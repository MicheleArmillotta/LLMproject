[
  {
    "function_name": "Logv",
    "container": "PosixLogger",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/leveldb/util/posix_logger.h",
    "lines": "28-93",
    "snippet": "virtual void Logv(const char* format, va_list ap) {\n    const uint64_t thread_id = (*gettid_)();\n\n    // We try twice: the first time with a fixed-size stack allocated buffer,\n    // and the second time with a much larger dynamically allocated buffer.\n    char buffer[500];\n    for (int iter = 0; iter < 2; iter++) {\n      char* base;\n      int bufsize;\n      if (iter == 0) {\n        bufsize = sizeof(buffer);\n        base = buffer;\n      } else {\n        bufsize = 30000;\n        base = new char[bufsize];\n      }\n      char* p = base;\n      char* limit = base + bufsize;\n\n      struct timeval now_tv;\n      gettimeofday(&now_tv, NULL);\n      const time_t seconds = now_tv.tv_sec;\n      struct tm t;\n      localtime_r(&seconds, &t);\n      p += snprintf(p, limit - p,\n                    \"%04d/%02d/%02d-%02d:%02d:%02d.%06d %llx \",\n                    t.tm_year + 1900,\n                    t.tm_mon + 1,\n                    t.tm_mday,\n                    t.tm_hour,\n                    t.tm_min,\n                    t.tm_sec,\n                    static_cast<int>(now_tv.tv_usec),\n                    static_cast<long long unsigned int>(thread_id));\n\n      // Print the message\n      if (p < limit) {\n        va_list backup_ap;\n        va_copy(backup_ap, ap);\n        p += vsnprintf(p, limit - p, format, backup_ap);\n        va_end(backup_ap);\n      }\n\n      // Truncate to available space if necessary\n      if (p >= limit) {\n        if (iter == 0) {\n          continue;       // Try again with larger buffer\n        } else {\n          p = limit - 1;\n        }\n      }\n\n      // Add newline if necessary\n      if (p == base || p[-1] != '\\n') {\n        *p++ = '\\n';\n      }\n\n      assert(p <= limit);\n      fwrite(base, 1, p - base, file_);\n      fflush(file_);\n      if (base != buffer) {\n        delete[] base;\n      }\n      break;\n    }\n  }",
    "includes": [
      "#include \"leveldb/env.h\"",
      "#include <time.h>",
      "#include <sys/time.h>",
      "#include <stdio.h>",
      "#include <algorithm>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "fflush",
          "args": [
            "file_"
          ],
          "line": 87
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fwrite",
          "args": [
            "base",
            "1",
            "p - base",
            "file_"
          ],
          "line": 86
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "assert",
          "args": [
            "p <= limit"
          ],
          "line": 85
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "va_end",
          "args": [
            "backup_ap"
          ],
          "line": 68
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "vsnprintf",
          "args": [
            "p",
            "limit - p",
            "format",
            "backup_ap"
          ],
          "line": 67
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "va_copy",
          "args": [
            "backup_ap",
            "ap"
          ],
          "line": 66
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "snprintf",
          "args": [
            "p",
            "limit - p",
            "\"%04d/%02d/%02d-%02d:%02d:%02d.%06d %llx \"",
            "t.tm_year + 1900",
            "t.tm_mon + 1",
            "t.tm_mday",
            "t.tm_hour",
            "t.tm_min",
            "t.tm_sec",
            "static_cast<int>(now_tv.tv_usec)",
            "static_cast<long long unsigned int>(thread_id)"
          ],
          "line": 52
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "static_cast<long long unsigned int>",
          "args": [
            "thread_id"
          ],
          "line": 61
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "static_cast<int>",
          "args": [
            "now_tv.tv_usec"
          ],
          "line": 60
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "localtime_r",
          "args": [
            "&seconds",
            "&t"
          ],
          "line": 51
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gettimeofday",
          "args": [
            "&now_tv",
            "NULL"
          ],
          "line": 48
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "",
          "args": [],
          "line": 29
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"leveldb/env.h\"\n#include <time.h>\n#include <sys/time.h>\n#include <stdio.h>\n#include <algorithm>\n\nPosixLogger {\n  virtual void Logv(const char* format, va_list ap) {\n      const uint64_t thread_id = (*gettid_)();\n  \n      // We try twice: the first time with a fixed-size stack allocated buffer,\n      // and the second time with a much larger dynamically allocated buffer.\n      char buffer[500];\n      for (int iter = 0; iter < 2; iter++) {\n        char* base;\n        int bufsize;\n        if (iter == 0) {\n          bufsize = sizeof(buffer);\n          base = buffer;\n        } else {\n          bufsize = 30000;\n          base = new char[bufsize];\n        }\n        char* p = base;\n        char* limit = base + bufsize;\n  \n        struct timeval now_tv;\n        gettimeofday(&now_tv, NULL);\n        const time_t seconds = now_tv.tv_sec;\n        struct tm t;\n        localtime_r(&seconds, &t);\n        p += snprintf(p, limit - p,\n                      \"%04d/%02d/%02d-%02d:%02d:%02d.%06d %llx \",\n                      t.tm_year + 1900,\n                      t.tm_mon + 1,\n                      t.tm_mday,\n                      t.tm_hour,\n                      t.tm_min,\n                      t.tm_sec,\n                      static_cast<int>(now_tv.tv_usec),\n                      static_cast<long long unsigned int>(thread_id));\n  \n        // Print the message\n        if (p < limit) {\n          va_list backup_ap;\n          va_copy(backup_ap, ap);\n          p += vsnprintf(p, limit - p, format, backup_ap);\n          va_end(backup_ap);\n        }\n  \n        // Truncate to available space if necessary\n        if (p >= limit) {\n          if (iter == 0) {\n            continue;       // Try again with larger buffer\n          } else {\n            p = limit - 1;\n          }\n        }\n  \n        // Add newline if necessary\n        if (p == base || p[-1] != '\\n') {\n          *p++ = '\\n';\n        }\n  \n        assert(p <= limit);\n        fwrite(base, 1, p - base, file_);\n        fflush(file_);\n        if (base != buffer) {\n          delete[] base;\n        }\n        break;\n      }\n    }\n}"
  },
  {
    "function_name": "PosixLogger",
    "container": "PosixLogger",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/leveldb/util/posix_logger.h",
    "lines": "24-24",
    "snippet": "PosixLogger(FILE* f, uint64_t (*gettid)()) : file_(f), gettid_(gettid) { }",
    "includes": [
      "#include \"leveldb/env.h\"",
      "#include <time.h>",
      "#include <sys/time.h>",
      "#include <stdio.h>",
      "#include <algorithm>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"leveldb/env.h\"\n#include <time.h>\n#include <sys/time.h>\n#include <stdio.h>\n#include <algorithm>\n\nPosixLogger {\n  PosixLogger(FILE* f, uint64_t (*gettid)()) : file_(f), gettid_(gettid) { }\n}"
  }
]