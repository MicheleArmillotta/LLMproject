[
  {
    "function_name": "EncryptKeys",
    "container": "CCryptoKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "197-221",
    "snippet": "bool CCryptoKeyStore::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n{\n    {\n        LOCK(cs_KeyStore);\n        if (!mapCryptedKeys.empty() || IsCrypted())\n            return false;\n\n        fUseCrypto = true;\n        BOOST_FOREACH(KeyMap::value_type& mKey, mapKeys)\n        {\n            CKey key;\n            if (!key.SetSecret(mKey.second.first, mKey.second.second))\n                return false;\n            const CPubKey vchPubKey = key.GetPubKey();\n            std::vector<unsigned char> vchCryptedSecret;\n            bool fCompressed;\n            if (!EncryptSecret(vMasterKeyIn, key.GetSecret(fCompressed), vchPubKey.GetHash(), vchCryptedSecret))\n                return false;\n            if (!AddCryptedKey(vchPubKey, vchCryptedSecret))\n                return false;\n        }\n        mapKeys.clear();\n    }\n    return true;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "mapKeys.clear",
          "args": [],
          "line": 218
        },
        "resolved": true,
        "details": {
          "function_name": "clear",
          "container": "CTxMemPool",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/main.cpp",
          "lines": "768-774",
          "snippet": "void CTxMemPool::clear()\n{\n    LOCK(cs);\n    mapTx.clear();\n    mapNextTx.clear();\n    ++nTransactionsUpdated;\n}",
          "includes": [
            "#include <boost/filesystem/fstream.hpp>",
            "#include <boost/filesystem.hpp>",
            "#include <boost/algorithm/string/replace.hpp>",
            "#include \"kernel.h\"",
            "#include \"ui_interface.h\"",
            "#include \"init.h\"",
            "#include \"net.h\"",
            "#include \"txdb.h\"",
            "#include \"db.h\"",
            "#include \"checkpoints.h\"",
            "#include \"alert.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "unsigned int nTransactionsUpdated = 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <boost/filesystem/fstream.hpp>\n#include <boost/filesystem.hpp>\n#include <boost/algorithm/string/replace.hpp>\n#include \"kernel.h\"\n#include \"ui_interface.h\"\n#include \"init.h\"\n#include \"net.h\"\n#include \"txdb.h\"\n#include \"db.h\"\n#include \"checkpoints.h\"\n#include \"alert.h\"\n\nunsigned int nTransactionsUpdated = 0;\n\nCTxMemPool {\n  void CTxMemPool::clear()\n  {\n      LOCK(cs);\n      mapTx.clear();\n      mapNextTx.clear();\n      ++nTransactionsUpdated;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "AddCryptedKey",
          "args": [
            "vchPubKey",
            "vchCryptedSecret"
          ],
          "line": 215
        },
        "resolved": true,
        "details": {
          "function_name": "AddCryptedKey",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
          "lines": "143-153",
          "snippet": "bool CCryptoKeyStore::AddCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret)\n{\n    {\n        LOCK(cs_KeyStore);\n        if (!SetCrypted())\n            return false;\n\n        mapCryptedKeys[vchPubKey.GetID()] = make_pair(vchPubKey, vchCryptedSecret);\n    }\n    return true;\n}",
          "includes": [
            "#include \"script.h\"",
            "#include \"keystore.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::AddCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret)\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (!SetCrypted())\n              return false;\n  \n          mapCryptedKeys[vchPubKey.GetID()] = make_pair(vchPubKey, vchCryptedSecret);\n      }\n      return true;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "EncryptSecret",
          "args": [
            "vMasterKeyIn",
            "key.GetSecret(fCompressed)",
            "vchPubKey.GetHash()",
            "vchCryptedSecret"
          ],
          "line": 213
        },
        "resolved": true,
        "details": {
          "function_name": "EncryptSecret",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/crypter.cpp",
          "lines": "117-125",
          "snippet": "bool EncryptSecret(CKeyingMaterial& vMasterKey, const CSecret &vchPlaintext, const uint256& nIV, std::vector<unsigned char> &vchCiphertext)\n{\n    CCrypter cKeyCrypter;\n    std::vector<unsigned char> chIV(WALLET_CRYPTO_KEY_SIZE);\n    memcpy(&chIV[0], &nIV, WALLET_CRYPTO_KEY_SIZE);\n    if(!cKeyCrypter.SetKey(vMasterKey, chIV))\n        return false;\n    return cKeyCrypter.Encrypt((CKeyingMaterial)vchPlaintext, vchCiphertext);\n}",
          "includes": [
            "#include \"scrypt.h\"",
            "#include \"crypter.h\"",
            "#include <windows.h>",
            "#include <string>",
            "#include <vector>",
            "#include <openssl/evp.h>",
            "#include <openssl/aes.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"scrypt.h\"\n#include \"crypter.h\"\n#include <windows.h>\n#include <string>\n#include <vector>\n#include <openssl/evp.h>\n#include <openssl/aes.h>\n\nbool EncryptSecret(CKeyingMaterial& vMasterKey, const CSecret &vchPlaintext, const uint256& nIV, std::vector<unsigned char> &vchCiphertext)\n{\n    CCrypter cKeyCrypter;\n    std::vector<unsigned char> chIV(WALLET_CRYPTO_KEY_SIZE);\n    memcpy(&chIV[0], &nIV, WALLET_CRYPTO_KEY_SIZE);\n    if(!cKeyCrypter.SetKey(vMasterKey, chIV))\n        return false;\n    return cKeyCrypter.Encrypt((CKeyingMaterial)vchPlaintext, vchCiphertext);\n}"
        }
      },
      {
        "call_info": {
          "callee": "vchPubKey.GetHash",
          "args": [],
          "line": 213
        },
        "resolved": true,
        "details": {
          "function_name": "GetHash",
          "container": "CNetAddr",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/netbase.cpp",
          "lines": "922-928",
          "snippet": "uint64_t CNetAddr::GetHash() const\n{\n    uint256 hash = Hash(&ip[0], &ip[16]);\n    uint64_t nRet;\n    memcpy(&nRet, &hash, sizeof(nRet));\n    return nRet;\n}",
          "includes": [
            "#include <boost/algorithm/string/case_conv.hpp> // for to_lower()",
            "#include \"strlcpy.h\"",
            "#include <sys/fcntl.h>",
            "#include \"sync.h\"",
            "#include \"util.h\"",
            "#include \"netbase.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <boost/algorithm/string/case_conv.hpp> // for to_lower()\n#include \"strlcpy.h\"\n#include <sys/fcntl.h>\n#include \"sync.h\"\n#include \"util.h\"\n#include \"netbase.h\"\n\nCNetAddr {\n  uint64_t CNetAddr::GetHash() const\n  {\n      uint256 hash = Hash(&ip[0], &ip[16]);\n      uint64_t nRet;\n      memcpy(&nRet, &hash, sizeof(nRet));\n      return nRet;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "key.GetSecret",
          "args": [
            "fCompressed"
          ],
          "line": 213
        },
        "resolved": true,
        "details": {
          "function_name": "GetSecret",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "232-245",
          "snippet": "CSecret CKey::GetSecret(bool &fCompressed) const\n{\n    CSecret vchRet;\n    vchRet.resize(32);\n    const BIGNUM *bn = EC_KEY_get0_private_key(pkey);\n    int nBytes = BN_num_bytes(bn);\n    if (bn == NULL)\n        throw key_error(\"CKey::GetSecret() : EC_KEY_get0_private_key failed\");\n    int n=BN_bn2bin(bn,&vchRet[32 - nBytes]);\n    if (n != nBytes)\n        throw key_error(\"CKey::GetSecret(): BN_bn2bin failed\");\n    fCompressed = fCompressedPubKey;\n    return vchRet;\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  CSecret CKey::GetSecret(bool &fCompressed) const\n  {\n      CSecret vchRet;\n      vchRet.resize(32);\n      const BIGNUM *bn = EC_KEY_get0_private_key(pkey);\n      int nBytes = BN_num_bytes(bn);\n      if (bn == NULL)\n          throw key_error(\"CKey::GetSecret() : EC_KEY_get0_private_key failed\");\n      int n=BN_bn2bin(bn,&vchRet[32 - nBytes]);\n      if (n != nBytes)\n          throw key_error(\"CKey::GetSecret(): BN_bn2bin failed\");\n      fCompressed = fCompressedPubKey;\n      return vchRet;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "key.GetPubKey",
          "args": [],
          "line": 210
        },
        "resolved": true,
        "details": {
          "function_name": "GetPubKey",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "274-284",
          "snippet": "CPubKey CKey::GetPubKey() const\n{\n    int nSize = i2o_ECPublicKey(pkey, NULL);\n    if (!nSize)\n        throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey failed\");\n    std::vector<unsigned char> vchPubKey(nSize, 0);\n    unsigned char* pbegin = &vchPubKey[0];\n    if (i2o_ECPublicKey(pkey, &pbegin) != nSize)\n        throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey returned unexpected size\");\n    return CPubKey(vchPubKey);\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  CPubKey CKey::GetPubKey() const\n  {\n      int nSize = i2o_ECPublicKey(pkey, NULL);\n      if (!nSize)\n          throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey failed\");\n      std::vector<unsigned char> vchPubKey(nSize, 0);\n      unsigned char* pbegin = &vchPubKey[0];\n      if (i2o_ECPublicKey(pkey, &pbegin) != nSize)\n          throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey returned unexpected size\");\n      return CPubKey(vchPubKey);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "key.SetSecret",
          "args": [
            "mKey.second.first",
            "mKey.second.second"
          ],
          "line": 208
        },
        "resolved": true,
        "details": {
          "function_name": "SetSecret",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "209-230",
          "snippet": "bool CKey::SetSecret(const CSecret& vchSecret, bool fCompressed)\n{\n    EC_KEY_free(pkey);\n    pkey = EC_KEY_new_by_curve_name(NID_secp256k1);\n    if (pkey == NULL)\n        throw key_error(\"CKey::SetSecret() : EC_KEY_new_by_curve_name failed\");\n    if (vchSecret.size() != 32)\n        throw key_error(\"CKey::SetSecret() : secret must be 32 bytes\");\n    BIGNUM *bn = BN_bin2bn(&vchSecret[0],32,BN_new());\n    if (bn == NULL)\n        throw key_error(\"CKey::SetSecret() : BN_bin2bn failed\");\n    if (!EC_KEY_regenerate_key(pkey,bn))\n    {\n        BN_clear_free(bn);\n        throw key_error(\"CKey::SetSecret() : EC_KEY_regenerate_key failed\");\n    }\n    BN_clear_free(bn);\n    fSet = true;\n    if (fCompressed || fCompressedPubKey)\n        SetCompressedPubKey();\n    return true;\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  bool CKey::SetSecret(const CSecret& vchSecret, bool fCompressed)\n  {\n      EC_KEY_free(pkey);\n      pkey = EC_KEY_new_by_curve_name(NID_secp256k1);\n      if (pkey == NULL)\n          throw key_error(\"CKey::SetSecret() : EC_KEY_new_by_curve_name failed\");\n      if (vchSecret.size() != 32)\n          throw key_error(\"CKey::SetSecret() : secret must be 32 bytes\");\n      BIGNUM *bn = BN_bin2bn(&vchSecret[0],32,BN_new());\n      if (bn == NULL)\n          throw key_error(\"CKey::SetSecret() : BN_bin2bn failed\");\n      if (!EC_KEY_regenerate_key(pkey,bn))\n      {\n          BN_clear_free(bn);\n          throw key_error(\"CKey::SetSecret() : EC_KEY_regenerate_key failed\");\n      }\n      BN_clear_free(bn);\n      fSet = true;\n      if (fCompressed || fCompressedPubKey)\n          SetCompressedPubKey();\n      return true;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "IsCrypted",
          "args": [],
          "line": 201
        },
        "resolved": true,
        "details": {
          "function_name": "IsCrypted",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.h",
          "lines": "129-132",
          "snippet": "bool IsCrypted() const\n    {\n        return fUseCrypto;\n    }",
          "includes": [
            "#include <boost/signals2/signal.hpp>",
            "#include \"sync.h\"",
            "#include \"crypter.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <boost/signals2/signal.hpp>\n#include \"sync.h\"\n#include \"crypter.h\"\n\nCCryptoKeyStore {\n  bool IsCrypted() const\n      {\n          return fUseCrypto;\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "mapCryptedKeys.empty",
          "args": [],
          "line": 201
        },
        "resolved": true,
        "details": {
          "function_name": "empty",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "32-32",
          "snippet": "bool empty() const { return map.empty(); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  bool empty() const { return map.empty(); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 200
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (!mapCryptedKeys.empty() || IsCrypted())\n              return false;\n  \n          fUseCrypto = true;\n          BOOST_FOREACH(KeyMap::value_type& mKey, mapKeys)\n          {\n              CKey key;\n              if (!key.SetSecret(mKey.second.first, mKey.second.second))\n                  return false;\n              const CPubKey vchPubKey = key.GetPubKey();\n              std::vector<unsigned char> vchCryptedSecret;\n              bool fCompressed;\n              if (!EncryptSecret(vMasterKeyIn, key.GetSecret(fCompressed), vchPubKey.GetHash(), vchCryptedSecret))\n                  return false;\n              if (!AddCryptedKey(vchPubKey, vchCryptedSecret))\n                  return false;\n          }\n          mapKeys.clear();\n      }\n      return true;\n  }\n}"
  },
  {
    "function_name": "GetPubKey",
    "container": "CCryptoKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "180-195",
    "snippet": "bool CCryptoKeyStore::GetPubKey(const CKeyID &address, CPubKey& vchPubKeyOut) const\n{\n    {\n        LOCK(cs_KeyStore);\n        if (!IsCrypted())\n            return CKeyStore::GetPubKey(address, vchPubKeyOut);\n\n        CryptedKeyMap::const_iterator mi = mapCryptedKeys.find(address);\n        if (mi != mapCryptedKeys.end())\n        {\n            vchPubKeyOut = (*mi).second.first;\n            return true;\n        }\n    }\n    return false;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "mapCryptedKeys.end",
          "args": [],
          "line": 188
        },
        "resolved": true,
        "details": {
          "function_name": "end",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "30-30",
          "snippet": "const_iterator end() const { return map.end(); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  const_iterator end() const { return map.end(); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "mapCryptedKeys.find",
          "args": [
            "address"
          ],
          "line": 187
        },
        "resolved": true,
        "details": {
          "function_name": "find",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "33-33",
          "snippet": "const_iterator find(const key_type& k) const { return map.find(k); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  const_iterator find(const key_type& k) const { return map.find(k); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "CKeyStore::GetPubKey",
          "args": [
            "address",
            "vchPubKeyOut"
          ],
          "line": 185
        },
        "resolved": true,
        "details": {
          "function_name": "GetPubKey",
          "container": "CKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
          "lines": "9-16",
          "snippet": "bool CKeyStore::GetPubKey(const CKeyID &address, CPubKey &vchPubKeyOut) const\n{\n    CKey key;\n    if (!GetKey(address, key))\n        return false;\n    vchPubKeyOut = key.GetPubKey();\n    return true;\n}",
          "includes": [
            "#include \"script.h\"",
            "#include \"keystore.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCKeyStore {\n  bool CKeyStore::GetPubKey(const CKeyID &address, CPubKey &vchPubKeyOut) const\n  {\n      CKey key;\n      if (!GetKey(address, key))\n          return false;\n      vchPubKeyOut = key.GetPubKey();\n      return true;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "IsCrypted",
          "args": [],
          "line": 184
        },
        "resolved": true,
        "details": {
          "function_name": "IsCrypted",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.h",
          "lines": "129-132",
          "snippet": "bool IsCrypted() const\n    {\n        return fUseCrypto;\n    }",
          "includes": [
            "#include <boost/signals2/signal.hpp>",
            "#include \"sync.h\"",
            "#include \"crypter.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <boost/signals2/signal.hpp>\n#include \"sync.h\"\n#include \"crypter.h\"\n\nCCryptoKeyStore {\n  bool IsCrypted() const\n      {\n          return fUseCrypto;\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 183
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::GetPubKey(const CKeyID &address, CPubKey& vchPubKeyOut) const\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (!IsCrypted())\n              return CKeyStore::GetPubKey(address, vchPubKeyOut);\n  \n          CryptedKeyMap::const_iterator mi = mapCryptedKeys.find(address);\n          if (mi != mapCryptedKeys.end())\n          {\n              vchPubKeyOut = (*mi).second.first;\n              return true;\n          }\n      }\n      return false;\n  }\n}"
  },
  {
    "function_name": "GetKey",
    "container": "CCryptoKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "155-178",
    "snippet": "bool CCryptoKeyStore::GetKey(const CKeyID &address, CKey& keyOut) const\n{\n    {\n        LOCK(cs_KeyStore);\n        if (!IsCrypted())\n            return CBasicKeyStore::GetKey(address, keyOut);\n\n        CryptedKeyMap::const_iterator mi = mapCryptedKeys.find(address);\n        if (mi != mapCryptedKeys.end())\n        {\n            const CPubKey &vchPubKey = (*mi).second.first;\n            const std::vector<unsigned char> &vchCryptedSecret = (*mi).second.second;\n            CSecret vchSecret;\n            if (!DecryptSecret(vMasterKey, vchCryptedSecret, vchPubKey.GetHash(), vchSecret))\n                return false;\n            if (vchSecret.size() != 32)\n                return false;\n            keyOut.SetPubKey(vchPubKey);\n            keyOut.SetSecret(vchSecret);\n            return true;\n        }\n    }\n    return false;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "keyOut.SetSecret",
          "args": [
            "vchSecret"
          ],
          "line": 173
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keyOut.SetPubKey",
          "args": [
            "vchPubKey"
          ],
          "line": 172
        },
        "resolved": true,
        "details": {
          "function_name": "SetPubKey",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "259-272",
          "snippet": "bool CKey::SetPubKey(const CPubKey& vchPubKey)\n{\n    const unsigned char* pbegin = &vchPubKey.vchPubKey[0];\n    if (o2i_ECPublicKey(&pkey, &pbegin, vchPubKey.vchPubKey.size()))\n    {\n        fSet = true;\n        if (vchPubKey.vchPubKey.size() == 33)\n            SetCompressedPubKey();\n        return true;\n    }\n    pkey = NULL;\n    Reset();\n    return false;\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  bool CKey::SetPubKey(const CPubKey& vchPubKey)\n  {\n      const unsigned char* pbegin = &vchPubKey.vchPubKey[0];\n      if (o2i_ECPublicKey(&pkey, &pbegin, vchPubKey.vchPubKey.size()))\n      {\n          fSet = true;\n          if (vchPubKey.vchPubKey.size() == 33)\n              SetCompressedPubKey();\n          return true;\n      }\n      pkey = NULL;\n      Reset();\n      return false;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "vchSecret.size",
          "args": [],
          "line": 170
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "base_uint",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/uint256.h",
          "lines": "354-357",
          "snippet": "unsigned int size()\n    {\n        return sizeof(pn);\n    }",
          "includes": [
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdint.h>",
            "#include <vector>",
            "#include <string>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <stdio.h>\n#include <stdint.h>\n#include <vector>\n#include <string>\n\nbase_uint {\n  unsigned int size()\n      {\n          return sizeof(pn);\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "DecryptSecret",
          "args": [
            "vMasterKey",
            "vchCryptedSecret",
            "vchPubKey.GetHash()",
            "vchSecret"
          ],
          "line": 168
        },
        "resolved": true,
        "details": {
          "function_name": "DecryptSecret",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/crypter.cpp",
          "lines": "127-135",
          "snippet": "bool DecryptSecret(const CKeyingMaterial& vMasterKey, const std::vector<unsigned char>& vchCiphertext, const uint256& nIV, CSecret& vchPlaintext)\n{\n    CCrypter cKeyCrypter;\n    std::vector<unsigned char> chIV(WALLET_CRYPTO_KEY_SIZE);\n    memcpy(&chIV[0], &nIV, WALLET_CRYPTO_KEY_SIZE);\n    if(!cKeyCrypter.SetKey(vMasterKey, chIV))\n        return false;\n    return cKeyCrypter.Decrypt(vchCiphertext, *((CKeyingMaterial*)&vchPlaintext));\n}",
          "includes": [
            "#include \"scrypt.h\"",
            "#include \"crypter.h\"",
            "#include <windows.h>",
            "#include <string>",
            "#include <vector>",
            "#include <openssl/evp.h>",
            "#include <openssl/aes.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"scrypt.h\"\n#include \"crypter.h\"\n#include <windows.h>\n#include <string>\n#include <vector>\n#include <openssl/evp.h>\n#include <openssl/aes.h>\n\nbool DecryptSecret(const CKeyingMaterial& vMasterKey, const std::vector<unsigned char>& vchCiphertext, const uint256& nIV, CSecret& vchPlaintext)\n{\n    CCrypter cKeyCrypter;\n    std::vector<unsigned char> chIV(WALLET_CRYPTO_KEY_SIZE);\n    memcpy(&chIV[0], &nIV, WALLET_CRYPTO_KEY_SIZE);\n    if(!cKeyCrypter.SetKey(vMasterKey, chIV))\n        return false;\n    return cKeyCrypter.Decrypt(vchCiphertext, *((CKeyingMaterial*)&vchPlaintext));\n}"
        }
      },
      {
        "call_info": {
          "callee": "vchPubKey.GetHash",
          "args": [],
          "line": 168
        },
        "resolved": true,
        "details": {
          "function_name": "GetHash",
          "container": "CNetAddr",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/netbase.cpp",
          "lines": "922-928",
          "snippet": "uint64_t CNetAddr::GetHash() const\n{\n    uint256 hash = Hash(&ip[0], &ip[16]);\n    uint64_t nRet;\n    memcpy(&nRet, &hash, sizeof(nRet));\n    return nRet;\n}",
          "includes": [
            "#include <boost/algorithm/string/case_conv.hpp> // for to_lower()",
            "#include \"strlcpy.h\"",
            "#include <sys/fcntl.h>",
            "#include \"sync.h\"",
            "#include \"util.h\"",
            "#include \"netbase.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <boost/algorithm/string/case_conv.hpp> // for to_lower()\n#include \"strlcpy.h\"\n#include <sys/fcntl.h>\n#include \"sync.h\"\n#include \"util.h\"\n#include \"netbase.h\"\n\nCNetAddr {\n  uint64_t CNetAddr::GetHash() const\n  {\n      uint256 hash = Hash(&ip[0], &ip[16]);\n      uint64_t nRet;\n      memcpy(&nRet, &hash, sizeof(nRet));\n      return nRet;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "mapCryptedKeys.end",
          "args": [],
          "line": 163
        },
        "resolved": true,
        "details": {
          "function_name": "end",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "30-30",
          "snippet": "const_iterator end() const { return map.end(); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  const_iterator end() const { return map.end(); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "mapCryptedKeys.find",
          "args": [
            "address"
          ],
          "line": 162
        },
        "resolved": true,
        "details": {
          "function_name": "find",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "33-33",
          "snippet": "const_iterator find(const key_type& k) const { return map.find(k); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  const_iterator find(const key_type& k) const { return map.find(k); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "CBasicKeyStore::GetKey",
          "args": [
            "address",
            "keyOut"
          ],
          "line": 160
        },
        "resolved": true,
        "details": {
          "function_name": "GetKey",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
          "lines": "155-178",
          "snippet": "bool CCryptoKeyStore::GetKey(const CKeyID &address, CKey& keyOut) const\n{\n    {\n        LOCK(cs_KeyStore);\n        if (!IsCrypted())\n            return CBasicKeyStore::GetKey(address, keyOut);\n\n        CryptedKeyMap::const_iterator mi = mapCryptedKeys.find(address);\n        if (mi != mapCryptedKeys.end())\n        {\n            const CPubKey &vchPubKey = (*mi).second.first;\n            const std::vector<unsigned char> &vchCryptedSecret = (*mi).second.second;\n            CSecret vchSecret;\n            if (!DecryptSecret(vMasterKey, vchCryptedSecret, vchPubKey.GetHash(), vchSecret))\n                return false;\n            if (vchSecret.size() != 32)\n                return false;\n            keyOut.SetPubKey(vchPubKey);\n            keyOut.SetSecret(vchSecret);\n            return true;\n        }\n    }\n    return false;\n}",
          "note": "cyclic_reference_detected"
        }
      },
      {
        "call_info": {
          "callee": "IsCrypted",
          "args": [],
          "line": 159
        },
        "resolved": true,
        "details": {
          "function_name": "IsCrypted",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.h",
          "lines": "129-132",
          "snippet": "bool IsCrypted() const\n    {\n        return fUseCrypto;\n    }",
          "includes": [
            "#include <boost/signals2/signal.hpp>",
            "#include \"sync.h\"",
            "#include \"crypter.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <boost/signals2/signal.hpp>\n#include \"sync.h\"\n#include \"crypter.h\"\n\nCCryptoKeyStore {\n  bool IsCrypted() const\n      {\n          return fUseCrypto;\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 158
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::GetKey(const CKeyID &address, CKey& keyOut) const\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (!IsCrypted())\n              return CBasicKeyStore::GetKey(address, keyOut);\n  \n          CryptedKeyMap::const_iterator mi = mapCryptedKeys.find(address);\n          if (mi != mapCryptedKeys.end())\n          {\n              const CPubKey &vchPubKey = (*mi).second.first;\n              const std::vector<unsigned char> &vchCryptedSecret = (*mi).second.second;\n              CSecret vchSecret;\n              if (!DecryptSecret(vMasterKey, vchCryptedSecret, vchPubKey.GetHash(), vchSecret))\n                  return false;\n              if (vchSecret.size() != 32)\n                  return false;\n              keyOut.SetPubKey(vchPubKey);\n              keyOut.SetSecret(vchSecret);\n              return true;\n          }\n      }\n      return false;\n  }\n}"
  },
  {
    "function_name": "AddCryptedKey",
    "container": "CCryptoKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "143-153",
    "snippet": "bool CCryptoKeyStore::AddCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret)\n{\n    {\n        LOCK(cs_KeyStore);\n        if (!SetCrypted())\n            return false;\n\n        mapCryptedKeys[vchPubKey.GetID()] = make_pair(vchPubKey, vchCryptedSecret);\n    }\n    return true;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "make_pair",
          "args": [
            "vchPubKey",
            "vchCryptedSecret"
          ],
          "line": 150
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "vchPubKey.GetID",
          "args": [],
          "line": 150
        },
        "resolved": true,
        "details": {
          "function_name": "GetID",
          "container": "CPubKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.h",
          "lines": "80-82",
          "snippet": "CKeyID GetID() const {\n        return CKeyID(Hash160(vchPubKey));\n    }",
          "includes": [
            "#include <openssl/ec.h> // for EC_KEY definition",
            "#include \"util.h\"",
            "#include \"uint256.h\"",
            "#include \"serialize.h\"",
            "#include \"allocators.h\"",
            "#include <vector>",
            "#include <stdexcept>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/ec.h> // for EC_KEY definition\n#include \"util.h\"\n#include \"uint256.h\"\n#include \"serialize.h\"\n#include \"allocators.h\"\n#include <vector>\n#include <stdexcept>\n\nCPubKey {\n  CKeyID GetID() const {\n          return CKeyID(Hash160(vchPubKey));\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "SetCrypted",
          "args": [],
          "line": 147
        },
        "resolved": true,
        "details": {
          "function_name": "SetCrypted",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
          "lines": "63-74",
          "snippet": "bool CCryptoKeyStore::SetCrypted()\n{\n    {\n        LOCK(cs_KeyStore);\n        if (fUseCrypto)\n            return true;\n        if (!mapKeys.empty())\n            return false;\n        fUseCrypto = true;\n    }\n    return true;\n}",
          "includes": [
            "#include \"script.h\"",
            "#include \"keystore.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::SetCrypted()\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (fUseCrypto)\n              return true;\n          if (!mapKeys.empty())\n              return false;\n          fUseCrypto = true;\n      }\n      return true;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 146
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::AddCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret)\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (!SetCrypted())\n              return false;\n  \n          mapCryptedKeys[vchPubKey.GetID()] = make_pair(vchPubKey, vchCryptedSecret);\n      }\n      return true;\n  }\n}"
  },
  {
    "function_name": "AddKey",
    "container": "CCryptoKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "120-140",
    "snippet": "bool CCryptoKeyStore::AddKey(const CKey& key)\n{\n    {\n        LOCK(cs_KeyStore);\n        if (!IsCrypted())\n            return CBasicKeyStore::AddKey(key);\n\n        if (IsLocked())\n            return false;\n\n        std::vector<unsigned char> vchCryptedSecret;\n        CPubKey vchPubKey = key.GetPubKey();\n        bool fCompressed;\n        if (!EncryptSecret(vMasterKey, key.GetSecret(fCompressed), vchPubKey.GetHash(), vchCryptedSecret))\n            return false;\n\n        if (!AddCryptedKey(key.GetPubKey(), vchCryptedSecret))\n            return false;\n    }\n    return true;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "AddCryptedKey",
          "args": [
            "key.GetPubKey()",
            "vchCryptedSecret"
          ],
          "line": 136
        },
        "resolved": true,
        "details": {
          "function_name": "AddCryptedKey",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
          "lines": "143-153",
          "snippet": "bool CCryptoKeyStore::AddCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret)\n{\n    {\n        LOCK(cs_KeyStore);\n        if (!SetCrypted())\n            return false;\n\n        mapCryptedKeys[vchPubKey.GetID()] = make_pair(vchPubKey, vchCryptedSecret);\n    }\n    return true;\n}",
          "includes": [
            "#include \"script.h\"",
            "#include \"keystore.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::AddCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret)\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (!SetCrypted())\n              return false;\n  \n          mapCryptedKeys[vchPubKey.GetID()] = make_pair(vchPubKey, vchCryptedSecret);\n      }\n      return true;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "key.GetPubKey",
          "args": [],
          "line": 136
        },
        "resolved": true,
        "details": {
          "function_name": "GetPubKey",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "274-284",
          "snippet": "CPubKey CKey::GetPubKey() const\n{\n    int nSize = i2o_ECPublicKey(pkey, NULL);\n    if (!nSize)\n        throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey failed\");\n    std::vector<unsigned char> vchPubKey(nSize, 0);\n    unsigned char* pbegin = &vchPubKey[0];\n    if (i2o_ECPublicKey(pkey, &pbegin) != nSize)\n        throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey returned unexpected size\");\n    return CPubKey(vchPubKey);\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  CPubKey CKey::GetPubKey() const\n  {\n      int nSize = i2o_ECPublicKey(pkey, NULL);\n      if (!nSize)\n          throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey failed\");\n      std::vector<unsigned char> vchPubKey(nSize, 0);\n      unsigned char* pbegin = &vchPubKey[0];\n      if (i2o_ECPublicKey(pkey, &pbegin) != nSize)\n          throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey returned unexpected size\");\n      return CPubKey(vchPubKey);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "EncryptSecret",
          "args": [
            "vMasterKey",
            "key.GetSecret(fCompressed)",
            "vchPubKey.GetHash()",
            "vchCryptedSecret"
          ],
          "line": 133
        },
        "resolved": true,
        "details": {
          "function_name": "EncryptSecret",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/crypter.cpp",
          "lines": "117-125",
          "snippet": "bool EncryptSecret(CKeyingMaterial& vMasterKey, const CSecret &vchPlaintext, const uint256& nIV, std::vector<unsigned char> &vchCiphertext)\n{\n    CCrypter cKeyCrypter;\n    std::vector<unsigned char> chIV(WALLET_CRYPTO_KEY_SIZE);\n    memcpy(&chIV[0], &nIV, WALLET_CRYPTO_KEY_SIZE);\n    if(!cKeyCrypter.SetKey(vMasterKey, chIV))\n        return false;\n    return cKeyCrypter.Encrypt((CKeyingMaterial)vchPlaintext, vchCiphertext);\n}",
          "includes": [
            "#include \"scrypt.h\"",
            "#include \"crypter.h\"",
            "#include <windows.h>",
            "#include <string>",
            "#include <vector>",
            "#include <openssl/evp.h>",
            "#include <openssl/aes.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"scrypt.h\"\n#include \"crypter.h\"\n#include <windows.h>\n#include <string>\n#include <vector>\n#include <openssl/evp.h>\n#include <openssl/aes.h>\n\nbool EncryptSecret(CKeyingMaterial& vMasterKey, const CSecret &vchPlaintext, const uint256& nIV, std::vector<unsigned char> &vchCiphertext)\n{\n    CCrypter cKeyCrypter;\n    std::vector<unsigned char> chIV(WALLET_CRYPTO_KEY_SIZE);\n    memcpy(&chIV[0], &nIV, WALLET_CRYPTO_KEY_SIZE);\n    if(!cKeyCrypter.SetKey(vMasterKey, chIV))\n        return false;\n    return cKeyCrypter.Encrypt((CKeyingMaterial)vchPlaintext, vchCiphertext);\n}"
        }
      },
      {
        "call_info": {
          "callee": "vchPubKey.GetHash",
          "args": [],
          "line": 133
        },
        "resolved": true,
        "details": {
          "function_name": "GetHash",
          "container": "CNetAddr",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/netbase.cpp",
          "lines": "922-928",
          "snippet": "uint64_t CNetAddr::GetHash() const\n{\n    uint256 hash = Hash(&ip[0], &ip[16]);\n    uint64_t nRet;\n    memcpy(&nRet, &hash, sizeof(nRet));\n    return nRet;\n}",
          "includes": [
            "#include <boost/algorithm/string/case_conv.hpp> // for to_lower()",
            "#include \"strlcpy.h\"",
            "#include <sys/fcntl.h>",
            "#include \"sync.h\"",
            "#include \"util.h\"",
            "#include \"netbase.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <boost/algorithm/string/case_conv.hpp> // for to_lower()\n#include \"strlcpy.h\"\n#include <sys/fcntl.h>\n#include \"sync.h\"\n#include \"util.h\"\n#include \"netbase.h\"\n\nCNetAddr {\n  uint64_t CNetAddr::GetHash() const\n  {\n      uint256 hash = Hash(&ip[0], &ip[16]);\n      uint64_t nRet;\n      memcpy(&nRet, &hash, sizeof(nRet));\n      return nRet;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "key.GetSecret",
          "args": [
            "fCompressed"
          ],
          "line": 133
        },
        "resolved": true,
        "details": {
          "function_name": "GetSecret",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "232-245",
          "snippet": "CSecret CKey::GetSecret(bool &fCompressed) const\n{\n    CSecret vchRet;\n    vchRet.resize(32);\n    const BIGNUM *bn = EC_KEY_get0_private_key(pkey);\n    int nBytes = BN_num_bytes(bn);\n    if (bn == NULL)\n        throw key_error(\"CKey::GetSecret() : EC_KEY_get0_private_key failed\");\n    int n=BN_bn2bin(bn,&vchRet[32 - nBytes]);\n    if (n != nBytes)\n        throw key_error(\"CKey::GetSecret(): BN_bn2bin failed\");\n    fCompressed = fCompressedPubKey;\n    return vchRet;\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  CSecret CKey::GetSecret(bool &fCompressed) const\n  {\n      CSecret vchRet;\n      vchRet.resize(32);\n      const BIGNUM *bn = EC_KEY_get0_private_key(pkey);\n      int nBytes = BN_num_bytes(bn);\n      if (bn == NULL)\n          throw key_error(\"CKey::GetSecret() : EC_KEY_get0_private_key failed\");\n      int n=BN_bn2bin(bn,&vchRet[32 - nBytes]);\n      if (n != nBytes)\n          throw key_error(\"CKey::GetSecret(): BN_bn2bin failed\");\n      fCompressed = fCompressedPubKey;\n      return vchRet;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "IsLocked",
          "args": [],
          "line": 127
        },
        "resolved": true,
        "details": {
          "function_name": "IsLocked",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.h",
          "lines": "134-144",
          "snippet": "bool IsLocked() const\n    {\n        if (!IsCrypted())\n            return false;\n        bool result;\n        {\n            LOCK(cs_KeyStore);\n            result = vMasterKey.empty();\n        }\n        return result;\n    }",
          "includes": [
            "#include <boost/signals2/signal.hpp>",
            "#include \"sync.h\"",
            "#include \"crypter.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <boost/signals2/signal.hpp>\n#include \"sync.h\"\n#include \"crypter.h\"\n\nCCryptoKeyStore {\n  bool IsLocked() const\n      {\n          if (!IsCrypted())\n              return false;\n          bool result;\n          {\n              LOCK(cs_KeyStore);\n              result = vMasterKey.empty();\n          }\n          return result;\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "CBasicKeyStore::AddKey",
          "args": [
            "key"
          ],
          "line": 125
        },
        "resolved": true,
        "details": {
          "function_name": "AddKey",
          "container": "CBasicKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
          "lines": "18-27",
          "snippet": "bool CBasicKeyStore::AddKey(const CKey& key)\n{\n    bool fCompressed = false;\n    CSecret secret = key.GetSecret(fCompressed);\n    {\n        LOCK(cs_KeyStore);\n        mapKeys[key.GetPubKey().GetID()] = make_pair(secret, fCompressed);\n    }\n    return true;\n}",
          "includes": [
            "#include \"script.h\"",
            "#include \"keystore.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCBasicKeyStore {\n  bool CBasicKeyStore::AddKey(const CKey& key)\n  {\n      bool fCompressed = false;\n      CSecret secret = key.GetSecret(fCompressed);\n      {\n          LOCK(cs_KeyStore);\n          mapKeys[key.GetPubKey().GetID()] = make_pair(secret, fCompressed);\n      }\n      return true;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "IsCrypted",
          "args": [],
          "line": 124
        },
        "resolved": true,
        "details": {
          "function_name": "IsCrypted",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.h",
          "lines": "129-132",
          "snippet": "bool IsCrypted() const\n    {\n        return fUseCrypto;\n    }",
          "includes": [
            "#include <boost/signals2/signal.hpp>",
            "#include \"sync.h\"",
            "#include \"crypter.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <boost/signals2/signal.hpp>\n#include \"sync.h\"\n#include \"crypter.h\"\n\nCCryptoKeyStore {\n  bool IsCrypted() const\n      {\n          return fUseCrypto;\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 123
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::AddKey(const CKey& key)\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (!IsCrypted())\n              return CBasicKeyStore::AddKey(key);\n  \n          if (IsLocked())\n              return false;\n  \n          std::vector<unsigned char> vchCryptedSecret;\n          CPubKey vchPubKey = key.GetPubKey();\n          bool fCompressed;\n          if (!EncryptSecret(vMasterKey, key.GetSecret(fCompressed), vchPubKey.GetHash(), vchCryptedSecret))\n              return false;\n  \n          if (!AddCryptedKey(key.GetPubKey(), vchCryptedSecret))\n              return false;\n      }\n      return true;\n  }\n}"
  },
  {
    "function_name": "Unlock",
    "container": "CCryptoKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "90-118",
    "snippet": "bool CCryptoKeyStore::Unlock(const CKeyingMaterial& vMasterKeyIn)\n{\n    {\n        LOCK(cs_KeyStore);\n        if (!SetCrypted())\n            return false;\n\n        CryptedKeyMap::const_iterator mi = mapCryptedKeys.begin();\n        for (; mi != mapCryptedKeys.end(); ++mi)\n        {\n            const CPubKey &vchPubKey = (*mi).second.first;\n            const std::vector<unsigned char> &vchCryptedSecret = (*mi).second.second;\n            CSecret vchSecret;\n            if(!DecryptSecret(vMasterKeyIn, vchCryptedSecret, vchPubKey.GetHash(), vchSecret))\n                return false;\n            if (vchSecret.size() != 32)\n                return false;\n            CKey key;\n            key.SetPubKey(vchPubKey);\n            key.SetSecret(vchSecret);\n            if (key.GetPubKey() == vchPubKey)\n                break;\n            return false;\n        }\n        vMasterKey = vMasterKeyIn;\n    }\n    NotifyStatusChanged(this);\n    return true;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "NotifyStatusChanged",
          "args": [
            "this"
          ],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "key.GetPubKey",
          "args": [],
          "line": 110
        },
        "resolved": true,
        "details": {
          "function_name": "GetPubKey",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "274-284",
          "snippet": "CPubKey CKey::GetPubKey() const\n{\n    int nSize = i2o_ECPublicKey(pkey, NULL);\n    if (!nSize)\n        throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey failed\");\n    std::vector<unsigned char> vchPubKey(nSize, 0);\n    unsigned char* pbegin = &vchPubKey[0];\n    if (i2o_ECPublicKey(pkey, &pbegin) != nSize)\n        throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey returned unexpected size\");\n    return CPubKey(vchPubKey);\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  CPubKey CKey::GetPubKey() const\n  {\n      int nSize = i2o_ECPublicKey(pkey, NULL);\n      if (!nSize)\n          throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey failed\");\n      std::vector<unsigned char> vchPubKey(nSize, 0);\n      unsigned char* pbegin = &vchPubKey[0];\n      if (i2o_ECPublicKey(pkey, &pbegin) != nSize)\n          throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey returned unexpected size\");\n      return CPubKey(vchPubKey);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "key.SetSecret",
          "args": [
            "vchSecret"
          ],
          "line": 109
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "key.SetPubKey",
          "args": [
            "vchPubKey"
          ],
          "line": 108
        },
        "resolved": true,
        "details": {
          "function_name": "SetPubKey",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "259-272",
          "snippet": "bool CKey::SetPubKey(const CPubKey& vchPubKey)\n{\n    const unsigned char* pbegin = &vchPubKey.vchPubKey[0];\n    if (o2i_ECPublicKey(&pkey, &pbegin, vchPubKey.vchPubKey.size()))\n    {\n        fSet = true;\n        if (vchPubKey.vchPubKey.size() == 33)\n            SetCompressedPubKey();\n        return true;\n    }\n    pkey = NULL;\n    Reset();\n    return false;\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  bool CKey::SetPubKey(const CPubKey& vchPubKey)\n  {\n      const unsigned char* pbegin = &vchPubKey.vchPubKey[0];\n      if (o2i_ECPublicKey(&pkey, &pbegin, vchPubKey.vchPubKey.size()))\n      {\n          fSet = true;\n          if (vchPubKey.vchPubKey.size() == 33)\n              SetCompressedPubKey();\n          return true;\n      }\n      pkey = NULL;\n      Reset();\n      return false;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "vchSecret.size",
          "args": [],
          "line": 105
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "base_uint",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/uint256.h",
          "lines": "354-357",
          "snippet": "unsigned int size()\n    {\n        return sizeof(pn);\n    }",
          "includes": [
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdint.h>",
            "#include <vector>",
            "#include <string>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <stdio.h>\n#include <stdint.h>\n#include <vector>\n#include <string>\n\nbase_uint {\n  unsigned int size()\n      {\n          return sizeof(pn);\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "DecryptSecret",
          "args": [
            "vMasterKeyIn",
            "vchCryptedSecret",
            "vchPubKey.GetHash()",
            "vchSecret"
          ],
          "line": 103
        },
        "resolved": true,
        "details": {
          "function_name": "DecryptSecret",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/crypter.cpp",
          "lines": "127-135",
          "snippet": "bool DecryptSecret(const CKeyingMaterial& vMasterKey, const std::vector<unsigned char>& vchCiphertext, const uint256& nIV, CSecret& vchPlaintext)\n{\n    CCrypter cKeyCrypter;\n    std::vector<unsigned char> chIV(WALLET_CRYPTO_KEY_SIZE);\n    memcpy(&chIV[0], &nIV, WALLET_CRYPTO_KEY_SIZE);\n    if(!cKeyCrypter.SetKey(vMasterKey, chIV))\n        return false;\n    return cKeyCrypter.Decrypt(vchCiphertext, *((CKeyingMaterial*)&vchPlaintext));\n}",
          "includes": [
            "#include \"scrypt.h\"",
            "#include \"crypter.h\"",
            "#include <windows.h>",
            "#include <string>",
            "#include <vector>",
            "#include <openssl/evp.h>",
            "#include <openssl/aes.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"scrypt.h\"\n#include \"crypter.h\"\n#include <windows.h>\n#include <string>\n#include <vector>\n#include <openssl/evp.h>\n#include <openssl/aes.h>\n\nbool DecryptSecret(const CKeyingMaterial& vMasterKey, const std::vector<unsigned char>& vchCiphertext, const uint256& nIV, CSecret& vchPlaintext)\n{\n    CCrypter cKeyCrypter;\n    std::vector<unsigned char> chIV(WALLET_CRYPTO_KEY_SIZE);\n    memcpy(&chIV[0], &nIV, WALLET_CRYPTO_KEY_SIZE);\n    if(!cKeyCrypter.SetKey(vMasterKey, chIV))\n        return false;\n    return cKeyCrypter.Decrypt(vchCiphertext, *((CKeyingMaterial*)&vchPlaintext));\n}"
        }
      },
      {
        "call_info": {
          "callee": "vchPubKey.GetHash",
          "args": [],
          "line": 103
        },
        "resolved": true,
        "details": {
          "function_name": "GetHash",
          "container": "CNetAddr",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/netbase.cpp",
          "lines": "922-928",
          "snippet": "uint64_t CNetAddr::GetHash() const\n{\n    uint256 hash = Hash(&ip[0], &ip[16]);\n    uint64_t nRet;\n    memcpy(&nRet, &hash, sizeof(nRet));\n    return nRet;\n}",
          "includes": [
            "#include <boost/algorithm/string/case_conv.hpp> // for to_lower()",
            "#include \"strlcpy.h\"",
            "#include <sys/fcntl.h>",
            "#include \"sync.h\"",
            "#include \"util.h\"",
            "#include \"netbase.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <boost/algorithm/string/case_conv.hpp> // for to_lower()\n#include \"strlcpy.h\"\n#include <sys/fcntl.h>\n#include \"sync.h\"\n#include \"util.h\"\n#include \"netbase.h\"\n\nCNetAddr {\n  uint64_t CNetAddr::GetHash() const\n  {\n      uint256 hash = Hash(&ip[0], &ip[16]);\n      uint64_t nRet;\n      memcpy(&nRet, &hash, sizeof(nRet));\n      return nRet;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "mapCryptedKeys.end",
          "args": [],
          "line": 98
        },
        "resolved": true,
        "details": {
          "function_name": "end",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "30-30",
          "snippet": "const_iterator end() const { return map.end(); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  const_iterator end() const { return map.end(); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "mapCryptedKeys.begin",
          "args": [],
          "line": 97
        },
        "resolved": true,
        "details": {
          "function_name": "begin",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "29-29",
          "snippet": "const_iterator begin() const { return map.begin(); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  const_iterator begin() const { return map.begin(); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "SetCrypted",
          "args": [],
          "line": 94
        },
        "resolved": true,
        "details": {
          "function_name": "SetCrypted",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
          "lines": "63-74",
          "snippet": "bool CCryptoKeyStore::SetCrypted()\n{\n    {\n        LOCK(cs_KeyStore);\n        if (fUseCrypto)\n            return true;\n        if (!mapKeys.empty())\n            return false;\n        fUseCrypto = true;\n    }\n    return true;\n}",
          "includes": [
            "#include \"script.h\"",
            "#include \"keystore.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::SetCrypted()\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (fUseCrypto)\n              return true;\n          if (!mapKeys.empty())\n              return false;\n          fUseCrypto = true;\n      }\n      return true;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::Unlock(const CKeyingMaterial& vMasterKeyIn)\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (!SetCrypted())\n              return false;\n  \n          CryptedKeyMap::const_iterator mi = mapCryptedKeys.begin();\n          for (; mi != mapCryptedKeys.end(); ++mi)\n          {\n              const CPubKey &vchPubKey = (*mi).second.first;\n              const std::vector<unsigned char> &vchCryptedSecret = (*mi).second.second;\n              CSecret vchSecret;\n              if(!DecryptSecret(vMasterKeyIn, vchCryptedSecret, vchPubKey.GetHash(), vchSecret))\n                  return false;\n              if (vchSecret.size() != 32)\n                  return false;\n              CKey key;\n              key.SetPubKey(vchPubKey);\n              key.SetSecret(vchSecret);\n              if (key.GetPubKey() == vchPubKey)\n                  break;\n              return false;\n          }\n          vMasterKey = vMasterKeyIn;\n      }\n      NotifyStatusChanged(this);\n      return true;\n  }\n}"
  },
  {
    "function_name": "Lock",
    "container": "CCryptoKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "76-88",
    "snippet": "bool CCryptoKeyStore::Lock()\n{\n    if (!SetCrypted())\n        return false;\n\n    {\n        LOCK(cs_KeyStore);\n        vMasterKey.clear();\n    }\n\n    NotifyStatusChanged(this);\n    return true;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "NotifyStatusChanged",
          "args": [
            "this"
          ],
          "line": 86
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "vMasterKey.clear",
          "args": [],
          "line": 83
        },
        "resolved": true,
        "details": {
          "function_name": "clear",
          "container": "CTxMemPool",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/main.cpp",
          "lines": "768-774",
          "snippet": "void CTxMemPool::clear()\n{\n    LOCK(cs);\n    mapTx.clear();\n    mapNextTx.clear();\n    ++nTransactionsUpdated;\n}",
          "includes": [
            "#include <boost/filesystem/fstream.hpp>",
            "#include <boost/filesystem.hpp>",
            "#include <boost/algorithm/string/replace.hpp>",
            "#include \"kernel.h\"",
            "#include \"ui_interface.h\"",
            "#include \"init.h\"",
            "#include \"net.h\"",
            "#include \"txdb.h\"",
            "#include \"db.h\"",
            "#include \"checkpoints.h\"",
            "#include \"alert.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "unsigned int nTransactionsUpdated = 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <boost/filesystem/fstream.hpp>\n#include <boost/filesystem.hpp>\n#include <boost/algorithm/string/replace.hpp>\n#include \"kernel.h\"\n#include \"ui_interface.h\"\n#include \"init.h\"\n#include \"net.h\"\n#include \"txdb.h\"\n#include \"db.h\"\n#include \"checkpoints.h\"\n#include \"alert.h\"\n\nunsigned int nTransactionsUpdated = 0;\n\nCTxMemPool {\n  void CTxMemPool::clear()\n  {\n      LOCK(cs);\n      mapTx.clear();\n      mapNextTx.clear();\n      ++nTransactionsUpdated;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 82
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "SetCrypted",
          "args": [],
          "line": 78
        },
        "resolved": true,
        "details": {
          "function_name": "SetCrypted",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
          "lines": "63-74",
          "snippet": "bool CCryptoKeyStore::SetCrypted()\n{\n    {\n        LOCK(cs_KeyStore);\n        if (fUseCrypto)\n            return true;\n        if (!mapKeys.empty())\n            return false;\n        fUseCrypto = true;\n    }\n    return true;\n}",
          "includes": [
            "#include \"script.h\"",
            "#include \"keystore.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::SetCrypted()\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (fUseCrypto)\n              return true;\n          if (!mapKeys.empty())\n              return false;\n          fUseCrypto = true;\n      }\n      return true;\n  }\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::Lock()\n  {\n      if (!SetCrypted())\n          return false;\n  \n      {\n          LOCK(cs_KeyStore);\n          vMasterKey.clear();\n      }\n  \n      NotifyStatusChanged(this);\n      return true;\n  }\n}"
  },
  {
    "function_name": "SetCrypted",
    "container": "CCryptoKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "63-74",
    "snippet": "bool CCryptoKeyStore::SetCrypted()\n{\n    {\n        LOCK(cs_KeyStore);\n        if (fUseCrypto)\n            return true;\n        if (!mapKeys.empty())\n            return false;\n        fUseCrypto = true;\n    }\n    return true;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "mapKeys.empty",
          "args": [],
          "line": 69
        },
        "resolved": true,
        "details": {
          "function_name": "empty",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "32-32",
          "snippet": "bool empty() const { return map.empty(); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  bool empty() const { return map.empty(); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 66
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::SetCrypted()\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (fUseCrypto)\n              return true;\n          if (!mapKeys.empty())\n              return false;\n          fUseCrypto = true;\n      }\n      return true;\n  }\n}"
  },
  {
    "function_name": "GetCScript",
    "container": "CBasicKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "49-61",
    "snippet": "bool CBasicKeyStore::GetCScript(const CScriptID &hash, CScript& redeemScriptOut) const\n{\n    {\n        LOCK(cs_KeyStore);\n        ScriptMap::const_iterator mi = mapScripts.find(hash);\n        if (mi != mapScripts.end())\n        {\n            redeemScriptOut = (*mi).second;\n            return true;\n        }\n    }\n    return false;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "mapScripts.end",
          "args": [],
          "line": 54
        },
        "resolved": true,
        "details": {
          "function_name": "end",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "30-30",
          "snippet": "const_iterator end() const { return map.end(); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  const_iterator end() const { return map.end(); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "mapScripts.find",
          "args": [
            "hash"
          ],
          "line": 53
        },
        "resolved": true,
        "details": {
          "function_name": "find",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "33-33",
          "snippet": "const_iterator find(const key_type& k) const { return map.find(k); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  const_iterator find(const key_type& k) const { return map.find(k); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 52
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCBasicKeyStore {\n  bool CBasicKeyStore::GetCScript(const CScriptID &hash, CScript& redeemScriptOut) const\n  {\n      {\n          LOCK(cs_KeyStore);\n          ScriptMap::const_iterator mi = mapScripts.find(hash);\n          if (mi != mapScripts.end())\n          {\n              redeemScriptOut = (*mi).second;\n              return true;\n          }\n      }\n      return false;\n  }\n}"
  },
  {
    "function_name": "HaveCScript",
    "container": "CBasicKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "38-46",
    "snippet": "bool CBasicKeyStore::HaveCScript(const CScriptID& hash) const\n{\n    bool result;\n    {\n        LOCK(cs_KeyStore);\n        result = (mapScripts.count(hash) > 0);\n    }\n    return result;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "mapScripts.count",
          "args": [
            "hash"
          ],
          "line": 43
        },
        "resolved": true,
        "details": {
          "function_name": "count",
          "container": "limitedmap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/limitedmap.h",
          "lines": "34-34",
          "snippet": "size_type count(const key_type& k) const { return map.count(k); }",
          "includes": [
            "#include <deque>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <deque>\n#include <map>\n\nlimitedmap {\n  size_type count(const key_type& k) const { return map.count(k); }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 42
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCBasicKeyStore {\n  bool CBasicKeyStore::HaveCScript(const CScriptID& hash) const\n  {\n      bool result;\n      {\n          LOCK(cs_KeyStore);\n          result = (mapScripts.count(hash) > 0);\n      }\n      return result;\n  }\n}"
  },
  {
    "function_name": "AddCScript",
    "container": "CBasicKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "29-36",
    "snippet": "bool CBasicKeyStore::AddCScript(const CScript& redeemScript)\n{\n    {\n        LOCK(cs_KeyStore);\n        mapScripts[redeemScript.GetID()] = redeemScript;\n    }\n    return true;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "redeemScript.GetID",
          "args": [],
          "line": 33
        },
        "resolved": true,
        "details": {
          "function_name": "GetID",
          "container": "CPubKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.h",
          "lines": "80-82",
          "snippet": "CKeyID GetID() const {\n        return CKeyID(Hash160(vchPubKey));\n    }",
          "includes": [
            "#include <openssl/ec.h> // for EC_KEY definition",
            "#include \"util.h\"",
            "#include \"uint256.h\"",
            "#include \"serialize.h\"",
            "#include \"allocators.h\"",
            "#include <vector>",
            "#include <stdexcept>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/ec.h> // for EC_KEY definition\n#include \"util.h\"\n#include \"uint256.h\"\n#include \"serialize.h\"\n#include \"allocators.h\"\n#include <vector>\n#include <stdexcept>\n\nCPubKey {\n  CKeyID GetID() const {\n          return CKeyID(Hash160(vchPubKey));\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 32
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCBasicKeyStore {\n  bool CBasicKeyStore::AddCScript(const CScript& redeemScript)\n  {\n      {\n          LOCK(cs_KeyStore);\n          mapScripts[redeemScript.GetID()] = redeemScript;\n      }\n      return true;\n  }\n}"
  },
  {
    "function_name": "AddKey",
    "container": "CBasicKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "18-27",
    "snippet": "bool CBasicKeyStore::AddKey(const CKey& key)\n{\n    bool fCompressed = false;\n    CSecret secret = key.GetSecret(fCompressed);\n    {\n        LOCK(cs_KeyStore);\n        mapKeys[key.GetPubKey().GetID()] = make_pair(secret, fCompressed);\n    }\n    return true;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "make_pair",
          "args": [
            "secret",
            "fCompressed"
          ],
          "line": 24
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "key.GetPubKey",
          "args": [],
          "line": 24
        },
        "resolved": true,
        "details": {
          "function_name": "GetPubKey",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "274-284",
          "snippet": "CPubKey CKey::GetPubKey() const\n{\n    int nSize = i2o_ECPublicKey(pkey, NULL);\n    if (!nSize)\n        throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey failed\");\n    std::vector<unsigned char> vchPubKey(nSize, 0);\n    unsigned char* pbegin = &vchPubKey[0];\n    if (i2o_ECPublicKey(pkey, &pbegin) != nSize)\n        throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey returned unexpected size\");\n    return CPubKey(vchPubKey);\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  CPubKey CKey::GetPubKey() const\n  {\n      int nSize = i2o_ECPublicKey(pkey, NULL);\n      if (!nSize)\n          throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey failed\");\n      std::vector<unsigned char> vchPubKey(nSize, 0);\n      unsigned char* pbegin = &vchPubKey[0];\n      if (i2o_ECPublicKey(pkey, &pbegin) != nSize)\n          throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey returned unexpected size\");\n      return CPubKey(vchPubKey);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "LOCK",
          "args": [
            "cs_KeyStore"
          ],
          "line": 23
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "key.GetSecret",
          "args": [
            "fCompressed"
          ],
          "line": 21
        },
        "resolved": true,
        "details": {
          "function_name": "GetSecret",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "232-245",
          "snippet": "CSecret CKey::GetSecret(bool &fCompressed) const\n{\n    CSecret vchRet;\n    vchRet.resize(32);\n    const BIGNUM *bn = EC_KEY_get0_private_key(pkey);\n    int nBytes = BN_num_bytes(bn);\n    if (bn == NULL)\n        throw key_error(\"CKey::GetSecret() : EC_KEY_get0_private_key failed\");\n    int n=BN_bn2bin(bn,&vchRet[32 - nBytes]);\n    if (n != nBytes)\n        throw key_error(\"CKey::GetSecret(): BN_bn2bin failed\");\n    fCompressed = fCompressedPubKey;\n    return vchRet;\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  CSecret CKey::GetSecret(bool &fCompressed) const\n  {\n      CSecret vchRet;\n      vchRet.resize(32);\n      const BIGNUM *bn = EC_KEY_get0_private_key(pkey);\n      int nBytes = BN_num_bytes(bn);\n      if (bn == NULL)\n          throw key_error(\"CKey::GetSecret() : EC_KEY_get0_private_key failed\");\n      int n=BN_bn2bin(bn,&vchRet[32 - nBytes]);\n      if (n != nBytes)\n          throw key_error(\"CKey::GetSecret(): BN_bn2bin failed\");\n      fCompressed = fCompressedPubKey;\n      return vchRet;\n  }\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCBasicKeyStore {\n  bool CBasicKeyStore::AddKey(const CKey& key)\n  {\n      bool fCompressed = false;\n      CSecret secret = key.GetSecret(fCompressed);\n      {\n          LOCK(cs_KeyStore);\n          mapKeys[key.GetPubKey().GetID()] = make_pair(secret, fCompressed);\n      }\n      return true;\n  }\n}"
  },
  {
    "function_name": "GetPubKey",
    "container": "CKeyStore",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
    "lines": "9-16",
    "snippet": "bool CKeyStore::GetPubKey(const CKeyID &address, CPubKey &vchPubKeyOut) const\n{\n    CKey key;\n    if (!GetKey(address, key))\n        return false;\n    vchPubKeyOut = key.GetPubKey();\n    return true;\n}",
    "includes": [
      "#include \"script.h\"",
      "#include \"keystore.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "key.GetPubKey",
          "args": [],
          "line": 14
        },
        "resolved": true,
        "details": {
          "function_name": "GetPubKey",
          "container": "CKey",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/key.cpp",
          "lines": "274-284",
          "snippet": "CPubKey CKey::GetPubKey() const\n{\n    int nSize = i2o_ECPublicKey(pkey, NULL);\n    if (!nSize)\n        throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey failed\");\n    std::vector<unsigned char> vchPubKey(nSize, 0);\n    unsigned char* pbegin = &vchPubKey[0];\n    if (i2o_ECPublicKey(pkey, &pbegin) != nSize)\n        throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey returned unexpected size\");\n    return CPubKey(vchPubKey);\n}",
          "includes": [
            "#include \"key.h\"",
            "#include <openssl/obj_mac.h>",
            "#include <openssl/ecdsa.h>",
            "#include <map>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"key.h\"\n#include <openssl/obj_mac.h>\n#include <openssl/ecdsa.h>\n#include <map>\n\nCKey {\n  CPubKey CKey::GetPubKey() const\n  {\n      int nSize = i2o_ECPublicKey(pkey, NULL);\n      if (!nSize)\n          throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey failed\");\n      std::vector<unsigned char> vchPubKey(nSize, 0);\n      unsigned char* pbegin = &vchPubKey[0];\n      if (i2o_ECPublicKey(pkey, &pbegin) != nSize)\n          throw key_error(\"CKey::GetPubKey() : i2o_ECPublicKey returned unexpected size\");\n      return CPubKey(vchPubKey);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "GetKey",
          "args": [
            "address",
            "key"
          ],
          "line": 12
        },
        "resolved": true,
        "details": {
          "function_name": "GetKey",
          "container": "CCryptoKeyStore",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-4300/repo/src/keystore.cpp",
          "lines": "155-178",
          "snippet": "bool CCryptoKeyStore::GetKey(const CKeyID &address, CKey& keyOut) const\n{\n    {\n        LOCK(cs_KeyStore);\n        if (!IsCrypted())\n            return CBasicKeyStore::GetKey(address, keyOut);\n\n        CryptedKeyMap::const_iterator mi = mapCryptedKeys.find(address);\n        if (mi != mapCryptedKeys.end())\n        {\n            const CPubKey &vchPubKey = (*mi).second.first;\n            const std::vector<unsigned char> &vchCryptedSecret = (*mi).second.second;\n            CSecret vchSecret;\n            if (!DecryptSecret(vMasterKey, vchCryptedSecret, vchPubKey.GetHash(), vchSecret))\n                return false;\n            if (vchSecret.size() != 32)\n                return false;\n            keyOut.SetPubKey(vchPubKey);\n            keyOut.SetSecret(vchSecret);\n            return true;\n        }\n    }\n    return false;\n}",
          "includes": [
            "#include \"script.h\"",
            "#include \"keystore.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCCryptoKeyStore {\n  bool CCryptoKeyStore::GetKey(const CKeyID &address, CKey& keyOut) const\n  {\n      {\n          LOCK(cs_KeyStore);\n          if (!IsCrypted())\n              return CBasicKeyStore::GetKey(address, keyOut);\n  \n          CryptedKeyMap::const_iterator mi = mapCryptedKeys.find(address);\n          if (mi != mapCryptedKeys.end())\n          {\n              const CPubKey &vchPubKey = (*mi).second.first;\n              const std::vector<unsigned char> &vchCryptedSecret = (*mi).second.second;\n              CSecret vchSecret;\n              if (!DecryptSecret(vMasterKey, vchCryptedSecret, vchPubKey.GetHash(), vchSecret))\n                  return false;\n              if (vchSecret.size() != 32)\n                  return false;\n              keyOut.SetPubKey(vchPubKey);\n              keyOut.SetSecret(vchSecret);\n              return true;\n          }\n      }\n      return false;\n  }\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"script.h\"\n#include \"keystore.h\"\n\nCKeyStore {\n  bool CKeyStore::GetPubKey(const CKeyID &address, CPubKey &vchPubKeyOut) const\n  {\n      CKey key;\n      if (!GetKey(address, key))\n          return false;\n      vchPubKeyOut = key.GetPubKey();\n      return true;\n  }\n}"
  }
]