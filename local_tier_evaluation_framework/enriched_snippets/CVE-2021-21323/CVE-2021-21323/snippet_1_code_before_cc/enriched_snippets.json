[
  {
    "function_name": "OnBeforeURLRequest_AdBlockTPPreWork",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
    "lines": "219-236",
    "snippet": "int OnBeforeURLRequest_AdBlockTPPreWork(const ResponseCallback& next_callback,\n                                        std::shared_ptr<BraveRequestInfo> ctx) {\n  if (ctx->request_url.is_empty()) {\n    return net::OK;\n  }\n\n  // If the following info isn't available, then proper content settings can't\n  // be looked up, so do nothing.\n  if (ctx->tab_origin.is_empty() || !ctx->allow_brave_shields ||\n      ctx->allow_ads ||\n      ctx->resource_type == BraveRequestInfo::kInvalidResourceType) {\n    return net::OK;\n  }\n\n  OnBeforeURLRequestAdBlockTP(next_callback, ctx);\n\n  return net::ERR_IO_PENDING;\n}",
    "includes": [
      "#include \"url/url_canon.h\"",
      "#include \"ui/base/resource/resource_bundle.h\"",
      "#include \"services/network/network_context.h\"",
      "#include \"mojo/public/cpp/bindings/remote.h\"",
      "#include \"extensions/common/url_pattern.h\"",
      "#include \"content/public/browser/web_contents.h\"",
      "#include \"content/public/browser/storage_partition.h\"",
      "#include \"content/public/browser/render_frame_host.h\"",
      "#include \"content/public/browser/browser_thread.h\"",
      "#include \"content/public/browser/browser_context.h\"",
      "#include \"brave/grit/brave_generated_resources.h\"",
      "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
      "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
      "#include \"brave/common/network_constants.h\"",
      "#include \"brave/browser/net/url_context.h\"",
      "#include \"brave/browser/brave_browser_process_impl.h\"",
      "#include \"base/strings/string_util.h\"",
      "#include \"base/base64url.h\"",
      "#include <vector>",
      "#include <utility>",
      "#include <string>",
      "#include <memory>",
      "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "OnBeforeURLRequestAdBlockTP",
          "args": [
            "next_callback",
            "ctx"
          ],
          "line": 233
        },
        "resolved": true,
        "details": {
          "function_name": "OnBeforeURLRequestAdBlockTP",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
          "lines": "193-217",
          "snippet": "void OnBeforeURLRequestAdBlockTP(const ResponseCallback& next_callback,\n                                 std::shared_ptr<BraveRequestInfo> ctx) {\n  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);\n  // If the following info isn't available, then proper content settings can't\n  // be looked up, so do nothing.\n  if (ctx->tab_origin.is_empty() || !ctx->tab_origin.has_host() ||\n      ctx->request_url.is_empty()) {\n    return;\n  }\n  DCHECK_NE(ctx->request_identifier, 0UL);\n\n  scoped_refptr<base::SequencedTaskRunner> task_runner =\n      g_brave_browser_process->ad_block_service()->GetTaskRunner();\n\n  DCHECK(ctx->browser_context);\n  // DoH or standard DNS quries won't be routed through Tor, so we need to skip\n  // it.\n  if (ctx->browser_context->IsTor()) {\n    ShouldBlockAdWithOptionalCname(task_runner, std::move(next_callback), ctx,\n                                   base::nullopt);\n  } else {\n    new AdblockCnameResolveHostClient(std::move(next_callback), task_runner,\n                                      ctx);\n  }\n}",
          "includes": [
            "#include \"url/url_canon.h\"",
            "#include \"ui/base/resource/resource_bundle.h\"",
            "#include \"services/network/network_context.h\"",
            "#include \"mojo/public/cpp/bindings/remote.h\"",
            "#include \"extensions/common/url_pattern.h\"",
            "#include \"content/public/browser/web_contents.h\"",
            "#include \"content/public/browser/storage_partition.h\"",
            "#include \"content/public/browser/render_frame_host.h\"",
            "#include \"content/public/browser/browser_thread.h\"",
            "#include \"content/public/browser/browser_context.h\"",
            "#include \"brave/grit/brave_generated_resources.h\"",
            "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
            "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
            "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
            "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
            "#include \"brave/common/network_constants.h\"",
            "#include \"brave/browser/net/url_context.h\"",
            "#include \"brave/browser/brave_browser_process_impl.h\"",
            "#include \"base/strings/string_util.h\"",
            "#include \"base/base64url.h\"",
            "#include <vector>",
            "#include <utility>",
            "#include <string>",
            "#include <memory>",
            "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nvoid OnBeforeURLRequestAdBlockTP(const ResponseCallback& next_callback,\n                                 std::shared_ptr<BraveRequestInfo> ctx) {\n  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);\n  // If the following info isn't available, then proper content settings can't\n  // be looked up, so do nothing.\n  if (ctx->tab_origin.is_empty() || !ctx->tab_origin.has_host() ||\n      ctx->request_url.is_empty()) {\n    return;\n  }\n  DCHECK_NE(ctx->request_identifier, 0UL);\n\n  scoped_refptr<base::SequencedTaskRunner> task_runner =\n      g_brave_browser_process->ad_block_service()->GetTaskRunner();\n\n  DCHECK(ctx->browser_context);\n  // DoH or standard DNS quries won't be routed through Tor, so we need to skip\n  // it.\n  if (ctx->browser_context->IsTor()) {\n    ShouldBlockAdWithOptionalCname(task_runner, std::move(next_callback), ctx,\n                                   base::nullopt);\n  } else {\n    new AdblockCnameResolveHostClient(std::move(next_callback), task_runner,\n                                      ctx);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "ctx->tab_origin.is_empty",
          "args": [],
          "line": 227
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctx->request_url.is_empty",
          "args": [],
          "line": 221
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nint OnBeforeURLRequest_AdBlockTPPreWork(const ResponseCallback& next_callback,\n                                        std::shared_ptr<BraveRequestInfo> ctx) {\n  if (ctx->request_url.is_empty()) {\n    return net::OK;\n  }\n\n  // If the following info isn't available, then proper content settings can't\n  // be looked up, so do nothing.\n  if (ctx->tab_origin.is_empty() || !ctx->allow_brave_shields ||\n      ctx->allow_ads ||\n      ctx->resource_type == BraveRequestInfo::kInvalidResourceType) {\n    return net::OK;\n  }\n\n  OnBeforeURLRequestAdBlockTP(next_callback, ctx);\n\n  return net::ERR_IO_PENDING;\n}"
  },
  {
    "function_name": "OnBeforeURLRequestAdBlockTP",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
    "lines": "193-217",
    "snippet": "void OnBeforeURLRequestAdBlockTP(const ResponseCallback& next_callback,\n                                 std::shared_ptr<BraveRequestInfo> ctx) {\n  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);\n  // If the following info isn't available, then proper content settings can't\n  // be looked up, so do nothing.\n  if (ctx->tab_origin.is_empty() || !ctx->tab_origin.has_host() ||\n      ctx->request_url.is_empty()) {\n    return;\n  }\n  DCHECK_NE(ctx->request_identifier, 0UL);\n\n  scoped_refptr<base::SequencedTaskRunner> task_runner =\n      g_brave_browser_process->ad_block_service()->GetTaskRunner();\n\n  DCHECK(ctx->browser_context);\n  // DoH or standard DNS quries won't be routed through Tor, so we need to skip\n  // it.\n  if (ctx->browser_context->IsTor()) {\n    ShouldBlockAdWithOptionalCname(task_runner, std::move(next_callback), ctx,\n                                   base::nullopt);\n  } else {\n    new AdblockCnameResolveHostClient(std::move(next_callback), task_runner,\n                                      ctx);\n  }\n}",
    "includes": [
      "#include \"url/url_canon.h\"",
      "#include \"ui/base/resource/resource_bundle.h\"",
      "#include \"services/network/network_context.h\"",
      "#include \"mojo/public/cpp/bindings/remote.h\"",
      "#include \"extensions/common/url_pattern.h\"",
      "#include \"content/public/browser/web_contents.h\"",
      "#include \"content/public/browser/storage_partition.h\"",
      "#include \"content/public/browser/render_frame_host.h\"",
      "#include \"content/public/browser/browser_thread.h\"",
      "#include \"content/public/browser/browser_context.h\"",
      "#include \"brave/grit/brave_generated_resources.h\"",
      "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
      "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
      "#include \"brave/common/network_constants.h\"",
      "#include \"brave/browser/net/url_context.h\"",
      "#include \"brave/browser/brave_browser_process_impl.h\"",
      "#include \"base/strings/string_util.h\"",
      "#include \"base/base64url.h\"",
      "#include <vector>",
      "#include <utility>",
      "#include <string>",
      "#include <memory>",
      "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "std::move",
          "args": [
            "next_callback"
          ],
          "line": 214
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ShouldBlockAdWithOptionalCname",
          "args": [
            "task_runner",
            "std::move(next_callback)",
            "ctx",
            "base::nullopt"
          ],
          "line": 211
        },
        "resolved": true,
        "details": {
          "function_name": "ShouldBlockAdWithOptionalCname",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
          "lines": "104-113",
          "snippet": "void ShouldBlockAdWithOptionalCname(\n    scoped_refptr<base::SequencedTaskRunner> task_runner,\n    const ResponseCallback& next_callback,\n    std::shared_ptr<BraveRequestInfo> ctx,\n    const base::Optional<std::string> cname) {\n  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);\n  task_runner->PostTaskAndReply(\n      FROM_HERE, base::BindOnce(&ShouldBlockAdOnTaskRunner, ctx, cname),\n      base::BindOnce(&OnShouldBlockAdResult, next_callback, ctx));\n}",
          "includes": [
            "#include \"url/url_canon.h\"",
            "#include \"ui/base/resource/resource_bundle.h\"",
            "#include \"services/network/network_context.h\"",
            "#include \"mojo/public/cpp/bindings/remote.h\"",
            "#include \"extensions/common/url_pattern.h\"",
            "#include \"content/public/browser/web_contents.h\"",
            "#include \"content/public/browser/storage_partition.h\"",
            "#include \"content/public/browser/render_frame_host.h\"",
            "#include \"content/public/browser/browser_thread.h\"",
            "#include \"content/public/browser/browser_context.h\"",
            "#include \"brave/grit/brave_generated_resources.h\"",
            "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
            "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
            "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
            "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
            "#include \"brave/common/network_constants.h\"",
            "#include \"brave/browser/net/url_context.h\"",
            "#include \"brave/browser/brave_browser_process_impl.h\"",
            "#include \"base/strings/string_util.h\"",
            "#include \"base/base64url.h\"",
            "#include <vector>",
            "#include <utility>",
            "#include <string>",
            "#include <memory>",
            "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nvoid ShouldBlockAdWithOptionalCname(\n    scoped_refptr<base::SequencedTaskRunner> task_runner,\n    const ResponseCallback& next_callback,\n    std::shared_ptr<BraveRequestInfo> ctx,\n    const base::Optional<std::string> cname) {\n  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);\n  task_runner->PostTaskAndReply(\n      FROM_HERE, base::BindOnce(&ShouldBlockAdOnTaskRunner, ctx, cname),\n      base::BindOnce(&OnShouldBlockAdResult, next_callback, ctx));\n}"
        }
      },
      {
        "call_info": {
          "callee": "std::move",
          "args": [
            "next_callback"
          ],
          "line": 211
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctx->browser_context->IsTor",
          "args": [],
          "line": 210
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "DCHECK",
          "args": [
            "ctx->browser_context"
          ],
          "line": 207
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "g_brave_browser_process->ad_block_service",
          "args": [],
          "line": 205
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "g_brave_browser_process->ad_block_service",
          "args": [],
          "line": 205
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "DCHECK_NE",
          "args": [
            "ctx->request_identifier",
            "0UL"
          ],
          "line": 202
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctx->request_url.is_empty",
          "args": [],
          "line": 199
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctx->tab_origin.has_host",
          "args": [],
          "line": 198
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctx->tab_origin.is_empty",
          "args": [],
          "line": 198
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "DCHECK_CURRENTLY_ON",
          "args": [
            "content::BrowserThread::UI"
          ],
          "line": 195
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nvoid OnBeforeURLRequestAdBlockTP(const ResponseCallback& next_callback,\n                                 std::shared_ptr<BraveRequestInfo> ctx) {\n  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);\n  // If the following info isn't available, then proper content settings can't\n  // be looked up, so do nothing.\n  if (ctx->tab_origin.is_empty() || !ctx->tab_origin.has_host() ||\n      ctx->request_url.is_empty()) {\n    return;\n  }\n  DCHECK_NE(ctx->request_identifier, 0UL);\n\n  scoped_refptr<base::SequencedTaskRunner> task_runner =\n      g_brave_browser_process->ad_block_service()->GetTaskRunner();\n\n  DCHECK(ctx->browser_context);\n  // DoH or standard DNS quries won't be routed through Tor, so we need to skip\n  // it.\n  if (ctx->browser_context->IsTor()) {\n    ShouldBlockAdWithOptionalCname(task_runner, std::move(next_callback), ctx,\n                                   base::nullopt);\n  } else {\n    new AdblockCnameResolveHostClient(std::move(next_callback), task_runner,\n                                      ctx);\n  }\n}"
  },
  {
    "function_name": "OnHostnameResults",
    "container": "AdblockCnameResolveHostClient",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
    "lines": "188-190",
    "snippet": "void OnHostnameResults(const std::vector<net::HostPortPair>& hosts) override {\n    NOTREACHED();\n  }",
    "includes": [
      "#include \"url/url_canon.h\"",
      "#include \"ui/base/resource/resource_bundle.h\"",
      "#include \"services/network/network_context.h\"",
      "#include \"mojo/public/cpp/bindings/remote.h\"",
      "#include \"extensions/common/url_pattern.h\"",
      "#include \"content/public/browser/web_contents.h\"",
      "#include \"content/public/browser/storage_partition.h\"",
      "#include \"content/public/browser/render_frame_host.h\"",
      "#include \"content/public/browser/browser_thread.h\"",
      "#include \"content/public/browser/browser_context.h\"",
      "#include \"brave/grit/brave_generated_resources.h\"",
      "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
      "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
      "#include \"brave/common/network_constants.h\"",
      "#include \"brave/browser/net/url_context.h\"",
      "#include \"brave/browser/brave_browser_process_impl.h\"",
      "#include \"base/strings/string_util.h\"",
      "#include \"base/base64url.h\"",
      "#include <vector>",
      "#include <utility>",
      "#include <string>",
      "#include <memory>",
      "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "NOTREACHED",
          "args": [],
          "line": 189
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nAdblockCnameResolveHostClient {\n  void OnHostnameResults(const std::vector<net::HostPortPair>& hosts) override {\n      NOTREACHED();\n    }\n}"
  },
  {
    "function_name": "OnTextResults",
    "container": "AdblockCnameResolveHostClient",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
    "lines": "183-185",
    "snippet": "void OnTextResults(const std::vector<std::string>& text_results) override {\n    NOTREACHED();\n  }",
    "includes": [
      "#include \"url/url_canon.h\"",
      "#include \"ui/base/resource/resource_bundle.h\"",
      "#include \"services/network/network_context.h\"",
      "#include \"mojo/public/cpp/bindings/remote.h\"",
      "#include \"extensions/common/url_pattern.h\"",
      "#include \"content/public/browser/web_contents.h\"",
      "#include \"content/public/browser/storage_partition.h\"",
      "#include \"content/public/browser/render_frame_host.h\"",
      "#include \"content/public/browser/browser_thread.h\"",
      "#include \"content/public/browser/browser_context.h\"",
      "#include \"brave/grit/brave_generated_resources.h\"",
      "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
      "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
      "#include \"brave/common/network_constants.h\"",
      "#include \"brave/browser/net/url_context.h\"",
      "#include \"brave/browser/brave_browser_process_impl.h\"",
      "#include \"base/strings/string_util.h\"",
      "#include \"base/base64url.h\"",
      "#include <vector>",
      "#include <utility>",
      "#include <string>",
      "#include <memory>",
      "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "NOTREACHED",
          "args": [],
          "line": 184
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nAdblockCnameResolveHostClient {\n  void OnTextResults(const std::vector<std::string>& text_results) override {\n      NOTREACHED();\n    }\n}"
  },
  {
    "function_name": "OnComplete",
    "container": "AdblockCnameResolveHostClient",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
    "lines": "165-180",
    "snippet": "void OnComplete(\n      int32_t result,\n      const net::ResolveErrorInfo& resolve_error_info,\n      const base::Optional<net::AddressList>& resolved_addresses) override {\n    UMA_HISTOGRAM_TIMES(\"Brave.ShieldsCNAMEBlocking.TotalResolutionTime\",\n                        base::TimeTicks::Now() - start_time_);\n    if (result == net::OK && resolved_addresses) {\n      DCHECK(resolved_addresses.has_value() && !resolved_addresses->empty());\n      std::move(cb_).Run(\n          base::Optional<std::string>(resolved_addresses->canonical_name()));\n    } else {\n      std::move(cb_).Run(base::nullopt);\n    }\n\n    delete this;\n  }",
    "includes": [
      "#include \"url/url_canon.h\"",
      "#include \"ui/base/resource/resource_bundle.h\"",
      "#include \"services/network/network_context.h\"",
      "#include \"mojo/public/cpp/bindings/remote.h\"",
      "#include \"extensions/common/url_pattern.h\"",
      "#include \"content/public/browser/web_contents.h\"",
      "#include \"content/public/browser/storage_partition.h\"",
      "#include \"content/public/browser/render_frame_host.h\"",
      "#include \"content/public/browser/browser_thread.h\"",
      "#include \"content/public/browser/browser_context.h\"",
      "#include \"brave/grit/brave_generated_resources.h\"",
      "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
      "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
      "#include \"brave/common/network_constants.h\"",
      "#include \"brave/browser/net/url_context.h\"",
      "#include \"brave/browser/brave_browser_process_impl.h\"",
      "#include \"base/strings/string_util.h\"",
      "#include \"base/base64url.h\"",
      "#include <vector>",
      "#include <utility>",
      "#include <string>",
      "#include <memory>",
      "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "std::move",
          "args": [
            "base::nullopt"
          ],
          "line": 176
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "std::move",
          "args": [
            "cb_"
          ],
          "line": 176
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "std::move",
          "args": [
            "base::Optional<std::string>(resolved_addresses->canonical_name())"
          ],
          "line": 173
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base::Optional<std::string>",
          "args": [
            "resolved_addresses->canonical_name()"
          ],
          "line": 174
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "resolved_addresses->canonical_name",
          "args": [],
          "line": 174
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "std::move",
          "args": [
            "cb_"
          ],
          "line": 173
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "DCHECK",
          "args": [
            "resolved_addresses.has_value() && !resolved_addresses->empty()"
          ],
          "line": 172
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "resolved_addresses->empty",
          "args": [],
          "line": 172
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "resolved_addresses.has_value",
          "args": [],
          "line": 172
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "UMA_HISTOGRAM_TIMES",
          "args": [
            "\"Brave.ShieldsCNAMEBlocking.TotalResolutionTime\"",
            "base::TimeTicks::Now() - start_time_"
          ],
          "line": 169
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base::TimeTicks::Now",
          "args": [],
          "line": 170
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nAdblockCnameResolveHostClient {\n  void OnComplete(\n        int32_t result,\n        const net::ResolveErrorInfo& resolve_error_info,\n        const base::Optional<net::AddressList>& resolved_addresses) override {\n      UMA_HISTOGRAM_TIMES(\"Brave.ShieldsCNAMEBlocking.TotalResolutionTime\",\n                          base::TimeTicks::Now() - start_time_);\n      if (result == net::OK && resolved_addresses) {\n        DCHECK(resolved_addresses.has_value() && !resolved_addresses->empty());\n        std::move(cb_).Run(\n            base::Optional<std::string>(resolved_addresses->canonical_name()));\n      } else {\n        std::move(cb_).Run(base::nullopt);\n      }\n  \n      delete this;\n    }\n}"
  },
  {
    "function_name": "AdblockCnameResolveHostClient",
    "container": "AdblockCnameResolveHostClient",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
    "lines": "122-163",
    "snippet": "AdblockCnameResolveHostClient(\n      const ResponseCallback& next_callback,\n      scoped_refptr<base::SequencedTaskRunner> task_runner,\n      std::shared_ptr<BraveRequestInfo> ctx) {\n    cb_ = base::BindOnce(&ShouldBlockAdWithOptionalCname, task_runner,\n                         std::move(next_callback), ctx);\n\n    auto* web_contents = GetWebContents(\n        ctx->render_process_id, ctx->render_frame_id, ctx->frame_tree_node_id);\n    if (!web_contents) {\n      start_time_ = base::TimeTicks::Now();\n      this->OnComplete(net::ERR_FAILED, net::ResolveErrorInfo(), base::nullopt);\n      return;\n    }\n\n    content::BrowserContext* context = web_contents->GetBrowserContext();\n\n    const auto network_isolation_key = ctx->network_isolation_key;\n\n    network::mojom::ResolveHostParametersPtr optional_parameters =\n        network::mojom::ResolveHostParameters::New();\n    optional_parameters->include_canonical_name = true;\n    // Explicitly specify source to avoid using `HostResolverProc`\n    // which will be handled by system resolver\n    // See https://crbug.com/872665\n    optional_parameters->source = net::HostResolverSource::DNS;\n\n    network::mojom::NetworkContext* network_context =\n        content::BrowserContext::GetDefaultStoragePartition(context)\n            ->GetNetworkContext();\n\n    start_time_ = base::TimeTicks::Now();\n\n    network_context->ResolveHost(\n        net::HostPortPair::FromURL(ctx->request_url), network_isolation_key,\n        std::move(optional_parameters), receiver_.BindNewPipeAndPassRemote());\n\n    receiver_.set_disconnect_handler(\n        base::BindOnce(&AdblockCnameResolveHostClient::OnComplete,\n                       base::Unretained(this), net::ERR_NAME_NOT_RESOLVED,\n                       net::ResolveErrorInfo(net::ERR_FAILED), base::nullopt));\n  }",
    "includes": [
      "#include \"url/url_canon.h\"",
      "#include \"ui/base/resource/resource_bundle.h\"",
      "#include \"services/network/network_context.h\"",
      "#include \"mojo/public/cpp/bindings/remote.h\"",
      "#include \"extensions/common/url_pattern.h\"",
      "#include \"content/public/browser/web_contents.h\"",
      "#include \"content/public/browser/storage_partition.h\"",
      "#include \"content/public/browser/render_frame_host.h\"",
      "#include \"content/public/browser/browser_thread.h\"",
      "#include \"content/public/browser/browser_context.h\"",
      "#include \"brave/grit/brave_generated_resources.h\"",
      "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
      "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
      "#include \"brave/common/network_constants.h\"",
      "#include \"brave/browser/net/url_context.h\"",
      "#include \"brave/browser/brave_browser_process_impl.h\"",
      "#include \"base/strings/string_util.h\"",
      "#include \"base/base64url.h\"",
      "#include <vector>",
      "#include <utility>",
      "#include <string>",
      "#include <memory>",
      "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "receiver_.set_disconnect_handler",
          "args": [
            "base::BindOnce(&AdblockCnameResolveHostClient::OnComplete,\n                       base::Unretained(this), net::ERR_NAME_NOT_RESOLVED,\n                       net::ResolveErrorInfo(net::ERR_FAILED), base::nullopt)"
          ],
          "line": 159
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base::BindOnce",
          "args": [
            "&AdblockCnameResolveHostClient::OnComplete",
            "base::Unretained(this)",
            "net::ERR_NAME_NOT_RESOLVED",
            "net::ResolveErrorInfo(net::ERR_FAILED)",
            "base::nullopt"
          ],
          "line": 160
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "net::ResolveErrorInfo",
          "args": [
            "net::ERR_FAILED"
          ],
          "line": 162
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base::Unretained",
          "args": [
            "this"
          ],
          "line": 161
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "network_context->ResolveHost",
          "args": [
            "net::HostPortPair::FromURL(ctx->request_url)",
            "network_isolation_key",
            "std::move(optional_parameters)",
            "receiver_.BindNewPipeAndPassRemote()"
          ],
          "line": 155
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "receiver_.BindNewPipeAndPassRemote",
          "args": [],
          "line": 157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "std::move",
          "args": [
            "optional_parameters"
          ],
          "line": 157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "net::HostPortPair::FromURL",
          "args": [
            "ctx->request_url"
          ],
          "line": 156
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base::TimeTicks::Now",
          "args": [],
          "line": 153
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content::BrowserContext::GetDefaultStoragePartition",
          "args": [],
          "line": 150
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content::BrowserContext::GetDefaultStoragePartition",
          "args": [
            "context"
          ],
          "line": 150
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "network::mojom::ResolveHostParameters::New",
          "args": [],
          "line": 142
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "web_contents->GetBrowserContext",
          "args": [],
          "line": 137
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "this->OnComplete",
          "args": [
            "net::ERR_FAILED",
            "net::ResolveErrorInfo()",
            "base::nullopt"
          ],
          "line": 133
        },
        "resolved": true,
        "details": {
          "function_name": "OnComplete",
          "container": "AdblockCnameResolveHostClient",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
          "lines": "165-180",
          "snippet": "void OnComplete(\n      int32_t result,\n      const net::ResolveErrorInfo& resolve_error_info,\n      const base::Optional<net::AddressList>& resolved_addresses) override {\n    UMA_HISTOGRAM_TIMES(\"Brave.ShieldsCNAMEBlocking.TotalResolutionTime\",\n                        base::TimeTicks::Now() - start_time_);\n    if (result == net::OK && resolved_addresses) {\n      DCHECK(resolved_addresses.has_value() && !resolved_addresses->empty());\n      std::move(cb_).Run(\n          base::Optional<std::string>(resolved_addresses->canonical_name()));\n    } else {\n      std::move(cb_).Run(base::nullopt);\n    }\n\n    delete this;\n  }",
          "includes": [
            "#include \"url/url_canon.h\"",
            "#include \"ui/base/resource/resource_bundle.h\"",
            "#include \"services/network/network_context.h\"",
            "#include \"mojo/public/cpp/bindings/remote.h\"",
            "#include \"extensions/common/url_pattern.h\"",
            "#include \"content/public/browser/web_contents.h\"",
            "#include \"content/public/browser/storage_partition.h\"",
            "#include \"content/public/browser/render_frame_host.h\"",
            "#include \"content/public/browser/browser_thread.h\"",
            "#include \"content/public/browser/browser_context.h\"",
            "#include \"brave/grit/brave_generated_resources.h\"",
            "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
            "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
            "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
            "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
            "#include \"brave/common/network_constants.h\"",
            "#include \"brave/browser/net/url_context.h\"",
            "#include \"brave/browser/brave_browser_process_impl.h\"",
            "#include \"base/strings/string_util.h\"",
            "#include \"base/base64url.h\"",
            "#include <vector>",
            "#include <utility>",
            "#include <string>",
            "#include <memory>",
            "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nAdblockCnameResolveHostClient {\n  void OnComplete(\n        int32_t result,\n        const net::ResolveErrorInfo& resolve_error_info,\n        const base::Optional<net::AddressList>& resolved_addresses) override {\n      UMA_HISTOGRAM_TIMES(\"Brave.ShieldsCNAMEBlocking.TotalResolutionTime\",\n                          base::TimeTicks::Now() - start_time_);\n      if (result == net::OK && resolved_addresses) {\n        DCHECK(resolved_addresses.has_value() && !resolved_addresses->empty());\n        std::move(cb_).Run(\n            base::Optional<std::string>(resolved_addresses->canonical_name()));\n      } else {\n        std::move(cb_).Run(base::nullopt);\n      }\n  \n      delete this;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "net::ResolveErrorInfo",
          "args": [],
          "line": 133
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base::TimeTicks::Now",
          "args": [],
          "line": 132
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GetWebContents",
          "args": [
            "ctx->render_process_id",
            "ctx->render_frame_id",
            "ctx->frame_tree_node_id"
          ],
          "line": 129
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base::BindOnce",
          "args": [
            "&ShouldBlockAdWithOptionalCname",
            "task_runner",
            "std::move(next_callback)",
            "ctx"
          ],
          "line": 126
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "std::move",
          "args": [
            "next_callback"
          ],
          "line": 127
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nAdblockCnameResolveHostClient {\n  AdblockCnameResolveHostClient(\n        const ResponseCallback& next_callback,\n        scoped_refptr<base::SequencedTaskRunner> task_runner,\n        std::shared_ptr<BraveRequestInfo> ctx) {\n      cb_ = base::BindOnce(&ShouldBlockAdWithOptionalCname, task_runner,\n                           std::move(next_callback), ctx);\n  \n      auto* web_contents = GetWebContents(\n          ctx->render_process_id, ctx->render_frame_id, ctx->frame_tree_node_id);\n      if (!web_contents) {\n        start_time_ = base::TimeTicks::Now();\n        this->OnComplete(net::ERR_FAILED, net::ResolveErrorInfo(), base::nullopt);\n        return;\n      }\n  \n      content::BrowserContext* context = web_contents->GetBrowserContext();\n  \n      const auto network_isolation_key = ctx->network_isolation_key;\n  \n      network::mojom::ResolveHostParametersPtr optional_parameters =\n          network::mojom::ResolveHostParameters::New();\n      optional_parameters->include_canonical_name = true;\n      // Explicitly specify source to avoid using `HostResolverProc`\n      // which will be handled by system resolver\n      // See https://crbug.com/872665\n      optional_parameters->source = net::HostResolverSource::DNS;\n  \n      network::mojom::NetworkContext* network_context =\n          content::BrowserContext::GetDefaultStoragePartition(context)\n              ->GetNetworkContext();\n  \n      start_time_ = base::TimeTicks::Now();\n  \n      network_context->ResolveHost(\n          net::HostPortPair::FromURL(ctx->request_url), network_isolation_key,\n          std::move(optional_parameters), receiver_.BindNewPipeAndPassRemote());\n  \n      receiver_.set_disconnect_handler(\n          base::BindOnce(&AdblockCnameResolveHostClient::OnComplete,\n                         base::Unretained(this), net::ERR_NAME_NOT_RESOLVED,\n                         net::ResolveErrorInfo(net::ERR_FAILED), base::nullopt));\n    }\n}"
  },
  {
    "function_name": "ShouldBlockAdWithOptionalCname",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
    "lines": "104-113",
    "snippet": "void ShouldBlockAdWithOptionalCname(\n    scoped_refptr<base::SequencedTaskRunner> task_runner,\n    const ResponseCallback& next_callback,\n    std::shared_ptr<BraveRequestInfo> ctx,\n    const base::Optional<std::string> cname) {\n  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);\n  task_runner->PostTaskAndReply(\n      FROM_HERE, base::BindOnce(&ShouldBlockAdOnTaskRunner, ctx, cname),\n      base::BindOnce(&OnShouldBlockAdResult, next_callback, ctx));\n}",
    "includes": [
      "#include \"url/url_canon.h\"",
      "#include \"ui/base/resource/resource_bundle.h\"",
      "#include \"services/network/network_context.h\"",
      "#include \"mojo/public/cpp/bindings/remote.h\"",
      "#include \"extensions/common/url_pattern.h\"",
      "#include \"content/public/browser/web_contents.h\"",
      "#include \"content/public/browser/storage_partition.h\"",
      "#include \"content/public/browser/render_frame_host.h\"",
      "#include \"content/public/browser/browser_thread.h\"",
      "#include \"content/public/browser/browser_context.h\"",
      "#include \"brave/grit/brave_generated_resources.h\"",
      "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
      "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
      "#include \"brave/common/network_constants.h\"",
      "#include \"brave/browser/net/url_context.h\"",
      "#include \"brave/browser/brave_browser_process_impl.h\"",
      "#include \"base/strings/string_util.h\"",
      "#include \"base/base64url.h\"",
      "#include <vector>",
      "#include <utility>",
      "#include <string>",
      "#include <memory>",
      "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "task_runner->PostTaskAndReply",
          "args": [
            "FROM_HERE",
            "base::BindOnce(&ShouldBlockAdOnTaskRunner, ctx, cname)",
            "base::BindOnce(&OnShouldBlockAdResult, next_callback, ctx)"
          ],
          "line": 110
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base::BindOnce",
          "args": [
            "&OnShouldBlockAdResult",
            "next_callback",
            "ctx"
          ],
          "line": 112
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base::BindOnce",
          "args": [
            "&ShouldBlockAdOnTaskRunner",
            "ctx",
            "cname"
          ],
          "line": 111
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "DCHECK_CURRENTLY_ON",
          "args": [
            "content::BrowserThread::UI"
          ],
          "line": 109
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nvoid ShouldBlockAdWithOptionalCname(\n    scoped_refptr<base::SequencedTaskRunner> task_runner,\n    const ResponseCallback& next_callback,\n    std::shared_ptr<BraveRequestInfo> ctx,\n    const base::Optional<std::string> cname) {\n  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);\n  task_runner->PostTaskAndReply(\n      FROM_HERE, base::BindOnce(&ShouldBlockAdOnTaskRunner, ctx, cname),\n      base::BindOnce(&OnShouldBlockAdResult, next_callback, ctx));\n}"
  },
  {
    "function_name": "OnShouldBlockAdResult",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
    "lines": "93-102",
    "snippet": "void OnShouldBlockAdResult(const ResponseCallback& next_callback,\n                           std::shared_ptr<BraveRequestInfo> ctx) {\n  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);\n  if (ctx->blocked_by == kAdBlocked) {\n    brave_shields::DispatchBlockedEvent(\n        ctx->request_url, ctx->render_frame_id, ctx->render_process_id,\n        ctx->frame_tree_node_id, brave_shields::kAds);\n  }\n  next_callback.Run();\n}",
    "includes": [
      "#include \"url/url_canon.h\"",
      "#include \"ui/base/resource/resource_bundle.h\"",
      "#include \"services/network/network_context.h\"",
      "#include \"mojo/public/cpp/bindings/remote.h\"",
      "#include \"extensions/common/url_pattern.h\"",
      "#include \"content/public/browser/web_contents.h\"",
      "#include \"content/public/browser/storage_partition.h\"",
      "#include \"content/public/browser/render_frame_host.h\"",
      "#include \"content/public/browser/browser_thread.h\"",
      "#include \"content/public/browser/browser_context.h\"",
      "#include \"brave/grit/brave_generated_resources.h\"",
      "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
      "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
      "#include \"brave/common/network_constants.h\"",
      "#include \"brave/browser/net/url_context.h\"",
      "#include \"brave/browser/brave_browser_process_impl.h\"",
      "#include \"base/strings/string_util.h\"",
      "#include \"base/base64url.h\"",
      "#include <vector>",
      "#include <utility>",
      "#include <string>",
      "#include <memory>",
      "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "next_callback.Run",
          "args": [],
          "line": 101
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "brave_shields::DispatchBlockedEvent",
          "args": [
            "ctx->request_url",
            "ctx->render_frame_id",
            "ctx->render_process_id",
            "ctx->frame_tree_node_id",
            "brave_shields::kAds"
          ],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "DCHECK_CURRENTLY_ON",
          "args": [
            "content::BrowserThread::UI"
          ],
          "line": 95
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nvoid OnShouldBlockAdResult(const ResponseCallback& next_callback,\n                           std::shared_ptr<BraveRequestInfo> ctx) {\n  DCHECK_CURRENTLY_ON(content::BrowserThread::UI);\n  if (ctx->blocked_by == kAdBlocked) {\n    brave_shields::DispatchBlockedEvent(\n        ctx->request_url, ctx->render_frame_id, ctx->render_process_id,\n        ctx->frame_tree_node_id, brave_shields::kAds);\n  }\n  next_callback.Run();\n}"
  },
  {
    "function_name": "ShouldBlockAdOnTaskRunner",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2021-21323/snippet_1/code_before.cc",
    "lines": "57-91",
    "snippet": "void ShouldBlockAdOnTaskRunner(std::shared_ptr<BraveRequestInfo> ctx,\n                               base::Optional<std::string> canonical_name) {\n  bool did_match_rule = false;\n  bool did_match_exception = false;\n  bool did_match_important = false;\n  if (!ctx->initiator_url.is_valid()) {\n    return;\n  }\n  std::string source_host = ctx->initiator_url.host();\n\n  g_brave_browser_process->ad_block_service()->ShouldStartRequest(\n      ctx->request_url, ctx->resource_type, source_host, &did_match_rule,\n      &did_match_exception, &did_match_important, &ctx->mock_data_url);\n  if (did_match_important) {\n    ctx->blocked_by = kAdBlocked;\n    return;\n  }\n\n  if (canonical_name.has_value() &&\n      ctx->request_url.host() != *canonical_name && *canonical_name != \"\") {\n    GURL::Replacements replacements = GURL::Replacements();\n    replacements.SetHost(\n        canonical_name->c_str(),\n        url::Component(0, static_cast<int>(canonical_name->length())));\n    const GURL canonical_url = ctx->request_url.ReplaceComponents(replacements);\n\n    g_brave_browser_process->ad_block_service()->ShouldStartRequest(\n        ctx->request_url, ctx->resource_type, source_host, &did_match_rule,\n        &did_match_exception, &did_match_important, &ctx->mock_data_url);\n  }\n\n  if (did_match_important || (did_match_rule && !did_match_exception)) {\n    ctx->blocked_by = kAdBlocked;\n  }\n}",
    "includes": [
      "#include \"url/url_canon.h\"",
      "#include \"ui/base/resource/resource_bundle.h\"",
      "#include \"services/network/network_context.h\"",
      "#include \"mojo/public/cpp/bindings/remote.h\"",
      "#include \"extensions/common/url_pattern.h\"",
      "#include \"content/public/browser/web_contents.h\"",
      "#include \"content/public/browser/storage_partition.h\"",
      "#include \"content/public/browser/render_frame_host.h\"",
      "#include \"content/public/browser/browser_thread.h\"",
      "#include \"content/public/browser/browser_context.h\"",
      "#include \"brave/grit/brave_generated_resources.h\"",
      "#include \"brave/components/brave_shields/common/brave_shield_constants.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"",
      "#include \"brave/components/brave_shields/browser/brave_shields_util.h\"",
      "#include \"brave/components/brave_shields/browser/ad_block_service.h\"",
      "#include \"brave/common/network_constants.h\"",
      "#include \"brave/browser/net/url_context.h\"",
      "#include \"brave/browser/brave_browser_process_impl.h\"",
      "#include \"base/strings/string_util.h\"",
      "#include \"base/base64url.h\"",
      "#include <vector>",
      "#include <utility>",
      "#include <string>",
      "#include <memory>",
      "#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "g_brave_browser_process->ad_block_service",
          "args": [
            "ctx->request_url",
            "ctx->resource_type",
            "source_host",
            "&did_match_rule",
            "&did_match_exception",
            "&did_match_important",
            "&ctx->mock_data_url"
          ],
          "line": 83
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "g_brave_browser_process->ad_block_service",
          "args": [],
          "line": 83
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctx->request_url.ReplaceComponents",
          "args": [
            "replacements"
          ],
          "line": 81
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "replacements.SetHost",
          "args": [
            "canonical_name->c_str()",
            "url::Component(0, static_cast<int>(canonical_name->length()))"
          ],
          "line": 78
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "url::Component",
          "args": [
            "0",
            "static_cast<int>(canonical_name->length())"
          ],
          "line": 80
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "static_cast<int>",
          "args": [
            "canonical_name->length()"
          ],
          "line": 80
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "canonical_name->length",
          "args": [],
          "line": 80
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "canonical_name->c_str",
          "args": [],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GURL::Replacements",
          "args": [],
          "line": 77
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctx->request_url.host",
          "args": [],
          "line": 76
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "canonical_name.has_value",
          "args": [],
          "line": 75
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "g_brave_browser_process->ad_block_service",
          "args": [
            "ctx->request_url",
            "ctx->resource_type",
            "source_host",
            "&did_match_rule",
            "&did_match_exception",
            "&did_match_important",
            "&ctx->mock_data_url"
          ],
          "line": 67
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "g_brave_browser_process->ad_block_service",
          "args": [],
          "line": 67
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctx->initiator_url.host",
          "args": [],
          "line": 65
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctx->initiator_url.is_valid",
          "args": [],
          "line": 62
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"url/url_canon.h\"\n#include \"ui/base/resource/resource_bundle.h\"\n#include \"services/network/network_context.h\"\n#include \"mojo/public/cpp/bindings/remote.h\"\n#include \"extensions/common/url_pattern.h\"\n#include \"content/public/browser/web_contents.h\"\n#include \"content/public/browser/storage_partition.h\"\n#include \"content/public/browser/render_frame_host.h\"\n#include \"content/public/browser/browser_thread.h\"\n#include \"content/public/browser/browser_context.h\"\n#include \"brave/grit/brave_generated_resources.h\"\n#include \"brave/components/brave_shields/common/brave_shield_constants.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_web_contents_observer.h\"\n#include \"brave/components/brave_shields/browser/brave_shields_util.h\"\n#include \"brave/components/brave_shields/browser/ad_block_service.h\"\n#include \"brave/common/network_constants.h\"\n#include \"brave/browser/net/url_context.h\"\n#include \"brave/browser/brave_browser_process_impl.h\"\n#include \"base/strings/string_util.h\"\n#include \"base/base64url.h\"\n#include <vector>\n#include <utility>\n#include <string>\n#include <memory>\n#include \"brave/browser/net/brave_ad_block_tp_network_delegate_helper.h\"\n\nvoid ShouldBlockAdOnTaskRunner(std::shared_ptr<BraveRequestInfo> ctx,\n                               base::Optional<std::string> canonical_name) {\n  bool did_match_rule = false;\n  bool did_match_exception = false;\n  bool did_match_important = false;\n  if (!ctx->initiator_url.is_valid()) {\n    return;\n  }\n  std::string source_host = ctx->initiator_url.host();\n\n  g_brave_browser_process->ad_block_service()->ShouldStartRequest(\n      ctx->request_url, ctx->resource_type, source_host, &did_match_rule,\n      &did_match_exception, &did_match_important, &ctx->mock_data_url);\n  if (did_match_important) {\n    ctx->blocked_by = kAdBlocked;\n    return;\n  }\n\n  if (canonical_name.has_value() &&\n      ctx->request_url.host() != *canonical_name && *canonical_name != \"\") {\n    GURL::Replacements replacements = GURL::Replacements();\n    replacements.SetHost(\n        canonical_name->c_str(),\n        url::Component(0, static_cast<int>(canonical_name->length())));\n    const GURL canonical_url = ctx->request_url.ReplaceComponents(replacements);\n\n    g_brave_browser_process->ad_block_service()->ShouldStartRequest(\n        ctx->request_url, ctx->resource_type, source_host, &did_match_rule,\n        &did_match_exception, &did_match_important, &ctx->mock_data_url);\n  }\n\n  if (did_match_important || (did_match_rule && !did_match_exception)) {\n    ctx->blocked_by = kAdBlocked;\n  }\n}"
  }
]