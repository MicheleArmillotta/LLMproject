[
  {
    "function_name": "call",
    "container": "Cmd",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2013-7299/repo/framework/common/cmd.cpp",
    "lines": "39-56",
    "snippet": "void Cmd::call(const Compident& ci, const QueryParams& queryParams)\n  {\n    HttpRequest request(application, &socketIf);\n    request.setQueryParams(queryParams);\n\n    // set thread context for thread scope\n    request.setThreadContext(&threadContext);\n\n    // sets session and application scope\n    scopeManager.preCall(request, ci.libname);\n    scopeManager.setSessionId(request, sessionId);\n\n    // fetch and call the component\n    comploader.fetchComp(ci)(request, reply, request.getQueryParams());\n\n    // sets session cookie if needed\n    sessionId = scopeManager.postCall(request, reply, application.getAppName());\n  }",
    "includes": [
      "#include <tnt/cmd.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "scopeManager.postCall",
          "args": [
            "request",
            "reply",
            "application.getAppName()"
          ],
          "line": 55
        },
        "resolved": true,
        "details": {
          "function_name": "postCall",
          "container": "ScopeManager",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2013-7299/repo/framework/common/scopemanager.cpp",
          "lines": "246-317",
          "snippet": "std::string ScopeManager::postCall(HttpRequest& request, HttpReply& reply, const std::string& app)\n  {\n    std::string currentSessionCookieName = app.empty() ? std::string(\"tntnet\") : \"tntnet.\" + app;\n    std::string currentSecureSessionCookieName = app.empty() ? std::string(\"stntnet\") : \"stntnet.\" + app;\n\n    std::string sessionId;\n\n    if (reply.isClearSession())\n    {\n      sessionId = request.getCookie(currentSessionCookieName);\n      if (!sessionId.empty())\n        removeSessionScope(sessionId);\n\n      std::string secureSessionId = request.getCookie(currentSecureSessionCookieName);\n      if (!secureSessionId.empty())\n        removeSessionScope(secureSessionId);\n    }\n    else\n    {\n      if (request.hasSessionScope())\n      {\n        // request has session scope\n        sessionId = request.getCookie(currentSessionCookieName);\n        if (sessionId.empty())\n        {\n          // client has no sessionId\n\n          cxxtools::Md5stream c;\n          c << request.getSerial() << '-' << ::pthread_self() << '-' << rand();\n          sessionId = c.getHexDigest();\n          log_info(\"create new session \" << sessionId);\n          reply.setCookie(currentSessionCookieName, sessionId);\n          putSessionScope(sessionId, &request.getSessionScope());\n        }\n        else if (!hasSessionScope(sessionId))\n        {\n          // client has a sessionId but no associated session\n          // this may happen, when tntnet is restarted while the browser has a session\n\n          putSessionScope(sessionId, &request.getSessionScope());\n        }\n      }\n\n      if (request.isSsl() && request.hasSecureSessionScope())\n      {\n        // request has secure session scope\n        std::string sessionId = request.getCookie(currentSecureSessionCookieName);\n        if (sessionId.empty())\n        {\n          // client has no sessionId\n\n          cxxtools::Md5stream c;\n          c << request.getSerial() << '-' << ::pthread_self() << '-' << rand();\n          sessionId = c.getHexDigest();\n          log_info(\"create new secure session \" << sessionId);\n          tnt::Cookie cookie(sessionId);\n          cookie.setSecure();\n          reply.setCookie(currentSecureSessionCookieName, cookie);\n          putSessionScope(sessionId, &request.getSecureSessionScope());\n        }\n        else if (!hasSessionScope(sessionId))\n        {\n          // client has a sessionId but no associated session\n          // this may happen, when tntnet is restarted while the browser has a session\n\n          putSessionScope(sessionId, &request.getSecureSessionScope());\n        }\n      }\n    }\n\n    return sessionId;\n  }",
          "includes": [
            "#include <stdlib.h>",
            "#include <pthread.h>",
            "#include <cxxtools/md5stream.h>",
            "#include <cxxtools/log.h>",
            "#include \"tnt/httpreply.h\"",
            "#include \"tnt/httprequest.h\"",
            "#include \"tnt/sessionscope.h\"",
            "#include \"tnt/scopemanager.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdlib.h>\n#include <pthread.h>\n#include <cxxtools/md5stream.h>\n#include <cxxtools/log.h>\n#include \"tnt/httpreply.h\"\n#include \"tnt/httprequest.h\"\n#include \"tnt/sessionscope.h\"\n#include \"tnt/scopemanager.h\"\n\nScopeManager {\n  std::string ScopeManager::postCall(HttpRequest& request, HttpReply& reply, const std::string& app)\n    {\n      std::string currentSessionCookieName = app.empty() ? std::string(\"tntnet\") : \"tntnet.\" + app;\n      std::string currentSecureSessionCookieName = app.empty() ? std::string(\"stntnet\") : \"stntnet.\" + app;\n  \n      std::string sessionId;\n  \n      if (reply.isClearSession())\n      {\n        sessionId = request.getCookie(currentSessionCookieName);\n        if (!sessionId.empty())\n          removeSessionScope(sessionId);\n  \n        std::string secureSessionId = request.getCookie(currentSecureSessionCookieName);\n        if (!secureSessionId.empty())\n          removeSessionScope(secureSessionId);\n      }\n      else\n      {\n        if (request.hasSessionScope())\n        {\n          // request has session scope\n          sessionId = request.getCookie(currentSessionCookieName);\n          if (sessionId.empty())\n          {\n            // client has no sessionId\n  \n            cxxtools::Md5stream c;\n            c << request.getSerial() << '-' << ::pthread_self() << '-' << rand();\n            sessionId = c.getHexDigest();\n            log_info(\"create new session \" << sessionId);\n            reply.setCookie(currentSessionCookieName, sessionId);\n            putSessionScope(sessionId, &request.getSessionScope());\n          }\n          else if (!hasSessionScope(sessionId))\n          {\n            // client has a sessionId but no associated session\n            // this may happen, when tntnet is restarted while the browser has a session\n  \n            putSessionScope(sessionId, &request.getSessionScope());\n          }\n        }\n  \n        if (request.isSsl() && request.hasSecureSessionScope())\n        {\n          // request has secure session scope\n          std::string sessionId = request.getCookie(currentSecureSessionCookieName);\n          if (sessionId.empty())\n          {\n            // client has no sessionId\n  \n            cxxtools::Md5stream c;\n            c << request.getSerial() << '-' << ::pthread_self() << '-' << rand();\n            sessionId = c.getHexDigest();\n            log_info(\"create new secure session \" << sessionId);\n            tnt::Cookie cookie(sessionId);\n            cookie.setSecure();\n            reply.setCookie(currentSecureSessionCookieName, cookie);\n            putSessionScope(sessionId, &request.getSecureSessionScope());\n          }\n          else if (!hasSessionScope(sessionId))\n          {\n            // client has a sessionId but no associated session\n            // this may happen, when tntnet is restarted while the browser has a session\n  \n            putSessionScope(sessionId, &request.getSecureSessionScope());\n          }\n        }\n      }\n  \n      return sessionId;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "application.getAppName",
          "args": [],
          "line": 55
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "comploader.fetchComp",
          "args": [
            "request",
            "reply",
            "request.getQueryParams()"
          ],
          "line": 52
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "request.getQueryParams",
          "args": [],
          "line": 52
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "comploader.fetchComp",
          "args": [
            "ci"
          ],
          "line": 52
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "scopeManager.setSessionId",
          "args": [
            "request",
            "sessionId"
          ],
          "line": 49
        },
        "resolved": true,
        "details": {
          "function_name": "setSessionId",
          "container": "ScopeManager",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2013-7299/repo/framework/common/scopemanager.cpp",
          "lines": "229-244",
          "snippet": "void ScopeManager::setSessionId(HttpRequest& request, const std::string& sessionId)\n  {\n    if (sessionId.empty())\n    {\n      request.setSessionScope(0);\n    }\n    else\n    {\n      Sessionscope* sessionScope = getSessionScope(sessionId);\n      if (sessionScope != 0)\n      {\n        log_debug(\"session found\");\n        request.setSessionScope(sessionScope);\n      }\n    }\n  }",
          "includes": [
            "#include <stdlib.h>",
            "#include <pthread.h>",
            "#include <cxxtools/md5stream.h>",
            "#include <cxxtools/log.h>",
            "#include \"tnt/httpreply.h\"",
            "#include \"tnt/httprequest.h\"",
            "#include \"tnt/sessionscope.h\"",
            "#include \"tnt/scopemanager.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdlib.h>\n#include <pthread.h>\n#include <cxxtools/md5stream.h>\n#include <cxxtools/log.h>\n#include \"tnt/httpreply.h\"\n#include \"tnt/httprequest.h\"\n#include \"tnt/sessionscope.h\"\n#include \"tnt/scopemanager.h\"\n\nScopeManager {\n  void ScopeManager::setSessionId(HttpRequest& request, const std::string& sessionId)\n    {\n      if (sessionId.empty())\n      {\n        request.setSessionScope(0);\n      }\n      else\n      {\n        Sessionscope* sessionScope = getSessionScope(sessionId);\n        if (sessionScope != 0)\n        {\n          log_debug(\"session found\");\n          request.setSessionScope(sessionScope);\n        }\n      }\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "scopeManager.preCall",
          "args": [
            "request",
            "ci.libname"
          ],
          "line": 48
        },
        "resolved": true,
        "details": {
          "function_name": "preCall",
          "container": "ScopeManager",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2013-7299/repo/framework/common/scopemanager.cpp",
          "lines": "140-227",
          "snippet": "void ScopeManager::preCall(HttpRequest& request, const std::string& app)\n  {\n    // check session-cookie\n    std::string currentSessionCookieName = app.empty() ? std::string(\"tntnet\") : \"tntnet.\" + app;\n    std::string currentSecureSessionCookieName = app.empty() ? std::string(\"stntnet\") : \"stntnet.\" + app;\n\n    Cookie c = request.getCookie(currentSessionCookieName);\n    if (c.getValue().empty())\n    {\n      /*\n      cxxtools::MutexLock lock(sessionScopesMutex);\n      log_debug(sessionScopes.size() << \" sessions available\");\n      for (sessionscopes_type::iterator it = sessionScopes.begin(); it != sessionScopes.end(); ++it)\n        log_debug(\"available session \" << it->first << \" value \" << it->second);\n        */\n\n      log_debug(\"session cookie \" << currentSessionCookieName << \" not found - keep session\");\n    }\n    else\n    {\n      log_debug(\"session cookie \" << currentSessionCookieName << \" found: \" << c.getValue());\n\n      cxxtools::MutexLock lock(sessionScopesMutex);\n\n      Sessionscope* sessionScope;\n\n      sessionscopes_type::iterator it = sessionScopes.find(c.getValue());\n      if (it == sessionScopes.end())\n      {\n        log_debug(\"session not found - create new\");\n        sessionScope = new Sessionscope();\n        sessionScope->addRef();\n        sessionScopes.insert(sessionscopes_type::value_type(c.getValue(), sessionScope));\n      }\n      else\n      {\n        log_debug(\"session found\");\n        sessionScope = it->second;\n        sessionScope->touch();\n      }\n\n      request.setSessionScope(sessionScope);\n    }\n\n    if (request.isSsl())\n    {\n      c = request.getCookie(currentSecureSessionCookieName);\n      if (c.getValue().empty())\n      {\n        log_debug(\"secure session cookie \" << currentSessionCookieName\n            << \" not found - keep session\");\n      }\n      else if (request.isSsl())\n      {\n        log_debug(\"secure session cookie \" << currentSessionCookieName\n            << \" found: \" << c.getValue());\n\n        cxxtools::MutexLock lock(sessionScopesMutex);\n\n        Sessionscope* sessionScope;\n\n        sessionscopes_type::iterator it = sessionScopes.find(c.getValue());\n        if (it == sessionScopes.end())\n        {\n          log_debug(\"session not found - create new\");\n          sessionScope = new Sessionscope();\n          sessionScope->addRef();\n          sessionScopes.insert(sessionscopes_type::value_type(c.getValue(), sessionScope));\n        }\n        else\n        {\n          log_debug(\"session found\");\n          sessionScope = it->second;\n          sessionScope->touch();\n        }\n\n        request.setSecureSessionScope(sessionScope);\n      }\n    }\n    else\n    {\n      log_debug(\"secure session cookie \" << currentSessionCookieName\n          << \" not checked in non ssl request\");\n    }\n\n    // set application-scope\n    request.setApplicationScope(getApplicationScope(app));\n  }",
          "includes": [
            "#include <stdlib.h>",
            "#include <pthread.h>",
            "#include <cxxtools/md5stream.h>",
            "#include <cxxtools/log.h>",
            "#include \"tnt/httpreply.h\"",
            "#include \"tnt/httprequest.h\"",
            "#include \"tnt/sessionscope.h\"",
            "#include \"tnt/scopemanager.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdlib.h>\n#include <pthread.h>\n#include <cxxtools/md5stream.h>\n#include <cxxtools/log.h>\n#include \"tnt/httpreply.h\"\n#include \"tnt/httprequest.h\"\n#include \"tnt/sessionscope.h\"\n#include \"tnt/scopemanager.h\"\n\nScopeManager {\n  void ScopeManager::preCall(HttpRequest& request, const std::string& app)\n    {\n      // check session-cookie\n      std::string currentSessionCookieName = app.empty() ? std::string(\"tntnet\") : \"tntnet.\" + app;\n      std::string currentSecureSessionCookieName = app.empty() ? std::string(\"stntnet\") : \"stntnet.\" + app;\n  \n      Cookie c = request.getCookie(currentSessionCookieName);\n      if (c.getValue().empty())\n      {\n        /*\n        cxxtools::MutexLock lock(sessionScopesMutex);\n        log_debug(sessionScopes.size() << \" sessions available\");\n        for (sessionscopes_type::iterator it = sessionScopes.begin(); it != sessionScopes.end(); ++it)\n          log_debug(\"available session \" << it->first << \" value \" << it->second);\n          */\n  \n        log_debug(\"session cookie \" << currentSessionCookieName << \" not found - keep session\");\n      }\n      else\n      {\n        log_debug(\"session cookie \" << currentSessionCookieName << \" found: \" << c.getValue());\n  \n        cxxtools::MutexLock lock(sessionScopesMutex);\n  \n        Sessionscope* sessionScope;\n  \n        sessionscopes_type::iterator it = sessionScopes.find(c.getValue());\n        if (it == sessionScopes.end())\n        {\n          log_debug(\"session not found - create new\");\n          sessionScope = new Sessionscope();\n          sessionScope->addRef();\n          sessionScopes.insert(sessionscopes_type::value_type(c.getValue(), sessionScope));\n        }\n        else\n        {\n          log_debug(\"session found\");\n          sessionScope = it->second;\n          sessionScope->touch();\n        }\n  \n        request.setSessionScope(sessionScope);\n      }\n  \n      if (request.isSsl())\n      {\n        c = request.getCookie(currentSecureSessionCookieName);\n        if (c.getValue().empty())\n        {\n          log_debug(\"secure session cookie \" << currentSessionCookieName\n              << \" not found - keep session\");\n        }\n        else if (request.isSsl())\n        {\n          log_debug(\"secure session cookie \" << currentSessionCookieName\n              << \" found: \" << c.getValue());\n  \n          cxxtools::MutexLock lock(sessionScopesMutex);\n  \n          Sessionscope* sessionScope;\n  \n          sessionscopes_type::iterator it = sessionScopes.find(c.getValue());\n          if (it == sessionScopes.end())\n          {\n            log_debug(\"session not found - create new\");\n            sessionScope = new Sessionscope();\n            sessionScope->addRef();\n            sessionScopes.insert(sessionscopes_type::value_type(c.getValue(), sessionScope));\n          }\n          else\n          {\n            log_debug(\"session found\");\n            sessionScope = it->second;\n            sessionScope->touch();\n          }\n  \n          request.setSecureSessionScope(sessionScope);\n        }\n      }\n      else\n      {\n        log_debug(\"secure session cookie \" << currentSessionCookieName\n            << \" not checked in non ssl request\");\n      }\n  \n      // set application-scope\n      request.setApplicationScope(getApplicationScope(app));\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "request.setThreadContext",
          "args": [
            "&threadContext"
          ],
          "line": 45
        },
        "resolved": true,
        "details": {
          "function_name": "setThreadContext",
          "container": "HttpRequest",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2013-7299/repo/framework/common/tnt/httprequest.h",
          "lines": "229-229",
          "snippet": "void setThreadContext(ThreadContext* ctx)    { threadContext = ctx; }",
          "includes": [
            "#include <cstring>",
            "#include <string>",
            "#include <cxxtools/atomicity.h>",
            "#include <map>",
            "#include <locale>",
            "#include <tnt/threadcontext.h>",
            "#include <tnt/scope.h>",
            "#include <tnt/query_params.h>",
            "#include <tnt/encoding.h>",
            "#include <tnt/cookie.h>",
            "#include <tnt/multipart.h>",
            "#include <tnt/contenttype.h>",
            "#include <tnt/socketif.h>",
            "#include <tnt/httpheader.h>",
            "#include <tnt/httpmessage.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <cstring>\n#include <string>\n#include <cxxtools/atomicity.h>\n#include <map>\n#include <locale>\n#include <tnt/threadcontext.h>\n#include <tnt/scope.h>\n#include <tnt/query_params.h>\n#include <tnt/encoding.h>\n#include <tnt/cookie.h>\n#include <tnt/multipart.h>\n#include <tnt/contenttype.h>\n#include <tnt/socketif.h>\n#include <tnt/httpheader.h>\n#include <tnt/httpmessage.h>\n\nHttpRequest {\n  void setThreadContext(ThreadContext* ctx)    { threadContext = ctx; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "request.setQueryParams",
          "args": [
            "queryParams"
          ],
          "line": 42
        },
        "resolved": true,
        "details": {
          "function_name": "setQueryParams",
          "container": "HttpRequest",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2013-7299/repo/framework/common/tnt/httprequest.h",
          "lines": "176-176",
          "snippet": "void setQueryParams(const tnt::QueryParams& q)   { qparam = q; }",
          "includes": [
            "#include <cstring>",
            "#include <string>",
            "#include <cxxtools/atomicity.h>",
            "#include <map>",
            "#include <locale>",
            "#include <tnt/threadcontext.h>",
            "#include <tnt/scope.h>",
            "#include <tnt/query_params.h>",
            "#include <tnt/encoding.h>",
            "#include <tnt/cookie.h>",
            "#include <tnt/multipart.h>",
            "#include <tnt/contenttype.h>",
            "#include <tnt/socketif.h>",
            "#include <tnt/httpheader.h>",
            "#include <tnt/httpmessage.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <cstring>\n#include <string>\n#include <cxxtools/atomicity.h>\n#include <map>\n#include <locale>\n#include <tnt/threadcontext.h>\n#include <tnt/scope.h>\n#include <tnt/query_params.h>\n#include <tnt/encoding.h>\n#include <tnt/cookie.h>\n#include <tnt/multipart.h>\n#include <tnt/contenttype.h>\n#include <tnt/socketif.h>\n#include <tnt/httpheader.h>\n#include <tnt/httpmessage.h>\n\nHttpRequest {\n  void setQueryParams(const tnt::QueryParams& q)   { qparam = q; }\n}"
        }
      }
    ],
    "contextual_snippet": "#include <tnt/cmd.h>\n\nCmd {\n  void Cmd::call(const Compident& ci, const QueryParams& queryParams)\n    {\n      HttpRequest request(application, &socketIf);\n      request.setQueryParams(queryParams);\n  \n      // set thread context for thread scope\n      request.setThreadContext(&threadContext);\n  \n      // sets session and application scope\n      scopeManager.preCall(request, ci.libname);\n      scopeManager.setSessionId(request, sessionId);\n  \n      // fetch and call the component\n      comploader.fetchComp(ci)(request, reply, request.getQueryParams());\n  \n      // sets session cookie if needed\n      sessionId = scopeManager.postCall(request, reply, application.getAppName());\n    }\n}"
  },
  {
    "function_name": "Cmd",
    "container": "Cmd",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2013-7299/repo/framework/common/cmd.cpp",
    "lines": "33-37",
    "snippet": "Cmd::Cmd(std::ostream& out)\n    : reply(out, false)\n  {\n    reply.setDirectModeNoFlush();\n  }",
    "includes": [
      "#include <tnt/cmd.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "reply.setDirectModeNoFlush",
          "args": [],
          "line": 36
        },
        "resolved": true,
        "details": {
          "function_name": "setDirectModeNoFlush",
          "container": "HttpReply",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2013-7299/repo/framework/common/httpreply.cpp",
          "lines": "492-496",
          "snippet": "void HttpReply::setDirectModeNoFlush()\n  {\n    current_outstream = impl->socket;\n    impl->safe_outstream.setSink(*impl->socket);\n  }",
          "includes": [
            "#include <netinet/in.h>",
            "#include <zlib.h>",
            "#include <stdio.h>",
            "#include <sstream>",
            "#include <cxxtools/mutex.h>",
            "#include <cxxtools/md5stream.h>",
            "#include <cxxtools/log.h>",
            "#include <tnt/encoding.h>",
            "#include <tnt/urlescostream.h>",
            "#include <tnt/htmlescostream.h>",
            "#include <tnt/tntconfig.h>",
            "#include <tnt/httperror.h>",
            "#include <tnt/deflatestream.h>",
            "#include <tnt/httpheader.h>",
            "#include <tnt/http.h>",
            "#include <tnt/httpreply.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <netinet/in.h>\n#include <zlib.h>\n#include <stdio.h>\n#include <sstream>\n#include <cxxtools/mutex.h>\n#include <cxxtools/md5stream.h>\n#include <cxxtools/log.h>\n#include <tnt/encoding.h>\n#include <tnt/urlescostream.h>\n#include <tnt/htmlescostream.h>\n#include <tnt/tntconfig.h>\n#include <tnt/httperror.h>\n#include <tnt/deflatestream.h>\n#include <tnt/httpheader.h>\n#include <tnt/http.h>\n#include <tnt/httpreply.h>\n\nHttpReply {\n  void HttpReply::setDirectModeNoFlush()\n    {\n      current_outstream = impl->socket;\n      impl->safe_outstream.setSink(*impl->socket);\n    }\n}"
        }
      }
    ],
    "contextual_snippet": "#include <tnt/cmd.h>\n\nCmd {\n  Cmd::Cmd(std::ostream& out)\n      : reply(out, false)\n    {\n      reply.setDirectModeNoFlush();\n    }\n}"
  }
]