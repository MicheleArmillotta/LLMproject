[
  {
    "function_name": "SetNewAndDeleteFunctionPointers",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2015-2141/repo/dll.cpp",
    "lines": "65-124",
    "snippet": "static void SetNewAndDeleteFunctionPointers()\n{\n\tvoid *p = NULL;\n\tHMODULE hModule = NULL;\n\tMEMORY_BASIC_INFORMATION mbi;\n\n\twhile (true)\n\t{\n\t\tVirtualQuery(p, &mbi, sizeof(mbi));\n\n\t\tif (p >= (char *)mbi.BaseAddress + mbi.RegionSize)\n\t\t\tbreak;\n\n\t\tp = (char *)mbi.BaseAddress + mbi.RegionSize;\n\n\t\tif (!mbi.AllocationBase || mbi.AllocationBase == hModule)\n\t\t\tcontinue;\n\n\t\thModule = HMODULE(mbi.AllocationBase);\n\n\t\tPGetNewAndDelete pGetNewAndDelete = (PGetNewAndDelete)GetProcAddress(hModule, \"GetNewAndDeleteForCryptoPP\");\n\t\tif (pGetNewAndDelete)\n\t\t{\n\t\t\tpGetNewAndDelete(s_pNew, s_pDelete);\n\t\t\treturn;\n\t\t}\n\n\t\tPSetNewAndDelete pSetNewAndDelete = (PSetNewAndDelete)GetProcAddress(hModule, \"SetNewAndDeleteFromCryptoPP\");\n\t\tif (pSetNewAndDelete)\n\t\t{\n\t\t\ts_pNew = &New;\n\t\t\ts_pDelete = &free;\n\t\t\tpSetNewAndDelete(s_pNew, s_pDelete, &set_new_handler);\n\t\t\treturn;\n\t\t}\n\t}\n\n\t// try getting these directly using mangled names of new and delete operators\n\n\thModule = GetModuleHandle(\"msvcrtd\");\n\tif (!hModule)\n\t\thModule = GetModuleHandle(\"msvcrt\");\n\tif (hModule)\n\t{\n\t\t// 32-bit versions\n\t\ts_pNew = (PNew)GetProcAddress(hModule, \"??2@YAPAXI@Z\");\n\t\ts_pDelete = (PDelete)GetProcAddress(hModule, \"??3@YAXPAX@Z\");\n\t\tif (s_pNew && s_pDelete)\n\t\t\treturn;\n\n\t\t// 64-bit versions\n\t\ts_pNew = (PNew)GetProcAddress(hModule, \"??2@YAPEAX_K@Z\");\n\t\ts_pDelete = (PDelete)GetProcAddress(hModule, \"??3@YAXPEAX@Z\");\n\t\tif (s_pNew && s_pDelete)\n\t\t\treturn;\n\t}\n\n\tOutputDebugString(\"Crypto++ was not able to obtain new and delete function pointers.\\n\");\n\tthrow 0;\n}",
    "includes": [
      "#include <windows.h>",
      "#include \"dll.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "OutputDebugString",
          "args": [
            "\"Crypto++ was not able to obtain new and delete function pointers.\\n\""
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GetProcAddress",
          "args": [
            "hModule",
            "\"??3@YAXPEAX@Z\""
          ],
          "line": 117
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GetProcAddress",
          "args": [
            "hModule",
            "\"??2@YAPEAX_K@Z\""
          ],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GetProcAddress",
          "args": [
            "hModule",
            "\"??3@YAXPAX@Z\""
          ],
          "line": 111
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GetProcAddress",
          "args": [
            "hModule",
            "\"??2@YAPAXI@Z\""
          ],
          "line": 110
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GetModuleHandle",
          "args": [
            "\"msvcrt\""
          ],
          "line": 106
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GetModuleHandle",
          "args": [
            "\"msvcrtd\""
          ],
          "line": 104
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pSetNewAndDelete",
          "args": [
            "s_pNew",
            "s_pDelete",
            "&set_new_handler"
          ],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GetProcAddress",
          "args": [
            "hModule",
            "\"SetNewAndDeleteFromCryptoPP\""
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pGetNewAndDelete",
          "args": [
            "s_pNew",
            "s_pDelete"
          ],
          "line": 88
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GetProcAddress",
          "args": [
            "hModule",
            "\"GetNewAndDeleteForCryptoPP\""
          ],
          "line": 85
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "HMODULE",
          "args": [
            "mbi.AllocationBase"
          ],
          "line": 83
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VirtualQuery",
          "args": [
            "p",
            "&mbi",
            "sizeof(mbi)"
          ],
          "line": 73
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <windows.h>\n#include \"dll.h\"\n\nstatic void SetNewAndDeleteFunctionPointers()\n{\n\tvoid *p = NULL;\n\tHMODULE hModule = NULL;\n\tMEMORY_BASIC_INFORMATION mbi;\n\n\twhile (true)\n\t{\n\t\tVirtualQuery(p, &mbi, sizeof(mbi));\n\n\t\tif (p >= (char *)mbi.BaseAddress + mbi.RegionSize)\n\t\t\tbreak;\n\n\t\tp = (char *)mbi.BaseAddress + mbi.RegionSize;\n\n\t\tif (!mbi.AllocationBase || mbi.AllocationBase == hModule)\n\t\t\tcontinue;\n\n\t\thModule = HMODULE(mbi.AllocationBase);\n\n\t\tPGetNewAndDelete pGetNewAndDelete = (PGetNewAndDelete)GetProcAddress(hModule, \"GetNewAndDeleteForCryptoPP\");\n\t\tif (pGetNewAndDelete)\n\t\t{\n\t\t\tpGetNewAndDelete(s_pNew, s_pDelete);\n\t\t\treturn;\n\t\t}\n\n\t\tPSetNewAndDelete pSetNewAndDelete = (PSetNewAndDelete)GetProcAddress(hModule, \"SetNewAndDeleteFromCryptoPP\");\n\t\tif (pSetNewAndDelete)\n\t\t{\n\t\t\ts_pNew = &New;\n\t\t\ts_pDelete = &free;\n\t\t\tpSetNewAndDelete(s_pNew, s_pDelete, &set_new_handler);\n\t\t\treturn;\n\t\t}\n\t}\n\n\t// try getting these directly using mangled names of new and delete operators\n\n\thModule = GetModuleHandle(\"msvcrtd\");\n\tif (!hModule)\n\t\thModule = GetModuleHandle(\"msvcrt\");\n\tif (hModule)\n\t{\n\t\t// 32-bit versions\n\t\ts_pNew = (PNew)GetProcAddress(hModule, \"??2@YAPAXI@Z\");\n\t\ts_pDelete = (PDelete)GetProcAddress(hModule, \"??3@YAXPAX@Z\");\n\t\tif (s_pNew && s_pDelete)\n\t\t\treturn;\n\n\t\t// 64-bit versions\n\t\ts_pNew = (PNew)GetProcAddress(hModule, \"??2@YAPEAX_K@Z\");\n\t\ts_pDelete = (PDelete)GetProcAddress(hModule, \"??3@YAXPEAX@Z\");\n\t\tif (s_pNew && s_pDelete)\n\t\t\treturn;\n\t}\n\n\tOutputDebugString(\"Crypto++ was not able to obtain new and delete function pointers.\\n\");\n\tthrow 0;\n}"
  }
]