[
  {
    "function_name": "run",
    "container": "AppIndexMain",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "467-482",
    "snippet": "kj::MainBuilder::Validity run() {\n    mkdir(\"/var/www/experimental\", 0777);  // back-compat; ignore already exists error\n    mkdir(\"/var/apps\", 0777);  // back-compat; ignore already exists error\n\n    Indexer indexer;\n\n    // Set up RPC on file descriptor 3.\n    auto stream = ioContext.lowLevelProvider->wrapSocketFd(3);\n    capnp::TwoPartyClient client(*stream, kj::heap<UiViewImpl>(indexer));\n\n    // TODO(soon):  We don't use this, but for some reason the connection doesn't come up if we\n    //   don't do this bootstrap.  Cap'n Proto bug?  v8capnp bug?  Shell bug?\n    client.bootstrap();\n\n    kj::NEVER_DONE.wait(ioContext.waitScope);\n  }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::NEVER_DONE.wait",
          "args": [
            "ioContext.waitScope"
          ],
          "line": 481
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "client.bootstrap",
          "args": [],
          "line": 479
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heap<UiViewImpl>",
          "args": [
            "indexer"
          ],
          "line": 475
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ioContext.lowLevelProvider->wrapSocketFd",
          "args": [
            "3"
          ],
          "line": 474
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/apps\"",
            "0777"
          ],
          "line": 469
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/www/experimental\"",
            "0777"
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nAppIndexMain {\n  kj::MainBuilder::Validity run() {\n      mkdir(\"/var/www/experimental\", 0777);  // back-compat; ignore already exists error\n      mkdir(\"/var/apps\", 0777);  // back-compat; ignore already exists error\n  \n      Indexer indexer;\n  \n      // Set up RPC on file descriptor 3.\n      auto stream = ioContext.lowLevelProvider->wrapSocketFd(3);\n      capnp::TwoPartyClient client(*stream, kj::heap<UiViewImpl>(indexer));\n  \n      // TODO(soon):  We don't use this, but for some reason the connection doesn't come up if we\n      //   don't do this bootstrap.  Cap'n Proto bug?  v8capnp bug?  Shell bug?\n      client.bootstrap();\n  \n      kj::NEVER_DONE.wait(ioContext.waitScope);\n    }\n}"
  },
  {
    "function_name": "init",
    "container": "AppIndexMain",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "454-465",
    "snippet": "kj::MainBuilder::Validity init() {\n    KJ_SYSCALL(mkdir(\"/var/packages\", 0777));\n    KJ_SYSCALL(mkdir(\"/var/apps\", 0777));\n    KJ_SYSCALL(mkdir(\"/var/keybase\", 0777));\n    KJ_SYSCALL(mkdir(\"/var/www\", 0777));\n    KJ_SYSCALL(mkdir(\"/var/www/apps\", 0777));\n    KJ_SYSCALL(mkdir(\"/var/www/experimental\", 0777));\n    KJ_SYSCALL(mkdir(\"/var/www/images\", 0777));\n    KJ_SYSCALL(mkdir(\"/var/www/packages\", 0777));\n    KJ_SYSCALL(mkdir(\"/var/tmp\", 0777));\n    return true;\n  }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mkdir(\"/var/tmp\", 0777)"
          ],
          "line": 463
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/tmp\"",
            "0777"
          ],
          "line": 463
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mkdir(\"/var/www/packages\", 0777)"
          ],
          "line": 462
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/www/packages\"",
            "0777"
          ],
          "line": 462
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mkdir(\"/var/www/images\", 0777)"
          ],
          "line": 461
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/www/images\"",
            "0777"
          ],
          "line": 461
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mkdir(\"/var/www/experimental\", 0777)"
          ],
          "line": 460
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/www/experimental\"",
            "0777"
          ],
          "line": 460
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mkdir(\"/var/www/apps\", 0777)"
          ],
          "line": 459
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/www/apps\"",
            "0777"
          ],
          "line": 459
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mkdir(\"/var/www\", 0777)"
          ],
          "line": 458
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/www\"",
            "0777"
          ],
          "line": 458
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mkdir(\"/var/keybase\", 0777)"
          ],
          "line": 457
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/keybase\"",
            "0777"
          ],
          "line": 457
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mkdir(\"/var/apps\", 0777)"
          ],
          "line": 456
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/apps\"",
            "0777"
          ],
          "line": 456
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mkdir(\"/var/packages\", 0777)"
          ],
          "line": 455
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/packages\"",
            "0777"
          ],
          "line": 455
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nAppIndexMain {\n  kj::MainBuilder::Validity init() {\n      KJ_SYSCALL(mkdir(\"/var/packages\", 0777));\n      KJ_SYSCALL(mkdir(\"/var/apps\", 0777));\n      KJ_SYSCALL(mkdir(\"/var/keybase\", 0777));\n      KJ_SYSCALL(mkdir(\"/var/www\", 0777));\n      KJ_SYSCALL(mkdir(\"/var/www/apps\", 0777));\n      KJ_SYSCALL(mkdir(\"/var/www/experimental\", 0777));\n      KJ_SYSCALL(mkdir(\"/var/www/images\", 0777));\n      KJ_SYSCALL(mkdir(\"/var/www/packages\", 0777));\n      KJ_SYSCALL(mkdir(\"/var/tmp\", 0777));\n      return true;\n    }\n}"
  },
  {
    "function_name": "getMain",
    "container": "AppIndexMain",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "446-452",
    "snippet": "kj::MainFunc getMain() {\n    return kj::MainBuilder(context, \"Sandstorm App Index\",\n                           \"Runs the Sandstorm app index.\")\n        .addOption({'i', \"init\"}, KJ_BIND_METHOD(*this, init), \"first run\")\n        .callAfterParsing(KJ_BIND_METHOD(*this, run))\n        .build();\n  }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 447
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "KJ_BIND_METHOD(*this, run)"
          ],
          "line": 447
        },
        "resolved": true,
        "details": {
          "function_name": "Validity inheritPidfileFd",
          "container": "kj::MainBuilder",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "432-752",
          "snippet": "class RunBundleMain {\n  // Main class for the Sandstorm bundle runner.  This is a convenience tool for running the\n  // Sandstorm binary bundle, which is a packaged chroot environment containing everything needed\n  // to run a Sandstorm server.  Just unpack and run!\n\n  struct Config;\n\npublic:\n  RunBundleMain(kj::ProcessContext& context): context(context) {\n    // Make sure we didn't inherit a weird signal mask from the parent process.\n    clearSignalMask();\n    umask(0022);\n\n    if (!isKernelNewEnough()) {\n      context.exitError(\n          \"ERROR: Your Linux kernel is too old. You need at least kernel version 3.10.\");\n    }\n  }\n\n  kj::MainFunc getMain() {\n    static const char* VERSION = \"Sandstorm version \" SANDSTORM_VERSION;\n\n    {\n      auto programName = context.getProgramName();\n      if (programName.endsWith(\"supervisor\")) {  // historically \"sandstorm-supervisor\"\n        alternateMain = kj::heap<SupervisorMain>(context);\n        return alternateMain->getMain();\n      } else if (programName == \"spk\" || programName.endsWith(\"/spk\")) {\n        alternateMain = getSpkMain(context);\n        return alternateMain->getMain();\n      } else if (programName == \"backup\" || programName.endsWith(\"/backup\")) {\n        alternateMain = kj::heap<BackupMain>(context);\n        return alternateMain->getMain();\n      }\n    }\n\n    return kj::MainBuilder(context, VERSION,\n            \"Controls the Sandstorm server.\\n\\n\"\n            \"Something not working? Check the logs in SANDSTORM_HOME/var/log.\")\n        .addSubCommand(\"start\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION, \"Starts the Sandstorm server (default).\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, start))\n                  .build();\n            },\n            \"Start the sandstorm server.\")\n        .addSubCommand(\"stop\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION, \"Stops the Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, stop))\n                  .build();\n            },\n            \"Stop the sandstorm server.\")\n        .addSubCommand(\"start-fe\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                    \"Starts the Sandstorm front-end after it has previously been stopped using \"\n                    \"the `stop-fe` command.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, startFe))\n                  .build();\n            },\n            \"Undo previous stop-fe.\")\n        .addSubCommand(\"stop-fe\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                    \"Stops the Sandstorm front-end, but leaves Mongo running. Useful when you \"\n                    \"want to run the front-end in dev mode in front of the existing database \"\n                    \"and grains.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, stopFe))\n                  .build();\n            },\n            \"Stop the sandstorm front-end.\")\n        .addSubCommand(\"status\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Checks whether Sandstorm is running. Prints the pid and exits successfully \"\n                      \"if so; exits with an error otherwise.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, status))\n                  .build();\n            },\n            \"Check if Sandstorm is running.\")\n        .addSubCommand(\"restart\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION, \"Restarts Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, restart))\n                  .build();\n            },\n            \"Restart Sandstorm server.\")\n        .addSubCommand(\"mongo\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                  \"Runs MongoDB shell, connecting to the already-running Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, mongo))\n                  .build();\n            },\n            \"Run MongoDB shell.\")\n        .addSubCommand(\"update\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Updates the Sandstorm platform to a new version. If <release> is provided \"\n                      \"and specifies a bundle file (something like sandstorm-1234.tar.xz) it is \"\n                      \"used as the update. If <release> is a channel name, e.g. \\\"dev\\\", we \"\n                      \"securely check the web for an update. If <release> is not provided, we \"\n                      \"use the channel specified in the config file.\")\n                  .expectOptionalArg(\"<release>\", KJ_BIND_METHOD(*this, setUpdateFile))\n                  .callAfterParsing(KJ_BIND_METHOD(*this, update))\n                  .build();\n            },\n            \"Update the Sandstorm platform.\")\n        .addSubCommand(\"spk\",\n            [this]() {\n              alternateMain = getSpkMain(context);\n              return alternateMain->getMain();\n            },\n            \"Manipulate spk files.\")\n        .addSubCommand(\"continue\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"For internal use only: Continues running Sandstorm after an update. \"\n                      \"This command is invoked by the Sandstorm server itself. Do not run it \"\n                      \"directly.\")\n                  .addOption({\"userns\"}, [this]() { unsharedUidNamespace = true; return true; },\n                      \"Pass this flag if the parent has already set up and entered a UID \"\n                      \"namespace.\")\n                  .expectArg(\"<pidfile-fd>\", KJ_BIND_METHOD(*this, inheritPidfileFd))\n                  .expectZeroOrMoreArgs(\"<fd>:tcp:<port>\", KJ_BIND_METHOD(*this, inheritFd))\n                  .callAfterParsing(KJ_BIND_METHOD(*this, continue_))\n                  .build();\n            },\n            \"For internal use only.\")\n        .addSubCommand(\"dev\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"For internal use only: Runs an app in dev mode. This command is \"\n                      \"invoked by the `spk` tool. Do not run it directly.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, dev))\n                  .build();\n            },\n            \"For internal use only.\")\n        .addSubCommand(\"admin-token\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Generates a new admin token that you can use to access the admin settings \"\n                      \"page. This is meant for initial setup, or if an admin account is locked out.\")\n                  .addOption({'q', \"quiet\"}, [this]() { shortOutput = true; return true; },\n                      \"Output only the token.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, adminToken))\n                  .build();\n            },\n            \"Generate admin token.\")\n        .addSubCommand(\"uninstall\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Uninstalls Sandstorm.\")\n                  .addOption({\"delete-user-data\"}, [this]() { deleteUserData = true; return true; },\n                      \"Also delete all user data.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, uninstall))\n                  .build();\n            },\n            \"Uninstall Sandstorm.\")\n        .build();\n  }\n\n  kj::MainBuilder::Validity start() {\n    changeToInstallDir();\n    const Config config = readConfig();\n\n    // Check / lock the pidfile.\n    auto pidfile = raiiOpen(\"../var/pid/sandstorm.pid\", O_RDWR | O_CREAT | O_CLOEXEC, 0660);\n    {\n      struct flock lock;\n      memset(&lock, 0, sizeof(lock));\n      lock.l_type = F_WRLCK;\n      lock.l_whence = SEEK_SET;\n      lock.l_start = 0;\n      lock.l_len = 0;  // entire file\n      if (fcntl(pidfile, F_SETLK, &lock) < 0) {\n        int error = errno;\n        if (error == EACCES || error == EAGAIN) {\n          context.exitInfo(kj::str(\"Sandstorm is already running.  PID = \", readAll(pidfile)));\n        } else {\n          KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLK)\", error);\n        }\n      }\n\n      // It's ours.  Truncate for now so we can write in the new PID later.\n      KJ_SYSCALL(ftruncate(pidfile, 0));\n    }\n\n    if (!runningAsRoot) unshareUidNamespaceOnce();\n\n    // Unshare PID namespace so that daemon process becomes the root process of its own PID\n    // namespace and therefore if it dies the whole namespace is killed.\n    KJ_SYSCALL(unshare(CLONE_NEWPID));\n\n    // Daemonize ourselves.\n    pid_t mainPid;  // PID of the main process as seen *outside* the PID namespace.\n    {\n      int pipeFds[2];\n      KJ_SYSCALL(pipe2(pipeFds, O_CLOEXEC));\n      kj::AutoCloseFd pipeIn(pipeFds[0]), pipeOut(pipeFds[1]);\n\n      KJ_SYSCALL(mainPid = fork());\n      if (mainPid != 0) {\n        // Tell the child process its own PID, since being in a PID namespace its own getpid() will\n        // unhelpfully return 1.\n        pipeIn = nullptr;\n        kj::FdOutputStream(kj::mv(pipeOut)).write(&mainPid, sizeof(mainPid));\n\n        // Write the pidfile before exiting.\n        {\n          auto pidstr = kj::str(mainPid, '\\n');\n          kj::FdOutputStream((int)pidfile).write(pidstr.begin(), pidstr.size());\n        }\n\n        // Exit success.\n        context.exitInfo(kj::str(\"Sandstorm started. PID = \", mainPid));\n        return true;\n      }\n\n      // Read our (global) PID in from the parent process.\n      pipeOut = nullptr;\n      kj::FdInputStream(kj::mv(pipeIn)).read(&mainPid, sizeof(mainPid));\n    }\n\n    // Since we unshared the PID namespace, the first fork() should have produced pid 1 in the\n    // new namespace.  That means that if this pid ever exits, everything under it dies.  That's\n    // perfect!  Otherwise we'd have to carefully kill node and mongo separately.\n    KJ_ASSERT(getpid() == 1, \"unshare(CLONE_NEWPID) didn't do what I expected.\", getpid());\n\n    // Lock the pidfile and make sure it still belongs to us.\n    //\n    // We need to wait for the parent process to release its lock, so we use F_SETLKW.\n    // However, if another Sandstorm server is started simultaneously and manages to steal\n    // ownership, we want to detect this and exit, so we take a shared (read-only) lock.\n    {\n      struct flock lock;\n      memset(&lock, 0, sizeof(lock));\n      lock.l_type = F_RDLCK;\n      lock.l_whence = SEEK_SET;\n      lock.l_start = 0;\n      lock.l_len = 0;  // entire file\n      KJ_SYSCALL(fcntl(pidfile, F_SETLKW, &lock));\n\n      // Verify that we still own the file.\n      KJ_SYSCALL(lseek(pidfile, 0, SEEK_SET));\n      pid_t pidfilePid = KJ_ASSERT_NONNULL(parseUInt(trim(readAll(pidfile)), 10));\n      if (pidfilePid != mainPid) {\n        context.exitInfo(kj::str(\n            \"Oops, Sandstorm PID \", pidfilePid, \" just started. \"\n            \"PID \", mainPid, \" exiting in deference.\"));\n      }\n    }\n\n    // Redirect stdio.\n    {\n      auto logFd = raiiOpen(\"../var/log/sandstorm.log\", O_WRONLY | O_APPEND | O_CREAT, 0660);\n      if (runningAsRoot) { KJ_SYSCALL(fchown(logFd, config.uids.uid, config.uids.gid)); }\n      KJ_SYSCALL(dup2(logFd, STDOUT_FILENO));\n      KJ_SYSCALL(dup2(logFd, STDERR_FILENO));\n    }\n    {\n      auto nullFd = raiiOpen(\"/dev/null\", O_RDONLY);\n      KJ_SYSCALL(dup2(nullFd, STDIN_FILENO));\n    }\n\n    // Write time to log.\n    time_t now;\n    time(&now);\n    context.warning(kj::str(\"** Starting Sandstorm at: \", ctime(&now)));\n\n    // Detach from controlling terminal and make ourselves session leader.\n    KJ_SYSCALL(setsid());\n\n    FdBundle fdBundle(config);\n\n    runUpdateMonitor(config, fdBundle, pidfile);\n  }\n\n  kj::MainBuilder::Validity inheritFd(kj::StringPtr mapping) {\n    auto parts = split(mapping, ':');\n    if (parts.size() != 3) {\n      return \"invalid syntax for port mapping\";\n    }\n\n    int fd;\n    KJ_IF_MAYBE(p, parseUInt(kj::str(parts[0]), 10)) {\n      fd = *p;\n    } else {\n      return \"invalid fd\";\n    }\n\n    kj::String type = kj::str(parts[1]);\n    if (type != \"tcp\") {\n      return \"invalid type\";\n    }\n\n    uint port;\n    KJ_IF_MAYBE(p, parseUInt(kj::str(parts[2]), 10)) {\n      port = *p;\n    } else {\n      return \"invalid port\";\n    }\n\n    KJ_SYSCALL(ioctl(fd, FIOCLEX));  // set CLOEXEC\n    if (!inheritedTcpPorts.insert(std::make_pair(port, kj::AutoCloseFd(fd))).second) {\n      return \"duplicate port\";\n    }\n\n    return true;\n  }\n\n  kj::MainBuilder::Validity inheritPidfileFd(kj::StringPtr pidfileFdStr) {\n    KJ_IF_MAYBE(p, parseUInt(pidfileFdStr, 10)) {\n      inheritedPidfile = kj::AutoCloseFd(*p);\n      KJ_SYSCALL(ioctl(inheritedPidfile, FIOCLEX));  // set CLOEXEC\n      return true;\n    } else {\n      return \"invalid fd\";\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;",
            "kj::Own<AbstractMain> alternateMain;",
            "kj::AutoCloseFd inheritedPidfile;",
            "std::map<uint, kj::AutoCloseFd> inheritedTcpPorts;",
            "bool unsharedUidNamespace = false;",
            "bool runningAsRoot = getuid() == 0;",
            "bool shortOutput = false;",
            "bool deleteUserData = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nkj::Own<AbstractMain> alternateMain;\nkj::AutoCloseFd inheritedPidfile;\nstd::map<uint, kj::AutoCloseFd> inheritedTcpPorts;\nbool unsharedUidNamespace = false;\nbool runningAsRoot = getuid() == 0;\nbool shortOutput = false;\nbool deleteUserData = false;\n\nkj {\n  MainBuilder {\n    class RunBundleMain {\n      // Main class for the Sandstorm bundle runner.  This is a convenience tool for running the\n      // Sandstorm binary bundle, which is a packaged chroot environment containing everything needed\n      // to run a Sandstorm server.  Just unpack and run!\n    \n      struct Config;\n    \n    public:\n      RunBundleMain(kj::ProcessContext& context): context(context) {\n        // Make sure we didn't inherit a weird signal mask from the parent process.\n        clearSignalMask();\n        umask(0022);\n    \n        if (!isKernelNewEnough()) {\n          context.exitError(\n              \"ERROR: Your Linux kernel is too old. You need at least kernel version 3.10.\");\n        }\n      }\n    \n      kj::MainFunc getMain() {\n        static const char* VERSION = \"Sandstorm version \" SANDSTORM_VERSION;\n    \n        {\n          auto programName = context.getProgramName();\n          if (programName.endsWith(\"supervisor\")) {  // historically \"sandstorm-supervisor\"\n            alternateMain = kj::heap<SupervisorMain>(context);\n            return alternateMain->getMain();\n          } else if (programName == \"spk\" || programName.endsWith(\"/spk\")) {\n            alternateMain = getSpkMain(context);\n            return alternateMain->getMain();\n          } else if (programName == \"backup\" || programName.endsWith(\"/backup\")) {\n            alternateMain = kj::heap<BackupMain>(context);\n            return alternateMain->getMain();\n          }\n        }\n    \n        return kj::MainBuilder(context, VERSION,\n                \"Controls the Sandstorm server.\\n\\n\"\n                \"Something not working? Check the logs in SANDSTORM_HOME/var/log.\")\n            .addSubCommand(\"start\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION, \"Starts the Sandstorm server (default).\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, start))\n                      .build();\n                },\n                \"Start the sandstorm server.\")\n            .addSubCommand(\"stop\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION, \"Stops the Sandstorm server.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, stop))\n                      .build();\n                },\n                \"Stop the sandstorm server.\")\n            .addSubCommand(\"start-fe\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                        \"Starts the Sandstorm front-end after it has previously been stopped using \"\n                        \"the `stop-fe` command.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, startFe))\n                      .build();\n                },\n                \"Undo previous stop-fe.\")\n            .addSubCommand(\"stop-fe\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                        \"Stops the Sandstorm front-end, but leaves Mongo running. Useful when you \"\n                        \"want to run the front-end in dev mode in front of the existing database \"\n                        \"and grains.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, stopFe))\n                      .build();\n                },\n                \"Stop the sandstorm front-end.\")\n            .addSubCommand(\"status\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"Checks whether Sandstorm is running. Prints the pid and exits successfully \"\n                          \"if so; exits with an error otherwise.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, status))\n                      .build();\n                },\n                \"Check if Sandstorm is running.\")\n            .addSubCommand(\"restart\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION, \"Restarts Sandstorm server.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, restart))\n                      .build();\n                },\n                \"Restart Sandstorm server.\")\n            .addSubCommand(\"mongo\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                      \"Runs MongoDB shell, connecting to the already-running Sandstorm server.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, mongo))\n                      .build();\n                },\n                \"Run MongoDB shell.\")\n            .addSubCommand(\"update\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"Updates the Sandstorm platform to a new version. If <release> is provided \"\n                          \"and specifies a bundle file (something like sandstorm-1234.tar.xz) it is \"\n                          \"used as the update. If <release> is a channel name, e.g. \\\"dev\\\", we \"\n                          \"securely check the web for an update. If <release> is not provided, we \"\n                          \"use the channel specified in the config file.\")\n                      .expectOptionalArg(\"<release>\", KJ_BIND_METHOD(*this, setUpdateFile))\n                      .callAfterParsing(KJ_BIND_METHOD(*this, update))\n                      .build();\n                },\n                \"Update the Sandstorm platform.\")\n            .addSubCommand(\"spk\",\n                [this]() {\n                  alternateMain = getSpkMain(context);\n                  return alternateMain->getMain();\n                },\n                \"Manipulate spk files.\")\n            .addSubCommand(\"continue\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"For internal use only: Continues running Sandstorm after an update. \"\n                          \"This command is invoked by the Sandstorm server itself. Do not run it \"\n                          \"directly.\")\n                      .addOption({\"userns\"}, [this]() { unsharedUidNamespace = true; return true; },\n                          \"Pass this flag if the parent has already set up and entered a UID \"\n                          \"namespace.\")\n                      .expectArg(\"<pidfile-fd>\", KJ_BIND_METHOD(*this, inheritPidfileFd))\n                      .expectZeroOrMoreArgs(\"<fd>:tcp:<port>\", KJ_BIND_METHOD(*this, inheritFd))\n                      .callAfterParsing(KJ_BIND_METHOD(*this, continue_))\n                      .build();\n                },\n                \"For internal use only.\")\n            .addSubCommand(\"dev\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"For internal use only: Runs an app in dev mode. This command is \"\n                          \"invoked by the `spk` tool. Do not run it directly.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, dev))\n                      .build();\n                },\n                \"For internal use only.\")\n            .addSubCommand(\"admin-token\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"Generates a new admin token that you can use to access the admin settings \"\n                          \"page. This is meant for initial setup, or if an admin account is locked out.\")\n                      .addOption({'q', \"quiet\"}, [this]() { shortOutput = true; return true; },\n                          \"Output only the token.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, adminToken))\n                      .build();\n                },\n                \"Generate admin token.\")\n            .addSubCommand(\"uninstall\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"Uninstalls Sandstorm.\")\n                      .addOption({\"delete-user-data\"}, [this]() { deleteUserData = true; return true; },\n                          \"Also delete all user data.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, uninstall))\n                      .build();\n                },\n                \"Uninstall Sandstorm.\")\n            .build();\n      }\n    \n      kj::MainBuilder::Validity start() {\n        changeToInstallDir();\n        const Config config = readConfig();\n    \n        // Check / lock the pidfile.\n        auto pidfile = raiiOpen(\"../var/pid/sandstorm.pid\", O_RDWR | O_CREAT | O_CLOEXEC, 0660);\n        {\n          struct flock lock;\n          memset(&lock, 0, sizeof(lock));\n          lock.l_type = F_WRLCK;\n          lock.l_whence = SEEK_SET;\n          lock.l_start = 0;\n          lock.l_len = 0;  // entire file\n          if (fcntl(pidfile, F_SETLK, &lock) < 0) {\n            int error = errno;\n            if (error == EACCES || error == EAGAIN) {\n              context.exitInfo(kj::str(\"Sandstorm is already running.  PID = \", readAll(pidfile)));\n            } else {\n              KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLK)\", error);\n            }\n          }\n    \n          // It's ours.  Truncate for now so we can write in the new PID later.\n          KJ_SYSCALL(ftruncate(pidfile, 0));\n        }\n    \n        if (!runningAsRoot) unshareUidNamespaceOnce();\n    \n        // Unshare PID namespace so that daemon process becomes the root process of its own PID\n        // namespace and therefore if it dies the whole namespace is killed.\n        KJ_SYSCALL(unshare(CLONE_NEWPID));\n    \n        // Daemonize ourselves.\n        pid_t mainPid;  // PID of the main process as seen *outside* the PID namespace.\n        {\n          int pipeFds[2];\n          KJ_SYSCALL(pipe2(pipeFds, O_CLOEXEC));\n          kj::AutoCloseFd pipeIn(pipeFds[0]), pipeOut(pipeFds[1]);\n    \n          KJ_SYSCALL(mainPid = fork());\n          if (mainPid != 0) {\n            // Tell the child process its own PID, since being in a PID namespace its own getpid() will\n            // unhelpfully return 1.\n            pipeIn = nullptr;\n            kj::FdOutputStream(kj::mv(pipeOut)).write(&mainPid, sizeof(mainPid));\n    \n            // Write the pidfile before exiting.\n            {\n              auto pidstr = kj::str(mainPid, '\\n');\n              kj::FdOutputStream((int)pidfile).write(pidstr.begin(), pidstr.size());\n            }\n    \n            // Exit success.\n            context.exitInfo(kj::str(\"Sandstorm started. PID = \", mainPid));\n            return true;\n          }\n    \n          // Read our (global) PID in from the parent process.\n          pipeOut = nullptr;\n          kj::FdInputStream(kj::mv(pipeIn)).read(&mainPid, sizeof(mainPid));\n        }\n    \n        // Since we unshared the PID namespace, the first fork() should have produced pid 1 in the\n        // new namespace.  That means that if this pid ever exits, everything under it dies.  That's\n        // perfect!  Otherwise we'd have to carefully kill node and mongo separately.\n        KJ_ASSERT(getpid() == 1, \"unshare(CLONE_NEWPID) didn't do what I expected.\", getpid());\n    \n        // Lock the pidfile and make sure it still belongs to us.\n        //\n        // We need to wait for the parent process to release its lock, so we use F_SETLKW.\n        // However, if another Sandstorm server is started simultaneously and manages to steal\n        // ownership, we want to detect this and exit, so we take a shared (read-only) lock.\n        {\n          struct flock lock;\n          memset(&lock, 0, sizeof(lock));\n          lock.l_type = F_RDLCK;\n          lock.l_whence = SEEK_SET;\n          lock.l_start = 0;\n          lock.l_len = 0;  // entire file\n          KJ_SYSCALL(fcntl(pidfile, F_SETLKW, &lock));\n    \n          // Verify that we still own the file.\n          KJ_SYSCALL(lseek(pidfile, 0, SEEK_SET));\n          pid_t pidfilePid = KJ_ASSERT_NONNULL(parseUInt(trim(readAll(pidfile)), 10));\n          if (pidfilePid != mainPid) {\n            context.exitInfo(kj::str(\n                \"Oops, Sandstorm PID \", pidfilePid, \" just started. \"\n                \"PID \", mainPid, \" exiting in deference.\"));\n          }\n        }\n    \n        // Redirect stdio.\n        {\n          auto logFd = raiiOpen(\"../var/log/sandstorm.log\", O_WRONLY | O_APPEND | O_CREAT, 0660);\n          if (runningAsRoot) { KJ_SYSCALL(fchown(logFd, config.uids.uid, config.uids.gid)); }\n          KJ_SYSCALL(dup2(logFd, STDOUT_FILENO));\n          KJ_SYSCALL(dup2(logFd, STDERR_FILENO));\n        }\n        {\n          auto nullFd = raiiOpen(\"/dev/null\", O_RDONLY);\n          KJ_SYSCALL(dup2(nullFd, STDIN_FILENO));\n        }\n    \n        // Write time to log.\n        time_t now;\n        time(&now);\n        context.warning(kj::str(\"** Starting Sandstorm at: \", ctime(&now)));\n    \n        // Detach from controlling terminal and make ourselves session leader.\n        KJ_SYSCALL(setsid());\n    \n        FdBundle fdBundle(config);\n    \n        runUpdateMonitor(config, fdBundle, pidfile);\n      }\n    \n      kj::MainBuilder::Validity inheritFd(kj::StringPtr mapping) {\n        auto parts = split(mapping, ':');\n        if (parts.size() != 3) {\n          return \"invalid syntax for port mapping\";\n        }\n    \n        int fd;\n        KJ_IF_MAYBE(p, parseUInt(kj::str(parts[0]), 10)) {\n          fd = *p;\n        } else {\n          return \"invalid fd\";\n        }\n    \n        kj::String type = kj::str(parts[1]);\n        if (type != \"tcp\") {\n          return \"invalid type\";\n        }\n    \n        uint port;\n        KJ_IF_MAYBE(p, parseUInt(kj::str(parts[2]), 10)) {\n          port = *p;\n        } else {\n          return \"invalid port\";\n        }\n    \n        KJ_SYSCALL(ioctl(fd, FIOCLEX));  // set CLOEXEC\n        if (!inheritedTcpPorts.insert(std::make_pair(port, kj::AutoCloseFd(fd))).second) {\n          return \"duplicate port\";\n        }\n    \n        return true;\n      }\n    \n      kj::MainBuilder::Validity inheritPidfileFd(kj::StringPtr pidfileFdStr) {\n        KJ_IF_MAYBE(p, parseUInt(pidfileFdStr, 10)) {\n          inheritedPidfile = kj::AutoCloseFd(*p);\n          KJ_SYSCALL(ioctl(inheritedPidfile, FIOCLEX));  // set CLOEXEC\n          return true;\n        } else {\n          return \"invalid fd\";\n        }\n      }\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "run"
          ],
          "line": 450
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "{'i', \"init\"}",
            "KJ_BIND_METHOD(*this, init)",
            "\"first run\""
          ],
          "line": 447
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "init"
          ],
          "line": 449
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "\"Sandstorm App Index\"",
            "\"Runs the Sandstorm app index.\""
          ],
          "line": 447
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nAppIndexMain {\n  kj::MainFunc getMain() {\n      return kj::MainBuilder(context, \"Sandstorm App Index\",\n                             \"Runs the Sandstorm app index.\")\n          .addOption({'i', \"init\"}, KJ_BIND_METHOD(*this, init), \"first run\")\n          .callAfterParsing(KJ_BIND_METHOD(*this, run))\n          .build();\n    }\n}"
  },
  {
    "function_name": "AppIndexMain",
    "container": "AppIndexMain",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "442-444",
    "snippet": "AppIndexMain(kj::ProcessContext& context): context(context), ioContext(kj::setupAsyncIo()) {\n    kj::_::Debug::setLogLevel(kj::LogSeverity::INFO);\n  }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::_::Debug::setLogLevel",
          "args": [
            "kj::LogSeverity::INFO"
          ],
          "line": 443
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::setupAsyncIo",
          "args": [],
          "line": 442
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nAppIndexMain {\n  AppIndexMain(kj::ProcessContext& context): context(context), ioContext(kj::setupAsyncIo()) {\n      kj::_::Debug::setLogLevel(kj::LogSeverity::INFO);\n    }\n}"
  },
  {
    "function_name": "newSession",
    "container": "UiViewImpl",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "406-434",
    "snippet": "kj::Promise<void> newSession(NewSessionContext context) override {\n    auto params = context.getParams();\n\n    auto userInfo = params.getUserInfo();\n    auto permissions = userInfo.getPermissions();\n    auto hasPermission = [&](uint index) {\n      return index < permissions.size() && permissions[index];\n    };\n\n    UiSession::Client result = nullptr;\n\n    if (params.getSessionType() == capnp::typeId<ApiSession>()) {\n      KJ_REQUIRE(hasPermission(SUBMIT_PERMISSION),\n                 \"client does not have permission to submit apps; can't use API\");\n      result = kj::heap<SubmissionSession>(\n          indexer, params.getContext().castAs<HackSessionContext>());\n    } else if (params.getSessionType() == capnp::typeId<WebSession>()) {\n      KJ_REQUIRE(hasPermission(REVIEW_PERMISSION),\n                 \"client does not have permission to review apps; can't use web interface\");\n      result = kj::heap<ReviewSession>(\n          indexer, params.getContext().castAs<HackSessionContext>(),\n          hasPermission(APPROVE_PERMISSION));\n    } else {\n      KJ_FAIL_REQUIRE(\"Unsupported session type.\");\n    }\n\n    context.initResults(capnp::MessageSize {4, 1}).setSession(kj::mv(result));\n    return kj::READY_NOW;\n  }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.initResults",
          "args": [
            "kj::mv(result)"
          ],
          "line": 432
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "result"
          ],
          "line": 432
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.initResults",
          "args": [
            "capnp::MessageSize {4, 1}"
          ],
          "line": 432
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_REQUIRE",
          "args": [
            "\"Unsupported session type.\""
          ],
          "line": 429
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heap<ReviewSession>",
          "args": [
            "indexer",
            "params.getContext().castAs<HackSessionContext>()",
            "hasPermission(APPROVE_PERMISSION)"
          ],
          "line": 425
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "hasPermission",
          "args": [
            "APPROVE_PERMISSION"
          ],
          "line": 427
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContext",
          "args": [],
          "line": 426
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContext",
          "args": [],
          "line": 426
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "hasPermission(REVIEW_PERMISSION)",
            "\"client does not have permission to review apps; can't use web interface\""
          ],
          "line": 423
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "hasPermission",
          "args": [
            "REVIEW_PERMISSION"
          ],
          "line": 423
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::typeId<WebSession>",
          "args": [],
          "line": 422
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getSessionType",
          "args": [],
          "line": 422
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heap<SubmissionSession>",
          "args": [
            "indexer",
            "params.getContext().castAs<HackSessionContext>()"
          ],
          "line": 420
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContext",
          "args": [],
          "line": 421
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContext",
          "args": [],
          "line": 421
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "hasPermission(SUBMIT_PERMISSION)",
            "\"client does not have permission to submit apps; can't use API\""
          ],
          "line": 418
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "hasPermission",
          "args": [
            "SUBMIT_PERMISSION"
          ],
          "line": 418
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::typeId<ApiSession>",
          "args": [],
          "line": 417
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getSessionType",
          "args": [],
          "line": 417
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "permissions.size",
          "args": [],
          "line": 412
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "userInfo.getPermissions",
          "args": [],
          "line": 410
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getUserInfo",
          "args": [],
          "line": 409
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getParams",
          "args": [],
          "line": 407
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nUiViewImpl {\n  kj::Promise<void> newSession(NewSessionContext context) override {\n      auto params = context.getParams();\n  \n      auto userInfo = params.getUserInfo();\n      auto permissions = userInfo.getPermissions();\n      auto hasPermission = [&](uint index) {\n        return index < permissions.size() && permissions[index];\n      };\n  \n      UiSession::Client result = nullptr;\n  \n      if (params.getSessionType() == capnp::typeId<ApiSession>()) {\n        KJ_REQUIRE(hasPermission(SUBMIT_PERMISSION),\n                   \"client does not have permission to submit apps; can't use API\");\n        result = kj::heap<SubmissionSession>(\n            indexer, params.getContext().castAs<HackSessionContext>());\n      } else if (params.getSessionType() == capnp::typeId<WebSession>()) {\n        KJ_REQUIRE(hasPermission(REVIEW_PERMISSION),\n                   \"client does not have permission to review apps; can't use web interface\");\n        result = kj::heap<ReviewSession>(\n            indexer, params.getContext().castAs<HackSessionContext>(),\n            hasPermission(APPROVE_PERMISSION));\n      } else {\n        KJ_FAIL_REQUIRE(\"Unsupported session type.\");\n      }\n  \n      context.initResults(capnp::MessageSize {4, 1}).setSession(kj::mv(result));\n      return kj::READY_NOW;\n    }\n}"
  },
  {
    "function_name": "getViewInfo",
    "container": "UiViewImpl",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "401-404",
    "snippet": "kj::Promise<void> getViewInfo(GetViewInfoContext context) override {\n    context.setResults(APP_INDEX_VIEW_INFO);\n    return kj::READY_NOW;\n  }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.setResults",
          "args": [
            "APP_INDEX_VIEW_INFO"
          ],
          "line": 402
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nUiViewImpl {\n  kj::Promise<void> getViewInfo(GetViewInfoContext context) override {\n      context.setResults(APP_INDEX_VIEW_INFO);\n      return kj::READY_NOW;\n    }\n}"
  },
  {
    "function_name": "UiViewImpl",
    "container": "UiViewImpl",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "399-399",
    "snippet": "explicit UiViewImpl(Indexer& indexer): indexer(indexer) {}",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nUiViewImpl {\n  explicit UiViewImpl(Indexer& indexer): indexer(indexer) {}\n}"
  },
  {
    "function_name": "post",
    "container": "ReviewSession",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "309-389",
    "snippet": "kj::Promise<void> post(PostContext context) override {\n    return kj::evalNow([&]() -> kj::Promise<void> {\n      KJ_REQUIRE(canApprove, \"approval permission denied; you can only view the review queue\");\n\n      auto params = context.getParams();\n      auto path = params.getPath();\n      KJ_LOG(INFO, path);\n      if (path.startsWith(\"approve/\")) {\n        // TODO(soon): Set URL.\n        indexer.approve(path.slice(strlen(\"approve/\")), \"\");\n        indexer.updateIndex();\n        context.getResults().initNoContent();\n      } else if (path.startsWith(\"reject/\")) {\n        indexer.reject(path.slice(strlen(\"reject/\")),\n            kj::str(params.getContent().getContent().asChars()));\n        indexer.updateIndex();  // remove from experimental\n        context.getResults().initNoContent();\n      } else if (path.startsWith(\"unapprove/\")) {\n        indexer.unapprove(path.slice(strlen(\"unapprove/\")));\n        indexer.updateIndex();\n        context.getResults().initNoContent();\n      } else if (path == \"reindex\") {\n        indexer.updateIndex();\n        context.getResults().initNoContent();\n      } else if (path.startsWith(\"keybase/\")) {\n        // As a temporary hack, we process keybase API results client-side and then upload them\n        // in a non-JSON format.\n        //\n        // TODO(cleanup): Implement a JSON parser that we can run server-side.\n\n        auto fingerprint = path.slice(strlen(\"keybase/\"));\n        KJ_REQUIRE(fingerprint.size() >= 32 && fingerprint.size() <= 128, \"bad fingerprint\");\n        for (char c: fingerprint) {\n          KJ_REQUIRE(isalnum(c), \"bad fingerprint\");\n        }\n\n        kj::Vector<kj::String> keys;\n        std::map<kj::StringPtr, kj::Vector<kj::String>> items;\n        auto lines = splitLines(kj::heapString(params.getContent().getContent().asChars()));\n\n        for (auto& line: lines) {\n          size_t colonPos = KJ_REQUIRE_NONNULL(line.findFirst(':'));\n          auto key = kj::heapString(line.slice(0, colonPos));\n          items[key].add(kj::heapString(line.slice(colonPos + 1)));\n          keys.add(kj::mv(key));\n        }\n\n        capnp::MallocMessageBuilder message;\n        auto keybase = message.getRoot<KeybaseIdentity>();\n\n        KJ_REQUIRE(items[\"username\"].size() > 0, \"missing username\");\n        keybase.setKeybaseHandle(items[\"username\"][0]);\n\n        if (items[\"name\"].size() > 0) {\n          keybase.setName(items[\"name\"][0]);\n        }\n        if (items[\"picture\"].size() > 0 && items[\"picture\"][0].startsWith(\"http\")) {\n          keybase.setPicture(items[\"picture\"][0]);\n        }\n\n#define TO_STRPTR_ARRAY(array) KJ_MAP(s, array) -> capnp::Text::Reader { return s; }\n        keybase.setWebsites(TO_STRPTR_ARRAY(items[\"proof.generic_web_site\"]));\n        keybase.setGithubHandles(TO_STRPTR_ARRAY(items[\"proof.github\"]));\n        keybase.setTwitterHandles(TO_STRPTR_ARRAY(items[\"proof.twitter\"]));\n        keybase.setHackernewsHandles(TO_STRPTR_ARRAY(items[\"proof.hackernews\"]));\n        keybase.setRedditHandles(TO_STRPTR_ARRAY(items[\"proof.reddit\"]));\n#undef TO_STRPTR_ARRAY\n\n        indexer.addKeybaseProfile(fingerprint, message);\n        context.getResults().initNoContent();\n      } else {\n        auto error = context.getResults().initClientError();\n        error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n        error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n      }\n\n      return kj::READY_NOW;\n    }).catch_([context](kj::Exception&& e) mutable {\n      handleError(context, kj::mv(e));\n    });\n  }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::evalNow",
          "args": [
            "[context](kj::Exception&& e) mutable {\n      handleError(context, kj::mv(e));\n    }"
          ],
          "line": 310
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "handleError",
          "args": [
            "context",
            "kj::mv(e)"
          ],
          "line": 387
        },
        "resolved": true,
        "details": {
          "function_name": "handleError",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
          "lines": "67-71",
          "snippet": "void handleError(Context& context, kj::Exception&& e) {\n  KJ_LOG(ERROR, e);\n  auto error = context.getResults().initServerError();\n  error.setDescriptionHtml(kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\"));\n}",
          "includes": [
            "#include \"indexer.h\"",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include <sandstorm/util.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <map>",
            "#include <sodium/crypto_sign.h>",
            "#include <ctype.h>",
            "#include <errno.h>",
            "#include <dirent.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <fcntl.h>",
            "#include <stdio.h>",
            "#include <stdlib.h>",
            "#include <unistd.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/membrane.h>",
            "#include <capnp/serialize-packed.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async-io.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid handleError(Context& context, kj::Exception&& e) {\n  KJ_LOG(ERROR, e);\n  auto error = context.getResults().initServerError();\n  error.setDescriptionHtml(kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\"));\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "e"
          ],
          "line": 387
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::evalNow",
          "args": [
            "[&]() -> kj::Promise<void> {\n      KJ_REQUIRE(canApprove, \"approval permission denied; you can only view the review queue\");\n\n      auto params = context.getParams();\n      auto path = params.getPath();\n      KJ_LOG(INFO, path);\n      if (path.startsWith(\"approve/\")) {\n        // TODO(soon): Set URL.\n        indexer.approve(path.slice(strlen(\"approve/\")), \"\");\n        indexer.updateIndex();\n        context.getResults().initNoContent();\n      } else if (path.startsWith(\"reject/\")) {\n        indexer.reject(path.slice(strlen(\"reject/\")),\n            kj::str(params.getContent().getContent().asChars()));\n        indexer.updateIndex();  // remove from experimental\n        context.getResults().initNoContent();\n      } else if (path.startsWith(\"unapprove/\")) {\n        indexer.unapprove(path.slice(strlen(\"unapprove/\")));\n        indexer.updateIndex();\n        context.getResults().initNoContent();\n      } else if (path == \"reindex\") {\n        indexer.updateIndex();\n        context.getResults().initNoContent();\n      } else if (path.startsWith(\"keybase/\")) {\n        // As a temporary hack, we process keybase API results client-side and then upload them\n        // in a non-JSON format.\n        //\n        // TODO(cleanup): Implement a JSON parser that we can run server-side.\n\n        auto fingerprint = path.slice(strlen(\"keybase/\"));\n        KJ_REQUIRE(fingerprint.size() >= 32 && fingerprint.size() <= 128, \"bad fingerprint\");\n        for (char c: fingerprint) {\n          KJ_REQUIRE(isalnum(c), \"bad fingerprint\");\n        }\n\n        kj::Vector<kj::String> keys;\n        std::map<kj::StringPtr, kj::Vector<kj::String>> items;\n        auto lines = splitLines(kj::heapString(params.getContent().getContent().asChars()));\n\n        for (auto& line: lines) {\n          size_t colonPos = KJ_REQUIRE_NONNULL(line.findFirst(':'));\n          auto key = kj::heapString(line.slice(0, colonPos));\n          items[key].add(kj::heapString(line.slice(colonPos + 1)));\n          keys.add(kj::mv(key));\n        }\n\n        capnp::MallocMessageBuilder message;\n        auto keybase = message.getRoot<KeybaseIdentity>();\n\n        KJ_REQUIRE(items[\"username\"].size() > 0, \"missing username\");\n        keybase.setKeybaseHandle(items[\"username\"][0]);\n\n        if (items[\"name\"].size() > 0) {\n          keybase.setName(items[\"name\"][0]);\n        }\n        if (items[\"picture\"].size() > 0 && items[\"picture\"][0].startsWith(\"http\")) {\n          keybase.setPicture(items[\"picture\"][0]);\n        }\n\n#define TO_STRPTR_ARRAY(array) KJ_MAP(s, array) -> capnp::Text::Reader { return s; }\n        keybase.setWebsites(TO_STRPTR_ARRAY(items[\"proof.generic_web_site\"]));\n        keybase.setGithubHandles(TO_STRPTR_ARRAY(items[\"proof.github\"]));\n        keybase.setTwitterHandles(TO_STRPTR_ARRAY(items[\"proof.twitter\"]));\n        keybase.setHackernewsHandles(TO_STRPTR_ARRAY(items[\"proof.hackernews\"]));\n        keybase.setRedditHandles(TO_STRPTR_ARRAY(items[\"proof.reddit\"]));\n#undef TO_STRPTR_ARRAY\n\n        indexer.addKeybaseProfile(fingerprint, message);\n        context.getResults().initNoContent();\n      } else {\n        auto error = context.getResults().initClientError();\n        error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n        error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n      }\n\n      return kj::READY_NOW;\n    }"
          ],
          "line": 310
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "error.setDescriptionHtml",
          "args": [
            "\"<html><body><pre>404 not found</pre></body></html>\""
          ],
          "line": 382
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "error.setStatusCode",
          "args": [
            "WebSession::Response::ClientErrorCode::NOT_FOUND"
          ],
          "line": 381
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 380
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 380
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 378
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 378
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.addKeybaseProfile",
          "args": [
            "fingerprint",
            "message"
          ],
          "line": 377
        },
        "resolved": true,
        "details": {
          "function_name": "addKeybaseProfile",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "72-76",
          "snippet": "void Indexer::addKeybaseProfile(kj::StringPtr fingerprint, capnp::MallocMessageBuilder& message) {\n  StagingFile file(\"/var/keybase\");\n  capnp::writeMessageToFd(file.getFd(), message);\n  file.finalize(kj::str(\"/var/keybase/\", fingerprint));\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::addKeybaseProfile(kj::StringPtr fingerprint, capnp::MallocMessageBuilder& message) {\n    StagingFile file(\"/var/keybase\");\n    capnp::writeMessageToFd(file.getFd(), message);\n    file.finalize(kj::str(\"/var/keybase/\", fingerprint));\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "keybase.setRedditHandles",
          "args": [
            "TO_STRPTR_ARRAY(items[\"proof.reddit\"])"
          ],
          "line": 374
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "TO_STRPTR_ARRAY",
          "args": [
            "items[\"proof.reddit\"]"
          ],
          "line": 374
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.setHackernewsHandles",
          "args": [
            "TO_STRPTR_ARRAY(items[\"proof.hackernews\"])"
          ],
          "line": 373
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "TO_STRPTR_ARRAY",
          "args": [
            "items[\"proof.hackernews\"]"
          ],
          "line": 373
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.setTwitterHandles",
          "args": [
            "TO_STRPTR_ARRAY(items[\"proof.twitter\"])"
          ],
          "line": 372
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "TO_STRPTR_ARRAY",
          "args": [
            "items[\"proof.twitter\"]"
          ],
          "line": 372
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.setGithubHandles",
          "args": [
            "TO_STRPTR_ARRAY(items[\"proof.github\"])"
          ],
          "line": 371
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "TO_STRPTR_ARRAY",
          "args": [
            "items[\"proof.github\"]"
          ],
          "line": 371
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.setWebsites",
          "args": [
            "TO_STRPTR_ARRAY(items[\"proof.generic_web_site\"])"
          ],
          "line": 370
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "TO_STRPTR_ARRAY",
          "args": [
            "items[\"proof.generic_web_site\"]"
          ],
          "line": 370
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.setPicture",
          "args": [
            "items[\"picture\"][0]"
          ],
          "line": 366
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "items[\"picture\"][0].startsWith",
          "args": [
            "\"http\""
          ],
          "line": 365
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "items[\"picture\"].size",
          "args": [],
          "line": 365
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "keybase.setName",
          "args": [
            "items[\"name\"][0]"
          ],
          "line": 363
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.setKeybaseHandle",
          "args": [
            "items[\"username\"][0]"
          ],
          "line": 360
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "items[\"username\"].size() > 0",
            "\"missing username\""
          ],
          "line": 359
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "message.getRoot<KeybaseIdentity>",
          "args": [],
          "line": 357
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keys.add",
          "args": [
            "kj::mv(key)"
          ],
          "line": 353
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "key"
          ],
          "line": 353
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "items[key].add",
          "args": [
            "kj::heapString(line.slice(colonPos + 1))"
          ],
          "line": 352
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "line.slice(colonPos + 1)"
          ],
          "line": 352
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "line.slice",
          "args": [
            "colonPos + 1"
          ],
          "line": 352
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "line.slice(0, colonPos)"
          ],
          "line": 351
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "line.slice",
          "args": [
            "0",
            "colonPos"
          ],
          "line": 351
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE_NONNULL",
          "args": [
            "line.findFirst(':')"
          ],
          "line": 350
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "line.findFirst",
          "args": [
            "':'"
          ],
          "line": 350
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "splitLines",
          "args": [
            "kj::heapString(params.getContent().getContent().asChars())"
          ],
          "line": 347
        },
        "resolved": true,
        "details": {
          "function_name": "splitLines",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "387-414",
          "snippet": "kj::Array<kj::String> splitLines(kj::StringPtr input) {\n  size_t lineStart = 0;\n  kj::Vector<kj::String> results;\n  for (size_t i = 0; i < input.size(); i++) {\n    if (input[i] == '\\n' || input[i] == '#') {\n      bool hasComment = input[i] == '#';\n      auto line = trim(input.slice(lineStart, i));\n      if (line.size() > 0) {\n        results.add(kj::mv(line));\n      }\n      if (hasComment) {\n        // Ignore through newline.\n        ++i;\n        while (i < input.size() && input[i] != '\\n') ++i;\n      }\n      lineStart = i + 1;\n    }\n  }\n\n  if (lineStart < input.size()) {\n    auto lastLine = trim(input.slice(lineStart));\n    if (lastLine.size() > 0) {\n      results.add(kj::mv(lastLine));\n    }\n  }\n\n  return results.releaseAsArray();\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Array<kj::String> splitLines(kj::StringPtr input) {\n  size_t lineStart = 0;\n  kj::Vector<kj::String> results;\n  for (size_t i = 0; i < input.size(); i++) {\n    if (input[i] == '\\n' || input[i] == '#') {\n      bool hasComment = input[i] == '#';\n      auto line = trim(input.slice(lineStart, i));\n      if (line.size() > 0) {\n        results.add(kj::mv(line));\n      }\n      if (hasComment) {\n        // Ignore through newline.\n        ++i;\n        while (i < input.size() && input[i] != '\\n') ++i;\n      }\n      lineStart = i + 1;\n    }\n  }\n\n  if (lineStart < input.size()) {\n    auto lastLine = trim(input.slice(lineStart));\n    if (lastLine.size() > 0) {\n      results.add(kj::mv(lastLine));\n    }\n  }\n\n  return results.releaseAsArray();\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "params.getContent().getContent().asChars()"
          ],
          "line": 347
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContent",
          "args": [],
          "line": 347
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContent",
          "args": [],
          "line": 347
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContent",
          "args": [],
          "line": 347
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "isalnum(c)",
            "\"bad fingerprint\""
          ],
          "line": 342
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "isalnum",
          "args": [
            "c"
          ],
          "line": 342
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "fingerprint.size() >= 32 && fingerprint.size() <= 128",
            "\"bad fingerprint\""
          ],
          "line": 340
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.slice",
          "args": [
            "strlen(\"keybase/\")"
          ],
          "line": 339
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "\"keybase/\""
          ],
          "line": 339
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.startsWith",
          "args": [
            "\"keybase/\""
          ],
          "line": 333
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 332
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 332
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.updateIndex",
          "args": [],
          "line": 331
        },
        "resolved": true,
        "details": {
          "function_name": "updateIndex",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "416-419",
          "snippet": "void Indexer::updateIndex() {\n  updateIndexInternal(\"/var/www/apps\", false);\n  updateIndexInternal(\"/var/www/experimental\", true);\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::updateIndex() {\n    updateIndexInternal(\"/var/www/apps\", false);\n    updateIndexInternal(\"/var/www/experimental\", true);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 329
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 329
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.unapprove",
          "args": [
            "path.slice(strlen(\"unapprove/\"))"
          ],
          "line": 327
        },
        "resolved": true,
        "details": {
          "function_name": "unapprove",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "145-151",
          "snippet": "void Indexer::unapprove(kj::StringPtr packageId) {\n  updatePackageStatus(packageId, [](auto&& status) {\n    if (status.isPending()) return false;\n    status.setPending();\n    return true;\n  });\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::unapprove(kj::StringPtr packageId) {\n    updatePackageStatus(packageId, [](auto&& status) {\n      if (status.isPending()) return false;\n      status.setPending();\n      return true;\n    });\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "path.slice",
          "args": [
            "strlen(\"unapprove/\")"
          ],
          "line": 327
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "\"unapprove/\""
          ],
          "line": 327
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.startsWith",
          "args": [
            "\"unapprove/\""
          ],
          "line": 326
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 325
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 325
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.reject",
          "args": [
            "path.slice(strlen(\"reject/\"))",
            "kj::str(params.getContent().getContent().asChars())"
          ],
          "line": 322
        },
        "resolved": true,
        "details": {
          "function_name": "reject",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "153-158",
          "snippet": "void Indexer::reject(kj::StringPtr packageId, kj::StringPtr reason) {\n  updatePackageStatus(packageId, [&](auto&& status) {\n    status.setNeedsUpdate(reason);\n    return true;\n  });\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::reject(kj::StringPtr packageId, kj::StringPtr reason) {\n    updatePackageStatus(packageId, [&](auto&& status) {\n      status.setNeedsUpdate(reason);\n      return true;\n    });\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "params.getContent().getContent().asChars()"
          ],
          "line": 323
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContent",
          "args": [],
          "line": 323
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContent",
          "args": [],
          "line": 323
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContent",
          "args": [],
          "line": 323
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.slice",
          "args": [
            "strlen(\"reject/\")"
          ],
          "line": 322
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "\"reject/\""
          ],
          "line": 322
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.startsWith",
          "args": [
            "\"reject/\""
          ],
          "line": 321
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.approve",
          "args": [
            "path.slice(strlen(\"approve/\"))",
            "\"\""
          ],
          "line": 318
        },
        "resolved": true,
        "details": {
          "function_name": "approve",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "137-143",
          "snippet": "void Indexer::approve(kj::StringPtr packageId, kj::StringPtr url) {\n  updatePackageStatus(packageId, [&](auto&& status) {\n    if (status.isApproved()) return false;\n    status.setApproved(url);\n    return true;\n  });\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::approve(kj::StringPtr packageId, kj::StringPtr url) {\n    updatePackageStatus(packageId, [&](auto&& status) {\n      if (status.isApproved()) return false;\n      status.setApproved(url);\n      return true;\n    });\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "path.slice",
          "args": [
            "strlen(\"approve/\")"
          ],
          "line": 318
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "\"approve/\""
          ],
          "line": 318
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.startsWith",
          "args": [
            "\"approve/\""
          ],
          "line": 316
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_LOG",
          "args": [
            "INFO",
            "path"
          ],
          "line": 315
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getPath",
          "args": [],
          "line": 314
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getParams",
          "args": [],
          "line": 313
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "canApprove",
            "\"approval permission denied; you can only view the review queue\""
          ],
          "line": 311
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nReviewSession {\n  kj::Promise<void> post(PostContext context) override {\n      return kj::evalNow([&]() -> kj::Promise<void> {\n        KJ_REQUIRE(canApprove, \"approval permission denied; you can only view the review queue\");\n  \n        auto params = context.getParams();\n        auto path = params.getPath();\n        KJ_LOG(INFO, path);\n        if (path.startsWith(\"approve/\")) {\n          // TODO(soon): Set URL.\n          indexer.approve(path.slice(strlen(\"approve/\")), \"\");\n          indexer.updateIndex();\n          context.getResults().initNoContent();\n        } else if (path.startsWith(\"reject/\")) {\n          indexer.reject(path.slice(strlen(\"reject/\")),\n              kj::str(params.getContent().getContent().asChars()));\n          indexer.updateIndex();  // remove from experimental\n          context.getResults().initNoContent();\n        } else if (path.startsWith(\"unapprove/\")) {\n          indexer.unapprove(path.slice(strlen(\"unapprove/\")));\n          indexer.updateIndex();\n          context.getResults().initNoContent();\n        } else if (path == \"reindex\") {\n          indexer.updateIndex();\n          context.getResults().initNoContent();\n        } else if (path.startsWith(\"keybase/\")) {\n          // As a temporary hack, we process keybase API results client-side and then upload them\n          // in a non-JSON format.\n          //\n          // TODO(cleanup): Implement a JSON parser that we can run server-side.\n  \n          auto fingerprint = path.slice(strlen(\"keybase/\"));\n          KJ_REQUIRE(fingerprint.size() >= 32 && fingerprint.size() <= 128, \"bad fingerprint\");\n          for (char c: fingerprint) {\n            KJ_REQUIRE(isalnum(c), \"bad fingerprint\");\n          }\n  \n          kj::Vector<kj::String> keys;\n          std::map<kj::StringPtr, kj::Vector<kj::String>> items;\n          auto lines = splitLines(kj::heapString(params.getContent().getContent().asChars()));\n  \n          for (auto& line: lines) {\n            size_t colonPos = KJ_REQUIRE_NONNULL(line.findFirst(':'));\n            auto key = kj::heapString(line.slice(0, colonPos));\n            items[key].add(kj::heapString(line.slice(colonPos + 1)));\n            keys.add(kj::mv(key));\n          }\n  \n          capnp::MallocMessageBuilder message;\n          auto keybase = message.getRoot<KeybaseIdentity>();\n  \n          KJ_REQUIRE(items[\"username\"].size() > 0, \"missing username\");\n          keybase.setKeybaseHandle(items[\"username\"][0]);\n  \n          if (items[\"name\"].size() > 0) {\n            keybase.setName(items[\"name\"][0]);\n          }\n          if (items[\"picture\"].size() > 0 && items[\"picture\"][0].startsWith(\"http\")) {\n            keybase.setPicture(items[\"picture\"][0]);\n          }\n  \n  #define TO_STRPTR_ARRAY(array) KJ_MAP(s, array) -> capnp::Text::Reader { return s; }\n          keybase.setWebsites(TO_STRPTR_ARRAY(items[\"proof.generic_web_site\"]));\n          keybase.setGithubHandles(TO_STRPTR_ARRAY(items[\"proof.github\"]));\n          keybase.setTwitterHandles(TO_STRPTR_ARRAY(items[\"proof.twitter\"]));\n          keybase.setHackernewsHandles(TO_STRPTR_ARRAY(items[\"proof.hackernews\"]));\n          keybase.setRedditHandles(TO_STRPTR_ARRAY(items[\"proof.reddit\"]));\n  #undef TO_STRPTR_ARRAY\n  \n          indexer.addKeybaseProfile(fingerprint, message);\n          context.getResults().initNoContent();\n        } else {\n          auto error = context.getResults().initClientError();\n          error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n          error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n        }\n  \n        return kj::READY_NOW;\n      }).catch_([context](kj::Exception&& e) mutable {\n        handleError(context, kj::mv(e));\n      });\n    }\n}"
  },
  {
    "function_name": "get",
    "container": "ReviewSession",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "279-307",
    "snippet": "kj::Promise<void> get(GetContext context) override {\n    return kj::evalNow([&]() -> kj::Promise<void> {\n      auto path = context.getParams().getPath();\n      if (path == \"\") {\n        auto content = context.getResults().initContent();\n        content.setMimeType(\"text/html; charset=utf-8\");\n        content.initBody().setBytes(REVIEW_APP_HTML->asBytes());\n      } else if (path == \"queue\") {\n        auto content = context.getResults().initContent();\n        content.setMimeType(\"application/json\");\n        content.initBody().setBytes(indexer.getReviewQueueJson().asBytes());\n      } else if (path == \"public-id\") {\n        context.releaseParams();\n        return session.getPublicIdRequest().send().then([context](auto&& result) mutable {\n          auto content = context.getResults().initContent();\n          content.setMimeType(\"application/json\");\n          content.initBody().setBytes(capnp::JsonCodec().encode(result).asBytes());\n        });\n      } else {\n        auto error = context.getResults().initClientError();\n        error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n        error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n      }\n\n      return kj::READY_NOW;\n    }).catch_([context](kj::Exception&& e) mutable {\n      handleError(context, kj::mv(e));\n    });\n  }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::evalNow",
          "args": [
            "[context](kj::Exception&& e) mutable {\n      handleError(context, kj::mv(e));\n    }"
          ],
          "line": 280
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "handleError",
          "args": [
            "context",
            "kj::mv(e)"
          ],
          "line": 305
        },
        "resolved": true,
        "details": {
          "function_name": "handleError",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
          "lines": "67-71",
          "snippet": "void handleError(Context& context, kj::Exception&& e) {\n  KJ_LOG(ERROR, e);\n  auto error = context.getResults().initServerError();\n  error.setDescriptionHtml(kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\"));\n}",
          "includes": [
            "#include \"indexer.h\"",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include <sandstorm/util.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <map>",
            "#include <sodium/crypto_sign.h>",
            "#include <ctype.h>",
            "#include <errno.h>",
            "#include <dirent.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <fcntl.h>",
            "#include <stdio.h>",
            "#include <stdlib.h>",
            "#include <unistd.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/membrane.h>",
            "#include <capnp/serialize-packed.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async-io.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid handleError(Context& context, kj::Exception&& e) {\n  KJ_LOG(ERROR, e);\n  auto error = context.getResults().initServerError();\n  error.setDescriptionHtml(kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\"));\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "e"
          ],
          "line": 305
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::evalNow",
          "args": [
            "[&]() -> kj::Promise<void> {\n      auto path = context.getParams().getPath();\n      if (path == \"\") {\n        auto content = context.getResults().initContent();\n        content.setMimeType(\"text/html; charset=utf-8\");\n        content.initBody().setBytes(REVIEW_APP_HTML->asBytes());\n      } else if (path == \"queue\") {\n        auto content = context.getResults().initContent();\n        content.setMimeType(\"application/json\");\n        content.initBody().setBytes(indexer.getReviewQueueJson().asBytes());\n      } else if (path == \"public-id\") {\n        context.releaseParams();\n        return session.getPublicIdRequest().send().then([context](auto&& result) mutable {\n          auto content = context.getResults().initContent();\n          content.setMimeType(\"application/json\");\n          content.initBody().setBytes(capnp::JsonCodec().encode(result).asBytes());\n        });\n      } else {\n        auto error = context.getResults().initClientError();\n        error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n        error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n      }\n\n      return kj::READY_NOW;\n    }"
          ],
          "line": 280
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "error.setDescriptionHtml",
          "args": [
            "\"<html><body><pre>404 not found</pre></body></html>\""
          ],
          "line": 300
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "error.setStatusCode",
          "args": [
            "WebSession::Response::ClientErrorCode::NOT_FOUND"
          ],
          "line": 299
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 298
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 298
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "session.getPublicIdRequest",
          "args": [
            "[context](auto&& result) mutable {\n          auto content = context.getResults().initContent();\n          content.setMimeType(\"application/json\");\n          content.initBody().setBytes(capnp::JsonCodec().encode(result).asBytes());\n        }"
          ],
          "line": 292
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.initBody",
          "args": [
            "capnp::JsonCodec().encode(result).asBytes()"
          ],
          "line": 295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::JsonCodec",
          "args": [],
          "line": 295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::JsonCodec",
          "args": [
            "result"
          ],
          "line": 295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::JsonCodec",
          "args": [],
          "line": 295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.initBody",
          "args": [],
          "line": 295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.setMimeType",
          "args": [
            "\"application/json\""
          ],
          "line": 294
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 293
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 293
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "session.getPublicIdRequest",
          "args": [],
          "line": 292
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "session.getPublicIdRequest",
          "args": [],
          "line": 292
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.releaseParams",
          "args": [],
          "line": 291
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.initBody",
          "args": [
            "indexer.getReviewQueueJson().asBytes()"
          ],
          "line": 289
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.getReviewQueueJson",
          "args": [],
          "line": 289
        },
        "resolved": true,
        "details": {
          "function_name": "getReviewQueueJson",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "486-527",
          "snippet": "kj::String Indexer::getReviewQueueJson() {\n  kj::Vector<kj::String> reviewIds;\n\n  for (auto& packageId: listDirectory(\"/var/packages\")) {\n    KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n      auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n      auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n\n      KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n\n      capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n      auto status = statusMessage.getRoot<SubmissionStatus>();\n      if (status.isPending() && status.getRequestState() != SubmissionState::IGNORE) {\n        reviewIds.add(kj::str(packageId));\n      }\n    })) {\n      KJ_LOG(ERROR, \"error processing package\", packageId, *exception);\n    }\n  }\n\n  capnp::MallocMessageBuilder scratch;\n  auto orphan = scratch.getOrphanage().newOrphan<capnp::List<spk::VerifiedInfo>>(reviewIds.size());\n  auto list = orphan.get();\n  uint i = 0;\n\n  for (auto& packageId: reviewIds) {\n    auto metadataFile = kj::str(\"/var/packages/\", packageId, \"/metadata\");\n    capnp::StreamFdMessageReader metadataMessage(raiiOpen(metadataFile, O_RDONLY));\n    list.setWithCaveats(i++, metadataMessage.getRoot<spk::VerifiedInfo>());\n  }\n\n  AppIdJsonHandler appIdHandler;\n  PackageIdJsonHandler packageIdHandler;\n  DataHandler dataHandler;\n  capnp::JsonCodec json;\n  json.addTypeHandler(appIdHandler);\n  json.addTypeHandler(packageIdHandler);\n  json.addTypeHandler(dataHandler);\n  json.setPrettyPrint(true);\n\n  return json.encode(list);\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::getReviewQueueJson() {\n    kj::Vector<kj::String> reviewIds;\n  \n    for (auto& packageId: listDirectory(\"/var/packages\")) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n        auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n  \n        KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n  \n        capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n        auto status = statusMessage.getRoot<SubmissionStatus>();\n        if (status.isPending() && status.getRequestState() != SubmissionState::IGNORE) {\n          reviewIds.add(kj::str(packageId));\n        }\n      })) {\n        KJ_LOG(ERROR, \"error processing package\", packageId, *exception);\n      }\n    }\n  \n    capnp::MallocMessageBuilder scratch;\n    auto orphan = scratch.getOrphanage().newOrphan<capnp::List<spk::VerifiedInfo>>(reviewIds.size());\n    auto list = orphan.get();\n    uint i = 0;\n  \n    for (auto& packageId: reviewIds) {\n      auto metadataFile = kj::str(\"/var/packages/\", packageId, \"/metadata\");\n      capnp::StreamFdMessageReader metadataMessage(raiiOpen(metadataFile, O_RDONLY));\n      list.setWithCaveats(i++, metadataMessage.getRoot<spk::VerifiedInfo>());\n    }\n  \n    AppIdJsonHandler appIdHandler;\n    PackageIdJsonHandler packageIdHandler;\n    DataHandler dataHandler;\n    capnp::JsonCodec json;\n    json.addTypeHandler(appIdHandler);\n    json.addTypeHandler(packageIdHandler);\n    json.addTypeHandler(dataHandler);\n    json.setPrettyPrint(true);\n  \n    return json.encode(list);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "content.initBody",
          "args": [],
          "line": 289
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.setMimeType",
          "args": [
            "\"application/json\""
          ],
          "line": 288
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 287
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 287
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.initBody",
          "args": [
            "REVIEW_APP_HTML->asBytes()"
          ],
          "line": 285
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "REVIEW_APP_HTML->asBytes",
          "args": [],
          "line": 285
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.initBody",
          "args": [],
          "line": 285
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.setMimeType",
          "args": [
            "\"text/html; charset=utf-8\""
          ],
          "line": 284
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 283
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 283
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getParams",
          "args": [],
          "line": 281
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getParams",
          "args": [],
          "line": 281
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nReviewSession {\n  kj::Promise<void> get(GetContext context) override {\n      return kj::evalNow([&]() -> kj::Promise<void> {\n        auto path = context.getParams().getPath();\n        if (path == \"\") {\n          auto content = context.getResults().initContent();\n          content.setMimeType(\"text/html; charset=utf-8\");\n          content.initBody().setBytes(REVIEW_APP_HTML->asBytes());\n        } else if (path == \"queue\") {\n          auto content = context.getResults().initContent();\n          content.setMimeType(\"application/json\");\n          content.initBody().setBytes(indexer.getReviewQueueJson().asBytes());\n        } else if (path == \"public-id\") {\n          context.releaseParams();\n          return session.getPublicIdRequest().send().then([context](auto&& result) mutable {\n            auto content = context.getResults().initContent();\n            content.setMimeType(\"application/json\");\n            content.initBody().setBytes(capnp::JsonCodec().encode(result).asBytes());\n          });\n        } else {\n          auto error = context.getResults().initClientError();\n          error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n          error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n        }\n  \n        return kj::READY_NOW;\n      }).catch_([context](kj::Exception&& e) mutable {\n        handleError(context, kj::mv(e));\n      });\n    }\n}"
  },
  {
    "function_name": "ReviewSession",
    "container": "ReviewSession",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "276-277",
    "snippet": "ReviewSession(Indexer& indexer, HackSessionContext::Client session, bool canApprove)\n      : indexer(indexer), session(kj::mv(session)), canApprove(canApprove) {}",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "session"
          ],
          "line": 277
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nReviewSession {\n  ReviewSession(Indexer& indexer, HackSessionContext::Client session, bool canApprove)\n        : indexer(indexer), session(kj::mv(session)), canApprove(canApprove) {}\n}"
  },
  {
    "function_name": "addRef",
    "container": "SubmissionSession::RequestStreamMembrane",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "270-270",
    "snippet": "kj::Own<MembranePolicy> addRef() override { return kj::addRef(*this); }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::addRef",
          "args": [
            "*this"
          ],
          "line": 270
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nSubmissionSession {\n  RequestStreamMembrane {\n    kj::Own<MembranePolicy> addRef() override { return kj::addRef(*this); }\n  }\n}"
  },
  {
    "function_name": "outboundCall",
    "container": "SubmissionSession::RequestStreamMembrane",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "264-268",
    "snippet": "kj::Maybe<capnp::Capability::Client> outboundCall(\n        uint64_t interfaceId, uint16_t methodId, capnp::Capability::Client target) override {\n      // Never called.\n      return nullptr;\n    }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nSubmissionSession {\n  RequestStreamMembrane {\n    kj::Maybe<capnp::Capability::Client> outboundCall(\n            uint64_t interfaceId, uint16_t methodId, capnp::Capability::Client target) override {\n          // Never called.\n          return nullptr;\n        }\n  }\n}"
  },
  {
    "function_name": "inboundCall",
    "container": "SubmissionSession::RequestStreamMembrane",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "255-262",
    "snippet": "kj::Maybe<capnp::Capability::Client> inboundCall(\n        uint64_t interfaceId, uint16_t methodId, capnp::Capability::Client target) override {\n      if (interfaceId != capnp::typeId<ByteStream>()) {\n        return WebSession::RequestStream::Client(\n            kj::heap<StreamWrapper>(target.castAs<AppIndex::UploadStream>()));\n      }\n      return nullptr;\n    }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "WebSession::RequestStream::Client",
          "args": [
            "kj::heap<StreamWrapper>(target.castAs<AppIndex::UploadStream>())"
          ],
          "line": 258
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heap<StreamWrapper>",
          "args": [
            "target.castAs<AppIndex::UploadStream>()"
          ],
          "line": 259
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "target.castAs<AppIndex::UploadStream>",
          "args": [],
          "line": 259
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::typeId<ByteStream>",
          "args": [],
          "line": 257
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nSubmissionSession {\n  RequestStreamMembrane {\n    kj::Maybe<capnp::Capability::Client> inboundCall(\n            uint64_t interfaceId, uint16_t methodId, capnp::Capability::Client target) override {\n          if (interfaceId != capnp::typeId<ByteStream>()) {\n            return WebSession::RequestStream::Client(\n                kj::heap<StreamWrapper>(target.castAs<AppIndex::UploadStream>()));\n          }\n          return nullptr;\n        }\n  }\n}"
  },
  {
    "function_name": "getResponse",
    "container": "SubmissionSession::StreamWrapper",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "236-245",
    "snippet": "kj::Promise<void> getResponse(GetResponseContext context) override {\n      return kj::evalNow([&]() -> kj::Promise<void> {\n        context.releaseParams();\n        return inner.getResultRequest().send().then([this,context](auto&&) mutable {\n          context.initResults().initNoContent();\n        });\n      }).catch_([context](kj::Exception&& e) mutable {\n        handleError(context, kj::mv(e));\n      });\n    }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::evalNow",
          "args": [
            "[context](kj::Exception&& e) mutable {\n        handleError(context, kj::mv(e));\n      }"
          ],
          "line": 237
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "handleError",
          "args": [
            "context",
            "kj::mv(e)"
          ],
          "line": 243
        },
        "resolved": true,
        "details": {
          "function_name": "handleError",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
          "lines": "67-71",
          "snippet": "void handleError(Context& context, kj::Exception&& e) {\n  KJ_LOG(ERROR, e);\n  auto error = context.getResults().initServerError();\n  error.setDescriptionHtml(kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\"));\n}",
          "includes": [
            "#include \"indexer.h\"",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include <sandstorm/util.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <map>",
            "#include <sodium/crypto_sign.h>",
            "#include <ctype.h>",
            "#include <errno.h>",
            "#include <dirent.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <fcntl.h>",
            "#include <stdio.h>",
            "#include <stdlib.h>",
            "#include <unistd.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/membrane.h>",
            "#include <capnp/serialize-packed.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async-io.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid handleError(Context& context, kj::Exception&& e) {\n  KJ_LOG(ERROR, e);\n  auto error = context.getResults().initServerError();\n  error.setDescriptionHtml(kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\"));\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "e"
          ],
          "line": 243
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::evalNow",
          "args": [
            "[&]() -> kj::Promise<void> {\n        context.releaseParams();\n        return inner.getResultRequest().send().then([this,context](auto&&) mutable {\n          context.initResults().initNoContent();\n        });\n      }"
          ],
          "line": 237
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "inner.getResultRequest",
          "args": [
            "[this,context](auto&&) mutable {\n          context.initResults().initNoContent();\n        }"
          ],
          "line": 239
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.initResults",
          "args": [],
          "line": 240
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.initResults",
          "args": [],
          "line": 240
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "inner.getResultRequest",
          "args": [],
          "line": 239
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "inner.getResultRequest",
          "args": [],
          "line": 239
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.releaseParams",
          "args": [],
          "line": 238
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nSubmissionSession {\n  StreamWrapper {\n    kj::Promise<void> getResponse(GetResponseContext context) override {\n          return kj::evalNow([&]() -> kj::Promise<void> {\n            context.releaseParams();\n            return inner.getResultRequest().send().then([this,context](auto&&) mutable {\n              context.initResults().initNoContent();\n            });\n          }).catch_([context](kj::Exception&& e) mutable {\n            handleError(context, kj::mv(e));\n          });\n        }\n  }\n}"
  },
  {
    "function_name": "StreamWrapper",
    "container": "SubmissionSession::StreamWrapper",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "233-233",
    "snippet": "explicit StreamWrapper(AppIndex::UploadStream::Client inner): inner(kj::mv(inner)) {}",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "inner"
          ],
          "line": 233
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nSubmissionSession {\n  StreamWrapper {\n    explicit StreamWrapper(AppIndex::UploadStream::Client inner): inner(kj::mv(inner)) {}\n  }\n}"
  },
  {
    "function_name": "postStreaming",
    "container": "SubmissionSession",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "210-225",
    "snippet": "kj::Promise<void> postStreaming(PostStreamingContext context) override {\n    auto params = context.getParams();\n    auto path = params.getPath();\n    if (path == \"upload\") {\n      KJ_REQUIRE(!params.hasEncoding(), \"can't accept encoded (e.g. gzipped) upload\");\n      context.releaseParams();\n\n      context.getResults(capnp::MessageSize {4,1}).setStream(\n          capnp::membrane(indexer.newUploadStream(), kj::refcounted<RequestStreamMembrane>())\n              .castAs<WebSession::RequestStream>());\n      return kj::READY_NOW;\n    } else {\n      // This should cause the shell to retry using regular post().\n      KJ_UNIMPLEMENTED(\"postStreaming() only implemented for /upload\");\n    }\n  }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_UNIMPLEMENTED",
          "args": [
            "\"postStreaming() only implemented for /upload\""
          ],
          "line": 223
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [
            "capnp::membrane(indexer.newUploadStream(), kj::refcounted<RequestStreamMembrane>())\n              .castAs<WebSession::RequestStream>()"
          ],
          "line": 217
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::membrane",
          "args": [],
          "line": 218
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::membrane",
          "args": [
            "indexer.newUploadStream()",
            "kj::refcounted<RequestStreamMembrane>()"
          ],
          "line": 218
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::refcounted<RequestStreamMembrane>",
          "args": [],
          "line": 218
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.newUploadStream",
          "args": [],
          "line": 218
        },
        "resolved": true,
        "details": {
          "function_name": "newUploadStream",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "615-617",
          "snippet": "AppIndex::UploadStream::Client Indexer::newUploadStream() {\n  return kj::heap<UploadStreamImpl>();\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  AppIndex::UploadStream::Client Indexer::newUploadStream() {\n    return kj::heap<UploadStreamImpl>();\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [
            "capnp::MessageSize {4,1}"
          ],
          "line": 217
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.releaseParams",
          "args": [],
          "line": 215
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "!params.hasEncoding()",
            "\"can't accept encoded (e.g. gzipped) upload\""
          ],
          "line": 214
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.hasEncoding",
          "args": [],
          "line": 214
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getPath",
          "args": [],
          "line": 212
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getParams",
          "args": [],
          "line": 211
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nSubmissionSession {\n  kj::Promise<void> postStreaming(PostStreamingContext context) override {\n      auto params = context.getParams();\n      auto path = params.getPath();\n      if (path == \"upload\") {\n        KJ_REQUIRE(!params.hasEncoding(), \"can't accept encoded (e.g. gzipped) upload\");\n        context.releaseParams();\n  \n        context.getResults(capnp::MessageSize {4,1}).setStream(\n            capnp::membrane(indexer.newUploadStream(), kj::refcounted<RequestStreamMembrane>())\n                .castAs<WebSession::RequestStream>());\n        return kj::READY_NOW;\n      } else {\n        // This should cause the shell to retry using regular post().\n        KJ_UNIMPLEMENTED(\"postStreaming() only implemented for /upload\");\n      }\n    }\n}"
  },
  {
    "function_name": "post",
    "container": "SubmissionSession",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "78-208",
    "snippet": "kj::Promise<void> post(PostContext context) override {\n    return kj::evalNow([&]() -> kj::Promise<void> {\n      auto params = context.getParams();\n      auto path = params.getPath();\n      if (path == \"upload\") {\n        auto content = params.getContent();\n        KJ_REQUIRE(!content.hasEncoding(), \"can't accept encoded (e.g. gzipped) upload\");\n\n        // Write content to upload stream: a write() followed by a done(), and a getResults().\n        auto stream = indexer.newUploadStream();\n        auto promises = kj::heapArrayBuilder<kj::Promise<void>>(3);\n        auto req1 = stream.writeRequest();\n        req1.setData(content.getContent());\n        promises.add(req1.send().then([](auto&&) {}));\n        promises.add(stream.doneRequest().send().then([](auto&&) {}));\n        promises.add(stream.getResultRequest().send().then([](auto&&) {}));\n\n        context.releaseParams();\n\n        // Return \"no content\" when getResult() completes.\n        context.initResults().initNoContent();\n        return kj::joinPromises(promises.finish());\n      } else if (path == \"status\") {\n        auto content = params.getContent();\n        KJ_REQUIRE(!content.hasEncoding(), \"POST can't be encoded (e.g. gzipped)\");\n\n        capnp::MallocMessageBuilder requestMessage;\n\n        auto origBytes = content.getContent();\n        kj::ArrayInputStream stream(origBytes);\n        requestMessage.setRoot(capnp::PackedMessageReader(stream).getRoot<SubmissionRequest>());\n\n        // Whatever is left in the input is the signature. What ever was consumed from the input is\n        // the request.\n        kj::ArrayPtr<const byte> signature = stream.tryGetReadBuffer();\n        KJ_ASSERT(signature.begin() >= origBytes.begin() && signature.end() <= origBytes.end());\n        kj::ArrayPtr<const byte> requestBytes = kj::arrayPtr(origBytes.begin(), signature.begin());\n\n        auto req = requestMessage.getRoot<SubmissionRequest>();\n\n        // TODO(security): Verify request's webkey hash. Need to know our own webkey, somehow.\n\n        auto packageId = packageIdString(req.getPackageId());\n\n        KJ_REQUIRE(signature.size() == crypto_sign_BYTES, \"invalid signature\");\n\n        capnp::MallocMessageBuilder response;\n        byte appPublicKey[crypto_sign_PUBLICKEYBYTES];\n        if (indexer.tryGetPublicKey(packageId, appPublicKey)) {\n          KJ_ASSERT(\n              crypto_sign_verify_detached(signature.begin(),\n                  requestBytes.begin(), requestBytes.size(), appPublicKey) == 0,\n              \"signature validation failed\");\n\n          bool changed = false;\n          if (req.isSetState()) {\n            auto mutation = req.getSetState();\n            changed = indexer.setSubmissionState(\n                packageId, mutation.getNewState(), mutation.getSequenceNumber());\n          }\n\n          indexer.getSubmissionStatus(packageId, response);\n\n          if (changed) {\n            // Force update now!\n            indexer.updateIndex();\n          }\n        } else {\n          response.getRoot<SubmissionStatus>().setNotUploaded();\n        }\n\n        auto status = response.getRoot<SubmissionStatus>();\n        auto outBytes = kj::heapArray<byte>(\n            status.totalSize().wordCount * sizeof(capnp::word) + 128);\n        kj::ArrayOutputStream outStream(outBytes);\n        {\n          // We prefix with a NUL byte to indicate a binary response, because unfortunately the\n          // client tool uses curl with which it is excessively difficult to distinguish error\n          // responses from success. Ugh.\n          auto buffer = outStream.getWriteBuffer();\n          buffer[0] = 0;\n          outStream.write(buffer.begin(), 1);\n        }\n        capnp::writePackedMessage(outStream, response);\n\n        auto httpResponse = context.getResults().initContent();\n        httpResponse.setMimeType(\"application/octet-stream\");\n        httpResponse.initBody().setBytes(outStream.getArray());\n\n        if (!req.isSetState() ||\n            !response.getRoot<SubmissionStatus>().isPending()) {\n          return kj::READY_NOW;\n        }\n\n        // Send notification email to app index reviewers.\n        auto appTitle = indexer.getAppTitle(packageId);\n        auto notificationText = kj::str(\n            \"An app package is pending review in the app index.\\n\\n\"\n            \"https://alpha.sandstorm.io/grain/NujwEZfut8oZoSdcrFzy9p/\\n\\n\"\n            \"title: \", appTitle, \"\\n\"\n            \"packageId: \", packageIdString(req.getPackageId()), \"\\n\"\n            \"requested state: \", req.getSetState().getNewState(), \"\\n\");\n\n        return session.getPublicIdRequest().send()\n            .then([this,KJ_MVCAP(appTitle),KJ_MVCAP(notificationText)](auto&& publicId) mutable {\n          return session.getUserAddressRequest().send()\n              .then([this,KJ_MVCAP(appTitle),KJ_MVCAP(notificationText),KJ_MVCAP(publicId)]\n                    (auto&& response) mutable {\n            auto emailReq = session.sendRequest();\n            auto email = emailReq.initEmail();\n            auto from = email.initFrom();\n            from.setName(\"App Index\");\n            from.setAddress(kj::str(publicId.getPublicId(), \"@\", publicId.getHostname()));\n            auto to = email.initTo(1)[0];\n            to.setAddress(\"app-index@corp.sandstorm.io\");\n            to.setName(\"App Index Notifications\");\n            email.setSubject(kj::str(\"App index: \", appTitle));\n            email.setText(notificationText);\n            return emailReq.send().ignoreResult();\n          });\n        });\n      } else {\n        auto error = context.getResults().initClientError();\n        error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n        error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n        return kj::READY_NOW;\n      }\n    }).catch_([context](kj::Exception&& e) mutable {\n      handleError(context, kj::mv(e));\n    });\n  }",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::evalNow",
          "args": [
            "[context](kj::Exception&& e) mutable {\n      handleError(context, kj::mv(e));\n    }"
          ],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "handleError",
          "args": [
            "context",
            "kj::mv(e)"
          ],
          "line": 206
        },
        "resolved": true,
        "details": {
          "function_name": "handleError",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
          "lines": "67-71",
          "snippet": "void handleError(Context& context, kj::Exception&& e) {\n  KJ_LOG(ERROR, e);\n  auto error = context.getResults().initServerError();\n  error.setDescriptionHtml(kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\"));\n}",
          "includes": [
            "#include \"indexer.h\"",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include <sandstorm/util.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <map>",
            "#include <sodium/crypto_sign.h>",
            "#include <ctype.h>",
            "#include <errno.h>",
            "#include <dirent.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <fcntl.h>",
            "#include <stdio.h>",
            "#include <stdlib.h>",
            "#include <unistd.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/membrane.h>",
            "#include <capnp/serialize-packed.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async-io.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid handleError(Context& context, kj::Exception&& e) {\n  KJ_LOG(ERROR, e);\n  auto error = context.getResults().initServerError();\n  error.setDescriptionHtml(kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\"));\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "e"
          ],
          "line": 206
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::evalNow",
          "args": [
            "[&]() -> kj::Promise<void> {\n      auto params = context.getParams();\n      auto path = params.getPath();\n      if (path == \"upload\") {\n        auto content = params.getContent();\n        KJ_REQUIRE(!content.hasEncoding(), \"can't accept encoded (e.g. gzipped) upload\");\n\n        // Write content to upload stream: a write() followed by a done(), and a getResults().\n        auto stream = indexer.newUploadStream();\n        auto promises = kj::heapArrayBuilder<kj::Promise<void>>(3);\n        auto req1 = stream.writeRequest();\n        req1.setData(content.getContent());\n        promises.add(req1.send().then([](auto&&) {}));\n        promises.add(stream.doneRequest().send().then([](auto&&) {}));\n        promises.add(stream.getResultRequest().send().then([](auto&&) {}));\n\n        context.releaseParams();\n\n        // Return \"no content\" when getResult() completes.\n        context.initResults().initNoContent();\n        return kj::joinPromises(promises.finish());\n      } else if (path == \"status\") {\n        auto content = params.getContent();\n        KJ_REQUIRE(!content.hasEncoding(), \"POST can't be encoded (e.g. gzipped)\");\n\n        capnp::MallocMessageBuilder requestMessage;\n\n        auto origBytes = content.getContent();\n        kj::ArrayInputStream stream(origBytes);\n        requestMessage.setRoot(capnp::PackedMessageReader(stream).getRoot<SubmissionRequest>());\n\n        // Whatever is left in the input is the signature. What ever was consumed from the input is\n        // the request.\n        kj::ArrayPtr<const byte> signature = stream.tryGetReadBuffer();\n        KJ_ASSERT(signature.begin() >= origBytes.begin() && signature.end() <= origBytes.end());\n        kj::ArrayPtr<const byte> requestBytes = kj::arrayPtr(origBytes.begin(), signature.begin());\n\n        auto req = requestMessage.getRoot<SubmissionRequest>();\n\n        // TODO(security): Verify request's webkey hash. Need to know our own webkey, somehow.\n\n        auto packageId = packageIdString(req.getPackageId());\n\n        KJ_REQUIRE(signature.size() == crypto_sign_BYTES, \"invalid signature\");\n\n        capnp::MallocMessageBuilder response;\n        byte appPublicKey[crypto_sign_PUBLICKEYBYTES];\n        if (indexer.tryGetPublicKey(packageId, appPublicKey)) {\n          KJ_ASSERT(\n              crypto_sign_verify_detached(signature.begin(),\n                  requestBytes.begin(), requestBytes.size(), appPublicKey) == 0,\n              \"signature validation failed\");\n\n          bool changed = false;\n          if (req.isSetState()) {\n            auto mutation = req.getSetState();\n            changed = indexer.setSubmissionState(\n                packageId, mutation.getNewState(), mutation.getSequenceNumber());\n          }\n\n          indexer.getSubmissionStatus(packageId, response);\n\n          if (changed) {\n            // Force update now!\n            indexer.updateIndex();\n          }\n        } else {\n          response.getRoot<SubmissionStatus>().setNotUploaded();\n        }\n\n        auto status = response.getRoot<SubmissionStatus>();\n        auto outBytes = kj::heapArray<byte>(\n            status.totalSize().wordCount * sizeof(capnp::word) + 128);\n        kj::ArrayOutputStream outStream(outBytes);\n        {\n          // We prefix with a NUL byte to indicate a binary response, because unfortunately the\n          // client tool uses curl with which it is excessively difficult to distinguish error\n          // responses from success. Ugh.\n          auto buffer = outStream.getWriteBuffer();\n          buffer[0] = 0;\n          outStream.write(buffer.begin(), 1);\n        }\n        capnp::writePackedMessage(outStream, response);\n\n        auto httpResponse = context.getResults().initContent();\n        httpResponse.setMimeType(\"application/octet-stream\");\n        httpResponse.initBody().setBytes(outStream.getArray());\n\n        if (!req.isSetState() ||\n            !response.getRoot<SubmissionStatus>().isPending()) {\n          return kj::READY_NOW;\n        }\n\n        // Send notification email to app index reviewers.\n        auto appTitle = indexer.getAppTitle(packageId);\n        auto notificationText = kj::str(\n            \"An app package is pending review in the app index.\\n\\n\"\n            \"https://alpha.sandstorm.io/grain/NujwEZfut8oZoSdcrFzy9p/\\n\\n\"\n            \"title: \", appTitle, \"\\n\"\n            \"packageId: \", packageIdString(req.getPackageId()), \"\\n\"\n            \"requested state: \", req.getSetState().getNewState(), \"\\n\");\n\n        return session.getPublicIdRequest().send()\n            .then([this,KJ_MVCAP(appTitle),KJ_MVCAP(notificationText)](auto&& publicId) mutable {\n          return session.getUserAddressRequest().send()\n              .then([this,KJ_MVCAP(appTitle),KJ_MVCAP(notificationText),KJ_MVCAP(publicId)]\n                    (auto&& response) mutable {\n            auto emailReq = session.sendRequest();\n            auto email = emailReq.initEmail();\n            auto from = email.initFrom();\n            from.setName(\"App Index\");\n            from.setAddress(kj::str(publicId.getPublicId(), \"@\", publicId.getHostname()));\n            auto to = email.initTo(1)[0];\n            to.setAddress(\"app-index@corp.sandstorm.io\");\n            to.setName(\"App Index Notifications\");\n            email.setSubject(kj::str(\"App index: \", appTitle));\n            email.setText(notificationText);\n            return emailReq.send().ignoreResult();\n          });\n        });\n      } else {\n        auto error = context.getResults().initClientError();\n        error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n        error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n        return kj::READY_NOW;\n      }\n    }"
          ],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "error.setDescriptionHtml",
          "args": [
            "\"<html><body><pre>404 not found</pre></body></html>\""
          ],
          "line": 202
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "error.setStatusCode",
          "args": [
            "WebSession::Response::ClientErrorCode::NOT_FOUND"
          ],
          "line": 201
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 200
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 200
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "emailReq.send",
          "args": [],
          "line": 196
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "emailReq.send",
          "args": [],
          "line": 196
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "email.setText",
          "args": [
            "notificationText"
          ],
          "line": 195
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "email.setSubject",
          "args": [
            "kj::str(\"App index: \", appTitle)"
          ],
          "line": 194
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"App index: \"",
            "appTitle"
          ],
          "line": 194
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "to.setName",
          "args": [
            "\"App Index Notifications\""
          ],
          "line": 193
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "to.setAddress",
          "args": [
            "\"app-index@corp.sandstorm.io\""
          ],
          "line": 192
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "email.initTo",
          "args": [
            "1"
          ],
          "line": 191
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "from.setAddress",
          "args": [
            "kj::str(publicId.getPublicId(), \"@\", publicId.getHostname())"
          ],
          "line": 190
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "publicId.getPublicId()",
            "\"@\"",
            "publicId.getHostname()"
          ],
          "line": 190
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "publicId.getHostname",
          "args": [],
          "line": 190
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "publicId.getPublicId",
          "args": [],
          "line": 190
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "from.setName",
          "args": [
            "\"App Index\""
          ],
          "line": 189
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "email.initFrom",
          "args": [],
          "line": 188
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "emailReq.initEmail",
          "args": [],
          "line": 187
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "session.sendRequest",
          "args": [],
          "line": 186
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "]",
          "args": [
            "auto&& response"
          ],
          "line": 184
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_MVCAP",
          "args": [
            "publicId"
          ],
          "line": 184
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_MVCAP",
          "args": [
            "notificationText"
          ],
          "line": 184
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "session.getUserAddressRequest",
          "args": [],
          "line": 183
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "session.getUserAddressRequest",
          "args": [],
          "line": 183
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "session.getPublicIdRequest",
          "args": [
            "[this,KJ_MVCAP(appTitle),KJ_MVCAP(notificationText)](auto&& publicId"
          ],
          "line": 181
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_MVCAP",
          "args": [
            "notificationText"
          ],
          "line": 182
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "session.getPublicIdRequest",
          "args": [],
          "line": 181
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "session.getPublicIdRequest",
          "args": [],
          "line": 181
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"An app package is pending review in the app index.\\n\\n\"\n            \"https://alpha.sandstorm.io/grain/NujwEZfut8oZoSdcrFzy9p/\\n\\n\"\n            \"title: \"",
            "appTitle",
            "\"\\n\"\n            \"packageId: \"",
            "packageIdString(req.getPackageId())",
            "\"\\n\"\n            \"requested state: \"",
            "req.getSetState().getNewState()",
            "\"\\n\""
          ],
          "line": 174
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "req.getSetState",
          "args": [],
          "line": 179
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "req.getSetState",
          "args": [],
          "line": 179
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "packageIdString",
          "args": [
            "req.getPackageId()"
          ],
          "line": 178
        },
        "resolved": true,
        "details": {
          "function_name": "packageIdString",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/id-to-text.c++",
          "lines": "189-192",
          "snippet": "kj::String packageIdString(kj::ArrayPtr<const kj::byte> packageId) {\n  KJ_ASSERT(packageId.size() == PACKAGE_ID_BYTE_SIZE);\n  return hexEncode(packageId);\n}",
          "includes": [
            "#include \"util.h\"",
            "#include \"id-to-text.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include \"id-to-text.h\"\n\nkj::String packageIdString(kj::ArrayPtr<const kj::byte> packageId) {\n  KJ_ASSERT(packageId.size() == PACKAGE_ID_BYTE_SIZE);\n  return hexEncode(packageId);\n}"
        }
      },
      {
        "call_info": {
          "callee": "req.getPackageId",
          "args": [],
          "line": 178
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.getAppTitle",
          "args": [
            "packageId"
          ],
          "line": 173
        },
        "resolved": true,
        "details": {
          "function_name": "getAppTitle",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "187-191",
          "snippet": "kj::String Indexer::getAppTitle(kj::StringPtr packageId) {\n  capnp::StreamFdMessageReader message(\n      sandstorm::raiiOpen(kj::str(\"/var/packages/\", packageId, \"/metadata\"), O_RDONLY));\n  return kj::str(message.getRoot<spk::VerifiedInfo>().getTitle().getDefaultText());\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::getAppTitle(kj::StringPtr packageId) {\n    capnp::StreamFdMessageReader message(\n        sandstorm::raiiOpen(kj::str(\"/var/packages/\", packageId, \"/metadata\"), O_RDONLY));\n    return kj::str(message.getRoot<spk::VerifiedInfo>().getTitle().getDefaultText());\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "response.getRoot<SubmissionStatus>",
          "args": [],
          "line": 168
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "response.getRoot<SubmissionStatus>",
          "args": [],
          "line": 168
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "req.isSetState",
          "args": [],
          "line": 167
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "httpResponse.initBody",
          "args": [
            "outStream.getArray()"
          ],
          "line": 165
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "outStream.getArray",
          "args": [],
          "line": 165
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "httpResponse.initBody",
          "args": [],
          "line": 165
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "httpResponse.setMimeType",
          "args": [
            "\"application/octet-stream\""
          ],
          "line": 164
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 163
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 163
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::writePackedMessage",
          "args": [
            "outStream",
            "response"
          ],
          "line": 161
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "outStream.write",
          "args": [
            "buffer.begin()",
            "1"
          ],
          "line": 159
        },
        "resolved": true,
        "details": {
          "function_name": "write",
          "container": "RefcountedAsyncIoStream",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/sandstorm-http-bridge.c++",
          "lines": "914-916",
          "snippet": "kj::Promise<void> write(const void* buffer, size_t size) override {\n    return stream->write(buffer, size);\n  }",
          "includes": [
            "#include \"bridge-proxy.h\"",
            "#include \"util.h\"",
            "#include \"version.h\"",
            "#include <joyent-http/http_parser.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/sandstorm-http-bridge-internal.capnp.h>",
            "#include <sandstorm/sandstorm-http-bridge.capnp.h>",
            "#include <sandstorm/email.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <sandstorm/util.capnp.h>",
            "#include <stdio.h>",
            "#include <fcntl.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <time.h>",
            "#include <unordered_map>",
            "#include <map>",
            "#include <unistd.h>",
            "#include <arpa/inet.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/schema.h>",
            "#include <capnp/rpc.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/io.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/async-io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"bridge-proxy.h\"\n#include \"util.h\"\n#include \"version.h\"\n#include <joyent-http/http_parser.h>\n#include <sandstorm/package.capnp.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/sandstorm-http-bridge-internal.capnp.h>\n#include <sandstorm/sandstorm-http-bridge.capnp.h>\n#include <sandstorm/email.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <sandstorm/util.capnp.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <sys/wait.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <time.h>\n#include <unordered_map>\n#include <map>\n#include <unistd.h>\n#include <arpa/inet.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/schema.h>\n#include <capnp/rpc.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/io.h>\n#include <kj/async-unix.h>\n#include <kj/async-io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nRefcountedAsyncIoStream {\n  kj::Promise<void> write(const void* buffer, size_t size) override {\n      return stream->write(buffer, size);\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "buffer.begin",
          "args": [],
          "line": 159
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "outStream.getWriteBuffer",
          "args": [],
          "line": 157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapArray<byte>",
          "args": [
            "status.totalSize().wordCount * sizeof(capnp::word) + 128"
          ],
          "line": 150
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.totalSize",
          "args": [],
          "line": 151
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "response.getRoot<SubmissionStatus>",
          "args": [],
          "line": 149
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "response.getRoot<SubmissionStatus>",
          "args": [],
          "line": 146
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "response.getRoot<SubmissionStatus>",
          "args": [],
          "line": 146
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.updateIndex",
          "args": [],
          "line": 143
        },
        "resolved": true,
        "details": {
          "function_name": "updateIndex",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "416-419",
          "snippet": "void Indexer::updateIndex() {\n  updateIndexInternal(\"/var/www/apps\", false);\n  updateIndexInternal(\"/var/www/experimental\", true);\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::updateIndex() {\n    updateIndexInternal(\"/var/www/apps\", false);\n    updateIndexInternal(\"/var/www/experimental\", true);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "indexer.getSubmissionStatus",
          "args": [
            "packageId",
            "response"
          ],
          "line": 139
        },
        "resolved": true,
        "details": {
          "function_name": "getSubmissionStatus",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "172-185",
          "snippet": "void Indexer::getSubmissionStatus(kj::StringPtr packageId, capnp::MessageBuilder& output) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), output);\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::getSubmissionStatus(kj::StringPtr packageId, capnp::MessageBuilder& output) {\n    KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n    for (auto c: packageId) {\n      KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n    }\n  \n    auto packageDir = kj::str(\"/var/packages/\", packageId);\n    auto spkFile = kj::str(packageDir, \"/spk\");\n    KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n               \"no such package; try uploading it again\");\n  \n    auto statusFile = kj::str(packageDir, \"/status\");\n    capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), output);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "indexer.setSubmissionState",
          "args": [
            "packageId",
            "mutation.getNewState()",
            "mutation.getSequenceNumber()"
          ],
          "line": 135
        },
        "resolved": true,
        "details": {
          "function_name": "setSubmissionState",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "160-170",
          "snippet": "bool Indexer::setSubmissionState(kj::StringPtr packageId, SubmissionState state,\n                                 uint64_t sequence) {\n  return updatePackageStatus(packageId, [&](auto&& status) {\n    if (status.getRequestState() == state) return false;\n    KJ_REQUIRE(sequence >= status.getNextSequenceNumber(),\n               \"bad sequence number in request; replay attack?\");\n    status.setRequestState(state);\n    status.setNextSequenceNumber(sequence + 1);\n    return true;\n  });\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  bool Indexer::setSubmissionState(kj::StringPtr packageId, SubmissionState state,\n                                   uint64_t sequence) {\n    return updatePackageStatus(packageId, [&](auto&& status) {\n      if (status.getRequestState() == state) return false;\n      KJ_REQUIRE(sequence >= status.getNextSequenceNumber(),\n                 \"bad sequence number in request; replay attack?\");\n      status.setRequestState(state);\n      status.setNextSequenceNumber(sequence + 1);\n      return true;\n    });\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "mutation.getSequenceNumber",
          "args": [],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mutation.getNewState",
          "args": [],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "req.getSetState",
          "args": [],
          "line": 134
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "req.isSetState",
          "args": [],
          "line": 133
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "crypto_sign_verify_detached(signature.begin(),\n                  requestBytes.begin(), requestBytes.size(), appPublicKey) == 0",
            "\"signature validation failed\""
          ],
          "line": 127
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "crypto_sign_verify_detached",
          "args": [
            "signature.begin()",
            "requestBytes.begin()",
            "requestBytes.size()",
            "appPublicKey"
          ],
          "line": 128
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "requestBytes.size",
          "args": [],
          "line": 129
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "requestBytes.begin",
          "args": [],
          "line": 129
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signature.begin",
          "args": [],
          "line": 128
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.tryGetPublicKey",
          "args": [
            "packageId",
            "appPublicKey"
          ],
          "line": 126
        },
        "resolved": true,
        "details": {
          "function_name": "tryGetPublicKey",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "78-106",
          "snippet": "bool Indexer::tryGetPublicKey(kj::StringPtr packageId, byte publicKey[crypto_sign_PUBLICKEYBYTES]) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n\n  while (access(spkFile.cStr(), F_OK) < 0) {\n    int error = errno;\n    if (error == ENOENT) {\n      return false;\n    } else if (error != EINTR) {\n      KJ_FAIL_SYSCALL(\"access(spkFile, F_OK)\", error, spkFile);\n    }\n  }\n\n  auto infoFile = kj::str(packageDir, \"/metadata\");\n  capnp::StreamFdMessageReader infoMessage(raiiOpen(infoFile, O_RDONLY));\n\n  auto bytes = capnp::AnyStruct::Reader(\n      infoMessage.getRoot<spk::VerifiedInfo>().getAppId()).getDataSection();\n  KJ_ASSERT(bytes.size() == crypto_sign_PUBLICKEYBYTES);\n  static_assert(crypto_sign_PUBLICKEYBYTES == APP_ID_BYTE_SIZE, \"app ID size changed?\");\n  memcpy(publicKey, sandstorm::getPublicKeyForApp(bytes).begin(), crypto_sign_PUBLICKEYBYTES);\n\n  return true;\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  bool Indexer::tryGetPublicKey(kj::StringPtr packageId, byte publicKey[crypto_sign_PUBLICKEYBYTES]) {\n    KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n    for (auto c: packageId) {\n      KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n    }\n  \n    auto packageDir = kj::str(\"/var/packages/\", packageId);\n    auto spkFile = kj::str(packageDir, \"/spk\");\n  \n    while (access(spkFile.cStr(), F_OK) < 0) {\n      int error = errno;\n      if (error == ENOENT) {\n        return false;\n      } else if (error != EINTR) {\n        KJ_FAIL_SYSCALL(\"access(spkFile, F_OK)\", error, spkFile);\n      }\n    }\n  \n    auto infoFile = kj::str(packageDir, \"/metadata\");\n    capnp::StreamFdMessageReader infoMessage(raiiOpen(infoFile, O_RDONLY));\n  \n    auto bytes = capnp::AnyStruct::Reader(\n        infoMessage.getRoot<spk::VerifiedInfo>().getAppId()).getDataSection();\n    KJ_ASSERT(bytes.size() == crypto_sign_PUBLICKEYBYTES);\n    static_assert(crypto_sign_PUBLICKEYBYTES == APP_ID_BYTE_SIZE, \"app ID size changed?\");\n    memcpy(publicKey, sandstorm::getPublicKeyForApp(bytes).begin(), crypto_sign_PUBLICKEYBYTES);\n  \n    return true;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "signature.size() == crypto_sign_BYTES",
            "\"invalid signature\""
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "req.getPackageId",
          "args": [],
          "line": 120
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "requestMessage.getRoot<SubmissionRequest>",
          "args": [],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::arrayPtr",
          "args": [
            "origBytes.begin()",
            "signature.begin()"
          ],
          "line": 114
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signature.begin",
          "args": [],
          "line": 114
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "origBytes.begin",
          "args": [],
          "line": 114
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "signature.begin() >= origBytes.begin() && signature.end() <= origBytes.end()"
          ],
          "line": 113
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "origBytes.end",
          "args": [],
          "line": 113
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signature.end",
          "args": [],
          "line": 113
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "origBytes.begin",
          "args": [],
          "line": 113
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signature.begin",
          "args": [],
          "line": 113
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stream.tryGetReadBuffer",
          "args": [],
          "line": 112
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "requestMessage.setRoot",
          "args": [
            "capnp::PackedMessageReader(stream).getRoot<SubmissionRequest>()"
          ],
          "line": 108
        },
        "resolved": true,
        "details": {
          "function_name": "setRoot",
          "container": "BackupMain",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/backup.c++",
          "lines": "66-69",
          "snippet": "bool BackupMain::setRoot(kj::StringPtr arg) {\n  root = arg;\n  return true;\n}",
          "includes": [
            "#include <sys/capability.h>",
            "#include <sys/prctl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <sys/syscall.h>",
            "#include <sys/mount.h>",
            "#include <sched.h>",
            "#include <kj/debug.h>",
            "#include \"version.h\"",
            "#include \"util.h\"",
            "#include \"backup.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/capability.h>\n#include <sys/prctl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <sys/syscall.h>\n#include <sys/mount.h>\n#include <sched.h>\n#include <kj/debug.h>\n#include \"version.h\"\n#include \"util.h\"\n#include \"backup.h\"\n\nBackupMain {\n  bool BackupMain::setRoot(kj::StringPtr arg) {\n    root = arg;\n    return true;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "capnp::PackedMessageReader",
          "args": [],
          "line": 108
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::PackedMessageReader",
          "args": [
            "stream"
          ],
          "line": 108
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.getContent",
          "args": [],
          "line": 106
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "!content.hasEncoding()",
            "\"POST can't be encoded (e.g. gzipped)\""
          ],
          "line": 102
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.hasEncoding",
          "args": [],
          "line": 102
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContent",
          "args": [],
          "line": 101
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::joinPromises",
          "args": [
            "promises.finish()"
          ],
          "line": 99
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "promises.finish",
          "args": [],
          "line": 99
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.initResults",
          "args": [],
          "line": 98
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.initResults",
          "args": [],
          "line": 98
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.releaseParams",
          "args": [],
          "line": 95
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "promises.add",
          "args": [
            "stream.getResultRequest().send().then([](auto&&) {})"
          ],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stream.getResultRequest",
          "args": [
            "[](auto&&) {}"
          ],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stream.getResultRequest",
          "args": [],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stream.getResultRequest",
          "args": [],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "promises.add",
          "args": [
            "stream.doneRequest().send().then([](auto&&) {})"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stream.doneRequest",
          "args": [
            "[](auto&&) {}"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stream.doneRequest",
          "args": [],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stream.doneRequest",
          "args": [],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "promises.add",
          "args": [
            "req1.send().then([](auto&&) {})"
          ],
          "line": 91
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "req1.send",
          "args": [
            "[](auto&&) {}"
          ],
          "line": 91
        },
        "resolved": true,
        "details": {
          "function_name": "send",
          "container": "EmailSessionImpl",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/sandstorm-http-bridge.c++",
          "lines": "1885-1944",
          "snippet": "kj::Promise<void> send(SendContext context) override {\n    // We're receiving an e-mail. We place the message in maildir format under /var/mail.\n\n    auto email = context.getParams().getEmail();\n    auto id = genRandomString();\n\n    // TODO(perf): The following does a lot more copying than necessary.\n\n    // Construct the mail file.\n    kj::Vector<kj::String> lines;\n\n    addDateHeader(lines, email.getDate());\n\n    addHeader(lines, \"To\", email.getTo());\n    addHeader(lines, \"From\", email.getFrom());\n    addHeader(lines, \"Reply-To\", email.getReplyTo());\n    addHeader(lines, \"CC\", email.getCc());\n    addHeader(lines, \"BCC\", email.getBcc());\n    addHeader(lines, \"Subject\", email.getSubject());\n\n    addHeader(lines, \"Message-Id\", email.getMessageId());\n    addHeader(lines, \"References\", email.getReferences());\n    addHeader(lines, \"In-Reply-To\", email.getInReplyTo());\n\n    addHeader(lines, \"Content-Type\",\n        kj::str(\"multipart/alternative; boundary=\", id));\n\n    lines.add(nullptr);  // blank line starts body.\n\n    if (email.hasText()) {\n      lines.add(kj::str(\"--\", id));\n      addHeader(lines, \"Content-Type\", kj::str(\"text/plain; charset=UTF-8\"));\n      lines.add(nullptr);\n      lines.add(kj::str(email.getText()));\n    }\n    if (email.hasHtml()) {\n      lines.add(kj::str(\"--\", id));\n      addHeader(lines, \"Content-Type\", kj::str(\"text/html; charset=UTF-8\"));\n      lines.add(nullptr);\n      lines.add(kj::str(email.getHtml()));\n    }\n    for (auto attachment : email.getAttachments()) {\n      addAttachment(lines, id, attachment);\n    }\n    lines.add(kj::str(\"--\", id, \"--\"));\n\n    lines.add(nullptr);\n    auto text = kj::strArray(lines, \"\\n\");\n\n    // Write to temp file. Prefix name with _ in case `id` starts with '.'.\n    auto tmpFilename = kj::str(\"/var/mail/tmp/_\", id);\n    auto mailFd = raiiOpen(tmpFilename, O_WRONLY | O_CREAT | O_EXCL);\n    kj::FdOutputStream((int)mailFd).write(text.begin(), text.size());\n    mailFd = nullptr;\n\n    // Move to final location.\n    KJ_SYSCALL(rename(tmpFilename.cStr(), kj::str(\"/var/mail/new/_\", id).cStr()));\n\n    return kj::READY_NOW;\n  }",
          "includes": [
            "#include \"bridge-proxy.h\"",
            "#include \"util.h\"",
            "#include \"version.h\"",
            "#include <joyent-http/http_parser.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/sandstorm-http-bridge-internal.capnp.h>",
            "#include <sandstorm/sandstorm-http-bridge.capnp.h>",
            "#include <sandstorm/email.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <sandstorm/util.capnp.h>",
            "#include <stdio.h>",
            "#include <fcntl.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <time.h>",
            "#include <unordered_map>",
            "#include <map>",
            "#include <unistd.h>",
            "#include <arpa/inet.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/schema.h>",
            "#include <capnp/rpc.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/io.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/async-io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"bridge-proxy.h\"\n#include \"util.h\"\n#include \"version.h\"\n#include <joyent-http/http_parser.h>\n#include <sandstorm/package.capnp.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/sandstorm-http-bridge-internal.capnp.h>\n#include <sandstorm/sandstorm-http-bridge.capnp.h>\n#include <sandstorm/email.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <sandstorm/util.capnp.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <sys/wait.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <time.h>\n#include <unordered_map>\n#include <map>\n#include <unistd.h>\n#include <arpa/inet.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/schema.h>\n#include <capnp/rpc.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/io.h>\n#include <kj/async-unix.h>\n#include <kj/async-io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nEmailSessionImpl {\n  kj::Promise<void> send(SendContext context) override {\n      // We're receiving an e-mail. We place the message in maildir format under /var/mail.\n  \n      auto email = context.getParams().getEmail();\n      auto id = genRandomString();\n  \n      // TODO(perf): The following does a lot more copying than necessary.\n  \n      // Construct the mail file.\n      kj::Vector<kj::String> lines;\n  \n      addDateHeader(lines, email.getDate());\n  \n      addHeader(lines, \"To\", email.getTo());\n      addHeader(lines, \"From\", email.getFrom());\n      addHeader(lines, \"Reply-To\", email.getReplyTo());\n      addHeader(lines, \"CC\", email.getCc());\n      addHeader(lines, \"BCC\", email.getBcc());\n      addHeader(lines, \"Subject\", email.getSubject());\n  \n      addHeader(lines, \"Message-Id\", email.getMessageId());\n      addHeader(lines, \"References\", email.getReferences());\n      addHeader(lines, \"In-Reply-To\", email.getInReplyTo());\n  \n      addHeader(lines, \"Content-Type\",\n          kj::str(\"multipart/alternative; boundary=\", id));\n  \n      lines.add(nullptr);  // blank line starts body.\n  \n      if (email.hasText()) {\n        lines.add(kj::str(\"--\", id));\n        addHeader(lines, \"Content-Type\", kj::str(\"text/plain; charset=UTF-8\"));\n        lines.add(nullptr);\n        lines.add(kj::str(email.getText()));\n      }\n      if (email.hasHtml()) {\n        lines.add(kj::str(\"--\", id));\n        addHeader(lines, \"Content-Type\", kj::str(\"text/html; charset=UTF-8\"));\n        lines.add(nullptr);\n        lines.add(kj::str(email.getHtml()));\n      }\n      for (auto attachment : email.getAttachments()) {\n        addAttachment(lines, id, attachment);\n      }\n      lines.add(kj::str(\"--\", id, \"--\"));\n  \n      lines.add(nullptr);\n      auto text = kj::strArray(lines, \"\\n\");\n  \n      // Write to temp file. Prefix name with _ in case `id` starts with '.'.\n      auto tmpFilename = kj::str(\"/var/mail/tmp/_\", id);\n      auto mailFd = raiiOpen(tmpFilename, O_WRONLY | O_CREAT | O_EXCL);\n      kj::FdOutputStream((int)mailFd).write(text.begin(), text.size());\n      mailFd = nullptr;\n  \n      // Move to final location.\n      KJ_SYSCALL(rename(tmpFilename.cStr(), kj::str(\"/var/mail/new/_\", id).cStr()));\n  \n      return kj::READY_NOW;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "req1.send",
          "args": [],
          "line": 91
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "req1.setData",
          "args": [
            "content.getContent()"
          ],
          "line": 90
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.getContent",
          "args": [],
          "line": 90
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stream.writeRequest",
          "args": [],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapArrayBuilder<kj::Promise<void>>",
          "args": [
            "3"
          ],
          "line": 88
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexer.newUploadStream",
          "args": [],
          "line": 87
        },
        "resolved": true,
        "details": {
          "function_name": "newUploadStream",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "615-617",
          "snippet": "AppIndex::UploadStream::Client Indexer::newUploadStream() {\n  return kj::heap<UploadStreamImpl>();\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  AppIndex::UploadStream::Client Indexer::newUploadStream() {\n    return kj::heap<UploadStreamImpl>();\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "!content.hasEncoding()",
            "\"can't accept encoded (e.g. gzipped) upload\""
          ],
          "line": 84
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "content.hasEncoding",
          "args": [],
          "line": 84
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getContent",
          "args": [],
          "line": 83
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "params.getPath",
          "args": [],
          "line": 81
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getParams",
          "args": [],
          "line": 80
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nSubmissionSession {\n  kj::Promise<void> post(PostContext context) override {\n      return kj::evalNow([&]() -> kj::Promise<void> {\n        auto params = context.getParams();\n        auto path = params.getPath();\n        if (path == \"upload\") {\n          auto content = params.getContent();\n          KJ_REQUIRE(!content.hasEncoding(), \"can't accept encoded (e.g. gzipped) upload\");\n  \n          // Write content to upload stream: a write() followed by a done(), and a getResults().\n          auto stream = indexer.newUploadStream();\n          auto promises = kj::heapArrayBuilder<kj::Promise<void>>(3);\n          auto req1 = stream.writeRequest();\n          req1.setData(content.getContent());\n          promises.add(req1.send().then([](auto&&) {}));\n          promises.add(stream.doneRequest().send().then([](auto&&) {}));\n          promises.add(stream.getResultRequest().send().then([](auto&&) {}));\n  \n          context.releaseParams();\n  \n          // Return \"no content\" when getResult() completes.\n          context.initResults().initNoContent();\n          return kj::joinPromises(promises.finish());\n        } else if (path == \"status\") {\n          auto content = params.getContent();\n          KJ_REQUIRE(!content.hasEncoding(), \"POST can't be encoded (e.g. gzipped)\");\n  \n          capnp::MallocMessageBuilder requestMessage;\n  \n          auto origBytes = content.getContent();\n          kj::ArrayInputStream stream(origBytes);\n          requestMessage.setRoot(capnp::PackedMessageReader(stream).getRoot<SubmissionRequest>());\n  \n          // Whatever is left in the input is the signature. What ever was consumed from the input is\n          // the request.\n          kj::ArrayPtr<const byte> signature = stream.tryGetReadBuffer();\n          KJ_ASSERT(signature.begin() >= origBytes.begin() && signature.end() <= origBytes.end());\n          kj::ArrayPtr<const byte> requestBytes = kj::arrayPtr(origBytes.begin(), signature.begin());\n  \n          auto req = requestMessage.getRoot<SubmissionRequest>();\n  \n          // TODO(security): Verify request's webkey hash. Need to know our own webkey, somehow.\n  \n          auto packageId = packageIdString(req.getPackageId());\n  \n          KJ_REQUIRE(signature.size() == crypto_sign_BYTES, \"invalid signature\");\n  \n          capnp::MallocMessageBuilder response;\n          byte appPublicKey[crypto_sign_PUBLICKEYBYTES];\n          if (indexer.tryGetPublicKey(packageId, appPublicKey)) {\n            KJ_ASSERT(\n                crypto_sign_verify_detached(signature.begin(),\n                    requestBytes.begin(), requestBytes.size(), appPublicKey) == 0,\n                \"signature validation failed\");\n  \n            bool changed = false;\n            if (req.isSetState()) {\n              auto mutation = req.getSetState();\n              changed = indexer.setSubmissionState(\n                  packageId, mutation.getNewState(), mutation.getSequenceNumber());\n            }\n  \n            indexer.getSubmissionStatus(packageId, response);\n  \n            if (changed) {\n              // Force update now!\n              indexer.updateIndex();\n            }\n          } else {\n            response.getRoot<SubmissionStatus>().setNotUploaded();\n          }\n  \n          auto status = response.getRoot<SubmissionStatus>();\n          auto outBytes = kj::heapArray<byte>(\n              status.totalSize().wordCount * sizeof(capnp::word) + 128);\n          kj::ArrayOutputStream outStream(outBytes);\n          {\n            // We prefix with a NUL byte to indicate a binary response, because unfortunately the\n            // client tool uses curl with which it is excessively difficult to distinguish error\n            // responses from success. Ugh.\n            auto buffer = outStream.getWriteBuffer();\n            buffer[0] = 0;\n            outStream.write(buffer.begin(), 1);\n          }\n          capnp::writePackedMessage(outStream, response);\n  \n          auto httpResponse = context.getResults().initContent();\n          httpResponse.setMimeType(\"application/octet-stream\");\n          httpResponse.initBody().setBytes(outStream.getArray());\n  \n          if (!req.isSetState() ||\n              !response.getRoot<SubmissionStatus>().isPending()) {\n            return kj::READY_NOW;\n          }\n  \n          // Send notification email to app index reviewers.\n          auto appTitle = indexer.getAppTitle(packageId);\n          auto notificationText = kj::str(\n              \"An app package is pending review in the app index.\\n\\n\"\n              \"https://alpha.sandstorm.io/grain/NujwEZfut8oZoSdcrFzy9p/\\n\\n\"\n              \"title: \", appTitle, \"\\n\"\n              \"packageId: \", packageIdString(req.getPackageId()), \"\\n\"\n              \"requested state: \", req.getSetState().getNewState(), \"\\n\");\n  \n          return session.getPublicIdRequest().send()\n              .then([this,KJ_MVCAP(appTitle),KJ_MVCAP(notificationText)](auto&& publicId) mutable {\n            return session.getUserAddressRequest().send()\n                .then([this,KJ_MVCAP(appTitle),KJ_MVCAP(notificationText),KJ_MVCAP(publicId)]\n                      (auto&& response) mutable {\n              auto emailReq = session.sendRequest();\n              auto email = emailReq.initEmail();\n              auto from = email.initFrom();\n              from.setName(\"App Index\");\n              from.setAddress(kj::str(publicId.getPublicId(), \"@\", publicId.getHostname()));\n              auto to = email.initTo(1)[0];\n              to.setAddress(\"app-index@corp.sandstorm.io\");\n              to.setName(\"App Index Notifications\");\n              email.setSubject(kj::str(\"App index: \", appTitle));\n              email.setText(notificationText);\n              return emailReq.send().ignoreResult();\n            });\n          });\n        } else {\n          auto error = context.getResults().initClientError();\n          error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n          error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n          return kj::READY_NOW;\n        }\n      }).catch_([context](kj::Exception&& e) mutable {\n        handleError(context, kj::mv(e));\n      });\n    }\n}"
  },
  {
    "function_name": "SubmissionSession",
    "container": "SubmissionSession",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "75-76",
    "snippet": "explicit SubmissionSession(Indexer& indexer, HackSessionContext::Client session)\n      : indexer(indexer), session(kj::mv(session)) {}",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "session"
          ],
          "line": 76
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nSubmissionSession {\n  explicit SubmissionSession(Indexer& indexer, HackSessionContext::Client session)\n        : indexer(indexer), session(kj::mv(session)) {}\n}"
  },
  {
    "function_name": "handleError",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "67-71",
    "snippet": "void handleError(Context& context, kj::Exception&& e) {\n  KJ_LOG(ERROR, e);\n  auto error = context.getResults().initServerError();\n  error.setDescriptionHtml(kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\"));\n}",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "error.setDescriptionHtml",
          "args": [
            "kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\")"
          ],
          "line": 70
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Error: \"",
            "htmlEscape(e.getDescription())",
            "\"\\n\""
          ],
          "line": 70
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "htmlEscape",
          "args": [
            "e.getDescription()"
          ],
          "line": 70
        },
        "resolved": true,
        "details": {
          "function_name": "htmlEscape",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
          "lines": "52-64",
          "snippet": "kj::String htmlEscape(kj::StringPtr text) {\n  kj::Vector<char> result(text.size() + 1);\n  for (char c: text) {\n    switch (c) {\n      case '<': result.addAll(kj::StringPtr(\"&lt;\")); break;\n      case '>': result.addAll(kj::StringPtr(\"&gt;\")); break;\n      case '&': result.addAll(kj::StringPtr(\"&amp;\")); break;\n      default: result.add(c); break;\n    }\n  }\n  result.add('\\0');\n  return kj::String(result.releaseAsArray());\n}",
          "includes": [
            "#include \"indexer.h\"",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include <sandstorm/util.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <map>",
            "#include <sodium/crypto_sign.h>",
            "#include <ctype.h>",
            "#include <errno.h>",
            "#include <dirent.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <fcntl.h>",
            "#include <stdio.h>",
            "#include <stdlib.h>",
            "#include <unistd.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/membrane.h>",
            "#include <capnp/serialize-packed.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async-io.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::String htmlEscape(kj::StringPtr text) {\n  kj::Vector<char> result(text.size() + 1);\n  for (char c: text) {\n    switch (c) {\n      case '<': result.addAll(kj::StringPtr(\"&lt;\")); break;\n      case '>': result.addAll(kj::StringPtr(\"&gt;\")); break;\n      case '&': result.addAll(kj::StringPtr(\"&amp;\")); break;\n      default: result.add(c); break;\n    }\n  }\n  result.add('\\0');\n  return kj::String(result.releaseAsArray());\n}"
        }
      },
      {
        "call_info": {
          "callee": "e.getDescription",
          "args": [],
          "line": 70
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 69
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [],
          "line": 69
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_LOG",
          "args": [
            "ERROR",
            "e"
          ],
          "line": 68
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid handleError(Context& context, kj::Exception&& e) {\n  KJ_LOG(ERROR, e);\n  auto error = context.getResults().initServerError();\n  error.setDescriptionHtml(kj::str(\"Error: \", htmlEscape(e.getDescription()), \"\\n\"));\n}"
  },
  {
    "function_name": "htmlEscape",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
    "lines": "52-64",
    "snippet": "kj::String htmlEscape(kj::StringPtr text) {\n  kj::Vector<char> result(text.size() + 1);\n  for (char c: text) {\n    switch (c) {\n      case '<': result.addAll(kj::StringPtr(\"&lt;\")); break;\n      case '>': result.addAll(kj::StringPtr(\"&gt;\")); break;\n      case '&': result.addAll(kj::StringPtr(\"&amp;\")); break;\n      default: result.add(c); break;\n    }\n  }\n  result.add('\\0');\n  return kj::String(result.releaseAsArray());\n}",
    "includes": [
      "#include \"indexer.h\"",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include <sandstorm/util.h>",
      "#include <sandstorm/hack-session.capnp.h>",
      "#include <sandstorm/api-session.capnp.h>",
      "#include <sandstorm/web-session.capnp.h>",
      "#include <sandstorm/grain.capnp.h>",
      "#include <map>",
      "#include <sodium/crypto_sign.h>",
      "#include <ctype.h>",
      "#include <errno.h>",
      "#include <dirent.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <fcntl.h>",
      "#include <stdio.h>",
      "#include <stdlib.h>",
      "#include <unistd.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/membrane.h>",
      "#include <capnp/serialize-packed.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/rpc-twoparty.h>",
      "#include <kj/async-io.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::String",
          "args": [
            "result.releaseAsArray()"
          ],
          "line": 63
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "result.releaseAsArray",
          "args": [],
          "line": 63
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "result.add",
          "args": [
            "'\\0'"
          ],
          "line": 62
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "result.add",
          "args": [
            "c"
          ],
          "line": 59
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "result.addAll",
          "args": [
            "kj::StringPtr(\"&amp;\")"
          ],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::StringPtr",
          "args": [
            "\"&amp;\""
          ],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "result.addAll",
          "args": [
            "kj::StringPtr(\"&gt;\")"
          ],
          "line": 57
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::StringPtr",
          "args": [
            "\"&gt;\""
          ],
          "line": 57
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "result.addAll",
          "args": [
            "kj::StringPtr(\"&lt;\")"
          ],
          "line": 56
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::StringPtr",
          "args": [
            "\"&lt;\""
          ],
          "line": 56
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "text.size",
          "args": [],
          "line": 53
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::String htmlEscape(kj::StringPtr text) {\n  kj::Vector<char> result(text.size() + 1);\n  for (char c: text) {\n    switch (c) {\n      case '<': result.addAll(kj::StringPtr(\"&lt;\")); break;\n      case '>': result.addAll(kj::StringPtr(\"&gt;\")); break;\n      case '&': result.addAll(kj::StringPtr(\"&amp;\")); break;\n      default: result.add(c); break;\n    }\n  }\n  result.add('\\0');\n  return kj::String(result.releaseAsArray());\n}"
  }
]