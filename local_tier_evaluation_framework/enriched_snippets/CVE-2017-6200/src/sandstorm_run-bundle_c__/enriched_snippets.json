[
  {
    "function_name": "setUpdateFile",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2995-3020",
    "snippet": "kj::MainBuilder::Validity setUpdateFile(kj::StringPtr arg) {\n    // If the parameter consists only of lower-case letters, treat it as a channel name,\n    // otherwise treat it as a file name. Any reasonable update file should end in .tar.xz\n    // and therefore not be all letters.\n    bool isFile = false;\n    for (char c: arg) {\n      if (c < 'a' || c > 'z') {\n        isFile = true;\n        break;\n      }\n    }\n\n    updateFileIsChannel = !isFile;\n\n    if (isFile && access(arg.cStr(), F_OK) < 0) {\n      return \"file not found\";\n    } else if (isFile && !arg.startsWith(\"/\")) {\n      char absoluteNameBuf[PATH_MAX + 1];\n      KJ_SYSCALL(realpath(arg.cStr(), absoluteNameBuf));\n      updateFile = kj::heapString(absoluteNameBuf);\n      return true;\n    } else {\n      updateFile = kj::heapString(arg);\n      return true;\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "kj::String updateFile;",
      "bool updateFileIsChannel = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "arg"
          ],
          "line": 3017
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "absoluteNameBuf"
          ],
          "line": 3014
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "realpath(arg.cStr(), absoluteNameBuf)"
          ],
          "line": 3013
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "realpath",
          "args": [
            "arg.cStr()",
            "absoluteNameBuf"
          ],
          "line": 3013
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "arg.cStr",
          "args": [],
          "line": 3013
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "arg.startsWith",
          "args": [
            "\"/\""
          ],
          "line": 3011
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "arg.cStr()",
            "F_OK"
          ],
          "line": 3009
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "arg.cStr",
          "args": [],
          "line": 3009
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::String updateFile;\nbool updateFileIsChannel = false;\n\nkj::MainBuilder::Validity setUpdateFile(kj::StringPtr arg) {\n    // If the parameter consists only of lower-case letters, treat it as a channel name,\n    // otherwise treat it as a file name. Any reasonable update file should end in .tar.xz\n    // and therefore not be all letters.\n    bool isFile = false;\n    for (char c: arg) {\n      if (c < 'a' || c > 'z') {\n        isFile = true;\n        break;\n      }\n    }\n\n    updateFileIsChannel = !isFile;\n\n    if (isFile && access(arg.cStr(), F_OK) < 0) {\n      return \"file not found\";\n    } else if (isFile && !arg.startsWith(\"/\")) {\n      char absoluteNameBuf[PATH_MAX + 1];\n      KJ_SYSCALL(realpath(arg.cStr(), absoluteNameBuf));\n      updateFile = kj::heapString(absoluteNameBuf);\n      return true;\n    } else {\n      updateFile = kj::heapString(arg);\n      return true;\n    }\n  }"
  },
  {
    "function_name": "execMongoClient",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2954-2991",
    "snippet": "[[noreturn]] void execMongoClient(const Config& config,\n        std::initializer_list<kj::StringPtr> optionArgs,\n        std::initializer_list<kj::StringPtr> fileArgs,\n        kj::StringPtr dbName = \"meteor\") {\n    auto db = kj::str(\"127.0.0.1:\", config.mongoPort, \"/\", dbName);\n\n    kj::Vector<const char*> args;\n    args.add(\"/bin/mongo\");\n\n    // If /var/mongo/passwd exists, we interpret it as containing the password for a Mongo user\n    // \"sandstorm\", and assume we are expected to log in as this user.\n    kj::String passwordArg;\n    if (access(\"/var/mongo/passwd\", F_OK) == 0) {\n      passwordArg = kj::str(\"--password=\", trim(readAll(raiiOpen(\"/var/mongo/passwd\", O_RDONLY))));\n\n      args.add(\"-u\");\n      args.add(\"sandstorm\");\n      args.add(passwordArg.cStr());\n      args.add(\"--authenticationDatabase\");\n      args.add(\"admin\");\n    }\n\n    for (auto& arg: optionArgs) {\n      args.add(arg.cStr());\n    }\n\n    args.add(db.cStr());\n\n    for (auto& arg: fileArgs) {\n      args.add(arg.cStr());\n    }\n\n    args.add(nullptr);\n\n    // OK, run the Mongo client!\n    KJ_SYSCALL(execv(args[0], const_cast<char**>(args.begin())));\n    KJ_UNREACHABLE;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "execv(args[0], const_cast<char**>(args.begin()))"
          ],
          "line": 2989
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "execv",
          "args": [
            "args[0]",
            "const_cast<char**>(args.begin())"
          ],
          "line": 2989
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "const_cast<char**>",
          "args": [
            "args.begin()"
          ],
          "line": 2989
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.begin",
          "args": [],
          "line": 2989
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "nullptr"
          ],
          "line": 2986
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "arg.cStr()"
          ],
          "line": 2983
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "arg.cStr",
          "args": [],
          "line": 2983
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "db.cStr()"
          ],
          "line": 2980
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db.cStr",
          "args": [],
          "line": 2980
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "arg.cStr()"
          ],
          "line": 2977
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "arg.cStr",
          "args": [],
          "line": 2977
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "\"admin\""
          ],
          "line": 2973
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "\"--authenticationDatabase\""
          ],
          "line": 2972
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "passwordArg.cStr()"
          ],
          "line": 2971
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "passwordArg.cStr",
          "args": [],
          "line": 2971
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "\"sandstorm\""
          ],
          "line": 2970
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "\"-u\""
          ],
          "line": 2969
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"--password=\"",
            "trim(readAll(raiiOpen(\"/var/mongo/passwd\", O_RDONLY)))"
          ],
          "line": 2967
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "trim",
          "args": [
            "readAll(raiiOpen(\"/var/mongo/passwd\", O_RDONLY))"
          ],
          "line": 2967
        },
        "resolved": true,
        "details": {
          "function_name": "trim",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "202-204",
          "snippet": "kj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}"
        }
      },
      {
        "call_info": {
          "callee": "readAll",
          "args": [
            "raiiOpen(\"/var/mongo/passwd\", O_RDONLY)"
          ],
          "line": 2967
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"/var/mongo/passwd\"",
            "O_RDONLY"
          ],
          "line": 2967
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"/var/mongo/passwd\"",
            "F_OK"
          ],
          "line": 2966
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "\"/bin/mongo\""
          ],
          "line": 2961
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"127.0.0.1:\"",
            "config.mongoPort",
            "\"/\"",
            "dbName"
          ],
          "line": 2958
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\n[[noreturn]] void execMongoClient(const Config& config,\n        std::initializer_list<kj::StringPtr> optionArgs,\n        std::initializer_list<kj::StringPtr> fileArgs,\n        kj::StringPtr dbName = \"meteor\") {\n    auto db = kj::str(\"127.0.0.1:\", config.mongoPort, \"/\", dbName);\n\n    kj::Vector<const char*> args;\n    args.add(\"/bin/mongo\");\n\n    // If /var/mongo/passwd exists, we interpret it as containing the password for a Mongo user\n    // \"sandstorm\", and assume we are expected to log in as this user.\n    kj::String passwordArg;\n    if (access(\"/var/mongo/passwd\", F_OK) == 0) {\n      passwordArg = kj::str(\"--password=\", trim(readAll(raiiOpen(\"/var/mongo/passwd\", O_RDONLY))));\n\n      args.add(\"-u\");\n      args.add(\"sandstorm\");\n      args.add(passwordArg.cStr());\n      args.add(\"--authenticationDatabase\");\n      args.add(\"admin\");\n    }\n\n    for (auto& arg: optionArgs) {\n      args.add(arg.cStr());\n    }\n\n    args.add(db.cStr());\n\n    for (auto& arg: fileArgs) {\n      args.add(arg.cStr());\n    }\n\n    args.add(nullptr);\n\n    // OK, run the Mongo client!\n    KJ_SYSCALL(execv(args[0], const_cast<char**>(args.begin())));\n    KJ_UNREACHABLE;\n  }"
  },
  {
    "function_name": "mongoCommand",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2929-2952",
    "snippet": "void mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool runningAsRoot = getuid() == 0;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "process.waitForSuccess",
          "args": [],
          "line": 2951
        },
        "resolved": true,
        "details": {
          "function_name": "waitForSuccess",
          "container": "Subprocess",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "993-996",
          "snippet": "void Subprocess::waitForSuccess() {\n  int exitCode = waitForExit();\n  KJ_ASSERT(exitCode == 0, \"child process failed\", name, exitCode);\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nSubprocess {\n  void Subprocess::waitForSuccess() {\n    int exitCode = waitForExit();\n    KJ_ASSERT(exitCode == 0, \"child process failed\", name, exitCode);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "execMongoClient",
          "args": [
            "config",
            "{\"--quiet\"}",
            "{commandFile}",
            "db"
          ],
          "line": 2948
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dropPrivs",
          "args": [
            "config.uids"
          ],
          "line": 2946
        },
        "resolved": true,
        "details": {
          "function_name": "dropPrivs",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1451-1497",
          "snippet": "void dropPrivs(const UserIds& uids, bool keepRealUid = false) {\n    // Defense in depth: Don't give my children any new caps for any reason.\n    KJ_SYSCALL(prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0));\n\n    if (runningAsRoot) {\n      KJ_SYSCALL(setresgid(uids.gid, uids.gid, uids.gid));\n      KJ_SYSCALL(setgroups(uids.groups.size(), uids.groups.begin()));\n\n      if (keepRealUid) {\n        // We're prepping to run the backend and user namespaces are not available, therefore the\n        // backend needs to keep its superuser powers stashed in order to hand them off to the\n        // grain supervisors so that they can set up sandboxes. Instead of creating a suid binary\n        // (with all the danger that entails), we merely drop the effective UID, but raise it again\n        // when invoking the supervisor.\n        KJ_SYSCALL(seteuid(uids.uid));\n      } else {\n        KJ_SYSCALL(setresuid(uids.uid, uids.uid, uids.uid));\n      }\n    } else {\n      // We're using UID namespaces.\n\n      KJ_ASSERT(!keepRealUid);\n\n      // Defense in depth: Drop all capabilities from the set of caps which my children are allowed\n      //   to ever have.\n      for (uint cap: kj::range(0, CAP_LAST_CAP + 1)) {\n        // TODO(soon): I spontaneously started getting EINVAL here, but only in production, so I\n        //   had to remove the error check. Figure out what happened and re-enable it. Maybe it\n        //   makes sense to read the bset first and then only drop the caps in it?\n        prctl(PR_CAPBSET_DROP, cap, 0, 0, 0);\n      }\n\n      // Defense in depth: Don't grant my children capabilities just because they have UID 0.\n      KJ_SYSCALL(prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED));\n\n      // Drop all Linux \"capabilities\".  (These are Linux/POSIX \"capabilities\", which are not true\n      // object-capabilities, hence the quotes.)\n      struct __user_cap_header_struct hdr;\n      struct __user_cap_data_struct data[2];\n      hdr.version = _LINUX_CAPABILITY_VERSION_3;\n      hdr.pid = 0;\n      memset(data, 0, sizeof(data));  // All capabilities disabled!\n      KJ_SYSCALL(capset(&hdr, data));\n    }\n\n    umask(0007);\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;",
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool runningAsRoot = getuid() == 0;\n\nvoid dropPrivs(const UserIds& uids, bool keepRealUid = false) {\n    // Defense in depth: Don't give my children any new caps for any reason.\n    KJ_SYSCALL(prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0));\n\n    if (runningAsRoot) {\n      KJ_SYSCALL(setresgid(uids.gid, uids.gid, uids.gid));\n      KJ_SYSCALL(setgroups(uids.groups.size(), uids.groups.begin()));\n\n      if (keepRealUid) {\n        // We're prepping to run the backend and user namespaces are not available, therefore the\n        // backend needs to keep its superuser powers stashed in order to hand them off to the\n        // grain supervisors so that they can set up sandboxes. Instead of creating a suid binary\n        // (with all the danger that entails), we merely drop the effective UID, but raise it again\n        // when invoking the supervisor.\n        KJ_SYSCALL(seteuid(uids.uid));\n      } else {\n        KJ_SYSCALL(setresuid(uids.uid, uids.uid, uids.uid));\n      }\n    } else {\n      // We're using UID namespaces.\n\n      KJ_ASSERT(!keepRealUid);\n\n      // Defense in depth: Drop all capabilities from the set of caps which my children are allowed\n      //   to ever have.\n      for (uint cap: kj::range(0, CAP_LAST_CAP + 1)) {\n        // TODO(soon): I spontaneously started getting EINVAL here, but only in production, so I\n        //   had to remove the error check. Figure out what happened and re-enable it. Maybe it\n        //   makes sense to read the bset first and then only drop the caps in it?\n        prctl(PR_CAPBSET_DROP, cap, 0, 0, 0);\n      }\n\n      // Defense in depth: Don't grant my children capabilities just because they have UID 0.\n      KJ_SYSCALL(prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED));\n\n      // Drop all Linux \"capabilities\".  (These are Linux/POSIX \"capabilities\", which are not true\n      // object-capabilities, hence the quotes.)\n      struct __user_cap_header_struct hdr;\n      struct __user_cap_data_struct data[2];\n      hdr.version = _LINUX_CAPABILITY_VERSION_3;\n      hdr.pid = 0;\n      memset(data, 0, sizeof(data));  // All capabilities disabled!\n      KJ_SYSCALL(capset(&hdr, data));\n    }\n\n    umask(0007);\n  }"
        }
      },
      {
        "call_info": {
          "callee": "fdBundle.closeAll",
          "args": [],
          "line": 2943
        },
        "resolved": true,
        "details": {
          "function_name": "closeAll",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1693-1695",
          "snippet": "void closeAll() {\n      ports.clear();\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void closeAll() {\n        ports.clear();\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "command.begin()",
            "command.size()"
          ],
          "line": 2940
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command.size",
          "args": [],
          "line": 2940
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "command.begin",
          "args": [],
          "line": 2940
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "kj::mv(commandFd)"
          ],
          "line": 2940
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "commandFd"
          ],
          "line": 2940
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fchmod(commandRawFd, 0660)"
          ],
          "line": 2938
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fchmod",
          "args": [
            "commandRawFd",
            "0660"
          ],
          "line": 2938
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fchown(commandRawFd, -1, config.uids.gid)"
          ],
          "line": 2937
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fchown",
          "args": [
            "commandRawFd",
            "-1",
            "config.uids.gid"
          ],
          "line": 2937
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_DEFER",
          "args": [
            "unlink(commandFile)"
          ],
          "line": 2935
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "commandFile"
          ],
          "line": 2935
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "commandRawFd = mkstemp(commandFile)"
          ],
          "line": 2933
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkstemp",
          "args": [
            "commandFile"
          ],
          "line": 2933
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\nvoid mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }"
  },
  {
    "function_name": "clearDevPackages",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2924-2927",
    "snippet": "void clearDevPackages(const Config& config) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\"db.devpackages.remove({})\"));\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "mongoCommand",
          "args": [
            "config",
            "fakeBundle",
            "kj::str(\"db.devpackages.remove({})\")"
          ],
          "line": 2926
        },
        "resolved": true,
        "details": {
          "function_name": "mongoCommand",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2929-2952",
          "snippet": "void mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\nvoid mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"db.devpackages.remove({})\""
          ],
          "line": 2926
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid clearDevPackages(const Config& config) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\"db.devpackages.remove({})\"));\n  }"
  },
  {
    "function_name": "removeDevPackage",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2918-2922",
    "snippet": "void removeDevPackage(const Config& config, kj::StringPtr pkgId) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.remove({_id:\\\"\", pkgId, \"\\\"})\"));\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "mongoCommand",
          "args": [
            "config",
            "fakeBundle",
            "kj::str(\n        \"db.devpackages.remove({_id:\\\"\", pkgId, \"\\\"})\")"
          ],
          "line": 2920
        },
        "resolved": true,
        "details": {
          "function_name": "mongoCommand",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2929-2952",
          "snippet": "void mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\nvoid mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"db.devpackages.remove({_id:\\\"\"",
            "pkgId",
            "\"\\\"})\""
          ],
          "line": 2920
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid removeDevPackage(const Config& config, kj::StringPtr pkgId) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.remove({_id:\\\"\", pkgId, \"\\\"})\"));\n  }"
  },
  {
    "function_name": "updateDevPackage",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2909-2916",
    "snippet": "void updateDevPackage(const Config& config, kj::StringPtr pkgId, spk::Manifest::Reader manifest) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.update({_id:\\\"\", pkgId, \"\\\"}, {$set: {\"\n          \"timestamp:\", time(nullptr), \",\"\n          \"manifest:\", toMongoJson(manifest),\n        \"}})\"));\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "mongoCommand",
          "args": [
            "config",
            "fakeBundle",
            "kj::str(\n        \"db.devpackages.update({_id:\\\"\", pkgId, \"\\\"}, {$set: {\"\n          \"timestamp:\", time(nullptr), \",\"\n          \"manifest:\", toMongoJson(manifest),\n        \"}})\")"
          ],
          "line": 2911
        },
        "resolved": true,
        "details": {
          "function_name": "mongoCommand",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2929-2952",
          "snippet": "void mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\nvoid mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"db.devpackages.update({_id:\\\"\"",
            "pkgId",
            "\"\\\"}, {$set: {\"\n          \"timestamp:\"",
            "time(nullptr)",
            "\",\"\n          \"manifest:\"",
            "toMongoJson(manifest)",
            "\"}})\""
          ],
          "line": 2911
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "toMongoJson",
          "args": [
            "manifest"
          ],
          "line": 2914
        },
        "resolved": true,
        "details": {
          "function_name": "toMongoJson",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2889-2894",
          "snippet": "kj::StringTree toMongoJson(T&& value) {\n    capnp::JsonCodec json;\n    MongoJsonBinaryHandler binHandler;\n    json.addTypeHandler(binHandler);\n    return json.encode(kj::fwd<T>(value));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::StringTree toMongoJson(T&& value) {\n    capnp::JsonCodec json;\n    MongoJsonBinaryHandler binHandler;\n    json.addTypeHandler(binHandler);\n    return json.encode(kj::fwd<T>(value));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "time",
          "args": [
            "nullptr"
          ],
          "line": 2913
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid updateDevPackage(const Config& config, kj::StringPtr pkgId, spk::Manifest::Reader manifest) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.update({_id:\\\"\", pkgId, \"\\\"}, {$set: {\"\n          \"timestamp:\", time(nullptr), \",\"\n          \"manifest:\", toMongoJson(manifest),\n        \"}})\"));\n  }"
  },
  {
    "function_name": "insertDevPackage",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2896-2907",
    "snippet": "void insertDevPackage(const Config& config, kj::StringPtr appId, bool mountProc,\n                        kj::StringPtr pkgId, spk::Manifest::Reader manifest) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.insert({\"\n          \"_id:\\\"\", pkgId, \"\\\",\"\n          \"appId:\\\"\", appId, \"\\\",\"\n          \"timestamp:\", time(nullptr), \",\"\n          \"manifest:\", toMongoJson(manifest), \",\"\n          \"mountProc:\", mountProc ? \"true\" : \"false\",\n        \"})\"));\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "mongoCommand",
          "args": [
            "config",
            "fakeBundle",
            "kj::str(\n        \"db.devpackages.insert({\"\n          \"_id:\\\"\", pkgId, \"\\\",\"\n          \"appId:\\\"\", appId, \"\\\",\"\n          \"timestamp:\", time(nullptr), \",\"\n          \"manifest:\", toMongoJson(manifest), \",\"\n          \"mountProc:\", mountProc ? \"true\" : \"false\",\n        \"})\")"
          ],
          "line": 2899
        },
        "resolved": true,
        "details": {
          "function_name": "mongoCommand",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2929-2952",
          "snippet": "void mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\nvoid mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"db.devpackages.insert({\"\n          \"_id:\\\"\"",
            "pkgId",
            "\"\\\",\"\n          \"appId:\\\"\"",
            "appId",
            "\"\\\",\"\n          \"timestamp:\"",
            "time(nullptr)",
            "\",\"\n          \"manifest:\"",
            "toMongoJson(manifest)",
            "\",\"\n          \"mountProc:\"",
            "mountProc ? \"true\" : \"false\"",
            "\"})\""
          ],
          "line": 2899
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "toMongoJson",
          "args": [
            "manifest"
          ],
          "line": 2904
        },
        "resolved": true,
        "details": {
          "function_name": "toMongoJson",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2889-2894",
          "snippet": "kj::StringTree toMongoJson(T&& value) {\n    capnp::JsonCodec json;\n    MongoJsonBinaryHandler binHandler;\n    json.addTypeHandler(binHandler);\n    return json.encode(kj::fwd<T>(value));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::StringTree toMongoJson(T&& value) {\n    capnp::JsonCodec json;\n    MongoJsonBinaryHandler binHandler;\n    json.addTypeHandler(binHandler);\n    return json.encode(kj::fwd<T>(value));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "time",
          "args": [
            "nullptr"
          ],
          "line": 2903
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid insertDevPackage(const Config& config, kj::StringPtr appId, bool mountProc,\n                        kj::StringPtr pkgId, spk::Manifest::Reader manifest) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.insert({\"\n          \"_id:\\\"\", pkgId, \"\\\",\"\n          \"appId:\\\"\", appId, \"\\\",\"\n          \"timestamp:\", time(nullptr), \",\"\n          \"manifest:\", toMongoJson(manifest), \",\"\n          \"mountProc:\", mountProc ? \"true\" : \"false\",\n        \"})\"));\n  }"
  },
  {
    "function_name": "toMongoJson",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2889-2894",
    "snippet": "kj::StringTree toMongoJson(T&& value) {\n    capnp::JsonCodec json;\n    MongoJsonBinaryHandler binHandler;\n    json.addTypeHandler(binHandler);\n    return json.encode(kj::fwd<T>(value));\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "json.encode",
          "args": [
            "kj::fwd<T>(value)"
          ],
          "line": 2893
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::fwd<T>",
          "args": [
            "value"
          ],
          "line": 2893
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "json.addTypeHandler",
          "args": [
            "binHandler"
          ],
          "line": 2892
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::StringTree toMongoJson(T&& value) {\n    capnp::JsonCodec json;\n    MongoJsonBinaryHandler binHandler;\n    json.addTypeHandler(binHandler);\n    return json.encode(kj::fwd<T>(value));\n  }"
  },
  {
    "function_name": "decode",
    "container": "MongoJsonBinaryHandler",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2881-2885",
    "snippet": "capnp::Orphan<capnp::Data> decode(\n        const capnp::JsonCodec& codec, capnp::JsonValue::Reader input,\n        capnp::Orphanage orphanage) const override {\n      KJ_UNIMPLEMENTED(\"MongoJsonBinaryHandler::decode\");\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_UNIMPLEMENTED",
          "args": [
            "\"MongoJsonBinaryHandler::decode\""
          ],
          "line": 2884
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nMongoJsonBinaryHandler {\n  capnp::Orphan<capnp::Data> decode(\n          const capnp::JsonCodec& codec, capnp::JsonValue::Reader input,\n          capnp::Orphanage orphanage) const override {\n        KJ_UNIMPLEMENTED(\"MongoJsonBinaryHandler::decode\");\n      }\n}"
  },
  {
    "function_name": "encode",
    "container": "MongoJsonBinaryHandler",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2872-2879",
    "snippet": "void encode(const capnp::JsonCodec& codec, capnp::Data::Reader input,\n                capnp::JsonValue::Builder output) const override {\n      auto call = output.initCall();\n      call.setFunction(\"BinData\");\n      auto params = call.initParams(2);\n      params[0].setNumber(0);\n      params[1].setString(base64Encode(input, false));\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "params[1].setString",
          "args": [
            "base64Encode(input, false)"
          ],
          "line": 2878
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base64Encode",
          "args": [
            "input",
            "false"
          ],
          "line": 2878
        },
        "resolved": true,
        "details": {
          "function_name": "base64Encode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "630-670",
          "snippet": "kj::String base64Encode(kj::ArrayPtr<const byte> input, bool breakLines) {\n  /* set up a destination buffer large enough to hold the encoded data */\n  // equivalent to ceil(input.size() / 3) * 4\n  auto numChars = (input.size() + 2) / 3 * 4;\n  if (breakLines) {\n    // Add space for newline characters.\n    uint lineCount = numChars / CHARS_PER_LINE;\n    if (numChars % CHARS_PER_LINE > 0) {\n      // Partial line.\n      ++lineCount;\n    }\n    numChars = numChars + lineCount;\n  }\n  auto output = kj::heapString(numChars);\n  /* keep track of our encoded position */\n  char* c = output.begin();\n  /* store the number of bytes encoded by a single call */\n  int cnt = 0;\n  size_t total = 0;\n  /* we need an encoder state */\n  base64_encodestate s;\n\n  /*---------- START ENCODING ----------*/\n  /* initialise the encoder state */\n  base64_init_encodestate(&s);\n  /* gather data from the input and send it to the output */\n  cnt = base64_encode_block((const char *)input.begin(), input.size(), c, &s, breakLines);\n  c += cnt;\n  total += cnt;\n\n  /* since we have encoded the entire input string, we know that\n     there is no more input data; finalise the encoding */\n  cnt = base64_encode_blockend(c, &s, breakLines);\n  c += cnt;\n  total += cnt;\n  /*---------- STOP ENCODING  ----------*/\n\n  KJ_ASSERT(total == output.size(), total, output.size());\n\n  return output;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String base64Encode(kj::ArrayPtr<const byte> input, bool breakLines) {\n  /* set up a destination buffer large enough to hold the encoded data */\n  // equivalent to ceil(input.size() / 3) * 4\n  auto numChars = (input.size() + 2) / 3 * 4;\n  if (breakLines) {\n    // Add space for newline characters.\n    uint lineCount = numChars / CHARS_PER_LINE;\n    if (numChars % CHARS_PER_LINE > 0) {\n      // Partial line.\n      ++lineCount;\n    }\n    numChars = numChars + lineCount;\n  }\n  auto output = kj::heapString(numChars);\n  /* keep track of our encoded position */\n  char* c = output.begin();\n  /* store the number of bytes encoded by a single call */\n  int cnt = 0;\n  size_t total = 0;\n  /* we need an encoder state */\n  base64_encodestate s;\n\n  /*---------- START ENCODING ----------*/\n  /* initialise the encoder state */\n  base64_init_encodestate(&s);\n  /* gather data from the input and send it to the output */\n  cnt = base64_encode_block((const char *)input.begin(), input.size(), c, &s, breakLines);\n  c += cnt;\n  total += cnt;\n\n  /* since we have encoded the entire input string, we know that\n     there is no more input data; finalise the encoding */\n  cnt = base64_encode_blockend(c, &s, breakLines);\n  c += cnt;\n  total += cnt;\n  /*---------- STOP ENCODING  ----------*/\n\n  KJ_ASSERT(total == output.size(), total, output.size());\n\n  return output;\n}"
        }
      },
      {
        "call_info": {
          "callee": "params[0].setNumber",
          "args": [
            "0"
          ],
          "line": 2877
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "call.initParams",
          "args": [
            "2"
          ],
          "line": 2876
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "call.setFunction",
          "args": [
            "\"BinData\""
          ],
          "line": 2875
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "output.initCall",
          "args": [],
          "line": 2874
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nMongoJsonBinaryHandler {\n  void encode(const capnp::JsonCodec& codec, capnp::Data::Reader input,\n                  capnp::JsonValue::Builder output) const override {\n        auto call = output.initCall();\n        call.setFunction(\"BinData\");\n        auto params = call.initParams(2);\n        params[0].setNumber(0);\n        params[1].setString(base64Encode(input, false));\n      }\n}"
  },
  {
    "function_name": "runDevSession",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2758-2868",
    "snippet": "[[noreturn]] void runDevSession(const Config& config, kj::AutoCloseFd internalFd) {\n    auto exception = kj::runCatchingExceptions([&]() {\n      // When someone connects, we expect them to pass us a one-byte command code.\n      kj::byte commandCode;\n      kj::FdInputStream((int)internalFd).read(&commandCode, 1);\n\n      KJ_REQUIRE(commandCode == DEVMODE_COMMAND_CONNECT);\n      context.warning(\"** Accepted new dev session connection...\");\n\n      // OK, we're accepting a new dev mode connection. `internalFd` is the socket opened by\n      // the `sandstorm dev` command, implemented elsewhere in this file. All it does is pass\n      // us the file descriptor originally provided by its invoker (i.e. from the `spk` tool).\n      // So get that, then discard internalFd.\n      auto fd = receiveFd(internalFd);\n      internalFd = nullptr;\n\n      // Dev error log goes to the connected session.\n      KJ_SYSCALL(dup2(fd, STDOUT_FILENO));\n      KJ_SYSCALL(dup2(fd, STDERR_FILENO));\n\n      // Restore SIGCHLD, ignored by parent process.\n      KJ_SYSCALL(signal(SIGCHLD, SIG_DFL));\n\n      kj::FdInputStream rawInput((int)fd);\n      kj::BufferedInputStreamWrapper input(rawInput);\n      kj::String appId;\n      KJ_IF_MAYBE(line, readLine(input)) {\n        appId = kj::mv(*line);\n      } else {\n        KJ_FAIL_ASSERT(\"Expected app ID.\");\n      }\n\n      bool mountProc = false;\n      KJ_IF_MAYBE(line, readLine(input)) {\n        kj::String mountProcLine = kj::mv(*line);\n        if (mountProcLine == \"1\") {\n          mountProc = true;\n        }\n      } else {\n        KJ_FAIL_ASSERT(\"Expected value of '1' or '0' for mountProc.\");\n      }\n\n      for (char c: appId) {\n        if (!isalnum(c)) {\n          context.exitError(\"Invalid app ID. Must contain only alphanumerics.\");\n        }\n      }\n\n      char dir[] = \"/var/sandstorm/apps/dev-XXXXXX\";\n      if (mkdtemp(dir) == nullptr) {\n        KJ_FAIL_SYSCALL(\"mkdtemp(dir)\", errno, dir);\n      }\n      KJ_DEFER(rmdir(dir));\n      if (runningAsRoot) { KJ_SYSCALL(chown(dir, config.uids.uid, config.uids.gid)); }\n\n      char* pkgId = strrchr(dir, '/') + 1;\n\n      // We dont use fusermount(1) because it doesn't live in our namespace. For now, this is not\n      // a problem because we're root anyway. If in the future we use UID namespaces to avoid being\n      // root, then this gets complicated. We could include fusermount(1) in our package, but\n      // it would have to be suid-root, defeating the goal of not using root rights.\n      auto fuseFd = raiiOpen(\"/dev/fuse\", O_RDWR);\n\n      auto mountOptions = kj::str(\"fd=\", fuseFd, \",rootmode=40000,\"\n          \"user_id=\", config.uids.uid, \",group_id=\", config.uids.gid, \",allow_other\");\n\n      KJ_SYSCALL(mount(\"/dev/fuse\", dir, \"fuse\", MS_NOSUID|MS_NODEV, mountOptions.cStr()));\n      KJ_DEFER(umount2(dir, MNT_FORCE | UMOUNT_NOFOLLOW));\n\n      // Send the FUSE fd back to the client.\n      sendFd(fd, fuseFd);\n      fuseFd = nullptr;\n\n      capnp::ReaderOptions manifestLimits;\n      manifestLimits.traversalLimitInWords = spk::Manifest::SIZE_LIMIT_IN_WORDS;\n\n      {\n        // Read the manifest.\n        capnp::StreamFdMessageReader reader(\n            raiiOpen(kj::str(dir, \"/sandstorm-manifest\"), O_RDONLY), manifestLimits);\n\n        // Notify the front-end that the app exists.\n        insertDevPackage(config, appId, mountProc, pkgId, reader.getRoot<spk::Manifest>());\n      }\n\n      {\n        KJ_DEFER(removeDevPackage(config, pkgId));\n\n        for (;;) {\n          KJ_IF_MAYBE(line, readLine(input)) {\n            if (*line == \"restart\") {\n              // Re-read the manifest.\n              capnp::StreamFdMessageReader reader(\n                  raiiOpen(kj::str(dir, \"/sandstorm-manifest\"), O_RDONLY), manifestLimits);\n\n              // Notify front-end that the app changed.\n              updateDevPackage(config, pkgId, reader.getRoot<spk::Manifest>());\n            }\n          } else {\n            break;\n          }\n        }\n      }\n    });\n\n    KJ_IF_MAYBE(e, exception) {\n      context.exitError(kj::str(*e));\n    } else {\n      context.exit();\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool runningAsRoot = getuid() == 0;",
      "static constexpr kj::byte DEVMODE_COMMAND_CONNECT = 1;",
      "constexpr kj::byte RunBundleMain::DEVMODE_COMMAND_CONNECT;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exit",
          "args": [],
          "line": 2866
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitError",
          "args": [
            "kj::str(*e)"
          ],
          "line": 2864
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "*e"
          ],
          "line": 2864
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::runCatchingExceptions",
          "args": [
            "[&]() {\n      // When someone connects, we expect them to pass us a one-byte command code.\n      kj::byte commandCode;\n      kj::FdInputStream((int)internalFd).read(&commandCode, 1);\n\n      KJ_REQUIRE(commandCode == DEVMODE_COMMAND_CONNECT);\n      context.warning(\"** Accepted new dev session connection...\");\n\n      // OK, we're accepting a new dev mode connection. `internalFd` is the socket opened by\n      // the `sandstorm dev` command, implemented elsewhere in this file. All it does is pass\n      // us the file descriptor originally provided by its invoker (i.e. from the `spk` tool).\n      // So get that, then discard internalFd.\n      auto fd = receiveFd(internalFd);\n      internalFd = nullptr;\n\n      // Dev error log goes to the connected session.\n      KJ_SYSCALL(dup2(fd, STDOUT_FILENO));\n      KJ_SYSCALL(dup2(fd, STDERR_FILENO));\n\n      // Restore SIGCHLD, ignored by parent process.\n      KJ_SYSCALL(signal(SIGCHLD, SIG_DFL));\n\n      kj::FdInputStream rawInput((int)fd);\n      kj::BufferedInputStreamWrapper input(rawInput);\n      kj::String appId;\n      KJ_IF_MAYBE(line, readLine(input)) {\n        appId = kj::mv(*line);\n      } else {\n        KJ_FAIL_ASSERT(\"Expected app ID.\");\n      }\n\n      bool mountProc = false;\n      KJ_IF_MAYBE(line, readLine(input)) {\n        kj::String mountProcLine = kj::mv(*line);\n        if (mountProcLine == \"1\") {\n          mountProc = true;\n        }\n      } else {\n        KJ_FAIL_ASSERT(\"Expected value of '1' or '0' for mountProc.\");\n      }\n\n      for (char c: appId) {\n        if (!isalnum(c)) {\n          context.exitError(\"Invalid app ID. Must contain only alphanumerics.\");\n        }\n      }\n\n      char dir[] = \"/var/sandstorm/apps/dev-XXXXXX\";\n      if (mkdtemp(dir) == nullptr) {\n        KJ_FAIL_SYSCALL(\"mkdtemp(dir)\", errno, dir);\n      }\n      KJ_DEFER(rmdir(dir));\n      if (runningAsRoot) { KJ_SYSCALL(chown(dir, config.uids.uid, config.uids.gid)); }\n\n      char* pkgId = strrchr(dir, '/') + 1;\n\n      // We dont use fusermount(1) because it doesn't live in our namespace. For now, this is not\n      // a problem because we're root anyway. If in the future we use UID namespaces to avoid being\n      // root, then this gets complicated. We could include fusermount(1) in our package, but\n      // it would have to be suid-root, defeating the goal of not using root rights.\n      auto fuseFd = raiiOpen(\"/dev/fuse\", O_RDWR);\n\n      auto mountOptions = kj::str(\"fd=\", fuseFd, \",rootmode=40000,\"\n          \"user_id=\", config.uids.uid, \",group_id=\", config.uids.gid, \",allow_other\");\n\n      KJ_SYSCALL(mount(\"/dev/fuse\", dir, \"fuse\", MS_NOSUID|MS_NODEV, mountOptions.cStr()));\n      KJ_DEFER(umount2(dir, MNT_FORCE | UMOUNT_NOFOLLOW));\n\n      // Send the FUSE fd back to the client.\n      sendFd(fd, fuseFd);\n      fuseFd = nullptr;\n\n      capnp::ReaderOptions manifestLimits;\n      manifestLimits.traversalLimitInWords = spk::Manifest::SIZE_LIMIT_IN_WORDS;\n\n      {\n        // Read the manifest.\n        capnp::StreamFdMessageReader reader(\n            raiiOpen(kj::str(dir, \"/sandstorm-manifest\"), O_RDONLY), manifestLimits);\n\n        // Notify the front-end that the app exists.\n        insertDevPackage(config, appId, mountProc, pkgId, reader.getRoot<spk::Manifest>());\n      }\n\n      {\n        KJ_DEFER(removeDevPackage(config, pkgId));\n\n        for (;;) {\n          KJ_IF_MAYBE(line, readLine(input)) {\n            if (*line == \"restart\") {\n              // Re-read the manifest.\n              capnp::StreamFdMessageReader reader(\n                  raiiOpen(kj::str(dir, \"/sandstorm-manifest\"), O_RDONLY), manifestLimits);\n\n              // Notify front-end that the app changed.\n              updateDevPackage(config, pkgId, reader.getRoot<spk::Manifest>());\n            }\n          } else {\n            break;\n          }\n        }\n      }}"
          ],
          "line": 2759
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "updateDevPackage",
          "args": [
            "config",
            "pkgId",
            "reader.getRoot<spk::Manifest>()"
          ],
          "line": 2854
        },
        "resolved": true,
        "details": {
          "function_name": "updateDevPackage",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2909-2916",
          "snippet": "void updateDevPackage(const Config& config, kj::StringPtr pkgId, spk::Manifest::Reader manifest) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.update({_id:\\\"\", pkgId, \"\\\"}, {$set: {\"\n          \"timestamp:\", time(nullptr), \",\"\n          \"manifest:\", toMongoJson(manifest),\n        \"}})\"));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid updateDevPackage(const Config& config, kj::StringPtr pkgId, spk::Manifest::Reader manifest) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.update({_id:\\\"\", pkgId, \"\\\"}, {$set: {\"\n          \"timestamp:\", time(nullptr), \",\"\n          \"manifest:\", toMongoJson(manifest),\n        \"}})\"));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "reader.getRoot<spk::Manifest>",
          "args": [],
          "line": 2854
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "kj::str(dir, \"/sandstorm-manifest\")",
            "O_RDONLY"
          ],
          "line": 2851
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "dir",
            "\"/sandstorm-manifest\""
          ],
          "line": 2851
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_DEFER",
          "args": [
            "removeDevPackage(config, pkgId)"
          ],
          "line": 2844
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "removeDevPackage",
          "args": [
            "config",
            "pkgId"
          ],
          "line": 2844
        },
        "resolved": true,
        "details": {
          "function_name": "removeDevPackage",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2918-2922",
          "snippet": "void removeDevPackage(const Config& config, kj::StringPtr pkgId) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.remove({_id:\\\"\", pkgId, \"\\\"})\"));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid removeDevPackage(const Config& config, kj::StringPtr pkgId) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.remove({_id:\\\"\", pkgId, \"\\\"})\"));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "insertDevPackage",
          "args": [
            "config",
            "appId",
            "mountProc",
            "pkgId",
            "reader.getRoot<spk::Manifest>()"
          ],
          "line": 2840
        },
        "resolved": true,
        "details": {
          "function_name": "insertDevPackage",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2896-2907",
          "snippet": "void insertDevPackage(const Config& config, kj::StringPtr appId, bool mountProc,\n                        kj::StringPtr pkgId, spk::Manifest::Reader manifest) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.insert({\"\n          \"_id:\\\"\", pkgId, \"\\\",\"\n          \"appId:\\\"\", appId, \"\\\",\"\n          \"timestamp:\", time(nullptr), \",\"\n          \"manifest:\", toMongoJson(manifest), \",\"\n          \"mountProc:\", mountProc ? \"true\" : \"false\",\n        \"})\"));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid insertDevPackage(const Config& config, kj::StringPtr appId, bool mountProc,\n                        kj::StringPtr pkgId, spk::Manifest::Reader manifest) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\n        \"db.devpackages.insert({\"\n          \"_id:\\\"\", pkgId, \"\\\",\"\n          \"appId:\\\"\", appId, \"\\\",\"\n          \"timestamp:\", time(nullptr), \",\"\n          \"manifest:\", toMongoJson(manifest), \",\"\n          \"mountProc:\", mountProc ? \"true\" : \"false\",\n        \"})\"));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "reader.getRoot<spk::Manifest>",
          "args": [],
          "line": 2840
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "kj::str(dir, \"/sandstorm-manifest\")",
            "O_RDONLY"
          ],
          "line": 2837
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "dir",
            "\"/sandstorm-manifest\""
          ],
          "line": 2837
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sendFd",
          "args": [
            "fd",
            "fuseFd"
          ],
          "line": 2828
        },
        "resolved": true,
        "details": {
          "function_name": "sendFd",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/send-fd.c++",
          "lines": "24-53",
          "snippet": "void sendFd(int sendOn, int fdToSend) {\n  // Sends the fd over the given socket. A NUL byte is also sent, because at least one byte\n  // must be written along with the FD.\n\n  struct msghdr msg;\n  struct iovec iov;\n  union {\n    struct cmsghdr cmsg;\n    char cmsgSpace[CMSG_LEN(sizeof(int))];\n  };\n  memset(&msg, 0, sizeof(msg));\n  memset(&iov, 0, sizeof(iov));\n  memset(cmsgSpace, 0, sizeof(cmsgSpace));\n\n  char c = 0;\n  iov.iov_base = &c;\n  iov.iov_len = 1;\n  msg.msg_iov = &iov;\n  msg.msg_iovlen = 1;\n\n  msg.msg_control = &cmsg;\n  msg.msg_controllen = sizeof(cmsgSpace);\n\n  cmsg.cmsg_len = sizeof(cmsgSpace);\n  cmsg.cmsg_level = SOL_SOCKET;\n  cmsg.cmsg_type = SCM_RIGHTS;\n  *reinterpret_cast<int*>(CMSG_DATA(&cmsg)) = fdToSend;\n\n  KJ_SYSCALL(sendmsg(sendOn, &msg, 0));\n}",
          "includes": [
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <kj/debug.h>",
            "#include \"send-fd.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/un.h>\n#include <sys/socket.h>\n#include <kj/debug.h>\n#include \"send-fd.h\"\n\nvoid sendFd(int sendOn, int fdToSend) {\n  // Sends the fd over the given socket. A NUL byte is also sent, because at least one byte\n  // must be written along with the FD.\n\n  struct msghdr msg;\n  struct iovec iov;\n  union {\n    struct cmsghdr cmsg;\n    char cmsgSpace[CMSG_LEN(sizeof(int))];\n  };\n  memset(&msg, 0, sizeof(msg));\n  memset(&iov, 0, sizeof(iov));\n  memset(cmsgSpace, 0, sizeof(cmsgSpace));\n\n  char c = 0;\n  iov.iov_base = &c;\n  iov.iov_len = 1;\n  msg.msg_iov = &iov;\n  msg.msg_iovlen = 1;\n\n  msg.msg_control = &cmsg;\n  msg.msg_controllen = sizeof(cmsgSpace);\n\n  cmsg.cmsg_len = sizeof(cmsgSpace);\n  cmsg.cmsg_level = SOL_SOCKET;\n  cmsg.cmsg_type = SCM_RIGHTS;\n  *reinterpret_cast<int*>(CMSG_DATA(&cmsg)) = fdToSend;\n\n  KJ_SYSCALL(sendmsg(sendOn, &msg, 0));\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_DEFER",
          "args": [
            "umount2(dir, MNT_FORCE | UMOUNT_NOFOLLOW)"
          ],
          "line": 2825
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "umount2",
          "args": [
            "dir",
            "MNT_FORCE | UMOUNT_NOFOLLOW"
          ],
          "line": 2825
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/dev/fuse\", dir, \"fuse\", MS_NOSUID|MS_NODEV, mountOptions.cStr())"
          ],
          "line": 2824
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/dev/fuse\"",
            "dir",
            "\"fuse\"",
            "MS_NOSUID|MS_NODEV",
            "mountOptions.cStr()"
          ],
          "line": 2824
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mountOptions.cStr",
          "args": [],
          "line": 2824
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"fd=\"",
            "fuseFd",
            "\",rootmode=40000,\"\n          \"user_id=\"",
            "config.uids.uid",
            "\",group_id=\"",
            "config.uids.gid",
            "\",allow_other\""
          ],
          "line": 2821
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"/dev/fuse\"",
            "O_RDWR"
          ],
          "line": 2819
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strrchr",
          "args": [
            "dir",
            "'/'"
          ],
          "line": 2813
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chown(dir, config.uids.uid, config.uids.gid)"
          ],
          "line": 2811
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chown",
          "args": [
            "dir",
            "config.uids.uid",
            "config.uids.gid"
          ],
          "line": 2811
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_DEFER",
          "args": [
            "rmdir(dir)"
          ],
          "line": 2810
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rmdir",
          "args": [
            "dir"
          ],
          "line": 2810
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"mkdtemp(dir)\"",
            "errno",
            "dir"
          ],
          "line": 2808
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdtemp",
          "args": [
            "dir"
          ],
          "line": 2807
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitError",
          "args": [
            "\"Invalid app ID. Must contain only alphanumerics.\""
          ],
          "line": 2802
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "isalnum",
          "args": [
            "c"
          ],
          "line": 2801
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_ASSERT",
          "args": [
            "\"Expected value of '1' or '0' for mountProc.\""
          ],
          "line": 2797
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "*line"
          ],
          "line": 2792
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_ASSERT",
          "args": [
            "\"Expected app ID.\""
          ],
          "line": 2787
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "*line"
          ],
          "line": 2785
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "signal(SIGCHLD, SIG_DFL)"
          ],
          "line": 2779
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signal",
          "args": [
            "SIGCHLD",
            "SIG_DFL"
          ],
          "line": 2779
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(fd, STDERR_FILENO)"
          ],
          "line": 2776
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "fd",
            "STDERR_FILENO"
          ],
          "line": 2776
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(fd, STDOUT_FILENO)"
          ],
          "line": 2775
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "fd",
            "STDOUT_FILENO"
          ],
          "line": 2775
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "receiveFd",
          "args": [
            "internalFd"
          ],
          "line": 2771
        },
        "resolved": true,
        "details": {
          "function_name": "receiveFd",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/send-fd.c++",
          "lines": "55-59",
          "snippet": "kj::AutoCloseFd receiveFd(int sockFd) {\n  return receiveFd(sockFd, [](kj::ArrayPtr<const kj::byte>) {\n    KJ_FAIL_REQUIRE(\"Got unexpected data on unix socket while waiting for a file descriptor.\");\n  });\n}",
          "includes": [
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <kj/debug.h>",
            "#include \"send-fd.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/un.h>\n#include <sys/socket.h>\n#include <kj/debug.h>\n#include \"send-fd.h\"\n\nkj::AutoCloseFd receiveFd(int sockFd) {\n  return receiveFd(sockFd, [](kj::ArrayPtr<const kj::byte>) {\n    KJ_FAIL_REQUIRE(\"Got unexpected data on unix socket while waiting for a file descriptor.\");\n  });\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Accepted new dev session connection...\""
          ],
          "line": 2765
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "commandCode == DEVMODE_COMMAND_CONNECT"
          ],
          "line": 2764
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdInputStream",
          "args": [
            "&commandCode",
            "1"
          ],
          "line": 2762
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdInputStream",
          "args": [
            "(int)internalFd"
          ],
          "line": 2762
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\nstatic constexpr kj::byte DEVMODE_COMMAND_CONNECT = 1;\nconstexpr kj::byte RunBundleMain::DEVMODE_COMMAND_CONNECT;\n\n[[noreturn]] void runDevSession(const Config& config, kj::AutoCloseFd internalFd) {\n    auto exception = kj::runCatchingExceptions([&]() {\n      // When someone connects, we expect them to pass us a one-byte command code.\n      kj::byte commandCode;\n      kj::FdInputStream((int)internalFd).read(&commandCode, 1);\n\n      KJ_REQUIRE(commandCode == DEVMODE_COMMAND_CONNECT);\n      context.warning(\"** Accepted new dev session connection...\");\n\n      // OK, we're accepting a new dev mode connection. `internalFd` is the socket opened by\n      // the `sandstorm dev` command, implemented elsewhere in this file. All it does is pass\n      // us the file descriptor originally provided by its invoker (i.e. from the `spk` tool).\n      // So get that, then discard internalFd.\n      auto fd = receiveFd(internalFd);\n      internalFd = nullptr;\n\n      // Dev error log goes to the connected session.\n      KJ_SYSCALL(dup2(fd, STDOUT_FILENO));\n      KJ_SYSCALL(dup2(fd, STDERR_FILENO));\n\n      // Restore SIGCHLD, ignored by parent process.\n      KJ_SYSCALL(signal(SIGCHLD, SIG_DFL));\n\n      kj::FdInputStream rawInput((int)fd);\n      kj::BufferedInputStreamWrapper input(rawInput);\n      kj::String appId;\n      KJ_IF_MAYBE(line, readLine(input)) {\n        appId = kj::mv(*line);\n      } else {\n        KJ_FAIL_ASSERT(\"Expected app ID.\");\n      }\n\n      bool mountProc = false;\n      KJ_IF_MAYBE(line, readLine(input)) {\n        kj::String mountProcLine = kj::mv(*line);\n        if (mountProcLine == \"1\") {\n          mountProc = true;\n        }\n      } else {\n        KJ_FAIL_ASSERT(\"Expected value of '1' or '0' for mountProc.\");\n      }\n\n      for (char c: appId) {\n        if (!isalnum(c)) {\n          context.exitError(\"Invalid app ID. Must contain only alphanumerics.\");\n        }\n      }\n\n      char dir[] = \"/var/sandstorm/apps/dev-XXXXXX\";\n      if (mkdtemp(dir) == nullptr) {\n        KJ_FAIL_SYSCALL(\"mkdtemp(dir)\", errno, dir);\n      }\n      KJ_DEFER(rmdir(dir));\n      if (runningAsRoot) { KJ_SYSCALL(chown(dir, config.uids.uid, config.uids.gid)); }\n\n      char* pkgId = strrchr(dir, '/') + 1;\n\n      // We dont use fusermount(1) because it doesn't live in our namespace. For now, this is not\n      // a problem because we're root anyway. If in the future we use UID namespaces to avoid being\n      // root, then this gets complicated. We could include fusermount(1) in our package, but\n      // it would have to be suid-root, defeating the goal of not using root rights.\n      auto fuseFd = raiiOpen(\"/dev/fuse\", O_RDWR);\n\n      auto mountOptions = kj::str(\"fd=\", fuseFd, \",rootmode=40000,\"\n          \"user_id=\", config.uids.uid, \",group_id=\", config.uids.gid, \",allow_other\");\n\n      KJ_SYSCALL(mount(\"/dev/fuse\", dir, \"fuse\", MS_NOSUID|MS_NODEV, mountOptions.cStr()));\n      KJ_DEFER(umount2(dir, MNT_FORCE | UMOUNT_NOFOLLOW));\n\n      // Send the FUSE fd back to the client.\n      sendFd(fd, fuseFd);\n      fuseFd = nullptr;\n\n      capnp::ReaderOptions manifestLimits;\n      manifestLimits.traversalLimitInWords = spk::Manifest::SIZE_LIMIT_IN_WORDS;\n\n      {\n        // Read the manifest.\n        capnp::StreamFdMessageReader reader(\n            raiiOpen(kj::str(dir, \"/sandstorm-manifest\"), O_RDONLY), manifestLimits);\n\n        // Notify the front-end that the app exists.\n        insertDevPackage(config, appId, mountProc, pkgId, reader.getRoot<spk::Manifest>());\n      }\n\n      {\n        KJ_DEFER(removeDevPackage(config, pkgId));\n\n        for (;;) {\n          KJ_IF_MAYBE(line, readLine(input)) {\n            if (*line == \"restart\") {\n              // Re-read the manifest.\n              capnp::StreamFdMessageReader reader(\n                  raiiOpen(kj::str(dir, \"/sandstorm-manifest\"), O_RDONLY), manifestLimits);\n\n              // Notify front-end that the app changed.\n              updateDevPackage(config, pkgId, reader.getRoot<spk::Manifest>());\n            }\n          } else {\n            break;\n          }\n        }\n      }\n    });\n\n    KJ_IF_MAYBE(e, exception) {\n      context.exitError(kj::str(*e));\n    } else {\n      context.exit();\n    }\n  }"
  },
  {
    "function_name": "runDevDaemon",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2705-2753",
    "snippet": "[[noreturn]] void runDevDaemon(const Config& config) {\n    clearDevPackages(config);\n\n    // Make sure socket directory exists (since the installer doesn't create it).\n    if (mkdir(\"/var/sandstorm/socket\", 0770) == 0) {\n      // Allow group to use this directory.\n      if (runningAsRoot) { KJ_SYSCALL(chown(\"/var/sandstorm/socket\", 0, config.uids.gid)); }\n    } else {\n      int error = errno;\n      if (error != EEXIST) {\n        KJ_FAIL_SYSCALL(\"mkdir(/var/sandstorm/socket)\", error);\n      }\n    }\n\n    // Create the devmode socket.\n    int sock_;\n    KJ_SYSCALL(sock_ = socket(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0));\n    auto sock = kj::AutoCloseFd(sock_);\n\n    struct sockaddr_un addr;\n    memset(&addr, 0, sizeof(addr));\n    addr.sun_family = AF_UNIX;\n    strcpy(addr.sun_path, \"/var/sandstorm/socket/devmode\");\n    unlink(addr.sun_path);\n    KJ_SYSCALL(bind(sock, reinterpret_cast<struct sockaddr*>(&addr), sizeof(addr)));\n    KJ_SYSCALL(listen(sock, 2));\n\n    // Ensure that the group can connect to the socket.\n    if (runningAsRoot) { KJ_SYSCALL(chown(\"/var/sandstorm/socket/devmode\", 0, config.uids.gid)); }\n    KJ_SYSCALL(chmod(\"/var/sandstorm/socket/devmode\", 0770));\n\n    // We don't care to reap dev sessions.\n    KJ_SYSCALL(signal(SIGCHLD, SIG_IGN));\n\n    // Please don't SIGPIPE if we write to a disconnected socket. An exception is nicer.\n    KJ_SYSCALL(signal(SIGPIPE, SIG_IGN));\n\n    for (;;) {\n      int connFd_;\n      KJ_SYSCALL(connFd_ = accept4(sock, nullptr, nullptr, SOCK_CLOEXEC));\n      kj::AutoCloseFd connFd(connFd_);\n\n      if (fork() == 0) {\n        sock = nullptr;\n        runDevSession(config, kj::mv(connFd));\n        KJ_UNREACHABLE;\n      }\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool runningAsRoot = getuid() == 0;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "runDevSession",
          "args": [
            "config",
            "kj::mv(connFd)"
          ],
          "line": 2749
        },
        "resolved": true,
        "details": {
          "function_name": "runDevSession",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2758-2868",
          "snippet": "[[noreturn]] void runDevSession(const Config& config, kj::AutoCloseFd internalFd) {\n    auto exception = kj::runCatchingExceptions([&]() {\n      // When someone connects, we expect them to pass us a one-byte command code.\n      kj::byte commandCode;\n      kj::FdInputStream((int)internalFd).read(&commandCode, 1);\n\n      KJ_REQUIRE(commandCode == DEVMODE_COMMAND_CONNECT);\n      context.warning(\"** Accepted new dev session connection...\");\n\n      // OK, we're accepting a new dev mode connection. `internalFd` is the socket opened by\n      // the `sandstorm dev` command, implemented elsewhere in this file. All it does is pass\n      // us the file descriptor originally provided by its invoker (i.e. from the `spk` tool).\n      // So get that, then discard internalFd.\n      auto fd = receiveFd(internalFd);\n      internalFd = nullptr;\n\n      // Dev error log goes to the connected session.\n      KJ_SYSCALL(dup2(fd, STDOUT_FILENO));\n      KJ_SYSCALL(dup2(fd, STDERR_FILENO));\n\n      // Restore SIGCHLD, ignored by parent process.\n      KJ_SYSCALL(signal(SIGCHLD, SIG_DFL));\n\n      kj::FdInputStream rawInput((int)fd);\n      kj::BufferedInputStreamWrapper input(rawInput);\n      kj::String appId;\n      KJ_IF_MAYBE(line, readLine(input)) {\n        appId = kj::mv(*line);\n      } else {\n        KJ_FAIL_ASSERT(\"Expected app ID.\");\n      }\n\n      bool mountProc = false;\n      KJ_IF_MAYBE(line, readLine(input)) {\n        kj::String mountProcLine = kj::mv(*line);\n        if (mountProcLine == \"1\") {\n          mountProc = true;\n        }\n      } else {\n        KJ_FAIL_ASSERT(\"Expected value of '1' or '0' for mountProc.\");\n      }\n\n      for (char c: appId) {\n        if (!isalnum(c)) {\n          context.exitError(\"Invalid app ID. Must contain only alphanumerics.\");\n        }\n      }\n\n      char dir[] = \"/var/sandstorm/apps/dev-XXXXXX\";\n      if (mkdtemp(dir) == nullptr) {\n        KJ_FAIL_SYSCALL(\"mkdtemp(dir)\", errno, dir);\n      }\n      KJ_DEFER(rmdir(dir));\n      if (runningAsRoot) { KJ_SYSCALL(chown(dir, config.uids.uid, config.uids.gid)); }\n\n      char* pkgId = strrchr(dir, '/') + 1;\n\n      // We dont use fusermount(1) because it doesn't live in our namespace. For now, this is not\n      // a problem because we're root anyway. If in the future we use UID namespaces to avoid being\n      // root, then this gets complicated. We could include fusermount(1) in our package, but\n      // it would have to be suid-root, defeating the goal of not using root rights.\n      auto fuseFd = raiiOpen(\"/dev/fuse\", O_RDWR);\n\n      auto mountOptions = kj::str(\"fd=\", fuseFd, \",rootmode=40000,\"\n          \"user_id=\", config.uids.uid, \",group_id=\", config.uids.gid, \",allow_other\");\n\n      KJ_SYSCALL(mount(\"/dev/fuse\", dir, \"fuse\", MS_NOSUID|MS_NODEV, mountOptions.cStr()));\n      KJ_DEFER(umount2(dir, MNT_FORCE | UMOUNT_NOFOLLOW));\n\n      // Send the FUSE fd back to the client.\n      sendFd(fd, fuseFd);\n      fuseFd = nullptr;\n\n      capnp::ReaderOptions manifestLimits;\n      manifestLimits.traversalLimitInWords = spk::Manifest::SIZE_LIMIT_IN_WORDS;\n\n      {\n        // Read the manifest.\n        capnp::StreamFdMessageReader reader(\n            raiiOpen(kj::str(dir, \"/sandstorm-manifest\"), O_RDONLY), manifestLimits);\n\n        // Notify the front-end that the app exists.\n        insertDevPackage(config, appId, mountProc, pkgId, reader.getRoot<spk::Manifest>());\n      }\n\n      {\n        KJ_DEFER(removeDevPackage(config, pkgId));\n\n        for (;;) {\n          KJ_IF_MAYBE(line, readLine(input)) {\n            if (*line == \"restart\") {\n              // Re-read the manifest.\n              capnp::StreamFdMessageReader reader(\n                  raiiOpen(kj::str(dir, \"/sandstorm-manifest\"), O_RDONLY), manifestLimits);\n\n              // Notify front-end that the app changed.\n              updateDevPackage(config, pkgId, reader.getRoot<spk::Manifest>());\n            }\n          } else {\n            break;\n          }\n        }\n      }\n    });\n\n    KJ_IF_MAYBE(e, exception) {\n      context.exitError(kj::str(*e));\n    } else {\n      context.exit();\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;",
            "static constexpr kj::byte DEVMODE_COMMAND_CONNECT = 1;",
            "constexpr kj::byte RunBundleMain::DEVMODE_COMMAND_CONNECT;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\nstatic constexpr kj::byte DEVMODE_COMMAND_CONNECT = 1;\nconstexpr kj::byte RunBundleMain::DEVMODE_COMMAND_CONNECT;\n\n[[noreturn]] void runDevSession(const Config& config, kj::AutoCloseFd internalFd) {\n    auto exception = kj::runCatchingExceptions([&]() {\n      // When someone connects, we expect them to pass us a one-byte command code.\n      kj::byte commandCode;\n      kj::FdInputStream((int)internalFd).read(&commandCode, 1);\n\n      KJ_REQUIRE(commandCode == DEVMODE_COMMAND_CONNECT);\n      context.warning(\"** Accepted new dev session connection...\");\n\n      // OK, we're accepting a new dev mode connection. `internalFd` is the socket opened by\n      // the `sandstorm dev` command, implemented elsewhere in this file. All it does is pass\n      // us the file descriptor originally provided by its invoker (i.e. from the `spk` tool).\n      // So get that, then discard internalFd.\n      auto fd = receiveFd(internalFd);\n      internalFd = nullptr;\n\n      // Dev error log goes to the connected session.\n      KJ_SYSCALL(dup2(fd, STDOUT_FILENO));\n      KJ_SYSCALL(dup2(fd, STDERR_FILENO));\n\n      // Restore SIGCHLD, ignored by parent process.\n      KJ_SYSCALL(signal(SIGCHLD, SIG_DFL));\n\n      kj::FdInputStream rawInput((int)fd);\n      kj::BufferedInputStreamWrapper input(rawInput);\n      kj::String appId;\n      KJ_IF_MAYBE(line, readLine(input)) {\n        appId = kj::mv(*line);\n      } else {\n        KJ_FAIL_ASSERT(\"Expected app ID.\");\n      }\n\n      bool mountProc = false;\n      KJ_IF_MAYBE(line, readLine(input)) {\n        kj::String mountProcLine = kj::mv(*line);\n        if (mountProcLine == \"1\") {\n          mountProc = true;\n        }\n      } else {\n        KJ_FAIL_ASSERT(\"Expected value of '1' or '0' for mountProc.\");\n      }\n\n      for (char c: appId) {\n        if (!isalnum(c)) {\n          context.exitError(\"Invalid app ID. Must contain only alphanumerics.\");\n        }\n      }\n\n      char dir[] = \"/var/sandstorm/apps/dev-XXXXXX\";\n      if (mkdtemp(dir) == nullptr) {\n        KJ_FAIL_SYSCALL(\"mkdtemp(dir)\", errno, dir);\n      }\n      KJ_DEFER(rmdir(dir));\n      if (runningAsRoot) { KJ_SYSCALL(chown(dir, config.uids.uid, config.uids.gid)); }\n\n      char* pkgId = strrchr(dir, '/') + 1;\n\n      // We dont use fusermount(1) because it doesn't live in our namespace. For now, this is not\n      // a problem because we're root anyway. If in the future we use UID namespaces to avoid being\n      // root, then this gets complicated. We could include fusermount(1) in our package, but\n      // it would have to be suid-root, defeating the goal of not using root rights.\n      auto fuseFd = raiiOpen(\"/dev/fuse\", O_RDWR);\n\n      auto mountOptions = kj::str(\"fd=\", fuseFd, \",rootmode=40000,\"\n          \"user_id=\", config.uids.uid, \",group_id=\", config.uids.gid, \",allow_other\");\n\n      KJ_SYSCALL(mount(\"/dev/fuse\", dir, \"fuse\", MS_NOSUID|MS_NODEV, mountOptions.cStr()));\n      KJ_DEFER(umount2(dir, MNT_FORCE | UMOUNT_NOFOLLOW));\n\n      // Send the FUSE fd back to the client.\n      sendFd(fd, fuseFd);\n      fuseFd = nullptr;\n\n      capnp::ReaderOptions manifestLimits;\n      manifestLimits.traversalLimitInWords = spk::Manifest::SIZE_LIMIT_IN_WORDS;\n\n      {\n        // Read the manifest.\n        capnp::StreamFdMessageReader reader(\n            raiiOpen(kj::str(dir, \"/sandstorm-manifest\"), O_RDONLY), manifestLimits);\n\n        // Notify the front-end that the app exists.\n        insertDevPackage(config, appId, mountProc, pkgId, reader.getRoot<spk::Manifest>());\n      }\n\n      {\n        KJ_DEFER(removeDevPackage(config, pkgId));\n\n        for (;;) {\n          KJ_IF_MAYBE(line, readLine(input)) {\n            if (*line == \"restart\") {\n              // Re-read the manifest.\n              capnp::StreamFdMessageReader reader(\n                  raiiOpen(kj::str(dir, \"/sandstorm-manifest\"), O_RDONLY), manifestLimits);\n\n              // Notify front-end that the app changed.\n              updateDevPackage(config, pkgId, reader.getRoot<spk::Manifest>());\n            }\n          } else {\n            break;\n          }\n        }\n      }\n    });\n\n    KJ_IF_MAYBE(e, exception) {\n      context.exitError(kj::str(*e));\n    } else {\n      context.exit();\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "connFd"
          ],
          "line": 2749
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fork",
          "args": [],
          "line": 2747
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "connFd_ = accept4(sock, nullptr, nullptr, SOCK_CLOEXEC)"
          ],
          "line": 2744
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "accept4",
          "args": [
            "sock",
            "nullptr",
            "nullptr",
            "SOCK_CLOEXEC"
          ],
          "line": 2744
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "signal(SIGPIPE, SIG_IGN)"
          ],
          "line": 2740
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signal",
          "args": [
            "SIGPIPE",
            "SIG_IGN"
          ],
          "line": 2740
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "signal(SIGCHLD, SIG_IGN)"
          ],
          "line": 2737
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signal",
          "args": [
            "SIGCHLD",
            "SIG_IGN"
          ],
          "line": 2737
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chmod(\"/var/sandstorm/socket/devmode\", 0770)"
          ],
          "line": 2734
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chmod",
          "args": [
            "\"/var/sandstorm/socket/devmode\"",
            "0770"
          ],
          "line": 2734
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chown(\"/var/sandstorm/socket/devmode\", 0, config.uids.gid)"
          ],
          "line": 2733
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chown",
          "args": [
            "\"/var/sandstorm/socket/devmode\"",
            "0",
            "config.uids.gid"
          ],
          "line": 2733
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "listen(sock, 2)"
          ],
          "line": 2730
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "listen",
          "args": [
            "sock",
            "2"
          ],
          "line": 2730
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "bind(sock, reinterpret_cast<struct sockaddr*>(&addr), sizeof(addr))"
          ],
          "line": 2729
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bind",
          "args": [
            "sock",
            "reinterpret_cast<struct sockaddr*>(&addr)",
            "sizeof(addr)"
          ],
          "line": 2729
        },
        "resolved": true,
        "details": {
          "function_name": "bind",
          "container": "SupervisorMain",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/supervisor.c++",
          "lines": "708-716",
          "snippet": "void SupervisorMain::bind(kj::StringPtr src, kj::StringPtr dst, unsigned long flags) {\n  // Contrary to the documentation of MS_BIND claiming this is no longer the case after 2.6.26,\n  // mountflags are ignored on the initial bind.  We have to issue a subsequent remount to set\n  // them.\n  KJ_SYSCALL(mount(src.cStr(), dst.cStr(), nullptr, MS_BIND, nullptr), src, dst);\n  KJ_SYSCALL(mount(src.cStr(), dst.cStr(), nullptr,\n                   MS_BIND | MS_REMOUNT | MS_NOSUID | flags, nullptr),\n      src, dst);\n}",
          "includes": [
            "#include \"util.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <sandstorm/supervisor.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <seccomp.h>",
            "#include <sys/resource.h>",
            "#include <sys/eventfd.h>",
            "#include <linux/rtnetlink.h>",
            "#include <linux/netlink.h>",
            "#include <execinfo.h>",
            "#include <unordered_map>",
            "#include <map>",
            "#include <sys/inotify.h>",
            "#include <grp.h>",
            "#include <pwd.h>",
            "#include <dirent.h>",
            "#include <sched.h>",
            "#include <limits.h>",
            "#include <stdlib.h>",
            "#include <errno.h>",
            "#include <fcntl.h>",
            "#include <linux/netfilter/nf_nat.h>",
            "#include <sandstorm/ip_tables.h>  // created by Makefile from <linux/netfilter_ipv4/ip_tables.h>",
            "#include <linux/route.h>",
            "#include <linux/sockios.h>",
            "#include <sys/syscall.h>",
            "#include <sys/ptrace.h>",
            "#include <sys/capability.h>",
            "#include <sys/prctl.h>",
            "#include <sys/mount.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <sys/wait.h>",
            "#include <sys/time.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <netinet/in.h> // needs to be included before sys/capability.h",
            "#include <unistd.h>",
            "#include <capnp/rpc.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/io.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/async-io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>",
            "#include \"supervisor.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <sandstorm/supervisor.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <seccomp.h>\n#include <sys/resource.h>\n#include <sys/eventfd.h>\n#include <linux/rtnetlink.h>\n#include <linux/netlink.h>\n#include <execinfo.h>\n#include <unordered_map>\n#include <map>\n#include <sys/inotify.h>\n#include <grp.h>\n#include <pwd.h>\n#include <dirent.h>\n#include <sched.h>\n#include <limits.h>\n#include <stdlib.h>\n#include <errno.h>\n#include <fcntl.h>\n#include <linux/netfilter/nf_nat.h>\n#include <sandstorm/ip_tables.h>  // created by Makefile from <linux/netfilter_ipv4/ip_tables.h>\n#include <linux/route.h>\n#include <linux/sockios.h>\n#include <sys/syscall.h>\n#include <sys/ptrace.h>\n#include <sys/capability.h>\n#include <sys/prctl.h>\n#include <sys/mount.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <sys/wait.h>\n#include <sys/time.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <netinet/in.h> // needs to be included before sys/capability.h\n#include <unistd.h>\n#include <capnp/rpc.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/io.h>\n#include <kj/async-unix.h>\n#include <kj/async-io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n#include \"supervisor.h\"\n\nSupervisorMain {\n  void SupervisorMain::bind(kj::StringPtr src, kj::StringPtr dst, unsigned long flags) {\n    // Contrary to the documentation of MS_BIND claiming this is no longer the case after 2.6.26,\n    // mountflags are ignored on the initial bind.  We have to issue a subsequent remount to set\n    // them.\n    KJ_SYSCALL(mount(src.cStr(), dst.cStr(), nullptr, MS_BIND, nullptr), src, dst);\n    KJ_SYSCALL(mount(src.cStr(), dst.cStr(), nullptr,\n                     MS_BIND | MS_REMOUNT | MS_NOSUID | flags, nullptr),\n        src, dst);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "reinterpret_cast<struct sockaddr*>",
          "args": [
            "&addr"
          ],
          "line": 2729
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "addr.sun_path"
          ],
          "line": 2728
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcpy",
          "args": [
            "addr.sun_path",
            "\"/var/sandstorm/socket/devmode\""
          ],
          "line": 2727
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&addr",
            "0",
            "sizeof(addr)"
          ],
          "line": 2725
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::AutoCloseFd",
          "args": [
            "sock_"
          ],
          "line": 2722
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sock_ = socket(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0)"
          ],
          "line": 2721
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "socket",
          "args": [
            "AF_UNIX",
            "SOCK_STREAM | SOCK_CLOEXEC",
            "0"
          ],
          "line": 2721
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"mkdir(/var/sandstorm/socket)\"",
            "error"
          ],
          "line": 2715
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chown(\"/var/sandstorm/socket\", 0, config.uids.gid)"
          ],
          "line": 2711
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chown",
          "args": [
            "\"/var/sandstorm/socket\"",
            "0",
            "config.uids.gid"
          ],
          "line": 2711
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "\"/var/sandstorm/socket\"",
            "0770"
          ],
          "line": 2709
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "clearDevPackages",
          "args": [
            "config"
          ],
          "line": 2706
        },
        "resolved": true,
        "details": {
          "function_name": "clearDevPackages",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2924-2927",
          "snippet": "void clearDevPackages(const Config& config) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\"db.devpackages.remove({})\"));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid clearDevPackages(const Config& config) {\n    FdBundle fakeBundle(nullptr);\n    mongoCommand(config, fakeBundle, kj::str(\"db.devpackages.remove({})\"));\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\n[[noreturn]] void runDevDaemon(const Config& config) {\n    clearDevPackages(config);\n\n    // Make sure socket directory exists (since the installer doesn't create it).\n    if (mkdir(\"/var/sandstorm/socket\", 0770) == 0) {\n      // Allow group to use this directory.\n      if (runningAsRoot) { KJ_SYSCALL(chown(\"/var/sandstorm/socket\", 0, config.uids.gid)); }\n    } else {\n      int error = errno;\n      if (error != EEXIST) {\n        KJ_FAIL_SYSCALL(\"mkdir(/var/sandstorm/socket)\", error);\n      }\n    }\n\n    // Create the devmode socket.\n    int sock_;\n    KJ_SYSCALL(sock_ = socket(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0));\n    auto sock = kj::AutoCloseFd(sock_);\n\n    struct sockaddr_un addr;\n    memset(&addr, 0, sizeof(addr));\n    addr.sun_family = AF_UNIX;\n    strcpy(addr.sun_path, \"/var/sandstorm/socket/devmode\");\n    unlink(addr.sun_path);\n    KJ_SYSCALL(bind(sock, reinterpret_cast<struct sockaddr*>(&addr), sizeof(addr)));\n    KJ_SYSCALL(listen(sock, 2));\n\n    // Ensure that the group can connect to the socket.\n    if (runningAsRoot) { KJ_SYSCALL(chown(\"/var/sandstorm/socket/devmode\", 0, config.uids.gid)); }\n    KJ_SYSCALL(chmod(\"/var/sandstorm/socket/devmode\", 0770));\n\n    // We don't care to reap dev sessions.\n    KJ_SYSCALL(signal(SIGCHLD, SIG_IGN));\n\n    // Please don't SIGPIPE if we write to a disconnected socket. An exception is nicer.\n    KJ_SYSCALL(signal(SIGPIPE, SIG_IGN));\n\n    for (;;) {\n      int connFd_;\n      KJ_SYSCALL(connFd_ = accept4(sock, nullptr, nullptr, SOCK_CLOEXEC));\n      kj::AutoCloseFd connFd(connFd_);\n\n      if (fork() == 0) {\n        sock = nullptr;\n        runDevSession(config, kj::mv(connFd));\n        KJ_UNREACHABLE;\n      }\n    }\n  }"
  },
  {
    "function_name": "connectToDevDaemon",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2691-2703",
    "snippet": "kj::AutoCloseFd connectToDevDaemon() {\n    int sock_;\n    KJ_SYSCALL(sock_ = socket(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0));\n    auto sock = kj::AutoCloseFd(sock_);\n\n    struct sockaddr_un addr;\n    memset(&addr, 0, sizeof(addr));\n    addr.sun_family = AF_UNIX;\n    strcpy(addr.sun_path, \"../var/sandstorm/socket/devmode\");\n    KJ_SYSCALL(connect(sock, reinterpret_cast<struct sockaddr*>(&addr), sizeof(addr)));\n\n    return kj::mv(sock);\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "sock"
          ],
          "line": 2702
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "connect(sock, reinterpret_cast<struct sockaddr*>(&addr), sizeof(addr))"
          ],
          "line": 2700
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "connect",
          "args": [
            "sock",
            "reinterpret_cast<struct sockaddr*>(&addr)",
            "sizeof(addr)"
          ],
          "line": 2700
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reinterpret_cast<struct sockaddr*>",
          "args": [
            "&addr"
          ],
          "line": 2700
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcpy",
          "args": [
            "addr.sun_path",
            "\"../var/sandstorm/socket/devmode\""
          ],
          "line": 2699
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&addr",
            "0",
            "sizeof(addr)"
          ],
          "line": 2697
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::AutoCloseFd",
          "args": [
            "sock_"
          ],
          "line": 2694
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sock_ = socket(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0)"
          ],
          "line": 2693
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "socket",
          "args": [
            "AF_UNIX",
            "SOCK_STREAM | SOCK_CLOEXEC",
            "0"
          ],
          "line": 2693
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::AutoCloseFd connectToDevDaemon() {\n    int sock_;\n    KJ_SYSCALL(sock_ = socket(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0));\n    auto sock = kj::AutoCloseFd(sock_);\n\n    struct sockaddr_un addr;\n    memset(&addr, 0, sizeof(addr));\n    addr.sun_family = AF_UNIX;\n    strcpy(addr.sun_path, \"../var/sandstorm/socket/devmode\");\n    KJ_SYSCALL(connect(sock, reinterpret_cast<struct sockaddr*>(&addr), sizeof(addr)));\n\n    return kj::mv(sock);\n  }"
  },
  {
    "function_name": "setOwnerGroupAndMode",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2686-2689",
    "snippet": "void setOwnerGroupAndMode(const kj::String& path, mode_t mode, uid_t owner, uid_t group) {\n    KJ_SYSCALL(chmod(path.cStr(), mode));\n    KJ_SYSCALL(chown(path.cStr(), owner, group));\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chown(path.cStr(), owner, group)"
          ],
          "line": 2688
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chown",
          "args": [
            "path.cStr()",
            "owner",
            "group"
          ],
          "line": 2688
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.cStr",
          "args": [],
          "line": 2688
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chmod(path.cStr(), mode)"
          ],
          "line": 2687
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chmod",
          "args": [
            "path.cStr()",
            "mode"
          ],
          "line": 2687
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.cStr",
          "args": [],
          "line": 2687
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid setOwnerGroupAndMode(const kj::String& path, mode_t mode, uid_t owner, uid_t group) {\n    KJ_SYSCALL(chmod(path.cStr(), mode));\n    KJ_SYSCALL(chown(path.cStr(), owner, group));\n  }"
  },
  {
    "function_name": "fixSandcatsPermissions",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2656-2684",
    "snippet": "void fixSandcatsPermissions(const Config& config) {\n    // An older version of the sandcats installer left various sandcats-related files around owned\n    // by root, rather than the sandstorm server user.\n    // var/sandcats should be 0700, with corrected owner/group\n    if (access(\"../var/sandcats\", F_OK) == 0) {\n        setOwnerGroupAndMode(kj::str(\"../var/sandcats\"), 0700, config.uids.uid, config.uids.gid);\n    }\n\n    // Same issue with https directory & its subdirectories.\n    kj::String httpsBaseDir = kj::str(\"../var/sandcats/https\");\n    if (access(httpsBaseDir.cStr(), F_OK) == 0) {\n      setOwnerGroupAndMode(httpsBaseDir, 0700, config.uids.uid, config.uids.gid);\n\n      kj::Array<kj::String> entries = listDirectory(kj::str(httpsBaseDir));\n      for (size_t i = 0; i < entries.size(); i++) {\n        setOwnerGroupAndMode(kj::str(httpsBaseDir, \"/\", entries[i]), 0700, config.uids.uid, config.uids.gid);\n      }\n    }\n\n    // var/sandcats/{register-log,id_rsa{,.pub,private_combined}} should each be 0640, with corrected\n    // owner/group\n    static const char* const files[] = {\"register-log\", \"id_rsa\", \"id_rsa.pub\", \"id_rsa.private_combined\"};\n    for (auto f : files) {\n      auto path = kj::str(\"../var/sandcats/\", f);\n      if (access(path.cStr(), F_OK) == 0) {\n        setOwnerGroupAndMode(path, 0640, config.uids.uid, config.uids.gid);\n      }\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "setOwnerGroupAndMode",
          "args": [
            "path",
            "0640",
            "config.uids.uid",
            "config.uids.gid"
          ],
          "line": 2681
        },
        "resolved": true,
        "details": {
          "function_name": "setOwnerGroupAndMode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2686-2689",
          "snippet": "void setOwnerGroupAndMode(const kj::String& path, mode_t mode, uid_t owner, uid_t group) {\n    KJ_SYSCALL(chmod(path.cStr(), mode));\n    KJ_SYSCALL(chown(path.cStr(), owner, group));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid setOwnerGroupAndMode(const kj::String& path, mode_t mode, uid_t owner, uid_t group) {\n    KJ_SYSCALL(chmod(path.cStr(), mode));\n    KJ_SYSCALL(chown(path.cStr(), owner, group));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "path.cStr()",
            "F_OK"
          ],
          "line": 2680
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.cStr",
          "args": [],
          "line": 2680
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"../var/sandcats/\"",
            "f"
          ],
          "line": 2679
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "httpsBaseDir",
            "\"/\"",
            "entries[i]"
          ],
          "line": 2671
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "entries.size",
          "args": [],
          "line": 2670
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "listDirectory",
          "args": [
            "kj::str(httpsBaseDir)"
          ],
          "line": 2669
        },
        "resolved": true,
        "details": {
          "function_name": "listDirectoryFd",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "292-297",
          "snippet": "kj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "httpsBaseDir"
          ],
          "line": 2669
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "httpsBaseDir.cStr()",
            "F_OK"
          ],
          "line": 2666
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "httpsBaseDir.cStr",
          "args": [],
          "line": 2666
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"../var/sandcats/https\""
          ],
          "line": 2665
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"../var/sandcats\""
          ],
          "line": 2661
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"../var/sandcats\"",
            "F_OK"
          ],
          "line": 2660
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid fixSandcatsPermissions(const Config& config) {\n    // An older version of the sandcats installer left various sandcats-related files around owned\n    // by root, rather than the sandstorm server user.\n    // var/sandcats should be 0700, with corrected owner/group\n    if (access(\"../var/sandcats\", F_OK) == 0) {\n        setOwnerGroupAndMode(kj::str(\"../var/sandcats\"), 0700, config.uids.uid, config.uids.gid);\n    }\n\n    // Same issue with https directory & its subdirectories.\n    kj::String httpsBaseDir = kj::str(\"../var/sandcats/https\");\n    if (access(httpsBaseDir.cStr(), F_OK) == 0) {\n      setOwnerGroupAndMode(httpsBaseDir, 0700, config.uids.uid, config.uids.gid);\n\n      kj::Array<kj::String> entries = listDirectory(kj::str(httpsBaseDir));\n      for (size_t i = 0; i < entries.size(); i++) {\n        setOwnerGroupAndMode(kj::str(httpsBaseDir, \"/\", entries[i]), 0700, config.uids.uid, config.uids.gid);\n      }\n    }\n\n    // var/sandcats/{register-log,id_rsa{,.pub,private_combined}} should each be 0640, with corrected\n    // owner/group\n    static const char* const files[] = {\"register-log\", \"id_rsa\", \"id_rsa.pub\", \"id_rsa.private_combined\"};\n    for (auto f : files) {\n      auto path = kj::str(\"../var/sandcats/\", f);\n      if (access(path.cStr(), F_OK) == 0) {\n        setOwnerGroupAndMode(path, 0640, config.uids.uid, config.uids.gid);\n      }\n    }\n  }"
  },
  {
    "function_name": "cleanupOldVersions",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2627-2654",
    "snippet": "void cleanupOldVersions() {\n    for (auto& file: listDirectory(\"..\")) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        if (file.startsWith(\"sandstorm-\")) {\n          auto suffix = file.slice(strlen(\"sandstorm-\"));\n          if (suffix.startsWith(\"custom.\")) {\n            // This is a custom build. If we aren't currently running a custom build, go ahead and\n            // delete it.\n            if (SANDSTORM_BUILD != 0) {\n              recursivelyDelete(kj::str(\"../\", file));\n            }\n          } else KJ_IF_MAYBE(build, parseUInt(suffix, 10)) {\n            // Only delete older builds.\n            if (*build < SANDSTORM_BUILD) {\n              KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n                recursivelyDelete(kj::str(\"../\", file));\n              })) {\n                context.warning(kj::str(\"couldn't delete old build \", file, \": \",\n                                        exception->getDescription()));\n              }\n            }\n          }\n        }\n      })) {\n        KJ_LOG(ERROR, \"Error while trying to delete old versions.\", *exception);\n      }\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_LOG",
          "args": [
            "ERROR",
            "\"Error while trying to delete old versions.\"",
            "*exception"
          ],
          "line": 2651
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "exception",
            "kj::runCatchingExceptions([&]() {\n        if (file.startsWith(\"sandstorm-\")) {\n          auto suffix = file.slice(strlen(\"sandstorm-\"));\n          if (suffix.startsWith(\"custom.\")) {\n            // This is a custom build. If we aren't currently running a custom build, go ahead and\n            // delete it.\n            if (SANDSTORM_BUILD != 0) {\n              recursivelyDelete(kj::str(\"../\", file));\n            }\n          } else KJ_IF_MAYBE(build, parseUInt(suffix, 10)) {\n            // Only delete older builds.\n            if (*build < SANDSTORM_BUILD) {\n              KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n                recursivelyDelete(kj::str(\"../\", file));\n              })) {\n                context.warning(kj::str(\"couldn't delete old build \", file, \": \",\n                                        exception->getDescription()));\n              }\n            }\n          }\n        }\n      })"
          ],
          "line": 2629
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1662-1665",
          "snippet": "KJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }"
        }
      },
      {
        "call_info": {
          "callee": "kj::runCatchingExceptions",
          "args": [
            "[&]() {\n        if (file.startsWith(\"sandstorm-\")) {\n          auto suffix = file.slice(strlen(\"sandstorm-\"));\n          if (suffix.startsWith(\"custom.\")) {\n            // This is a custom build. If we aren't currently running a custom build, go ahead and\n            // delete it.\n            if (SANDSTORM_BUILD != 0) {\n              recursivelyDelete(kj::str(\"../\", file));\n            }\n          } else KJ_IF_MAYBE(build, parseUInt(suffix, 10)) {\n            // Only delete older builds.\n            if (*build < SANDSTORM_BUILD) {\n              KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n                recursivelyDelete(kj::str(\"../\", file));\n              })) {\n                context.warning(kj::str(\"couldn't delete old build \", file, \": \",\n                                        exception->getDescription()));\n              }\n            }\n          }\n        }\n      }"
          ],
          "line": 2629
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\"couldn't delete old build \", file, \": \",\n                                        exception->getDescription())"
          ],
          "line": 2644
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"couldn't delete old build \"",
            "file",
            "\": \"",
            "exception->getDescription()"
          ],
          "line": 2644
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "exception->getDescription",
          "args": [],
          "line": 2645
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::runCatchingExceptions",
          "args": [
            "[&]() {\n                recursivelyDelete(kj::str(\"../\", file));\n              }"
          ],
          "line": 2641
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "recursivelyDelete",
          "args": [
            "kj::str(\"../\", file)"
          ],
          "line": 2642
        },
        "resolved": true,
        "details": {
          "function_name": "recursivelyDelete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "299-313",
          "snippet": "void recursivelyDelete(kj::StringPtr path) {\n  KJ_REQUIRE(!path.endsWith(\"/\"),\n      \"refusing to recursively delete directory name with trailing / to reduce risk of \"\n      \"catastrophic empty-string bugs\");\n  struct stat stats;\n  KJ_SYSCALL(lstat(path.cStr(), &stats), path) { return; }\n  if (S_ISDIR(stats.st_mode)) {\n    for (auto& file: listDirectory(path)) {\n      recursivelyDelete(kj::str(path, \"/\", file));\n    }\n    KJ_SYSCALL(rmdir(path.cStr()), path) { break; }\n  } else {\n    KJ_SYSCALL(unlink(path.cStr()), path) { break; }\n  }\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nvoid recursivelyDelete(kj::StringPtr path) {\n  KJ_REQUIRE(!path.endsWith(\"/\"),\n      \"refusing to recursively delete directory name with trailing / to reduce risk of \"\n      \"catastrophic empty-string bugs\");\n  struct stat stats;\n  KJ_SYSCALL(lstat(path.cStr(), &stats), path) { return; }\n  if (S_ISDIR(stats.st_mode)) {\n    for (auto& file: listDirectory(path)) {\n      recursivelyDelete(kj::str(path, \"/\", file));\n    }\n    KJ_SYSCALL(rmdir(path.cStr()), path) { break; }\n  } else {\n    KJ_SYSCALL(unlink(path.cStr()), path) { break; }\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"../\"",
            "file"
          ],
          "line": 2642
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "parseUInt",
          "args": [
            "suffix",
            "10"
          ],
          "line": 2638
        },
        "resolved": true,
        "details": {
          "function_name": "parseUInt64",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "223-230",
          "snippet": "kj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"../\"",
            "file"
          ],
          "line": 2636
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "suffix.startsWith",
          "args": [
            "\"custom.\""
          ],
          "line": 2632
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "file.slice",
          "args": [
            "strlen(\"sandstorm-\")"
          ],
          "line": 2631
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "\"sandstorm-\""
          ],
          "line": 2631
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "file.startsWith",
          "args": [
            "\"sandstorm-\""
          ],
          "line": 2630
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "listDirectory",
          "args": [
            "\"..\""
          ],
          "line": 2628
        },
        "resolved": true,
        "details": {
          "function_name": "listDirectoryFd",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "292-297",
          "snippet": "kj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid cleanupOldVersions() {\n    for (auto& file: listDirectory(\"..\")) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        if (file.startsWith(\"sandstorm-\")) {\n          auto suffix = file.slice(strlen(\"sandstorm-\"));\n          if (suffix.startsWith(\"custom.\")) {\n            // This is a custom build. If we aren't currently running a custom build, go ahead and\n            // delete it.\n            if (SANDSTORM_BUILD != 0) {\n              recursivelyDelete(kj::str(\"../\", file));\n            }\n          } else KJ_IF_MAYBE(build, parseUInt(suffix, 10)) {\n            // Only delete older builds.\n            if (*build < SANDSTORM_BUILD) {\n              KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n                recursivelyDelete(kj::str(\"../\", file));\n              })) {\n                context.warning(kj::str(\"couldn't delete old build \", file, \": \",\n                                        exception->getDescription()));\n              }\n            }\n          }\n        }\n      })) {\n        KJ_LOG(ERROR, \"Error while trying to delete old versions.\", *exception);\n      }\n    }\n  }"
  },
  {
    "function_name": "restartForUpdate",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2602-2625",
    "snippet": "[[noreturn]] void restartForUpdate(int pidfileFd, FdBundle& fdBundle) {\n    // Change pidfile to not close on exec, since we want it to live through the following exec!\n    KJ_SYSCALL(fcntl(pidfileFd, F_SETFD, 0));\n\n    auto inheritArgs = fdBundle.prepareForContinue();\n\n    // Create arg list.\n    kj::Vector<const char*> argv;\n    argv.add(\"../latest/sandstorm\");\n    argv.add(\"continue\");\n    if (unsharedUidNamespace) {\n      argv.add(\"--userns\");\n    }\n    auto pidfileFdStr = kj::str(pidfileFd);\n    argv.add(pidfileFdStr.cStr());\n    for (auto& a: inheritArgs) {\n      argv.add(a.cStr());\n    }\n    argv.add(EXEC_END_ARGS);\n\n    // Exec the new version with our magic \"continue\".\n    KJ_SYSCALL(execv(argv[0], const_cast<char**>(argv.begin())));\n    KJ_UNREACHABLE;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool unsharedUidNamespace = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "execv(argv[0], const_cast<char**>(argv.begin()))"
          ],
          "line": 2623
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "execv",
          "args": [
            "argv[0]",
            "const_cast<char**>(argv.begin())"
          ],
          "line": 2623
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "const_cast<char**>",
          "args": [
            "argv.begin()"
          ],
          "line": 2623
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "argv.begin",
          "args": [],
          "line": 2623
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "argv.add",
          "args": [
            "EXEC_END_ARGS"
          ],
          "line": 2620
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "argv.add",
          "args": [
            "a.cStr()"
          ],
          "line": 2618
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "a.cStr",
          "args": [],
          "line": 2618
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "argv.add",
          "args": [
            "pidfileFdStr.cStr()"
          ],
          "line": 2616
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pidfileFdStr.cStr",
          "args": [],
          "line": 2616
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "pidfileFd"
          ],
          "line": 2615
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "argv.add",
          "args": [
            "\"--userns\""
          ],
          "line": 2613
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "argv.add",
          "args": [
            "\"continue\""
          ],
          "line": 2611
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "argv.add",
          "args": [
            "\"../latest/sandstorm\""
          ],
          "line": 2610
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fdBundle.prepareForContinue",
          "args": [],
          "line": 2606
        },
        "resolved": true,
        "details": {
          "function_name": "prepareForContinue",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1697-1704",
          "snippet": "kj::Array<kj::String> prepareForContinue() {\n      auto args = kj::heapArrayBuilder<kj::String>(ports.size());\n      for (auto& port: ports) {\n        args.add(kj::str(port.second.fd.get(), \":tcp:\", port.first));\n        KJ_SYSCALL(ioctl(port.second.fd, FIONCLEX));\n      }\n      return args.finish();\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  kj::Array<kj::String> prepareForContinue() {\n        auto args = kj::heapArrayBuilder<kj::String>(ports.size());\n        for (auto& port: ports) {\n          args.add(kj::str(port.second.fd.get(), \":tcp:\", port.first));\n          KJ_SYSCALL(ioctl(port.second.fd, FIONCLEX));\n        }\n        return args.finish();\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fcntl(pidfileFd, F_SETFD, 0)"
          ],
          "line": 2604
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fcntl",
          "args": [
            "pidfileFd",
            "F_SETFD",
            "0"
          ],
          "line": 2604
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool unsharedUidNamespace = false;\n\n[[noreturn]] void restartForUpdate(int pidfileFd, FdBundle& fdBundle) {\n    // Change pidfile to not close on exec, since we want it to live through the following exec!\n    KJ_SYSCALL(fcntl(pidfileFd, F_SETFD, 0));\n\n    auto inheritArgs = fdBundle.prepareForContinue();\n\n    // Create arg list.\n    kj::Vector<const char*> argv;\n    argv.add(\"../latest/sandstorm\");\n    argv.add(\"continue\");\n    if (unsharedUidNamespace) {\n      argv.add(\"--userns\");\n    }\n    auto pidfileFdStr = kj::str(pidfileFd);\n    argv.add(pidfileFdStr.cStr());\n    for (auto& a: inheritArgs) {\n      argv.add(a.cStr());\n    }\n    argv.add(EXEC_END_ARGS);\n\n    // Exec the new version with our magic \"continue\".\n    KJ_SYSCALL(execv(argv[0], const_cast<char**>(argv.begin())));\n    KJ_UNREACHABLE;\n  }"
  },
  {
    "function_name": "doUpdateLoop",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2563-2600",
    "snippet": "[[noreturn]] void doUpdateLoop(kj::StringPtr channel, bool isRetry, const Config& config) {\n    // This is the updater process.  Run in a loop.\n    auto log = raiiOpen(\"../var/log/updater.log\", O_WRONLY | O_APPEND | O_CREAT);\n    KJ_SYSCALL(dup2(log, STDOUT_FILENO));\n    KJ_SYSCALL(dup2(log, STDERR_FILENO));\n\n    // Wait 10 minutes before the first update attempt just to make sure the server isn't going\n    // to be shut down right away.  (On a retry, wait an hour so we don't overwhelm the servers\n    // when a broken package is posted.)\n    uint n = isRetry ? 3600 : 600;\n    while (n > 0) n = sleep(n);\n\n    // The 10-minute request is called \"startup\" while subsequent daily requests are called \"daily\".\n    // We signal retries separately so that the server can monitor for flapping clients.\n    kj::StringPtr type = isRetry ? \"retry\" : \"startup\";\n\n    for (;;) {\n      // Print time.\n      time_t start = time(nullptr);\n      context.warning(kj::str(\"** Time: \", ctime(&start)));\n\n      // Check for updates.\n      if (checkForUpdates(channel, type, config)) {\n        // Exit so that the update can be applied.\n        context.exitInfo(\"** Successfully updated; restarting.\");\n      }\n\n      // Wait a day.  We actually wait 10 minutes at a time, then check if a day has passed, to\n      // capture cases where the system was suspended.\n      for (;;) {\n        n = 600;\n        while (n > 0) n = sleep(n);\n        if (time(nullptr) - start >= 86400) break;\n      }\n\n      type = \"daily\";\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "time",
          "args": [
            "nullptr"
          ],
          "line": 2595
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sleep",
          "args": [
            "n"
          ],
          "line": 2594
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "\"** Successfully updated; restarting.\""
          ],
          "line": 2587
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "checkForUpdates",
          "args": [
            "channel",
            "type",
            "config"
          ],
          "line": 2585
        },
        "resolved": true,
        "details": {
          "function_name": "checkForUpdates",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2415-2481",
          "snippet": "bool checkForUpdates(kj::StringPtr channel, kj::StringPtr type, const Config& config) {\n    // GET install.sandstorm.io/$channel?from=$oldBuild&type=[manual|startup|daily]\n    //     -> result is build number\n    context.warning(kj::str(\"Checking for updates on channel \", channel, \"...\"));\n\n    kj::String buildStr;\n\n    {\n      kj::String from;\n      if (SANDSTORM_BUILD > 0) {\n        from = kj::str(\"from=\", SANDSTORM_BUILD, \"&\");\n      }\n\n      CurlRequest updateCheck(\n          kj::str(\"https://install.sandstorm.io/\", channel, \"?\", from, \"type=\", type));\n      buildStr = readAll(updateCheck.getPipe());\n    }\n\n    uint targetBuild = KJ_ASSERT_NONNULL(parseUInt(trim(buildStr), 10));\n\n    if (targetBuild <= SANDSTORM_BUILD) {\n      context.warning(\"No update available.\");\n      return false;\n    }\n\n    // Download bundle to temporary file.\n    auto url = kj::str(\"https://dl.sandstorm.io/sandstorm-\", targetBuild, \".tar.xz\");\n    auto file = openTemporary(\"/var/tmp/sandstorm-update\");\n    context.warning(kj::str(\"Downloading: \", url));\n    CurlRequest(url, file);\n    KJ_SYSCALL(lseek(file, 0, SEEK_SET));\n\n    // Verify signature.\n    {\n      context.warning(\"Checking signature...\");\n      KJ_ON_SCOPE_FAILURE(context.warning(\n          \"*** Aborting update because signature check failed! Most likely this is due to a \"\n          \"network glitch, but if you suspect an attack, notify security@sandstorm.io.\"));\n\n      // Download and parse signature file for this update.\n      capnp::StreamFdMessageReader signatureMessage(\n          CurlRequest(kj::str(url, \".update-sig\")).getPipe());\n      auto sigs = signatureMessage.getRoot<UpdateSignature>().getSignatures();\n\n      // Always verify using the *last* key in updatePublicKeys, as it is the most recent.\n      uint keyIndex = UPDATE_PUBLIC_KEYS->size() - 1;\n      PublicSigningKey::Reader key = (*UPDATE_PUBLIC_KEYS)[keyIndex];\n      KJ_ASSERT(sigs.size() > keyIndex,\n          \"signature is missing the most recent signing key\");\n      Signature::Reader signature = sigs[keyIndex];\n\n      // mmap the file and check the signature.\n      MemoryMapping mapping(file, \"(update tarball)\");\n      capnp::Data::Reader data = mapping;\n      KJ_ASSERT(crypto_sign_ed25519_verify_detached(\n          structToBytes(signature, crypto_sign_ed25519_BYTES),\n          data.begin(), data.size(),\n          structToBytes(key, crypto_sign_ed25519_PUBLICKEYBYTES)) == 0,\n          \"signature is invalid\");\n\n      context.warning(\"Signature is valid.\");\n    }\n\n    unpackUpdate(file, targetBuild);\n\n    return true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "else if (key == \"PORT\")",
            "else if (key == \"MONGO_PORT\")",
            "else if (key == \"BIND_IP\")",
            "else if (key == \"BASE_URL\")",
            "else if (key == \"WILDCARD_HOST\")",
            "else if (key == \"WILDCARD_PARENT_URL\")",
            "else if (key == \"DDP_DEFAULT_CONNECTION_URL\")",
            "else if (key == \"MAIL_URL\")",
            "else if (key == \"UPDATE_CHANNEL\")",
            "else if (key == \"SANDCATS_BASE_DOMAIN\")",
            "else if (key == \"ALLOW_DEMO_ACCOUNTS\")",
            "else if (key == \"ALLOW_DEV_ACCOUNTS\")",
            "else if (key == \"IS_TESTING\")",
            "else if (key == \"HIDE_TROUBLESHOOTING\")",
            "else if (key == \"SMTP_LISTEN_PORT\")"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nelse if (key == \"PORT\");\nelse if (key == \"MONGO_PORT\");\nelse if (key == \"BIND_IP\");\nelse if (key == \"BASE_URL\");\nelse if (key == \"WILDCARD_HOST\");\nelse if (key == \"WILDCARD_PARENT_URL\");\nelse if (key == \"DDP_DEFAULT_CONNECTION_URL\");\nelse if (key == \"MAIL_URL\");\nelse if (key == \"UPDATE_CHANNEL\");\nelse if (key == \"SANDCATS_BASE_DOMAIN\");\nelse if (key == \"ALLOW_DEMO_ACCOUNTS\");\nelse if (key == \"ALLOW_DEV_ACCOUNTS\");\nelse if (key == \"IS_TESTING\");\nelse if (key == \"HIDE_TROUBLESHOOTING\");\nelse if (key == \"SMTP_LISTEN_PORT\");\n\nbool checkForUpdates(kj::StringPtr channel, kj::StringPtr type, const Config& config) {\n    // GET install.sandstorm.io/$channel?from=$oldBuild&type=[manual|startup|daily]\n    //     -> result is build number\n    context.warning(kj::str(\"Checking for updates on channel \", channel, \"...\"));\n\n    kj::String buildStr;\n\n    {\n      kj::String from;\n      if (SANDSTORM_BUILD > 0) {\n        from = kj::str(\"from=\", SANDSTORM_BUILD, \"&\");\n      }\n\n      CurlRequest updateCheck(\n          kj::str(\"https://install.sandstorm.io/\", channel, \"?\", from, \"type=\", type));\n      buildStr = readAll(updateCheck.getPipe());\n    }\n\n    uint targetBuild = KJ_ASSERT_NONNULL(parseUInt(trim(buildStr), 10));\n\n    if (targetBuild <= SANDSTORM_BUILD) {\n      context.warning(\"No update available.\");\n      return false;\n    }\n\n    // Download bundle to temporary file.\n    auto url = kj::str(\"https://dl.sandstorm.io/sandstorm-\", targetBuild, \".tar.xz\");\n    auto file = openTemporary(\"/var/tmp/sandstorm-update\");\n    context.warning(kj::str(\"Downloading: \", url));\n    CurlRequest(url, file);\n    KJ_SYSCALL(lseek(file, 0, SEEK_SET));\n\n    // Verify signature.\n    {\n      context.warning(\"Checking signature...\");\n      KJ_ON_SCOPE_FAILURE(context.warning(\n          \"*** Aborting update because signature check failed! Most likely this is due to a \"\n          \"network glitch, but if you suspect an attack, notify security@sandstorm.io.\"));\n\n      // Download and parse signature file for this update.\n      capnp::StreamFdMessageReader signatureMessage(\n          CurlRequest(kj::str(url, \".update-sig\")).getPipe());\n      auto sigs = signatureMessage.getRoot<UpdateSignature>().getSignatures();\n\n      // Always verify using the *last* key in updatePublicKeys, as it is the most recent.\n      uint keyIndex = UPDATE_PUBLIC_KEYS->size() - 1;\n      PublicSigningKey::Reader key = (*UPDATE_PUBLIC_KEYS)[keyIndex];\n      KJ_ASSERT(sigs.size() > keyIndex,\n          \"signature is missing the most recent signing key\");\n      Signature::Reader signature = sigs[keyIndex];\n\n      // mmap the file and check the signature.\n      MemoryMapping mapping(file, \"(update tarball)\");\n      capnp::Data::Reader data = mapping;\n      KJ_ASSERT(crypto_sign_ed25519_verify_detached(\n          structToBytes(signature, crypto_sign_ed25519_BYTES),\n          data.begin(), data.size(),\n          structToBytes(key, crypto_sign_ed25519_PUBLICKEYBYTES)) == 0,\n          \"signature is invalid\");\n\n      context.warning(\"Signature is valid.\");\n    }\n\n    unpackUpdate(file, targetBuild);\n\n    return true;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\"** Time: \", ctime(&start))"
          ],
          "line": 2582
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"** Time: \"",
            "ctime(&start)"
          ],
          "line": 2582
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctime",
          "args": [
            "&start"
          ],
          "line": 2582
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "time",
          "args": [
            "nullptr"
          ],
          "line": 2581
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sleep",
          "args": [
            "n"
          ],
          "line": 2573
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(log, STDERR_FILENO)"
          ],
          "line": 2567
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "log",
            "STDERR_FILENO"
          ],
          "line": 2567
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(log, STDOUT_FILENO)"
          ],
          "line": 2566
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "log",
            "STDOUT_FILENO"
          ],
          "line": 2566
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"../var/log/updater.log\"",
            "O_WRONLY | O_APPEND | O_CREAT"
          ],
          "line": 2565
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\n[[noreturn]] void doUpdateLoop(kj::StringPtr channel, bool isRetry, const Config& config) {\n    // This is the updater process.  Run in a loop.\n    auto log = raiiOpen(\"../var/log/updater.log\", O_WRONLY | O_APPEND | O_CREAT);\n    KJ_SYSCALL(dup2(log, STDOUT_FILENO));\n    KJ_SYSCALL(dup2(log, STDERR_FILENO));\n\n    // Wait 10 minutes before the first update attempt just to make sure the server isn't going\n    // to be shut down right away.  (On a retry, wait an hour so we don't overwhelm the servers\n    // when a broken package is posted.)\n    uint n = isRetry ? 3600 : 600;\n    while (n > 0) n = sleep(n);\n\n    // The 10-minute request is called \"startup\" while subsequent daily requests are called \"daily\".\n    // We signal retries separately so that the server can monitor for flapping clients.\n    kj::StringPtr type = isRetry ? \"retry\" : \"startup\";\n\n    for (;;) {\n      // Print time.\n      time_t start = time(nullptr);\n      context.warning(kj::str(\"** Time: \", ctime(&start)));\n\n      // Check for updates.\n      if (checkForUpdates(channel, type, config)) {\n        // Exit so that the update can be applied.\n        context.exitInfo(\"** Successfully updated; restarting.\");\n      }\n\n      // Wait a day.  We actually wait 10 minutes at a time, then check if a day has passed, to\n      // capture cases where the system was suspended.\n      for (;;) {\n        n = 600;\n        while (n > 0) n = sleep(n);\n        if (time(nullptr) - start >= 86400) break;\n      }\n\n      type = \"daily\";\n    }\n  }"
  },
  {
    "function_name": "startUpdater",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2544-2561",
    "snippet": "pid_t startUpdater(const Config& config, FdBundle& fdBundle, bool isRetry) {\n    if (config.updateChannel == nullptr) {\n      context.warning(\"WARNING: Auto-updates are disabled by config.\");\n      return 0;\n    } else if (access(\"..\", W_OK) != 0) {\n      context.warning(\"WARNING: Auto-updates are disabled because the server does not have write \"\n                      \"access to the installation location.\");\n      return 0;\n    } else {\n      pid_t pid = fork();\n      if (pid == 0) {\n        fdBundle.closeAll();\n        doUpdateLoop(config.updateChannel, isRetry, config);\n        KJ_UNREACHABLE;\n      }\n      return pid;\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "doUpdateLoop",
          "args": [
            "config.updateChannel",
            "isRetry",
            "config"
          ],
          "line": 2556
        },
        "resolved": true,
        "details": {
          "function_name": "doUpdateLoop",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2563-2600",
          "snippet": "[[noreturn]] void doUpdateLoop(kj::StringPtr channel, bool isRetry, const Config& config) {\n    // This is the updater process.  Run in a loop.\n    auto log = raiiOpen(\"../var/log/updater.log\", O_WRONLY | O_APPEND | O_CREAT);\n    KJ_SYSCALL(dup2(log, STDOUT_FILENO));\n    KJ_SYSCALL(dup2(log, STDERR_FILENO));\n\n    // Wait 10 minutes before the first update attempt just to make sure the server isn't going\n    // to be shut down right away.  (On a retry, wait an hour so we don't overwhelm the servers\n    // when a broken package is posted.)\n    uint n = isRetry ? 3600 : 600;\n    while (n > 0) n = sleep(n);\n\n    // The 10-minute request is called \"startup\" while subsequent daily requests are called \"daily\".\n    // We signal retries separately so that the server can monitor for flapping clients.\n    kj::StringPtr type = isRetry ? \"retry\" : \"startup\";\n\n    for (;;) {\n      // Print time.\n      time_t start = time(nullptr);\n      context.warning(kj::str(\"** Time: \", ctime(&start)));\n\n      // Check for updates.\n      if (checkForUpdates(channel, type, config)) {\n        // Exit so that the update can be applied.\n        context.exitInfo(\"** Successfully updated; restarting.\");\n      }\n\n      // Wait a day.  We actually wait 10 minutes at a time, then check if a day has passed, to\n      // capture cases where the system was suspended.\n      for (;;) {\n        n = 600;\n        while (n > 0) n = sleep(n);\n        if (time(nullptr) - start >= 86400) break;\n      }\n\n      type = \"daily\";\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\n[[noreturn]] void doUpdateLoop(kj::StringPtr channel, bool isRetry, const Config& config) {\n    // This is the updater process.  Run in a loop.\n    auto log = raiiOpen(\"../var/log/updater.log\", O_WRONLY | O_APPEND | O_CREAT);\n    KJ_SYSCALL(dup2(log, STDOUT_FILENO));\n    KJ_SYSCALL(dup2(log, STDERR_FILENO));\n\n    // Wait 10 minutes before the first update attempt just to make sure the server isn't going\n    // to be shut down right away.  (On a retry, wait an hour so we don't overwhelm the servers\n    // when a broken package is posted.)\n    uint n = isRetry ? 3600 : 600;\n    while (n > 0) n = sleep(n);\n\n    // The 10-minute request is called \"startup\" while subsequent daily requests are called \"daily\".\n    // We signal retries separately so that the server can monitor for flapping clients.\n    kj::StringPtr type = isRetry ? \"retry\" : \"startup\";\n\n    for (;;) {\n      // Print time.\n      time_t start = time(nullptr);\n      context.warning(kj::str(\"** Time: \", ctime(&start)));\n\n      // Check for updates.\n      if (checkForUpdates(channel, type, config)) {\n        // Exit so that the update can be applied.\n        context.exitInfo(\"** Successfully updated; restarting.\");\n      }\n\n      // Wait a day.  We actually wait 10 minutes at a time, then check if a day has passed, to\n      // capture cases where the system was suspended.\n      for (;;) {\n        n = 600;\n        while (n > 0) n = sleep(n);\n        if (time(nullptr) - start >= 86400) break;\n      }\n\n      type = \"daily\";\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "fdBundle.closeAll",
          "args": [],
          "line": 2555
        },
        "resolved": true,
        "details": {
          "function_name": "closeAll",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1693-1695",
          "snippet": "void closeAll() {\n      ports.clear();\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void closeAll() {\n        ports.clear();\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "fork",
          "args": [],
          "line": 2553
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"WARNING: Auto-updates are disabled because the server does not have write \"\n                      \"access to the installation location.\""
          ],
          "line": 2549
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"..\"",
            "W_OK"
          ],
          "line": 2548
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"WARNING: Auto-updates are disabled by config.\""
          ],
          "line": 2546
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\npid_t startUpdater(const Config& config, FdBundle& fdBundle, bool isRetry) {\n    if (config.updateChannel == nullptr) {\n      context.warning(\"WARNING: Auto-updates are disabled by config.\");\n      return 0;\n    } else if (access(\"..\", W_OK) != 0) {\n      context.warning(\"WARNING: Auto-updates are disabled because the server does not have write \"\n                      \"access to the installation location.\");\n      return 0;\n    } else {\n      pid_t pid = fork();\n      if (pid == 0) {\n        fdBundle.closeAll();\n        doUpdateLoop(config.updateChannel, isRetry, config);\n        KJ_UNREACHABLE;\n      }\n      return pid;\n    }\n  }"
  },
  {
    "function_name": "unpackUpdate",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2489-2542",
    "snippet": "void unpackUpdate(int bundleFd, uint expectedBuild = 0) {\n    char tmpdir[] = \"../downloading.XXXXXX\";\n    if (mkdtemp(tmpdir) != tmpdir) {\n      KJ_FAIL_SYSCALL(\"mkdtemp\", errno);\n    }\n    KJ_DEFER(recursivelyDelete(tmpdir));\n\n    pid_t tarPid = fork();\n    if (tarPid == 0) {\n      KJ_SYSCALL(dup2(bundleFd, STDIN_FILENO));\n      KJ_SYSCALL(chdir(tmpdir));\n      KJ_SYSCALL(execlp(\"tar\", \"tar\", \"Jxo\", EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    }\n\n    int tarStatus;\n    KJ_SYSCALL(waitpid(tarPid, &tarStatus, 0));\n    KJ_ASSERT(WIFEXITED(tarStatus) && WEXITSTATUS(tarStatus) == 0, \"tar failed\");\n\n    auto files = listDirectory(tmpdir);\n    KJ_ASSERT(files.size() == 1, \"Expected tar file to contain only one item.\");\n    KJ_ASSERT(files[0].startsWith(\"sandstorm-\"), \"Expected tar file to contain sandstorm-$BUILD.\");\n\n    uint targetBuild = KJ_ASSERT_NONNULL(parseUInt(files[0].slice(strlen(\"sandstorm-\")), 10));\n\n    if (expectedBuild != 0) {\n      KJ_ASSERT(targetBuild == expectedBuild,\n          \"Downloaded bundle did not contain the build number we expecetd.\");\n    }\n\n    kj::String targetDir;\n    if (targetBuild == 0) {\n      // Build 0 indicates a custom build. Tag it with the time.\n\n      char buffer[128];\n      time_t now = time(nullptr);\n      struct tm local;\n      localtime_r(&now, &local);\n      strftime(buffer, sizeof(buffer), \"%Y-%m-%d_%H-%M-%S\", &local);\n      targetDir = kj::str(\"../sandstorm-custom.\", buffer);\n    } else {\n      targetDir = kj::str(\"../\", files[0]);\n    }\n\n    if (access(targetDir.cStr(), F_OK) != 0) {\n      KJ_SYSCALL(rename(kj::str(tmpdir, '/', files[0]).cStr(), targetDir.cStr()));\n    }\n\n    // Setup \"latest\" symlink, atomically.\n    auto tmpLink = kj::str(\"../latest.\", targetBuild);\n    unlink(tmpLink.cStr());  // just in case; ignore failure\n    KJ_SYSCALL(symlink(targetDir.slice(3).cStr(), tmpLink.cStr()));\n    KJ_SYSCALL(rename(tmpLink.cStr(), \"../latest\"));\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "rename(tmpLink.cStr(), \"../latest\")"
          ],
          "line": 2541
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rename",
          "args": [
            "tmpLink.cStr()",
            "\"../latest\""
          ],
          "line": 2541
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "tmpLink.cStr",
          "args": [],
          "line": 2541
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "symlink(targetDir.slice(3).cStr(), tmpLink.cStr())"
          ],
          "line": 2540
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "symlink",
          "args": [
            "targetDir.slice(3).cStr()",
            "tmpLink.cStr()"
          ],
          "line": 2540
        },
        "resolved": true,
        "details": {
          "function_name": "symlinkPointsInto",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "101-124",
          "snippet": "static bool symlinkPointsInto(kj::StringPtr symlink, kj::StringPtr targetPrefix) {\n  // Returns true if the given path names a symlink whose target has the given prefix, false if\n  // it points elsewhere or doesn't exist or isn't a symlink.\nretry:\n  char buffer[PATH_MAX];\n  ssize_t n = readlink(symlink.cStr(), buffer, sizeof(buffer) - 1);\n  if (n < 0) {\n    int error = errno;\n    switch (error) {\n      case ENOENT:\n      case ENOTDIR:\n      case EINVAL:\n        // File (or parent directory) dosen't exist or isn't a symlink.\n        return false;\n      case EINTR:\n        goto retry;\n      default:\n        KJ_FAIL_SYSCALL(\"readlink(symlink)\", error, symlink);\n    }\n  } else {\n    buffer[n] = '\\0';\n    return kj::StringPtr(buffer, n).startsWith(targetPrefix);\n  }\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nstatic bool symlinkPointsInto(kj::StringPtr symlink, kj::StringPtr targetPrefix) {\n  // Returns true if the given path names a symlink whose target has the given prefix, false if\n  // it points elsewhere or doesn't exist or isn't a symlink.\nretry:\n  char buffer[PATH_MAX];\n  ssize_t n = readlink(symlink.cStr(), buffer, sizeof(buffer) - 1);\n  if (n < 0) {\n    int error = errno;\n    switch (error) {\n      case ENOENT:\n      case ENOTDIR:\n      case EINVAL:\n        // File (or parent directory) dosen't exist or isn't a symlink.\n        return false;\n      case EINTR:\n        goto retry;\n      default:\n        KJ_FAIL_SYSCALL(\"readlink(symlink)\", error, symlink);\n    }\n  } else {\n    buffer[n] = '\\0';\n    return kj::StringPtr(buffer, n).startsWith(targetPrefix);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "tmpLink.cStr",
          "args": [],
          "line": 2540
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "targetDir.slice",
          "args": [],
          "line": 2540
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "targetDir.slice",
          "args": [
            "3"
          ],
          "line": 2540
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "tmpLink.cStr()"
          ],
          "line": 2539
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "tmpLink.cStr",
          "args": [],
          "line": 2539
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"../latest.\"",
            "targetBuild"
          ],
          "line": 2538
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "rename(kj::str(tmpdir, '/', files[0]).cStr(), targetDir.cStr())"
          ],
          "line": 2534
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rename",
          "args": [
            "kj::str(tmpdir, '/', files[0]).cStr()",
            "targetDir.cStr()"
          ],
          "line": 2534
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "targetDir.cStr",
          "args": [],
          "line": 2534
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [],
          "line": 2534
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "tmpdir",
            "'/'",
            "files[0]"
          ],
          "line": 2534
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "targetDir.cStr()",
            "F_OK"
          ],
          "line": 2533
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "targetDir.cStr",
          "args": [],
          "line": 2533
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"../\"",
            "files[0]"
          ],
          "line": 2530
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"../sandstorm-custom.\"",
            "buffer"
          ],
          "line": 2528
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strftime",
          "args": [
            "buffer",
            "sizeof(buffer)",
            "\"%Y-%m-%d_%H-%M-%S\"",
            "&local"
          ],
          "line": 2527
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "localtime_r",
          "args": [
            "&now",
            "&local"
          ],
          "line": 2526
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "time",
          "args": [
            "nullptr"
          ],
          "line": 2524
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "targetBuild == expectedBuild",
            "\"Downloaded bundle did not contain the build number we expecetd.\""
          ],
          "line": 2515
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT_NONNULL",
          "args": [
            "parseUInt(files[0].slice(strlen(\"sandstorm-\")), 10)"
          ],
          "line": 2512
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "parseUInt",
          "args": [
            "files[0].slice(strlen(\"sandstorm-\"))",
            "10"
          ],
          "line": 2512
        },
        "resolved": true,
        "details": {
          "function_name": "parseUInt64",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "223-230",
          "snippet": "kj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "files[0].slice",
          "args": [
            "strlen(\"sandstorm-\")"
          ],
          "line": 2512
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "\"sandstorm-\""
          ],
          "line": 2512
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "files[0].startsWith(\"sandstorm-\")",
            "\"Expected tar file to contain sandstorm-$BUILD.\""
          ],
          "line": 2510
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "files[0].startsWith",
          "args": [
            "\"sandstorm-\""
          ],
          "line": 2510
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "files.size() == 1",
            "\"Expected tar file to contain only one item.\""
          ],
          "line": 2509
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "files.size",
          "args": [],
          "line": 2509
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "listDirectory",
          "args": [
            "tmpdir"
          ],
          "line": 2508
        },
        "resolved": true,
        "details": {
          "function_name": "listDirectoryFd",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "292-297",
          "snippet": "kj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "WIFEXITED(tarStatus) && WEXITSTATUS(tarStatus) == 0",
            "\"tar failed\""
          ],
          "line": 2506
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "WEXITSTATUS",
          "args": [
            "tarStatus"
          ],
          "line": 2506
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "WIFEXITED",
          "args": [
            "tarStatus"
          ],
          "line": 2506
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "waitpid(tarPid, &tarStatus, 0)"
          ],
          "line": 2505
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "waitpid",
          "args": [
            "tarPid",
            "&tarStatus",
            "0"
          ],
          "line": 2505
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "execlp(\"tar\", \"tar\", \"Jxo\", EXEC_END_ARGS)"
          ],
          "line": 2500
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "execlp",
          "args": [
            "\"tar\"",
            "\"tar\"",
            "\"Jxo\"",
            "EXEC_END_ARGS"
          ],
          "line": 2500
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chdir(tmpdir)"
          ],
          "line": 2499
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chdir",
          "args": [
            "tmpdir"
          ],
          "line": 2499
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(bundleFd, STDIN_FILENO)"
          ],
          "line": 2498
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "bundleFd",
            "STDIN_FILENO"
          ],
          "line": 2498
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fork",
          "args": [],
          "line": 2496
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_DEFER",
          "args": [
            "recursivelyDelete(tmpdir)"
          ],
          "line": 2494
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "recursivelyDelete",
          "args": [
            "tmpdir"
          ],
          "line": 2494
        },
        "resolved": true,
        "details": {
          "function_name": "recursivelyDelete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "299-313",
          "snippet": "void recursivelyDelete(kj::StringPtr path) {\n  KJ_REQUIRE(!path.endsWith(\"/\"),\n      \"refusing to recursively delete directory name with trailing / to reduce risk of \"\n      \"catastrophic empty-string bugs\");\n  struct stat stats;\n  KJ_SYSCALL(lstat(path.cStr(), &stats), path) { return; }\n  if (S_ISDIR(stats.st_mode)) {\n    for (auto& file: listDirectory(path)) {\n      recursivelyDelete(kj::str(path, \"/\", file));\n    }\n    KJ_SYSCALL(rmdir(path.cStr()), path) { break; }\n  } else {\n    KJ_SYSCALL(unlink(path.cStr()), path) { break; }\n  }\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nvoid recursivelyDelete(kj::StringPtr path) {\n  KJ_REQUIRE(!path.endsWith(\"/\"),\n      \"refusing to recursively delete directory name with trailing / to reduce risk of \"\n      \"catastrophic empty-string bugs\");\n  struct stat stats;\n  KJ_SYSCALL(lstat(path.cStr(), &stats), path) { return; }\n  if (S_ISDIR(stats.st_mode)) {\n    for (auto& file: listDirectory(path)) {\n      recursivelyDelete(kj::str(path, \"/\", file));\n    }\n    KJ_SYSCALL(rmdir(path.cStr()), path) { break; }\n  } else {\n    KJ_SYSCALL(unlink(path.cStr()), path) { break; }\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"mkdtemp\"",
            "errno"
          ],
          "line": 2492
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdtemp",
          "args": [
            "tmpdir"
          ],
          "line": 2491
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid unpackUpdate(int bundleFd, uint expectedBuild = 0) {\n    char tmpdir[] = \"../downloading.XXXXXX\";\n    if (mkdtemp(tmpdir) != tmpdir) {\n      KJ_FAIL_SYSCALL(\"mkdtemp\", errno);\n    }\n    KJ_DEFER(recursivelyDelete(tmpdir));\n\n    pid_t tarPid = fork();\n    if (tarPid == 0) {\n      KJ_SYSCALL(dup2(bundleFd, STDIN_FILENO));\n      KJ_SYSCALL(chdir(tmpdir));\n      KJ_SYSCALL(execlp(\"tar\", \"tar\", \"Jxo\", EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    }\n\n    int tarStatus;\n    KJ_SYSCALL(waitpid(tarPid, &tarStatus, 0));\n    KJ_ASSERT(WIFEXITED(tarStatus) && WEXITSTATUS(tarStatus) == 0, \"tar failed\");\n\n    auto files = listDirectory(tmpdir);\n    KJ_ASSERT(files.size() == 1, \"Expected tar file to contain only one item.\");\n    KJ_ASSERT(files[0].startsWith(\"sandstorm-\"), \"Expected tar file to contain sandstorm-$BUILD.\");\n\n    uint targetBuild = KJ_ASSERT_NONNULL(parseUInt(files[0].slice(strlen(\"sandstorm-\")), 10));\n\n    if (expectedBuild != 0) {\n      KJ_ASSERT(targetBuild == expectedBuild,\n          \"Downloaded bundle did not contain the build number we expecetd.\");\n    }\n\n    kj::String targetDir;\n    if (targetBuild == 0) {\n      // Build 0 indicates a custom build. Tag it with the time.\n\n      char buffer[128];\n      time_t now = time(nullptr);\n      struct tm local;\n      localtime_r(&now, &local);\n      strftime(buffer, sizeof(buffer), \"%Y-%m-%d_%H-%M-%S\", &local);\n      targetDir = kj::str(\"../sandstorm-custom.\", buffer);\n    } else {\n      targetDir = kj::str(\"../\", files[0]);\n    }\n\n    if (access(targetDir.cStr(), F_OK) != 0) {\n      KJ_SYSCALL(rename(kj::str(tmpdir, '/', files[0]).cStr(), targetDir.cStr()));\n    }\n\n    // Setup \"latest\" symlink, atomically.\n    auto tmpLink = kj::str(\"../latest.\", targetBuild);\n    unlink(tmpLink.cStr());  // just in case; ignore failure\n    KJ_SYSCALL(symlink(targetDir.slice(3).cStr(), tmpLink.cStr()));\n    KJ_SYSCALL(rename(tmpLink.cStr(), \"../latest\"));\n  }"
  },
  {
    "function_name": "checkForUpdates",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2415-2481",
    "snippet": "bool checkForUpdates(kj::StringPtr channel, kj::StringPtr type, const Config& config) {\n    // GET install.sandstorm.io/$channel?from=$oldBuild&type=[manual|startup|daily]\n    //     -> result is build number\n    context.warning(kj::str(\"Checking for updates on channel \", channel, \"...\"));\n\n    kj::String buildStr;\n\n    {\n      kj::String from;\n      if (SANDSTORM_BUILD > 0) {\n        from = kj::str(\"from=\", SANDSTORM_BUILD, \"&\");\n      }\n\n      CurlRequest updateCheck(\n          kj::str(\"https://install.sandstorm.io/\", channel, \"?\", from, \"type=\", type));\n      buildStr = readAll(updateCheck.getPipe());\n    }\n\n    uint targetBuild = KJ_ASSERT_NONNULL(parseUInt(trim(buildStr), 10));\n\n    if (targetBuild <= SANDSTORM_BUILD) {\n      context.warning(\"No update available.\");\n      return false;\n    }\n\n    // Download bundle to temporary file.\n    auto url = kj::str(\"https://dl.sandstorm.io/sandstorm-\", targetBuild, \".tar.xz\");\n    auto file = openTemporary(\"/var/tmp/sandstorm-update\");\n    context.warning(kj::str(\"Downloading: \", url));\n    CurlRequest(url, file);\n    KJ_SYSCALL(lseek(file, 0, SEEK_SET));\n\n    // Verify signature.\n    {\n      context.warning(\"Checking signature...\");\n      KJ_ON_SCOPE_FAILURE(context.warning(\n          \"*** Aborting update because signature check failed! Most likely this is due to a \"\n          \"network glitch, but if you suspect an attack, notify security@sandstorm.io.\"));\n\n      // Download and parse signature file for this update.\n      capnp::StreamFdMessageReader signatureMessage(\n          CurlRequest(kj::str(url, \".update-sig\")).getPipe());\n      auto sigs = signatureMessage.getRoot<UpdateSignature>().getSignatures();\n\n      // Always verify using the *last* key in updatePublicKeys, as it is the most recent.\n      uint keyIndex = UPDATE_PUBLIC_KEYS->size() - 1;\n      PublicSigningKey::Reader key = (*UPDATE_PUBLIC_KEYS)[keyIndex];\n      KJ_ASSERT(sigs.size() > keyIndex,\n          \"signature is missing the most recent signing key\");\n      Signature::Reader signature = sigs[keyIndex];\n\n      // mmap the file and check the signature.\n      MemoryMapping mapping(file, \"(update tarball)\");\n      capnp::Data::Reader data = mapping;\n      KJ_ASSERT(crypto_sign_ed25519_verify_detached(\n          structToBytes(signature, crypto_sign_ed25519_BYTES),\n          data.begin(), data.size(),\n          structToBytes(key, crypto_sign_ed25519_PUBLICKEYBYTES)) == 0,\n          \"signature is invalid\");\n\n      context.warning(\"Signature is valid.\");\n    }\n\n    unpackUpdate(file, targetBuild);\n\n    return true;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "else if (key == \"PORT\")",
      "else if (key == \"MONGO_PORT\")",
      "else if (key == \"BIND_IP\")",
      "else if (key == \"BASE_URL\")",
      "else if (key == \"WILDCARD_HOST\")",
      "else if (key == \"WILDCARD_PARENT_URL\")",
      "else if (key == \"DDP_DEFAULT_CONNECTION_URL\")",
      "else if (key == \"MAIL_URL\")",
      "else if (key == \"UPDATE_CHANNEL\")",
      "else if (key == \"SANDCATS_BASE_DOMAIN\")",
      "else if (key == \"ALLOW_DEMO_ACCOUNTS\")",
      "else if (key == \"ALLOW_DEV_ACCOUNTS\")",
      "else if (key == \"IS_TESTING\")",
      "else if (key == \"HIDE_TROUBLESHOOTING\")",
      "else if (key == \"SMTP_LISTEN_PORT\")"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "unpackUpdate",
          "args": [
            "file",
            "targetBuild"
          ],
          "line": 2478
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Signature is valid.\""
          ],
          "line": 2475
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "crypto_sign_ed25519_verify_detached(\n          structToBytes(signature, crypto_sign_ed25519_BYTES),\n          data.begin(), data.size(),\n          structToBytes(key, crypto_sign_ed25519_PUBLICKEYBYTES)) == 0",
            "\"signature is invalid\""
          ],
          "line": 2469
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "crypto_sign_ed25519_verify_detached",
          "args": [
            "structToBytes(signature, crypto_sign_ed25519_BYTES)",
            "data.begin()",
            "data.size()",
            "structToBytes(key, crypto_sign_ed25519_PUBLICKEYBYTES)"
          ],
          "line": 2469
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "structToBytes",
          "args": [
            "key",
            "crypto_sign_ed25519_PUBLICKEYBYTES"
          ],
          "line": 2472
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "data.size",
          "args": [],
          "line": 2471
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "data.begin",
          "args": [],
          "line": 2471
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "structToBytes",
          "args": [
            "signature",
            "crypto_sign_ed25519_BYTES"
          ],
          "line": 2470
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "sigs.size() > keyIndex",
            "\"signature is missing the most recent signing key\""
          ],
          "line": 2462
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signatureMessage.getRoot<UpdateSignature>",
          "args": [],
          "line": 2457
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signatureMessage.getRoot<UpdateSignature>",
          "args": [],
          "line": 2457
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "CurlRequest",
          "args": [],
          "line": 2456
        },
        "resolved": true,
        "details": {
          "function_name": "getPipe",
          "container": "CurlRequest",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "420-420",
          "snippet": "int getPipe() { return pipeFd; }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nCurlRequest {\n  int getPipe() { return pipeFd; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "CurlRequest",
          "args": [
            "kj::str(url, \".update-sig\")"
          ],
          "line": 2456
        },
        "resolved": true,
        "details": {
          "function_name": "CurlRequest",
          "container": "CurlRequest",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "370-387",
          "snippet": "explicit CurlRequest(kj::StringPtr url): url(kj::heapString(url)) {\n    int pipeFds[2];\n    KJ_SYSCALL(pipe(pipeFds));\n    kj::AutoCloseFd pipeInput(pipeFds[0]), pipeOutput(pipeFds[1]);\n\n    KJ_SYSCALL(pid = fork());\n    if (pid == 0) {\n      KJ_SYSCALL(dup2(pipeOutput, STDOUT_FILENO));\n      pipeInput = nullptr;\n      pipeOutput = nullptr;\n\n      KJ_SYSCALL(execlp(\"curl\", \"curl\", isatty(STDERR_FILENO) ? \"-f\" : \"-fs\",\n                        url.cStr(), EXEC_END_ARGS), url);\n      KJ_UNREACHABLE;\n    } else {\n      pipeFd = kj::mv(pipeInput);\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nCurlRequest {\n  explicit CurlRequest(kj::StringPtr url): url(kj::heapString(url)) {\n      int pipeFds[2];\n      KJ_SYSCALL(pipe(pipeFds));\n      kj::AutoCloseFd pipeInput(pipeFds[0]), pipeOutput(pipeFds[1]);\n  \n      KJ_SYSCALL(pid = fork());\n      if (pid == 0) {\n        KJ_SYSCALL(dup2(pipeOutput, STDOUT_FILENO));\n        pipeInput = nullptr;\n        pipeOutput = nullptr;\n  \n        KJ_SYSCALL(execlp(\"curl\", \"curl\", isatty(STDERR_FILENO) ? \"-f\" : \"-fs\",\n                          url.cStr(), EXEC_END_ARGS), url);\n        KJ_UNREACHABLE;\n      } else {\n        pipeFd = kj::mv(pipeInput);\n      }\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "url",
            "\".update-sig\""
          ],
          "line": 2456
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ON_SCOPE_FAILURE",
          "args": [
            "context.warning(\n          \"*** Aborting update because signature check failed! Most likely this is due to a \"\n          \"network glitch, but if you suspect an attack, notify security@sandstorm.io.\")"
          ],
          "line": 2450
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"*** Aborting update because signature check failed! Most likely this is due to a \"\n          \"network glitch, but if you suspect an attack, notify security@sandstorm.io.\""
          ],
          "line": 2450
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Checking signature...\""
          ],
          "line": 2449
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "lseek(file, 0, SEEK_SET)"
          ],
          "line": 2445
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "lseek",
          "args": [
            "file",
            "0",
            "SEEK_SET"
          ],
          "line": 2445
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\"Downloading: \", url)"
          ],
          "line": 2443
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Downloading: \"",
            "url"
          ],
          "line": 2443
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "openTemporary",
          "args": [
            "\"/var/tmp/sandstorm-update\""
          ],
          "line": 2442
        },
        "resolved": true,
        "details": {
          "function_name": "openTemporary",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "232-241",
          "snippet": "kj::AutoCloseFd openTemporary(kj::StringPtr near) {\n  // TODO(someday):  Use O_TMPFILE?  New in Linux 3.11.\n\n  int fd;\n  auto name = kj::str(near, \".XXXXXX\");\n  KJ_SYSCALL(fd = mkostemp(name.begin(), O_CLOEXEC), name);\n  kj::AutoCloseFd result(fd);\n  KJ_SYSCALL(unlink(name.cStr()));\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::AutoCloseFd openTemporary(kj::StringPtr near) {\n  // TODO(someday):  Use O_TMPFILE?  New in Linux 3.11.\n\n  int fd;\n  auto name = kj::str(near, \".XXXXXX\");\n  KJ_SYSCALL(fd = mkostemp(name.begin(), O_CLOEXEC), name);\n  kj::AutoCloseFd result(fd);\n  KJ_SYSCALL(unlink(name.cStr()));\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"https://dl.sandstorm.io/sandstorm-\"",
            "targetBuild",
            "\".tar.xz\""
          ],
          "line": 2441
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"No update available.\""
          ],
          "line": 2436
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT_NONNULL",
          "args": [
            "parseUInt(trim(buildStr), 10)"
          ],
          "line": 2433
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "parseUInt",
          "args": [
            "trim(buildStr)",
            "10"
          ],
          "line": 2433
        },
        "resolved": true,
        "details": {
          "function_name": "parseUInt64",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "223-230",
          "snippet": "kj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "trim",
          "args": [
            "buildStr"
          ],
          "line": 2433
        },
        "resolved": true,
        "details": {
          "function_name": "trim",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "202-204",
          "snippet": "kj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}"
        }
      },
      {
        "call_info": {
          "callee": "readAll",
          "args": [
            "updateCheck.getPipe()"
          ],
          "line": 2430
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"https://install.sandstorm.io/\"",
            "channel",
            "\"?\"",
            "from",
            "\"type=\"",
            "type"
          ],
          "line": 2429
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"from=\"",
            "SANDSTORM_BUILD",
            "\"&\""
          ],
          "line": 2425
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\"Checking for updates on channel \", channel, \"...\")"
          ],
          "line": 2418
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Checking for updates on channel \"",
            "channel",
            "\"...\""
          ],
          "line": 2418
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nelse if (key == \"PORT\");\nelse if (key == \"MONGO_PORT\");\nelse if (key == \"BIND_IP\");\nelse if (key == \"BASE_URL\");\nelse if (key == \"WILDCARD_HOST\");\nelse if (key == \"WILDCARD_PARENT_URL\");\nelse if (key == \"DDP_DEFAULT_CONNECTION_URL\");\nelse if (key == \"MAIL_URL\");\nelse if (key == \"UPDATE_CHANNEL\");\nelse if (key == \"SANDCATS_BASE_DOMAIN\");\nelse if (key == \"ALLOW_DEMO_ACCOUNTS\");\nelse if (key == \"ALLOW_DEV_ACCOUNTS\");\nelse if (key == \"IS_TESTING\");\nelse if (key == \"HIDE_TROUBLESHOOTING\");\nelse if (key == \"SMTP_LISTEN_PORT\");\n\nbool checkForUpdates(kj::StringPtr channel, kj::StringPtr type, const Config& config) {\n    // GET install.sandstorm.io/$channel?from=$oldBuild&type=[manual|startup|daily]\n    //     -> result is build number\n    context.warning(kj::str(\"Checking for updates on channel \", channel, \"...\"));\n\n    kj::String buildStr;\n\n    {\n      kj::String from;\n      if (SANDSTORM_BUILD > 0) {\n        from = kj::str(\"from=\", SANDSTORM_BUILD, \"&\");\n      }\n\n      CurlRequest updateCheck(\n          kj::str(\"https://install.sandstorm.io/\", channel, \"?\", from, \"type=\", type));\n      buildStr = readAll(updateCheck.getPipe());\n    }\n\n    uint targetBuild = KJ_ASSERT_NONNULL(parseUInt(trim(buildStr), 10));\n\n    if (targetBuild <= SANDSTORM_BUILD) {\n      context.warning(\"No update available.\");\n      return false;\n    }\n\n    // Download bundle to temporary file.\n    auto url = kj::str(\"https://dl.sandstorm.io/sandstorm-\", targetBuild, \".tar.xz\");\n    auto file = openTemporary(\"/var/tmp/sandstorm-update\");\n    context.warning(kj::str(\"Downloading: \", url));\n    CurlRequest(url, file);\n    KJ_SYSCALL(lseek(file, 0, SEEK_SET));\n\n    // Verify signature.\n    {\n      context.warning(\"Checking signature...\");\n      KJ_ON_SCOPE_FAILURE(context.warning(\n          \"*** Aborting update because signature check failed! Most likely this is due to a \"\n          \"network glitch, but if you suspect an attack, notify security@sandstorm.io.\"));\n\n      // Download and parse signature file for this update.\n      capnp::StreamFdMessageReader signatureMessage(\n          CurlRequest(kj::str(url, \".update-sig\")).getPipe());\n      auto sigs = signatureMessage.getRoot<UpdateSignature>().getSignatures();\n\n      // Always verify using the *last* key in updatePublicKeys, as it is the most recent.\n      uint keyIndex = UPDATE_PUBLIC_KEYS->size() - 1;\n      PublicSigningKey::Reader key = (*UPDATE_PUBLIC_KEYS)[keyIndex];\n      KJ_ASSERT(sigs.size() > keyIndex,\n          \"signature is missing the most recent signing key\");\n      Signature::Reader signature = sigs[keyIndex];\n\n      // mmap the file and check the signature.\n      MemoryMapping mapping(file, \"(update tarball)\");\n      capnp::Data::Reader data = mapping;\n      KJ_ASSERT(crypto_sign_ed25519_verify_detached(\n          structToBytes(signature, crypto_sign_ed25519_BYTES),\n          data.begin(), data.size(),\n          structToBytes(key, crypto_sign_ed25519_PUBLICKEYBYTES)) == 0,\n          \"signature is invalid\");\n\n      context.warning(\"Signature is valid.\");\n    }\n\n    unpackUpdate(file, targetBuild);\n\n    return true;\n  }"
  },
  {
    "function_name": "killChild",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2377-2413",
    "snippet": "void killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"waitpid()\"",
            "error",
            "title"
          ],
          "line": 2410
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "kill(pid, SIGKILL)"
          ],
          "line": 2404
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kill",
          "args": [
            "pid",
            "SIGKILL"
          ],
          "line": 2404
        },
        "resolved": true,
        "details": {
          "function_name": "killChild",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2377-2413",
          "snippet": "void killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }",
          "note": "cyclic_reference_detected"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\")"
          ],
          "line": 2402
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "title",
            "\" did not terminate after \"",
            "timeout",
            "\" seconds; killing.\""
          ],
          "line": 2402
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "alarm(0)"
          ],
          "line": 2394
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "alarm",
          "args": [
            "0"
          ],
          "line": 2394
        },
        "resolved": true,
        "details": {
          "function_name": "alarmHandler",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "72-74",
          "snippet": "void alarmHandler(int) {\n  alarmed = true;\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid alarmHandler(int) {\n  alarmed = true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "waitpid",
          "args": [
            "pid",
            "&status",
            "0"
          ],
          "line": 2393
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "alarm(timeout)"
          ],
          "line": 2390
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "kill(pid, SIGTERM)"
          ],
          "line": 2386
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\"Not killing \", title, \" because it is not running.\")"
          ],
          "line": 2380
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Not killing \"",
            "title",
            "\" because it is not running.\""
          ],
          "line": 2380
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nvoid killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }"
  },
  {
    "function_name": "maybeWaitAfterChildDeath",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2364-2375",
    "snippet": "void maybeWaitAfterChildDeath(kj::StringPtr title, int64_t startTime) {\n    if (getTime() - startTime < 10ll * 1000 * 1000 * 1000) {\n      context.warning(kj::str(\n          \"** \", title, \" died immediately after starting.\\n\"\n          \"** Sleeping for a bit before trying again...\"));\n\n      // Sleep for 10 seconds to avoid burning resources on a restart loop.\n      usleep(10 * 1000 * 1000);\n    } else {\n      context.warning(kj::str(\"** \", title, \" died! Restarting it...\"));\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\"** \", title, \" died! Restarting it...\")"
          ],
          "line": 2373
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"** \"",
            "title",
            "\" died! Restarting it...\""
          ],
          "line": 2373
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "usleep",
          "args": [
            "10 * 1000 * 1000"
          ],
          "line": 2371
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\n          \"** \", title, \" died immediately after starting.\\n\"\n          \"** Sleeping for a bit before trying again...\")"
          ],
          "line": 2366
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"** \"",
            "title",
            "\" died immediately after starting.\\n\"\n          \"** Sleeping for a bit before trying again...\""
          ],
          "line": 2366
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getTime",
          "args": [],
          "line": 2365
        },
        "resolved": true,
        "details": {
          "function_name": "getTime",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1289-1293",
          "snippet": "int64_t getTime() {\n    struct timespec ts;\n    KJ_SYSCALL(clock_gettime(CLOCK_MONOTONIC, &ts));\n    return ts.tv_sec * 1000000000ll + ts.tv_nsec;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nint64_t getTime() {\n    struct timespec ts;\n    KJ_SYSCALL(clock_gettime(CLOCK_MONOTONIC, &ts));\n    return ts.tv_sec * 1000000000ll + ts.tv_nsec;\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid maybeWaitAfterChildDeath(kj::StringPtr title, int64_t startTime) {\n    if (getTime() - startTime < 10ll * 1000 * 1000 * 1000) {\n      context.warning(kj::str(\n          \"** \", title, \" died immediately after starting.\\n\"\n          \"** Sleeping for a bit before trying again...\"));\n\n      // Sleep for 10 seconds to avoid burning resources on a restart loop.\n      usleep(10 * 1000 * 1000);\n    } else {\n      context.warning(kj::str(\"** \", title, \" died! Restarting it...\"));\n    }\n  }"
  },
  {
    "function_name": "startNode",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2273-2362",
    "snippet": "pid_t startNode(const Config& config, FdBundle& fdBundle) {\n    Subprocess process([&]() -> int {\n      fdBundle.prepareInheritedFds();\n\n      dropPrivs(config.uids);\n      clearSignalMask();\n\n      kj::String authPrefix;\n      kj::StringPtr authSuffix;\n      if (access(\"/var/mongo/passwd\", F_OK) == 0) {\n        // Read the password.\n        auto password = trim(readAll(raiiOpen(\"/var/mongo/passwd\", O_RDONLY)));\n        authPrefix = kj::str(\"sandstorm:\", password, \"@\");\n        authSuffix = \"?authSource=admin\";\n\n        // Oplog is only configured if we have a password.\n        KJ_SYSCALL(setenv(\"MONGO_OPLOG_URL\",\n            kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                    \"/local\", authSuffix).cStr(),\n            true));\n      }\n\n      KJ_SYSCALL(setenv(\"PORT\", kj::strArray(config.ports, \",\").cStr(), true));\n      KJ_IF_MAYBE(httpsPort, config.httpsPort) {\n        KJ_SYSCALL(setenv(\"HTTPS_PORT\", kj::str(*httpsPort).cStr(), true));\n      }\n\n      KJ_SYSCALL(setenv(\"MONGO_URL\",\n          kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                  \"/meteor\", authSuffix).cStr(),\n          true));\n      KJ_SYSCALL(setenv(\"BIND_IP\", config.bindIp.cStr(), true));\n      if (config.mailUrl != nullptr) {\n        KJ_SYSCALL(setenv(\"MAIL_URL\", config.mailUrl.cStr(), true));\n      }\n      if (config.rootUrl == nullptr) {\n        kj::StringPtr scheme;\n        uint defaultPort;\n\n        if (config.httpsPort == nullptr) {\n          scheme = \"http://\";\n          defaultPort = 80;\n        } else {\n          scheme = \"https://\";\n          defaultPort = 443;\n        }\n        if (config.ports[0] == defaultPort) {\n          KJ_SYSCALL(setenv(\"ROOT_URL\", kj::str(scheme, config.bindIp).cStr(), true));\n        } else {\n          KJ_SYSCALL(setenv(\"ROOT_URL\",\n              kj::str(scheme, config.bindIp, \":\", config.ports[0]).cStr(), true));\n        }\n      } else {\n        KJ_SYSCALL(setenv(\"ROOT_URL\", config.rootUrl.cStr(), true));\n      }\n      if (config.wildcardHost != nullptr) {\n        KJ_SYSCALL(setenv(\"WILDCARD_HOST\", config.wildcardHost.cStr(), true));\n      }\n      if (config.ddpUrl != nullptr) {\n        KJ_SYSCALL(setenv(\"DDP_DEFAULT_CONNECTION_URL\", config.ddpUrl.cStr(), true));\n      }\n\n      kj::String buildstamp;\n      if (SANDSTORM_BUILD == 0) {\n        buildstamp = kj::str(\"\\\"[\", trim(readAll(\"buildstamp\")), \"]\\\"\");\n      } else {\n        buildstamp = kj::str(SANDSTORM_BUILD);\n      }\n\n      kj::String settingsString = kj::str(\n          \"{\\\"public\\\":{\\\"build\\\":\", buildstamp,\n          \", \\\"allowDemoAccounts\\\":\", config.allowDemoAccounts ? \"true\" : \"false\",\n          \", \\\"allowDevAccounts\\\":\", config.allowDevAccounts ? \"true\" : \"false\",\n          \", \\\"isTesting\\\":\", config.isTesting ? \"true\" : \"false\",\n          \", \\\"hideTroubleshooting\\\":\", config.hideTroubleshooting ? \"true\" : \"false\",\n          \", \\\"wildcardHost\\\":\\\"\", config.wildcardHost, \"\\\"\");\n      if (config.sandcatsHostname.size() > 0) {\n          settingsString = kj::str(settingsString,\n            \", \\\"sandcatsHostname\\\":\\\"\", config.sandcatsHostname, \"\\\"\");\n      }\n      settingsString = kj::str(settingsString, \"}}\");\n      KJ_SYSCALL(setenv(\"METEOR_SETTINGS\", settingsString.cStr(), true));\n      KJ_SYSCALL(execl(\"/bin/node\", \"/bin/node\", \"sandstorm-main.js\", EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    });\n\n    pid_t result = process.getPid();\n    process.detach();\n    return result;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "process.detach",
          "args": [],
          "line": 2360
        },
        "resolved": true,
        "details": {
          "function_name": "detach",
          "container": "Subprocess",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "385-391",
          "snippet": "void detach() {\n    // Indicates that you don't intend to wait for this process to complete and do not want it to\n    // be killed when the Subprocess object is destroyed. The parent process needs a wait loop\n    // somewhere to clean up zombies.\n\n    pid = 0;\n  }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nSubprocess {\n  void detach() {\n      // Indicates that you don't intend to wait for this process to complete and do not want it to\n      // be killed when the Subprocess object is destroyed. The parent process needs a wait loop\n      // somewhere to clean up zombies.\n  \n      pid = 0;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "process.getPid",
          "args": [],
          "line": 2359
        },
        "resolved": true,
        "details": {
          "function_name": "getPid",
          "container": "Subprocess",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "365-368",
          "snippet": "pid_t getPid() {\n    KJ_IREQUIRE(pid != 0, \"already exited\");\n    return pid;\n  }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nSubprocess {\n  pid_t getPid() {\n      KJ_IREQUIRE(pid != 0, \"already exited\");\n      return pid;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "execl(\"/bin/node\", \"/bin/node\", \"sandstorm-main.js\", EXEC_END_ARGS)"
          ],
          "line": 2355
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "execl",
          "args": [
            "\"/bin/node\"",
            "\"/bin/node\"",
            "\"sandstorm-main.js\"",
            "EXEC_END_ARGS"
          ],
          "line": 2355
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"METEOR_SETTINGS\", settingsString.cStr(), true)"
          ],
          "line": 2354
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"METEOR_SETTINGS\"",
            "settingsString.cStr()",
            "true"
          ],
          "line": 2354
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "settingsString.cStr",
          "args": [],
          "line": 2354
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "settingsString",
            "\"}}\""
          ],
          "line": 2353
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "settingsString",
            "\", \\\"sandcatsHostname\\\":\\\"\"",
            "config.sandcatsHostname",
            "\"\\\"\""
          ],
          "line": 2350
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "config.sandcatsHostname.size",
          "args": [],
          "line": 2349
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"{\\\"public\\\":{\\\"build\\\":\"",
            "buildstamp",
            "\", \\\"allowDemoAccounts\\\":\"",
            "config.allowDemoAccounts ? \"true\" : \"false\"",
            "\", \\\"allowDevAccounts\\\":\"",
            "config.allowDevAccounts ? \"true\" : \"false\"",
            "\", \\\"isTesting\\\":\"",
            "config.isTesting ? \"true\" : \"false\"",
            "\", \\\"hideTroubleshooting\\\":\"",
            "config.hideTroubleshooting ? \"true\" : \"false\"",
            "\", \\\"wildcardHost\\\":\\\"\"",
            "config.wildcardHost",
            "\"\\\"\""
          ],
          "line": 2342
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "SANDSTORM_BUILD"
          ],
          "line": 2339
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"\\\"[\"",
            "trim(readAll(\"buildstamp\"))",
            "\"]\\\"\""
          ],
          "line": 2337
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "trim",
          "args": [
            "readAll(\"buildstamp\")"
          ],
          "line": 2337
        },
        "resolved": true,
        "details": {
          "function_name": "trim",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "202-204",
          "snippet": "kj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}"
        }
      },
      {
        "call_info": {
          "callee": "readAll",
          "args": [
            "\"buildstamp\""
          ],
          "line": 2337
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"DDP_DEFAULT_CONNECTION_URL\", config.ddpUrl.cStr(), true)"
          ],
          "line": 2332
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"DDP_DEFAULT_CONNECTION_URL\"",
            "config.ddpUrl.cStr()",
            "true"
          ],
          "line": 2332
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "config.ddpUrl.cStr",
          "args": [],
          "line": 2332
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"WILDCARD_HOST\", config.wildcardHost.cStr(), true)"
          ],
          "line": 2329
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"WILDCARD_HOST\"",
            "config.wildcardHost.cStr()",
            "true"
          ],
          "line": 2329
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "config.wildcardHost.cStr",
          "args": [],
          "line": 2329
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"ROOT_URL\", config.rootUrl.cStr(), true)"
          ],
          "line": 2326
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"ROOT_URL\"",
            "config.rootUrl.cStr()",
            "true"
          ],
          "line": 2326
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "config.rootUrl.cStr",
          "args": [],
          "line": 2326
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"ROOT_URL\",\n              kj::str(scheme, config.bindIp, \":\", config.ports[0]).cStr(), true)"
          ],
          "line": 2322
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"ROOT_URL\"",
            "kj::str(scheme, config.bindIp, \":\", config.ports[0]).cStr()",
            "true"
          ],
          "line": 2322
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [],
          "line": 2323
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "scheme",
            "config.bindIp",
            "\":\"",
            "config.ports[0]"
          ],
          "line": 2323
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"ROOT_URL\", kj::str(scheme, config.bindIp).cStr(), true)"
          ],
          "line": 2320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"ROOT_URL\"",
            "kj::str(scheme, config.bindIp).cStr()",
            "true"
          ],
          "line": 2320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [],
          "line": 2320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "scheme",
            "config.bindIp"
          ],
          "line": 2320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"MAIL_URL\", config.mailUrl.cStr(), true)"
          ],
          "line": 2306
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"MAIL_URL\"",
            "config.mailUrl.cStr()",
            "true"
          ],
          "line": 2306
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "config.mailUrl.cStr",
          "args": [],
          "line": 2306
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"BIND_IP\", config.bindIp.cStr(), true)"
          ],
          "line": 2304
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"BIND_IP\"",
            "config.bindIp.cStr()",
            "true"
          ],
          "line": 2304
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "config.bindIp.cStr",
          "args": [],
          "line": 2304
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"MONGO_URL\",\n          kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                  \"/meteor\", authSuffix).cStr(),\n          true)"
          ],
          "line": 2300
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"MONGO_URL\"",
            "kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                  \"/meteor\", authSuffix).cStr()",
            "true"
          ],
          "line": 2300
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [],
          "line": 2301
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"mongodb://\"",
            "authPrefix",
            "\"127.0.0.1:\"",
            "config.mongoPort",
            "\"/meteor\"",
            "authSuffix"
          ],
          "line": 2301
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"HTTPS_PORT\", kj::str(*httpsPort).cStr(), true)"
          ],
          "line": 2297
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"HTTPS_PORT\"",
            "kj::str(*httpsPort).cStr()",
            "true"
          ],
          "line": 2297
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [],
          "line": 2297
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "*httpsPort"
          ],
          "line": 2297
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "httpsPort",
            "config.httpsPort"
          ],
          "line": 2296
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1662-1665",
          "snippet": "KJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"PORT\", kj::strArray(config.ports, \",\").cStr(), true)"
          ],
          "line": 2295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"PORT\"",
            "kj::strArray(config.ports, \",\").cStr()",
            "true"
          ],
          "line": 2295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::strArray",
          "args": [],
          "line": 2295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::strArray",
          "args": [
            "config.ports",
            "\",\""
          ],
          "line": 2295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"MONGO_OPLOG_URL\",\n            kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                    \"/local\", authSuffix).cStr(),\n            true)"
          ],
          "line": 2289
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"MONGO_OPLOG_URL\"",
            "kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                    \"/local\", authSuffix).cStr()",
            "true"
          ],
          "line": 2289
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [],
          "line": 2290
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"mongodb://\"",
            "authPrefix",
            "\"127.0.0.1:\"",
            "config.mongoPort",
            "\"/local\"",
            "authSuffix"
          ],
          "line": 2290
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"sandstorm:\"",
            "password",
            "\"@\""
          ],
          "line": 2285
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"/var/mongo/passwd\"",
            "O_RDONLY"
          ],
          "line": 2284
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"/var/mongo/passwd\"",
            "F_OK"
          ],
          "line": 2282
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "clearSignalMask",
          "args": [],
          "line": 2278
        },
        "resolved": true,
        "details": {
          "function_name": "clearSignalMask",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1499-1503",
          "snippet": "void clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "dropPrivs",
          "args": [
            "config.uids"
          ],
          "line": 2277
        },
        "resolved": true,
        "details": {
          "function_name": "dropPrivs",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1451-1497",
          "snippet": "void dropPrivs(const UserIds& uids, bool keepRealUid = false) {\n    // Defense in depth: Don't give my children any new caps for any reason.\n    KJ_SYSCALL(prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0));\n\n    if (runningAsRoot) {\n      KJ_SYSCALL(setresgid(uids.gid, uids.gid, uids.gid));\n      KJ_SYSCALL(setgroups(uids.groups.size(), uids.groups.begin()));\n\n      if (keepRealUid) {\n        // We're prepping to run the backend and user namespaces are not available, therefore the\n        // backend needs to keep its superuser powers stashed in order to hand them off to the\n        // grain supervisors so that they can set up sandboxes. Instead of creating a suid binary\n        // (with all the danger that entails), we merely drop the effective UID, but raise it again\n        // when invoking the supervisor.\n        KJ_SYSCALL(seteuid(uids.uid));\n      } else {\n        KJ_SYSCALL(setresuid(uids.uid, uids.uid, uids.uid));\n      }\n    } else {\n      // We're using UID namespaces.\n\n      KJ_ASSERT(!keepRealUid);\n\n      // Defense in depth: Drop all capabilities from the set of caps which my children are allowed\n      //   to ever have.\n      for (uint cap: kj::range(0, CAP_LAST_CAP + 1)) {\n        // TODO(soon): I spontaneously started getting EINVAL here, but only in production, so I\n        //   had to remove the error check. Figure out what happened and re-enable it. Maybe it\n        //   makes sense to read the bset first and then only drop the caps in it?\n        prctl(PR_CAPBSET_DROP, cap, 0, 0, 0);\n      }\n\n      // Defense in depth: Don't grant my children capabilities just because they have UID 0.\n      KJ_SYSCALL(prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED));\n\n      // Drop all Linux \"capabilities\".  (These are Linux/POSIX \"capabilities\", which are not true\n      // object-capabilities, hence the quotes.)\n      struct __user_cap_header_struct hdr;\n      struct __user_cap_data_struct data[2];\n      hdr.version = _LINUX_CAPABILITY_VERSION_3;\n      hdr.pid = 0;\n      memset(data, 0, sizeof(data));  // All capabilities disabled!\n      KJ_SYSCALL(capset(&hdr, data));\n    }\n\n    umask(0007);\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;",
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool runningAsRoot = getuid() == 0;\n\nvoid dropPrivs(const UserIds& uids, bool keepRealUid = false) {\n    // Defense in depth: Don't give my children any new caps for any reason.\n    KJ_SYSCALL(prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0));\n\n    if (runningAsRoot) {\n      KJ_SYSCALL(setresgid(uids.gid, uids.gid, uids.gid));\n      KJ_SYSCALL(setgroups(uids.groups.size(), uids.groups.begin()));\n\n      if (keepRealUid) {\n        // We're prepping to run the backend and user namespaces are not available, therefore the\n        // backend needs to keep its superuser powers stashed in order to hand them off to the\n        // grain supervisors so that they can set up sandboxes. Instead of creating a suid binary\n        // (with all the danger that entails), we merely drop the effective UID, but raise it again\n        // when invoking the supervisor.\n        KJ_SYSCALL(seteuid(uids.uid));\n      } else {\n        KJ_SYSCALL(setresuid(uids.uid, uids.uid, uids.uid));\n      }\n    } else {\n      // We're using UID namespaces.\n\n      KJ_ASSERT(!keepRealUid);\n\n      // Defense in depth: Drop all capabilities from the set of caps which my children are allowed\n      //   to ever have.\n      for (uint cap: kj::range(0, CAP_LAST_CAP + 1)) {\n        // TODO(soon): I spontaneously started getting EINVAL here, but only in production, so I\n        //   had to remove the error check. Figure out what happened and re-enable it. Maybe it\n        //   makes sense to read the bset first and then only drop the caps in it?\n        prctl(PR_CAPBSET_DROP, cap, 0, 0, 0);\n      }\n\n      // Defense in depth: Don't grant my children capabilities just because they have UID 0.\n      KJ_SYSCALL(prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED));\n\n      // Drop all Linux \"capabilities\".  (These are Linux/POSIX \"capabilities\", which are not true\n      // object-capabilities, hence the quotes.)\n      struct __user_cap_header_struct hdr;\n      struct __user_cap_data_struct data[2];\n      hdr.version = _LINUX_CAPABILITY_VERSION_3;\n      hdr.pid = 0;\n      memset(data, 0, sizeof(data));  // All capabilities disabled!\n      KJ_SYSCALL(capset(&hdr, data));\n    }\n\n    umask(0007);\n  }"
        }
      },
      {
        "call_info": {
          "callee": "fdBundle.prepareInheritedFds",
          "args": [],
          "line": 2275
        },
        "resolved": true,
        "details": {
          "function_name": "prepareInheritedFds",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1706-1710",
          "snippet": "void prepareInheritedFds() {\n      for (auto& port: ports) {\n        KJ_SYSCALL(dup2(port.second.fd, port.second.targetFd));\n      }\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void prepareInheritedFds() {\n        for (auto& port: ports) {\n          KJ_SYSCALL(dup2(port.second.fd, port.second.targetFd));\n        }\n      }\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t startNode(const Config& config, FdBundle& fdBundle) {\n    Subprocess process([&]() -> int {\n      fdBundle.prepareInheritedFds();\n\n      dropPrivs(config.uids);\n      clearSignalMask();\n\n      kj::String authPrefix;\n      kj::StringPtr authSuffix;\n      if (access(\"/var/mongo/passwd\", F_OK) == 0) {\n        // Read the password.\n        auto password = trim(readAll(raiiOpen(\"/var/mongo/passwd\", O_RDONLY)));\n        authPrefix = kj::str(\"sandstorm:\", password, \"@\");\n        authSuffix = \"?authSource=admin\";\n\n        // Oplog is only configured if we have a password.\n        KJ_SYSCALL(setenv(\"MONGO_OPLOG_URL\",\n            kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                    \"/local\", authSuffix).cStr(),\n            true));\n      }\n\n      KJ_SYSCALL(setenv(\"PORT\", kj::strArray(config.ports, \",\").cStr(), true));\n      KJ_IF_MAYBE(httpsPort, config.httpsPort) {\n        KJ_SYSCALL(setenv(\"HTTPS_PORT\", kj::str(*httpsPort).cStr(), true));\n      }\n\n      KJ_SYSCALL(setenv(\"MONGO_URL\",\n          kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                  \"/meteor\", authSuffix).cStr(),\n          true));\n      KJ_SYSCALL(setenv(\"BIND_IP\", config.bindIp.cStr(), true));\n      if (config.mailUrl != nullptr) {\n        KJ_SYSCALL(setenv(\"MAIL_URL\", config.mailUrl.cStr(), true));\n      }\n      if (config.rootUrl == nullptr) {\n        kj::StringPtr scheme;\n        uint defaultPort;\n\n        if (config.httpsPort == nullptr) {\n          scheme = \"http://\";\n          defaultPort = 80;\n        } else {\n          scheme = \"https://\";\n          defaultPort = 443;\n        }\n        if (config.ports[0] == defaultPort) {\n          KJ_SYSCALL(setenv(\"ROOT_URL\", kj::str(scheme, config.bindIp).cStr(), true));\n        } else {\n          KJ_SYSCALL(setenv(\"ROOT_URL\",\n              kj::str(scheme, config.bindIp, \":\", config.ports[0]).cStr(), true));\n        }\n      } else {\n        KJ_SYSCALL(setenv(\"ROOT_URL\", config.rootUrl.cStr(), true));\n      }\n      if (config.wildcardHost != nullptr) {\n        KJ_SYSCALL(setenv(\"WILDCARD_HOST\", config.wildcardHost.cStr(), true));\n      }\n      if (config.ddpUrl != nullptr) {\n        KJ_SYSCALL(setenv(\"DDP_DEFAULT_CONNECTION_URL\", config.ddpUrl.cStr(), true));\n      }\n\n      kj::String buildstamp;\n      if (SANDSTORM_BUILD == 0) {\n        buildstamp = kj::str(\"\\\"[\", trim(readAll(\"buildstamp\")), \"]\\\"\");\n      } else {\n        buildstamp = kj::str(SANDSTORM_BUILD);\n      }\n\n      kj::String settingsString = kj::str(\n          \"{\\\"public\\\":{\\\"build\\\":\", buildstamp,\n          \", \\\"allowDemoAccounts\\\":\", config.allowDemoAccounts ? \"true\" : \"false\",\n          \", \\\"allowDevAccounts\\\":\", config.allowDevAccounts ? \"true\" : \"false\",\n          \", \\\"isTesting\\\":\", config.isTesting ? \"true\" : \"false\",\n          \", \\\"hideTroubleshooting\\\":\", config.hideTroubleshooting ? \"true\" : \"false\",\n          \", \\\"wildcardHost\\\":\\\"\", config.wildcardHost, \"\\\"\");\n      if (config.sandcatsHostname.size() > 0) {\n          settingsString = kj::str(settingsString,\n            \", \\\"sandcatsHostname\\\":\\\"\", config.sandcatsHostname, \"\\\"\");\n      }\n      settingsString = kj::str(settingsString, \"}}\");\n      KJ_SYSCALL(setenv(\"METEOR_SETTINGS\", settingsString.cStr(), true));\n      KJ_SYSCALL(execl(\"/bin/node\", \"/bin/node\", \"sandstorm-main.js\", EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    });\n\n    pid_t result = process.getPid();\n    process.detach();\n    return result;\n  }"
  },
  {
    "function_name": "startBackend",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2201-2271",
    "snippet": "pid_t startBackend(const Config& config, FdBundle& fdBundle) {\n    int pipeFds[2];\n    KJ_SYSCALL(pipe2(pipeFds, O_CLOEXEC));\n    kj::AutoCloseFd inPipe(pipeFds[0]);\n    kj::AutoCloseFd outPipe(pipeFds[1]);\n\n    Subprocess process([&]() -> int {\n      inPipe = nullptr;\n      fdBundle.closeAll();\n\n      // Mainly to cause Cap'n Proto to log exceptions being returned over RPC so we can see the\n      // stack traces.\n      kj::_::Debug::setLogLevel(kj::LogSeverity::INFO);\n\n      kj::StringPtr socketPath = Backend::SOCKET_PATH;\n      sandstorm::recursivelyCreateParent(socketPath);\n      unlink(socketPath.cStr());\n\n      auto io = kj::setupAsyncIo();\n      auto& network = io.provider->getNetwork();\n      auto listener = network.parseAddress(kj::str(\"unix:\", socketPath))\n          .wait(io.waitScope)->listen();\n\n      if (runningAsRoot) {\n        // Make socket available to server user.\n        KJ_SYSCALL(chmod(socketPath.cStr(), 0770));\n        KJ_SYSCALL(chown(socketPath.cStr(), 0, config.uids.gid));\n\n        // Also make the socket parent directory available to user.\n        KJ_IF_MAYBE(pos, socketPath.findLast('/')) {\n          kj::String parent = kj::heapString(socketPath.slice(0, *pos));\n          KJ_SYSCALL(chmod(parent.cStr(), 0770));\n          KJ_SYSCALL(chown(parent.cStr(), 0, config.uids.gid));\n        }\n      }\n\n      // If we're not running as root, we have to use user namespaces. Otherwise, dynamically\n      // check if they're available. If not, we'll need to pass superuser privileges on to the\n      // backend.\n      bool avoidUserns = runningAsRoot && !isUserNsAvailable();\n      kj::Maybe<uid_t> sandboxUid;\n      if (avoidUserns) sandboxUid = config.uids.uid;\n\n      dropPrivs(config.uids, avoidUserns);\n      clearSignalMask();\n\n      auto paf = kj::newPromiseAndFulfiller<Backend::Client>();\n      TwoPartyServerWithClientBootstrap server(kj::mv(paf.promise));\n      paf.fulfiller->fulfill(kj::heap<BackendImpl>(*io.lowLevelProvider, network,\n        server.getBootstrap().castAs<SandstormCoreFactory>(), sandboxUid));\n\n      // Signal readiness.\n      write(outPipe, \"ready\", 5);\n      outPipe = nullptr;\n\n      server.listen(kj::mv(listener))\n            // Rotate logs, keeping 1-2MB worth. We do this in the backend process mainly because\n            // it is the only asynchronous process in run-bundle.c++.\n            .exclusiveJoin(rotateLog(io.provider->getTimer(),\n                                     STDERR_FILENO, \"/var/log/sandstorm.log\", 1u << 20))\n            .wait(io.waitScope);\n      KJ_UNREACHABLE;\n    });\n\n    outPipe = nullptr;\n    KJ_ASSERT(sandstorm::readAll(inPipe) == \"ready\", \"starting back-end failed\");\n\n    pid_t result = process.getPid();\n    process.detach();\n    return result;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool runningAsRoot = getuid() == 0;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "process.detach",
          "args": [],
          "line": 2269
        },
        "resolved": true,
        "details": {
          "function_name": "detach",
          "container": "Subprocess",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "385-391",
          "snippet": "void detach() {\n    // Indicates that you don't intend to wait for this process to complete and do not want it to\n    // be killed when the Subprocess object is destroyed. The parent process needs a wait loop\n    // somewhere to clean up zombies.\n\n    pid = 0;\n  }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nSubprocess {\n  void detach() {\n      // Indicates that you don't intend to wait for this process to complete and do not want it to\n      // be killed when the Subprocess object is destroyed. The parent process needs a wait loop\n      // somewhere to clean up zombies.\n  \n      pid = 0;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "process.getPid",
          "args": [],
          "line": 2268
        },
        "resolved": true,
        "details": {
          "function_name": "getPid",
          "container": "Subprocess",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "365-368",
          "snippet": "pid_t getPid() {\n    KJ_IREQUIRE(pid != 0, \"already exited\");\n    return pid;\n  }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nSubprocess {\n  pid_t getPid() {\n      KJ_IREQUIRE(pid != 0, \"already exited\");\n      return pid;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "sandstorm::readAll(inPipe) == \"ready\"",
            "\"starting back-end failed\""
          ],
          "line": 2266
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sandstorm::readAll",
          "args": [
            "inPipe"
          ],
          "line": 2266
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      },
      {
        "call_info": {
          "callee": "server.listen",
          "args": [
            "io.waitScope"
          ],
          "line": 2256
        },
        "resolved": true,
        "details": {
          "function_name": "listen",
          "container": "TwoPartyServerWithClientBootstrap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "1227-1247",
          "snippet": "kj::Promise<void> TwoPartyServerWithClientBootstrap::listen(\n  kj::Own<kj::ConnectionReceiver>&& listener) {\n  return listener->accept()\n      .then([this,KJ_MVCAP(listener)](kj::Own<kj::AsyncIoStream>&& connection) mutable {\n    auto connectionState = kj::heap<AcceptedConnection>(bootstrapInterface, kj::mv(connection));\n\n    // Update the bootstrap redirector to point at the new connection's bootstrap.\n    capnp::MallocMessageBuilder message(8);\n    auto vatId = message.getRoot<capnp::rpc::twoparty::VatId>();\n    vatId.setSide(capnp::rpc::twoparty::Side::CLIENT);\n    uint iteration = redirector->setTarget(connectionState->rpcSystem.bootstrap(vatId));\n\n    // Run the connection until disconnect.\n    auto promise = connectionState->network.onDisconnect();\n    tasks.add(promise.attach(kj::mv(connectionState), kj::defer([this,iteration]() {\n      // Disconnect the redirector when the client disconnects.\n      redirector->setDisconnected(iteration);\n    })));\n\n    return listen(kj::mv(listener));\n  }",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nTwoPartyServerWithClientBootstrap {\n  kj::Promise<void> TwoPartyServerWithClientBootstrap::listen(\n    kj::Own<kj::ConnectionReceiver>&& listener) {\n    return listener->accept()\n        .then([this,KJ_MVCAP(listener)](kj::Own<kj::AsyncIoStream>&& connection) mutable {\n      auto connectionState = kj::heap<AcceptedConnection>(bootstrapInterface, kj::mv(connection));\n  \n      // Update the bootstrap redirector to point at the new connection's bootstrap.\n      capnp::MallocMessageBuilder message(8);\n      auto vatId = message.getRoot<capnp::rpc::twoparty::VatId>();\n      vatId.setSide(capnp::rpc::twoparty::Side::CLIENT);\n      uint iteration = redirector->setTarget(connectionState->rpcSystem.bootstrap(vatId));\n  \n      // Run the connection until disconnect.\n      auto promise = connectionState->network.onDisconnect();\n      tasks.add(promise.attach(kj::mv(connectionState), kj::defer([this,iteration]() {\n        // Disconnect the redirector when the client disconnects.\n        redirector->setDisconnected(iteration);\n      })));\n  \n      return listen(kj::mv(listener));\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "rotateLog",
          "args": [
            "io.provider->getTimer()",
            "STDERR_FILENO",
            "\"/var/log/sandstorm.log\"",
            "1u << 20"
          ],
          "line": 2259
        },
        "resolved": true,
        "details": {
          "function_name": "rotateLog",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "480-513",
          "snippet": "kj::Promise<void> rotateLog(kj::Timer& timer, int logFd, kj::StringPtr path, size_t threshold) {\n  struct stat stats;\n  KJ_SYSCALL(fstat(logFd, &stats));\n  if (stats.st_size >= threshold) {\n    // TODO(someday): If .1 exists, we could move it to .2, which we could move to .3, etc. We could\n    //   also gzip older logs to save space. But does anyone actually care? Probably not? Note that\n    //   if this changes, the lseek() below probably needs to be replaced with something more\n    //   sophisticated.\n    auto out = raiiOpen(kj::str(path, \".1\"), O_WRONLY | O_CREAT | O_TRUNC);\n\n    // `logFd` might be write-only, so we reopen it for read.\n    auto in = raiiOpen(path, O_RDONLY);\n\n    // Only copy over the last `threshold` bytes of the log. We do this specifically to help deal\n    // with old grains that grew enormous logs before log rotation was introduced -- we'd like them\n    // to chop their logs down to size the first time they are opened. Note that this means \"log.1\"\n    // will tend to start mid-line, which is ugly, but it's probably not worth trying to avoid.\n    KJ_SYSCALL(lseek(in, stats.st_size - threshold, SEEK_SET));\n\n    // Transfer data using `sendfile()` to avoid unnecessary copies and context switches.\n    for (;;) {\n      ssize_t n;\n      KJ_SYSCALL(n = sendfile(out, in, nullptr, threshold));\n      if (n == 0) break;\n    }\n\n    // EOF. Quick, truncate before any other log data appears.\n    KJ_SYSCALL(ftruncate(logFd, 0));\n  }\n\n  return timer.afterDelay(5 * kj::MINUTES).then([=,&timer]() mutable {\n    return rotateLog(timer, logFd, path, threshold);\n  });\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Promise<void> rotateLog(kj::Timer& timer, int logFd, kj::StringPtr path, size_t threshold) {\n  struct stat stats;\n  KJ_SYSCALL(fstat(logFd, &stats));\n  if (stats.st_size >= threshold) {\n    // TODO(someday): If .1 exists, we could move it to .2, which we could move to .3, etc. We could\n    //   also gzip older logs to save space. But does anyone actually care? Probably not? Note that\n    //   if this changes, the lseek() below probably needs to be replaced with something more\n    //   sophisticated.\n    auto out = raiiOpen(kj::str(path, \".1\"), O_WRONLY | O_CREAT | O_TRUNC);\n\n    // `logFd` might be write-only, so we reopen it for read.\n    auto in = raiiOpen(path, O_RDONLY);\n\n    // Only copy over the last `threshold` bytes of the log. We do this specifically to help deal\n    // with old grains that grew enormous logs before log rotation was introduced -- we'd like them\n    // to chop their logs down to size the first time they are opened. Note that this means \"log.1\"\n    // will tend to start mid-line, which is ugly, but it's probably not worth trying to avoid.\n    KJ_SYSCALL(lseek(in, stats.st_size - threshold, SEEK_SET));\n\n    // Transfer data using `sendfile()` to avoid unnecessary copies and context switches.\n    for (;;) {\n      ssize_t n;\n      KJ_SYSCALL(n = sendfile(out, in, nullptr, threshold));\n      if (n == 0) break;\n    }\n\n    // EOF. Quick, truncate before any other log data appears.\n    KJ_SYSCALL(ftruncate(logFd, 0));\n  }\n\n  return timer.afterDelay(5 * kj::MINUTES).then([=,&timer]() mutable {\n    return rotateLog(timer, logFd, path, threshold);\n  });\n}"
        }
      },
      {
        "call_info": {
          "callee": "io.provider->getTimer",
          "args": [],
          "line": 2259
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "listener"
          ],
          "line": 2256
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "write",
          "args": [
            "outPipe",
            "\"ready\"",
            "5"
          ],
          "line": 2253
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "paf.fulfiller->fulfill",
          "args": [
            "kj::heap<BackendImpl>(*io.lowLevelProvider, network,\n        server.getBootstrap().castAs<SandstormCoreFactory>(), sandboxUid)"
          ],
          "line": 2249
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heap<BackendImpl>",
          "args": [
            "*io.lowLevelProvider",
            "network",
            "server.getBootstrap().castAs<SandstormCoreFactory>()",
            "sandboxUid"
          ],
          "line": 2249
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "server.getBootstrap",
          "args": [],
          "line": 2250
        },
        "resolved": true,
        "details": {
          "function_name": "getBootstrap",
          "container": "TwoPartyServerWithClientBootstrap",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "1250-1252",
          "snippet": "capnp::Capability::Client TwoPartyServerWithClientBootstrap::getBootstrap() {\n  return kj::addRef(*redirector);\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nTwoPartyServerWithClientBootstrap {\n  capnp::Capability::Client TwoPartyServerWithClientBootstrap::getBootstrap() {\n    return kj::addRef(*redirector);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "paf.promise"
          ],
          "line": 2248
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::newPromiseAndFulfiller<Backend::Client>",
          "args": [],
          "line": 2247
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "clearSignalMask",
          "args": [],
          "line": 2245
        },
        "resolved": true,
        "details": {
          "function_name": "clearSignalMask",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1499-1503",
          "snippet": "void clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "dropPrivs",
          "args": [
            "config.uids",
            "avoidUserns"
          ],
          "line": 2244
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "isUserNsAvailable",
          "args": [],
          "line": 2240
        },
        "resolved": true,
        "details": {
          "function_name": "isUserNsAvailable",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "183-212",
          "snippet": "bool isUserNsAvailable() {\n  Subprocess child([]() {\n    if (getuid() == 0) {\n      if (setuid(1000) < 0) {\n        // setuid() failed?\n        return 2;\n      }\n    }\n\n    if (unshare(CLONE_NEWUSER) < 0) {\n      return 1;\n    }\n\n    return 0;\n  });\n\n  int status = child.waitForExit();\n  switch (status) {\n    case 0:\n      return true;\n    case 1:\n      return false;\n    case 2:\n      KJ_LOG(ERROR, \"setuid() failed when trying to test if unprivileged userns works\");\n      return true;\n    default:\n      KJ_LOG(ERROR, \"userns test process exited with unexpected status code\", status);\n      return true;\n  }\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool isUserNsAvailable() {\n  Subprocess child([]() {\n    if (getuid() == 0) {\n      if (setuid(1000) < 0) {\n        // setuid() failed?\n        return 2;\n      }\n    }\n\n    if (unshare(CLONE_NEWUSER) < 0) {\n      return 1;\n    }\n\n    return 0;\n  });\n\n  int status = child.waitForExit();\n  switch (status) {\n    case 0:\n      return true;\n    case 1:\n      return false;\n    case 2:\n      KJ_LOG(ERROR, \"setuid() failed when trying to test if unprivileged userns works\");\n      return true;\n    default:\n      KJ_LOG(ERROR, \"userns test process exited with unexpected status code\", status);\n      return true;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chown(parent.cStr(), 0, config.uids.gid)"
          ],
          "line": 2233
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chown",
          "args": [
            "parent.cStr()",
            "0",
            "config.uids.gid"
          ],
          "line": 2233
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "parent.cStr",
          "args": [],
          "line": 2233
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chmod(parent.cStr(), 0770)"
          ],
          "line": 2232
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chmod",
          "args": [
            "parent.cStr()",
            "0770"
          ],
          "line": 2232
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "parent.cStr",
          "args": [],
          "line": 2232
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "socketPath.slice(0, *pos)"
          ],
          "line": 2231
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "socketPath.slice",
          "args": [
            "0",
            "*pos"
          ],
          "line": 2231
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "pos",
            "socketPath.findLast('/')"
          ],
          "line": 2230
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1662-1665",
          "snippet": "KJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }"
        }
      },
      {
        "call_info": {
          "callee": "socketPath.findLast",
          "args": [
            "'/'"
          ],
          "line": 2230
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chown(socketPath.cStr(), 0, config.uids.gid)"
          ],
          "line": 2227
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chown",
          "args": [
            "socketPath.cStr()",
            "0",
            "config.uids.gid"
          ],
          "line": 2227
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "socketPath.cStr",
          "args": [],
          "line": 2227
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chmod(socketPath.cStr(), 0770)"
          ],
          "line": 2226
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chmod",
          "args": [
            "socketPath.cStr()",
            "0770"
          ],
          "line": 2226
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "socketPath.cStr",
          "args": [],
          "line": 2226
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "network.parseAddress",
          "args": [],
          "line": 2221
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "network.parseAddress",
          "args": [
            "io.waitScope"
          ],
          "line": 2221
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "network.parseAddress",
          "args": [
            "kj::str(\"unix:\", socketPath)"
          ],
          "line": 2221
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"unix:\"",
            "socketPath"
          ],
          "line": 2221
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "io.provider->getNetwork",
          "args": [],
          "line": 2220
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::setupAsyncIo",
          "args": [],
          "line": 2219
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "socketPath.cStr()"
          ],
          "line": 2217
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "socketPath.cStr",
          "args": [],
          "line": 2217
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sandstorm::recursivelyCreateParent",
          "args": [
            "socketPath"
          ],
          "line": 2216
        },
        "resolved": true,
        "details": {
          "function_name": "recursivelyCreateParent",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "331-350",
          "snippet": "void recursivelyCreateParent(kj::StringPtr path) {\n  KJ_IF_MAYBE(pos, path.findLast('/')) {\n    if (*pos == 0) return;\n\n    kj::String parent = kj::heapString(path.slice(0, *pos));\n\n    bool firstTry = true;\n    while (mkdir(parent.cStr(), 0777) < 0) {\n      int error = errno;\n      if (firstTry && error == ENOENT) {\n        recursivelyCreateParent(parent);\n        firstTry = false;\n      } else if (error == EEXIST) {\n        break;\n      } else if (error != EINTR) {\n        KJ_FAIL_SYSCALL(\"mkdir(parent)\", error, parent);\n      }\n    }\n  }\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nvoid recursivelyCreateParent(kj::StringPtr path) {\n  KJ_IF_MAYBE(pos, path.findLast('/')) {\n    if (*pos == 0) return;\n\n    kj::String parent = kj::heapString(path.slice(0, *pos));\n\n    bool firstTry = true;\n    while (mkdir(parent.cStr(), 0777) < 0) {\n      int error = errno;\n      if (firstTry && error == ENOENT) {\n        recursivelyCreateParent(parent);\n        firstTry = false;\n      } else if (error == EEXIST) {\n        break;\n      } else if (error != EINTR) {\n        KJ_FAIL_SYSCALL(\"mkdir(parent)\", error, parent);\n      }\n    }\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::_::Debug::setLogLevel",
          "args": [
            "kj::LogSeverity::INFO"
          ],
          "line": 2213
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fdBundle.closeAll",
          "args": [],
          "line": 2209
        },
        "resolved": true,
        "details": {
          "function_name": "closeAll",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1693-1695",
          "snippet": "void closeAll() {\n      ports.clear();\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void closeAll() {\n        ports.clear();\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "pipe2(pipeFds, O_CLOEXEC)"
          ],
          "line": 2203
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pipe2",
          "args": [
            "pipeFds",
            "O_CLOEXEC"
          ],
          "line": 2203
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\npid_t startBackend(const Config& config, FdBundle& fdBundle) {\n    int pipeFds[2];\n    KJ_SYSCALL(pipe2(pipeFds, O_CLOEXEC));\n    kj::AutoCloseFd inPipe(pipeFds[0]);\n    kj::AutoCloseFd outPipe(pipeFds[1]);\n\n    Subprocess process([&]() -> int {\n      inPipe = nullptr;\n      fdBundle.closeAll();\n\n      // Mainly to cause Cap'n Proto to log exceptions being returned over RPC so we can see the\n      // stack traces.\n      kj::_::Debug::setLogLevel(kj::LogSeverity::INFO);\n\n      kj::StringPtr socketPath = Backend::SOCKET_PATH;\n      sandstorm::recursivelyCreateParent(socketPath);\n      unlink(socketPath.cStr());\n\n      auto io = kj::setupAsyncIo();\n      auto& network = io.provider->getNetwork();\n      auto listener = network.parseAddress(kj::str(\"unix:\", socketPath))\n          .wait(io.waitScope)->listen();\n\n      if (runningAsRoot) {\n        // Make socket available to server user.\n        KJ_SYSCALL(chmod(socketPath.cStr(), 0770));\n        KJ_SYSCALL(chown(socketPath.cStr(), 0, config.uids.gid));\n\n        // Also make the socket parent directory available to user.\n        KJ_IF_MAYBE(pos, socketPath.findLast('/')) {\n          kj::String parent = kj::heapString(socketPath.slice(0, *pos));\n          KJ_SYSCALL(chmod(parent.cStr(), 0770));\n          KJ_SYSCALL(chown(parent.cStr(), 0, config.uids.gid));\n        }\n      }\n\n      // If we're not running as root, we have to use user namespaces. Otherwise, dynamically\n      // check if they're available. If not, we'll need to pass superuser privileges on to the\n      // backend.\n      bool avoidUserns = runningAsRoot && !isUserNsAvailable();\n      kj::Maybe<uid_t> sandboxUid;\n      if (avoidUserns) sandboxUid = config.uids.uid;\n\n      dropPrivs(config.uids, avoidUserns);\n      clearSignalMask();\n\n      auto paf = kj::newPromiseAndFulfiller<Backend::Client>();\n      TwoPartyServerWithClientBootstrap server(kj::mv(paf.promise));\n      paf.fulfiller->fulfill(kj::heap<BackendImpl>(*io.lowLevelProvider, network,\n        server.getBootstrap().castAs<SandstormCoreFactory>(), sandboxUid));\n\n      // Signal readiness.\n      write(outPipe, \"ready\", 5);\n      outPipe = nullptr;\n\n      server.listen(kj::mv(listener))\n            // Rotate logs, keeping 1-2MB worth. We do this in the backend process mainly because\n            // it is the only asynchronous process in run-bundle.c++.\n            .exclusiveJoin(rotateLog(io.provider->getTimer(),\n                                     STDERR_FILENO, \"/var/log/sandstorm.log\", 1u << 20))\n            .wait(io.waitScope);\n      KJ_UNREACHABLE;\n    });\n\n    outPipe = nullptr;\n    KJ_ASSERT(sandstorm::readAll(inPipe) == \"ready\", \"starting back-end failed\");\n\n    pid_t result = process.getPid();\n    process.detach();\n    return result;\n  }"
  },
  {
    "function_name": "maybeCreateMongoUser",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2143-2199",
    "snippet": "void maybeCreateMongoUser(const Config& config, FdBundle& fdBundle) {\n    if (access(\"/var/mongo/passwd\", F_OK) != 0) {\n      // We need to initialize the repl set to get oplog tailing. Our set isn't actually much of a\n      // set since it only contains one instance, but you need that for oplog.\n      mongoCommand(config, fdBundle, kj::str(\n          \"rs.initiate({_id: 'ssrs', members: [{_id: 0, host: 'localhost:\",\n          config.mongoPort, \"'}]})\"));\n\n      // We have to wait a few seconds for Mongo to elect itself master of the repl set. Mongo does\n      // some sort of heartbeat every second and it takes three of these for Mongo to elect itself,\n      // meaning the whole process always takes 2-3 seconds. We'll sleep for 4.\n      // TODO(cleanup): This is ugly.\n      {\n        int n = 4;\n        while (n > 0) n = sleep(n);\n      }\n\n      // Get 20 random bytes for password.\n      kj::byte bytes[20];\n      kj::FdInputStream random(raiiOpen(\"/dev/urandom\", O_RDONLY));\n      random.read(bytes, sizeof(bytes));\n\n      // Base64 encode them.\n      // TODO(cleanup): Move to libkj.\n      const char* digits =\n          \"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_\";\n      uint buffer = 0;\n      uint bufferBits = 0;\n      kj::Vector<char> chars;\n      for (kj::byte b: bytes) {\n        buffer |= kj::implicitCast<uint>(b) << bufferBits;\n        bufferBits += 8;\n\n        while (bufferBits >= 6) {\n          chars.add(digits[buffer & 0x3f]);\n          buffer >>= 6;\n          bufferBits -= 6;\n        }\n      }\n      if (bufferBits > 0) {\n        chars.add(digits[buffer & 0x3f]);\n      }\n      chars.add('\\0');\n      kj::String password(chars.releaseAsArray());\n\n      // Create the mongo user.\n      auto command = kj::str(\n        \"db.createUser({user: \\\"sandstorm\\\", pwd: \\\"\", password, \"\\\", \"\n        \"roles: [\\\"readWriteAnyDatabase\\\",\\\"userAdminAnyDatabase\\\",\\\"dbAdminAnyDatabase\\\"]})\");\n      mongoCommand(config, fdBundle, command, \"admin\");\n\n      // Store the password.\n      auto outFd = raiiOpen(\"/var/mongo/passwd\", O_WRONLY | O_CREAT | O_EXCL, 0640);\n      if (runningAsRoot) { KJ_SYSCALL(fchown(outFd, config.uids.uid, config.uids.gid)); }\n      kj::FdOutputStream((int)outFd).write(password.begin(), password.size());\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool runningAsRoot = getuid() == 0;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "password.begin()",
            "password.size()"
          ],
          "line": 2197
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "password.size",
          "args": [],
          "line": 2197
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "password.begin",
          "args": [],
          "line": 2197
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "(int)outFd"
          ],
          "line": 2197
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fchown(outFd, config.uids.uid, config.uids.gid)"
          ],
          "line": 2196
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fchown",
          "args": [
            "outFd",
            "config.uids.uid",
            "config.uids.gid"
          ],
          "line": 2196
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"/var/mongo/passwd\"",
            "O_WRONLY | O_CREAT | O_EXCL",
            "0640"
          ],
          "line": 2195
        },
        "resolved": true,
        "details": {
          "function_name": "raiiOpenIfExists",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "71-82",
          "snippet": "kj::Maybe<kj::AutoCloseFd> raiiOpenIfExists(kj::StringPtr name, int flags, mode_t mode) {\n  int fd = open(name.cStr(), flags, mode);\n  if (fd == -1) {\n    if (errno == ENOENT) {\n      return nullptr;\n    } else {\n      KJ_FAIL_SYSCALL(\"open\", errno, name);\n    }\n  } else {\n    return kj::AutoCloseFd(fd);\n  }\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<kj::AutoCloseFd> raiiOpenIfExists(kj::StringPtr name, int flags, mode_t mode) {\n  int fd = open(name.cStr(), flags, mode);\n  if (fd == -1) {\n    if (errno == ENOENT) {\n      return nullptr;\n    } else {\n      KJ_FAIL_SYSCALL(\"open\", errno, name);\n    }\n  } else {\n    return kj::AutoCloseFd(fd);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "mongoCommand",
          "args": [
            "config",
            "fdBundle",
            "command",
            "\"admin\""
          ],
          "line": 2192
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"db.createUser({user: \\\"sandstorm\\\", pwd: \\\"\"",
            "password",
            "\"\\\", \"\n        \"roles: [\\\"readWriteAnyDatabase\\\",\\\"userAdminAnyDatabase\\\",\\\"dbAdminAnyDatabase\\\"]})\""
          ],
          "line": 2189
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chars.releaseAsArray",
          "args": [],
          "line": 2186
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chars.add",
          "args": [
            "'\\0'"
          ],
          "line": 2185
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chars.add",
          "args": [
            "digits[buffer & 0x3f]"
          ],
          "line": 2183
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chars.add",
          "args": [
            "digits[buffer & 0x3f]"
          ],
          "line": 2177
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::implicitCast<uint>",
          "args": [
            "b"
          ],
          "line": 2173
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "random.read",
          "args": [
            "bytes",
            "sizeof(bytes)"
          ],
          "line": 2163
        },
        "resolved": true,
        "details": {
          "function_name": "read",
          "container": "SimpleDataFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/union-fs.c++",
          "lines": "529-533",
          "snippet": "kj::Array<uint8_t> read(uint64_t offset0, uint32_t size0) override {\n    auto offset = kj::min(data.size(), offset0);\n    auto size = kj::min(data.size() - offset, size0);\n    return kj::heapArray(data.slice(offset, offset + size));\n  }",
          "includes": [
            "#include \"util.h\"",
            "#include \"fuse.h\"",
            "#include <stdlib.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <fcntl.h>",
            "#include <unistd.h>",
            "#include <set>",
            "#include <map>",
            "#include <capnp/serialize.h>",
            "#include <kj/debug.h>",
            "#include <kj/vector.h>",
            "#include \"union-fs.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include \"fuse.h\"\n#include <stdlib.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <unistd.h>\n#include <set>\n#include <map>\n#include <capnp/serialize.h>\n#include <kj/debug.h>\n#include <kj/vector.h>\n#include \"union-fs.h\"\n\nSimpleDataFile {\n  kj::Array<uint8_t> read(uint64_t offset0, uint32_t size0) override {\n      auto offset = kj::min(data.size(), offset0);\n      auto size = kj::min(data.size() - offset, size0);\n      return kj::heapArray(data.slice(offset, offset + size));\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"/dev/urandom\"",
            "O_RDONLY"
          ],
          "line": 2162
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sleep",
          "args": [
            "n"
          ],
          "line": 2157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mongoCommand",
          "args": [
            "config",
            "fdBundle",
            "kj::str(\n          \"rs.initiate({_id: 'ssrs', members: [{_id: 0, host: 'localhost:\",\n          config.mongoPort, \"'}]})\")"
          ],
          "line": 2147
        },
        "resolved": true,
        "details": {
          "function_name": "mongoCommand",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2929-2952",
          "snippet": "void mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\nvoid mongoCommand(const Config& config, FdBundle& fdBundle,\n                    kj::StringPtr command, kj::StringPtr db = \"meteor\") {\n    char commandFile[] = \"/tmp/mongo-command.XXXXXX\";\n    int commandRawFd;\n    KJ_SYSCALL(commandRawFd = mkstemp(commandFile));\n    kj::AutoCloseFd commandFd(commandRawFd);\n    KJ_DEFER(unlink(commandFile));\n    if (runningAsRoot) {\n      KJ_SYSCALL(fchown(commandRawFd, -1, config.uids.gid));\n      KJ_SYSCALL(fchmod(commandRawFd, 0660));\n    }\n    kj::FdOutputStream(kj::mv(commandFd)).write(command.begin(), command.size());\n\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n\n      // Don't run as root.\n      dropPrivs(config.uids);\n\n      execMongoClient(config, {\"--quiet\"}, {commandFile}, db);\n      KJ_UNREACHABLE;\n    });\n    process.waitForSuccess();\n  }"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"rs.initiate({_id: 'ssrs', members: [{_id: 0, host: 'localhost:\"",
            "config.mongoPort",
            "\"'}]})\""
          ],
          "line": 2147
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"/var/mongo/passwd\"",
            "F_OK"
          ],
          "line": 2144
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\nvoid maybeCreateMongoUser(const Config& config, FdBundle& fdBundle) {\n    if (access(\"/var/mongo/passwd\", F_OK) != 0) {\n      // We need to initialize the repl set to get oplog tailing. Our set isn't actually much of a\n      // set since it only contains one instance, but you need that for oplog.\n      mongoCommand(config, fdBundle, kj::str(\n          \"rs.initiate({_id: 'ssrs', members: [{_id: 0, host: 'localhost:\",\n          config.mongoPort, \"'}]})\"));\n\n      // We have to wait a few seconds for Mongo to elect itself master of the repl set. Mongo does\n      // some sort of heartbeat every second and it takes three of these for Mongo to elect itself,\n      // meaning the whole process always takes 2-3 seconds. We'll sleep for 4.\n      // TODO(cleanup): This is ugly.\n      {\n        int n = 4;\n        while (n > 0) n = sleep(n);\n      }\n\n      // Get 20 random bytes for password.\n      kj::byte bytes[20];\n      kj::FdInputStream random(raiiOpen(\"/dev/urandom\", O_RDONLY));\n      random.read(bytes, sizeof(bytes));\n\n      // Base64 encode them.\n      // TODO(cleanup): Move to libkj.\n      const char* digits =\n          \"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_\";\n      uint buffer = 0;\n      uint bufferBits = 0;\n      kj::Vector<char> chars;\n      for (kj::byte b: bytes) {\n        buffer |= kj::implicitCast<uint>(b) << bufferBits;\n        bufferBits += 8;\n\n        while (bufferBits >= 6) {\n          chars.add(digits[buffer & 0x3f]);\n          buffer >>= 6;\n          bufferBits -= 6;\n        }\n      }\n      if (bufferBits > 0) {\n        chars.add(digits[buffer & 0x3f]);\n      }\n      chars.add('\\0');\n      kj::String password(chars.releaseAsArray());\n\n      // Create the mongo user.\n      auto command = kj::str(\n        \"db.createUser({user: \\\"sandstorm\\\", pwd: \\\"\", password, \"\\\", \"\n        \"roles: [\\\"readWriteAnyDatabase\\\",\\\"userAdminAnyDatabase\\\",\\\"dbAdminAnyDatabase\\\"]})\");\n      mongoCommand(config, fdBundle, command, \"admin\");\n\n      // Store the password.\n      auto outFd = raiiOpen(\"/var/mongo/passwd\", O_WRONLY | O_CREAT | O_EXCL, 0640);\n      if (runningAsRoot) { KJ_SYSCALL(fchown(outFd, config.uids.uid, config.uids.gid)); }\n      kj::FdOutputStream((int)outFd).write(password.begin(), password.size());\n    }\n  }"
  },
  {
    "function_name": "startMongo",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "2060-2141",
    "snippet": "pid_t startMongo(const Config& config, FdBundle& fdBundle) {\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n      dropPrivs(config.uids);\n      clearSignalMask();\n\n      // Before starting Mongo, we remove \"mongod.lock\" basically unconditionally.\n      //\n      // Here's how MongoDB wants to use this lockfile: If MongoDB stopped abruptly in the past, and\n      // there is no journal, then MongoDB wants to prompt the admin to start it with\n      // --recover. Presumably it refuses to repair automatically in the absence of a journal\n      // because it can't always be sure of how to do recovery.\n      //\n      // If replica sets are enabled, MongoDB would prefer to ask the admin to restore it from a\n      // replica. Indeed, we do have replica sets enabled. But we can't restore from a replica\n      // because there is just \"one replica\" -- replica sets are enabled merely to enable Meteor to\n      // do oplog tailing.\n      //\n      // In our case, we do have journaling enabled, and we have no replica we can restore from, so\n      // in the case of crash, the best we can do is ask MongoDB to start itself up and restore from\n      // journal. That's what removing the lock file means.\n      //\n      // See http://docs.mongodb.org/manual/reference/command/repairDatabase/ and\n      // http://docs.mongodb.org/manual/tutorial/recover-data-following-unexpected-shutdown/ for\n      // more information.\n      kj::String lockFilePath = kj::str(\"/var/mongo/mongod.lock\");\n      if (access(lockFilePath.cStr(), F_OK) == 0) {\n        kj::String contents = trim(readAll(raiiOpen(lockFilePath.cStr(), O_RDONLY)));\n        if (contents != \"\") {\n          // This file should contain a PID, hence UInt.\n          //\n          // If somehow there are two instances of Sandstorm running, and the other one is running a\n          // mongod, then this action could dangerously cause two mongod instances to be\n          // running. However, in that case, we also can't see the other process, since it's in a\n          // pid namespace. So this is all the sanity-checking we can do.\n          KJ_ASSERT_NONNULL(parseUInt(contents, 10),\n                            \"mongod.lock exists & contains non-integer, refusing to unlink\");\n          context.warning(\"Found a stale mongod lock file. Removing it.\");\n          unlink(lockFilePath.cStr());\n        }\n      }\n\n      KJ_SYSCALL(execl(\"/bin/mongod\", \"/bin/mongod\", \"--fork\",\n          \"--bind_ip\", \"127.0.0.1\", \"--port\", kj::str(config.mongoPort).cStr(),\n          \"--dbpath\", \"/var/mongo\", \"--logpath\", \"/var/log/mongo.log\",\n          \"--pidfilepath\", \"/var/pid/mongo.pid\",\n          \"--auth\", \"--nohttpinterface\", \"--noprealloc\", \"--nopreallocj\", \"--smallfiles\",\n          \"--replSet\", \"ssrs\", \"--oplogSize\", \"16\",\n          EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    });\n\n    // Wait for mongod to return, meaning the database is up.  Then get its real pid via the\n    // pidfile.\n    auto status = process.waitForExit();\n\n    if (status == 0) {\n      // Even after the startup command exits, MongoDB takes exactly two seconds to elect itself as\n      // master of the repl set (of which it is the only damned member). Unforutnately, if Node\n      // connects during this time, it fails, sometimes without actually exiting, leaving the entire\n      // server hosed. It appears that this always takes exactly two seconds from startup, since\n      // MongoDB does some sort of heartbeat every second where it checks the replset status, and it\n      // takes three of these for the election to complete, and the first of the three happens\n      // immediately on startup, meaning the last one is two seconds in. So, we'll sleep for 3\n      // seconds to be safe.\n      // TODO(cleanup): There must be a better way...\n      int n = 3;\n      while (n > 0) n = sleep(n);\n      KJ_IF_MAYBE(mongoPid, parseUInt(trim(readAll(\"/var/pid/mongo.pid\")), 10)) {\n        return *mongoPid;\n      }\n    }\n\n    // If we got here, mongod either exited non-zero, or has no PID in its pidfile. In that case,\n    // we do not know how proceed.\n    KJ_FAIL_ASSERT(\"**mongod failed to start. Initial exit code: \", status,\n                   \"bailing out now. For troubleshooting, read \"\n                   \"/opt/sandstorm/var/log/mongo.log (or var/log/mongo.log within your Sandstorm \"\n                   \"if installed to a different place) and visit: \"\n                   \"https://docs.sandstorm.io/en/latest/search.html?q=mongod+failed+to+start\");\n    return 0;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_FAIL_ASSERT",
          "args": [
            "\"**mongod failed to start. Initial exit code: \"",
            "status",
            "\"bailing out now. For troubleshooting, read \"\n                   \"/opt/sandstorm/var/log/mongo.log (or var/log/mongo.log within your Sandstorm \"\n                   \"if installed to a different place) and visit: \"\n                   \"https://docs.sandstorm.io/en/latest/search.html?q=mongod+failed+to+start\""
          ],
          "line": 2135
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "mongoPid",
            "parseUInt(trim(readAll(\"/var/pid/mongo.pid\")), 10)"
          ],
          "line": 2128
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1662-1665",
          "snippet": "KJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }"
        }
      },
      {
        "call_info": {
          "callee": "parseUInt",
          "args": [
            "trim(readAll(\"/var/pid/mongo.pid\"))",
            "10"
          ],
          "line": 2128
        },
        "resolved": true,
        "details": {
          "function_name": "parseUInt64",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "223-230",
          "snippet": "kj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "trim",
          "args": [
            "readAll(\"/var/pid/mongo.pid\")"
          ],
          "line": 2128
        },
        "resolved": true,
        "details": {
          "function_name": "trim",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "202-204",
          "snippet": "kj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}"
        }
      },
      {
        "call_info": {
          "callee": "readAll",
          "args": [
            "\"/var/pid/mongo.pid\""
          ],
          "line": 2128
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      },
      {
        "call_info": {
          "callee": "sleep",
          "args": [
            "n"
          ],
          "line": 2127
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "process.waitForExit",
          "args": [],
          "line": 2114
        },
        "resolved": true,
        "details": {
          "function_name": "waitForExitOrSignal",
          "container": "Subprocess",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "1010-1019",
          "snippet": "int Subprocess::waitForExitOrSignal() {\n  KJ_REQUIRE(pid != 0, \"already waited for this child\");\n  int status;\n  KJ_SYSCALL(waitpid(pid, &status, 0));\n  KJ_IF_MAYBE(s, subprocessSet) {\n    s->alreadyReaped(pid);\n  }\n  pid = 0;\n  return status;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nSubprocess {\n  int Subprocess::waitForExitOrSignal() {\n    KJ_REQUIRE(pid != 0, \"already waited for this child\");\n    int status;\n    KJ_SYSCALL(waitpid(pid, &status, 0));\n    KJ_IF_MAYBE(s, subprocessSet) {\n      s->alreadyReaped(pid);\n    }\n    pid = 0;\n    return status;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "execl(\"/bin/mongod\", \"/bin/mongod\", \"--fork\",\n          \"--bind_ip\", \"127.0.0.1\", \"--port\", kj::str(config.mongoPort).cStr(),\n          \"--dbpath\", \"/var/mongo\", \"--logpath\", \"/var/log/mongo.log\",\n          \"--pidfilepath\", \"/var/pid/mongo.pid\",\n          \"--auth\", \"--nohttpinterface\", \"--noprealloc\", \"--nopreallocj\", \"--smallfiles\",\n          \"--replSet\", \"ssrs\", \"--oplogSize\", \"16\",\n          EXEC_END_ARGS)"
          ],
          "line": 2102
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "execl",
          "args": [
            "\"/bin/mongod\"",
            "\"/bin/mongod\"",
            "\"--fork\"",
            "\"--bind_ip\"",
            "\"127.0.0.1\"",
            "\"--port\"",
            "kj::str(config.mongoPort).cStr()",
            "\"--dbpath\"",
            "\"/var/mongo\"",
            "\"--logpath\"",
            "\"/var/log/mongo.log\"",
            "\"--pidfilepath\"",
            "\"/var/pid/mongo.pid\"",
            "\"--auth\"",
            "\"--nohttpinterface\"",
            "\"--noprealloc\"",
            "\"--nopreallocj\"",
            "\"--smallfiles\"",
            "\"--replSet\"",
            "\"ssrs\"",
            "\"--oplogSize\"",
            "\"16\"",
            "EXEC_END_ARGS"
          ],
          "line": 2102
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [],
          "line": 2103
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "config.mongoPort"
          ],
          "line": 2103
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "lockFilePath.cStr()"
          ],
          "line": 2098
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "lockFilePath.cStr",
          "args": [],
          "line": 2098
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Found a stale mongod lock file. Removing it.\""
          ],
          "line": 2097
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT_NONNULL",
          "args": [
            "parseUInt(contents, 10)",
            "\"mongod.lock exists & contains non-integer, refusing to unlink\""
          ],
          "line": 2095
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "lockFilePath.cStr()",
            "O_RDONLY"
          ],
          "line": 2087
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "lockFilePath.cStr",
          "args": [],
          "line": 2087
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "lockFilePath.cStr()",
            "F_OK"
          ],
          "line": 2086
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "lockFilePath.cStr",
          "args": [],
          "line": 2086
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/mongo/mongod.lock\""
          ],
          "line": 2085
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "clearSignalMask",
          "args": [],
          "line": 2064
        },
        "resolved": true,
        "details": {
          "function_name": "clearSignalMask",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1499-1503",
          "snippet": "void clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "dropPrivs",
          "args": [
            "config.uids"
          ],
          "line": 2063
        },
        "resolved": true,
        "details": {
          "function_name": "dropPrivs",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1451-1497",
          "snippet": "void dropPrivs(const UserIds& uids, bool keepRealUid = false) {\n    // Defense in depth: Don't give my children any new caps for any reason.\n    KJ_SYSCALL(prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0));\n\n    if (runningAsRoot) {\n      KJ_SYSCALL(setresgid(uids.gid, uids.gid, uids.gid));\n      KJ_SYSCALL(setgroups(uids.groups.size(), uids.groups.begin()));\n\n      if (keepRealUid) {\n        // We're prepping to run the backend and user namespaces are not available, therefore the\n        // backend needs to keep its superuser powers stashed in order to hand them off to the\n        // grain supervisors so that they can set up sandboxes. Instead of creating a suid binary\n        // (with all the danger that entails), we merely drop the effective UID, but raise it again\n        // when invoking the supervisor.\n        KJ_SYSCALL(seteuid(uids.uid));\n      } else {\n        KJ_SYSCALL(setresuid(uids.uid, uids.uid, uids.uid));\n      }\n    } else {\n      // We're using UID namespaces.\n\n      KJ_ASSERT(!keepRealUid);\n\n      // Defense in depth: Drop all capabilities from the set of caps which my children are allowed\n      //   to ever have.\n      for (uint cap: kj::range(0, CAP_LAST_CAP + 1)) {\n        // TODO(soon): I spontaneously started getting EINVAL here, but only in production, so I\n        //   had to remove the error check. Figure out what happened and re-enable it. Maybe it\n        //   makes sense to read the bset first and then only drop the caps in it?\n        prctl(PR_CAPBSET_DROP, cap, 0, 0, 0);\n      }\n\n      // Defense in depth: Don't grant my children capabilities just because they have UID 0.\n      KJ_SYSCALL(prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED));\n\n      // Drop all Linux \"capabilities\".  (These are Linux/POSIX \"capabilities\", which are not true\n      // object-capabilities, hence the quotes.)\n      struct __user_cap_header_struct hdr;\n      struct __user_cap_data_struct data[2];\n      hdr.version = _LINUX_CAPABILITY_VERSION_3;\n      hdr.pid = 0;\n      memset(data, 0, sizeof(data));  // All capabilities disabled!\n      KJ_SYSCALL(capset(&hdr, data));\n    }\n\n    umask(0007);\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;",
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool runningAsRoot = getuid() == 0;\n\nvoid dropPrivs(const UserIds& uids, bool keepRealUid = false) {\n    // Defense in depth: Don't give my children any new caps for any reason.\n    KJ_SYSCALL(prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0));\n\n    if (runningAsRoot) {\n      KJ_SYSCALL(setresgid(uids.gid, uids.gid, uids.gid));\n      KJ_SYSCALL(setgroups(uids.groups.size(), uids.groups.begin()));\n\n      if (keepRealUid) {\n        // We're prepping to run the backend and user namespaces are not available, therefore the\n        // backend needs to keep its superuser powers stashed in order to hand them off to the\n        // grain supervisors so that they can set up sandboxes. Instead of creating a suid binary\n        // (with all the danger that entails), we merely drop the effective UID, but raise it again\n        // when invoking the supervisor.\n        KJ_SYSCALL(seteuid(uids.uid));\n      } else {\n        KJ_SYSCALL(setresuid(uids.uid, uids.uid, uids.uid));\n      }\n    } else {\n      // We're using UID namespaces.\n\n      KJ_ASSERT(!keepRealUid);\n\n      // Defense in depth: Drop all capabilities from the set of caps which my children are allowed\n      //   to ever have.\n      for (uint cap: kj::range(0, CAP_LAST_CAP + 1)) {\n        // TODO(soon): I spontaneously started getting EINVAL here, but only in production, so I\n        //   had to remove the error check. Figure out what happened and re-enable it. Maybe it\n        //   makes sense to read the bset first and then only drop the caps in it?\n        prctl(PR_CAPBSET_DROP, cap, 0, 0, 0);\n      }\n\n      // Defense in depth: Don't grant my children capabilities just because they have UID 0.\n      KJ_SYSCALL(prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED));\n\n      // Drop all Linux \"capabilities\".  (These are Linux/POSIX \"capabilities\", which are not true\n      // object-capabilities, hence the quotes.)\n      struct __user_cap_header_struct hdr;\n      struct __user_cap_data_struct data[2];\n      hdr.version = _LINUX_CAPABILITY_VERSION_3;\n      hdr.pid = 0;\n      memset(data, 0, sizeof(data));  // All capabilities disabled!\n      KJ_SYSCALL(capset(&hdr, data));\n    }\n\n    umask(0007);\n  }"
        }
      },
      {
        "call_info": {
          "callee": "fdBundle.closeAll",
          "args": [],
          "line": 2062
        },
        "resolved": true,
        "details": {
          "function_name": "closeAll",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1693-1695",
          "snippet": "void closeAll() {\n      ports.clear();\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void closeAll() {\n        ports.clear();\n      }\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\npid_t startMongo(const Config& config, FdBundle& fdBundle) {\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n      dropPrivs(config.uids);\n      clearSignalMask();\n\n      // Before starting Mongo, we remove \"mongod.lock\" basically unconditionally.\n      //\n      // Here's how MongoDB wants to use this lockfile: If MongoDB stopped abruptly in the past, and\n      // there is no journal, then MongoDB wants to prompt the admin to start it with\n      // --recover. Presumably it refuses to repair automatically in the absence of a journal\n      // because it can't always be sure of how to do recovery.\n      //\n      // If replica sets are enabled, MongoDB would prefer to ask the admin to restore it from a\n      // replica. Indeed, we do have replica sets enabled. But we can't restore from a replica\n      // because there is just \"one replica\" -- replica sets are enabled merely to enable Meteor to\n      // do oplog tailing.\n      //\n      // In our case, we do have journaling enabled, and we have no replica we can restore from, so\n      // in the case of crash, the best we can do is ask MongoDB to start itself up and restore from\n      // journal. That's what removing the lock file means.\n      //\n      // See http://docs.mongodb.org/manual/reference/command/repairDatabase/ and\n      // http://docs.mongodb.org/manual/tutorial/recover-data-following-unexpected-shutdown/ for\n      // more information.\n      kj::String lockFilePath = kj::str(\"/var/mongo/mongod.lock\");\n      if (access(lockFilePath.cStr(), F_OK) == 0) {\n        kj::String contents = trim(readAll(raiiOpen(lockFilePath.cStr(), O_RDONLY)));\n        if (contents != \"\") {\n          // This file should contain a PID, hence UInt.\n          //\n          // If somehow there are two instances of Sandstorm running, and the other one is running a\n          // mongod, then this action could dangerously cause two mongod instances to be\n          // running. However, in that case, we also can't see the other process, since it's in a\n          // pid namespace. So this is all the sanity-checking we can do.\n          KJ_ASSERT_NONNULL(parseUInt(contents, 10),\n                            \"mongod.lock exists & contains non-integer, refusing to unlink\");\n          context.warning(\"Found a stale mongod lock file. Removing it.\");\n          unlink(lockFilePath.cStr());\n        }\n      }\n\n      KJ_SYSCALL(execl(\"/bin/mongod\", \"/bin/mongod\", \"--fork\",\n          \"--bind_ip\", \"127.0.0.1\", \"--port\", kj::str(config.mongoPort).cStr(),\n          \"--dbpath\", \"/var/mongo\", \"--logpath\", \"/var/log/mongo.log\",\n          \"--pidfilepath\", \"/var/pid/mongo.pid\",\n          \"--auth\", \"--nohttpinterface\", \"--noprealloc\", \"--nopreallocj\", \"--smallfiles\",\n          \"--replSet\", \"ssrs\", \"--oplogSize\", \"16\",\n          EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    });\n\n    // Wait for mongod to return, meaning the database is up.  Then get its real pid via the\n    // pidfile.\n    auto status = process.waitForExit();\n\n    if (status == 0) {\n      // Even after the startup command exits, MongoDB takes exactly two seconds to elect itself as\n      // master of the repl set (of which it is the only damned member). Unforutnately, if Node\n      // connects during this time, it fails, sometimes without actually exiting, leaving the entire\n      // server hosed. It appears that this always takes exactly two seconds from startup, since\n      // MongoDB does some sort of heartbeat every second where it checks the replset status, and it\n      // takes three of these for the election to complete, and the first of the three happens\n      // immediately on startup, meaning the last one is two seconds in. So, we'll sleep for 3\n      // seconds to be safe.\n      // TODO(cleanup): There must be a better way...\n      int n = 3;\n      while (n > 0) n = sleep(n);\n      KJ_IF_MAYBE(mongoPid, parseUInt(trim(readAll(\"/var/pid/mongo.pid\")), 10)) {\n        return *mongoPid;\n      }\n    }\n\n    // If we got here, mongod either exited non-zero, or has no PID in its pidfile. In that case,\n    // we do not know how proceed.\n    KJ_FAIL_ASSERT(\"**mongod failed to start. Initial exit code: \", status,\n                   \"bailing out now. For troubleshooting, read \"\n                   \"/opt/sandstorm/var/log/mongo.log (or var/log/mongo.log within your Sandstorm \"\n                   \"if installed to a different place) and visit: \"\n                   \"https://docs.sandstorm.io/en/latest/search.html?q=mongod+failed+to+start\");\n    return 0;\n  }"
  },
  {
    "function_name": "runServerMonitor",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1922-2058",
    "snippet": "[[noreturn]] void runServerMonitor(const Config& config, FdBundle& fdBundle) {\n    // Run the server monitor, which runs node and mongo and deals with them dying.\n\n    enterChroot(true);\n\n    // For later use when killing children with timeout.\n    registerAlarmHandler();\n\n    // MongoDB forks a subprocess but we want to be its reaper.\n    KJ_SYSCALL(prctl(PR_SET_CHILD_SUBREAPER, 1, 0, 0, 0));\n\n    auto sigfd = prepareMonitoringLoop();\n\n    context.warning(\"** Starting back-end...\");\n    pid_t backendPid = startBackend(config, fdBundle);\n    uint64_t backendStartTime = getTime();\n\n    context.warning(\"** Starting MongoDB...\");\n    pid_t mongoPid = startMongo(config, fdBundle);\n    int64_t mongoStartTime = getTime();\n\n    // Create the mongo user if it hasn't been created already.\n    maybeCreateMongoUser(config, fdBundle);\n\n    context.warning(\"** Back-end and Mongo started; now starting front-end...\");\n\n    // If we're root, run the dev daemon. At present the dev daemon requires root (in order to\n    // use FUSE), so we don't run it if we aren't root.\n    pid_t devDaemonPid;\n    if (runningAsRoot) {\n      KJ_SYSCALL(devDaemonPid = fork());\n      if (devDaemonPid == 0) {\n        // Ugh, undo the setup we *just* did. Note that we can't just fork the dev daemon earlier\n        // because it wants to connect to mongo first thing.\n        sigfd = nullptr;\n        clearSignalMask();\n        KJ_SYSCALL(signal(SIGALRM, SIG_DFL));\n        fdBundle.closeAll();\n        runDevDaemon(config);\n        KJ_UNREACHABLE;\n      }\n    } else {\n      devDaemonPid = 0;\n      context.warning(\"Note: Not accepting \\\"spk dev\\\" connections because not running as root.\");\n    }\n\n    pid_t nodePid = startNode(config, fdBundle);\n    int64_t nodeStartTime = getTime();\n\n    for (;;) {\n      // Wait for a signal -- any signal.\n      struct signalfd_siginfo siginfo;\n      KJ_SYSCALL(read(sigfd, &siginfo, sizeof(siginfo)));\n\n      if (siginfo.ssi_signo == SIGCHLD) {\n        // Some child exited.  If it's Mongo or Node we have a problem, but it could also be some\n        // grandchild that was orphaned and thus reparented to the PID namespace's init process,\n        // which is us.\n\n        // Reap zombies until there are no more.\n        bool backendDied = false;\n        bool mongoDied = false;\n        bool nodeDied = false;\n        for (;;) {\n          int status;\n          pid_t deadPid = waitpid(-1, &status, WNOHANG);\n          if (deadPid <= 0) {\n            // No more zombies.\n            break;\n          } else if (deadPid == backendPid) {\n            backendDied = true;\n          } else if (deadPid == mongoPid) {\n            mongoDied = true;\n          } else if (deadPid == nodePid) {\n            nodeDied = true;\n          } else if (deadPid == devDaemonPid) {\n            // We don't restart the dev daemon since it should never crash in the first place.\n            // Just record that we already reaped it.\n            devDaemonPid = 0;\n          }\n        }\n\n        // Deal with mongo or node dying.\n        if (backendDied) {\n          maybeWaitAfterChildDeath(\"Back-end\", backendStartTime);\n          backendPid = startBackend(config, fdBundle);\n          backendStartTime = getTime();\n        }\n        if (mongoDied) {\n          maybeWaitAfterChildDeath(\"MongoDB\", mongoStartTime);\n          mongoPid = startMongo(config, fdBundle);\n          mongoStartTime = getTime();\n        }\n        if (nodeDied) {\n          maybeWaitAfterChildDeath(\"Front-end\", nodeStartTime);\n          nodePid = startNode(config, fdBundle);\n          nodeStartTime = getTime();\n        }\n\n        if (mongoDied && !nodeDied) {\n          // If the back-end died then we unfortunately need to restart node as well.\n          context.warning(\"** Restarting front-end due to back-end failure\");\n          killChild(\"Front-end\", nodePid);\n          nodePid = startNode(config, fdBundle);\n          nodeStartTime = getTime();\n        }\n      } else if (siginfo.ssi_signo == SIGINT) {\n        if (siginfo.ssi_int) {\n          // Requested startup of front-end after previous shutdown.\n          if (nodePid == 0) {\n            context.warning(\"** Starting front-end by admin request\");\n            fdBundle = FdBundle(config);  // re-open FDs\n            nodePid = startNode(config, fdBundle);\n            nodeStartTime = getTime();\n          } else {\n            context.warning(\"** Request to start front-end, but it is already running\");\n          }\n        } else {\n          // Requested shutdown of the front-end but not the back-end.\n          context.warning(\"** Shutting down front-end by admin request\");\n          killChild(\"Front-end\", nodePid);\n          nodePid = 0;\n\n          // We have to close the FD bundle otherwise run-dev won't work.\n          fdBundle.closeAll();\n        }\n      } else {\n        // SIGTERM or something.\n        context.warning(\"** Shutting down due to signal\");\n        killChild(\"Front-end\", nodePid);\n        killChild(\"MongoDB\", mongoPid);\n        killChild(\"Back-end\", backendPid);\n        killChild(\"Dev daemon\", devDaemonPid);\n        context.exit();\n      }\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool runningAsRoot = getuid() == 0;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exit",
          "args": [],
          "line": 2055
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "killChild",
          "args": [
            "\"Dev daemon\"",
            "devDaemonPid"
          ],
          "line": 2054
        },
        "resolved": true,
        "details": {
          "function_name": "killChild",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2377-2413",
          "snippet": "void killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nvoid killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Shutting down due to signal\""
          ],
          "line": 2050
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fdBundle.closeAll",
          "args": [],
          "line": 2046
        },
        "resolved": true,
        "details": {
          "function_name": "closeAll",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1693-1695",
          "snippet": "void closeAll() {\n      ports.clear();\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void closeAll() {\n        ports.clear();\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Shutting down front-end by admin request\""
          ],
          "line": 2041
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Request to start front-end, but it is already running\""
          ],
          "line": 2037
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getTime",
          "args": [],
          "line": 2035
        },
        "resolved": true,
        "details": {
          "function_name": "getTime",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1289-1293",
          "snippet": "int64_t getTime() {\n    struct timespec ts;\n    KJ_SYSCALL(clock_gettime(CLOCK_MONOTONIC, &ts));\n    return ts.tv_sec * 1000000000ll + ts.tv_nsec;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nint64_t getTime() {\n    struct timespec ts;\n    KJ_SYSCALL(clock_gettime(CLOCK_MONOTONIC, &ts));\n    return ts.tv_sec * 1000000000ll + ts.tv_nsec;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "startNode",
          "args": [
            "config",
            "fdBundle"
          ],
          "line": 2034
        },
        "resolved": true,
        "details": {
          "function_name": "startNode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2273-2362",
          "snippet": "pid_t startNode(const Config& config, FdBundle& fdBundle) {\n    Subprocess process([&]() -> int {\n      fdBundle.prepareInheritedFds();\n\n      dropPrivs(config.uids);\n      clearSignalMask();\n\n      kj::String authPrefix;\n      kj::StringPtr authSuffix;\n      if (access(\"/var/mongo/passwd\", F_OK) == 0) {\n        // Read the password.\n        auto password = trim(readAll(raiiOpen(\"/var/mongo/passwd\", O_RDONLY)));\n        authPrefix = kj::str(\"sandstorm:\", password, \"@\");\n        authSuffix = \"?authSource=admin\";\n\n        // Oplog is only configured if we have a password.\n        KJ_SYSCALL(setenv(\"MONGO_OPLOG_URL\",\n            kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                    \"/local\", authSuffix).cStr(),\n            true));\n      }\n\n      KJ_SYSCALL(setenv(\"PORT\", kj::strArray(config.ports, \",\").cStr(), true));\n      KJ_IF_MAYBE(httpsPort, config.httpsPort) {\n        KJ_SYSCALL(setenv(\"HTTPS_PORT\", kj::str(*httpsPort).cStr(), true));\n      }\n\n      KJ_SYSCALL(setenv(\"MONGO_URL\",\n          kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                  \"/meteor\", authSuffix).cStr(),\n          true));\n      KJ_SYSCALL(setenv(\"BIND_IP\", config.bindIp.cStr(), true));\n      if (config.mailUrl != nullptr) {\n        KJ_SYSCALL(setenv(\"MAIL_URL\", config.mailUrl.cStr(), true));\n      }\n      if (config.rootUrl == nullptr) {\n        kj::StringPtr scheme;\n        uint defaultPort;\n\n        if (config.httpsPort == nullptr) {\n          scheme = \"http://\";\n          defaultPort = 80;\n        } else {\n          scheme = \"https://\";\n          defaultPort = 443;\n        }\n        if (config.ports[0] == defaultPort) {\n          KJ_SYSCALL(setenv(\"ROOT_URL\", kj::str(scheme, config.bindIp).cStr(), true));\n        } else {\n          KJ_SYSCALL(setenv(\"ROOT_URL\",\n              kj::str(scheme, config.bindIp, \":\", config.ports[0]).cStr(), true));\n        }\n      } else {\n        KJ_SYSCALL(setenv(\"ROOT_URL\", config.rootUrl.cStr(), true));\n      }\n      if (config.wildcardHost != nullptr) {\n        KJ_SYSCALL(setenv(\"WILDCARD_HOST\", config.wildcardHost.cStr(), true));\n      }\n      if (config.ddpUrl != nullptr) {\n        KJ_SYSCALL(setenv(\"DDP_DEFAULT_CONNECTION_URL\", config.ddpUrl.cStr(), true));\n      }\n\n      kj::String buildstamp;\n      if (SANDSTORM_BUILD == 0) {\n        buildstamp = kj::str(\"\\\"[\", trim(readAll(\"buildstamp\")), \"]\\\"\");\n      } else {\n        buildstamp = kj::str(SANDSTORM_BUILD);\n      }\n\n      kj::String settingsString = kj::str(\n          \"{\\\"public\\\":{\\\"build\\\":\", buildstamp,\n          \", \\\"allowDemoAccounts\\\":\", config.allowDemoAccounts ? \"true\" : \"false\",\n          \", \\\"allowDevAccounts\\\":\", config.allowDevAccounts ? \"true\" : \"false\",\n          \", \\\"isTesting\\\":\", config.isTesting ? \"true\" : \"false\",\n          \", \\\"hideTroubleshooting\\\":\", config.hideTroubleshooting ? \"true\" : \"false\",\n          \", \\\"wildcardHost\\\":\\\"\", config.wildcardHost, \"\\\"\");\n      if (config.sandcatsHostname.size() > 0) {\n          settingsString = kj::str(settingsString,\n            \", \\\"sandcatsHostname\\\":\\\"\", config.sandcatsHostname, \"\\\"\");\n      }\n      settingsString = kj::str(settingsString, \"}}\");\n      KJ_SYSCALL(setenv(\"METEOR_SETTINGS\", settingsString.cStr(), true));\n      KJ_SYSCALL(execl(\"/bin/node\", \"/bin/node\", \"sandstorm-main.js\", EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    });\n\n    pid_t result = process.getPid();\n    process.detach();\n    return result;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t startNode(const Config& config, FdBundle& fdBundle) {\n    Subprocess process([&]() -> int {\n      fdBundle.prepareInheritedFds();\n\n      dropPrivs(config.uids);\n      clearSignalMask();\n\n      kj::String authPrefix;\n      kj::StringPtr authSuffix;\n      if (access(\"/var/mongo/passwd\", F_OK) == 0) {\n        // Read the password.\n        auto password = trim(readAll(raiiOpen(\"/var/mongo/passwd\", O_RDONLY)));\n        authPrefix = kj::str(\"sandstorm:\", password, \"@\");\n        authSuffix = \"?authSource=admin\";\n\n        // Oplog is only configured if we have a password.\n        KJ_SYSCALL(setenv(\"MONGO_OPLOG_URL\",\n            kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                    \"/local\", authSuffix).cStr(),\n            true));\n      }\n\n      KJ_SYSCALL(setenv(\"PORT\", kj::strArray(config.ports, \",\").cStr(), true));\n      KJ_IF_MAYBE(httpsPort, config.httpsPort) {\n        KJ_SYSCALL(setenv(\"HTTPS_PORT\", kj::str(*httpsPort).cStr(), true));\n      }\n\n      KJ_SYSCALL(setenv(\"MONGO_URL\",\n          kj::str(\"mongodb://\", authPrefix, \"127.0.0.1:\", config.mongoPort,\n                  \"/meteor\", authSuffix).cStr(),\n          true));\n      KJ_SYSCALL(setenv(\"BIND_IP\", config.bindIp.cStr(), true));\n      if (config.mailUrl != nullptr) {\n        KJ_SYSCALL(setenv(\"MAIL_URL\", config.mailUrl.cStr(), true));\n      }\n      if (config.rootUrl == nullptr) {\n        kj::StringPtr scheme;\n        uint defaultPort;\n\n        if (config.httpsPort == nullptr) {\n          scheme = \"http://\";\n          defaultPort = 80;\n        } else {\n          scheme = \"https://\";\n          defaultPort = 443;\n        }\n        if (config.ports[0] == defaultPort) {\n          KJ_SYSCALL(setenv(\"ROOT_URL\", kj::str(scheme, config.bindIp).cStr(), true));\n        } else {\n          KJ_SYSCALL(setenv(\"ROOT_URL\",\n              kj::str(scheme, config.bindIp, \":\", config.ports[0]).cStr(), true));\n        }\n      } else {\n        KJ_SYSCALL(setenv(\"ROOT_URL\", config.rootUrl.cStr(), true));\n      }\n      if (config.wildcardHost != nullptr) {\n        KJ_SYSCALL(setenv(\"WILDCARD_HOST\", config.wildcardHost.cStr(), true));\n      }\n      if (config.ddpUrl != nullptr) {\n        KJ_SYSCALL(setenv(\"DDP_DEFAULT_CONNECTION_URL\", config.ddpUrl.cStr(), true));\n      }\n\n      kj::String buildstamp;\n      if (SANDSTORM_BUILD == 0) {\n        buildstamp = kj::str(\"\\\"[\", trim(readAll(\"buildstamp\")), \"]\\\"\");\n      } else {\n        buildstamp = kj::str(SANDSTORM_BUILD);\n      }\n\n      kj::String settingsString = kj::str(\n          \"{\\\"public\\\":{\\\"build\\\":\", buildstamp,\n          \", \\\"allowDemoAccounts\\\":\", config.allowDemoAccounts ? \"true\" : \"false\",\n          \", \\\"allowDevAccounts\\\":\", config.allowDevAccounts ? \"true\" : \"false\",\n          \", \\\"isTesting\\\":\", config.isTesting ? \"true\" : \"false\",\n          \", \\\"hideTroubleshooting\\\":\", config.hideTroubleshooting ? \"true\" : \"false\",\n          \", \\\"wildcardHost\\\":\\\"\", config.wildcardHost, \"\\\"\");\n      if (config.sandcatsHostname.size() > 0) {\n          settingsString = kj::str(settingsString,\n            \", \\\"sandcatsHostname\\\":\\\"\", config.sandcatsHostname, \"\\\"\");\n      }\n      settingsString = kj::str(settingsString, \"}}\");\n      KJ_SYSCALL(setenv(\"METEOR_SETTINGS\", settingsString.cStr(), true));\n      KJ_SYSCALL(execl(\"/bin/node\", \"/bin/node\", \"sandstorm-main.js\", EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    });\n\n    pid_t result = process.getPid();\n    process.detach();\n    return result;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "FdBundle",
          "args": [
            "config"
          ],
          "line": 2033
        },
        "resolved": true,
        "details": {
          "function_name": "ensureMinFd",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1779-1788",
          "snippet": "kj::AutoCloseFd ensureMinFd(kj::AutoCloseFd fd) {\n      if (fd.get() < minFd) {\n        // Push the FD number beyond our minimum.\n        int fd_;\n        KJ_SYSCALL(fd_ = fcntl(fd, F_DUPFD_CLOEXEC, minFd));\n        fd = kj::AutoCloseFd(fd_);\n        KJ_ASSERT(fd.get() >= minFd);\n      }\n      return kj::mv(fd);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  kj::AutoCloseFd ensureMinFd(kj::AutoCloseFd fd) {\n        if (fd.get() < minFd) {\n          // Push the FD number beyond our minimum.\n          int fd_;\n          KJ_SYSCALL(fd_ = fcntl(fd, F_DUPFD_CLOEXEC, minFd));\n          fd = kj::AutoCloseFd(fd_);\n          KJ_ASSERT(fd.get() >= minFd);\n        }\n        return kj::mv(fd);\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Starting front-end by admin request\""
          ],
          "line": 2032
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Restarting front-end due to back-end failure\""
          ],
          "line": 2023
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "maybeWaitAfterChildDeath",
          "args": [
            "\"Front-end\"",
            "nodeStartTime"
          ],
          "line": 2016
        },
        "resolved": true,
        "details": {
          "function_name": "maybeWaitAfterChildDeath",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2364-2375",
          "snippet": "void maybeWaitAfterChildDeath(kj::StringPtr title, int64_t startTime) {\n    if (getTime() - startTime < 10ll * 1000 * 1000 * 1000) {\n      context.warning(kj::str(\n          \"** \", title, \" died immediately after starting.\\n\"\n          \"** Sleeping for a bit before trying again...\"));\n\n      // Sleep for 10 seconds to avoid burning resources on a restart loop.\n      usleep(10 * 1000 * 1000);\n    } else {\n      context.warning(kj::str(\"** \", title, \" died! Restarting it...\"));\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid maybeWaitAfterChildDeath(kj::StringPtr title, int64_t startTime) {\n    if (getTime() - startTime < 10ll * 1000 * 1000 * 1000) {\n      context.warning(kj::str(\n          \"** \", title, \" died immediately after starting.\\n\"\n          \"** Sleeping for a bit before trying again...\"));\n\n      // Sleep for 10 seconds to avoid burning resources on a restart loop.\n      usleep(10 * 1000 * 1000);\n    } else {\n      context.warning(kj::str(\"** \", title, \" died! Restarting it...\"));\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "startMongo",
          "args": [
            "config",
            "fdBundle"
          ],
          "line": 2012
        },
        "resolved": true,
        "details": {
          "function_name": "startMongo",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2060-2141",
          "snippet": "pid_t startMongo(const Config& config, FdBundle& fdBundle) {\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n      dropPrivs(config.uids);\n      clearSignalMask();\n\n      // Before starting Mongo, we remove \"mongod.lock\" basically unconditionally.\n      //\n      // Here's how MongoDB wants to use this lockfile: If MongoDB stopped abruptly in the past, and\n      // there is no journal, then MongoDB wants to prompt the admin to start it with\n      // --recover. Presumably it refuses to repair automatically in the absence of a journal\n      // because it can't always be sure of how to do recovery.\n      //\n      // If replica sets are enabled, MongoDB would prefer to ask the admin to restore it from a\n      // replica. Indeed, we do have replica sets enabled. But we can't restore from a replica\n      // because there is just \"one replica\" -- replica sets are enabled merely to enable Meteor to\n      // do oplog tailing.\n      //\n      // In our case, we do have journaling enabled, and we have no replica we can restore from, so\n      // in the case of crash, the best we can do is ask MongoDB to start itself up and restore from\n      // journal. That's what removing the lock file means.\n      //\n      // See http://docs.mongodb.org/manual/reference/command/repairDatabase/ and\n      // http://docs.mongodb.org/manual/tutorial/recover-data-following-unexpected-shutdown/ for\n      // more information.\n      kj::String lockFilePath = kj::str(\"/var/mongo/mongod.lock\");\n      if (access(lockFilePath.cStr(), F_OK) == 0) {\n        kj::String contents = trim(readAll(raiiOpen(lockFilePath.cStr(), O_RDONLY)));\n        if (contents != \"\") {\n          // This file should contain a PID, hence UInt.\n          //\n          // If somehow there are two instances of Sandstorm running, and the other one is running a\n          // mongod, then this action could dangerously cause two mongod instances to be\n          // running. However, in that case, we also can't see the other process, since it's in a\n          // pid namespace. So this is all the sanity-checking we can do.\n          KJ_ASSERT_NONNULL(parseUInt(contents, 10),\n                            \"mongod.lock exists & contains non-integer, refusing to unlink\");\n          context.warning(\"Found a stale mongod lock file. Removing it.\");\n          unlink(lockFilePath.cStr());\n        }\n      }\n\n      KJ_SYSCALL(execl(\"/bin/mongod\", \"/bin/mongod\", \"--fork\",\n          \"--bind_ip\", \"127.0.0.1\", \"--port\", kj::str(config.mongoPort).cStr(),\n          \"--dbpath\", \"/var/mongo\", \"--logpath\", \"/var/log/mongo.log\",\n          \"--pidfilepath\", \"/var/pid/mongo.pid\",\n          \"--auth\", \"--nohttpinterface\", \"--noprealloc\", \"--nopreallocj\", \"--smallfiles\",\n          \"--replSet\", \"ssrs\", \"--oplogSize\", \"16\",\n          EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    });\n\n    // Wait for mongod to return, meaning the database is up.  Then get its real pid via the\n    // pidfile.\n    auto status = process.waitForExit();\n\n    if (status == 0) {\n      // Even after the startup command exits, MongoDB takes exactly two seconds to elect itself as\n      // master of the repl set (of which it is the only damned member). Unforutnately, if Node\n      // connects during this time, it fails, sometimes without actually exiting, leaving the entire\n      // server hosed. It appears that this always takes exactly two seconds from startup, since\n      // MongoDB does some sort of heartbeat every second where it checks the replset status, and it\n      // takes three of these for the election to complete, and the first of the three happens\n      // immediately on startup, meaning the last one is two seconds in. So, we'll sleep for 3\n      // seconds to be safe.\n      // TODO(cleanup): There must be a better way...\n      int n = 3;\n      while (n > 0) n = sleep(n);\n      KJ_IF_MAYBE(mongoPid, parseUInt(trim(readAll(\"/var/pid/mongo.pid\")), 10)) {\n        return *mongoPid;\n      }\n    }\n\n    // If we got here, mongod either exited non-zero, or has no PID in its pidfile. In that case,\n    // we do not know how proceed.\n    KJ_FAIL_ASSERT(\"**mongod failed to start. Initial exit code: \", status,\n                   \"bailing out now. For troubleshooting, read \"\n                   \"/opt/sandstorm/var/log/mongo.log (or var/log/mongo.log within your Sandstorm \"\n                   \"if installed to a different place) and visit: \"\n                   \"https://docs.sandstorm.io/en/latest/search.html?q=mongod+failed+to+start\");\n    return 0;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\npid_t startMongo(const Config& config, FdBundle& fdBundle) {\n    Subprocess process([&]() -> int {\n      fdBundle.closeAll();\n      dropPrivs(config.uids);\n      clearSignalMask();\n\n      // Before starting Mongo, we remove \"mongod.lock\" basically unconditionally.\n      //\n      // Here's how MongoDB wants to use this lockfile: If MongoDB stopped abruptly in the past, and\n      // there is no journal, then MongoDB wants to prompt the admin to start it with\n      // --recover. Presumably it refuses to repair automatically in the absence of a journal\n      // because it can't always be sure of how to do recovery.\n      //\n      // If replica sets are enabled, MongoDB would prefer to ask the admin to restore it from a\n      // replica. Indeed, we do have replica sets enabled. But we can't restore from a replica\n      // because there is just \"one replica\" -- replica sets are enabled merely to enable Meteor to\n      // do oplog tailing.\n      //\n      // In our case, we do have journaling enabled, and we have no replica we can restore from, so\n      // in the case of crash, the best we can do is ask MongoDB to start itself up and restore from\n      // journal. That's what removing the lock file means.\n      //\n      // See http://docs.mongodb.org/manual/reference/command/repairDatabase/ and\n      // http://docs.mongodb.org/manual/tutorial/recover-data-following-unexpected-shutdown/ for\n      // more information.\n      kj::String lockFilePath = kj::str(\"/var/mongo/mongod.lock\");\n      if (access(lockFilePath.cStr(), F_OK) == 0) {\n        kj::String contents = trim(readAll(raiiOpen(lockFilePath.cStr(), O_RDONLY)));\n        if (contents != \"\") {\n          // This file should contain a PID, hence UInt.\n          //\n          // If somehow there are two instances of Sandstorm running, and the other one is running a\n          // mongod, then this action could dangerously cause two mongod instances to be\n          // running. However, in that case, we also can't see the other process, since it's in a\n          // pid namespace. So this is all the sanity-checking we can do.\n          KJ_ASSERT_NONNULL(parseUInt(contents, 10),\n                            \"mongod.lock exists & contains non-integer, refusing to unlink\");\n          context.warning(\"Found a stale mongod lock file. Removing it.\");\n          unlink(lockFilePath.cStr());\n        }\n      }\n\n      KJ_SYSCALL(execl(\"/bin/mongod\", \"/bin/mongod\", \"--fork\",\n          \"--bind_ip\", \"127.0.0.1\", \"--port\", kj::str(config.mongoPort).cStr(),\n          \"--dbpath\", \"/var/mongo\", \"--logpath\", \"/var/log/mongo.log\",\n          \"--pidfilepath\", \"/var/pid/mongo.pid\",\n          \"--auth\", \"--nohttpinterface\", \"--noprealloc\", \"--nopreallocj\", \"--smallfiles\",\n          \"--replSet\", \"ssrs\", \"--oplogSize\", \"16\",\n          EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    });\n\n    // Wait for mongod to return, meaning the database is up.  Then get its real pid via the\n    // pidfile.\n    auto status = process.waitForExit();\n\n    if (status == 0) {\n      // Even after the startup command exits, MongoDB takes exactly two seconds to elect itself as\n      // master of the repl set (of which it is the only damned member). Unforutnately, if Node\n      // connects during this time, it fails, sometimes without actually exiting, leaving the entire\n      // server hosed. It appears that this always takes exactly two seconds from startup, since\n      // MongoDB does some sort of heartbeat every second where it checks the replset status, and it\n      // takes three of these for the election to complete, and the first of the three happens\n      // immediately on startup, meaning the last one is two seconds in. So, we'll sleep for 3\n      // seconds to be safe.\n      // TODO(cleanup): There must be a better way...\n      int n = 3;\n      while (n > 0) n = sleep(n);\n      KJ_IF_MAYBE(mongoPid, parseUInt(trim(readAll(\"/var/pid/mongo.pid\")), 10)) {\n        return *mongoPid;\n      }\n    }\n\n    // If we got here, mongod either exited non-zero, or has no PID in its pidfile. In that case,\n    // we do not know how proceed.\n    KJ_FAIL_ASSERT(\"**mongod failed to start. Initial exit code: \", status,\n                   \"bailing out now. For troubleshooting, read \"\n                   \"/opt/sandstorm/var/log/mongo.log (or var/log/mongo.log within your Sandstorm \"\n                   \"if installed to a different place) and visit: \"\n                   \"https://docs.sandstorm.io/en/latest/search.html?q=mongod+failed+to+start\");\n    return 0;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "startBackend",
          "args": [
            "config",
            "fdBundle"
          ],
          "line": 2007
        },
        "resolved": true,
        "details": {
          "function_name": "startBackend",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2201-2271",
          "snippet": "pid_t startBackend(const Config& config, FdBundle& fdBundle) {\n    int pipeFds[2];\n    KJ_SYSCALL(pipe2(pipeFds, O_CLOEXEC));\n    kj::AutoCloseFd inPipe(pipeFds[0]);\n    kj::AutoCloseFd outPipe(pipeFds[1]);\n\n    Subprocess process([&]() -> int {\n      inPipe = nullptr;\n      fdBundle.closeAll();\n\n      // Mainly to cause Cap'n Proto to log exceptions being returned over RPC so we can see the\n      // stack traces.\n      kj::_::Debug::setLogLevel(kj::LogSeverity::INFO);\n\n      kj::StringPtr socketPath = Backend::SOCKET_PATH;\n      sandstorm::recursivelyCreateParent(socketPath);\n      unlink(socketPath.cStr());\n\n      auto io = kj::setupAsyncIo();\n      auto& network = io.provider->getNetwork();\n      auto listener = network.parseAddress(kj::str(\"unix:\", socketPath))\n          .wait(io.waitScope)->listen();\n\n      if (runningAsRoot) {\n        // Make socket available to server user.\n        KJ_SYSCALL(chmod(socketPath.cStr(), 0770));\n        KJ_SYSCALL(chown(socketPath.cStr(), 0, config.uids.gid));\n\n        // Also make the socket parent directory available to user.\n        KJ_IF_MAYBE(pos, socketPath.findLast('/')) {\n          kj::String parent = kj::heapString(socketPath.slice(0, *pos));\n          KJ_SYSCALL(chmod(parent.cStr(), 0770));\n          KJ_SYSCALL(chown(parent.cStr(), 0, config.uids.gid));\n        }\n      }\n\n      // If we're not running as root, we have to use user namespaces. Otherwise, dynamically\n      // check if they're available. If not, we'll need to pass superuser privileges on to the\n      // backend.\n      bool avoidUserns = runningAsRoot && !isUserNsAvailable();\n      kj::Maybe<uid_t> sandboxUid;\n      if (avoidUserns) sandboxUid = config.uids.uid;\n\n      dropPrivs(config.uids, avoidUserns);\n      clearSignalMask();\n\n      auto paf = kj::newPromiseAndFulfiller<Backend::Client>();\n      TwoPartyServerWithClientBootstrap server(kj::mv(paf.promise));\n      paf.fulfiller->fulfill(kj::heap<BackendImpl>(*io.lowLevelProvider, network,\n        server.getBootstrap().castAs<SandstormCoreFactory>(), sandboxUid));\n\n      // Signal readiness.\n      write(outPipe, \"ready\", 5);\n      outPipe = nullptr;\n\n      server.listen(kj::mv(listener))\n            // Rotate logs, keeping 1-2MB worth. We do this in the backend process mainly because\n            // it is the only asynchronous process in run-bundle.c++.\n            .exclusiveJoin(rotateLog(io.provider->getTimer(),\n                                     STDERR_FILENO, \"/var/log/sandstorm.log\", 1u << 20))\n            .wait(io.waitScope);\n      KJ_UNREACHABLE;\n    });\n\n    outPipe = nullptr;\n    KJ_ASSERT(sandstorm::readAll(inPipe) == \"ready\", \"starting back-end failed\");\n\n    pid_t result = process.getPid();\n    process.detach();\n    return result;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\npid_t startBackend(const Config& config, FdBundle& fdBundle) {\n    int pipeFds[2];\n    KJ_SYSCALL(pipe2(pipeFds, O_CLOEXEC));\n    kj::AutoCloseFd inPipe(pipeFds[0]);\n    kj::AutoCloseFd outPipe(pipeFds[1]);\n\n    Subprocess process([&]() -> int {\n      inPipe = nullptr;\n      fdBundle.closeAll();\n\n      // Mainly to cause Cap'n Proto to log exceptions being returned over RPC so we can see the\n      // stack traces.\n      kj::_::Debug::setLogLevel(kj::LogSeverity::INFO);\n\n      kj::StringPtr socketPath = Backend::SOCKET_PATH;\n      sandstorm::recursivelyCreateParent(socketPath);\n      unlink(socketPath.cStr());\n\n      auto io = kj::setupAsyncIo();\n      auto& network = io.provider->getNetwork();\n      auto listener = network.parseAddress(kj::str(\"unix:\", socketPath))\n          .wait(io.waitScope)->listen();\n\n      if (runningAsRoot) {\n        // Make socket available to server user.\n        KJ_SYSCALL(chmod(socketPath.cStr(), 0770));\n        KJ_SYSCALL(chown(socketPath.cStr(), 0, config.uids.gid));\n\n        // Also make the socket parent directory available to user.\n        KJ_IF_MAYBE(pos, socketPath.findLast('/')) {\n          kj::String parent = kj::heapString(socketPath.slice(0, *pos));\n          KJ_SYSCALL(chmod(parent.cStr(), 0770));\n          KJ_SYSCALL(chown(parent.cStr(), 0, config.uids.gid));\n        }\n      }\n\n      // If we're not running as root, we have to use user namespaces. Otherwise, dynamically\n      // check if they're available. If not, we'll need to pass superuser privileges on to the\n      // backend.\n      bool avoidUserns = runningAsRoot && !isUserNsAvailable();\n      kj::Maybe<uid_t> sandboxUid;\n      if (avoidUserns) sandboxUid = config.uids.uid;\n\n      dropPrivs(config.uids, avoidUserns);\n      clearSignalMask();\n\n      auto paf = kj::newPromiseAndFulfiller<Backend::Client>();\n      TwoPartyServerWithClientBootstrap server(kj::mv(paf.promise));\n      paf.fulfiller->fulfill(kj::heap<BackendImpl>(*io.lowLevelProvider, network,\n        server.getBootstrap().castAs<SandstormCoreFactory>(), sandboxUid));\n\n      // Signal readiness.\n      write(outPipe, \"ready\", 5);\n      outPipe = nullptr;\n\n      server.listen(kj::mv(listener))\n            // Rotate logs, keeping 1-2MB worth. We do this in the backend process mainly because\n            // it is the only asynchronous process in run-bundle.c++.\n            .exclusiveJoin(rotateLog(io.provider->getTimer(),\n                                     STDERR_FILENO, \"/var/log/sandstorm.log\", 1u << 20))\n            .wait(io.waitScope);\n      KJ_UNREACHABLE;\n    });\n\n    outPipe = nullptr;\n    KJ_ASSERT(sandstorm::readAll(inPipe) == \"ready\", \"starting back-end failed\");\n\n    pid_t result = process.getPid();\n    process.detach();\n    return result;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "waitpid",
          "args": [
            "-1",
            "&status",
            "WNOHANG"
          ],
          "line": 1987
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "read(sigfd, &siginfo, sizeof(siginfo))"
          ],
          "line": 1974
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "read",
          "args": [
            "sigfd",
            "&siginfo",
            "sizeof(siginfo)"
          ],
          "line": 1974
        },
        "resolved": true,
        "details": {
          "function_name": "read",
          "container": "RefcountedAsyncIoStream",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/sandstorm-http-bridge.c++",
          "lines": "908-910",
          "snippet": "kj::Promise<size_t> read(void* buffer, size_t minBytes, size_t maxBytes) override {\n    return stream->read(buffer, minBytes, maxBytes);\n  }",
          "includes": [
            "#include \"bridge-proxy.h\"",
            "#include \"util.h\"",
            "#include \"version.h\"",
            "#include <joyent-http/http_parser.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/sandstorm-http-bridge-internal.capnp.h>",
            "#include <sandstorm/sandstorm-http-bridge.capnp.h>",
            "#include <sandstorm/email.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <sandstorm/util.capnp.h>",
            "#include <stdio.h>",
            "#include <fcntl.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <time.h>",
            "#include <unordered_map>",
            "#include <map>",
            "#include <unistd.h>",
            "#include <arpa/inet.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/schema.h>",
            "#include <capnp/rpc.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/io.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/async-io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"bridge-proxy.h\"\n#include \"util.h\"\n#include \"version.h\"\n#include <joyent-http/http_parser.h>\n#include <sandstorm/package.capnp.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/sandstorm-http-bridge-internal.capnp.h>\n#include <sandstorm/sandstorm-http-bridge.capnp.h>\n#include <sandstorm/email.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <sandstorm/util.capnp.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <sys/wait.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <time.h>\n#include <unordered_map>\n#include <map>\n#include <unistd.h>\n#include <arpa/inet.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/schema.h>\n#include <capnp/rpc.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/io.h>\n#include <kj/async-unix.h>\n#include <kj/async-io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nRefcountedAsyncIoStream {\n  kj::Promise<size_t> read(void* buffer, size_t minBytes, size_t maxBytes) override {\n      return stream->read(buffer, minBytes, maxBytes);\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Note: Not accepting \\\"spk dev\\\" connections because not running as root.\""
          ],
          "line": 1965
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "runDevDaemon",
          "args": [
            "config"
          ],
          "line": 1960
        },
        "resolved": true,
        "details": {
          "function_name": "runDevDaemon",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2705-2753",
          "snippet": "[[noreturn]] void runDevDaemon(const Config& config) {\n    clearDevPackages(config);\n\n    // Make sure socket directory exists (since the installer doesn't create it).\n    if (mkdir(\"/var/sandstorm/socket\", 0770) == 0) {\n      // Allow group to use this directory.\n      if (runningAsRoot) { KJ_SYSCALL(chown(\"/var/sandstorm/socket\", 0, config.uids.gid)); }\n    } else {\n      int error = errno;\n      if (error != EEXIST) {\n        KJ_FAIL_SYSCALL(\"mkdir(/var/sandstorm/socket)\", error);\n      }\n    }\n\n    // Create the devmode socket.\n    int sock_;\n    KJ_SYSCALL(sock_ = socket(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0));\n    auto sock = kj::AutoCloseFd(sock_);\n\n    struct sockaddr_un addr;\n    memset(&addr, 0, sizeof(addr));\n    addr.sun_family = AF_UNIX;\n    strcpy(addr.sun_path, \"/var/sandstorm/socket/devmode\");\n    unlink(addr.sun_path);\n    KJ_SYSCALL(bind(sock, reinterpret_cast<struct sockaddr*>(&addr), sizeof(addr)));\n    KJ_SYSCALL(listen(sock, 2));\n\n    // Ensure that the group can connect to the socket.\n    if (runningAsRoot) { KJ_SYSCALL(chown(\"/var/sandstorm/socket/devmode\", 0, config.uids.gid)); }\n    KJ_SYSCALL(chmod(\"/var/sandstorm/socket/devmode\", 0770));\n\n    // We don't care to reap dev sessions.\n    KJ_SYSCALL(signal(SIGCHLD, SIG_IGN));\n\n    // Please don't SIGPIPE if we write to a disconnected socket. An exception is nicer.\n    KJ_SYSCALL(signal(SIGPIPE, SIG_IGN));\n\n    for (;;) {\n      int connFd_;\n      KJ_SYSCALL(connFd_ = accept4(sock, nullptr, nullptr, SOCK_CLOEXEC));\n      kj::AutoCloseFd connFd(connFd_);\n\n      if (fork() == 0) {\n        sock = nullptr;\n        runDevSession(config, kj::mv(connFd));\n        KJ_UNREACHABLE;\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\n[[noreturn]] void runDevDaemon(const Config& config) {\n    clearDevPackages(config);\n\n    // Make sure socket directory exists (since the installer doesn't create it).\n    if (mkdir(\"/var/sandstorm/socket\", 0770) == 0) {\n      // Allow group to use this directory.\n      if (runningAsRoot) { KJ_SYSCALL(chown(\"/var/sandstorm/socket\", 0, config.uids.gid)); }\n    } else {\n      int error = errno;\n      if (error != EEXIST) {\n        KJ_FAIL_SYSCALL(\"mkdir(/var/sandstorm/socket)\", error);\n      }\n    }\n\n    // Create the devmode socket.\n    int sock_;\n    KJ_SYSCALL(sock_ = socket(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0));\n    auto sock = kj::AutoCloseFd(sock_);\n\n    struct sockaddr_un addr;\n    memset(&addr, 0, sizeof(addr));\n    addr.sun_family = AF_UNIX;\n    strcpy(addr.sun_path, \"/var/sandstorm/socket/devmode\");\n    unlink(addr.sun_path);\n    KJ_SYSCALL(bind(sock, reinterpret_cast<struct sockaddr*>(&addr), sizeof(addr)));\n    KJ_SYSCALL(listen(sock, 2));\n\n    // Ensure that the group can connect to the socket.\n    if (runningAsRoot) { KJ_SYSCALL(chown(\"/var/sandstorm/socket/devmode\", 0, config.uids.gid)); }\n    KJ_SYSCALL(chmod(\"/var/sandstorm/socket/devmode\", 0770));\n\n    // We don't care to reap dev sessions.\n    KJ_SYSCALL(signal(SIGCHLD, SIG_IGN));\n\n    // Please don't SIGPIPE if we write to a disconnected socket. An exception is nicer.\n    KJ_SYSCALL(signal(SIGPIPE, SIG_IGN));\n\n    for (;;) {\n      int connFd_;\n      KJ_SYSCALL(connFd_ = accept4(sock, nullptr, nullptr, SOCK_CLOEXEC));\n      kj::AutoCloseFd connFd(connFd_);\n\n      if (fork() == 0) {\n        sock = nullptr;\n        runDevSession(config, kj::mv(connFd));\n        KJ_UNREACHABLE;\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "signal(SIGALRM, SIG_DFL)"
          ],
          "line": 1958
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signal",
          "args": [
            "SIGALRM",
            "SIG_DFL"
          ],
          "line": 1958
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "clearSignalMask",
          "args": [],
          "line": 1957
        },
        "resolved": true,
        "details": {
          "function_name": "clearSignalMask",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1499-1503",
          "snippet": "void clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "devDaemonPid = fork()"
          ],
          "line": 1952
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fork",
          "args": [],
          "line": 1952
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Back-end and Mongo started; now starting front-end...\""
          ],
          "line": 1946
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "maybeCreateMongoUser",
          "args": [
            "config",
            "fdBundle"
          ],
          "line": 1944
        },
        "resolved": true,
        "details": {
          "function_name": "maybeCreateMongoUser",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2143-2199",
          "snippet": "void maybeCreateMongoUser(const Config& config, FdBundle& fdBundle) {\n    if (access(\"/var/mongo/passwd\", F_OK) != 0) {\n      // We need to initialize the repl set to get oplog tailing. Our set isn't actually much of a\n      // set since it only contains one instance, but you need that for oplog.\n      mongoCommand(config, fdBundle, kj::str(\n          \"rs.initiate({_id: 'ssrs', members: [{_id: 0, host: 'localhost:\",\n          config.mongoPort, \"'}]})\"));\n\n      // We have to wait a few seconds for Mongo to elect itself master of the repl set. Mongo does\n      // some sort of heartbeat every second and it takes three of these for Mongo to elect itself,\n      // meaning the whole process always takes 2-3 seconds. We'll sleep for 4.\n      // TODO(cleanup): This is ugly.\n      {\n        int n = 4;\n        while (n > 0) n = sleep(n);\n      }\n\n      // Get 20 random bytes for password.\n      kj::byte bytes[20];\n      kj::FdInputStream random(raiiOpen(\"/dev/urandom\", O_RDONLY));\n      random.read(bytes, sizeof(bytes));\n\n      // Base64 encode them.\n      // TODO(cleanup): Move to libkj.\n      const char* digits =\n          \"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_\";\n      uint buffer = 0;\n      uint bufferBits = 0;\n      kj::Vector<char> chars;\n      for (kj::byte b: bytes) {\n        buffer |= kj::implicitCast<uint>(b) << bufferBits;\n        bufferBits += 8;\n\n        while (bufferBits >= 6) {\n          chars.add(digits[buffer & 0x3f]);\n          buffer >>= 6;\n          bufferBits -= 6;\n        }\n      }\n      if (bufferBits > 0) {\n        chars.add(digits[buffer & 0x3f]);\n      }\n      chars.add('\\0');\n      kj::String password(chars.releaseAsArray());\n\n      // Create the mongo user.\n      auto command = kj::str(\n        \"db.createUser({user: \\\"sandstorm\\\", pwd: \\\"\", password, \"\\\", \"\n        \"roles: [\\\"readWriteAnyDatabase\\\",\\\"userAdminAnyDatabase\\\",\\\"dbAdminAnyDatabase\\\"]})\");\n      mongoCommand(config, fdBundle, command, \"admin\");\n\n      // Store the password.\n      auto outFd = raiiOpen(\"/var/mongo/passwd\", O_WRONLY | O_CREAT | O_EXCL, 0640);\n      if (runningAsRoot) { KJ_SYSCALL(fchown(outFd, config.uids.uid, config.uids.gid)); }\n      kj::FdOutputStream((int)outFd).write(password.begin(), password.size());\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\nvoid maybeCreateMongoUser(const Config& config, FdBundle& fdBundle) {\n    if (access(\"/var/mongo/passwd\", F_OK) != 0) {\n      // We need to initialize the repl set to get oplog tailing. Our set isn't actually much of a\n      // set since it only contains one instance, but you need that for oplog.\n      mongoCommand(config, fdBundle, kj::str(\n          \"rs.initiate({_id: 'ssrs', members: [{_id: 0, host: 'localhost:\",\n          config.mongoPort, \"'}]})\"));\n\n      // We have to wait a few seconds for Mongo to elect itself master of the repl set. Mongo does\n      // some sort of heartbeat every second and it takes three of these for Mongo to elect itself,\n      // meaning the whole process always takes 2-3 seconds. We'll sleep for 4.\n      // TODO(cleanup): This is ugly.\n      {\n        int n = 4;\n        while (n > 0) n = sleep(n);\n      }\n\n      // Get 20 random bytes for password.\n      kj::byte bytes[20];\n      kj::FdInputStream random(raiiOpen(\"/dev/urandom\", O_RDONLY));\n      random.read(bytes, sizeof(bytes));\n\n      // Base64 encode them.\n      // TODO(cleanup): Move to libkj.\n      const char* digits =\n          \"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_\";\n      uint buffer = 0;\n      uint bufferBits = 0;\n      kj::Vector<char> chars;\n      for (kj::byte b: bytes) {\n        buffer |= kj::implicitCast<uint>(b) << bufferBits;\n        bufferBits += 8;\n\n        while (bufferBits >= 6) {\n          chars.add(digits[buffer & 0x3f]);\n          buffer >>= 6;\n          bufferBits -= 6;\n        }\n      }\n      if (bufferBits > 0) {\n        chars.add(digits[buffer & 0x3f]);\n      }\n      chars.add('\\0');\n      kj::String password(chars.releaseAsArray());\n\n      // Create the mongo user.\n      auto command = kj::str(\n        \"db.createUser({user: \\\"sandstorm\\\", pwd: \\\"\", password, \"\\\", \"\n        \"roles: [\\\"readWriteAnyDatabase\\\",\\\"userAdminAnyDatabase\\\",\\\"dbAdminAnyDatabase\\\"]})\");\n      mongoCommand(config, fdBundle, command, \"admin\");\n\n      // Store the password.\n      auto outFd = raiiOpen(\"/var/mongo/passwd\", O_WRONLY | O_CREAT | O_EXCL, 0640);\n      if (runningAsRoot) { KJ_SYSCALL(fchown(outFd, config.uids.uid, config.uids.gid)); }\n      kj::FdOutputStream((int)outFd).write(password.begin(), password.size());\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Starting MongoDB...\""
          ],
          "line": 1939
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Starting back-end...\""
          ],
          "line": 1935
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "prepareMonitoringLoop",
          "args": [],
          "line": 1933
        },
        "resolved": true,
        "details": {
          "function_name": "prepareMonitoringLoop",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "82-99",
          "snippet": "kj::AutoCloseFd prepareMonitoringLoop() {\n  // Prepare to run a loop where we monitor some children and also receive signals.  Returns a\n  // signalfd.\n\n  // Set up signal mask to catch events that should lead to shutdown.\n  sigset_t sigmask;\n  KJ_SYSCALL(sigemptyset(&sigmask));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGTERM));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGINT));   // request front-end shutdown\n  KJ_SYSCALL(sigaddset(&sigmask, SIGCHLD));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGHUP));\n  KJ_SYSCALL(sigprocmask(SIG_BLOCK, &sigmask, nullptr));\n\n  // Receive signals on a signalfd.\n  int sigfd;\n  KJ_SYSCALL(sigfd = signalfd(-1, &sigmask, SFD_CLOEXEC));\n  return kj::AutoCloseFd(sigfd);\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::AutoCloseFd prepareMonitoringLoop() {\n  // Prepare to run a loop where we monitor some children and also receive signals.  Returns a\n  // signalfd.\n\n  // Set up signal mask to catch events that should lead to shutdown.\n  sigset_t sigmask;\n  KJ_SYSCALL(sigemptyset(&sigmask));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGTERM));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGINT));   // request front-end shutdown\n  KJ_SYSCALL(sigaddset(&sigmask, SIGCHLD));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGHUP));\n  KJ_SYSCALL(sigprocmask(SIG_BLOCK, &sigmask, nullptr));\n\n  // Receive signals on a signalfd.\n  int sigfd;\n  KJ_SYSCALL(sigfd = signalfd(-1, &sigmask, SFD_CLOEXEC));\n  return kj::AutoCloseFd(sigfd);\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "prctl(PR_SET_CHILD_SUBREAPER, 1, 0, 0, 0)"
          ],
          "line": 1931
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "prctl",
          "args": [
            "PR_SET_CHILD_SUBREAPER",
            "1",
            "0",
            "0",
            "0"
          ],
          "line": 1931
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "registerAlarmHandler",
          "args": [],
          "line": 1928
        },
        "resolved": true,
        "details": {
          "function_name": "registerAlarmHandler",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "75-80",
          "snippet": "void registerAlarmHandler() {\n  struct sigaction action;\n  memset(&action, 0, sizeof(action));\n  action.sa_handler = &alarmHandler;\n  KJ_SYSCALL(sigaction(SIGALRM, &action, nullptr));\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid registerAlarmHandler() {\n  struct sigaction action;\n  memset(&action, 0, sizeof(action));\n  action.sa_handler = &alarmHandler;\n  KJ_SYSCALL(sigaction(SIGALRM, &action, nullptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "enterChroot",
          "args": [
            "true"
          ],
          "line": 1925
        },
        "resolved": true,
        "details": {
          "function_name": "enterChroot",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1328-1449",
          "snippet": "void enterChroot(bool inPidNamespace) {\n    KJ_REQUIRE(changedDir);\n\n    // Verify ownership is intact.\n    checkOwnedByRoot(\"..\", \"Install directory\");\n    checkOwnedByRoot(\".\", \"Version install directory\");\n    checkOwnedByRoot(\"sandstorm\", \"'sandstorm' executable\");\n    checkOwnedByRoot(\"../sandstorm.conf\", \"Config file\");\n\n    kj::StringPtr tmpfsUidOpts = \"\";\n    if (runningAsRoot) {\n      tmpfsUidOpts = \",uid=0,gid=0\";\n    } else {\n      unshareUidNamespaceOnce();\n    }\n\n    // Unshare the mount namespace, so we can create some private bind mounts.\n    KJ_SYSCALL(unshare(CLONE_NEWNS));\n\n    // To really unshare the mount namespace, we also have to make sure all mounts are private.\n    // The parameters here were derived by strace'ing `mount --make-rprivate /`.  AFAICT the flags\n    // are undocumented.  :(\n    KJ_SYSCALL(mount(\"none\", \"/\", nullptr, MS_REC | MS_PRIVATE, nullptr));\n\n    // Make sure that the current directory is a mount point so that we can use pivot_root.\n    KJ_SYSCALL(mount(\".\", \".\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Now change directory into the new mount point.\n    char cwdBuf[PATH_MAX + 1];\n    if (getcwd(cwdBuf, sizeof(cwdBuf)) == nullptr) {\n      KJ_FAIL_SYSCALL(\"getcwd\", errno);\n    }\n    KJ_SYSCALL(chdir(cwdBuf));\n\n    if (inPidNamespace) {\n      // Mount /proc for our PID namespace in the chroot.\n      KJ_SYSCALL(mount(\"proc\", \"proc\", \"proc\", MS_NOSUID | MS_NODEV | MS_NOEXEC, \"\"));\n    } else {\n      // Bind /proc for the global pid namespace in the chroot.\n      KJ_SYSCALL(mount(\"/proc\", \"proc\", nullptr, MS_BIND | MS_REC, nullptr));\n    }\n\n    // Bind var -> ../var, so that all versions share the same var.\n    // Same for tmp, though we clear it on every startup.\n    KJ_SYSCALL(mount(\"../var\", \"var\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"../tmp\", \"tmp\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Bind devices from /dev into our chroot environment.\n    // We can't bind /dev itself because this is apparently not allowed when in a UID namespace\n    // (returns EINVAL; haven't figured out why yet).\n    KJ_SYSCALL(mount(\"/dev/null\", \"dev/null\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/zero\", \"dev/zero\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/random\", \"dev/random\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/urandom\", \"dev/urandom\", nullptr, MS_BIND, nullptr));\n\n    if (runningAsRoot && access(\"/dev/fuse\", F_OK) == 0) {\n      // Bring in FUSE just in case we need it for \"spk dev\".\n      // TODO(cleanup): We should probably instead open /dev/fuse in the \"spk\" command (i.e.\n      //   outside the namespace) and then pass the FD to the server.\n      KJ_SYSCALL(mount(\"/dev/fuse\", \"dev/fuse\", nullptr, MS_BIND, nullptr));\n    }\n\n    // Bind in the host's /etc as /etc.host.\n    // As noted in backup.c++, MS_BIND does not respect mount flags on the initial bind, and\n    // we have to issue a remount to set them.  Because the host /etc may have been mounted nosuid,\n    // nodev, and noexec, we also add those flags here lest mount() think we're trying to remove\n    // them (which would cause mount() to fail).  We also need MS_REC because the host may have\n    // mounted other FSes under /etc, and we need to recursively rebind those.\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n    // Then do the same for /run.\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n\n    // Mount a tmpfs at /run.\n    KJ_SYSCALL(mount(\"tmpfs\", \"run\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Mount a tmpfs at /etc.\n    KJ_SYSCALL(mount(\"tmpfs\", \"etc\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Symlink in necessary config files from the host, as described in the bundle's host.list\n    linkHostFiles();\n    // And just in case the user has /etc/resolv.conf as a symlink to something we haven't linked\n    // in, copy its contents to /etc/resolv.conf.host-initial so we can use that if needed.\n    backupResolvConf();\n\n    // OK, change our root directory.\n    KJ_SYSCALL(syscall(SYS_pivot_root, \".\", \"tmp\"));\n    KJ_SYSCALL(chdir(\"/\"));\n    KJ_SYSCALL(umount2(\"tmp\", MNT_DETACH));\n\n    // The environment inherited from the host is probably no good for us. E.g. an oddball\n    // locale setting can crash Mongo because we don't have the appropriate locale files available.\n    //\n    // That said, there are a few environment variables that we do re-export.\n    std::map<const char*, kj::String> envVars;\n    static const char* const KEEP_VARS[] = {\"http_proxy\", \"https_proxy\"};\n    for (const char* varName: KEEP_VARS) {\n      const char* envValue = getenv(varName);\n      if (envValue != nullptr) {\n        envVars.insert(std::make_pair(varName, kj::str(envValue)));\n      }\n    }\n    KJ_SYSCALL(clearenv());\n\n    // Set up an environment appropriate for us.\n    KJ_SYSCALL(setenv(\"LANG\", \"C.UTF-8\", true));\n    KJ_SYSCALL(setenv(\"PATH\", \"/usr/bin:/bin\", true));\n    KJ_SYSCALL(setenv(\"LD_LIBRARY_PATH\", \"/usr/local/lib:/usr/lib:/lib\", true));\n\n    // Copy any remaining environment variables in that we captured.\n    for (auto& entry: envVars) {\n      KJ_SYSCALL(setenv(entry.first, entry.second.cStr(), true));\n    }\n\n    // See if /etc/resolv.conf exists, and if not, try replacing it with the backup made earlier.\n    restoreResolvConfIfNeeded();\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;",
            "bool changedDir = false;",
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool changedDir = false;\nbool runningAsRoot = getuid() == 0;\n\nvoid enterChroot(bool inPidNamespace) {\n    KJ_REQUIRE(changedDir);\n\n    // Verify ownership is intact.\n    checkOwnedByRoot(\"..\", \"Install directory\");\n    checkOwnedByRoot(\".\", \"Version install directory\");\n    checkOwnedByRoot(\"sandstorm\", \"'sandstorm' executable\");\n    checkOwnedByRoot(\"../sandstorm.conf\", \"Config file\");\n\n    kj::StringPtr tmpfsUidOpts = \"\";\n    if (runningAsRoot) {\n      tmpfsUidOpts = \",uid=0,gid=0\";\n    } else {\n      unshareUidNamespaceOnce();\n    }\n\n    // Unshare the mount namespace, so we can create some private bind mounts.\n    KJ_SYSCALL(unshare(CLONE_NEWNS));\n\n    // To really unshare the mount namespace, we also have to make sure all mounts are private.\n    // The parameters here were derived by strace'ing `mount --make-rprivate /`.  AFAICT the flags\n    // are undocumented.  :(\n    KJ_SYSCALL(mount(\"none\", \"/\", nullptr, MS_REC | MS_PRIVATE, nullptr));\n\n    // Make sure that the current directory is a mount point so that we can use pivot_root.\n    KJ_SYSCALL(mount(\".\", \".\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Now change directory into the new mount point.\n    char cwdBuf[PATH_MAX + 1];\n    if (getcwd(cwdBuf, sizeof(cwdBuf)) == nullptr) {\n      KJ_FAIL_SYSCALL(\"getcwd\", errno);\n    }\n    KJ_SYSCALL(chdir(cwdBuf));\n\n    if (inPidNamespace) {\n      // Mount /proc for our PID namespace in the chroot.\n      KJ_SYSCALL(mount(\"proc\", \"proc\", \"proc\", MS_NOSUID | MS_NODEV | MS_NOEXEC, \"\"));\n    } else {\n      // Bind /proc for the global pid namespace in the chroot.\n      KJ_SYSCALL(mount(\"/proc\", \"proc\", nullptr, MS_BIND | MS_REC, nullptr));\n    }\n\n    // Bind var -> ../var, so that all versions share the same var.\n    // Same for tmp, though we clear it on every startup.\n    KJ_SYSCALL(mount(\"../var\", \"var\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"../tmp\", \"tmp\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Bind devices from /dev into our chroot environment.\n    // We can't bind /dev itself because this is apparently not allowed when in a UID namespace\n    // (returns EINVAL; haven't figured out why yet).\n    KJ_SYSCALL(mount(\"/dev/null\", \"dev/null\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/zero\", \"dev/zero\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/random\", \"dev/random\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/urandom\", \"dev/urandom\", nullptr, MS_BIND, nullptr));\n\n    if (runningAsRoot && access(\"/dev/fuse\", F_OK) == 0) {\n      // Bring in FUSE just in case we need it for \"spk dev\".\n      // TODO(cleanup): We should probably instead open /dev/fuse in the \"spk\" command (i.e.\n      //   outside the namespace) and then pass the FD to the server.\n      KJ_SYSCALL(mount(\"/dev/fuse\", \"dev/fuse\", nullptr, MS_BIND, nullptr));\n    }\n\n    // Bind in the host's /etc as /etc.host.\n    // As noted in backup.c++, MS_BIND does not respect mount flags on the initial bind, and\n    // we have to issue a remount to set them.  Because the host /etc may have been mounted nosuid,\n    // nodev, and noexec, we also add those flags here lest mount() think we're trying to remove\n    // them (which would cause mount() to fail).  We also need MS_REC because the host may have\n    // mounted other FSes under /etc, and we need to recursively rebind those.\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n    // Then do the same for /run.\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n\n    // Mount a tmpfs at /run.\n    KJ_SYSCALL(mount(\"tmpfs\", \"run\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Mount a tmpfs at /etc.\n    KJ_SYSCALL(mount(\"tmpfs\", \"etc\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Symlink in necessary config files from the host, as described in the bundle's host.list\n    linkHostFiles();\n    // And just in case the user has /etc/resolv.conf as a symlink to something we haven't linked\n    // in, copy its contents to /etc/resolv.conf.host-initial so we can use that if needed.\n    backupResolvConf();\n\n    // OK, change our root directory.\n    KJ_SYSCALL(syscall(SYS_pivot_root, \".\", \"tmp\"));\n    KJ_SYSCALL(chdir(\"/\"));\n    KJ_SYSCALL(umount2(\"tmp\", MNT_DETACH));\n\n    // The environment inherited from the host is probably no good for us. E.g. an oddball\n    // locale setting can crash Mongo because we don't have the appropriate locale files available.\n    //\n    // That said, there are a few environment variables that we do re-export.\n    std::map<const char*, kj::String> envVars;\n    static const char* const KEEP_VARS[] = {\"http_proxy\", \"https_proxy\"};\n    for (const char* varName: KEEP_VARS) {\n      const char* envValue = getenv(varName);\n      if (envValue != nullptr) {\n        envVars.insert(std::make_pair(varName, kj::str(envValue)));\n      }\n    }\n    KJ_SYSCALL(clearenv());\n\n    // Set up an environment appropriate for us.\n    KJ_SYSCALL(setenv(\"LANG\", \"C.UTF-8\", true));\n    KJ_SYSCALL(setenv(\"PATH\", \"/usr/bin:/bin\", true));\n    KJ_SYSCALL(setenv(\"LD_LIBRARY_PATH\", \"/usr/local/lib:/usr/lib:/lib\", true));\n\n    // Copy any remaining environment variables in that we captured.\n    for (auto& entry: envVars) {\n      KJ_SYSCALL(setenv(entry.first, entry.second.cStr(), true));\n    }\n\n    // See if /etc/resolv.conf exists, and if not, try replacing it with the backup made earlier.\n    restoreResolvConfIfNeeded();\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\n[[noreturn]] void runServerMonitor(const Config& config, FdBundle& fdBundle) {\n    // Run the server monitor, which runs node and mongo and deals with them dying.\n\n    enterChroot(true);\n\n    // For later use when killing children with timeout.\n    registerAlarmHandler();\n\n    // MongoDB forks a subprocess but we want to be its reaper.\n    KJ_SYSCALL(prctl(PR_SET_CHILD_SUBREAPER, 1, 0, 0, 0));\n\n    auto sigfd = prepareMonitoringLoop();\n\n    context.warning(\"** Starting back-end...\");\n    pid_t backendPid = startBackend(config, fdBundle);\n    uint64_t backendStartTime = getTime();\n\n    context.warning(\"** Starting MongoDB...\");\n    pid_t mongoPid = startMongo(config, fdBundle);\n    int64_t mongoStartTime = getTime();\n\n    // Create the mongo user if it hasn't been created already.\n    maybeCreateMongoUser(config, fdBundle);\n\n    context.warning(\"** Back-end and Mongo started; now starting front-end...\");\n\n    // If we're root, run the dev daemon. At present the dev daemon requires root (in order to\n    // use FUSE), so we don't run it if we aren't root.\n    pid_t devDaemonPid;\n    if (runningAsRoot) {\n      KJ_SYSCALL(devDaemonPid = fork());\n      if (devDaemonPid == 0) {\n        // Ugh, undo the setup we *just* did. Note that we can't just fork the dev daemon earlier\n        // because it wants to connect to mongo first thing.\n        sigfd = nullptr;\n        clearSignalMask();\n        KJ_SYSCALL(signal(SIGALRM, SIG_DFL));\n        fdBundle.closeAll();\n        runDevDaemon(config);\n        KJ_UNREACHABLE;\n      }\n    } else {\n      devDaemonPid = 0;\n      context.warning(\"Note: Not accepting \\\"spk dev\\\" connections because not running as root.\");\n    }\n\n    pid_t nodePid = startNode(config, fdBundle);\n    int64_t nodeStartTime = getTime();\n\n    for (;;) {\n      // Wait for a signal -- any signal.\n      struct signalfd_siginfo siginfo;\n      KJ_SYSCALL(read(sigfd, &siginfo, sizeof(siginfo)));\n\n      if (siginfo.ssi_signo == SIGCHLD) {\n        // Some child exited.  If it's Mongo or Node we have a problem, but it could also be some\n        // grandchild that was orphaned and thus reparented to the PID namespace's init process,\n        // which is us.\n\n        // Reap zombies until there are no more.\n        bool backendDied = false;\n        bool mongoDied = false;\n        bool nodeDied = false;\n        for (;;) {\n          int status;\n          pid_t deadPid = waitpid(-1, &status, WNOHANG);\n          if (deadPid <= 0) {\n            // No more zombies.\n            break;\n          } else if (deadPid == backendPid) {\n            backendDied = true;\n          } else if (deadPid == mongoPid) {\n            mongoDied = true;\n          } else if (deadPid == nodePid) {\n            nodeDied = true;\n          } else if (deadPid == devDaemonPid) {\n            // We don't restart the dev daemon since it should never crash in the first place.\n            // Just record that we already reaped it.\n            devDaemonPid = 0;\n          }\n        }\n\n        // Deal with mongo or node dying.\n        if (backendDied) {\n          maybeWaitAfterChildDeath(\"Back-end\", backendStartTime);\n          backendPid = startBackend(config, fdBundle);\n          backendStartTime = getTime();\n        }\n        if (mongoDied) {\n          maybeWaitAfterChildDeath(\"MongoDB\", mongoStartTime);\n          mongoPid = startMongo(config, fdBundle);\n          mongoStartTime = getTime();\n        }\n        if (nodeDied) {\n          maybeWaitAfterChildDeath(\"Front-end\", nodeStartTime);\n          nodePid = startNode(config, fdBundle);\n          nodeStartTime = getTime();\n        }\n\n        if (mongoDied && !nodeDied) {\n          // If the back-end died then we unfortunately need to restart node as well.\n          context.warning(\"** Restarting front-end due to back-end failure\");\n          killChild(\"Front-end\", nodePid);\n          nodePid = startNode(config, fdBundle);\n          nodeStartTime = getTime();\n        }\n      } else if (siginfo.ssi_signo == SIGINT) {\n        if (siginfo.ssi_int) {\n          // Requested startup of front-end after previous shutdown.\n          if (nodePid == 0) {\n            context.warning(\"** Starting front-end by admin request\");\n            fdBundle = FdBundle(config);  // re-open FDs\n            nodePid = startNode(config, fdBundle);\n            nodeStartTime = getTime();\n          } else {\n            context.warning(\"** Request to start front-end, but it is already running\");\n          }\n        } else {\n          // Requested shutdown of the front-end but not the back-end.\n          context.warning(\"** Shutting down front-end by admin request\");\n          killChild(\"Front-end\", nodePid);\n          nodePid = 0;\n\n          // We have to close the FD bundle otherwise run-dev won't work.\n          fdBundle.closeAll();\n        }\n      } else {\n        // SIGTERM or something.\n        context.warning(\"** Shutting down due to signal\");\n        killChild(\"Front-end\", nodePid);\n        killChild(\"MongoDB\", mongoPid);\n        killChild(\"Back-end\", backendPid);\n        killChild(\"Dev daemon\", devDaemonPid);\n        context.exit();\n      }\n    }\n  }"
  },
  {
    "function_name": "runUpdateMonitor",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1791-1920",
    "snippet": "[[noreturn]] void runUpdateMonitor(const Config& config, FdBundle& fdBundle, int pidfile) {\n    // Run the update monitor process.  This process runs two subprocesses:  the sandstorm server\n    // and the auto-updater.\n\n    if (runningAsRoot) {\n      // Fix permissions on pidfile. We do this here rather than back where we opened it because\n      // a previous version failed to do this and we want it fixed immediately on upgrade.\n      KJ_SYSCALL(fchown(pidfile, 0, config.uids.gid));\n      KJ_SYSCALL(fchmod(pidfile, 0660));\n\n      // Additionally, fix permissions on sandcats-related data, which was originally owned by root\n      fixSandcatsPermissions(config);\n\n      // Fix permissions on /var/sandstorm, which was originally owned by root:root.\n      KJ_SYSCALL(chown(\"../var/sandstorm\", 0, config.uids.gid));\n      KJ_SYSCALL(chmod(\"../var/sandstorm\", 0770));\n\n      // Fix permissions on /var/sandstorm/grains, which originally had mode 0730 because grain\n      // IDs were secret.\n      KJ_SYSCALL(chmod(\"../var/sandstorm/grains\", 0770));\n    }\n\n    cleanupOldVersions();\n\n    // Clean up the temp directory.\n    KJ_REQUIRE(changedDir);\n\n    static const char* const TMPDIRS[2] = { \"../tmp\", \"../var/sandstorm/tmp\" };\n    for (const char* tmpDir: TMPDIRS) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        if (access(tmpDir, F_OK) == 0) {\n          recursivelyDelete(tmpDir);\n        }\n        mkdir(tmpDir, 0770);\n        KJ_SYSCALL(chmod(tmpDir, 0770 | S_ISVTX));\n        if (runningAsRoot) {\n          KJ_SYSCALL(chown(tmpDir, 0, config.uids.gid));\n        }\n      })) {\n        KJ_LOG(WARNING, \"failed to clean up tmpdir; leaving it for now\", tmpDir, *exception);\n      }\n    }\n\n    auto sigfd = prepareMonitoringLoop();\n\n    pid_t updaterPid = startUpdater(config, fdBundle, false);\n\n    pid_t sandstormPid = fork();\n    if (sandstormPid == 0) {\n      runServerMonitor(config, fdBundle);\n      KJ_UNREACHABLE;\n    }\n\n    for (;;) {\n      // Wait for a signal -- any signal.\n      struct signalfd_siginfo siginfo;\n      KJ_SYSCALL(read(sigfd, &siginfo, sizeof(siginfo)));\n\n      if (siginfo.ssi_signo == SIGCHLD) {\n        // Some child exited.\n\n        // Reap zombies until there are no more.\n        bool updaterDied = false;\n        bool updaterSucceeded = false;\n        bool sandstormDied = false;\n        for (;;) {\n          int status;\n          pid_t deadPid = waitpid(-1, &status, WNOHANG);\n          if (deadPid <= 0) {\n            // No more zombies.\n            break;\n          } else if (deadPid == updaterPid) {\n            updaterDied = true;\n            updaterSucceeded = WIFEXITED(status) && WEXITSTATUS(status) == 0;\n          } else if (deadPid == sandstormPid) {\n            sandstormDied = true;\n          }\n        }\n\n        if (updaterSucceeded) {\n          context.warning(\"** Restarting to apply update\");\n          killChild(\"Server Monitor\", sandstormPid);\n          restartForUpdate(pidfile, fdBundle);\n          KJ_UNREACHABLE;\n        } else if (updaterDied) {\n          context.warning(\"** Updater died; restarting it\");\n          updaterPid = startUpdater(config, fdBundle, true);\n        } else if (sandstormDied) {\n          context.exitError(\"** Server monitor died. Aborting.\");\n          KJ_UNREACHABLE;\n        }\n      } else if (siginfo.ssi_signo == SIGINT) {\n        // Frontend startup or shutdown request, used with run-dev.\n\n        if (!siginfo.ssi_int) {\n          // We have to close all the listen ports otherwise run-dev won't be able to open them\n          // for itself. Note that we never re-open them here in the parent process, meaning that\n          // if you stop-fe and then start-fe and then do an update, you won't get a zero-downtime\n          // update. This only affects developers so whatever.\n          fdBundle.closeAll();\n        }\n\n        // Pass along to server monitor.\n        union sigval sigval;\n        memset(&sigval, 0, sizeof(sigval));\n        sigval.sival_int = siginfo.ssi_int;\n        KJ_SYSCALL(sigqueue(sandstormPid, SIGINT, sigval));\n      } else {\n        // Kill updater if it is running.\n        if (updaterPid != 0) {\n          KJ_SYSCALL(kill(updaterPid, SIGKILL));\n        }\n\n        // Shutdown server.\n        KJ_SYSCALL(kill(sandstormPid, SIGTERM));\n        int status;\n        KJ_SYSCALL(waitpid(sandstormPid, &status, 0));\n\n        // Handle signal.\n        if (siginfo.ssi_signo == SIGHUP) {\n          context.warning(\"** Restarting\");\n          restartForUpdate(pidfile, fdBundle);\n        } else {\n          // SIGTERM or something.\n          context.exitInfo(\"** Exiting\");\n        }\n        KJ_UNREACHABLE;\n      }\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "union sigval sigval;",
      "bool changedDir = false;",
      "bool runningAsRoot = getuid() == 0;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "\"** Exiting\""
          ],
          "line": 1915
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "restartForUpdate",
          "args": [
            "pidfile",
            "fdBundle"
          ],
          "line": 1912
        },
        "resolved": true,
        "details": {
          "function_name": "restartForUpdate",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2602-2625",
          "snippet": "[[noreturn]] void restartForUpdate(int pidfileFd, FdBundle& fdBundle) {\n    // Change pidfile to not close on exec, since we want it to live through the following exec!\n    KJ_SYSCALL(fcntl(pidfileFd, F_SETFD, 0));\n\n    auto inheritArgs = fdBundle.prepareForContinue();\n\n    // Create arg list.\n    kj::Vector<const char*> argv;\n    argv.add(\"../latest/sandstorm\");\n    argv.add(\"continue\");\n    if (unsharedUidNamespace) {\n      argv.add(\"--userns\");\n    }\n    auto pidfileFdStr = kj::str(pidfileFd);\n    argv.add(pidfileFdStr.cStr());\n    for (auto& a: inheritArgs) {\n      argv.add(a.cStr());\n    }\n    argv.add(EXEC_END_ARGS);\n\n    // Exec the new version with our magic \"continue\".\n    KJ_SYSCALL(execv(argv[0], const_cast<char**>(argv.begin())));\n    KJ_UNREACHABLE;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool unsharedUidNamespace = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool unsharedUidNamespace = false;\n\n[[noreturn]] void restartForUpdate(int pidfileFd, FdBundle& fdBundle) {\n    // Change pidfile to not close on exec, since we want it to live through the following exec!\n    KJ_SYSCALL(fcntl(pidfileFd, F_SETFD, 0));\n\n    auto inheritArgs = fdBundle.prepareForContinue();\n\n    // Create arg list.\n    kj::Vector<const char*> argv;\n    argv.add(\"../latest/sandstorm\");\n    argv.add(\"continue\");\n    if (unsharedUidNamespace) {\n      argv.add(\"--userns\");\n    }\n    auto pidfileFdStr = kj::str(pidfileFd);\n    argv.add(pidfileFdStr.cStr());\n    for (auto& a: inheritArgs) {\n      argv.add(a.cStr());\n    }\n    argv.add(EXEC_END_ARGS);\n\n    // Exec the new version with our magic \"continue\".\n    KJ_SYSCALL(execv(argv[0], const_cast<char**>(argv.begin())));\n    KJ_UNREACHABLE;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Restarting\""
          ],
          "line": 1911
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "waitpid(sandstormPid, &status, 0)"
          ],
          "line": 1907
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "waitpid",
          "args": [
            "sandstormPid",
            "&status",
            "0"
          ],
          "line": 1907
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "kill(sandstormPid, SIGTERM)"
          ],
          "line": 1905
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kill",
          "args": [
            "sandstormPid",
            "SIGTERM"
          ],
          "line": 1905
        },
        "resolved": true,
        "details": {
          "function_name": "killChild",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2377-2413",
          "snippet": "void killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nvoid killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "kill(updaterPid, SIGKILL)"
          ],
          "line": 1901
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigqueue(sandstormPid, SIGINT, sigval)"
          ],
          "line": 1897
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sigqueue",
          "args": [
            "sandstormPid",
            "SIGINT",
            "sigval"
          ],
          "line": 1897
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&sigval",
            "0",
            "sizeof(sigval)"
          ],
          "line": 1895
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fdBundle.closeAll",
          "args": [],
          "line": 1890
        },
        "resolved": true,
        "details": {
          "function_name": "closeAll",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1693-1695",
          "snippet": "void closeAll() {\n      ports.clear();\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void closeAll() {\n        ports.clear();\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.exitError",
          "args": [
            "\"** Server monitor died. Aborting.\""
          ],
          "line": 1879
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "startUpdater",
          "args": [
            "config",
            "fdBundle",
            "true"
          ],
          "line": 1877
        },
        "resolved": true,
        "details": {
          "function_name": "startUpdater",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2544-2561",
          "snippet": "pid_t startUpdater(const Config& config, FdBundle& fdBundle, bool isRetry) {\n    if (config.updateChannel == nullptr) {\n      context.warning(\"WARNING: Auto-updates are disabled by config.\");\n      return 0;\n    } else if (access(\"..\", W_OK) != 0) {\n      context.warning(\"WARNING: Auto-updates are disabled because the server does not have write \"\n                      \"access to the installation location.\");\n      return 0;\n    } else {\n      pid_t pid = fork();\n      if (pid == 0) {\n        fdBundle.closeAll();\n        doUpdateLoop(config.updateChannel, isRetry, config);\n        KJ_UNREACHABLE;\n      }\n      return pid;\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\npid_t startUpdater(const Config& config, FdBundle& fdBundle, bool isRetry) {\n    if (config.updateChannel == nullptr) {\n      context.warning(\"WARNING: Auto-updates are disabled by config.\");\n      return 0;\n    } else if (access(\"..\", W_OK) != 0) {\n      context.warning(\"WARNING: Auto-updates are disabled because the server does not have write \"\n                      \"access to the installation location.\");\n      return 0;\n    } else {\n      pid_t pid = fork();\n      if (pid == 0) {\n        fdBundle.closeAll();\n        doUpdateLoop(config.updateChannel, isRetry, config);\n        KJ_UNREACHABLE;\n      }\n      return pid;\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Updater died; restarting it\""
          ],
          "line": 1876
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"** Restarting to apply update\""
          ],
          "line": 1871
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "WEXITSTATUS",
          "args": [
            "status"
          ],
          "line": 1864
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "WIFEXITED",
          "args": [
            "status"
          ],
          "line": 1864
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "waitpid",
          "args": [
            "-1",
            "&status",
            "WNOHANG"
          ],
          "line": 1858
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "read(sigfd, &siginfo, sizeof(siginfo))"
          ],
          "line": 1847
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "read",
          "args": [
            "sigfd",
            "&siginfo",
            "sizeof(siginfo)"
          ],
          "line": 1847
        },
        "resolved": true,
        "details": {
          "function_name": "read",
          "container": "RefcountedAsyncIoStream",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/sandstorm-http-bridge.c++",
          "lines": "908-910",
          "snippet": "kj::Promise<size_t> read(void* buffer, size_t minBytes, size_t maxBytes) override {\n    return stream->read(buffer, minBytes, maxBytes);\n  }",
          "includes": [
            "#include \"bridge-proxy.h\"",
            "#include \"util.h\"",
            "#include \"version.h\"",
            "#include <joyent-http/http_parser.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/sandstorm-http-bridge-internal.capnp.h>",
            "#include <sandstorm/sandstorm-http-bridge.capnp.h>",
            "#include <sandstorm/email.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <sandstorm/util.capnp.h>",
            "#include <stdio.h>",
            "#include <fcntl.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <time.h>",
            "#include <unordered_map>",
            "#include <map>",
            "#include <unistd.h>",
            "#include <arpa/inet.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/schema.h>",
            "#include <capnp/rpc.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/io.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/async-io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"bridge-proxy.h\"\n#include \"util.h\"\n#include \"version.h\"\n#include <joyent-http/http_parser.h>\n#include <sandstorm/package.capnp.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/sandstorm-http-bridge-internal.capnp.h>\n#include <sandstorm/sandstorm-http-bridge.capnp.h>\n#include <sandstorm/email.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <sandstorm/util.capnp.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <sys/wait.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <time.h>\n#include <unordered_map>\n#include <map>\n#include <unistd.h>\n#include <arpa/inet.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/schema.h>\n#include <capnp/rpc.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/io.h>\n#include <kj/async-unix.h>\n#include <kj/async-io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nRefcountedAsyncIoStream {\n  kj::Promise<size_t> read(void* buffer, size_t minBytes, size_t maxBytes) override {\n      return stream->read(buffer, minBytes, maxBytes);\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "runServerMonitor",
          "args": [
            "config",
            "fdBundle"
          ],
          "line": 1840
        },
        "resolved": true,
        "details": {
          "function_name": "runServerMonitor",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1922-2058",
          "snippet": "[[noreturn]] void runServerMonitor(const Config& config, FdBundle& fdBundle) {\n    // Run the server monitor, which runs node and mongo and deals with them dying.\n\n    enterChroot(true);\n\n    // For later use when killing children with timeout.\n    registerAlarmHandler();\n\n    // MongoDB forks a subprocess but we want to be its reaper.\n    KJ_SYSCALL(prctl(PR_SET_CHILD_SUBREAPER, 1, 0, 0, 0));\n\n    auto sigfd = prepareMonitoringLoop();\n\n    context.warning(\"** Starting back-end...\");\n    pid_t backendPid = startBackend(config, fdBundle);\n    uint64_t backendStartTime = getTime();\n\n    context.warning(\"** Starting MongoDB...\");\n    pid_t mongoPid = startMongo(config, fdBundle);\n    int64_t mongoStartTime = getTime();\n\n    // Create the mongo user if it hasn't been created already.\n    maybeCreateMongoUser(config, fdBundle);\n\n    context.warning(\"** Back-end and Mongo started; now starting front-end...\");\n\n    // If we're root, run the dev daemon. At present the dev daemon requires root (in order to\n    // use FUSE), so we don't run it if we aren't root.\n    pid_t devDaemonPid;\n    if (runningAsRoot) {\n      KJ_SYSCALL(devDaemonPid = fork());\n      if (devDaemonPid == 0) {\n        // Ugh, undo the setup we *just* did. Note that we can't just fork the dev daemon earlier\n        // because it wants to connect to mongo first thing.\n        sigfd = nullptr;\n        clearSignalMask();\n        KJ_SYSCALL(signal(SIGALRM, SIG_DFL));\n        fdBundle.closeAll();\n        runDevDaemon(config);\n        KJ_UNREACHABLE;\n      }\n    } else {\n      devDaemonPid = 0;\n      context.warning(\"Note: Not accepting \\\"spk dev\\\" connections because not running as root.\");\n    }\n\n    pid_t nodePid = startNode(config, fdBundle);\n    int64_t nodeStartTime = getTime();\n\n    for (;;) {\n      // Wait for a signal -- any signal.\n      struct signalfd_siginfo siginfo;\n      KJ_SYSCALL(read(sigfd, &siginfo, sizeof(siginfo)));\n\n      if (siginfo.ssi_signo == SIGCHLD) {\n        // Some child exited.  If it's Mongo or Node we have a problem, but it could also be some\n        // grandchild that was orphaned and thus reparented to the PID namespace's init process,\n        // which is us.\n\n        // Reap zombies until there are no more.\n        bool backendDied = false;\n        bool mongoDied = false;\n        bool nodeDied = false;\n        for (;;) {\n          int status;\n          pid_t deadPid = waitpid(-1, &status, WNOHANG);\n          if (deadPid <= 0) {\n            // No more zombies.\n            break;\n          } else if (deadPid == backendPid) {\n            backendDied = true;\n          } else if (deadPid == mongoPid) {\n            mongoDied = true;\n          } else if (deadPid == nodePid) {\n            nodeDied = true;\n          } else if (deadPid == devDaemonPid) {\n            // We don't restart the dev daemon since it should never crash in the first place.\n            // Just record that we already reaped it.\n            devDaemonPid = 0;\n          }\n        }\n\n        // Deal with mongo or node dying.\n        if (backendDied) {\n          maybeWaitAfterChildDeath(\"Back-end\", backendStartTime);\n          backendPid = startBackend(config, fdBundle);\n          backendStartTime = getTime();\n        }\n        if (mongoDied) {\n          maybeWaitAfterChildDeath(\"MongoDB\", mongoStartTime);\n          mongoPid = startMongo(config, fdBundle);\n          mongoStartTime = getTime();\n        }\n        if (nodeDied) {\n          maybeWaitAfterChildDeath(\"Front-end\", nodeStartTime);\n          nodePid = startNode(config, fdBundle);\n          nodeStartTime = getTime();\n        }\n\n        if (mongoDied && !nodeDied) {\n          // If the back-end died then we unfortunately need to restart node as well.\n          context.warning(\"** Restarting front-end due to back-end failure\");\n          killChild(\"Front-end\", nodePid);\n          nodePid = startNode(config, fdBundle);\n          nodeStartTime = getTime();\n        }\n      } else if (siginfo.ssi_signo == SIGINT) {\n        if (siginfo.ssi_int) {\n          // Requested startup of front-end after previous shutdown.\n          if (nodePid == 0) {\n            context.warning(\"** Starting front-end by admin request\");\n            fdBundle = FdBundle(config);  // re-open FDs\n            nodePid = startNode(config, fdBundle);\n            nodeStartTime = getTime();\n          } else {\n            context.warning(\"** Request to start front-end, but it is already running\");\n          }\n        } else {\n          // Requested shutdown of the front-end but not the back-end.\n          context.warning(\"** Shutting down front-end by admin request\");\n          killChild(\"Front-end\", nodePid);\n          nodePid = 0;\n\n          // We have to close the FD bundle otherwise run-dev won't work.\n          fdBundle.closeAll();\n        }\n      } else {\n        // SIGTERM or something.\n        context.warning(\"** Shutting down due to signal\");\n        killChild(\"Front-end\", nodePid);\n        killChild(\"MongoDB\", mongoPid);\n        killChild(\"Back-end\", backendPid);\n        killChild(\"Dev daemon\", devDaemonPid);\n        context.exit();\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\n[[noreturn]] void runServerMonitor(const Config& config, FdBundle& fdBundle) {\n    // Run the server monitor, which runs node and mongo and deals with them dying.\n\n    enterChroot(true);\n\n    // For later use when killing children with timeout.\n    registerAlarmHandler();\n\n    // MongoDB forks a subprocess but we want to be its reaper.\n    KJ_SYSCALL(prctl(PR_SET_CHILD_SUBREAPER, 1, 0, 0, 0));\n\n    auto sigfd = prepareMonitoringLoop();\n\n    context.warning(\"** Starting back-end...\");\n    pid_t backendPid = startBackend(config, fdBundle);\n    uint64_t backendStartTime = getTime();\n\n    context.warning(\"** Starting MongoDB...\");\n    pid_t mongoPid = startMongo(config, fdBundle);\n    int64_t mongoStartTime = getTime();\n\n    // Create the mongo user if it hasn't been created already.\n    maybeCreateMongoUser(config, fdBundle);\n\n    context.warning(\"** Back-end and Mongo started; now starting front-end...\");\n\n    // If we're root, run the dev daemon. At present the dev daemon requires root (in order to\n    // use FUSE), so we don't run it if we aren't root.\n    pid_t devDaemonPid;\n    if (runningAsRoot) {\n      KJ_SYSCALL(devDaemonPid = fork());\n      if (devDaemonPid == 0) {\n        // Ugh, undo the setup we *just* did. Note that we can't just fork the dev daemon earlier\n        // because it wants to connect to mongo first thing.\n        sigfd = nullptr;\n        clearSignalMask();\n        KJ_SYSCALL(signal(SIGALRM, SIG_DFL));\n        fdBundle.closeAll();\n        runDevDaemon(config);\n        KJ_UNREACHABLE;\n      }\n    } else {\n      devDaemonPid = 0;\n      context.warning(\"Note: Not accepting \\\"spk dev\\\" connections because not running as root.\");\n    }\n\n    pid_t nodePid = startNode(config, fdBundle);\n    int64_t nodeStartTime = getTime();\n\n    for (;;) {\n      // Wait for a signal -- any signal.\n      struct signalfd_siginfo siginfo;\n      KJ_SYSCALL(read(sigfd, &siginfo, sizeof(siginfo)));\n\n      if (siginfo.ssi_signo == SIGCHLD) {\n        // Some child exited.  If it's Mongo or Node we have a problem, but it could also be some\n        // grandchild that was orphaned and thus reparented to the PID namespace's init process,\n        // which is us.\n\n        // Reap zombies until there are no more.\n        bool backendDied = false;\n        bool mongoDied = false;\n        bool nodeDied = false;\n        for (;;) {\n          int status;\n          pid_t deadPid = waitpid(-1, &status, WNOHANG);\n          if (deadPid <= 0) {\n            // No more zombies.\n            break;\n          } else if (deadPid == backendPid) {\n            backendDied = true;\n          } else if (deadPid == mongoPid) {\n            mongoDied = true;\n          } else if (deadPid == nodePid) {\n            nodeDied = true;\n          } else if (deadPid == devDaemonPid) {\n            // We don't restart the dev daemon since it should never crash in the first place.\n            // Just record that we already reaped it.\n            devDaemonPid = 0;\n          }\n        }\n\n        // Deal with mongo or node dying.\n        if (backendDied) {\n          maybeWaitAfterChildDeath(\"Back-end\", backendStartTime);\n          backendPid = startBackend(config, fdBundle);\n          backendStartTime = getTime();\n        }\n        if (mongoDied) {\n          maybeWaitAfterChildDeath(\"MongoDB\", mongoStartTime);\n          mongoPid = startMongo(config, fdBundle);\n          mongoStartTime = getTime();\n        }\n        if (nodeDied) {\n          maybeWaitAfterChildDeath(\"Front-end\", nodeStartTime);\n          nodePid = startNode(config, fdBundle);\n          nodeStartTime = getTime();\n        }\n\n        if (mongoDied && !nodeDied) {\n          // If the back-end died then we unfortunately need to restart node as well.\n          context.warning(\"** Restarting front-end due to back-end failure\");\n          killChild(\"Front-end\", nodePid);\n          nodePid = startNode(config, fdBundle);\n          nodeStartTime = getTime();\n        }\n      } else if (siginfo.ssi_signo == SIGINT) {\n        if (siginfo.ssi_int) {\n          // Requested startup of front-end after previous shutdown.\n          if (nodePid == 0) {\n            context.warning(\"** Starting front-end by admin request\");\n            fdBundle = FdBundle(config);  // re-open FDs\n            nodePid = startNode(config, fdBundle);\n            nodeStartTime = getTime();\n          } else {\n            context.warning(\"** Request to start front-end, but it is already running\");\n          }\n        } else {\n          // Requested shutdown of the front-end but not the back-end.\n          context.warning(\"** Shutting down front-end by admin request\");\n          killChild(\"Front-end\", nodePid);\n          nodePid = 0;\n\n          // We have to close the FD bundle otherwise run-dev won't work.\n          fdBundle.closeAll();\n        }\n      } else {\n        // SIGTERM or something.\n        context.warning(\"** Shutting down due to signal\");\n        killChild(\"Front-end\", nodePid);\n        killChild(\"MongoDB\", mongoPid);\n        killChild(\"Back-end\", backendPid);\n        killChild(\"Dev daemon\", devDaemonPid);\n        context.exit();\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "fork",
          "args": [],
          "line": 1838
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "prepareMonitoringLoop",
          "args": [],
          "line": 1834
        },
        "resolved": true,
        "details": {
          "function_name": "prepareMonitoringLoop",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "82-99",
          "snippet": "kj::AutoCloseFd prepareMonitoringLoop() {\n  // Prepare to run a loop where we monitor some children and also receive signals.  Returns a\n  // signalfd.\n\n  // Set up signal mask to catch events that should lead to shutdown.\n  sigset_t sigmask;\n  KJ_SYSCALL(sigemptyset(&sigmask));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGTERM));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGINT));   // request front-end shutdown\n  KJ_SYSCALL(sigaddset(&sigmask, SIGCHLD));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGHUP));\n  KJ_SYSCALL(sigprocmask(SIG_BLOCK, &sigmask, nullptr));\n\n  // Receive signals on a signalfd.\n  int sigfd;\n  KJ_SYSCALL(sigfd = signalfd(-1, &sigmask, SFD_CLOEXEC));\n  return kj::AutoCloseFd(sigfd);\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::AutoCloseFd prepareMonitoringLoop() {\n  // Prepare to run a loop where we monitor some children and also receive signals.  Returns a\n  // signalfd.\n\n  // Set up signal mask to catch events that should lead to shutdown.\n  sigset_t sigmask;\n  KJ_SYSCALL(sigemptyset(&sigmask));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGTERM));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGINT));   // request front-end shutdown\n  KJ_SYSCALL(sigaddset(&sigmask, SIGCHLD));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGHUP));\n  KJ_SYSCALL(sigprocmask(SIG_BLOCK, &sigmask, nullptr));\n\n  // Receive signals on a signalfd.\n  int sigfd;\n  KJ_SYSCALL(sigfd = signalfd(-1, &sigmask, SFD_CLOEXEC));\n  return kj::AutoCloseFd(sigfd);\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_LOG",
          "args": [
            "WARNING",
            "\"failed to clean up tmpdir; leaving it for now\"",
            "tmpDir",
            "*exception"
          ],
          "line": 1830
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "exception",
            "kj::runCatchingExceptions([&]() {\n        if (access(tmpDir, F_OK) == 0) {\n          recursivelyDelete(tmpDir);\n        }\n        mkdir(tmpDir, 0770);\n        KJ_SYSCALL(chmod(tmpDir, 0770 | S_ISVTX));\n        if (runningAsRoot) {\n          KJ_SYSCALL(chown(tmpDir, 0, config.uids.gid));\n        }\n      })"
          ],
          "line": 1820
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1662-1665",
          "snippet": "KJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }"
        }
      },
      {
        "call_info": {
          "callee": "kj::runCatchingExceptions",
          "args": [
            "[&]() {\n        if (access(tmpDir, F_OK) == 0) {\n          recursivelyDelete(tmpDir);\n        }\n        mkdir(tmpDir, 0770);\n        KJ_SYSCALL(chmod(tmpDir, 0770 | S_ISVTX));\n        if (runningAsRoot) {\n          KJ_SYSCALL(chown(tmpDir, 0, config.uids.gid));\n        }\n      }"
          ],
          "line": 1820
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chown(tmpDir, 0, config.uids.gid)"
          ],
          "line": 1827
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chown",
          "args": [
            "tmpDir",
            "0",
            "config.uids.gid"
          ],
          "line": 1827
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chmod(tmpDir, 0770 | S_ISVTX)"
          ],
          "line": 1825
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chmod",
          "args": [
            "tmpDir",
            "0770 | S_ISVTX"
          ],
          "line": 1825
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "tmpDir",
            "0770"
          ],
          "line": 1824
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "recursivelyDelete",
          "args": [
            "tmpDir"
          ],
          "line": 1822
        },
        "resolved": true,
        "details": {
          "function_name": "recursivelyDelete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "299-313",
          "snippet": "void recursivelyDelete(kj::StringPtr path) {\n  KJ_REQUIRE(!path.endsWith(\"/\"),\n      \"refusing to recursively delete directory name with trailing / to reduce risk of \"\n      \"catastrophic empty-string bugs\");\n  struct stat stats;\n  KJ_SYSCALL(lstat(path.cStr(), &stats), path) { return; }\n  if (S_ISDIR(stats.st_mode)) {\n    for (auto& file: listDirectory(path)) {\n      recursivelyDelete(kj::str(path, \"/\", file));\n    }\n    KJ_SYSCALL(rmdir(path.cStr()), path) { break; }\n  } else {\n    KJ_SYSCALL(unlink(path.cStr()), path) { break; }\n  }\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nvoid recursivelyDelete(kj::StringPtr path) {\n  KJ_REQUIRE(!path.endsWith(\"/\"),\n      \"refusing to recursively delete directory name with trailing / to reduce risk of \"\n      \"catastrophic empty-string bugs\");\n  struct stat stats;\n  KJ_SYSCALL(lstat(path.cStr(), &stats), path) { return; }\n  if (S_ISDIR(stats.st_mode)) {\n    for (auto& file: listDirectory(path)) {\n      recursivelyDelete(kj::str(path, \"/\", file));\n    }\n    KJ_SYSCALL(rmdir(path.cStr()), path) { break; }\n  } else {\n    KJ_SYSCALL(unlink(path.cStr()), path) { break; }\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "tmpDir",
            "F_OK"
          ],
          "line": 1821
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "changedDir"
          ],
          "line": 1816
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "cleanupOldVersions",
          "args": [],
          "line": 1813
        },
        "resolved": true,
        "details": {
          "function_name": "cleanupOldVersions",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2627-2654",
          "snippet": "void cleanupOldVersions() {\n    for (auto& file: listDirectory(\"..\")) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        if (file.startsWith(\"sandstorm-\")) {\n          auto suffix = file.slice(strlen(\"sandstorm-\"));\n          if (suffix.startsWith(\"custom.\")) {\n            // This is a custom build. If we aren't currently running a custom build, go ahead and\n            // delete it.\n            if (SANDSTORM_BUILD != 0) {\n              recursivelyDelete(kj::str(\"../\", file));\n            }\n          } else KJ_IF_MAYBE(build, parseUInt(suffix, 10)) {\n            // Only delete older builds.\n            if (*build < SANDSTORM_BUILD) {\n              KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n                recursivelyDelete(kj::str(\"../\", file));\n              })) {\n                context.warning(kj::str(\"couldn't delete old build \", file, \": \",\n                                        exception->getDescription()));\n              }\n            }\n          }\n        }\n      })) {\n        KJ_LOG(ERROR, \"Error while trying to delete old versions.\", *exception);\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid cleanupOldVersions() {\n    for (auto& file: listDirectory(\"..\")) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        if (file.startsWith(\"sandstorm-\")) {\n          auto suffix = file.slice(strlen(\"sandstorm-\"));\n          if (suffix.startsWith(\"custom.\")) {\n            // This is a custom build. If we aren't currently running a custom build, go ahead and\n            // delete it.\n            if (SANDSTORM_BUILD != 0) {\n              recursivelyDelete(kj::str(\"../\", file));\n            }\n          } else KJ_IF_MAYBE(build, parseUInt(suffix, 10)) {\n            // Only delete older builds.\n            if (*build < SANDSTORM_BUILD) {\n              KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n                recursivelyDelete(kj::str(\"../\", file));\n              })) {\n                context.warning(kj::str(\"couldn't delete old build \", file, \": \",\n                                        exception->getDescription()));\n              }\n            }\n          }\n        }\n      })) {\n        KJ_LOG(ERROR, \"Error while trying to delete old versions.\", *exception);\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chmod(\"../var/sandstorm/grains\", 0770)"
          ],
          "line": 1810
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chmod",
          "args": [
            "\"../var/sandstorm/grains\"",
            "0770"
          ],
          "line": 1810
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chmod(\"../var/sandstorm\", 0770)"
          ],
          "line": 1806
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chmod",
          "args": [
            "\"../var/sandstorm\"",
            "0770"
          ],
          "line": 1806
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chown(\"../var/sandstorm\", 0, config.uids.gid)"
          ],
          "line": 1805
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chown",
          "args": [
            "\"../var/sandstorm\"",
            "0",
            "config.uids.gid"
          ],
          "line": 1805
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fixSandcatsPermissions",
          "args": [
            "config"
          ],
          "line": 1802
        },
        "resolved": true,
        "details": {
          "function_name": "fixSandcatsPermissions",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2656-2684",
          "snippet": "void fixSandcatsPermissions(const Config& config) {\n    // An older version of the sandcats installer left various sandcats-related files around owned\n    // by root, rather than the sandstorm server user.\n    // var/sandcats should be 0700, with corrected owner/group\n    if (access(\"../var/sandcats\", F_OK) == 0) {\n        setOwnerGroupAndMode(kj::str(\"../var/sandcats\"), 0700, config.uids.uid, config.uids.gid);\n    }\n\n    // Same issue with https directory & its subdirectories.\n    kj::String httpsBaseDir = kj::str(\"../var/sandcats/https\");\n    if (access(httpsBaseDir.cStr(), F_OK) == 0) {\n      setOwnerGroupAndMode(httpsBaseDir, 0700, config.uids.uid, config.uids.gid);\n\n      kj::Array<kj::String> entries = listDirectory(kj::str(httpsBaseDir));\n      for (size_t i = 0; i < entries.size(); i++) {\n        setOwnerGroupAndMode(kj::str(httpsBaseDir, \"/\", entries[i]), 0700, config.uids.uid, config.uids.gid);\n      }\n    }\n\n    // var/sandcats/{register-log,id_rsa{,.pub,private_combined}} should each be 0640, with corrected\n    // owner/group\n    static const char* const files[] = {\"register-log\", \"id_rsa\", \"id_rsa.pub\", \"id_rsa.private_combined\"};\n    for (auto f : files) {\n      auto path = kj::str(\"../var/sandcats/\", f);\n      if (access(path.cStr(), F_OK) == 0) {\n        setOwnerGroupAndMode(path, 0640, config.uids.uid, config.uids.gid);\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid fixSandcatsPermissions(const Config& config) {\n    // An older version of the sandcats installer left various sandcats-related files around owned\n    // by root, rather than the sandstorm server user.\n    // var/sandcats should be 0700, with corrected owner/group\n    if (access(\"../var/sandcats\", F_OK) == 0) {\n        setOwnerGroupAndMode(kj::str(\"../var/sandcats\"), 0700, config.uids.uid, config.uids.gid);\n    }\n\n    // Same issue with https directory & its subdirectories.\n    kj::String httpsBaseDir = kj::str(\"../var/sandcats/https\");\n    if (access(httpsBaseDir.cStr(), F_OK) == 0) {\n      setOwnerGroupAndMode(httpsBaseDir, 0700, config.uids.uid, config.uids.gid);\n\n      kj::Array<kj::String> entries = listDirectory(kj::str(httpsBaseDir));\n      for (size_t i = 0; i < entries.size(); i++) {\n        setOwnerGroupAndMode(kj::str(httpsBaseDir, \"/\", entries[i]), 0700, config.uids.uid, config.uids.gid);\n      }\n    }\n\n    // var/sandcats/{register-log,id_rsa{,.pub,private_combined}} should each be 0640, with corrected\n    // owner/group\n    static const char* const files[] = {\"register-log\", \"id_rsa\", \"id_rsa.pub\", \"id_rsa.private_combined\"};\n    for (auto f : files) {\n      auto path = kj::str(\"../var/sandcats/\", f);\n      if (access(path.cStr(), F_OK) == 0) {\n        setOwnerGroupAndMode(path, 0640, config.uids.uid, config.uids.gid);\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fchmod(pidfile, 0660)"
          ],
          "line": 1799
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fchmod",
          "args": [
            "pidfile",
            "0660"
          ],
          "line": 1799
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fchown(pidfile, 0, config.uids.gid)"
          ],
          "line": 1798
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fchown",
          "args": [
            "pidfile",
            "0",
            "config.uids.gid"
          ],
          "line": 1798
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nunion sigval sigval;\nbool changedDir = false;\nbool runningAsRoot = getuid() == 0;\n\n[[noreturn]] void runUpdateMonitor(const Config& config, FdBundle& fdBundle, int pidfile) {\n    // Run the update monitor process.  This process runs two subprocesses:  the sandstorm server\n    // and the auto-updater.\n\n    if (runningAsRoot) {\n      // Fix permissions on pidfile. We do this here rather than back where we opened it because\n      // a previous version failed to do this and we want it fixed immediately on upgrade.\n      KJ_SYSCALL(fchown(pidfile, 0, config.uids.gid));\n      KJ_SYSCALL(fchmod(pidfile, 0660));\n\n      // Additionally, fix permissions on sandcats-related data, which was originally owned by root\n      fixSandcatsPermissions(config);\n\n      // Fix permissions on /var/sandstorm, which was originally owned by root:root.\n      KJ_SYSCALL(chown(\"../var/sandstorm\", 0, config.uids.gid));\n      KJ_SYSCALL(chmod(\"../var/sandstorm\", 0770));\n\n      // Fix permissions on /var/sandstorm/grains, which originally had mode 0730 because grain\n      // IDs were secret.\n      KJ_SYSCALL(chmod(\"../var/sandstorm/grains\", 0770));\n    }\n\n    cleanupOldVersions();\n\n    // Clean up the temp directory.\n    KJ_REQUIRE(changedDir);\n\n    static const char* const TMPDIRS[2] = { \"../tmp\", \"../var/sandstorm/tmp\" };\n    for (const char* tmpDir: TMPDIRS) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        if (access(tmpDir, F_OK) == 0) {\n          recursivelyDelete(tmpDir);\n        }\n        mkdir(tmpDir, 0770);\n        KJ_SYSCALL(chmod(tmpDir, 0770 | S_ISVTX));\n        if (runningAsRoot) {\n          KJ_SYSCALL(chown(tmpDir, 0, config.uids.gid));\n        }\n      })) {\n        KJ_LOG(WARNING, \"failed to clean up tmpdir; leaving it for now\", tmpDir, *exception);\n      }\n    }\n\n    auto sigfd = prepareMonitoringLoop();\n\n    pid_t updaterPid = startUpdater(config, fdBundle, false);\n\n    pid_t sandstormPid = fork();\n    if (sandstormPid == 0) {\n      runServerMonitor(config, fdBundle);\n      KJ_UNREACHABLE;\n    }\n\n    for (;;) {\n      // Wait for a signal -- any signal.\n      struct signalfd_siginfo siginfo;\n      KJ_SYSCALL(read(sigfd, &siginfo, sizeof(siginfo)));\n\n      if (siginfo.ssi_signo == SIGCHLD) {\n        // Some child exited.\n\n        // Reap zombies until there are no more.\n        bool updaterDied = false;\n        bool updaterSucceeded = false;\n        bool sandstormDied = false;\n        for (;;) {\n          int status;\n          pid_t deadPid = waitpid(-1, &status, WNOHANG);\n          if (deadPid <= 0) {\n            // No more zombies.\n            break;\n          } else if (deadPid == updaterPid) {\n            updaterDied = true;\n            updaterSucceeded = WIFEXITED(status) && WEXITSTATUS(status) == 0;\n          } else if (deadPid == sandstormPid) {\n            sandstormDied = true;\n          }\n        }\n\n        if (updaterSucceeded) {\n          context.warning(\"** Restarting to apply update\");\n          killChild(\"Server Monitor\", sandstormPid);\n          restartForUpdate(pidfile, fdBundle);\n          KJ_UNREACHABLE;\n        } else if (updaterDied) {\n          context.warning(\"** Updater died; restarting it\");\n          updaterPid = startUpdater(config, fdBundle, true);\n        } else if (sandstormDied) {\n          context.exitError(\"** Server monitor died. Aborting.\");\n          KJ_UNREACHABLE;\n        }\n      } else if (siginfo.ssi_signo == SIGINT) {\n        // Frontend startup or shutdown request, used with run-dev.\n\n        if (!siginfo.ssi_int) {\n          // We have to close all the listen ports otherwise run-dev won't be able to open them\n          // for itself. Note that we never re-open them here in the parent process, meaning that\n          // if you stop-fe and then start-fe and then do an update, you won't get a zero-downtime\n          // update. This only affects developers so whatever.\n          fdBundle.closeAll();\n        }\n\n        // Pass along to server monitor.\n        union sigval sigval;\n        memset(&sigval, 0, sizeof(sigval));\n        sigval.sival_int = siginfo.ssi_int;\n        KJ_SYSCALL(sigqueue(sandstormPid, SIGINT, sigval));\n      } else {\n        // Kill updater if it is running.\n        if (updaterPid != 0) {\n          KJ_SYSCALL(kill(updaterPid, SIGKILL));\n        }\n\n        // Shutdown server.\n        KJ_SYSCALL(kill(sandstormPid, SIGTERM));\n        int status;\n        KJ_SYSCALL(waitpid(sandstormPid, &status, 0));\n\n        // Handle signal.\n        if (siginfo.ssi_signo == SIGHUP) {\n          context.warning(\"** Restarting\");\n          restartForUpdate(pidfile, fdBundle);\n        } else {\n          // SIGTERM or something.\n          context.exitInfo(\"** Exiting\");\n        }\n        KJ_UNREACHABLE;\n      }\n    }\n  }"
  },
  {
    "function_name": "ensureMinFd",
    "container": "FdBundle",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1779-1788",
    "snippet": "kj::AutoCloseFd ensureMinFd(kj::AutoCloseFd fd) {\n      if (fd.get() < minFd) {\n        // Push the FD number beyond our minimum.\n        int fd_;\n        KJ_SYSCALL(fd_ = fcntl(fd, F_DUPFD_CLOEXEC, minFd));\n        fd = kj::AutoCloseFd(fd_);\n        KJ_ASSERT(fd.get() >= minFd);\n      }\n      return kj::mv(fd);\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "fd"
          ],
          "line": 1787
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "fd.get() >= minFd"
          ],
          "line": 1785
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fd.get",
          "args": [],
          "line": 1785
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::AutoCloseFd",
          "args": [
            "fd_"
          ],
          "line": 1784
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fd_ = fcntl(fd, F_DUPFD_CLOEXEC, minFd)"
          ],
          "line": 1783
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fcntl",
          "args": [
            "fd",
            "F_DUPFD_CLOEXEC",
            "minFd"
          ],
          "line": 1783
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fd.get",
          "args": [],
          "line": 1780
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  kj::AutoCloseFd ensureMinFd(kj::AutoCloseFd fd) {\n        if (fd.get() < minFd) {\n          // Push the FD number beyond our minimum.\n          int fd_;\n          KJ_SYSCALL(fd_ = fcntl(fd, F_DUPFD_CLOEXEC, minFd));\n          fd = kj::AutoCloseFd(fd_);\n          KJ_ASSERT(fd.get() >= minFd);\n        }\n        return kj::mv(fd);\n      }\n}"
  },
  {
    "function_name": "openPort",
    "container": "FdBundle",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1721-1777",
    "snippet": "void openPort(const Config& config, uint port, int targetFd,\n                  std::map<uint, kj::AutoCloseFd>& inherited) {\n      auto iter = inherited.find(port);\n      if (iter != inherited.end()) {\n        ports.insert(std::make_pair(port, FdInfo { ensureMinFd(kj::mv(iter->second)), targetFd }));\n        inherited.erase(iter);\n        return;\n      }\n\n      sockaddr_storage sa;\n      sockaddr_in* sa4 = reinterpret_cast<sockaddr_in*>(&sa);\n      sockaddr_in6* sa6 = reinterpret_cast<sockaddr_in6*>(&sa);\n\n      // Various syscalls require slightly different arguments for v4 and v6 addresses.\n      // Keep track of which we're trying.\n      bool useV6 = false;\n\n      memset(&sa, 0, sizeof sa);\n\n      sa.ss_family = AF_INET;\n      int rc = inet_pton(AF_INET, config.bindIp.cStr(), &(sa4->sin_addr));\n\n      if (rc == 0) {\n        // If IPv4 address parsing fails, try IPv6\n        useV6 = true;\n        sa.ss_family = AF_INET6;\n        rc = inet_pton(AF_INET6, config.bindIp.cStr(), &(sa6->sin6_addr));\n        KJ_REQUIRE(rc == 1, \"Bind IP is an invalid IP address:\", config.bindIp);\n      }\n\n      int sockFd_;\n\n      if (useV6) {\n        KJ_SYSCALL(sockFd_ = socket(\n            AF_INET6, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP));\n      } else {\n        KJ_SYSCALL(sockFd_ = socket(\n            AF_INET, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP));\n      }\n      kj::AutoCloseFd sockFd(sockFd_);\n\n      // Enable SO_REUSEADDR so that `sandstorm restart` doesn't take minutes to succeed.\n      int optval = 1;\n      KJ_SYSCALL(setsockopt(sockFd, SOL_SOCKET, SO_REUSEADDR, &optval, sizeof(optval)));\n\n      if (useV6) {\n        sa6->sin6_port = htons(port);\n        KJ_SYSCALL(bind(sockFd, reinterpret_cast<sockaddr *>(&sa), sizeof(sockaddr_in6)));\n      } else {\n        sa4->sin_port = htons(port);\n        KJ_SYSCALL(bind(sockFd, reinterpret_cast<sockaddr *>(&sa), sizeof(sockaddr_in)));\n      }\n\n      KJ_SYSCALL(listen(sockFd, SOMAXCONN));\n\n      ports.insert(std::make_pair(port, FdInfo { ensureMinFd(kj::mv(sockFd)), targetFd}));\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "ports.insert",
          "args": [
            "std::make_pair(port, FdInfo { ensureMinFd(kj::mv(sockFd)), targetFd})"
          ],
          "line": 1776
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "std::make_pair",
          "args": [
            "port",
            "FdInfo { ensureMinFd(kj::mv(sockFd)), targetFd}"
          ],
          "line": 1776
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ensureMinFd",
          "args": [
            "kj::mv(sockFd)"
          ],
          "line": 1776
        },
        "resolved": true,
        "details": {
          "function_name": "ensureMinFd",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1779-1788",
          "snippet": "kj::AutoCloseFd ensureMinFd(kj::AutoCloseFd fd) {\n      if (fd.get() < minFd) {\n        // Push the FD number beyond our minimum.\n        int fd_;\n        KJ_SYSCALL(fd_ = fcntl(fd, F_DUPFD_CLOEXEC, minFd));\n        fd = kj::AutoCloseFd(fd_);\n        KJ_ASSERT(fd.get() >= minFd);\n      }\n      return kj::mv(fd);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  kj::AutoCloseFd ensureMinFd(kj::AutoCloseFd fd) {\n        if (fd.get() < minFd) {\n          // Push the FD number beyond our minimum.\n          int fd_;\n          KJ_SYSCALL(fd_ = fcntl(fd, F_DUPFD_CLOEXEC, minFd));\n          fd = kj::AutoCloseFd(fd_);\n          KJ_ASSERT(fd.get() >= minFd);\n        }\n        return kj::mv(fd);\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "sockFd"
          ],
          "line": 1776
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "listen(sockFd, SOMAXCONN)"
          ],
          "line": 1774
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "listen",
          "args": [
            "sockFd",
            "SOMAXCONN"
          ],
          "line": 1774
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "bind(sockFd, reinterpret_cast<sockaddr *>(&sa), sizeof(sockaddr_in))"
          ],
          "line": 1771
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bind",
          "args": [
            "sockFd",
            "reinterpret_cast<sockaddr *>(&sa)",
            "sizeof(sockaddr_in)"
          ],
          "line": 1771
        },
        "resolved": true,
        "details": {
          "function_name": "bind",
          "container": "SupervisorMain",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/supervisor.c++",
          "lines": "708-716",
          "snippet": "void SupervisorMain::bind(kj::StringPtr src, kj::StringPtr dst, unsigned long flags) {\n  // Contrary to the documentation of MS_BIND claiming this is no longer the case after 2.6.26,\n  // mountflags are ignored on the initial bind.  We have to issue a subsequent remount to set\n  // them.\n  KJ_SYSCALL(mount(src.cStr(), dst.cStr(), nullptr, MS_BIND, nullptr), src, dst);\n  KJ_SYSCALL(mount(src.cStr(), dst.cStr(), nullptr,\n                   MS_BIND | MS_REMOUNT | MS_NOSUID | flags, nullptr),\n      src, dst);\n}",
          "includes": [
            "#include \"util.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <sandstorm/supervisor.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <seccomp.h>",
            "#include <sys/resource.h>",
            "#include <sys/eventfd.h>",
            "#include <linux/rtnetlink.h>",
            "#include <linux/netlink.h>",
            "#include <execinfo.h>",
            "#include <unordered_map>",
            "#include <map>",
            "#include <sys/inotify.h>",
            "#include <grp.h>",
            "#include <pwd.h>",
            "#include <dirent.h>",
            "#include <sched.h>",
            "#include <limits.h>",
            "#include <stdlib.h>",
            "#include <errno.h>",
            "#include <fcntl.h>",
            "#include <linux/netfilter/nf_nat.h>",
            "#include <sandstorm/ip_tables.h>  // created by Makefile from <linux/netfilter_ipv4/ip_tables.h>",
            "#include <linux/route.h>",
            "#include <linux/sockios.h>",
            "#include <sys/syscall.h>",
            "#include <sys/ptrace.h>",
            "#include <sys/capability.h>",
            "#include <sys/prctl.h>",
            "#include <sys/mount.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <sys/wait.h>",
            "#include <sys/time.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <netinet/in.h> // needs to be included before sys/capability.h",
            "#include <unistd.h>",
            "#include <capnp/rpc.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/io.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/async-io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>",
            "#include \"supervisor.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <sandstorm/supervisor.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <seccomp.h>\n#include <sys/resource.h>\n#include <sys/eventfd.h>\n#include <linux/rtnetlink.h>\n#include <linux/netlink.h>\n#include <execinfo.h>\n#include <unordered_map>\n#include <map>\n#include <sys/inotify.h>\n#include <grp.h>\n#include <pwd.h>\n#include <dirent.h>\n#include <sched.h>\n#include <limits.h>\n#include <stdlib.h>\n#include <errno.h>\n#include <fcntl.h>\n#include <linux/netfilter/nf_nat.h>\n#include <sandstorm/ip_tables.h>  // created by Makefile from <linux/netfilter_ipv4/ip_tables.h>\n#include <linux/route.h>\n#include <linux/sockios.h>\n#include <sys/syscall.h>\n#include <sys/ptrace.h>\n#include <sys/capability.h>\n#include <sys/prctl.h>\n#include <sys/mount.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <sys/wait.h>\n#include <sys/time.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <netinet/in.h> // needs to be included before sys/capability.h\n#include <unistd.h>\n#include <capnp/rpc.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/io.h>\n#include <kj/async-unix.h>\n#include <kj/async-io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n#include \"supervisor.h\"\n\nSupervisorMain {\n  void SupervisorMain::bind(kj::StringPtr src, kj::StringPtr dst, unsigned long flags) {\n    // Contrary to the documentation of MS_BIND claiming this is no longer the case after 2.6.26,\n    // mountflags are ignored on the initial bind.  We have to issue a subsequent remount to set\n    // them.\n    KJ_SYSCALL(mount(src.cStr(), dst.cStr(), nullptr, MS_BIND, nullptr), src, dst);\n    KJ_SYSCALL(mount(src.cStr(), dst.cStr(), nullptr,\n                     MS_BIND | MS_REMOUNT | MS_NOSUID | flags, nullptr),\n        src, dst);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "reinterpret_cast<sockaddr *>",
          "args": [
            "&sa"
          ],
          "line": 1771
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "htons",
          "args": [
            "port"
          ],
          "line": 1770
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "bind(sockFd, reinterpret_cast<sockaddr *>(&sa), sizeof(sockaddr_in6))"
          ],
          "line": 1768
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reinterpret_cast<sockaddr *>",
          "args": [
            "&sa"
          ],
          "line": 1768
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "htons",
          "args": [
            "port"
          ],
          "line": 1767
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setsockopt(sockFd, SOL_SOCKET, SO_REUSEADDR, &optval, sizeof(optval))"
          ],
          "line": 1764
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setsockopt",
          "args": [
            "sockFd",
            "SOL_SOCKET",
            "SO_REUSEADDR",
            "&optval",
            "sizeof(optval)"
          ],
          "line": 1764
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sockFd_ = socket(\n            AF_INET, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP)"
          ],
          "line": 1757
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "socket",
          "args": [
            "AF_INET",
            "SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC",
            "IPPROTO_TCP"
          ],
          "line": 1757
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sockFd_ = socket(\n            AF_INET6, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP)"
          ],
          "line": 1754
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "socket",
          "args": [
            "AF_INET6",
            "SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC",
            "IPPROTO_TCP"
          ],
          "line": 1754
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "rc == 1",
            "\"Bind IP is an invalid IP address:\"",
            "config.bindIp"
          ],
          "line": 1748
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "inet_pton",
          "args": [
            "AF_INET6",
            "config.bindIp.cStr()",
            "&(sa6->sin6_addr)"
          ],
          "line": 1747
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "config.bindIp.cStr",
          "args": [],
          "line": 1747
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "inet_pton",
          "args": [
            "AF_INET",
            "config.bindIp.cStr()",
            "&(sa4->sin_addr)"
          ],
          "line": 1741
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "config.bindIp.cStr",
          "args": [],
          "line": 1741
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&sa",
            "0",
            "sizeof sa"
          ],
          "line": 1738
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reinterpret_cast<sockaddr_in6*>",
          "args": [
            "&sa"
          ],
          "line": 1732
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reinterpret_cast<sockaddr_in*>",
          "args": [
            "&sa"
          ],
          "line": 1731
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "inherited.erase",
          "args": [
            "iter"
          ],
          "line": 1726
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ports.insert",
          "args": [
            "std::make_pair(port, FdInfo { ensureMinFd(kj::mv(iter->second)), targetFd })"
          ],
          "line": 1725
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "std::make_pair",
          "args": [
            "port",
            "FdInfo { ensureMinFd(kj::mv(iter->second)), targetFd }"
          ],
          "line": 1725
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "iter->second"
          ],
          "line": 1725
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "inherited.end",
          "args": [],
          "line": 1724
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "inherited.find",
          "args": [
            "port"
          ],
          "line": 1723
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void openPort(const Config& config, uint port, int targetFd,\n                    std::map<uint, kj::AutoCloseFd>& inherited) {\n        auto iter = inherited.find(port);\n        if (iter != inherited.end()) {\n          ports.insert(std::make_pair(port, FdInfo { ensureMinFd(kj::mv(iter->second)), targetFd }));\n          inherited.erase(iter);\n          return;\n        }\n  \n        sockaddr_storage sa;\n        sockaddr_in* sa4 = reinterpret_cast<sockaddr_in*>(&sa);\n        sockaddr_in6* sa6 = reinterpret_cast<sockaddr_in6*>(&sa);\n  \n        // Various syscalls require slightly different arguments for v4 and v6 addresses.\n        // Keep track of which we're trying.\n        bool useV6 = false;\n  \n        memset(&sa, 0, sizeof sa);\n  \n        sa.ss_family = AF_INET;\n        int rc = inet_pton(AF_INET, config.bindIp.cStr(), &(sa4->sin_addr));\n  \n        if (rc == 0) {\n          // If IPv4 address parsing fails, try IPv6\n          useV6 = true;\n          sa.ss_family = AF_INET6;\n          rc = inet_pton(AF_INET6, config.bindIp.cStr(), &(sa6->sin6_addr));\n          KJ_REQUIRE(rc == 1, \"Bind IP is an invalid IP address:\", config.bindIp);\n        }\n  \n        int sockFd_;\n  \n        if (useV6) {\n          KJ_SYSCALL(sockFd_ = socket(\n              AF_INET6, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP));\n        } else {\n          KJ_SYSCALL(sockFd_ = socket(\n              AF_INET, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP));\n        }\n        kj::AutoCloseFd sockFd(sockFd_);\n  \n        // Enable SO_REUSEADDR so that `sandstorm restart` doesn't take minutes to succeed.\n        int optval = 1;\n        KJ_SYSCALL(setsockopt(sockFd, SOL_SOCKET, SO_REUSEADDR, &optval, sizeof(optval)));\n  \n        if (useV6) {\n          sa6->sin6_port = htons(port);\n          KJ_SYSCALL(bind(sockFd, reinterpret_cast<sockaddr *>(&sa), sizeof(sockaddr_in6)));\n        } else {\n          sa4->sin_port = htons(port);\n          KJ_SYSCALL(bind(sockFd, reinterpret_cast<sockaddr *>(&sa), sizeof(sockaddr_in)));\n        }\n  \n        KJ_SYSCALL(listen(sockFd, SOMAXCONN));\n  \n        ports.insert(std::make_pair(port, FdInfo { ensureMinFd(kj::mv(sockFd)), targetFd}));\n      }\n}"
  },
  {
    "function_name": "prepareInheritedFds",
    "container": "FdBundle",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1706-1710",
    "snippet": "void prepareInheritedFds() {\n      for (auto& port: ports) {\n        KJ_SYSCALL(dup2(port.second.fd, port.second.targetFd));\n      }\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(port.second.fd, port.second.targetFd)"
          ],
          "line": 1708
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "port.second.fd",
            "port.second.targetFd"
          ],
          "line": 1708
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void prepareInheritedFds() {\n        for (auto& port: ports) {\n          KJ_SYSCALL(dup2(port.second.fd, port.second.targetFd));\n        }\n      }\n}"
  },
  {
    "function_name": "prepareForContinue",
    "container": "FdBundle",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1697-1704",
    "snippet": "kj::Array<kj::String> prepareForContinue() {\n      auto args = kj::heapArrayBuilder<kj::String>(ports.size());\n      for (auto& port: ports) {\n        args.add(kj::str(port.second.fd.get(), \":tcp:\", port.first));\n        KJ_SYSCALL(ioctl(port.second.fd, FIONCLEX));\n      }\n      return args.finish();\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "args.finish",
          "args": [],
          "line": 1703
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "ioctl(port.second.fd, FIONCLEX)"
          ],
          "line": 1701
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ioctl",
          "args": [
            "port.second.fd",
            "FIONCLEX"
          ],
          "line": 1701
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "args.add",
          "args": [
            "kj::str(port.second.fd.get(), \":tcp:\", port.first)"
          ],
          "line": 1700
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "port.second.fd.get()",
            "\":tcp:\"",
            "port.first"
          ],
          "line": 1700
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "port.second.fd.get",
          "args": [],
          "line": 1700
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapArrayBuilder<kj::String>",
          "args": [
            "ports.size()"
          ],
          "line": 1698
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ports.size",
          "args": [],
          "line": 1698
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  kj::Array<kj::String> prepareForContinue() {\n        auto args = kj::heapArrayBuilder<kj::String>(ports.size());\n        for (auto& port: ports) {\n          args.add(kj::str(port.second.fd.get(), \":tcp:\", port.first));\n          KJ_SYSCALL(ioctl(port.second.fd, FIONCLEX));\n        }\n        return args.finish();\n      }\n}"
  },
  {
    "function_name": "closeAll",
    "container": "FdBundle",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1693-1695",
    "snippet": "void closeAll() {\n      ports.clear();\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "ports.clear",
          "args": [],
          "line": 1694
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void closeAll() {\n        ports.clear();\n      }\n}"
  },
  {
    "function_name": "FdBundle",
    "container": "FdBundle",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1691-1691",
    "snippet": "FdBundle(decltype(nullptr)): minFd(0) {}",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  FdBundle(decltype(nullptr)): minFd(0) {}\n}"
  },
  {
    "function_name": "FdBundle",
    "container": "FdBundle",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1679-1689",
    "snippet": "FdBundle(const Config& config,\n             std::map<uint, kj::AutoCloseFd> inherited = std::map<uint, kj::AutoCloseFd>())\n        // STDERR + 1 (fd after STDERR) + HTTP ports + SMTP port\n        : minFd(STDERR_FILENO + 1 + config.ports.size() + 1) {\n      int targetFd = STDERR_FILENO + 1;\n      openPort(config, config.smtpListenPort, targetFd++, inherited);\n      for (auto& port: config.ports) {\n        openPort(config, port, targetFd++, inherited);\n      }\n      KJ_ASSERT(minFd == targetFd);\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "minFd == targetFd"
          ],
          "line": 1688
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "openPort",
          "args": [
            "config",
            "port",
            "targetFd++",
            "inherited"
          ],
          "line": 1686
        },
        "resolved": true,
        "details": {
          "function_name": "openPort",
          "container": "FdBundle",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1721-1777",
          "snippet": "void openPort(const Config& config, uint port, int targetFd,\n                  std::map<uint, kj::AutoCloseFd>& inherited) {\n      auto iter = inherited.find(port);\n      if (iter != inherited.end()) {\n        ports.insert(std::make_pair(port, FdInfo { ensureMinFd(kj::mv(iter->second)), targetFd }));\n        inherited.erase(iter);\n        return;\n      }\n\n      sockaddr_storage sa;\n      sockaddr_in* sa4 = reinterpret_cast<sockaddr_in*>(&sa);\n      sockaddr_in6* sa6 = reinterpret_cast<sockaddr_in6*>(&sa);\n\n      // Various syscalls require slightly different arguments for v4 and v6 addresses.\n      // Keep track of which we're trying.\n      bool useV6 = false;\n\n      memset(&sa, 0, sizeof sa);\n\n      sa.ss_family = AF_INET;\n      int rc = inet_pton(AF_INET, config.bindIp.cStr(), &(sa4->sin_addr));\n\n      if (rc == 0) {\n        // If IPv4 address parsing fails, try IPv6\n        useV6 = true;\n        sa.ss_family = AF_INET6;\n        rc = inet_pton(AF_INET6, config.bindIp.cStr(), &(sa6->sin6_addr));\n        KJ_REQUIRE(rc == 1, \"Bind IP is an invalid IP address:\", config.bindIp);\n      }\n\n      int sockFd_;\n\n      if (useV6) {\n        KJ_SYSCALL(sockFd_ = socket(\n            AF_INET6, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP));\n      } else {\n        KJ_SYSCALL(sockFd_ = socket(\n            AF_INET, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP));\n      }\n      kj::AutoCloseFd sockFd(sockFd_);\n\n      // Enable SO_REUSEADDR so that `sandstorm restart` doesn't take minutes to succeed.\n      int optval = 1;\n      KJ_SYSCALL(setsockopt(sockFd, SOL_SOCKET, SO_REUSEADDR, &optval, sizeof(optval)));\n\n      if (useV6) {\n        sa6->sin6_port = htons(port);\n        KJ_SYSCALL(bind(sockFd, reinterpret_cast<sockaddr *>(&sa), sizeof(sockaddr_in6)));\n      } else {\n        sa4->sin_port = htons(port);\n        KJ_SYSCALL(bind(sockFd, reinterpret_cast<sockaddr *>(&sa), sizeof(sockaddr_in)));\n      }\n\n      KJ_SYSCALL(listen(sockFd, SOMAXCONN));\n\n      ports.insert(std::make_pair(port, FdInfo { ensureMinFd(kj::mv(sockFd)), targetFd}));\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  void openPort(const Config& config, uint port, int targetFd,\n                    std::map<uint, kj::AutoCloseFd>& inherited) {\n        auto iter = inherited.find(port);\n        if (iter != inherited.end()) {\n          ports.insert(std::make_pair(port, FdInfo { ensureMinFd(kj::mv(iter->second)), targetFd }));\n          inherited.erase(iter);\n          return;\n        }\n  \n        sockaddr_storage sa;\n        sockaddr_in* sa4 = reinterpret_cast<sockaddr_in*>(&sa);\n        sockaddr_in6* sa6 = reinterpret_cast<sockaddr_in6*>(&sa);\n  \n        // Various syscalls require slightly different arguments for v4 and v6 addresses.\n        // Keep track of which we're trying.\n        bool useV6 = false;\n  \n        memset(&sa, 0, sizeof sa);\n  \n        sa.ss_family = AF_INET;\n        int rc = inet_pton(AF_INET, config.bindIp.cStr(), &(sa4->sin_addr));\n  \n        if (rc == 0) {\n          // If IPv4 address parsing fails, try IPv6\n          useV6 = true;\n          sa.ss_family = AF_INET6;\n          rc = inet_pton(AF_INET6, config.bindIp.cStr(), &(sa6->sin6_addr));\n          KJ_REQUIRE(rc == 1, \"Bind IP is an invalid IP address:\", config.bindIp);\n        }\n  \n        int sockFd_;\n  \n        if (useV6) {\n          KJ_SYSCALL(sockFd_ = socket(\n              AF_INET6, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP));\n        } else {\n          KJ_SYSCALL(sockFd_ = socket(\n              AF_INET, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP));\n        }\n        kj::AutoCloseFd sockFd(sockFd_);\n  \n        // Enable SO_REUSEADDR so that `sandstorm restart` doesn't take minutes to succeed.\n        int optval = 1;\n        KJ_SYSCALL(setsockopt(sockFd, SOL_SOCKET, SO_REUSEADDR, &optval, sizeof(optval)));\n  \n        if (useV6) {\n          sa6->sin6_port = htons(port);\n          KJ_SYSCALL(bind(sockFd, reinterpret_cast<sockaddr *>(&sa), sizeof(sockaddr_in6)));\n        } else {\n          sa4->sin_port = htons(port);\n          KJ_SYSCALL(bind(sockFd, reinterpret_cast<sockaddr *>(&sa), sizeof(sockaddr_in)));\n        }\n  \n        KJ_SYSCALL(listen(sockFd, SOMAXCONN));\n  \n        ports.insert(std::make_pair(port, FdInfo { ensureMinFd(kj::mv(sockFd)), targetFd}));\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "config.ports.size",
          "args": [],
          "line": 1682
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "std::map<uint, kj::AutoCloseFd>",
          "args": [],
          "line": 1680
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nFdBundle {\n  FdBundle(const Config& config,\n               std::map<uint, kj::AutoCloseFd> inherited = std::map<uint, kj::AutoCloseFd>())\n          // STDERR + 1 (fd after STDERR) + HTTP ports + SMTP port\n          : minFd(STDERR_FILENO + 1 + config.ports.size() + 1) {\n        int targetFd = STDERR_FILENO + 1;\n        openPort(config, config.smtpListenPort, targetFd++, inherited);\n        for (auto& port: config.ports) {\n          openPort(config, port, targetFd++, inherited);\n        }\n        KJ_ASSERT(minFd == targetFd);\n      }\n}"
  },
  {
    "function_name": "KJ_IF_MAYBE",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1662-1665",
    "snippet": "KJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "ports"
          ],
          "line": 1664
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "parsePorts",
          "args": [
            "config.httpsPort",
            "*portValue"
          ],
          "line": 1663
        },
        "resolved": true,
        "details": {
          "function_name": "parsePorts",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "277-291",
          "snippet": "kj::Array<uint> parsePorts(kj::Maybe<uint> httpsPort, kj::StringPtr portList) {\n  auto portsSplitOnComma = split(portList, ',');\n  size_t numHttpPorts = portsSplitOnComma.size();\n  size_t numHttpsPorts;\n  kj::Array<uint> result;\n\n  // If the configuration has a https port, then add it first.\n  KJ_IF_MAYBE(portNumber, httpsPort) {\n    numHttpsPorts = 1;\n    result = kj::heapArray<uint>(numHttpsPorts + numHttpPorts);\n    result[0] = *portNumber;\n  } else {\n    numHttpsPorts = 0;\n    result = kj::heapArray<uint>(numHttpsPorts + numHttpPorts);\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::Array<uint> parsePorts(kj::Maybe<uint> httpsPort, kj::StringPtr portList) {\n  auto portsSplitOnComma = split(portList, ',');\n  size_t numHttpPorts = portsSplitOnComma.size();\n  size_t numHttpsPorts;\n  kj::Array<uint> result;\n\n  // If the configuration has a https port, then add it first.\n  KJ_IF_MAYBE(portNumber, httpsPort) {\n    numHttpsPorts = 1;\n    result = kj::heapArray<uint>(numHttpsPorts + numHttpPorts);\n    result[0] = *portNumber;\n  } else {\n    numHttpsPorts = 0;\n    result = kj::heapArray<uint>(numHttpsPorts + numHttpPorts);\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }"
  },
  {
    "function_name": "readConfig",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1561-1597",
    "snippet": "Config readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool changedDir = false;",
      "else if (key == \"PORT\")",
      "else if (key == \"MONGO_PORT\")",
      "else if (key == \"BIND_IP\")",
      "else if (key == \"BASE_URL\")",
      "else if (key == \"WILDCARD_HOST\")",
      "else if (key == \"WILDCARD_PARENT_URL\")",
      "else if (key == \"DDP_DEFAULT_CONNECTION_URL\")",
      "else if (key == \"MAIL_URL\")",
      "else if (key == \"UPDATE_CHANNEL\")",
      "else if (key == \"SANDCATS_BASE_DOMAIN\")",
      "else if (key == \"ALLOW_DEMO_ACCOUNTS\")",
      "else if (key == \"ALLOW_DEV_ACCOUNTS\")",
      "else if (key == \"IS_TESTING\")",
      "else if (key == \"HIDE_TROUBLESHOOTING\")",
      "else if (key == \"SMTP_LISTEN_PORT\")"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_FAIL_REQUIRE",
          "args": [
            "\"invalid config value HTTPS_PORT\"",
            "value"
          ],
          "line": 1595
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "p",
            "parseUInt(value, 10)"
          ],
          "line": 1592
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1662-1665",
          "snippet": "KJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }"
        }
      },
      {
        "call_info": {
          "callee": "parseUInt",
          "args": [
            "value",
            "10"
          ],
          "line": 1592
        },
        "resolved": true,
        "details": {
          "function_name": "parseUInt64",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "223-230",
          "snippet": "kj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_REQUIRE",
          "args": [
            "\"invalid config value SERVER_USER\"",
            "value"
          ],
          "line": 1589
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "config.uids.uid != 0",
            "\"Sandstorm cannot run as root.\""
          ],
          "line": 1587
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "*u"
          ],
          "line": 1586
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "trim",
          "args": [
            "line.slice(equalsPos + 1)"
          ],
          "line": 1582
        },
        "resolved": true,
        "details": {
          "function_name": "trim",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "202-204",
          "snippet": "kj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}"
        }
      },
      {
        "call_info": {
          "callee": "line.slice",
          "args": [
            "equalsPos + 1"
          ],
          "line": 1582
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "line.slice",
          "args": [
            "0",
            "equalsPos"
          ],
          "line": 1581
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT_NONNULL",
          "args": [
            "line.findFirst('=')",
            "\"Invalid config line\"",
            "line"
          ],
          "line": 1580
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "line.findFirst",
          "args": [
            "'='"
          ],
          "line": 1580
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "splitLines",
          "args": [
            "readAll(\"../sandstorm.conf\")"
          ],
          "line": 1578
        },
        "resolved": true,
        "details": {
          "function_name": "splitLines",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "387-414",
          "snippet": "kj::Array<kj::String> splitLines(kj::StringPtr input) {\n  size_t lineStart = 0;\n  kj::Vector<kj::String> results;\n  for (size_t i = 0; i < input.size(); i++) {\n    if (input[i] == '\\n' || input[i] == '#') {\n      bool hasComment = input[i] == '#';\n      auto line = trim(input.slice(lineStart, i));\n      if (line.size() > 0) {\n        results.add(kj::mv(line));\n      }\n      if (hasComment) {\n        // Ignore through newline.\n        ++i;\n        while (i < input.size() && input[i] != '\\n') ++i;\n      }\n      lineStart = i + 1;\n    }\n  }\n\n  if (lineStart < input.size()) {\n    auto lastLine = trim(input.slice(lineStart));\n    if (lastLine.size() > 0) {\n      results.add(kj::mv(lastLine));\n    }\n  }\n\n  return results.releaseAsArray();\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Array<kj::String> splitLines(kj::StringPtr input) {\n  size_t lineStart = 0;\n  kj::Vector<kj::String> results;\n  for (size_t i = 0; i < input.size(); i++) {\n    if (input[i] == '\\n' || input[i] == '#') {\n      bool hasComment = input[i] == '#';\n      auto line = trim(input.slice(lineStart, i));\n      if (line.size() > 0) {\n        results.add(kj::mv(line));\n      }\n      if (hasComment) {\n        // Ignore through newline.\n        ++i;\n        while (i < input.size() && input[i] != '\\n') ++i;\n      }\n      lineStart = i + 1;\n    }\n  }\n\n  if (lineStart < input.size()) {\n    auto lastLine = trim(input.slice(lineStart));\n    if (lastLine.size() > 0) {\n      results.add(kj::mv(lastLine));\n    }\n  }\n\n  return results.releaseAsArray();\n}"
        }
      },
      {
        "call_info": {
          "callee": "readAll",
          "args": [
            "\"../sandstorm.conf\""
          ],
          "line": 1578
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      },
      {
        "call_info": {
          "callee": "getgid",
          "args": [],
          "line": 1572
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getuid",
          "args": [],
          "line": 1571
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "changedDir"
          ],
          "line": 1567
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\nelse if (key == \"PORT\");\nelse if (key == \"MONGO_PORT\");\nelse if (key == \"BIND_IP\");\nelse if (key == \"BASE_URL\");\nelse if (key == \"WILDCARD_HOST\");\nelse if (key == \"WILDCARD_PARENT_URL\");\nelse if (key == \"DDP_DEFAULT_CONNECTION_URL\");\nelse if (key == \"MAIL_URL\");\nelse if (key == \"UPDATE_CHANNEL\");\nelse if (key == \"SANDCATS_BASE_DOMAIN\");\nelse if (key == \"ALLOW_DEMO_ACCOUNTS\");\nelse if (key == \"ALLOW_DEV_ACCOUNTS\");\nelse if (key == \"IS_TESTING\");\nelse if (key == \"HIDE_TROUBLESHOOTING\");\nelse if (key == \"SMTP_LISTEN_PORT\");\n\nConfig readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }"
  },
  {
    "function_name": "restoreResolvConfIfNeeded",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1542-1559",
    "snippet": "void restoreResolvConfIfNeeded() {\n    struct stat stats;\n    if (stat(\"/etc/resolv.conf\", &stats) < 0) {\n      auto error = errno;\n      if (error == ENOENT) {\n        if (access(\"/etc/resolv.conf.host-initial\", R_OK) == 0) {\n          context.warning(\"WARNING: /etc/resolv.conf is unreachable from container, \"\n                          \"using backup from host\");\n          KJ_SYSCALL(rename(\"/etc/resolv.conf.host-initial\", \"/etc/resolv.conf\"));\n        } else {\n          context.warning(\"WARNING: Wanted to fall back to /etc/resolv.conf.host-initial, \"\n                          \"but it is unavailable.  Carrying on without DNS.\");\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"stat('/etc/resolv.conf')\", error);\n      }\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"stat('/etc/resolv.conf')\"",
            "error"
          ],
          "line": 1556
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"WARNING: Wanted to fall back to /etc/resolv.conf.host-initial, \"\n                          \"but it is unavailable.  Carrying on without DNS.\""
          ],
          "line": 1552
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "rename(\"/etc/resolv.conf.host-initial\", \"/etc/resolv.conf\")"
          ],
          "line": 1550
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rename",
          "args": [
            "\"/etc/resolv.conf.host-initial\"",
            "\"/etc/resolv.conf\""
          ],
          "line": 1550
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"WARNING: /etc/resolv.conf is unreachable from container, \"\n                          \"using backup from host\""
          ],
          "line": 1548
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"/etc/resolv.conf.host-initial\"",
            "R_OK"
          ],
          "line": 1547
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stat",
          "args": [
            "\"/etc/resolv.conf\"",
            "&stats"
          ],
          "line": 1544
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid restoreResolvConfIfNeeded() {\n    struct stat stats;\n    if (stat(\"/etc/resolv.conf\", &stats) < 0) {\n      auto error = errno;\n      if (error == ENOENT) {\n        if (access(\"/etc/resolv.conf.host-initial\", R_OK) == 0) {\n          context.warning(\"WARNING: /etc/resolv.conf is unreachable from container, \"\n                          \"using backup from host\");\n          KJ_SYSCALL(rename(\"/etc/resolv.conf.host-initial\", \"/etc/resolv.conf\"));\n        } else {\n          context.warning(\"WARNING: Wanted to fall back to /etc/resolv.conf.host-initial, \"\n                          \"but it is unavailable.  Carrying on without DNS.\");\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"stat('/etc/resolv.conf')\", error);\n      }\n    }\n  }"
  },
  {
    "function_name": "backupResolvConf",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1529-1540",
    "snippet": "void backupResolvConf() {\n    if (access(\"/etc/resolv.conf\", R_OK) == 0) {\n      auto in = raiiOpen(\"/etc/resolv.conf\", O_RDONLY);\n      auto out = raiiOpen(\"./etc/resolv.conf.host-initial\", O_WRONLY | O_CREAT | O_EXCL);\n      ssize_t n;\n      do {\n        KJ_SYSCALL(n = sendfile(out, in, nullptr, 1 << 20));\n      } while (n > 0);\n    } else {\n      context.warning(\"WARNING: Couldn't read host's /etc/resolv.conf, DNS may be broken\");\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"WARNING: Couldn't read host's /etc/resolv.conf, DNS may be broken\""
          ],
          "line": 1538
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "n = sendfile(out, in, nullptr, 1 << 20)"
          ],
          "line": 1535
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sendfile",
          "args": [
            "out",
            "in",
            "nullptr",
            "1 << 20"
          ],
          "line": 1535
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"./etc/resolv.conf.host-initial\"",
            "O_WRONLY | O_CREAT | O_EXCL"
          ],
          "line": 1532
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"/etc/resolv.conf\"",
            "O_RDONLY"
          ],
          "line": 1531
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"/etc/resolv.conf\"",
            "R_OK"
          ],
          "line": 1530
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid backupResolvConf() {\n    if (access(\"/etc/resolv.conf\", R_OK) == 0) {\n      auto in = raiiOpen(\"/etc/resolv.conf\", O_RDONLY);\n      auto out = raiiOpen(\"./etc/resolv.conf.host-initial\", O_WRONLY | O_CREAT | O_EXCL);\n      ssize_t n;\n      do {\n        KJ_SYSCALL(n = sendfile(out, in, nullptr, 1 << 20));\n      } while (n > 0);\n    } else {\n      context.warning(\"WARNING: Couldn't read host's /etc/resolv.conf, DNS may be broken\");\n    }\n  }"
  },
  {
    "function_name": "linkHostFiles",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1505-1527",
    "snippet": "void linkHostFiles() {\n    // We will create a symlink for the first child of /etc or /run named in each line of host.list to\n    // symlink that file or folder from the host into the /etc or /run tmpfs.\n    auto files = splitLines(readAll(\"host.list\"));\n\n    // Now copy over each file.\n    for (auto& file: files) {\n      auto pathElements = split(file, '/');\n      KJ_REQUIRE(pathElements.size() >= 3, \"invalid path\", file);\n      KJ_REQUIRE(pathElements[0].size() == 0,\"relative path given in host.list\", file);\n      auto firstDir = kj::str(pathElements[1]);\n      KJ_REQUIRE(firstDir == \"etc\" || firstDir == \"run\", \"host.list asked to symlink in file outside of /etc/ or /run/\", file);\n      auto child = pathElements[2];\n      auto linkTargetAsSeenByLink = kj::str(\"../\", firstDir, \".host/\", child);\n      auto linkToCreate = kj::str(\"./\", firstDir, \"/\", child);\n\n      // Only attempt to create the symlink if we haven't created it already.\n      struct stat stats;\n      if (lstat(linkToCreate.cStr(), &stats) < 0 && errno == ENOENT) {\n        KJ_SYSCALL(symlink(linkTargetAsSeenByLink.cStr(), linkToCreate.cStr()));\n      }\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "symlink(linkTargetAsSeenByLink.cStr(), linkToCreate.cStr())"
          ],
          "line": 1524
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "symlink",
          "args": [
            "linkTargetAsSeenByLink.cStr()",
            "linkToCreate.cStr()"
          ],
          "line": 1524
        },
        "resolved": true,
        "details": {
          "function_name": "symlinkPointsInto",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "101-124",
          "snippet": "static bool symlinkPointsInto(kj::StringPtr symlink, kj::StringPtr targetPrefix) {\n  // Returns true if the given path names a symlink whose target has the given prefix, false if\n  // it points elsewhere or doesn't exist or isn't a symlink.\nretry:\n  char buffer[PATH_MAX];\n  ssize_t n = readlink(symlink.cStr(), buffer, sizeof(buffer) - 1);\n  if (n < 0) {\n    int error = errno;\n    switch (error) {\n      case ENOENT:\n      case ENOTDIR:\n      case EINVAL:\n        // File (or parent directory) dosen't exist or isn't a symlink.\n        return false;\n      case EINTR:\n        goto retry;\n      default:\n        KJ_FAIL_SYSCALL(\"readlink(symlink)\", error, symlink);\n    }\n  } else {\n    buffer[n] = '\\0';\n    return kj::StringPtr(buffer, n).startsWith(targetPrefix);\n  }\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nstatic bool symlinkPointsInto(kj::StringPtr symlink, kj::StringPtr targetPrefix) {\n  // Returns true if the given path names a symlink whose target has the given prefix, false if\n  // it points elsewhere or doesn't exist or isn't a symlink.\nretry:\n  char buffer[PATH_MAX];\n  ssize_t n = readlink(symlink.cStr(), buffer, sizeof(buffer) - 1);\n  if (n < 0) {\n    int error = errno;\n    switch (error) {\n      case ENOENT:\n      case ENOTDIR:\n      case EINVAL:\n        // File (or parent directory) dosen't exist or isn't a symlink.\n        return false;\n      case EINTR:\n        goto retry;\n      default:\n        KJ_FAIL_SYSCALL(\"readlink(symlink)\", error, symlink);\n    }\n  } else {\n    buffer[n] = '\\0';\n    return kj::StringPtr(buffer, n).startsWith(targetPrefix);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "linkToCreate.cStr",
          "args": [],
          "line": 1524
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "linkTargetAsSeenByLink.cStr",
          "args": [],
          "line": 1524
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "lstat",
          "args": [
            "linkToCreate.cStr()",
            "&stats"
          ],
          "line": 1523
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "linkToCreate.cStr",
          "args": [],
          "line": 1523
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"./\"",
            "firstDir",
            "\"/\"",
            "child"
          ],
          "line": 1519
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"../\"",
            "firstDir",
            "\".host/\"",
            "child"
          ],
          "line": 1518
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "firstDir == \"etc\" || firstDir == \"run\"",
            "\"host.list asked to symlink in file outside of /etc/ or /run/\"",
            "file"
          ],
          "line": 1516
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "pathElements[1]"
          ],
          "line": 1515
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "pathElements[0].size() == 0",
            "\"relative path given in host.list\"",
            "file"
          ],
          "line": 1514
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pathElements[0].size",
          "args": [],
          "line": 1514
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "pathElements.size() >= 3",
            "\"invalid path\"",
            "file"
          ],
          "line": 1513
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "split",
          "args": [
            "file",
            "'/'"
          ],
          "line": 1512
        },
        "resolved": true,
        "details": {
          "function_name": "splitFirst",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "448-457",
          "snippet": "kj::Maybe<kj::ArrayPtr<const char>> splitFirst(kj::ArrayPtr<const char>& input, char delim) {\n  for (size_t i: kj::indices(input)) {\n    if (input[i] == delim) {\n      auto result = input.slice(0, i);\n      input = input.slice(i + 1, input.size());\n      return result;\n    }\n  }\n  return nullptr;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<kj::ArrayPtr<const char>> splitFirst(kj::ArrayPtr<const char>& input, char delim) {\n  for (size_t i: kj::indices(input)) {\n    if (input[i] == delim) {\n      auto result = input.slice(0, i);\n      input = input.slice(i + 1, input.size());\n      return result;\n    }\n  }\n  return nullptr;\n}"
        }
      },
      {
        "call_info": {
          "callee": "splitLines",
          "args": [
            "readAll(\"host.list\")"
          ],
          "line": 1508
        },
        "resolved": true,
        "details": {
          "function_name": "splitLines",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "387-414",
          "snippet": "kj::Array<kj::String> splitLines(kj::StringPtr input) {\n  size_t lineStart = 0;\n  kj::Vector<kj::String> results;\n  for (size_t i = 0; i < input.size(); i++) {\n    if (input[i] == '\\n' || input[i] == '#') {\n      bool hasComment = input[i] == '#';\n      auto line = trim(input.slice(lineStart, i));\n      if (line.size() > 0) {\n        results.add(kj::mv(line));\n      }\n      if (hasComment) {\n        // Ignore through newline.\n        ++i;\n        while (i < input.size() && input[i] != '\\n') ++i;\n      }\n      lineStart = i + 1;\n    }\n  }\n\n  if (lineStart < input.size()) {\n    auto lastLine = trim(input.slice(lineStart));\n    if (lastLine.size() > 0) {\n      results.add(kj::mv(lastLine));\n    }\n  }\n\n  return results.releaseAsArray();\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Array<kj::String> splitLines(kj::StringPtr input) {\n  size_t lineStart = 0;\n  kj::Vector<kj::String> results;\n  for (size_t i = 0; i < input.size(); i++) {\n    if (input[i] == '\\n' || input[i] == '#') {\n      bool hasComment = input[i] == '#';\n      auto line = trim(input.slice(lineStart, i));\n      if (line.size() > 0) {\n        results.add(kj::mv(line));\n      }\n      if (hasComment) {\n        // Ignore through newline.\n        ++i;\n        while (i < input.size() && input[i] != '\\n') ++i;\n      }\n      lineStart = i + 1;\n    }\n  }\n\n  if (lineStart < input.size()) {\n    auto lastLine = trim(input.slice(lineStart));\n    if (lastLine.size() > 0) {\n      results.add(kj::mv(lastLine));\n    }\n  }\n\n  return results.releaseAsArray();\n}"
        }
      },
      {
        "call_info": {
          "callee": "readAll",
          "args": [
            "\"host.list\""
          ],
          "line": 1508
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid linkHostFiles() {\n    // We will create a symlink for the first child of /etc or /run named in each line of host.list to\n    // symlink that file or folder from the host into the /etc or /run tmpfs.\n    auto files = splitLines(readAll(\"host.list\"));\n\n    // Now copy over each file.\n    for (auto& file: files) {\n      auto pathElements = split(file, '/');\n      KJ_REQUIRE(pathElements.size() >= 3, \"invalid path\", file);\n      KJ_REQUIRE(pathElements[0].size() == 0,\"relative path given in host.list\", file);\n      auto firstDir = kj::str(pathElements[1]);\n      KJ_REQUIRE(firstDir == \"etc\" || firstDir == \"run\", \"host.list asked to symlink in file outside of /etc/ or /run/\", file);\n      auto child = pathElements[2];\n      auto linkTargetAsSeenByLink = kj::str(\"../\", firstDir, \".host/\", child);\n      auto linkToCreate = kj::str(\"./\", firstDir, \"/\", child);\n\n      // Only attempt to create the symlink if we haven't created it already.\n      struct stat stats;\n      if (lstat(linkToCreate.cStr(), &stats) < 0 && errno == ENOENT) {\n        KJ_SYSCALL(symlink(linkTargetAsSeenByLink.cStr(), linkToCreate.cStr()));\n      }\n    }\n  }"
  },
  {
    "function_name": "clearSignalMask",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1499-1503",
    "snippet": "void clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigprocmask(SIG_SETMASK, &sigset, nullptr)"
          ],
          "line": 1502
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sigprocmask",
          "args": [
            "SIG_SETMASK",
            "&sigset",
            "nullptr"
          ],
          "line": 1502
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigemptyset(&sigset)"
          ],
          "line": 1501
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sigemptyset",
          "args": [
            "&sigset"
          ],
          "line": 1501
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }"
  },
  {
    "function_name": "dropPrivs",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1451-1497",
    "snippet": "void dropPrivs(const UserIds& uids, bool keepRealUid = false) {\n    // Defense in depth: Don't give my children any new caps for any reason.\n    KJ_SYSCALL(prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0));\n\n    if (runningAsRoot) {\n      KJ_SYSCALL(setresgid(uids.gid, uids.gid, uids.gid));\n      KJ_SYSCALL(setgroups(uids.groups.size(), uids.groups.begin()));\n\n      if (keepRealUid) {\n        // We're prepping to run the backend and user namespaces are not available, therefore the\n        // backend needs to keep its superuser powers stashed in order to hand them off to the\n        // grain supervisors so that they can set up sandboxes. Instead of creating a suid binary\n        // (with all the danger that entails), we merely drop the effective UID, but raise it again\n        // when invoking the supervisor.\n        KJ_SYSCALL(seteuid(uids.uid));\n      } else {\n        KJ_SYSCALL(setresuid(uids.uid, uids.uid, uids.uid));\n      }\n    } else {\n      // We're using UID namespaces.\n\n      KJ_ASSERT(!keepRealUid);\n\n      // Defense in depth: Drop all capabilities from the set of caps which my children are allowed\n      //   to ever have.\n      for (uint cap: kj::range(0, CAP_LAST_CAP + 1)) {\n        // TODO(soon): I spontaneously started getting EINVAL here, but only in production, so I\n        //   had to remove the error check. Figure out what happened and re-enable it. Maybe it\n        //   makes sense to read the bset first and then only drop the caps in it?\n        prctl(PR_CAPBSET_DROP, cap, 0, 0, 0);\n      }\n\n      // Defense in depth: Don't grant my children capabilities just because they have UID 0.\n      KJ_SYSCALL(prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED));\n\n      // Drop all Linux \"capabilities\".  (These are Linux/POSIX \"capabilities\", which are not true\n      // object-capabilities, hence the quotes.)\n      struct __user_cap_header_struct hdr;\n      struct __user_cap_data_struct data[2];\n      hdr.version = _LINUX_CAPABILITY_VERSION_3;\n      hdr.pid = 0;\n      memset(data, 0, sizeof(data));  // All capabilities disabled!\n      KJ_SYSCALL(capset(&hdr, data));\n    }\n\n    umask(0007);\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;",
      "bool runningAsRoot = getuid() == 0;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "umask",
          "args": [
            "0007"
          ],
          "line": 1496
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "capset(&hdr, data)"
          ],
          "line": 1493
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capset",
          "args": [
            "&hdr",
            "data"
          ],
          "line": 1493
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "data",
            "0",
            "sizeof(data)"
          ],
          "line": 1492
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED)"
          ],
          "line": 1484
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "prctl",
          "args": [
            "PR_SET_SECUREBITS",
            "SECBIT_NOROOT | SECBIT_NOROOT_LOCKED"
          ],
          "line": 1484
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "prctl",
          "args": [
            "PR_CAPBSET_DROP",
            "cap",
            "0",
            "0",
            "0"
          ],
          "line": 1480
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::range",
          "args": [
            "0",
            "CAP_LAST_CAP + 1"
          ],
          "line": 1476
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "!keepRealUid"
          ],
          "line": 1472
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setresuid(uids.uid, uids.uid, uids.uid)"
          ],
          "line": 1467
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setresuid",
          "args": [
            "uids.uid",
            "uids.uid",
            "uids.uid"
          ],
          "line": 1467
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "seteuid(uids.uid)"
          ],
          "line": 1465
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "seteuid",
          "args": [
            "uids.uid"
          ],
          "line": 1465
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setgroups(uids.groups.size(), uids.groups.begin())"
          ],
          "line": 1457
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setgroups",
          "args": [
            "uids.groups.size()",
            "uids.groups.begin()"
          ],
          "line": 1457
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "uids.groups.begin",
          "args": [],
          "line": 1457
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "uids.groups.size",
          "args": [],
          "line": 1457
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setresgid(uids.gid, uids.gid, uids.gid)"
          ],
          "line": 1456
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setresgid",
          "args": [
            "uids.gid",
            "uids.gid",
            "uids.gid"
          ],
          "line": 1456
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)"
          ],
          "line": 1453
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "prctl",
          "args": [
            "PR_SET_NO_NEW_PRIVS",
            "1",
            "0",
            "0",
            "0"
          ],
          "line": 1453
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool runningAsRoot = getuid() == 0;\n\nvoid dropPrivs(const UserIds& uids, bool keepRealUid = false) {\n    // Defense in depth: Don't give my children any new caps for any reason.\n    KJ_SYSCALL(prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0));\n\n    if (runningAsRoot) {\n      KJ_SYSCALL(setresgid(uids.gid, uids.gid, uids.gid));\n      KJ_SYSCALL(setgroups(uids.groups.size(), uids.groups.begin()));\n\n      if (keepRealUid) {\n        // We're prepping to run the backend and user namespaces are not available, therefore the\n        // backend needs to keep its superuser powers stashed in order to hand them off to the\n        // grain supervisors so that they can set up sandboxes. Instead of creating a suid binary\n        // (with all the danger that entails), we merely drop the effective UID, but raise it again\n        // when invoking the supervisor.\n        KJ_SYSCALL(seteuid(uids.uid));\n      } else {\n        KJ_SYSCALL(setresuid(uids.uid, uids.uid, uids.uid));\n      }\n    } else {\n      // We're using UID namespaces.\n\n      KJ_ASSERT(!keepRealUid);\n\n      // Defense in depth: Drop all capabilities from the set of caps which my children are allowed\n      //   to ever have.\n      for (uint cap: kj::range(0, CAP_LAST_CAP + 1)) {\n        // TODO(soon): I spontaneously started getting EINVAL here, but only in production, so I\n        //   had to remove the error check. Figure out what happened and re-enable it. Maybe it\n        //   makes sense to read the bset first and then only drop the caps in it?\n        prctl(PR_CAPBSET_DROP, cap, 0, 0, 0);\n      }\n\n      // Defense in depth: Don't grant my children capabilities just because they have UID 0.\n      KJ_SYSCALL(prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED));\n\n      // Drop all Linux \"capabilities\".  (These are Linux/POSIX \"capabilities\", which are not true\n      // object-capabilities, hence the quotes.)\n      struct __user_cap_header_struct hdr;\n      struct __user_cap_data_struct data[2];\n      hdr.version = _LINUX_CAPABILITY_VERSION_3;\n      hdr.pid = 0;\n      memset(data, 0, sizeof(data));  // All capabilities disabled!\n      KJ_SYSCALL(capset(&hdr, data));\n    }\n\n    umask(0007);\n  }"
  },
  {
    "function_name": "enterChroot",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1328-1449",
    "snippet": "void enterChroot(bool inPidNamespace) {\n    KJ_REQUIRE(changedDir);\n\n    // Verify ownership is intact.\n    checkOwnedByRoot(\"..\", \"Install directory\");\n    checkOwnedByRoot(\".\", \"Version install directory\");\n    checkOwnedByRoot(\"sandstorm\", \"'sandstorm' executable\");\n    checkOwnedByRoot(\"../sandstorm.conf\", \"Config file\");\n\n    kj::StringPtr tmpfsUidOpts = \"\";\n    if (runningAsRoot) {\n      tmpfsUidOpts = \",uid=0,gid=0\";\n    } else {\n      unshareUidNamespaceOnce();\n    }\n\n    // Unshare the mount namespace, so we can create some private bind mounts.\n    KJ_SYSCALL(unshare(CLONE_NEWNS));\n\n    // To really unshare the mount namespace, we also have to make sure all mounts are private.\n    // The parameters here were derived by strace'ing `mount --make-rprivate /`.  AFAICT the flags\n    // are undocumented.  :(\n    KJ_SYSCALL(mount(\"none\", \"/\", nullptr, MS_REC | MS_PRIVATE, nullptr));\n\n    // Make sure that the current directory is a mount point so that we can use pivot_root.\n    KJ_SYSCALL(mount(\".\", \".\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Now change directory into the new mount point.\n    char cwdBuf[PATH_MAX + 1];\n    if (getcwd(cwdBuf, sizeof(cwdBuf)) == nullptr) {\n      KJ_FAIL_SYSCALL(\"getcwd\", errno);\n    }\n    KJ_SYSCALL(chdir(cwdBuf));\n\n    if (inPidNamespace) {\n      // Mount /proc for our PID namespace in the chroot.\n      KJ_SYSCALL(mount(\"proc\", \"proc\", \"proc\", MS_NOSUID | MS_NODEV | MS_NOEXEC, \"\"));\n    } else {\n      // Bind /proc for the global pid namespace in the chroot.\n      KJ_SYSCALL(mount(\"/proc\", \"proc\", nullptr, MS_BIND | MS_REC, nullptr));\n    }\n\n    // Bind var -> ../var, so that all versions share the same var.\n    // Same for tmp, though we clear it on every startup.\n    KJ_SYSCALL(mount(\"../var\", \"var\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"../tmp\", \"tmp\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Bind devices from /dev into our chroot environment.\n    // We can't bind /dev itself because this is apparently not allowed when in a UID namespace\n    // (returns EINVAL; haven't figured out why yet).\n    KJ_SYSCALL(mount(\"/dev/null\", \"dev/null\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/zero\", \"dev/zero\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/random\", \"dev/random\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/urandom\", \"dev/urandom\", nullptr, MS_BIND, nullptr));\n\n    if (runningAsRoot && access(\"/dev/fuse\", F_OK) == 0) {\n      // Bring in FUSE just in case we need it for \"spk dev\".\n      // TODO(cleanup): We should probably instead open /dev/fuse in the \"spk\" command (i.e.\n      //   outside the namespace) and then pass the FD to the server.\n      KJ_SYSCALL(mount(\"/dev/fuse\", \"dev/fuse\", nullptr, MS_BIND, nullptr));\n    }\n\n    // Bind in the host's /etc as /etc.host.\n    // As noted in backup.c++, MS_BIND does not respect mount flags on the initial bind, and\n    // we have to issue a remount to set them.  Because the host /etc may have been mounted nosuid,\n    // nodev, and noexec, we also add those flags here lest mount() think we're trying to remove\n    // them (which would cause mount() to fail).  We also need MS_REC because the host may have\n    // mounted other FSes under /etc, and we need to recursively rebind those.\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n    // Then do the same for /run.\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n\n    // Mount a tmpfs at /run.\n    KJ_SYSCALL(mount(\"tmpfs\", \"run\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Mount a tmpfs at /etc.\n    KJ_SYSCALL(mount(\"tmpfs\", \"etc\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Symlink in necessary config files from the host, as described in the bundle's host.list\n    linkHostFiles();\n    // And just in case the user has /etc/resolv.conf as a symlink to something we haven't linked\n    // in, copy its contents to /etc/resolv.conf.host-initial so we can use that if needed.\n    backupResolvConf();\n\n    // OK, change our root directory.\n    KJ_SYSCALL(syscall(SYS_pivot_root, \".\", \"tmp\"));\n    KJ_SYSCALL(chdir(\"/\"));\n    KJ_SYSCALL(umount2(\"tmp\", MNT_DETACH));\n\n    // The environment inherited from the host is probably no good for us. E.g. an oddball\n    // locale setting can crash Mongo because we don't have the appropriate locale files available.\n    //\n    // That said, there are a few environment variables that we do re-export.\n    std::map<const char*, kj::String> envVars;\n    static const char* const KEEP_VARS[] = {\"http_proxy\", \"https_proxy\"};\n    for (const char* varName: KEEP_VARS) {\n      const char* envValue = getenv(varName);\n      if (envValue != nullptr) {\n        envVars.insert(std::make_pair(varName, kj::str(envValue)));\n      }\n    }\n    KJ_SYSCALL(clearenv());\n\n    // Set up an environment appropriate for us.\n    KJ_SYSCALL(setenv(\"LANG\", \"C.UTF-8\", true));\n    KJ_SYSCALL(setenv(\"PATH\", \"/usr/bin:/bin\", true));\n    KJ_SYSCALL(setenv(\"LD_LIBRARY_PATH\", \"/usr/local/lib:/usr/lib:/lib\", true));\n\n    // Copy any remaining environment variables in that we captured.\n    for (auto& entry: envVars) {\n      KJ_SYSCALL(setenv(entry.first, entry.second.cStr(), true));\n    }\n\n    // See if /etc/resolv.conf exists, and if not, try replacing it with the backup made earlier.\n    restoreResolvConfIfNeeded();\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;",
      "bool changedDir = false;",
      "bool runningAsRoot = getuid() == 0;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "restoreResolvConfIfNeeded",
          "args": [],
          "line": 1448
        },
        "resolved": true,
        "details": {
          "function_name": "restoreResolvConfIfNeeded",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1542-1559",
          "snippet": "void restoreResolvConfIfNeeded() {\n    struct stat stats;\n    if (stat(\"/etc/resolv.conf\", &stats) < 0) {\n      auto error = errno;\n      if (error == ENOENT) {\n        if (access(\"/etc/resolv.conf.host-initial\", R_OK) == 0) {\n          context.warning(\"WARNING: /etc/resolv.conf is unreachable from container, \"\n                          \"using backup from host\");\n          KJ_SYSCALL(rename(\"/etc/resolv.conf.host-initial\", \"/etc/resolv.conf\"));\n        } else {\n          context.warning(\"WARNING: Wanted to fall back to /etc/resolv.conf.host-initial, \"\n                          \"but it is unavailable.  Carrying on without DNS.\");\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"stat('/etc/resolv.conf')\", error);\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid restoreResolvConfIfNeeded() {\n    struct stat stats;\n    if (stat(\"/etc/resolv.conf\", &stats) < 0) {\n      auto error = errno;\n      if (error == ENOENT) {\n        if (access(\"/etc/resolv.conf.host-initial\", R_OK) == 0) {\n          context.warning(\"WARNING: /etc/resolv.conf is unreachable from container, \"\n                          \"using backup from host\");\n          KJ_SYSCALL(rename(\"/etc/resolv.conf.host-initial\", \"/etc/resolv.conf\"));\n        } else {\n          context.warning(\"WARNING: Wanted to fall back to /etc/resolv.conf.host-initial, \"\n                          \"but it is unavailable.  Carrying on without DNS.\");\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"stat('/etc/resolv.conf')\", error);\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(entry.first, entry.second.cStr(), true)"
          ],
          "line": 1444
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "entry.first",
            "entry.second.cStr()",
            "true"
          ],
          "line": 1444
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "entry.second.cStr",
          "args": [],
          "line": 1444
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"LD_LIBRARY_PATH\", \"/usr/local/lib:/usr/lib:/lib\", true)"
          ],
          "line": 1440
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"LD_LIBRARY_PATH\"",
            "\"/usr/local/lib:/usr/lib:/lib\"",
            "true"
          ],
          "line": 1440
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"PATH\", \"/usr/bin:/bin\", true)"
          ],
          "line": 1439
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"PATH\"",
            "\"/usr/bin:/bin\"",
            "true"
          ],
          "line": 1439
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"LANG\", \"C.UTF-8\", true)"
          ],
          "line": 1438
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"LANG\"",
            "\"C.UTF-8\"",
            "true"
          ],
          "line": 1438
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "clearenv()"
          ],
          "line": 1435
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "clearenv",
          "args": [],
          "line": 1435
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "envVars.insert",
          "args": [
            "std::make_pair(varName, kj::str(envValue))"
          ],
          "line": 1432
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "std::make_pair",
          "args": [
            "varName",
            "kj::str(envValue)"
          ],
          "line": 1432
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "envValue"
          ],
          "line": 1432
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getenv",
          "args": [
            "varName"
          ],
          "line": 1430
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "umount2(\"tmp\", MNT_DETACH)"
          ],
          "line": 1421
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "umount2",
          "args": [
            "\"tmp\"",
            "MNT_DETACH"
          ],
          "line": 1421
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chdir(\"/\")"
          ],
          "line": 1420
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chdir",
          "args": [
            "\"/\""
          ],
          "line": 1420
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "syscall(SYS_pivot_root, \".\", \"tmp\")"
          ],
          "line": 1419
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "syscall",
          "args": [
            "SYS_pivot_root",
            "\".\"",
            "\"tmp\""
          ],
          "line": 1419
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "backupResolvConf",
          "args": [],
          "line": 1416
        },
        "resolved": true,
        "details": {
          "function_name": "backupResolvConf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1529-1540",
          "snippet": "void backupResolvConf() {\n    if (access(\"/etc/resolv.conf\", R_OK) == 0) {\n      auto in = raiiOpen(\"/etc/resolv.conf\", O_RDONLY);\n      auto out = raiiOpen(\"./etc/resolv.conf.host-initial\", O_WRONLY | O_CREAT | O_EXCL);\n      ssize_t n;\n      do {\n        KJ_SYSCALL(n = sendfile(out, in, nullptr, 1 << 20));\n      } while (n > 0);\n    } else {\n      context.warning(\"WARNING: Couldn't read host's /etc/resolv.conf, DNS may be broken\");\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid backupResolvConf() {\n    if (access(\"/etc/resolv.conf\", R_OK) == 0) {\n      auto in = raiiOpen(\"/etc/resolv.conf\", O_RDONLY);\n      auto out = raiiOpen(\"./etc/resolv.conf.host-initial\", O_WRONLY | O_CREAT | O_EXCL);\n      ssize_t n;\n      do {\n        KJ_SYSCALL(n = sendfile(out, in, nullptr, 1 << 20));\n      } while (n > 0);\n    } else {\n      context.warning(\"WARNING: Couldn't read host's /etc/resolv.conf, DNS may be broken\");\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "linkHostFiles",
          "args": [],
          "line": 1413
        },
        "resolved": true,
        "details": {
          "function_name": "linkHostFiles",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1505-1527",
          "snippet": "void linkHostFiles() {\n    // We will create a symlink for the first child of /etc or /run named in each line of host.list to\n    // symlink that file or folder from the host into the /etc or /run tmpfs.\n    auto files = splitLines(readAll(\"host.list\"));\n\n    // Now copy over each file.\n    for (auto& file: files) {\n      auto pathElements = split(file, '/');\n      KJ_REQUIRE(pathElements.size() >= 3, \"invalid path\", file);\n      KJ_REQUIRE(pathElements[0].size() == 0,\"relative path given in host.list\", file);\n      auto firstDir = kj::str(pathElements[1]);\n      KJ_REQUIRE(firstDir == \"etc\" || firstDir == \"run\", \"host.list asked to symlink in file outside of /etc/ or /run/\", file);\n      auto child = pathElements[2];\n      auto linkTargetAsSeenByLink = kj::str(\"../\", firstDir, \".host/\", child);\n      auto linkToCreate = kj::str(\"./\", firstDir, \"/\", child);\n\n      // Only attempt to create the symlink if we haven't created it already.\n      struct stat stats;\n      if (lstat(linkToCreate.cStr(), &stats) < 0 && errno == ENOENT) {\n        KJ_SYSCALL(symlink(linkTargetAsSeenByLink.cStr(), linkToCreate.cStr()));\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid linkHostFiles() {\n    // We will create a symlink for the first child of /etc or /run named in each line of host.list to\n    // symlink that file or folder from the host into the /etc or /run tmpfs.\n    auto files = splitLines(readAll(\"host.list\"));\n\n    // Now copy over each file.\n    for (auto& file: files) {\n      auto pathElements = split(file, '/');\n      KJ_REQUIRE(pathElements.size() >= 3, \"invalid path\", file);\n      KJ_REQUIRE(pathElements[0].size() == 0,\"relative path given in host.list\", file);\n      auto firstDir = kj::str(pathElements[1]);\n      KJ_REQUIRE(firstDir == \"etc\" || firstDir == \"run\", \"host.list asked to symlink in file outside of /etc/ or /run/\", file);\n      auto child = pathElements[2];\n      auto linkTargetAsSeenByLink = kj::str(\"../\", firstDir, \".host/\", child);\n      auto linkToCreate = kj::str(\"./\", firstDir, \"/\", child);\n\n      // Only attempt to create the symlink if we haven't created it already.\n      struct stat stats;\n      if (lstat(linkToCreate.cStr(), &stats) < 0 && errno == ENOENT) {\n        KJ_SYSCALL(symlink(linkTargetAsSeenByLink.cStr(), linkToCreate.cStr()));\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"tmpfs\", \"etc\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr())"
          ],
          "line": 1410
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"tmpfs\"",
            "\"etc\"",
            "\"tmpfs\"",
            "MS_NOSUID | MS_NOEXEC",
            "kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()"
          ],
          "line": 1410
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [],
          "line": 1411
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"size=2m,nr_inodes=128,mode=755\"",
            "tmpfsUidOpts"
          ],
          "line": 1411
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"tmpfs\", \"run\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr())"
          ],
          "line": 1407
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"tmpfs\"",
            "\"run\"",
            "\"tmpfs\"",
            "MS_NOSUID | MS_NOEXEC",
            "kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()"
          ],
          "line": 1407
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [],
          "line": 1408
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"size=2m,nr_inodes=128,mode=755\"",
            "tmpfsUidOpts"
          ],
          "line": 1408
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/run\", \"run.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr)"
          ],
          "line": 1402
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/run\"",
            "\"run.host\"",
            "nullptr",
            "MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC",
            "nullptr"
          ],
          "line": 1402
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/run\", \"run.host\", nullptr, MS_BIND | MS_REC, nullptr)"
          ],
          "line": 1401
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/run\"",
            "\"run.host\"",
            "nullptr",
            "MS_BIND | MS_REC",
            "nullptr"
          ],
          "line": 1401
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/etc\", \"etc.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr)"
          ],
          "line": 1397
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/etc\"",
            "\"etc.host\"",
            "nullptr",
            "MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC",
            "nullptr"
          ],
          "line": 1397
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/etc\", \"etc.host\", nullptr, MS_BIND | MS_REC, nullptr)"
          ],
          "line": 1396
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/etc\"",
            "\"etc.host\"",
            "nullptr",
            "MS_BIND | MS_REC",
            "nullptr"
          ],
          "line": 1396
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/dev/fuse\", \"dev/fuse\", nullptr, MS_BIND, nullptr)"
          ],
          "line": 1387
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/dev/fuse\"",
            "\"dev/fuse\"",
            "nullptr",
            "MS_BIND",
            "nullptr"
          ],
          "line": 1387
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"/dev/fuse\"",
            "F_OK"
          ],
          "line": 1383
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/dev/urandom\", \"dev/urandom\", nullptr, MS_BIND, nullptr)"
          ],
          "line": 1381
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/dev/urandom\"",
            "\"dev/urandom\"",
            "nullptr",
            "MS_BIND",
            "nullptr"
          ],
          "line": 1381
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/dev/random\", \"dev/random\", nullptr, MS_BIND, nullptr)"
          ],
          "line": 1380
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/dev/random\"",
            "\"dev/random\"",
            "nullptr",
            "MS_BIND",
            "nullptr"
          ],
          "line": 1380
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/dev/zero\", \"dev/zero\", nullptr, MS_BIND, nullptr)"
          ],
          "line": 1379
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/dev/zero\"",
            "\"dev/zero\"",
            "nullptr",
            "MS_BIND",
            "nullptr"
          ],
          "line": 1379
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/dev/null\", \"dev/null\", nullptr, MS_BIND, nullptr)"
          ],
          "line": 1378
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/dev/null\"",
            "\"dev/null\"",
            "nullptr",
            "MS_BIND",
            "nullptr"
          ],
          "line": 1378
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"../tmp\", \"tmp\", nullptr, MS_BIND | MS_REC, nullptr)"
          ],
          "line": 1373
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"../tmp\"",
            "\"tmp\"",
            "nullptr",
            "MS_BIND | MS_REC",
            "nullptr"
          ],
          "line": 1373
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"../var\", \"var\", nullptr, MS_BIND | MS_REC, nullptr)"
          ],
          "line": 1372
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"../var\"",
            "\"var\"",
            "nullptr",
            "MS_BIND | MS_REC",
            "nullptr"
          ],
          "line": 1372
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"/proc\", \"proc\", nullptr, MS_BIND | MS_REC, nullptr)"
          ],
          "line": 1367
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"/proc\"",
            "\"proc\"",
            "nullptr",
            "MS_BIND | MS_REC",
            "nullptr"
          ],
          "line": 1367
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"proc\", \"proc\", \"proc\", MS_NOSUID | MS_NODEV | MS_NOEXEC, \"\")"
          ],
          "line": 1364
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"proc\"",
            "\"proc\"",
            "\"proc\"",
            "MS_NOSUID | MS_NODEV | MS_NOEXEC",
            "\"\""
          ],
          "line": 1364
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chdir(cwdBuf)"
          ],
          "line": 1360
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chdir",
          "args": [
            "cwdBuf"
          ],
          "line": 1360
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"getcwd\"",
            "errno"
          ],
          "line": 1358
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getcwd",
          "args": [
            "cwdBuf",
            "sizeof(cwdBuf)"
          ],
          "line": 1357
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\".\", \".\", nullptr, MS_BIND | MS_REC, nullptr)"
          ],
          "line": 1353
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\".\"",
            "\".\"",
            "nullptr",
            "MS_BIND | MS_REC",
            "nullptr"
          ],
          "line": 1353
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mount(\"none\", \"/\", nullptr, MS_REC | MS_PRIVATE, nullptr)"
          ],
          "line": 1350
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mount",
          "args": [
            "\"none\"",
            "\"/\"",
            "nullptr",
            "MS_REC | MS_PRIVATE",
            "nullptr"
          ],
          "line": 1350
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unshare(CLONE_NEWNS)"
          ],
          "line": 1345
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unshare",
          "args": [
            "CLONE_NEWNS"
          ],
          "line": 1345
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unshareUidNamespaceOnce",
          "args": [],
          "line": 1341
        },
        "resolved": true,
        "details": {
          "function_name": "unshareUidNamespaceOnce",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1306-1326",
          "snippet": "void unshareUidNamespaceOnce() {\n    if (!unsharedUidNamespace) {\n      uid_t uid = getuid();\n      gid_t gid = getgid();\n\n      KJ_SYSCALL(unshare(CLONE_NEWUSER));\n\n      // Set up the UID namespace. We map ourselves as UID zero because this allows capabilities\n      // to be inherited through exec(), which we need to support update and restart. With any\n      // other UID, capabilities can only be inherited through exec() if the target exec'd file\n      // has its inheritable capabilities set filled. By default, the inheritable capability set\n      // for all files is empty, and only the filesystem's superuser (i.e. not us) can change them.\n      // But if our UID is zero, then the file's attributes are ignored and all capabilities are\n      // inherited.\n      writeSetgroupsIfPresent(\"deny\\n\");\n      writeUserNSMap(\"uid\", kj::str(\"0 \", uid, \" 1\\n\"));\n      writeUserNSMap(\"gid\", kj::str(\"0 \", gid, \" 1\\n\"));\n\n      unsharedUidNamespace = true;\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool unsharedUidNamespace = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool unsharedUidNamespace = false;\n\nvoid unshareUidNamespaceOnce() {\n    if (!unsharedUidNamespace) {\n      uid_t uid = getuid();\n      gid_t gid = getgid();\n\n      KJ_SYSCALL(unshare(CLONE_NEWUSER));\n\n      // Set up the UID namespace. We map ourselves as UID zero because this allows capabilities\n      // to be inherited through exec(), which we need to support update and restart. With any\n      // other UID, capabilities can only be inherited through exec() if the target exec'd file\n      // has its inheritable capabilities set filled. By default, the inheritable capability set\n      // for all files is empty, and only the filesystem's superuser (i.e. not us) can change them.\n      // But if our UID is zero, then the file's attributes are ignored and all capabilities are\n      // inherited.\n      writeSetgroupsIfPresent(\"deny\\n\");\n      writeUserNSMap(\"uid\", kj::str(\"0 \", uid, \" 1\\n\"));\n      writeUserNSMap(\"gid\", kj::str(\"0 \", gid, \" 1\\n\"));\n\n      unsharedUidNamespace = true;\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "checkOwnedByRoot",
          "args": [
            "\"../sandstorm.conf\"",
            "\"Config file\""
          ],
          "line": 1335
        },
        "resolved": true,
        "details": {
          "function_name": "checkOwnedByRoot",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1216-1228",
          "snippet": "void checkOwnedByRoot(kj::StringPtr path, kj::StringPtr title) {\n    if (access(path.cStr(), F_OK) != 0) {\n      context.exitError(kj::str(title, \" not found.\"));\n    }\n\n    if (runningAsRoot) {\n      struct stat stats;\n      KJ_SYSCALL(stat(path.cStr(), &stats));\n      if (stats.st_uid != 0) {\n        context.exitError(kj::str(title, \" not owned by root, but you're running as root.\"));\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\nvoid checkOwnedByRoot(kj::StringPtr path, kj::StringPtr title) {\n    if (access(path.cStr(), F_OK) != 0) {\n      context.exitError(kj::str(title, \" not found.\"));\n    }\n\n    if (runningAsRoot) {\n      struct stat stats;\n      KJ_SYSCALL(stat(path.cStr(), &stats));\n      if (stats.st_uid != 0) {\n        context.exitError(kj::str(title, \" not owned by root, but you're running as root.\"));\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "changedDir"
          ],
          "line": 1329
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool changedDir = false;\nbool runningAsRoot = getuid() == 0;\n\nvoid enterChroot(bool inPidNamespace) {\n    KJ_REQUIRE(changedDir);\n\n    // Verify ownership is intact.\n    checkOwnedByRoot(\"..\", \"Install directory\");\n    checkOwnedByRoot(\".\", \"Version install directory\");\n    checkOwnedByRoot(\"sandstorm\", \"'sandstorm' executable\");\n    checkOwnedByRoot(\"../sandstorm.conf\", \"Config file\");\n\n    kj::StringPtr tmpfsUidOpts = \"\";\n    if (runningAsRoot) {\n      tmpfsUidOpts = \",uid=0,gid=0\";\n    } else {\n      unshareUidNamespaceOnce();\n    }\n\n    // Unshare the mount namespace, so we can create some private bind mounts.\n    KJ_SYSCALL(unshare(CLONE_NEWNS));\n\n    // To really unshare the mount namespace, we also have to make sure all mounts are private.\n    // The parameters here were derived by strace'ing `mount --make-rprivate /`.  AFAICT the flags\n    // are undocumented.  :(\n    KJ_SYSCALL(mount(\"none\", \"/\", nullptr, MS_REC | MS_PRIVATE, nullptr));\n\n    // Make sure that the current directory is a mount point so that we can use pivot_root.\n    KJ_SYSCALL(mount(\".\", \".\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Now change directory into the new mount point.\n    char cwdBuf[PATH_MAX + 1];\n    if (getcwd(cwdBuf, sizeof(cwdBuf)) == nullptr) {\n      KJ_FAIL_SYSCALL(\"getcwd\", errno);\n    }\n    KJ_SYSCALL(chdir(cwdBuf));\n\n    if (inPidNamespace) {\n      // Mount /proc for our PID namespace in the chroot.\n      KJ_SYSCALL(mount(\"proc\", \"proc\", \"proc\", MS_NOSUID | MS_NODEV | MS_NOEXEC, \"\"));\n    } else {\n      // Bind /proc for the global pid namespace in the chroot.\n      KJ_SYSCALL(mount(\"/proc\", \"proc\", nullptr, MS_BIND | MS_REC, nullptr));\n    }\n\n    // Bind var -> ../var, so that all versions share the same var.\n    // Same for tmp, though we clear it on every startup.\n    KJ_SYSCALL(mount(\"../var\", \"var\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"../tmp\", \"tmp\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Bind devices from /dev into our chroot environment.\n    // We can't bind /dev itself because this is apparently not allowed when in a UID namespace\n    // (returns EINVAL; haven't figured out why yet).\n    KJ_SYSCALL(mount(\"/dev/null\", \"dev/null\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/zero\", \"dev/zero\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/random\", \"dev/random\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/urandom\", \"dev/urandom\", nullptr, MS_BIND, nullptr));\n\n    if (runningAsRoot && access(\"/dev/fuse\", F_OK) == 0) {\n      // Bring in FUSE just in case we need it for \"spk dev\".\n      // TODO(cleanup): We should probably instead open /dev/fuse in the \"spk\" command (i.e.\n      //   outside the namespace) and then pass the FD to the server.\n      KJ_SYSCALL(mount(\"/dev/fuse\", \"dev/fuse\", nullptr, MS_BIND, nullptr));\n    }\n\n    // Bind in the host's /etc as /etc.host.\n    // As noted in backup.c++, MS_BIND does not respect mount flags on the initial bind, and\n    // we have to issue a remount to set them.  Because the host /etc may have been mounted nosuid,\n    // nodev, and noexec, we also add those flags here lest mount() think we're trying to remove\n    // them (which would cause mount() to fail).  We also need MS_REC because the host may have\n    // mounted other FSes under /etc, and we need to recursively rebind those.\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n    // Then do the same for /run.\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n\n    // Mount a tmpfs at /run.\n    KJ_SYSCALL(mount(\"tmpfs\", \"run\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Mount a tmpfs at /etc.\n    KJ_SYSCALL(mount(\"tmpfs\", \"etc\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Symlink in necessary config files from the host, as described in the bundle's host.list\n    linkHostFiles();\n    // And just in case the user has /etc/resolv.conf as a symlink to something we haven't linked\n    // in, copy its contents to /etc/resolv.conf.host-initial so we can use that if needed.\n    backupResolvConf();\n\n    // OK, change our root directory.\n    KJ_SYSCALL(syscall(SYS_pivot_root, \".\", \"tmp\"));\n    KJ_SYSCALL(chdir(\"/\"));\n    KJ_SYSCALL(umount2(\"tmp\", MNT_DETACH));\n\n    // The environment inherited from the host is probably no good for us. E.g. an oddball\n    // locale setting can crash Mongo because we don't have the appropriate locale files available.\n    //\n    // That said, there are a few environment variables that we do re-export.\n    std::map<const char*, kj::String> envVars;\n    static const char* const KEEP_VARS[] = {\"http_proxy\", \"https_proxy\"};\n    for (const char* varName: KEEP_VARS) {\n      const char* envValue = getenv(varName);\n      if (envValue != nullptr) {\n        envVars.insert(std::make_pair(varName, kj::str(envValue)));\n      }\n    }\n    KJ_SYSCALL(clearenv());\n\n    // Set up an environment appropriate for us.\n    KJ_SYSCALL(setenv(\"LANG\", \"C.UTF-8\", true));\n    KJ_SYSCALL(setenv(\"PATH\", \"/usr/bin:/bin\", true));\n    KJ_SYSCALL(setenv(\"LD_LIBRARY_PATH\", \"/usr/local/lib:/usr/lib:/lib\", true));\n\n    // Copy any remaining environment variables in that we captured.\n    for (auto& entry: envVars) {\n      KJ_SYSCALL(setenv(entry.first, entry.second.cStr(), true));\n    }\n\n    // See if /etc/resolv.conf exists, and if not, try replacing it with the backup made earlier.\n    restoreResolvConfIfNeeded();\n  }"
  },
  {
    "function_name": "unshareUidNamespaceOnce",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1306-1326",
    "snippet": "void unshareUidNamespaceOnce() {\n    if (!unsharedUidNamespace) {\n      uid_t uid = getuid();\n      gid_t gid = getgid();\n\n      KJ_SYSCALL(unshare(CLONE_NEWUSER));\n\n      // Set up the UID namespace. We map ourselves as UID zero because this allows capabilities\n      // to be inherited through exec(), which we need to support update and restart. With any\n      // other UID, capabilities can only be inherited through exec() if the target exec'd file\n      // has its inheritable capabilities set filled. By default, the inheritable capability set\n      // for all files is empty, and only the filesystem's superuser (i.e. not us) can change them.\n      // But if our UID is zero, then the file's attributes are ignored and all capabilities are\n      // inherited.\n      writeSetgroupsIfPresent(\"deny\\n\");\n      writeUserNSMap(\"uid\", kj::str(\"0 \", uid, \" 1\\n\"));\n      writeUserNSMap(\"gid\", kj::str(\"0 \", gid, \" 1\\n\"));\n\n      unsharedUidNamespace = true;\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool unsharedUidNamespace = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "writeUserNSMap",
          "args": [
            "\"gid\"",
            "kj::str(\"0 \", gid, \" 1\\n\")"
          ],
          "line": 1322
        },
        "resolved": true,
        "details": {
          "function_name": "writeUserNSMap",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1295-1298",
          "snippet": "void writeUserNSMap(const char *type, kj::StringPtr contents) {\n    kj::FdOutputStream(raiiOpen(kj::str(\"/proc/self/\", type, \"_map\").cStr(), O_WRONLY | O_CLOEXEC))\n        .write(contents.begin(), contents.size());\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid writeUserNSMap(const char *type, kj::StringPtr contents) {\n    kj::FdOutputStream(raiiOpen(kj::str(\"/proc/self/\", type, \"_map\").cStr(), O_WRONLY | O_CLOEXEC))\n        .write(contents.begin(), contents.size());\n  }"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"0 \"",
            "gid",
            "\" 1\\n\""
          ],
          "line": 1322
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"0 \"",
            "uid",
            "\" 1\\n\""
          ],
          "line": 1321
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "writeSetgroupsIfPresent",
          "args": [
            "\"deny\\n\""
          ],
          "line": 1320
        },
        "resolved": true,
        "details": {
          "function_name": "writeSetgroupsIfPresent",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1300-1304",
          "snippet": "void writeSetgroupsIfPresent(const char *contents) {\n    KJ_IF_MAYBE(fd, raiiOpenIfExists(\"/proc/self/setgroups\", O_WRONLY | O_CLOEXEC)) {\n      kj::FdOutputStream(kj::mv(*fd)).write(contents, strlen(contents));\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid writeSetgroupsIfPresent(const char *contents) {\n    KJ_IF_MAYBE(fd, raiiOpenIfExists(\"/proc/self/setgroups\", O_WRONLY | O_CLOEXEC)) {\n      kj::FdOutputStream(kj::mv(*fd)).write(contents, strlen(contents));\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unshare(CLONE_NEWUSER)"
          ],
          "line": 1311
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unshare",
          "args": [
            "CLONE_NEWUSER"
          ],
          "line": 1311
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getgid",
          "args": [],
          "line": 1309
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getuid",
          "args": [],
          "line": 1308
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool unsharedUidNamespace = false;\n\nvoid unshareUidNamespaceOnce() {\n    if (!unsharedUidNamespace) {\n      uid_t uid = getuid();\n      gid_t gid = getgid();\n\n      KJ_SYSCALL(unshare(CLONE_NEWUSER));\n\n      // Set up the UID namespace. We map ourselves as UID zero because this allows capabilities\n      // to be inherited through exec(), which we need to support update and restart. With any\n      // other UID, capabilities can only be inherited through exec() if the target exec'd file\n      // has its inheritable capabilities set filled. By default, the inheritable capability set\n      // for all files is empty, and only the filesystem's superuser (i.e. not us) can change them.\n      // But if our UID is zero, then the file's attributes are ignored and all capabilities are\n      // inherited.\n      writeSetgroupsIfPresent(\"deny\\n\");\n      writeUserNSMap(\"uid\", kj::str(\"0 \", uid, \" 1\\n\"));\n      writeUserNSMap(\"gid\", kj::str(\"0 \", gid, \" 1\\n\"));\n\n      unsharedUidNamespace = true;\n    }\n  }"
  },
  {
    "function_name": "writeSetgroupsIfPresent",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1300-1304",
    "snippet": "void writeSetgroupsIfPresent(const char *contents) {\n    KJ_IF_MAYBE(fd, raiiOpenIfExists(\"/proc/self/setgroups\", O_WRONLY | O_CLOEXEC)) {\n      kj::FdOutputStream(kj::mv(*fd)).write(contents, strlen(contents));\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "contents",
            "strlen(contents)"
          ],
          "line": 1302
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "contents"
          ],
          "line": 1302
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "kj::mv(*fd)"
          ],
          "line": 1302
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "*fd"
          ],
          "line": 1302
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "fd",
            "raiiOpenIfExists(\"/proc/self/setgroups\", O_WRONLY | O_CLOEXEC)"
          ],
          "line": 1301
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1662-1665",
          "snippet": "KJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }"
        }
      },
      {
        "call_info": {
          "callee": "raiiOpenIfExists",
          "args": [
            "\"/proc/self/setgroups\"",
            "O_WRONLY | O_CLOEXEC"
          ],
          "line": 1301
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid writeSetgroupsIfPresent(const char *contents) {\n    KJ_IF_MAYBE(fd, raiiOpenIfExists(\"/proc/self/setgroups\", O_WRONLY | O_CLOEXEC)) {\n      kj::FdOutputStream(kj::mv(*fd)).write(contents, strlen(contents));\n    }\n  }"
  },
  {
    "function_name": "writeUserNSMap",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1295-1298",
    "snippet": "void writeUserNSMap(const char *type, kj::StringPtr contents) {\n    kj::FdOutputStream(raiiOpen(kj::str(\"/proc/self/\", type, \"_map\").cStr(), O_WRONLY | O_CLOEXEC))\n        .write(contents.begin(), contents.size());\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "contents.begin()",
            "contents.size()"
          ],
          "line": 1296
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "contents.size",
          "args": [],
          "line": 1297
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "contents.begin",
          "args": [],
          "line": 1297
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "raiiOpen(kj::str(\"/proc/self/\", type, \"_map\").cStr(), O_WRONLY | O_CLOEXEC)"
          ],
          "line": 1296
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "kj::str(\"/proc/self/\", type, \"_map\").cStr()",
            "O_WRONLY | O_CLOEXEC"
          ],
          "line": 1296
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [],
          "line": 1296
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/proc/self/\"",
            "type",
            "\"_map\""
          ],
          "line": 1296
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid writeUserNSMap(const char *type, kj::StringPtr contents) {\n    kj::FdOutputStream(raiiOpen(kj::str(\"/proc/self/\", type, \"_map\").cStr(), O_WRONLY | O_CLOEXEC))\n        .write(contents.begin(), contents.size());\n  }"
  },
  {
    "function_name": "getTime",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1289-1293",
    "snippet": "int64_t getTime() {\n    struct timespec ts;\n    KJ_SYSCALL(clock_gettime(CLOCK_MONOTONIC, &ts));\n    return ts.tv_sec * 1000000000ll + ts.tv_nsec;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "clock_gettime(CLOCK_MONOTONIC, &ts)"
          ],
          "line": 1291
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "clock_gettime",
          "args": [
            "CLOCK_MONOTONIC",
            "&ts"
          ],
          "line": 1291
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nint64_t getTime() {\n    struct timespec ts;\n    KJ_SYSCALL(clock_gettime(CLOCK_MONOTONIC, &ts));\n    return ts.tv_sec * 1000000000ll + ts.tv_nsec;\n  }"
  },
  {
    "function_name": "getRunningPid",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1256-1278",
    "snippet": "kj::Maybe<pid_t> getRunningPid(kj::AutoCloseFd& pidfile) {\n    struct flock lock;\n    memset(&lock, 0, sizeof(lock));\n    lock.l_type = F_WRLCK;\n    lock.l_whence = SEEK_SET;\n    lock.l_start = 0;\n    lock.l_len = 0;  // entire file\n    KJ_SYSCALL(fcntl(pidfile, F_GETLK, &lock));\n\n    if (lock.l_type == F_UNLCK) {\n      return nullptr;\n    }\n\n    // The pidfile is locked, therefore someone is using it.\n    pid_t lockingPid = lock.l_pid;\n\n    // Let's also read the content of the file and make sure it matches.\n    pid_t pidfilePid;\n    KJ_IF_MAYBE(p, parseUInt(trim(readAll(pidfile)), 10)) {\n      pidfilePid = *p;\n    } else {\n      pidfilePid = -1;\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "p",
            "parseUInt(trim(readAll(pidfile)), 10)"
          ],
          "line": 1274
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1662-1665",
          "snippet": "KJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }"
        }
      },
      {
        "call_info": {
          "callee": "parseUInt",
          "args": [
            "trim(readAll(pidfile))",
            "10"
          ],
          "line": 1274
        },
        "resolved": true,
        "details": {
          "function_name": "parseUInt64",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "223-230",
          "snippet": "kj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "trim",
          "args": [
            "readAll(pidfile)"
          ],
          "line": 1274
        },
        "resolved": true,
        "details": {
          "function_name": "trim",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "202-204",
          "snippet": "kj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}"
        }
      },
      {
        "call_info": {
          "callee": "readAll",
          "args": [
            "pidfile"
          ],
          "line": 1274
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fcntl(pidfile, F_GETLK, &lock)"
          ],
          "line": 1263
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fcntl",
          "args": [
            "pidfile",
            "F_GETLK",
            "&lock"
          ],
          "line": 1263
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&lock",
            "0",
            "sizeof(lock)"
          ],
          "line": 1258
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::Maybe<pid_t> getRunningPid(kj::AutoCloseFd& pidfile) {\n    struct flock lock;\n    memset(&lock, 0, sizeof(lock));\n    lock.l_type = F_WRLCK;\n    lock.l_whence = SEEK_SET;\n    lock.l_start = 0;\n    lock.l_len = 0;  // entire file\n    KJ_SYSCALL(fcntl(pidfile, F_GETLK, &lock));\n\n    if (lock.l_type == F_UNLCK) {\n      return nullptr;\n    }\n\n    // The pidfile is locked, therefore someone is using it.\n    pid_t lockingPid = lock.l_pid;\n\n    // Let's also read the content of the file and make sure it matches.\n    pid_t pidfilePid;\n    KJ_IF_MAYBE(p, parseUInt(trim(readAll(pidfile)), 10)) {\n      pidfilePid = *p;\n    } else {\n      pidfilePid = -1;\n    }"
  },
  {
    "function_name": "getRunningPid",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1248-1254",
    "snippet": "kj::Maybe<pid_t> getRunningPid() {\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      return getRunningPid(*pf);\n    } else {\n      return nullptr;\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "getRunningPid",
          "args": [
            "*pf"
          ],
          "line": 1250
        },
        "resolved": true,
        "details": {
          "function_name": "getRunningPid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1256-1278",
          "snippet": "kj::Maybe<pid_t> getRunningPid(kj::AutoCloseFd& pidfile) {\n    struct flock lock;\n    memset(&lock, 0, sizeof(lock));\n    lock.l_type = F_WRLCK;\n    lock.l_whence = SEEK_SET;\n    lock.l_start = 0;\n    lock.l_len = 0;  // entire file\n    KJ_SYSCALL(fcntl(pidfile, F_GETLK, &lock));\n\n    if (lock.l_type == F_UNLCK) {\n      return nullptr;\n    }\n\n    // The pidfile is locked, therefore someone is using it.\n    pid_t lockingPid = lock.l_pid;\n\n    // Let's also read the content of the file and make sure it matches.\n    pid_t pidfilePid;\n    KJ_IF_MAYBE(p, parseUInt(trim(readAll(pidfile)), 10)) {\n      pidfilePid = *p;\n    } else {\n      pidfilePid = -1;\n    }",
          "note": "cyclic_reference_detected"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::Maybe<pid_t> getRunningPid() {\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      return getRunningPid(*pf);\n    } else {\n      return nullptr;\n    }\n  }"
  },
  {
    "function_name": "openPidfile",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1230-1246",
    "snippet": "kj::Maybe<kj::AutoCloseFd> openPidfile() {\n    KJ_REQUIRE(changedDir);\n    if (access(\"../var/pid\", R_OK) < 0) {\n      if (access(\"../var/pid\", F_OK) < 0) {\n        KJ_FAIL_REQUIRE(\"$SANDSTORM_HOME/var/pid doesn't exist?\");\n      } else {\n        KJ_FAIL_REQUIRE(\n            \"You do not have permission to read the pidfile directory. Perhaps your \"\n            \"user account is not a member of the server's group?\");\n      }\n    }\n    kj::StringPtr pidfileName = \"../var/pid/sandstorm.pid\";\n    if (access(pidfileName.cStr(), F_OK) < 0) {\n      return nullptr;\n    }\n    return raiiOpen(pidfileName, O_RDWR);\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;",
      "bool changedDir = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "pidfileName",
            "O_RDWR"
          ],
          "line": 1245
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "pidfileName.cStr()",
            "F_OK"
          ],
          "line": 1242
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pidfileName.cStr",
          "args": [],
          "line": 1242
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_REQUIRE",
          "args": [
            "\"You do not have permission to read the pidfile directory. Perhaps your \"\n            \"user account is not a member of the server's group?\""
          ],
          "line": 1236
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_REQUIRE",
          "args": [
            "\"$SANDSTORM_HOME/var/pid doesn't exist?\""
          ],
          "line": 1234
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"../var/pid\"",
            "F_OK"
          ],
          "line": 1233
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"../var/pid\"",
            "R_OK"
          ],
          "line": 1232
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "changedDir"
          ],
          "line": 1231
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool changedDir = false;\n\nkj::Maybe<kj::AutoCloseFd> openPidfile() {\n    KJ_REQUIRE(changedDir);\n    if (access(\"../var/pid\", R_OK) < 0) {\n      if (access(\"../var/pid\", F_OK) < 0) {\n        KJ_FAIL_REQUIRE(\"$SANDSTORM_HOME/var/pid doesn't exist?\");\n      } else {\n        KJ_FAIL_REQUIRE(\n            \"You do not have permission to read the pidfile directory. Perhaps your \"\n            \"user account is not a member of the server's group?\");\n      }\n    }\n    kj::StringPtr pidfileName = \"../var/pid/sandstorm.pid\";\n    if (access(pidfileName.cStr(), F_OK) < 0) {\n      return nullptr;\n    }\n    return raiiOpen(pidfileName, O_RDWR);\n  }"
  },
  {
    "function_name": "checkOwnedByRoot",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1216-1228",
    "snippet": "void checkOwnedByRoot(kj::StringPtr path, kj::StringPtr title) {\n    if (access(path.cStr(), F_OK) != 0) {\n      context.exitError(kj::str(title, \" not found.\"));\n    }\n\n    if (runningAsRoot) {\n      struct stat stats;\n      KJ_SYSCALL(stat(path.cStr(), &stats));\n      if (stats.st_uid != 0) {\n        context.exitError(kj::str(title, \" not owned by root, but you're running as root.\"));\n      }\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool runningAsRoot = getuid() == 0;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exitError",
          "args": [
            "kj::str(title, \" not owned by root, but you're running as root.\")"
          ],
          "line": 1225
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "title",
            "\" not owned by root, but you're running as root.\""
          ],
          "line": 1225
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "stat(path.cStr(), &stats)"
          ],
          "line": 1223
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stat",
          "args": [
            "path.cStr()",
            "&stats"
          ],
          "line": 1223
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.cStr",
          "args": [],
          "line": 1223
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitError",
          "args": [
            "kj::str(title, \" not found.\")"
          ],
          "line": 1218
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "title",
            "\" not found.\""
          ],
          "line": 1218
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "path.cStr()",
            "F_OK"
          ],
          "line": 1217
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.cStr",
          "args": [],
          "line": 1217
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\n\nvoid checkOwnedByRoot(kj::StringPtr path, kj::StringPtr title) {\n    if (access(path.cStr(), F_OK) != 0) {\n      context.exitError(kj::str(title, \" not found.\"));\n    }\n\n    if (runningAsRoot) {\n      struct stat stats;\n      KJ_SYSCALL(stat(path.cStr(), &stats));\n      if (stats.st_uid != 0) {\n        context.exitError(kj::str(title, \" not owned by root, but you're running as root.\"));\n      }\n    }\n  }"
  },
  {
    "function_name": "checkAccess",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1203-1214",
    "snippet": "void checkAccess() {\n    KJ_ASSERT(changedDir);\n    if (access(\"../var/sandstorm\", W_OK) == -1) {\n      if (errno == EACCES) {\n        KJ_FAIL_REQUIRE(\n            \"Sandstorm was not run with appropriate privileges; rerun as root or the user for \"\n            \"which it was installed.\");\n      } else {\n        KJ_FAIL_SYSCALL(\"access\", errno);\n      }\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool changedDir = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"access\"",
            "errno"
          ],
          "line": 1211
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_REQUIRE",
          "args": [
            "\"Sandstorm was not run with appropriate privileges; rerun as root or the user for \"\n            \"which it was installed.\""
          ],
          "line": 1207
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"../var/sandstorm\"",
            "W_OK"
          ],
          "line": 1205
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "changedDir"
          ],
          "line": 1204
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid checkAccess() {\n    KJ_ASSERT(changedDir);\n    if (access(\"../var/sandstorm\", W_OK) == -1) {\n      if (errno == EACCES) {\n        KJ_FAIL_REQUIRE(\n            \"Sandstorm was not run with appropriate privileges; rerun as root or the user for \"\n            \"which it was installed.\");\n      } else {\n        KJ_FAIL_SYSCALL(\"access\", errno);\n      }\n    }\n  }"
  },
  {
    "function_name": "changeToInstallDir",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1198-1201",
    "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool changedDir = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chdir(getInstallDir().cStr())"
          ],
          "line": 1199
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chdir",
          "args": [
            "getInstallDir().cStr()"
          ],
          "line": 1199
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getInstallDir",
          "args": [],
          "line": 1199
        },
        "resolved": true,
        "details": {
          "function_name": "getInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1189-1196",
          "snippet": "kj::String getInstallDir() {\n    char exeNameBuf[PATH_MAX + 1];\n    size_t len;\n    KJ_SYSCALL(len = readlink(\"/proc/self/exe\", exeNameBuf, sizeof(exeNameBuf) - 1));\n    exeNameBuf[len] = '\\0';\n    kj::StringPtr exeName(exeNameBuf, len);\n    return kj::heapString(exeName.slice(0, KJ_ASSERT_NONNULL(exeName.findLast('/'))));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::String getInstallDir() {\n    char exeNameBuf[PATH_MAX + 1];\n    size_t len;\n    KJ_SYSCALL(len = readlink(\"/proc/self/exe\", exeNameBuf, sizeof(exeNameBuf) - 1));\n    exeNameBuf[len] = '\\0';\n    kj::StringPtr exeName(exeNameBuf, len);\n    return kj::heapString(exeName.slice(0, KJ_ASSERT_NONNULL(exeName.findLast('/'))));\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
  },
  {
    "function_name": "getInstallDir",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1189-1196",
    "snippet": "kj::String getInstallDir() {\n    char exeNameBuf[PATH_MAX + 1];\n    size_t len;\n    KJ_SYSCALL(len = readlink(\"/proc/self/exe\", exeNameBuf, sizeof(exeNameBuf) - 1));\n    exeNameBuf[len] = '\\0';\n    kj::StringPtr exeName(exeNameBuf, len);\n    return kj::heapString(exeName.slice(0, KJ_ASSERT_NONNULL(exeName.findLast('/'))));\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "exeName.slice(0, KJ_ASSERT_NONNULL(exeName.findLast('/')))"
          ],
          "line": 1195
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "exeName.slice",
          "args": [
            "0",
            "KJ_ASSERT_NONNULL(exeName.findLast('/'))"
          ],
          "line": 1195
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT_NONNULL",
          "args": [
            "exeName.findLast('/')"
          ],
          "line": 1195
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "exeName.findLast",
          "args": [
            "'/'"
          ],
          "line": 1195
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "len = readlink(\"/proc/self/exe\", exeNameBuf, sizeof(exeNameBuf) - 1)"
          ],
          "line": 1192
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "readlink",
          "args": [
            "\"/proc/self/exe\"",
            "exeNameBuf",
            "sizeof(exeNameBuf) - 1"
          ],
          "line": 1192
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::String getInstallDir() {\n    char exeNameBuf[PATH_MAX + 1];\n    size_t len;\n    KJ_SYSCALL(len = readlink(\"/proc/self/exe\", exeNameBuf, sizeof(exeNameBuf) - 1));\n    exeNameBuf[len] = '\\0';\n    kj::StringPtr exeName(exeNameBuf, len);\n    return kj::heapString(exeName.slice(0, KJ_ASSERT_NONNULL(exeName.findLast('/'))));\n  }"
  },
  {
    "function_name": "dev",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "1123-1149",
    "snippet": "kj::MainBuilder::Validity dev() {\n    // When called by the spk tool, stdout is a socket where we will send the fuse FD.\n    struct stat stats;\n    KJ_SYSCALL(fstat(STDOUT_FILENO, &stats));\n    if (!S_ISSOCK(stats.st_mode)) {\n      return \"This command is for internal use only.\";\n    }\n\n    changeToInstallDir();\n\n    // Verify that Sandstorm is running.\n    if (getRunningPid() == nullptr) {\n      context.exitError(\"Sandstorm is not running.\");\n    }\n\n    // Connect to the devmode socket. The server daemon listens on this socket for commands.\n    // See `runDevDaemon()`.\n    auto sock = connectToDevDaemon();\n\n    // Send the command code.\n    kj::FdOutputStream((int)sock).write(&DEVMODE_COMMAND_CONNECT, 1);\n\n    // Send our \"stdout\" (which is actually a socket) to the devmode server.\n    sendFd(sock, STDOUT_FILENO);\n\n    return true;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static constexpr kj::byte DEVMODE_COMMAND_CONNECT = 1;",
      "constexpr kj::byte RunBundleMain::DEVMODE_COMMAND_CONNECT;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "sendFd",
          "args": [
            "sock",
            "STDOUT_FILENO"
          ],
          "line": 1146
        },
        "resolved": true,
        "details": {
          "function_name": "sendFd",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/send-fd.c++",
          "lines": "24-53",
          "snippet": "void sendFd(int sendOn, int fdToSend) {\n  // Sends the fd over the given socket. A NUL byte is also sent, because at least one byte\n  // must be written along with the FD.\n\n  struct msghdr msg;\n  struct iovec iov;\n  union {\n    struct cmsghdr cmsg;\n    char cmsgSpace[CMSG_LEN(sizeof(int))];\n  };\n  memset(&msg, 0, sizeof(msg));\n  memset(&iov, 0, sizeof(iov));\n  memset(cmsgSpace, 0, sizeof(cmsgSpace));\n\n  char c = 0;\n  iov.iov_base = &c;\n  iov.iov_len = 1;\n  msg.msg_iov = &iov;\n  msg.msg_iovlen = 1;\n\n  msg.msg_control = &cmsg;\n  msg.msg_controllen = sizeof(cmsgSpace);\n\n  cmsg.cmsg_len = sizeof(cmsgSpace);\n  cmsg.cmsg_level = SOL_SOCKET;\n  cmsg.cmsg_type = SCM_RIGHTS;\n  *reinterpret_cast<int*>(CMSG_DATA(&cmsg)) = fdToSend;\n\n  KJ_SYSCALL(sendmsg(sendOn, &msg, 0));\n}",
          "includes": [
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <kj/debug.h>",
            "#include \"send-fd.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/un.h>\n#include <sys/socket.h>\n#include <kj/debug.h>\n#include \"send-fd.h\"\n\nvoid sendFd(int sendOn, int fdToSend) {\n  // Sends the fd over the given socket. A NUL byte is also sent, because at least one byte\n  // must be written along with the FD.\n\n  struct msghdr msg;\n  struct iovec iov;\n  union {\n    struct cmsghdr cmsg;\n    char cmsgSpace[CMSG_LEN(sizeof(int))];\n  };\n  memset(&msg, 0, sizeof(msg));\n  memset(&iov, 0, sizeof(iov));\n  memset(cmsgSpace, 0, sizeof(cmsgSpace));\n\n  char c = 0;\n  iov.iov_base = &c;\n  iov.iov_len = 1;\n  msg.msg_iov = &iov;\n  msg.msg_iovlen = 1;\n\n  msg.msg_control = &cmsg;\n  msg.msg_controllen = sizeof(cmsgSpace);\n\n  cmsg.cmsg_len = sizeof(cmsgSpace);\n  cmsg.cmsg_level = SOL_SOCKET;\n  cmsg.cmsg_type = SCM_RIGHTS;\n  *reinterpret_cast<int*>(CMSG_DATA(&cmsg)) = fdToSend;\n\n  KJ_SYSCALL(sendmsg(sendOn, &msg, 0));\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "&DEVMODE_COMMAND_CONNECT",
            "1"
          ],
          "line": 1143
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "(int)sock"
          ],
          "line": 1143
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "connectToDevDaemon",
          "args": [],
          "line": 1140
        },
        "resolved": true,
        "details": {
          "function_name": "connectToDevDaemon",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2691-2703",
          "snippet": "kj::AutoCloseFd connectToDevDaemon() {\n    int sock_;\n    KJ_SYSCALL(sock_ = socket(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0));\n    auto sock = kj::AutoCloseFd(sock_);\n\n    struct sockaddr_un addr;\n    memset(&addr, 0, sizeof(addr));\n    addr.sun_family = AF_UNIX;\n    strcpy(addr.sun_path, \"../var/sandstorm/socket/devmode\");\n    KJ_SYSCALL(connect(sock, reinterpret_cast<struct sockaddr*>(&addr), sizeof(addr)));\n\n    return kj::mv(sock);\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::AutoCloseFd connectToDevDaemon() {\n    int sock_;\n    KJ_SYSCALL(sock_ = socket(AF_UNIX, SOCK_STREAM | SOCK_CLOEXEC, 0));\n    auto sock = kj::AutoCloseFd(sock_);\n\n    struct sockaddr_un addr;\n    memset(&addr, 0, sizeof(addr));\n    addr.sun_family = AF_UNIX;\n    strcpy(addr.sun_path, \"../var/sandstorm/socket/devmode\");\n    KJ_SYSCALL(connect(sock, reinterpret_cast<struct sockaddr*>(&addr), sizeof(addr)));\n\n    return kj::mv(sock);\n  }"
        }
      },
      {
        "call_info": {
          "callee": "context.exitError",
          "args": [
            "\"Sandstorm is not running.\""
          ],
          "line": 1135
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getRunningPid",
          "args": [],
          "line": 1134
        },
        "resolved": true,
        "details": {
          "function_name": "getRunningPid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1248-1254",
          "snippet": "kj::Maybe<pid_t> getRunningPid() {\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      return getRunningPid(*pf);\n    } else {\n      return nullptr;\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::Maybe<pid_t> getRunningPid() {\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      return getRunningPid(*pf);\n    } else {\n      return nullptr;\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 1131
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "S_ISSOCK",
          "args": [
            "stats.st_mode"
          ],
          "line": 1127
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fstat(STDOUT_FILENO, &stats)"
          ],
          "line": 1126
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fstat",
          "args": [
            "STDOUT_FILENO",
            "&stats"
          ],
          "line": 1126
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nstatic constexpr kj::byte DEVMODE_COMMAND_CONNECT = 1;\nconstexpr kj::byte RunBundleMain::DEVMODE_COMMAND_CONNECT;\n\nkj::MainBuilder::Validity dev() {\n    // When called by the spk tool, stdout is a socket where we will send the fuse FD.\n    struct stat stats;\n    KJ_SYSCALL(fstat(STDOUT_FILENO, &stats));\n    if (!S_ISSOCK(stats.st_mode)) {\n      return \"This command is for internal use only.\";\n    }\n\n    changeToInstallDir();\n\n    // Verify that Sandstorm is running.\n    if (getRunningPid() == nullptr) {\n      context.exitError(\"Sandstorm is not running.\");\n    }\n\n    // Connect to the devmode socket. The server daemon listens on this socket for commands.\n    // See `runDevDaemon()`.\n    auto sock = connectToDevDaemon();\n\n    // Send the command code.\n    kj::FdOutputStream((int)sock).write(&DEVMODE_COMMAND_CONNECT, 1);\n\n    // Send our \"stdout\" (which is actually a socket) to the devmode server.\n    sendFd(sock, STDOUT_FILENO);\n\n    return true;\n  }"
  },
  {
    "function_name": "uninstall",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "984-1121",
    "snippet": "kj::MainBuilder::Validity uninstall() {\n    auto bundleDir = getInstallDir();\n    auto sandstormHome = kj::str(bundleDir.slice(0, KJ_ASSERT_NONNULL(bundleDir.findLast('/'))));\n\n    changeToInstallDir();\n    checkAccess();\n\n    // Make sure server is stopped.\n    if (doStop()) {\n      context.warning(\"Sandstorm stopped.\");\n    } else {\n      context.warning(\"Sandstorm is not running.\");\n    }\n\n    KJ_SYSCALL(chdir(sandstormHome.cStr()));\n\n    // Make extra-sure we're in a Sandstorm directory.\n    KJ_ASSERT(access(\"sandstorm\", F_OK) >= 0 &&\n              access(\"sandstorm.conf\", F_OK) >= 0 &&\n              access(\"latest\", F_OK) >= 0 &&\n              sandstormHome != \"/\" &&\n              sandstormHome != \"/usr\",\n              \"uninstaller is confused; bailing out to avoid doing any damage\", sandstormHome);\n\n    bool hasCustomUser = fileHasLine(\"sandstorm.conf\", \"SERVER_USER=sandstorm\");\n\n    // Delete Sandstorm bundles.\n    context.warning(\"Deleting installed Sandstorm bundles...\");\n    static const kj::StringPtr BUNDLE_PREFIX = \"sandstorm-\";\n    for (auto& file: listDirectory(\".\")) {\n      if (file.startsWith(BUNDLE_PREFIX)) {\n        auto suffix = file.slice(BUNDLE_PREFIX.size());\n        if (parseUInt(suffix, 10) != nullptr || suffix.startsWith(\"custom.\")) {\n          // Delete bundle.\n          recursivelyDelete(file);\n        }\n      }\n    }\n\n    // Delete symlinks.\n    KJ_SYSCALL(unlink(\"sandstorm\"));\n    KJ_SYSCALL(unlink(\"latest\"));\n\n    if (access(\"tmp\", F_OK) >= 0) {\n      // Delete tmp since it's obviously not needed.\n      context.warning(\"Deleting temporary files...\");\n      recursivelyDelete(\"tmp\");\n    }\n\n    if (access(\"var\", F_OK) >= 0) {\n      if (deleteUserData) {\n        // User wants to delete their user data... OK then.\n        context.warning(\"Deleting user data (per your request)...\");\n        recursivelyDelete(\"var\");\n        KJ_SYSCALL(unlink(\"sandstorm.conf\"));\n      } else {\n        context.warning(kj::str(\"NOT deleting user data. Left at: \", sandstormHome, \"/var\"));\n      }\n    }\n\n    if (runningAsRoot) {\n      // Delete system-installed stuff. Be careful to verify that these files actually point at\n      // the installation of Sandstorm that we're removing, not some other installation that might\n      // be present on the machine.\n\n      bool seemsLikePrimarySandstorm = false;\n\n      // Remove `sandstorm` and `spk` command prefixes. Note that for historical reasons there are\n      // a few different places these might point, so we only check that they point somewhere under\n      // our Sandstorm install directory.\n      auto symlinkTargetPrefix = kj::str(sandstormHome, \"/\");\n\n      static const kj::StringPtr SANDSTORM_SYMLINK = \"/usr/local/bin/sandstorm\";\n      if (symlinkPointsInto(SANDSTORM_SYMLINK, symlinkTargetPrefix)) {\n        context.warning(\"Removing sandstorm command...\");\n        KJ_SYSCALL(unlink(SANDSTORM_SYMLINK.cStr()));\n        seemsLikePrimarySandstorm = true;\n      }\n\n      static const kj::StringPtr SPK_SYMLINK = \"/usr/local/bin/spk\";\n      if (symlinkPointsInto(SPK_SYMLINK, symlinkTargetPrefix)) {\n        context.warning(\"Removing spk command...\");\n        KJ_SYSCALL(unlink(SPK_SYMLINK.cStr()));\n      }\n\n      // SysV initscript. Remove if it inits this Sandstorm installation.\n      static const kj::StringPtr INITSCRIPT_FILE = \"/etc/init.d/sandstorm\";\n      auto initscriptLine = kj::str(\"DAEMON=\", sandstormHome, \"/sandstorm\");\n      if (fileHasLine(INITSCRIPT_FILE, initscriptLine)) {\n        context.warning(\"Removing SysV initscript...\");\n        KJ_SYSCALL(unlink(INITSCRIPT_FILE.cStr()));\n        system(\"update-rc.d sandstorm remove\");\n      }\n\n      // systemd service file. Remove if it inits this Sandstorm installation.\n      static const kj::StringPtr SYSTEMD_FILE = \"/etc/systemd/system/sandstorm.service\";\n      auto systemdLine = kj::str(\"ExecStart=\", sandstormHome, \"/sandstorm start\");\n      if (fileHasLine(SYSTEMD_FILE, systemdLine)) {\n        context.warning(\"Removing systemd service...\");\n        system(\"systemctl disable sandstorm.service\");\n        KJ_SYSCALL(unlink(SYSTEMD_FILE.cStr()));\n        system(\"systemctl daemon-reload\");\n      }\n\n      if (seemsLikePrimarySandstorm) {\n        // Remove the sysctl modifications. Unfortunately this will break any other Sandstorm\n        // installations on the server, but it _looks_ like we're removing the primary\n        // installation.\n        kj::StringPtr SYSCTL_CONF = \"/etc/sysctl.d/50-sandstorm.conf\";\n        if (access(SYSCTL_CONF.cStr(), F_OK) >= 0) {\n          context.warning(\"Removing sysctl modifications...\");\n          unlink(SYSCTL_CONF.cStr());\n        }\n\n        // Also check if the non-sysctl.d sysctl.conf was modified.\n        if (fileHasLine(\"/etc/sysctl.conf\",\n            \"# Enable non-root users to create sandboxes (needed by Sandstorm).\")) {\n          context.warning(\"WARNING: /etc/sysctl.conf was modified by Sandstorm. Please edit \"\n                          \"it manually if you wish to undo these changes.\");\n        }\n\n        if (hasCustomUser) {\n          context.warning(\"WARNING: A user account and group named 'sandstorm' were created to \"\n                          \"run the server. You may want to delete these manually if they are no \"\n                          \"longer needed. On most systems you can use these commands:\\n\\n\"\n                          \"  userdel sandstorm\\n\"\n                          \"  groupdel sandstorm\");\n        }\n      }\n    }\n\n    // Attempt to remove the Sandstorm home directory. This will fail if it isn't empty, but that's\n    // fine.\n    KJ_SYSCALL(chdir(\"/\"));  // Can't delete directory if we're in it.\n    rmdir(sandstormHome.cStr());\n\n    context.exitInfo(\"Sandstorm has been uninstalled.\");\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool runningAsRoot = getuid() == 0;",
      "bool deleteUserData = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "\"Sandstorm has been uninstalled.\""
          ],
          "line": 1120
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rmdir",
          "args": [
            "sandstormHome.cStr()"
          ],
          "line": 1118
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sandstormHome.cStr",
          "args": [],
          "line": 1118
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chdir(\"/\")"
          ],
          "line": 1117
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chdir",
          "args": [
            "\"/\""
          ],
          "line": 1117
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"WARNING: A user account and group named 'sandstorm' were created to \"\n                          \"run the server. You may want to delete these manually if they are no \"\n                          \"longer needed. On most systems you can use these commands:\\n\\n\"\n                          \"  userdel sandstorm\\n\"\n                          \"  groupdel sandstorm\""
          ],
          "line": 1106
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"WARNING: /etc/sysctl.conf was modified by Sandstorm. Please edit \"\n                          \"it manually if you wish to undo these changes.\""
          ],
          "line": 1101
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fileHasLine",
          "args": [
            "\"/etc/sysctl.conf\"",
            "\"# Enable non-root users to create sandboxes (needed by Sandstorm).\""
          ],
          "line": 1099
        },
        "resolved": true,
        "details": {
          "function_name": "fileHasLine",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "126-141",
          "snippet": "static bool fileHasLine(kj::StringPtr filename, kj::StringPtr expectedLine) {\n  // Returns true if the given text file contains a line matching exactly the given string.\n  auto file = raiiOpenIfExists(filename, O_RDONLY | O_CLOEXEC);\n  KJ_IF_MAYBE(f, file) {\n    for (auto& line: splitLines(readAll(*f))) {\n      if (line == expectedLine) {\n        return true;\n      }\n    }\n    // File doesn't contain line.\n    return false;\n  } else {\n    // File doesn't exist at all.\n    return false;\n  }\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nstatic bool fileHasLine(kj::StringPtr filename, kj::StringPtr expectedLine) {\n  // Returns true if the given text file contains a line matching exactly the given string.\n  auto file = raiiOpenIfExists(filename, O_RDONLY | O_CLOEXEC);\n  KJ_IF_MAYBE(f, file) {\n    for (auto& line: splitLines(readAll(*f))) {\n      if (line == expectedLine) {\n        return true;\n      }\n    }\n    // File doesn't contain line.\n    return false;\n  } else {\n    // File doesn't exist at all.\n    return false;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "SYSCTL_CONF.cStr()"
          ],
          "line": 1095
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "SYSCTL_CONF.cStr",
          "args": [],
          "line": 1095
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Removing sysctl modifications...\""
          ],
          "line": 1094
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "SYSCTL_CONF.cStr()",
            "F_OK"
          ],
          "line": 1093
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "SYSCTL_CONF.cStr",
          "args": [],
          "line": 1093
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "system",
          "args": [
            "\"systemctl daemon-reload\""
          ],
          "line": 1085
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unlink(SYSTEMD_FILE.cStr())"
          ],
          "line": 1084
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "SYSTEMD_FILE.cStr()"
          ],
          "line": 1084
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "SYSTEMD_FILE.cStr",
          "args": [],
          "line": 1084
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "system",
          "args": [
            "\"systemctl disable sandstorm.service\""
          ],
          "line": 1083
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Removing systemd service...\""
          ],
          "line": 1082
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"ExecStart=\"",
            "sandstormHome",
            "\"/sandstorm start\""
          ],
          "line": 1080
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "system",
          "args": [
            "\"update-rc.d sandstorm remove\""
          ],
          "line": 1075
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unlink(INITSCRIPT_FILE.cStr())"
          ],
          "line": 1074
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "INITSCRIPT_FILE.cStr()"
          ],
          "line": 1074
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "INITSCRIPT_FILE.cStr",
          "args": [],
          "line": 1074
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Removing SysV initscript...\""
          ],
          "line": 1073
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"DAEMON=\"",
            "sandstormHome",
            "\"/sandstorm\""
          ],
          "line": 1071
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unlink(SPK_SYMLINK.cStr())"
          ],
          "line": 1066
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "SPK_SYMLINK.cStr()"
          ],
          "line": 1066
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "SPK_SYMLINK.cStr",
          "args": [],
          "line": 1066
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Removing spk command...\""
          ],
          "line": 1065
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "symlinkPointsInto",
          "args": [
            "SPK_SYMLINK",
            "symlinkTargetPrefix"
          ],
          "line": 1064
        },
        "resolved": true,
        "details": {
          "function_name": "symlinkPointsInto",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "101-124",
          "snippet": "static bool symlinkPointsInto(kj::StringPtr symlink, kj::StringPtr targetPrefix) {\n  // Returns true if the given path names a symlink whose target has the given prefix, false if\n  // it points elsewhere or doesn't exist or isn't a symlink.\nretry:\n  char buffer[PATH_MAX];\n  ssize_t n = readlink(symlink.cStr(), buffer, sizeof(buffer) - 1);\n  if (n < 0) {\n    int error = errno;\n    switch (error) {\n      case ENOENT:\n      case ENOTDIR:\n      case EINVAL:\n        // File (or parent directory) dosen't exist or isn't a symlink.\n        return false;\n      case EINTR:\n        goto retry;\n      default:\n        KJ_FAIL_SYSCALL(\"readlink(symlink)\", error, symlink);\n    }\n  } else {\n    buffer[n] = '\\0';\n    return kj::StringPtr(buffer, n).startsWith(targetPrefix);\n  }\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nstatic bool symlinkPointsInto(kj::StringPtr symlink, kj::StringPtr targetPrefix) {\n  // Returns true if the given path names a symlink whose target has the given prefix, false if\n  // it points elsewhere or doesn't exist or isn't a symlink.\nretry:\n  char buffer[PATH_MAX];\n  ssize_t n = readlink(symlink.cStr(), buffer, sizeof(buffer) - 1);\n  if (n < 0) {\n    int error = errno;\n    switch (error) {\n      case ENOENT:\n      case ENOTDIR:\n      case EINVAL:\n        // File (or parent directory) dosen't exist or isn't a symlink.\n        return false;\n      case EINTR:\n        goto retry;\n      default:\n        KJ_FAIL_SYSCALL(\"readlink(symlink)\", error, symlink);\n    }\n  } else {\n    buffer[n] = '\\0';\n    return kj::StringPtr(buffer, n).startsWith(targetPrefix);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unlink(SANDSTORM_SYMLINK.cStr())"
          ],
          "line": 1059
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "SANDSTORM_SYMLINK.cStr()"
          ],
          "line": 1059
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "SANDSTORM_SYMLINK.cStr",
          "args": [],
          "line": 1059
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Removing sandstorm command...\""
          ],
          "line": 1058
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "sandstormHome",
            "\"/\""
          ],
          "line": 1054
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\"NOT deleting user data. Left at: \", sandstormHome, \"/var\")"
          ],
          "line": 1040
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"NOT deleting user data. Left at: \"",
            "sandstormHome",
            "\"/var\""
          ],
          "line": 1040
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unlink(\"sandstorm.conf\")"
          ],
          "line": 1038
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "\"sandstorm.conf\""
          ],
          "line": 1038
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "recursivelyDelete",
          "args": [
            "\"var\""
          ],
          "line": 1037
        },
        "resolved": true,
        "details": {
          "function_name": "recursivelyDelete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "299-313",
          "snippet": "void recursivelyDelete(kj::StringPtr path) {\n  KJ_REQUIRE(!path.endsWith(\"/\"),\n      \"refusing to recursively delete directory name with trailing / to reduce risk of \"\n      \"catastrophic empty-string bugs\");\n  struct stat stats;\n  KJ_SYSCALL(lstat(path.cStr(), &stats), path) { return; }\n  if (S_ISDIR(stats.st_mode)) {\n    for (auto& file: listDirectory(path)) {\n      recursivelyDelete(kj::str(path, \"/\", file));\n    }\n    KJ_SYSCALL(rmdir(path.cStr()), path) { break; }\n  } else {\n    KJ_SYSCALL(unlink(path.cStr()), path) { break; }\n  }\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nvoid recursivelyDelete(kj::StringPtr path) {\n  KJ_REQUIRE(!path.endsWith(\"/\"),\n      \"refusing to recursively delete directory name with trailing / to reduce risk of \"\n      \"catastrophic empty-string bugs\");\n  struct stat stats;\n  KJ_SYSCALL(lstat(path.cStr(), &stats), path) { return; }\n  if (S_ISDIR(stats.st_mode)) {\n    for (auto& file: listDirectory(path)) {\n      recursivelyDelete(kj::str(path, \"/\", file));\n    }\n    KJ_SYSCALL(rmdir(path.cStr()), path) { break; }\n  } else {\n    KJ_SYSCALL(unlink(path.cStr()), path) { break; }\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Deleting user data (per your request)...\""
          ],
          "line": 1036
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"var\"",
            "F_OK"
          ],
          "line": 1033
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Deleting temporary files...\""
          ],
          "line": 1029
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"tmp\"",
            "F_OK"
          ],
          "line": 1027
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unlink(\"latest\")"
          ],
          "line": 1025
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "\"latest\""
          ],
          "line": 1025
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unlink(\"sandstorm\")"
          ],
          "line": 1024
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "\"sandstorm\""
          ],
          "line": 1024
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "suffix.startsWith",
          "args": [
            "\"custom.\""
          ],
          "line": 1016
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "parseUInt",
          "args": [
            "suffix",
            "10"
          ],
          "line": 1016
        },
        "resolved": true,
        "details": {
          "function_name": "parseUInt64",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "223-230",
          "snippet": "kj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "file.slice",
          "args": [
            "BUNDLE_PREFIX.size()"
          ],
          "line": 1015
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "BUNDLE_PREFIX.size",
          "args": [],
          "line": 1015
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "file.startsWith",
          "args": [
            "BUNDLE_PREFIX"
          ],
          "line": 1014
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "listDirectory",
          "args": [
            "\".\""
          ],
          "line": 1013
        },
        "resolved": true,
        "details": {
          "function_name": "listDirectoryFd",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "292-297",
          "snippet": "kj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Deleting installed Sandstorm bundles...\""
          ],
          "line": 1011
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "access(\"sandstorm\", F_OK) >= 0 &&\n              access(\"sandstorm.conf\", F_OK) >= 0 &&\n              access(\"latest\", F_OK) >= 0 &&\n              sandstormHome != \"/\" &&\n              sandstormHome != \"/usr\"",
            "\"uninstaller is confused; bailing out to avoid doing any damage\"",
            "sandstormHome"
          ],
          "line": 1001
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"latest\"",
            "F_OK"
          ],
          "line": 1003
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"sandstorm.conf\"",
            "F_OK"
          ],
          "line": 1002
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "\"sandstorm\"",
            "F_OK"
          ],
          "line": 1001
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "chdir(sandstormHome.cStr())"
          ],
          "line": 998
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chdir",
          "args": [
            "sandstormHome.cStr()"
          ],
          "line": 998
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sandstormHome.cStr",
          "args": [],
          "line": 998
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Sandstorm is not running.\""
          ],
          "line": 995
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "\"Sandstorm stopped.\""
          ],
          "line": 993
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "doStop",
          "args": [],
          "line": 992
        },
        "resolved": true,
        "details": {
          "function_name": "doStop",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "771-829",
          "snippet": "bool doStop() {\n    // Stop Sandstorm. Don't return until it's stopped. Returns false if it wasn't running to start\n    // with.\n    KJ_ASSERT(changedDir);\n\n    registerAlarmHandler();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      return false;\n    }\n\n    pid_t pid;\n    KJ_IF_MAYBE(p, getRunningPid(pidfile)) {\n      pid = *p;\n    } else {\n      return false;\n    }\n\n    context.warning(kj::str(\"Waiting for PID \", pid, \" to terminate...\"));\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    // Timeout if not dead within 10 seconds.\n    uint timeout = 10;\n    KJ_SYSCALL(alarm(timeout));\n\n    // Take write lock on pidfile as a way to wait for exit.\n    struct flock lock;\n    memset(&lock, 0, sizeof(lock));\n    lock.l_type = F_WRLCK;\n    lock.l_whence = SEEK_SET;\n    lock.l_start = 0;\n    lock.l_len = 0;  // entire file\n\n    for (;;) {\n      if (fcntl(pidfile, F_SETLKW, &lock) >= 0) {\n        // Success.\n        break;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          context.warning(kj::str(\"Did not terminate after \", timeout, \" seconds; killing...\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Ignore signal.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLKW)\", error);\n      }\n    }\n\n    KJ_SYSCALL(alarm(0));\n    return true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;",
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool changedDir = false;\n\nbool doStop() {\n    // Stop Sandstorm. Don't return until it's stopped. Returns false if it wasn't running to start\n    // with.\n    KJ_ASSERT(changedDir);\n\n    registerAlarmHandler();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      return false;\n    }\n\n    pid_t pid;\n    KJ_IF_MAYBE(p, getRunningPid(pidfile)) {\n      pid = *p;\n    } else {\n      return false;\n    }\n\n    context.warning(kj::str(\"Waiting for PID \", pid, \" to terminate...\"));\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    // Timeout if not dead within 10 seconds.\n    uint timeout = 10;\n    KJ_SYSCALL(alarm(timeout));\n\n    // Take write lock on pidfile as a way to wait for exit.\n    struct flock lock;\n    memset(&lock, 0, sizeof(lock));\n    lock.l_type = F_WRLCK;\n    lock.l_whence = SEEK_SET;\n    lock.l_start = 0;\n    lock.l_len = 0;  // entire file\n\n    for (;;) {\n      if (fcntl(pidfile, F_SETLKW, &lock) >= 0) {\n        // Success.\n        break;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          context.warning(kj::str(\"Did not terminate after \", timeout, \" seconds; killing...\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Ignore signal.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLKW)\", error);\n      }\n    }\n\n    KJ_SYSCALL(alarm(0));\n    return true;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "checkAccess",
          "args": [],
          "line": 989
        },
        "resolved": true,
        "details": {
          "function_name": "checkAccess",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1203-1214",
          "snippet": "void checkAccess() {\n    KJ_ASSERT(changedDir);\n    if (access(\"../var/sandstorm\", W_OK) == -1) {\n      if (errno == EACCES) {\n        KJ_FAIL_REQUIRE(\n            \"Sandstorm was not run with appropriate privileges; rerun as root or the user for \"\n            \"which it was installed.\");\n      } else {\n        KJ_FAIL_SYSCALL(\"access\", errno);\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid checkAccess() {\n    KJ_ASSERT(changedDir);\n    if (access(\"../var/sandstorm\", W_OK) == -1) {\n      if (errno == EACCES) {\n        KJ_FAIL_REQUIRE(\n            \"Sandstorm was not run with appropriate privileges; rerun as root or the user for \"\n            \"which it was installed.\");\n      } else {\n        KJ_FAIL_SYSCALL(\"access\", errno);\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 988
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "bundleDir.slice(0, KJ_ASSERT_NONNULL(bundleDir.findLast('/')))"
          ],
          "line": 986
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bundleDir.slice",
          "args": [
            "0",
            "KJ_ASSERT_NONNULL(bundleDir.findLast('/'))"
          ],
          "line": 986
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT_NONNULL",
          "args": [
            "bundleDir.findLast('/')"
          ],
          "line": 986
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bundleDir.findLast",
          "args": [
            "'/'"
          ],
          "line": 986
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getInstallDir",
          "args": [],
          "line": 985
        },
        "resolved": true,
        "details": {
          "function_name": "getInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1189-1196",
          "snippet": "kj::String getInstallDir() {\n    char exeNameBuf[PATH_MAX + 1];\n    size_t len;\n    KJ_SYSCALL(len = readlink(\"/proc/self/exe\", exeNameBuf, sizeof(exeNameBuf) - 1));\n    exeNameBuf[len] = '\\0';\n    kj::StringPtr exeName(exeNameBuf, len);\n    return kj::heapString(exeName.slice(0, KJ_ASSERT_NONNULL(exeName.findLast('/'))));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::String getInstallDir() {\n    char exeNameBuf[PATH_MAX + 1];\n    size_t len;\n    KJ_SYSCALL(len = readlink(\"/proc/self/exe\", exeNameBuf, sizeof(exeNameBuf) - 1));\n    exeNameBuf[len] = '\\0';\n    kj::StringPtr exeName(exeNameBuf, len);\n    return kj::heapString(exeName.slice(0, KJ_ASSERT_NONNULL(exeName.findLast('/'))));\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool runningAsRoot = getuid() == 0;\nbool deleteUserData = false;\n\nkj::MainBuilder::Validity uninstall() {\n    auto bundleDir = getInstallDir();\n    auto sandstormHome = kj::str(bundleDir.slice(0, KJ_ASSERT_NONNULL(bundleDir.findLast('/'))));\n\n    changeToInstallDir();\n    checkAccess();\n\n    // Make sure server is stopped.\n    if (doStop()) {\n      context.warning(\"Sandstorm stopped.\");\n    } else {\n      context.warning(\"Sandstorm is not running.\");\n    }\n\n    KJ_SYSCALL(chdir(sandstormHome.cStr()));\n\n    // Make extra-sure we're in a Sandstorm directory.\n    KJ_ASSERT(access(\"sandstorm\", F_OK) >= 0 &&\n              access(\"sandstorm.conf\", F_OK) >= 0 &&\n              access(\"latest\", F_OK) >= 0 &&\n              sandstormHome != \"/\" &&\n              sandstormHome != \"/usr\",\n              \"uninstaller is confused; bailing out to avoid doing any damage\", sandstormHome);\n\n    bool hasCustomUser = fileHasLine(\"sandstorm.conf\", \"SERVER_USER=sandstorm\");\n\n    // Delete Sandstorm bundles.\n    context.warning(\"Deleting installed Sandstorm bundles...\");\n    static const kj::StringPtr BUNDLE_PREFIX = \"sandstorm-\";\n    for (auto& file: listDirectory(\".\")) {\n      if (file.startsWith(BUNDLE_PREFIX)) {\n        auto suffix = file.slice(BUNDLE_PREFIX.size());\n        if (parseUInt(suffix, 10) != nullptr || suffix.startsWith(\"custom.\")) {\n          // Delete bundle.\n          recursivelyDelete(file);\n        }\n      }\n    }\n\n    // Delete symlinks.\n    KJ_SYSCALL(unlink(\"sandstorm\"));\n    KJ_SYSCALL(unlink(\"latest\"));\n\n    if (access(\"tmp\", F_OK) >= 0) {\n      // Delete tmp since it's obviously not needed.\n      context.warning(\"Deleting temporary files...\");\n      recursivelyDelete(\"tmp\");\n    }\n\n    if (access(\"var\", F_OK) >= 0) {\n      if (deleteUserData) {\n        // User wants to delete their user data... OK then.\n        context.warning(\"Deleting user data (per your request)...\");\n        recursivelyDelete(\"var\");\n        KJ_SYSCALL(unlink(\"sandstorm.conf\"));\n      } else {\n        context.warning(kj::str(\"NOT deleting user data. Left at: \", sandstormHome, \"/var\"));\n      }\n    }\n\n    if (runningAsRoot) {\n      // Delete system-installed stuff. Be careful to verify that these files actually point at\n      // the installation of Sandstorm that we're removing, not some other installation that might\n      // be present on the machine.\n\n      bool seemsLikePrimarySandstorm = false;\n\n      // Remove `sandstorm` and `spk` command prefixes. Note that for historical reasons there are\n      // a few different places these might point, so we only check that they point somewhere under\n      // our Sandstorm install directory.\n      auto symlinkTargetPrefix = kj::str(sandstormHome, \"/\");\n\n      static const kj::StringPtr SANDSTORM_SYMLINK = \"/usr/local/bin/sandstorm\";\n      if (symlinkPointsInto(SANDSTORM_SYMLINK, symlinkTargetPrefix)) {\n        context.warning(\"Removing sandstorm command...\");\n        KJ_SYSCALL(unlink(SANDSTORM_SYMLINK.cStr()));\n        seemsLikePrimarySandstorm = true;\n      }\n\n      static const kj::StringPtr SPK_SYMLINK = \"/usr/local/bin/spk\";\n      if (symlinkPointsInto(SPK_SYMLINK, symlinkTargetPrefix)) {\n        context.warning(\"Removing spk command...\");\n        KJ_SYSCALL(unlink(SPK_SYMLINK.cStr()));\n      }\n\n      // SysV initscript. Remove if it inits this Sandstorm installation.\n      static const kj::StringPtr INITSCRIPT_FILE = \"/etc/init.d/sandstorm\";\n      auto initscriptLine = kj::str(\"DAEMON=\", sandstormHome, \"/sandstorm\");\n      if (fileHasLine(INITSCRIPT_FILE, initscriptLine)) {\n        context.warning(\"Removing SysV initscript...\");\n        KJ_SYSCALL(unlink(INITSCRIPT_FILE.cStr()));\n        system(\"update-rc.d sandstorm remove\");\n      }\n\n      // systemd service file. Remove if it inits this Sandstorm installation.\n      static const kj::StringPtr SYSTEMD_FILE = \"/etc/systemd/system/sandstorm.service\";\n      auto systemdLine = kj::str(\"ExecStart=\", sandstormHome, \"/sandstorm start\");\n      if (fileHasLine(SYSTEMD_FILE, systemdLine)) {\n        context.warning(\"Removing systemd service...\");\n        system(\"systemctl disable sandstorm.service\");\n        KJ_SYSCALL(unlink(SYSTEMD_FILE.cStr()));\n        system(\"systemctl daemon-reload\");\n      }\n\n      if (seemsLikePrimarySandstorm) {\n        // Remove the sysctl modifications. Unfortunately this will break any other Sandstorm\n        // installations on the server, but it _looks_ like we're removing the primary\n        // installation.\n        kj::StringPtr SYSCTL_CONF = \"/etc/sysctl.d/50-sandstorm.conf\";\n        if (access(SYSCTL_CONF.cStr(), F_OK) >= 0) {\n          context.warning(\"Removing sysctl modifications...\");\n          unlink(SYSCTL_CONF.cStr());\n        }\n\n        // Also check if the non-sysctl.d sysctl.conf was modified.\n        if (fileHasLine(\"/etc/sysctl.conf\",\n            \"# Enable non-root users to create sandboxes (needed by Sandstorm).\")) {\n          context.warning(\"WARNING: /etc/sysctl.conf was modified by Sandstorm. Please edit \"\n                          \"it manually if you wish to undo these changes.\");\n        }\n\n        if (hasCustomUser) {\n          context.warning(\"WARNING: A user account and group named 'sandstorm' were created to \"\n                          \"run the server. You may want to delete these manually if they are no \"\n                          \"longer needed. On most systems you can use these commands:\\n\\n\"\n                          \"  userdel sandstorm\\n\"\n                          \"  groupdel sandstorm\");\n        }\n      }\n    }\n\n    // Attempt to remove the Sandstorm home directory. This will fail if it isn't empty, but that's\n    // fine.\n    KJ_SYSCALL(chdir(\"/\"));  // Can't delete directory if we're in it.\n    rmdir(sandstormHome.cStr());\n\n    context.exitInfo(\"Sandstorm has been uninstalled.\");\n  }"
  },
  {
    "function_name": "adminToken",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "950-982",
    "snippet": "kj::MainBuilder::Validity adminToken() {\n    changeToInstallDir();\n    checkAccess();\n\n    // Get 20 random bytes for token.\n    kj::byte bytes[20];\n    randombytes_buf(bytes, sizeof(bytes));\n    auto hexString = hexEncode(bytes);\n\n    auto config = readConfig();\n\n    // Remove old token if present.\n    unlink(\"../var/sandstorm/adminToken\");\n\n    {\n      auto tokenFd = raiiOpen(\"../var/sandstorm/adminToken\",\n          O_WRONLY | O_CREAT | O_EXCL | O_CLOEXEC, 0640);\n      kj::FdOutputStream tokenFile(tokenFd.get());\n      KJ_SYSCALL(fchown(tokenFd, -1, config.uids.gid));\n      tokenFile.write(hexString.begin(), hexString.size());\n    }\n\n    if (shortOutput) {\n      context.exitInfo(hexString);\n    } else {\n      context.exitInfo(kj::str(\"Generated new admin token. Please proceed to:\\n\\n\",\n        config.rootUrl, \"/setup/token/\", hexString, \"\\n\\n\"\n        \"Here you can access the admin settings page and configure \"\n        \"your login system. You must visit the link within 15 minutes, after which you will have \"\n        \"24 hours to complete the setup process.  If you need more time, you can always generate \"\n        \"a new token with `sandstorm admin-token`.\"));\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "bool shortOutput = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "kj::str(\"Generated new admin token. Please proceed to:\\n\\n\",\n        config.rootUrl, \"/setup/token/\", hexString, \"\\n\\n\"\n        \"Here you can access the admin settings page and configure \"\n        \"your login system. You must visit the link within 15 minutes, after which you will have \"\n        \"24 hours to complete the setup process.  If you need more time, you can always generate \"\n        \"a new token with `sandstorm admin-token`.\")"
          ],
          "line": 975
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Generated new admin token. Please proceed to:\\n\\n\"",
            "config.rootUrl",
            "\"/setup/token/\"",
            "hexString",
            "\"\\n\\n\"\n        \"Here you can access the admin settings page and configure \"\n        \"your login system. You must visit the link within 15 minutes, after which you will have \"\n        \"24 hours to complete the setup process.  If you need more time, you can always generate \"\n        \"a new token with `sandstorm admin-token`.\""
          ],
          "line": 975
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "hexString"
          ],
          "line": 973
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "tokenFile.write",
          "args": [
            "hexString.begin()",
            "hexString.size()"
          ],
          "line": 969
        },
        "resolved": true,
        "details": {
          "function_name": "write",
          "container": "RefcountedAsyncIoStream",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/sandstorm-http-bridge.c++",
          "lines": "914-916",
          "snippet": "kj::Promise<void> write(const void* buffer, size_t size) override {\n    return stream->write(buffer, size);\n  }",
          "includes": [
            "#include \"bridge-proxy.h\"",
            "#include \"util.h\"",
            "#include \"version.h\"",
            "#include <joyent-http/http_parser.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/sandstorm-http-bridge-internal.capnp.h>",
            "#include <sandstorm/sandstorm-http-bridge.capnp.h>",
            "#include <sandstorm/email.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <sandstorm/util.capnp.h>",
            "#include <stdio.h>",
            "#include <fcntl.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <time.h>",
            "#include <unordered_map>",
            "#include <map>",
            "#include <unistd.h>",
            "#include <arpa/inet.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/schema.h>",
            "#include <capnp/rpc.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/io.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/async-io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"bridge-proxy.h\"\n#include \"util.h\"\n#include \"version.h\"\n#include <joyent-http/http_parser.h>\n#include <sandstorm/package.capnp.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/sandstorm-http-bridge-internal.capnp.h>\n#include <sandstorm/sandstorm-http-bridge.capnp.h>\n#include <sandstorm/email.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <sandstorm/util.capnp.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <sys/wait.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <time.h>\n#include <unordered_map>\n#include <map>\n#include <unistd.h>\n#include <arpa/inet.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/schema.h>\n#include <capnp/rpc.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/io.h>\n#include <kj/async-unix.h>\n#include <kj/async-io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nRefcountedAsyncIoStream {\n  kj::Promise<void> write(const void* buffer, size_t size) override {\n      return stream->write(buffer, size);\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "hexString.size",
          "args": [],
          "line": 969
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "hexString.begin",
          "args": [],
          "line": 969
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fchown(tokenFd, -1, config.uids.gid)"
          ],
          "line": 968
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fchown",
          "args": [
            "tokenFd",
            "-1",
            "config.uids.gid"
          ],
          "line": 968
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "tokenFd.get",
          "args": [],
          "line": 967
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"../var/sandstorm/adminToken\"",
            "O_WRONLY | O_CREAT | O_EXCL | O_CLOEXEC",
            "0640"
          ],
          "line": 965
        },
        "resolved": true,
        "details": {
          "function_name": "raiiOpenIfExists",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "71-82",
          "snippet": "kj::Maybe<kj::AutoCloseFd> raiiOpenIfExists(kj::StringPtr name, int flags, mode_t mode) {\n  int fd = open(name.cStr(), flags, mode);\n  if (fd == -1) {\n    if (errno == ENOENT) {\n      return nullptr;\n    } else {\n      KJ_FAIL_SYSCALL(\"open\", errno, name);\n    }\n  } else {\n    return kj::AutoCloseFd(fd);\n  }\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<kj::AutoCloseFd> raiiOpenIfExists(kj::StringPtr name, int flags, mode_t mode) {\n  int fd = open(name.cStr(), flags, mode);\n  if (fd == -1) {\n    if (errno == ENOENT) {\n      return nullptr;\n    } else {\n      KJ_FAIL_SYSCALL(\"open\", errno, name);\n    }\n  } else {\n    return kj::AutoCloseFd(fd);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "\"../var/sandstorm/adminToken\""
          ],
          "line": 962
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "readConfig",
          "args": [],
          "line": 959
        },
        "resolved": true,
        "details": {
          "function_name": "readConfig",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1561-1597",
          "snippet": "Config readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;",
            "else if (key == \"PORT\")",
            "else if (key == \"MONGO_PORT\")",
            "else if (key == \"BIND_IP\")",
            "else if (key == \"BASE_URL\")",
            "else if (key == \"WILDCARD_HOST\")",
            "else if (key == \"WILDCARD_PARENT_URL\")",
            "else if (key == \"DDP_DEFAULT_CONNECTION_URL\")",
            "else if (key == \"MAIL_URL\")",
            "else if (key == \"UPDATE_CHANNEL\")",
            "else if (key == \"SANDCATS_BASE_DOMAIN\")",
            "else if (key == \"ALLOW_DEMO_ACCOUNTS\")",
            "else if (key == \"ALLOW_DEV_ACCOUNTS\")",
            "else if (key == \"IS_TESTING\")",
            "else if (key == \"HIDE_TROUBLESHOOTING\")",
            "else if (key == \"SMTP_LISTEN_PORT\")"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\nelse if (key == \"PORT\");\nelse if (key == \"MONGO_PORT\");\nelse if (key == \"BIND_IP\");\nelse if (key == \"BASE_URL\");\nelse if (key == \"WILDCARD_HOST\");\nelse if (key == \"WILDCARD_PARENT_URL\");\nelse if (key == \"DDP_DEFAULT_CONNECTION_URL\");\nelse if (key == \"MAIL_URL\");\nelse if (key == \"UPDATE_CHANNEL\");\nelse if (key == \"SANDCATS_BASE_DOMAIN\");\nelse if (key == \"ALLOW_DEMO_ACCOUNTS\");\nelse if (key == \"ALLOW_DEV_ACCOUNTS\");\nelse if (key == \"IS_TESTING\");\nelse if (key == \"HIDE_TROUBLESHOOTING\");\nelse if (key == \"SMTP_LISTEN_PORT\");\n\nConfig readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }"
        }
      },
      {
        "call_info": {
          "callee": "hexEncode",
          "args": [
            "bytes"
          ],
          "line": 957
        },
        "resolved": true,
        "details": {
          "function_name": "hexEncode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "784-787",
          "snippet": "kj::String hexEncode(kj::ArrayPtr<const byte> input) {\n  const char DIGITS[] = \"0123456789abcdef\";\n  return kj::strArray(KJ_MAP(b, input) { return kj::heapArray<char>({DIGITS[b/16], DIGITS[b%16]}); }, \"\");\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String hexEncode(kj::ArrayPtr<const byte> input) {\n  const char DIGITS[] = \"0123456789abcdef\";\n  return kj::strArray(KJ_MAP(b, input) { return kj::heapArray<char>({DIGITS[b/16], DIGITS[b%16]}); }, \"\");\n}"
        }
      },
      {
        "call_info": {
          "callee": "randombytes_buf",
          "args": [
            "bytes",
            "sizeof(bytes)"
          ],
          "line": 956
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "checkAccess",
          "args": [],
          "line": 952
        },
        "resolved": true,
        "details": {
          "function_name": "checkAccess",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1203-1214",
          "snippet": "void checkAccess() {\n    KJ_ASSERT(changedDir);\n    if (access(\"../var/sandstorm\", W_OK) == -1) {\n      if (errno == EACCES) {\n        KJ_FAIL_REQUIRE(\n            \"Sandstorm was not run with appropriate privileges; rerun as root or the user for \"\n            \"which it was installed.\");\n      } else {\n        KJ_FAIL_SYSCALL(\"access\", errno);\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid checkAccess() {\n    KJ_ASSERT(changedDir);\n    if (access(\"../var/sandstorm\", W_OK) == -1) {\n      if (errno == EACCES) {\n        KJ_FAIL_REQUIRE(\n            \"Sandstorm was not run with appropriate privileges; rerun as root or the user for \"\n            \"which it was installed.\");\n      } else {\n        KJ_FAIL_SYSCALL(\"access\", errno);\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 951
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool shortOutput = false;\n\nkj::MainBuilder::Validity adminToken() {\n    changeToInstallDir();\n    checkAccess();\n\n    // Get 20 random bytes for token.\n    kj::byte bytes[20];\n    randombytes_buf(bytes, sizeof(bytes));\n    auto hexString = hexEncode(bytes);\n\n    auto config = readConfig();\n\n    // Remove old token if present.\n    unlink(\"../var/sandstorm/adminToken\");\n\n    {\n      auto tokenFd = raiiOpen(\"../var/sandstorm/adminToken\",\n          O_WRONLY | O_CREAT | O_EXCL | O_CLOEXEC, 0640);\n      kj::FdOutputStream tokenFile(tokenFd.get());\n      KJ_SYSCALL(fchown(tokenFd, -1, config.uids.gid));\n      tokenFile.write(hexString.begin(), hexString.size());\n    }\n\n    if (shortOutput) {\n      context.exitInfo(hexString);\n    } else {\n      context.exitInfo(kj::str(\"Generated new admin token. Please proceed to:\\n\\n\",\n        config.rootUrl, \"/setup/token/\", hexString, \"\\n\\n\"\n        \"Here you can access the admin settings page and configure \"\n        \"your login system. You must visit the link within 15 minutes, after which you will have \"\n        \"24 hours to complete the setup process.  If you need more time, you can always generate \"\n        \"a new token with `sandstorm admin-token`.\"));\n    }\n  }"
  },
  {
    "function_name": "update",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "914-948",
    "snippet": "kj::MainBuilder::Validity update() {\n    changeToInstallDir();\n    const Config config = readConfig();\n\n    if (updateFile == nullptr) {\n      if (config.updateChannel == nullptr) {\n        return \"You must specify a channel.\";\n      }\n\n      if (!checkForUpdates(config.updateChannel, \"manual\", config)) {\n        context.exit();\n      }\n    } else {\n      if (config.updateChannel != nullptr) {\n        return \"You currently have auto-updates enabled. Please disable it before updating \"\n               \"manually, otherwise you'll just be switched back at the next update. Set \"\n               \"UPDATE_CHANNEL to \\\"none\\\" to disable. Or, if you want to manually apply \"\n               \"the latest update from the configured channel, run `sandstorm update` with \"\n               \"no argument.\";\n      }\n\n      if (!updateFileIsChannel) {\n        unpackUpdate(raiiOpen(updateFile, O_RDONLY));\n      } else if (!checkForUpdates(updateFile, \"manual\", config)) {\n        context.exit();\n      }\n    }\n\n    KJ_IF_MAYBE(pid, getRunningPid()) {\n      KJ_SYSCALL(kill(*pid, SIGHUP));\n      context.exitInfo(\"Update complete; restarting Sandstorm.\");\n    } else {\n      context.exitInfo(\"Update complete.\");\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;",
      "kj::String updateFile;",
      "bool updateFileIsChannel = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "\"Update complete.\""
          ],
          "line": 946
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "\"Update complete; restarting Sandstorm.\""
          ],
          "line": 944
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "kill(*pid, SIGHUP)"
          ],
          "line": 943
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kill",
          "args": [
            "*pid",
            "SIGHUP"
          ],
          "line": 943
        },
        "resolved": true,
        "details": {
          "function_name": "killChild",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2377-2413",
          "snippet": "void killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nvoid killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "context.exit",
          "args": [],
          "line": 938
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "checkForUpdates",
          "args": [
            "updateFile",
            "\"manual\"",
            "config"
          ],
          "line": 937
        },
        "resolved": true,
        "details": {
          "function_name": "checkForUpdates",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2415-2481",
          "snippet": "bool checkForUpdates(kj::StringPtr channel, kj::StringPtr type, const Config& config) {\n    // GET install.sandstorm.io/$channel?from=$oldBuild&type=[manual|startup|daily]\n    //     -> result is build number\n    context.warning(kj::str(\"Checking for updates on channel \", channel, \"...\"));\n\n    kj::String buildStr;\n\n    {\n      kj::String from;\n      if (SANDSTORM_BUILD > 0) {\n        from = kj::str(\"from=\", SANDSTORM_BUILD, \"&\");\n      }\n\n      CurlRequest updateCheck(\n          kj::str(\"https://install.sandstorm.io/\", channel, \"?\", from, \"type=\", type));\n      buildStr = readAll(updateCheck.getPipe());\n    }\n\n    uint targetBuild = KJ_ASSERT_NONNULL(parseUInt(trim(buildStr), 10));\n\n    if (targetBuild <= SANDSTORM_BUILD) {\n      context.warning(\"No update available.\");\n      return false;\n    }\n\n    // Download bundle to temporary file.\n    auto url = kj::str(\"https://dl.sandstorm.io/sandstorm-\", targetBuild, \".tar.xz\");\n    auto file = openTemporary(\"/var/tmp/sandstorm-update\");\n    context.warning(kj::str(\"Downloading: \", url));\n    CurlRequest(url, file);\n    KJ_SYSCALL(lseek(file, 0, SEEK_SET));\n\n    // Verify signature.\n    {\n      context.warning(\"Checking signature...\");\n      KJ_ON_SCOPE_FAILURE(context.warning(\n          \"*** Aborting update because signature check failed! Most likely this is due to a \"\n          \"network glitch, but if you suspect an attack, notify security@sandstorm.io.\"));\n\n      // Download and parse signature file for this update.\n      capnp::StreamFdMessageReader signatureMessage(\n          CurlRequest(kj::str(url, \".update-sig\")).getPipe());\n      auto sigs = signatureMessage.getRoot<UpdateSignature>().getSignatures();\n\n      // Always verify using the *last* key in updatePublicKeys, as it is the most recent.\n      uint keyIndex = UPDATE_PUBLIC_KEYS->size() - 1;\n      PublicSigningKey::Reader key = (*UPDATE_PUBLIC_KEYS)[keyIndex];\n      KJ_ASSERT(sigs.size() > keyIndex,\n          \"signature is missing the most recent signing key\");\n      Signature::Reader signature = sigs[keyIndex];\n\n      // mmap the file and check the signature.\n      MemoryMapping mapping(file, \"(update tarball)\");\n      capnp::Data::Reader data = mapping;\n      KJ_ASSERT(crypto_sign_ed25519_verify_detached(\n          structToBytes(signature, crypto_sign_ed25519_BYTES),\n          data.begin(), data.size(),\n          structToBytes(key, crypto_sign_ed25519_PUBLICKEYBYTES)) == 0,\n          \"signature is invalid\");\n\n      context.warning(\"Signature is valid.\");\n    }\n\n    unpackUpdate(file, targetBuild);\n\n    return true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "else if (key == \"PORT\")",
            "else if (key == \"MONGO_PORT\")",
            "else if (key == \"BIND_IP\")",
            "else if (key == \"BASE_URL\")",
            "else if (key == \"WILDCARD_HOST\")",
            "else if (key == \"WILDCARD_PARENT_URL\")",
            "else if (key == \"DDP_DEFAULT_CONNECTION_URL\")",
            "else if (key == \"MAIL_URL\")",
            "else if (key == \"UPDATE_CHANNEL\")",
            "else if (key == \"SANDCATS_BASE_DOMAIN\")",
            "else if (key == \"ALLOW_DEMO_ACCOUNTS\")",
            "else if (key == \"ALLOW_DEV_ACCOUNTS\")",
            "else if (key == \"IS_TESTING\")",
            "else if (key == \"HIDE_TROUBLESHOOTING\")",
            "else if (key == \"SMTP_LISTEN_PORT\")"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nelse if (key == \"PORT\");\nelse if (key == \"MONGO_PORT\");\nelse if (key == \"BIND_IP\");\nelse if (key == \"BASE_URL\");\nelse if (key == \"WILDCARD_HOST\");\nelse if (key == \"WILDCARD_PARENT_URL\");\nelse if (key == \"DDP_DEFAULT_CONNECTION_URL\");\nelse if (key == \"MAIL_URL\");\nelse if (key == \"UPDATE_CHANNEL\");\nelse if (key == \"SANDCATS_BASE_DOMAIN\");\nelse if (key == \"ALLOW_DEMO_ACCOUNTS\");\nelse if (key == \"ALLOW_DEV_ACCOUNTS\");\nelse if (key == \"IS_TESTING\");\nelse if (key == \"HIDE_TROUBLESHOOTING\");\nelse if (key == \"SMTP_LISTEN_PORT\");\n\nbool checkForUpdates(kj::StringPtr channel, kj::StringPtr type, const Config& config) {\n    // GET install.sandstorm.io/$channel?from=$oldBuild&type=[manual|startup|daily]\n    //     -> result is build number\n    context.warning(kj::str(\"Checking for updates on channel \", channel, \"...\"));\n\n    kj::String buildStr;\n\n    {\n      kj::String from;\n      if (SANDSTORM_BUILD > 0) {\n        from = kj::str(\"from=\", SANDSTORM_BUILD, \"&\");\n      }\n\n      CurlRequest updateCheck(\n          kj::str(\"https://install.sandstorm.io/\", channel, \"?\", from, \"type=\", type));\n      buildStr = readAll(updateCheck.getPipe());\n    }\n\n    uint targetBuild = KJ_ASSERT_NONNULL(parseUInt(trim(buildStr), 10));\n\n    if (targetBuild <= SANDSTORM_BUILD) {\n      context.warning(\"No update available.\");\n      return false;\n    }\n\n    // Download bundle to temporary file.\n    auto url = kj::str(\"https://dl.sandstorm.io/sandstorm-\", targetBuild, \".tar.xz\");\n    auto file = openTemporary(\"/var/tmp/sandstorm-update\");\n    context.warning(kj::str(\"Downloading: \", url));\n    CurlRequest(url, file);\n    KJ_SYSCALL(lseek(file, 0, SEEK_SET));\n\n    // Verify signature.\n    {\n      context.warning(\"Checking signature...\");\n      KJ_ON_SCOPE_FAILURE(context.warning(\n          \"*** Aborting update because signature check failed! Most likely this is due to a \"\n          \"network glitch, but if you suspect an attack, notify security@sandstorm.io.\"));\n\n      // Download and parse signature file for this update.\n      capnp::StreamFdMessageReader signatureMessage(\n          CurlRequest(kj::str(url, \".update-sig\")).getPipe());\n      auto sigs = signatureMessage.getRoot<UpdateSignature>().getSignatures();\n\n      // Always verify using the *last* key in updatePublicKeys, as it is the most recent.\n      uint keyIndex = UPDATE_PUBLIC_KEYS->size() - 1;\n      PublicSigningKey::Reader key = (*UPDATE_PUBLIC_KEYS)[keyIndex];\n      KJ_ASSERT(sigs.size() > keyIndex,\n          \"signature is missing the most recent signing key\");\n      Signature::Reader signature = sigs[keyIndex];\n\n      // mmap the file and check the signature.\n      MemoryMapping mapping(file, \"(update tarball)\");\n      capnp::Data::Reader data = mapping;\n      KJ_ASSERT(crypto_sign_ed25519_verify_detached(\n          structToBytes(signature, crypto_sign_ed25519_BYTES),\n          data.begin(), data.size(),\n          structToBytes(key, crypto_sign_ed25519_PUBLICKEYBYTES)) == 0,\n          \"signature is invalid\");\n\n      context.warning(\"Signature is valid.\");\n    }\n\n    unpackUpdate(file, targetBuild);\n\n    return true;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "unpackUpdate",
          "args": [
            "raiiOpen(updateFile, O_RDONLY)"
          ],
          "line": 936
        },
        "resolved": true,
        "details": {
          "function_name": "unpackUpdate",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2489-2542",
          "snippet": "void unpackUpdate(int bundleFd, uint expectedBuild = 0) {\n    char tmpdir[] = \"../downloading.XXXXXX\";\n    if (mkdtemp(tmpdir) != tmpdir) {\n      KJ_FAIL_SYSCALL(\"mkdtemp\", errno);\n    }\n    KJ_DEFER(recursivelyDelete(tmpdir));\n\n    pid_t tarPid = fork();\n    if (tarPid == 0) {\n      KJ_SYSCALL(dup2(bundleFd, STDIN_FILENO));\n      KJ_SYSCALL(chdir(tmpdir));\n      KJ_SYSCALL(execlp(\"tar\", \"tar\", \"Jxo\", EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    }\n\n    int tarStatus;\n    KJ_SYSCALL(waitpid(tarPid, &tarStatus, 0));\n    KJ_ASSERT(WIFEXITED(tarStatus) && WEXITSTATUS(tarStatus) == 0, \"tar failed\");\n\n    auto files = listDirectory(tmpdir);\n    KJ_ASSERT(files.size() == 1, \"Expected tar file to contain only one item.\");\n    KJ_ASSERT(files[0].startsWith(\"sandstorm-\"), \"Expected tar file to contain sandstorm-$BUILD.\");\n\n    uint targetBuild = KJ_ASSERT_NONNULL(parseUInt(files[0].slice(strlen(\"sandstorm-\")), 10));\n\n    if (expectedBuild != 0) {\n      KJ_ASSERT(targetBuild == expectedBuild,\n          \"Downloaded bundle did not contain the build number we expecetd.\");\n    }\n\n    kj::String targetDir;\n    if (targetBuild == 0) {\n      // Build 0 indicates a custom build. Tag it with the time.\n\n      char buffer[128];\n      time_t now = time(nullptr);\n      struct tm local;\n      localtime_r(&now, &local);\n      strftime(buffer, sizeof(buffer), \"%Y-%m-%d_%H-%M-%S\", &local);\n      targetDir = kj::str(\"../sandstorm-custom.\", buffer);\n    } else {\n      targetDir = kj::str(\"../\", files[0]);\n    }\n\n    if (access(targetDir.cStr(), F_OK) != 0) {\n      KJ_SYSCALL(rename(kj::str(tmpdir, '/', files[0]).cStr(), targetDir.cStr()));\n    }\n\n    // Setup \"latest\" symlink, atomically.\n    auto tmpLink = kj::str(\"../latest.\", targetBuild);\n    unlink(tmpLink.cStr());  // just in case; ignore failure\n    KJ_SYSCALL(symlink(targetDir.slice(3).cStr(), tmpLink.cStr()));\n    KJ_SYSCALL(rename(tmpLink.cStr(), \"../latest\"));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid unpackUpdate(int bundleFd, uint expectedBuild = 0) {\n    char tmpdir[] = \"../downloading.XXXXXX\";\n    if (mkdtemp(tmpdir) != tmpdir) {\n      KJ_FAIL_SYSCALL(\"mkdtemp\", errno);\n    }\n    KJ_DEFER(recursivelyDelete(tmpdir));\n\n    pid_t tarPid = fork();\n    if (tarPid == 0) {\n      KJ_SYSCALL(dup2(bundleFd, STDIN_FILENO));\n      KJ_SYSCALL(chdir(tmpdir));\n      KJ_SYSCALL(execlp(\"tar\", \"tar\", \"Jxo\", EXEC_END_ARGS));\n      KJ_UNREACHABLE;\n    }\n\n    int tarStatus;\n    KJ_SYSCALL(waitpid(tarPid, &tarStatus, 0));\n    KJ_ASSERT(WIFEXITED(tarStatus) && WEXITSTATUS(tarStatus) == 0, \"tar failed\");\n\n    auto files = listDirectory(tmpdir);\n    KJ_ASSERT(files.size() == 1, \"Expected tar file to contain only one item.\");\n    KJ_ASSERT(files[0].startsWith(\"sandstorm-\"), \"Expected tar file to contain sandstorm-$BUILD.\");\n\n    uint targetBuild = KJ_ASSERT_NONNULL(parseUInt(files[0].slice(strlen(\"sandstorm-\")), 10));\n\n    if (expectedBuild != 0) {\n      KJ_ASSERT(targetBuild == expectedBuild,\n          \"Downloaded bundle did not contain the build number we expecetd.\");\n    }\n\n    kj::String targetDir;\n    if (targetBuild == 0) {\n      // Build 0 indicates a custom build. Tag it with the time.\n\n      char buffer[128];\n      time_t now = time(nullptr);\n      struct tm local;\n      localtime_r(&now, &local);\n      strftime(buffer, sizeof(buffer), \"%Y-%m-%d_%H-%M-%S\", &local);\n      targetDir = kj::str(\"../sandstorm-custom.\", buffer);\n    } else {\n      targetDir = kj::str(\"../\", files[0]);\n    }\n\n    if (access(targetDir.cStr(), F_OK) != 0) {\n      KJ_SYSCALL(rename(kj::str(tmpdir, '/', files[0]).cStr(), targetDir.cStr()));\n    }\n\n    // Setup \"latest\" symlink, atomically.\n    auto tmpLink = kj::str(\"../latest.\", targetBuild);\n    unlink(tmpLink.cStr());  // just in case; ignore failure\n    KJ_SYSCALL(symlink(targetDir.slice(3).cStr(), tmpLink.cStr()));\n    KJ_SYSCALL(rename(tmpLink.cStr(), \"../latest\"));\n  }"
        }
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "updateFile",
            "O_RDONLY"
          ],
          "line": 936
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exit",
          "args": [],
          "line": 924
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "readConfig",
          "args": [],
          "line": 916
        },
        "resolved": true,
        "details": {
          "function_name": "readConfig",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1561-1597",
          "snippet": "Config readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;",
            "else if (key == \"PORT\")",
            "else if (key == \"MONGO_PORT\")",
            "else if (key == \"BIND_IP\")",
            "else if (key == \"BASE_URL\")",
            "else if (key == \"WILDCARD_HOST\")",
            "else if (key == \"WILDCARD_PARENT_URL\")",
            "else if (key == \"DDP_DEFAULT_CONNECTION_URL\")",
            "else if (key == \"MAIL_URL\")",
            "else if (key == \"UPDATE_CHANNEL\")",
            "else if (key == \"SANDCATS_BASE_DOMAIN\")",
            "else if (key == \"ALLOW_DEMO_ACCOUNTS\")",
            "else if (key == \"ALLOW_DEV_ACCOUNTS\")",
            "else if (key == \"IS_TESTING\")",
            "else if (key == \"HIDE_TROUBLESHOOTING\")",
            "else if (key == \"SMTP_LISTEN_PORT\")"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\nelse if (key == \"PORT\");\nelse if (key == \"MONGO_PORT\");\nelse if (key == \"BIND_IP\");\nelse if (key == \"BASE_URL\");\nelse if (key == \"WILDCARD_HOST\");\nelse if (key == \"WILDCARD_PARENT_URL\");\nelse if (key == \"DDP_DEFAULT_CONNECTION_URL\");\nelse if (key == \"MAIL_URL\");\nelse if (key == \"UPDATE_CHANNEL\");\nelse if (key == \"SANDCATS_BASE_DOMAIN\");\nelse if (key == \"ALLOW_DEMO_ACCOUNTS\");\nelse if (key == \"ALLOW_DEV_ACCOUNTS\");\nelse if (key == \"IS_TESTING\");\nelse if (key == \"HIDE_TROUBLESHOOTING\");\nelse if (key == \"SMTP_LISTEN_PORT\");\n\nConfig readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }"
        }
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 915
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nkj::String updateFile;\nbool updateFileIsChannel = false;\n\nkj::MainBuilder::Validity update() {\n    changeToInstallDir();\n    const Config config = readConfig();\n\n    if (updateFile == nullptr) {\n      if (config.updateChannel == nullptr) {\n        return \"You must specify a channel.\";\n      }\n\n      if (!checkForUpdates(config.updateChannel, \"manual\", config)) {\n        context.exit();\n      }\n    } else {\n      if (config.updateChannel != nullptr) {\n        return \"You currently have auto-updates enabled. Please disable it before updating \"\n               \"manually, otherwise you'll just be switched back at the next update. Set \"\n               \"UPDATE_CHANNEL to \\\"none\\\" to disable. Or, if you want to manually apply \"\n               \"the latest update from the configured channel, run `sandstorm update` with \"\n               \"no argument.\";\n      }\n\n      if (!updateFileIsChannel) {\n        unpackUpdate(raiiOpen(updateFile, O_RDONLY));\n      } else if (!checkForUpdates(updateFile, \"manual\", config)) {\n        context.exit();\n      }\n    }\n\n    KJ_IF_MAYBE(pid, getRunningPid()) {\n      KJ_SYSCALL(kill(*pid, SIGHUP));\n      context.exitInfo(\"Update complete; restarting Sandstorm.\");\n    } else {\n      context.exitInfo(\"Update complete.\");\n    }\n  }"
  },
  {
    "function_name": "mongo",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "893-912",
    "snippet": "kj::MainBuilder::Validity mongo() {\n    changeToInstallDir();\n\n    // Verify that Sandstorm is running.\n    if (getRunningPid() == nullptr) {\n      context.exitError(\"Sandstorm is not running.\");\n    }\n\n    const Config config = readConfig();\n\n    // We'll run under the chroot.\n    enterChroot(false);\n\n    // Don't run as root.\n    dropPrivs(config.uids);\n\n    // OK, run the Mongo client!\n    execMongoClient(config, {}, {});\n    KJ_UNREACHABLE;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "execMongoClient",
          "args": [
            "config",
            "{}",
            "{}"
          ],
          "line": 910
        },
        "resolved": true,
        "details": {
          "function_name": "execMongoClient",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2954-2991",
          "snippet": "[[noreturn]] void execMongoClient(const Config& config,\n        std::initializer_list<kj::StringPtr> optionArgs,\n        std::initializer_list<kj::StringPtr> fileArgs,\n        kj::StringPtr dbName = \"meteor\") {\n    auto db = kj::str(\"127.0.0.1:\", config.mongoPort, \"/\", dbName);\n\n    kj::Vector<const char*> args;\n    args.add(\"/bin/mongo\");\n\n    // If /var/mongo/passwd exists, we interpret it as containing the password for a Mongo user\n    // \"sandstorm\", and assume we are expected to log in as this user.\n    kj::String passwordArg;\n    if (access(\"/var/mongo/passwd\", F_OK) == 0) {\n      passwordArg = kj::str(\"--password=\", trim(readAll(raiiOpen(\"/var/mongo/passwd\", O_RDONLY))));\n\n      args.add(\"-u\");\n      args.add(\"sandstorm\");\n      args.add(passwordArg.cStr());\n      args.add(\"--authenticationDatabase\");\n      args.add(\"admin\");\n    }\n\n    for (auto& arg: optionArgs) {\n      args.add(arg.cStr());\n    }\n\n    args.add(db.cStr());\n\n    for (auto& arg: fileArgs) {\n      args.add(arg.cStr());\n    }\n\n    args.add(nullptr);\n\n    // OK, run the Mongo client!\n    KJ_SYSCALL(execv(args[0], const_cast<char**>(args.begin())));\n    KJ_UNREACHABLE;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\n[[noreturn]] void execMongoClient(const Config& config,\n        std::initializer_list<kj::StringPtr> optionArgs,\n        std::initializer_list<kj::StringPtr> fileArgs,\n        kj::StringPtr dbName = \"meteor\") {\n    auto db = kj::str(\"127.0.0.1:\", config.mongoPort, \"/\", dbName);\n\n    kj::Vector<const char*> args;\n    args.add(\"/bin/mongo\");\n\n    // If /var/mongo/passwd exists, we interpret it as containing the password for a Mongo user\n    // \"sandstorm\", and assume we are expected to log in as this user.\n    kj::String passwordArg;\n    if (access(\"/var/mongo/passwd\", F_OK) == 0) {\n      passwordArg = kj::str(\"--password=\", trim(readAll(raiiOpen(\"/var/mongo/passwd\", O_RDONLY))));\n\n      args.add(\"-u\");\n      args.add(\"sandstorm\");\n      args.add(passwordArg.cStr());\n      args.add(\"--authenticationDatabase\");\n      args.add(\"admin\");\n    }\n\n    for (auto& arg: optionArgs) {\n      args.add(arg.cStr());\n    }\n\n    args.add(db.cStr());\n\n    for (auto& arg: fileArgs) {\n      args.add(arg.cStr());\n    }\n\n    args.add(nullptr);\n\n    // OK, run the Mongo client!\n    KJ_SYSCALL(execv(args[0], const_cast<char**>(args.begin())));\n    KJ_UNREACHABLE;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "dropPrivs",
          "args": [
            "config.uids"
          ],
          "line": 907
        },
        "resolved": true,
        "details": {
          "function_name": "dropPrivs",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1451-1497",
          "snippet": "void dropPrivs(const UserIds& uids, bool keepRealUid = false) {\n    // Defense in depth: Don't give my children any new caps for any reason.\n    KJ_SYSCALL(prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0));\n\n    if (runningAsRoot) {\n      KJ_SYSCALL(setresgid(uids.gid, uids.gid, uids.gid));\n      KJ_SYSCALL(setgroups(uids.groups.size(), uids.groups.begin()));\n\n      if (keepRealUid) {\n        // We're prepping to run the backend and user namespaces are not available, therefore the\n        // backend needs to keep its superuser powers stashed in order to hand them off to the\n        // grain supervisors so that they can set up sandboxes. Instead of creating a suid binary\n        // (with all the danger that entails), we merely drop the effective UID, but raise it again\n        // when invoking the supervisor.\n        KJ_SYSCALL(seteuid(uids.uid));\n      } else {\n        KJ_SYSCALL(setresuid(uids.uid, uids.uid, uids.uid));\n      }\n    } else {\n      // We're using UID namespaces.\n\n      KJ_ASSERT(!keepRealUid);\n\n      // Defense in depth: Drop all capabilities from the set of caps which my children are allowed\n      //   to ever have.\n      for (uint cap: kj::range(0, CAP_LAST_CAP + 1)) {\n        // TODO(soon): I spontaneously started getting EINVAL here, but only in production, so I\n        //   had to remove the error check. Figure out what happened and re-enable it. Maybe it\n        //   makes sense to read the bset first and then only drop the caps in it?\n        prctl(PR_CAPBSET_DROP, cap, 0, 0, 0);\n      }\n\n      // Defense in depth: Don't grant my children capabilities just because they have UID 0.\n      KJ_SYSCALL(prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED));\n\n      // Drop all Linux \"capabilities\".  (These are Linux/POSIX \"capabilities\", which are not true\n      // object-capabilities, hence the quotes.)\n      struct __user_cap_header_struct hdr;\n      struct __user_cap_data_struct data[2];\n      hdr.version = _LINUX_CAPABILITY_VERSION_3;\n      hdr.pid = 0;\n      memset(data, 0, sizeof(data));  // All capabilities disabled!\n      KJ_SYSCALL(capset(&hdr, data));\n    }\n\n    umask(0007);\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;",
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool runningAsRoot = getuid() == 0;\n\nvoid dropPrivs(const UserIds& uids, bool keepRealUid = false) {\n    // Defense in depth: Don't give my children any new caps for any reason.\n    KJ_SYSCALL(prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0));\n\n    if (runningAsRoot) {\n      KJ_SYSCALL(setresgid(uids.gid, uids.gid, uids.gid));\n      KJ_SYSCALL(setgroups(uids.groups.size(), uids.groups.begin()));\n\n      if (keepRealUid) {\n        // We're prepping to run the backend and user namespaces are not available, therefore the\n        // backend needs to keep its superuser powers stashed in order to hand them off to the\n        // grain supervisors so that they can set up sandboxes. Instead of creating a suid binary\n        // (with all the danger that entails), we merely drop the effective UID, but raise it again\n        // when invoking the supervisor.\n        KJ_SYSCALL(seteuid(uids.uid));\n      } else {\n        KJ_SYSCALL(setresuid(uids.uid, uids.uid, uids.uid));\n      }\n    } else {\n      // We're using UID namespaces.\n\n      KJ_ASSERT(!keepRealUid);\n\n      // Defense in depth: Drop all capabilities from the set of caps which my children are allowed\n      //   to ever have.\n      for (uint cap: kj::range(0, CAP_LAST_CAP + 1)) {\n        // TODO(soon): I spontaneously started getting EINVAL here, but only in production, so I\n        //   had to remove the error check. Figure out what happened and re-enable it. Maybe it\n        //   makes sense to read the bset first and then only drop the caps in it?\n        prctl(PR_CAPBSET_DROP, cap, 0, 0, 0);\n      }\n\n      // Defense in depth: Don't grant my children capabilities just because they have UID 0.\n      KJ_SYSCALL(prctl(PR_SET_SECUREBITS, SECBIT_NOROOT | SECBIT_NOROOT_LOCKED));\n\n      // Drop all Linux \"capabilities\".  (These are Linux/POSIX \"capabilities\", which are not true\n      // object-capabilities, hence the quotes.)\n      struct __user_cap_header_struct hdr;\n      struct __user_cap_data_struct data[2];\n      hdr.version = _LINUX_CAPABILITY_VERSION_3;\n      hdr.pid = 0;\n      memset(data, 0, sizeof(data));  // All capabilities disabled!\n      KJ_SYSCALL(capset(&hdr, data));\n    }\n\n    umask(0007);\n  }"
        }
      },
      {
        "call_info": {
          "callee": "enterChroot",
          "args": [
            "false"
          ],
          "line": 904
        },
        "resolved": true,
        "details": {
          "function_name": "enterChroot",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1328-1449",
          "snippet": "void enterChroot(bool inPidNamespace) {\n    KJ_REQUIRE(changedDir);\n\n    // Verify ownership is intact.\n    checkOwnedByRoot(\"..\", \"Install directory\");\n    checkOwnedByRoot(\".\", \"Version install directory\");\n    checkOwnedByRoot(\"sandstorm\", \"'sandstorm' executable\");\n    checkOwnedByRoot(\"../sandstorm.conf\", \"Config file\");\n\n    kj::StringPtr tmpfsUidOpts = \"\";\n    if (runningAsRoot) {\n      tmpfsUidOpts = \",uid=0,gid=0\";\n    } else {\n      unshareUidNamespaceOnce();\n    }\n\n    // Unshare the mount namespace, so we can create some private bind mounts.\n    KJ_SYSCALL(unshare(CLONE_NEWNS));\n\n    // To really unshare the mount namespace, we also have to make sure all mounts are private.\n    // The parameters here were derived by strace'ing `mount --make-rprivate /`.  AFAICT the flags\n    // are undocumented.  :(\n    KJ_SYSCALL(mount(\"none\", \"/\", nullptr, MS_REC | MS_PRIVATE, nullptr));\n\n    // Make sure that the current directory is a mount point so that we can use pivot_root.\n    KJ_SYSCALL(mount(\".\", \".\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Now change directory into the new mount point.\n    char cwdBuf[PATH_MAX + 1];\n    if (getcwd(cwdBuf, sizeof(cwdBuf)) == nullptr) {\n      KJ_FAIL_SYSCALL(\"getcwd\", errno);\n    }\n    KJ_SYSCALL(chdir(cwdBuf));\n\n    if (inPidNamespace) {\n      // Mount /proc for our PID namespace in the chroot.\n      KJ_SYSCALL(mount(\"proc\", \"proc\", \"proc\", MS_NOSUID | MS_NODEV | MS_NOEXEC, \"\"));\n    } else {\n      // Bind /proc for the global pid namespace in the chroot.\n      KJ_SYSCALL(mount(\"/proc\", \"proc\", nullptr, MS_BIND | MS_REC, nullptr));\n    }\n\n    // Bind var -> ../var, so that all versions share the same var.\n    // Same for tmp, though we clear it on every startup.\n    KJ_SYSCALL(mount(\"../var\", \"var\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"../tmp\", \"tmp\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Bind devices from /dev into our chroot environment.\n    // We can't bind /dev itself because this is apparently not allowed when in a UID namespace\n    // (returns EINVAL; haven't figured out why yet).\n    KJ_SYSCALL(mount(\"/dev/null\", \"dev/null\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/zero\", \"dev/zero\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/random\", \"dev/random\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/urandom\", \"dev/urandom\", nullptr, MS_BIND, nullptr));\n\n    if (runningAsRoot && access(\"/dev/fuse\", F_OK) == 0) {\n      // Bring in FUSE just in case we need it for \"spk dev\".\n      // TODO(cleanup): We should probably instead open /dev/fuse in the \"spk\" command (i.e.\n      //   outside the namespace) and then pass the FD to the server.\n      KJ_SYSCALL(mount(\"/dev/fuse\", \"dev/fuse\", nullptr, MS_BIND, nullptr));\n    }\n\n    // Bind in the host's /etc as /etc.host.\n    // As noted in backup.c++, MS_BIND does not respect mount flags on the initial bind, and\n    // we have to issue a remount to set them.  Because the host /etc may have been mounted nosuid,\n    // nodev, and noexec, we also add those flags here lest mount() think we're trying to remove\n    // them (which would cause mount() to fail).  We also need MS_REC because the host may have\n    // mounted other FSes under /etc, and we need to recursively rebind those.\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n    // Then do the same for /run.\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n\n    // Mount a tmpfs at /run.\n    KJ_SYSCALL(mount(\"tmpfs\", \"run\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Mount a tmpfs at /etc.\n    KJ_SYSCALL(mount(\"tmpfs\", \"etc\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Symlink in necessary config files from the host, as described in the bundle's host.list\n    linkHostFiles();\n    // And just in case the user has /etc/resolv.conf as a symlink to something we haven't linked\n    // in, copy its contents to /etc/resolv.conf.host-initial so we can use that if needed.\n    backupResolvConf();\n\n    // OK, change our root directory.\n    KJ_SYSCALL(syscall(SYS_pivot_root, \".\", \"tmp\"));\n    KJ_SYSCALL(chdir(\"/\"));\n    KJ_SYSCALL(umount2(\"tmp\", MNT_DETACH));\n\n    // The environment inherited from the host is probably no good for us. E.g. an oddball\n    // locale setting can crash Mongo because we don't have the appropriate locale files available.\n    //\n    // That said, there are a few environment variables that we do re-export.\n    std::map<const char*, kj::String> envVars;\n    static const char* const KEEP_VARS[] = {\"http_proxy\", \"https_proxy\"};\n    for (const char* varName: KEEP_VARS) {\n      const char* envValue = getenv(varName);\n      if (envValue != nullptr) {\n        envVars.insert(std::make_pair(varName, kj::str(envValue)));\n      }\n    }\n    KJ_SYSCALL(clearenv());\n\n    // Set up an environment appropriate for us.\n    KJ_SYSCALL(setenv(\"LANG\", \"C.UTF-8\", true));\n    KJ_SYSCALL(setenv(\"PATH\", \"/usr/bin:/bin\", true));\n    KJ_SYSCALL(setenv(\"LD_LIBRARY_PATH\", \"/usr/local/lib:/usr/lib:/lib\", true));\n\n    // Copy any remaining environment variables in that we captured.\n    for (auto& entry: envVars) {\n      KJ_SYSCALL(setenv(entry.first, entry.second.cStr(), true));\n    }\n\n    // See if /etc/resolv.conf exists, and if not, try replacing it with the backup made earlier.\n    restoreResolvConfIfNeeded();\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;",
            "bool changedDir = false;",
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool changedDir = false;\nbool runningAsRoot = getuid() == 0;\n\nvoid enterChroot(bool inPidNamespace) {\n    KJ_REQUIRE(changedDir);\n\n    // Verify ownership is intact.\n    checkOwnedByRoot(\"..\", \"Install directory\");\n    checkOwnedByRoot(\".\", \"Version install directory\");\n    checkOwnedByRoot(\"sandstorm\", \"'sandstorm' executable\");\n    checkOwnedByRoot(\"../sandstorm.conf\", \"Config file\");\n\n    kj::StringPtr tmpfsUidOpts = \"\";\n    if (runningAsRoot) {\n      tmpfsUidOpts = \",uid=0,gid=0\";\n    } else {\n      unshareUidNamespaceOnce();\n    }\n\n    // Unshare the mount namespace, so we can create some private bind mounts.\n    KJ_SYSCALL(unshare(CLONE_NEWNS));\n\n    // To really unshare the mount namespace, we also have to make sure all mounts are private.\n    // The parameters here were derived by strace'ing `mount --make-rprivate /`.  AFAICT the flags\n    // are undocumented.  :(\n    KJ_SYSCALL(mount(\"none\", \"/\", nullptr, MS_REC | MS_PRIVATE, nullptr));\n\n    // Make sure that the current directory is a mount point so that we can use pivot_root.\n    KJ_SYSCALL(mount(\".\", \".\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Now change directory into the new mount point.\n    char cwdBuf[PATH_MAX + 1];\n    if (getcwd(cwdBuf, sizeof(cwdBuf)) == nullptr) {\n      KJ_FAIL_SYSCALL(\"getcwd\", errno);\n    }\n    KJ_SYSCALL(chdir(cwdBuf));\n\n    if (inPidNamespace) {\n      // Mount /proc for our PID namespace in the chroot.\n      KJ_SYSCALL(mount(\"proc\", \"proc\", \"proc\", MS_NOSUID | MS_NODEV | MS_NOEXEC, \"\"));\n    } else {\n      // Bind /proc for the global pid namespace in the chroot.\n      KJ_SYSCALL(mount(\"/proc\", \"proc\", nullptr, MS_BIND | MS_REC, nullptr));\n    }\n\n    // Bind var -> ../var, so that all versions share the same var.\n    // Same for tmp, though we clear it on every startup.\n    KJ_SYSCALL(mount(\"../var\", \"var\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"../tmp\", \"tmp\", nullptr, MS_BIND | MS_REC, nullptr));\n\n    // Bind devices from /dev into our chroot environment.\n    // We can't bind /dev itself because this is apparently not allowed when in a UID namespace\n    // (returns EINVAL; haven't figured out why yet).\n    KJ_SYSCALL(mount(\"/dev/null\", \"dev/null\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/zero\", \"dev/zero\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/random\", \"dev/random\", nullptr, MS_BIND, nullptr));\n    KJ_SYSCALL(mount(\"/dev/urandom\", \"dev/urandom\", nullptr, MS_BIND, nullptr));\n\n    if (runningAsRoot && access(\"/dev/fuse\", F_OK) == 0) {\n      // Bring in FUSE just in case we need it for \"spk dev\".\n      // TODO(cleanup): We should probably instead open /dev/fuse in the \"spk\" command (i.e.\n      //   outside the namespace) and then pass the FD to the server.\n      KJ_SYSCALL(mount(\"/dev/fuse\", \"dev/fuse\", nullptr, MS_BIND, nullptr));\n    }\n\n    // Bind in the host's /etc as /etc.host.\n    // As noted in backup.c++, MS_BIND does not respect mount flags on the initial bind, and\n    // we have to issue a remount to set them.  Because the host /etc may have been mounted nosuid,\n    // nodev, and noexec, we also add those flags here lest mount() think we're trying to remove\n    // them (which would cause mount() to fail).  We also need MS_REC because the host may have\n    // mounted other FSes under /etc, and we need to recursively rebind those.\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/etc\", \"etc.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n    // Then do the same for /run.\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr, MS_BIND | MS_REC, nullptr));\n    KJ_SYSCALL(mount(\"/run\", \"run.host\", nullptr,\n                     MS_BIND | MS_REC | MS_REMOUNT | MS_RDONLY | MS_NOSUID | MS_NODEV | MS_NOEXEC,\n                     nullptr));\n\n    // Mount a tmpfs at /run.\n    KJ_SYSCALL(mount(\"tmpfs\", \"run\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Mount a tmpfs at /etc.\n    KJ_SYSCALL(mount(\"tmpfs\", \"etc\", \"tmpfs\", MS_NOSUID | MS_NOEXEC,\n                     kj::str(\"size=2m,nr_inodes=128,mode=755\", tmpfsUidOpts).cStr()));\n    // Symlink in necessary config files from the host, as described in the bundle's host.list\n    linkHostFiles();\n    // And just in case the user has /etc/resolv.conf as a symlink to something we haven't linked\n    // in, copy its contents to /etc/resolv.conf.host-initial so we can use that if needed.\n    backupResolvConf();\n\n    // OK, change our root directory.\n    KJ_SYSCALL(syscall(SYS_pivot_root, \".\", \"tmp\"));\n    KJ_SYSCALL(chdir(\"/\"));\n    KJ_SYSCALL(umount2(\"tmp\", MNT_DETACH));\n\n    // The environment inherited from the host is probably no good for us. E.g. an oddball\n    // locale setting can crash Mongo because we don't have the appropriate locale files available.\n    //\n    // That said, there are a few environment variables that we do re-export.\n    std::map<const char*, kj::String> envVars;\n    static const char* const KEEP_VARS[] = {\"http_proxy\", \"https_proxy\"};\n    for (const char* varName: KEEP_VARS) {\n      const char* envValue = getenv(varName);\n      if (envValue != nullptr) {\n        envVars.insert(std::make_pair(varName, kj::str(envValue)));\n      }\n    }\n    KJ_SYSCALL(clearenv());\n\n    // Set up an environment appropriate for us.\n    KJ_SYSCALL(setenv(\"LANG\", \"C.UTF-8\", true));\n    KJ_SYSCALL(setenv(\"PATH\", \"/usr/bin:/bin\", true));\n    KJ_SYSCALL(setenv(\"LD_LIBRARY_PATH\", \"/usr/local/lib:/usr/lib:/lib\", true));\n\n    // Copy any remaining environment variables in that we captured.\n    for (auto& entry: envVars) {\n      KJ_SYSCALL(setenv(entry.first, entry.second.cStr(), true));\n    }\n\n    // See if /etc/resolv.conf exists, and if not, try replacing it with the backup made earlier.\n    restoreResolvConfIfNeeded();\n  }"
        }
      },
      {
        "call_info": {
          "callee": "readConfig",
          "args": [],
          "line": 901
        },
        "resolved": true,
        "details": {
          "function_name": "readConfig",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1561-1597",
          "snippet": "Config readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;",
            "else if (key == \"PORT\")",
            "else if (key == \"MONGO_PORT\")",
            "else if (key == \"BIND_IP\")",
            "else if (key == \"BASE_URL\")",
            "else if (key == \"WILDCARD_HOST\")",
            "else if (key == \"WILDCARD_PARENT_URL\")",
            "else if (key == \"DDP_DEFAULT_CONNECTION_URL\")",
            "else if (key == \"MAIL_URL\")",
            "else if (key == \"UPDATE_CHANNEL\")",
            "else if (key == \"SANDCATS_BASE_DOMAIN\")",
            "else if (key == \"ALLOW_DEMO_ACCOUNTS\")",
            "else if (key == \"ALLOW_DEV_ACCOUNTS\")",
            "else if (key == \"IS_TESTING\")",
            "else if (key == \"HIDE_TROUBLESHOOTING\")",
            "else if (key == \"SMTP_LISTEN_PORT\")"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\nelse if (key == \"PORT\");\nelse if (key == \"MONGO_PORT\");\nelse if (key == \"BIND_IP\");\nelse if (key == \"BASE_URL\");\nelse if (key == \"WILDCARD_HOST\");\nelse if (key == \"WILDCARD_PARENT_URL\");\nelse if (key == \"DDP_DEFAULT_CONNECTION_URL\");\nelse if (key == \"MAIL_URL\");\nelse if (key == \"UPDATE_CHANNEL\");\nelse if (key == \"SANDCATS_BASE_DOMAIN\");\nelse if (key == \"ALLOW_DEMO_ACCOUNTS\");\nelse if (key == \"ALLOW_DEV_ACCOUNTS\");\nelse if (key == \"IS_TESTING\");\nelse if (key == \"HIDE_TROUBLESHOOTING\");\nelse if (key == \"SMTP_LISTEN_PORT\");\n\nConfig readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }"
        }
      },
      {
        "call_info": {
          "callee": "context.exitError",
          "args": [
            "\"Sandstorm is not running.\""
          ],
          "line": 898
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getRunningPid",
          "args": [],
          "line": 897
        },
        "resolved": true,
        "details": {
          "function_name": "getRunningPid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1248-1254",
          "snippet": "kj::Maybe<pid_t> getRunningPid() {\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      return getRunningPid(*pf);\n    } else {\n      return nullptr;\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::Maybe<pid_t> getRunningPid() {\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      return getRunningPid(*pf);\n    } else {\n      return nullptr;\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 894
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::MainBuilder::Validity mongo() {\n    changeToInstallDir();\n\n    // Verify that Sandstorm is running.\n    if (getRunningPid() == nullptr) {\n      context.exitError(\"Sandstorm is not running.\");\n    }\n\n    const Config config = readConfig();\n\n    // We'll run under the chroot.\n    enterChroot(false);\n\n    // Don't run as root.\n    dropPrivs(config.uids);\n\n    // OK, run the Mongo client!\n    execMongoClient(config, {}, {});\n    KJ_UNREACHABLE;\n  }"
  },
  {
    "function_name": "restart",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "882-891",
    "snippet": "kj::MainBuilder::Validity restart() {\n    changeToInstallDir();\n\n    KJ_IF_MAYBE(pid, getRunningPid()) {\n      KJ_SYSCALL(kill(*pid, SIGHUP));\n      context.exitInfo(\"Restart request sent.\");\n    } else {\n      context.exitError(\"Sandstorm is not running.\");\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exitError",
          "args": [
            "\"Sandstorm is not running.\""
          ],
          "line": 889
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "\"Restart request sent.\""
          ],
          "line": 887
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "kill(*pid, SIGHUP)"
          ],
          "line": 886
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kill",
          "args": [
            "*pid",
            "SIGHUP"
          ],
          "line": 886
        },
        "resolved": true,
        "details": {
          "function_name": "killChild",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2377-2413",
          "snippet": "void killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nvoid killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 883
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nkj::MainBuilder::Validity restart() {\n    changeToInstallDir();\n\n    KJ_IF_MAYBE(pid, getRunningPid()) {\n      KJ_SYSCALL(kill(*pid, SIGHUP));\n      context.exitInfo(\"Restart request sent.\");\n    } else {\n      context.exitError(\"Sandstorm is not running.\");\n    }\n  }"
  },
  {
    "function_name": "status",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "872-880",
    "snippet": "kj::MainBuilder::Validity status() {\n    changeToInstallDir();\n\n    KJ_IF_MAYBE(pid, getRunningPid()) {\n      context.exitInfo(kj::str(\"Sandstorm is running; PID = \", *pid));\n    } else {\n      context.exitError(\"Sandstorm is not running.\");\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exitError",
          "args": [
            "\"Sandstorm is not running.\""
          ],
          "line": 878
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "kj::str(\"Sandstorm is running; PID = \", *pid)"
          ],
          "line": 876
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Sandstorm is running; PID = \"",
            "*pid"
          ],
          "line": 876
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 873
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nkj::MainBuilder::Validity status() {\n    changeToInstallDir();\n\n    KJ_IF_MAYBE(pid, getRunningPid()) {\n      context.exitInfo(kj::str(\"Sandstorm is running; PID = \", *pid));\n    } else {\n      context.exitError(\"Sandstorm is not running.\");\n    }\n  }"
  },
  {
    "function_name": "KJ_IF_MAYBE",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "859-861",
    "snippet": "KJ_IF_MAYBE(p, getRunningPid(pidfile)) {\n      pid = *p;\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;"
    ],
    "called_functions": [],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nKJ_IF_MAYBE(p, getRunningPid(pidfile)) {\n      pid = *p;\n    }"
  },
  {
    "function_name": "startStopFe",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "848-856",
    "snippet": "kj::MainBuilder::Validity startStopFe(int value) {\n    changeToInstallDir();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      context.exitInfo(\"Sandstorm is not running.\");\n    }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "\"Sandstorm is not running.\""
          ],
          "line": 855
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "*pf"
          ],
          "line": 853
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 849
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::MainBuilder::Validity startStopFe(int value) {\n    changeToInstallDir();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      context.exitInfo(\"Sandstorm is not running.\");\n    }"
  },
  {
    "function_name": "stopFe",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "844-846",
    "snippet": "kj::MainBuilder::Validity stopFe() {\n    return startStopFe(0);\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "startStopFe",
          "args": [
            "0"
          ],
          "line": 845
        },
        "resolved": true,
        "details": {
          "function_name": "startStopFe",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "848-856",
          "snippet": "kj::MainBuilder::Validity startStopFe(int value) {\n    changeToInstallDir();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      context.exitInfo(\"Sandstorm is not running.\");\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::MainBuilder::Validity startStopFe(int value) {\n    changeToInstallDir();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      context.exitInfo(\"Sandstorm is not running.\");\n    }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::MainBuilder::Validity stopFe() {\n    return startStopFe(0);\n  }"
  },
  {
    "function_name": "startFe",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "840-842",
    "snippet": "kj::MainBuilder::Validity startFe() {\n    return startStopFe(1);\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "startStopFe",
          "args": [
            "1"
          ],
          "line": 841
        },
        "resolved": true,
        "details": {
          "function_name": "startStopFe",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "848-856",
          "snippet": "kj::MainBuilder::Validity startStopFe(int value) {\n    changeToInstallDir();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      context.exitInfo(\"Sandstorm is not running.\");\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::MainBuilder::Validity startStopFe(int value) {\n    changeToInstallDir();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      context.exitInfo(\"Sandstorm is not running.\");\n    }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::MainBuilder::Validity startFe() {\n    return startStopFe(1);\n  }"
  },
  {
    "function_name": "stop",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "831-838",
    "snippet": "kj::MainBuilder::Validity stop() {\n    changeToInstallDir();\n    if (doStop()) {\n      context.exitInfo(\"Sandstorm server stopped.\");\n    } else {\n      context.exitInfo(\"Sandstorm is not running.\");\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "\"Sandstorm is not running.\""
          ],
          "line": 836
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "\"Sandstorm server stopped.\""
          ],
          "line": 834
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "doStop",
          "args": [],
          "line": 833
        },
        "resolved": true,
        "details": {
          "function_name": "doStop",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "771-829",
          "snippet": "bool doStop() {\n    // Stop Sandstorm. Don't return until it's stopped. Returns false if it wasn't running to start\n    // with.\n    KJ_ASSERT(changedDir);\n\n    registerAlarmHandler();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      return false;\n    }\n\n    pid_t pid;\n    KJ_IF_MAYBE(p, getRunningPid(pidfile)) {\n      pid = *p;\n    } else {\n      return false;\n    }\n\n    context.warning(kj::str(\"Waiting for PID \", pid, \" to terminate...\"));\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    // Timeout if not dead within 10 seconds.\n    uint timeout = 10;\n    KJ_SYSCALL(alarm(timeout));\n\n    // Take write lock on pidfile as a way to wait for exit.\n    struct flock lock;\n    memset(&lock, 0, sizeof(lock));\n    lock.l_type = F_WRLCK;\n    lock.l_whence = SEEK_SET;\n    lock.l_start = 0;\n    lock.l_len = 0;  // entire file\n\n    for (;;) {\n      if (fcntl(pidfile, F_SETLKW, &lock) >= 0) {\n        // Success.\n        break;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          context.warning(kj::str(\"Did not terminate after \", timeout, \" seconds; killing...\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Ignore signal.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLKW)\", error);\n      }\n    }\n\n    KJ_SYSCALL(alarm(0));\n    return true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;",
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool changedDir = false;\n\nbool doStop() {\n    // Stop Sandstorm. Don't return until it's stopped. Returns false if it wasn't running to start\n    // with.\n    KJ_ASSERT(changedDir);\n\n    registerAlarmHandler();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      return false;\n    }\n\n    pid_t pid;\n    KJ_IF_MAYBE(p, getRunningPid(pidfile)) {\n      pid = *p;\n    } else {\n      return false;\n    }\n\n    context.warning(kj::str(\"Waiting for PID \", pid, \" to terminate...\"));\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    // Timeout if not dead within 10 seconds.\n    uint timeout = 10;\n    KJ_SYSCALL(alarm(timeout));\n\n    // Take write lock on pidfile as a way to wait for exit.\n    struct flock lock;\n    memset(&lock, 0, sizeof(lock));\n    lock.l_type = F_WRLCK;\n    lock.l_whence = SEEK_SET;\n    lock.l_start = 0;\n    lock.l_len = 0;  // entire file\n\n    for (;;) {\n      if (fcntl(pidfile, F_SETLKW, &lock) >= 0) {\n        // Success.\n        break;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          context.warning(kj::str(\"Did not terminate after \", timeout, \" seconds; killing...\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Ignore signal.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLKW)\", error);\n      }\n    }\n\n    KJ_SYSCALL(alarm(0));\n    return true;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 832
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::MainBuilder::Validity stop() {\n    changeToInstallDir();\n    if (doStop()) {\n      context.exitInfo(\"Sandstorm server stopped.\");\n    } else {\n      context.exitInfo(\"Sandstorm is not running.\");\n    }\n  }"
  },
  {
    "function_name": "doStop",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "771-829",
    "snippet": "bool doStop() {\n    // Stop Sandstorm. Don't return until it's stopped. Returns false if it wasn't running to start\n    // with.\n    KJ_ASSERT(changedDir);\n\n    registerAlarmHandler();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      return false;\n    }\n\n    pid_t pid;\n    KJ_IF_MAYBE(p, getRunningPid(pidfile)) {\n      pid = *p;\n    } else {\n      return false;\n    }\n\n    context.warning(kj::str(\"Waiting for PID \", pid, \" to terminate...\"));\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    // Timeout if not dead within 10 seconds.\n    uint timeout = 10;\n    KJ_SYSCALL(alarm(timeout));\n\n    // Take write lock on pidfile as a way to wait for exit.\n    struct flock lock;\n    memset(&lock, 0, sizeof(lock));\n    lock.l_type = F_WRLCK;\n    lock.l_whence = SEEK_SET;\n    lock.l_start = 0;\n    lock.l_len = 0;  // entire file\n\n    for (;;) {\n      if (fcntl(pidfile, F_SETLKW, &lock) >= 0) {\n        // Success.\n        break;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          context.warning(kj::str(\"Did not terminate after \", timeout, \" seconds; killing...\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Ignore signal.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLKW)\", error);\n      }\n    }\n\n    KJ_SYSCALL(alarm(0));\n    return true;\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;",
      "bool changedDir = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "alarm(0)"
          ],
          "line": 827
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "alarm",
          "args": [
            "0"
          ],
          "line": 827
        },
        "resolved": true,
        "details": {
          "function_name": "alarmHandler",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "72-74",
          "snippet": "void alarmHandler(int) {\n  alarmed = true;\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid alarmHandler(int) {\n  alarmed = true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"fcntl(pidfile, F_SETLKW)\"",
            "error"
          ],
          "line": 823
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "kill(pid, SIGKILL)"
          ],
          "line": 817
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kill",
          "args": [
            "pid",
            "SIGKILL"
          ],
          "line": 817
        },
        "resolved": true,
        "details": {
          "function_name": "killChild",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "2377-2413",
          "snippet": "void killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "pid_t pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nvoid killChild(kj::StringPtr title, pid_t pid) {\n    if (pid == 0) {\n      // We use PID = 0 to indicate that a process isn't running, so there's nothing to do.\n      context.warning(kj::str(\"Not killing \", title, \" because it is not running.\"));\n      return;\n    }\n\n    int status;\n\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    alarmed = false;\n    uint timeout = 5;\n    KJ_SYSCALL(alarm(timeout));\n\n    for (;;) {\n      if (waitpid(pid, &status, 0) >= 0) {\n        KJ_SYSCALL(alarm(0));\n        return;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          // Termination timed out.  Kill hard.\n          context.warning(kj::str(\n              title, \" did not terminate after \", timeout, \" seconds; killing.\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Some other signal; ignore.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"waitpid()\", error, title);\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\"Did not terminate after \", timeout, \" seconds; killing...\")"
          ],
          "line": 816
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Did not terminate after \"",
            "timeout",
            "\" seconds; killing...\""
          ],
          "line": 816
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fcntl",
          "args": [
            "pidfile",
            "F_SETLKW",
            "&lock"
          ],
          "line": 808
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&lock",
            "0",
            "sizeof(lock)"
          ],
          "line": 801
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "alarm(timeout)"
          ],
          "line": 797
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "kill(pid, SIGTERM)"
          ],
          "line": 793
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "else {\n      return false;\n    }\n\n    context.warning",
          "args": [
            "kj::str(\"Waiting for PID \", pid, \" to terminate...\")"
          ],
          "line": 788
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Waiting for PID \"",
            "pid",
            "\" to terminate...\""
          ],
          "line": 792
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "*pf"
          ],
          "line": 780
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "registerAlarmHandler",
          "args": [],
          "line": 776
        },
        "resolved": true,
        "details": {
          "function_name": "registerAlarmHandler",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "75-80",
          "snippet": "void registerAlarmHandler() {\n  struct sigaction action;\n  memset(&action, 0, sizeof(action));\n  action.sa_handler = &alarmHandler;\n  KJ_SYSCALL(sigaction(SIGALRM, &action, nullptr));\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid registerAlarmHandler() {\n  struct sigaction action;\n  memset(&action, 0, sizeof(action));\n  action.sa_handler = &alarmHandler;\n  KJ_SYSCALL(sigaction(SIGALRM, &action, nullptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "changedDir"
          ],
          "line": 774
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nbool changedDir = false;\n\nbool doStop() {\n    // Stop Sandstorm. Don't return until it's stopped. Returns false if it wasn't running to start\n    // with.\n    KJ_ASSERT(changedDir);\n\n    registerAlarmHandler();\n\n    kj::AutoCloseFd pidfile = nullptr;\n    KJ_IF_MAYBE(pf, openPidfile()) {\n      pidfile = kj::mv(*pf);\n    } else {\n      return false;\n    }\n\n    pid_t pid;\n    KJ_IF_MAYBE(p, getRunningPid(pidfile)) {\n      pid = *p;\n    } else {\n      return false;\n    }\n\n    context.warning(kj::str(\"Waiting for PID \", pid, \" to terminate...\"));\n    KJ_SYSCALL(kill(pid, SIGTERM));\n\n    // Timeout if not dead within 10 seconds.\n    uint timeout = 10;\n    KJ_SYSCALL(alarm(timeout));\n\n    // Take write lock on pidfile as a way to wait for exit.\n    struct flock lock;\n    memset(&lock, 0, sizeof(lock));\n    lock.l_type = F_WRLCK;\n    lock.l_whence = SEEK_SET;\n    lock.l_start = 0;\n    lock.l_len = 0;  // entire file\n\n    for (;;) {\n      if (fcntl(pidfile, F_SETLKW, &lock) >= 0) {\n        // Success.\n        break;\n      }\n\n      int error = errno;\n      if (error == EINTR) {\n        if (alarmed) {\n          context.warning(kj::str(\"Did not terminate after \", timeout, \" seconds; killing...\"));\n          KJ_SYSCALL(kill(pid, SIGKILL));\n          alarmed = false;\n        } else {\n          // Ignore signal.\n        }\n      } else {\n        KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLKW)\", error);\n      }\n    }\n\n    KJ_SYSCALL(alarm(0));\n    return true;\n  }"
  },
  {
    "function_name": "continue_",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "754-769",
    "snippet": "kj::MainBuilder::Validity continue_() {\n    if (getpid() != 1) {\n      return \"This command is for internal use only.\";\n    }\n\n    if (unsharedUidNamespace) {\n      // Even if getuid() return zero, we aren't really root, it's just that we mapped our UID to\n      // zero in the UID namespace.\n      runningAsRoot = false;\n    }\n\n    changeToInstallDir();\n    Config config = readConfig();\n    FdBundle fdBundle(config, kj::mv(inheritedTcpPorts));\n    runUpdateMonitor(config, fdBundle, inheritedPidfile);\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "kj::AutoCloseFd inheritedPidfile;",
      "std::map<uint, kj::AutoCloseFd> inheritedTcpPorts;",
      "bool unsharedUidNamespace = false;",
      "bool runningAsRoot = getuid() == 0;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "runUpdateMonitor",
          "args": [
            "config",
            "fdBundle",
            "inheritedPidfile"
          ],
          "line": 768
        },
        "resolved": true,
        "details": {
          "function_name": "runUpdateMonitor",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1791-1920",
          "snippet": "[[noreturn]] void runUpdateMonitor(const Config& config, FdBundle& fdBundle, int pidfile) {\n    // Run the update monitor process.  This process runs two subprocesses:  the sandstorm server\n    // and the auto-updater.\n\n    if (runningAsRoot) {\n      // Fix permissions on pidfile. We do this here rather than back where we opened it because\n      // a previous version failed to do this and we want it fixed immediately on upgrade.\n      KJ_SYSCALL(fchown(pidfile, 0, config.uids.gid));\n      KJ_SYSCALL(fchmod(pidfile, 0660));\n\n      // Additionally, fix permissions on sandcats-related data, which was originally owned by root\n      fixSandcatsPermissions(config);\n\n      // Fix permissions on /var/sandstorm, which was originally owned by root:root.\n      KJ_SYSCALL(chown(\"../var/sandstorm\", 0, config.uids.gid));\n      KJ_SYSCALL(chmod(\"../var/sandstorm\", 0770));\n\n      // Fix permissions on /var/sandstorm/grains, which originally had mode 0730 because grain\n      // IDs were secret.\n      KJ_SYSCALL(chmod(\"../var/sandstorm/grains\", 0770));\n    }\n\n    cleanupOldVersions();\n\n    // Clean up the temp directory.\n    KJ_REQUIRE(changedDir);\n\n    static const char* const TMPDIRS[2] = { \"../tmp\", \"../var/sandstorm/tmp\" };\n    for (const char* tmpDir: TMPDIRS) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        if (access(tmpDir, F_OK) == 0) {\n          recursivelyDelete(tmpDir);\n        }\n        mkdir(tmpDir, 0770);\n        KJ_SYSCALL(chmod(tmpDir, 0770 | S_ISVTX));\n        if (runningAsRoot) {\n          KJ_SYSCALL(chown(tmpDir, 0, config.uids.gid));\n        }\n      })) {\n        KJ_LOG(WARNING, \"failed to clean up tmpdir; leaving it for now\", tmpDir, *exception);\n      }\n    }\n\n    auto sigfd = prepareMonitoringLoop();\n\n    pid_t updaterPid = startUpdater(config, fdBundle, false);\n\n    pid_t sandstormPid = fork();\n    if (sandstormPid == 0) {\n      runServerMonitor(config, fdBundle);\n      KJ_UNREACHABLE;\n    }\n\n    for (;;) {\n      // Wait for a signal -- any signal.\n      struct signalfd_siginfo siginfo;\n      KJ_SYSCALL(read(sigfd, &siginfo, sizeof(siginfo)));\n\n      if (siginfo.ssi_signo == SIGCHLD) {\n        // Some child exited.\n\n        // Reap zombies until there are no more.\n        bool updaterDied = false;\n        bool updaterSucceeded = false;\n        bool sandstormDied = false;\n        for (;;) {\n          int status;\n          pid_t deadPid = waitpid(-1, &status, WNOHANG);\n          if (deadPid <= 0) {\n            // No more zombies.\n            break;\n          } else if (deadPid == updaterPid) {\n            updaterDied = true;\n            updaterSucceeded = WIFEXITED(status) && WEXITSTATUS(status) == 0;\n          } else if (deadPid == sandstormPid) {\n            sandstormDied = true;\n          }\n        }\n\n        if (updaterSucceeded) {\n          context.warning(\"** Restarting to apply update\");\n          killChild(\"Server Monitor\", sandstormPid);\n          restartForUpdate(pidfile, fdBundle);\n          KJ_UNREACHABLE;\n        } else if (updaterDied) {\n          context.warning(\"** Updater died; restarting it\");\n          updaterPid = startUpdater(config, fdBundle, true);\n        } else if (sandstormDied) {\n          context.exitError(\"** Server monitor died. Aborting.\");\n          KJ_UNREACHABLE;\n        }\n      } else if (siginfo.ssi_signo == SIGINT) {\n        // Frontend startup or shutdown request, used with run-dev.\n\n        if (!siginfo.ssi_int) {\n          // We have to close all the listen ports otherwise run-dev won't be able to open them\n          // for itself. Note that we never re-open them here in the parent process, meaning that\n          // if you stop-fe and then start-fe and then do an update, you won't get a zero-downtime\n          // update. This only affects developers so whatever.\n          fdBundle.closeAll();\n        }\n\n        // Pass along to server monitor.\n        union sigval sigval;\n        memset(&sigval, 0, sizeof(sigval));\n        sigval.sival_int = siginfo.ssi_int;\n        KJ_SYSCALL(sigqueue(sandstormPid, SIGINT, sigval));\n      } else {\n        // Kill updater if it is running.\n        if (updaterPid != 0) {\n          KJ_SYSCALL(kill(updaterPid, SIGKILL));\n        }\n\n        // Shutdown server.\n        KJ_SYSCALL(kill(sandstormPid, SIGTERM));\n        int status;\n        KJ_SYSCALL(waitpid(sandstormPid, &status, 0));\n\n        // Handle signal.\n        if (siginfo.ssi_signo == SIGHUP) {\n          context.warning(\"** Restarting\");\n          restartForUpdate(pidfile, fdBundle);\n        } else {\n          // SIGTERM or something.\n          context.exitInfo(\"** Exiting\");\n        }\n        KJ_UNREACHABLE;\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "union sigval sigval;",
            "bool changedDir = false;",
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nunion sigval sigval;\nbool changedDir = false;\nbool runningAsRoot = getuid() == 0;\n\n[[noreturn]] void runUpdateMonitor(const Config& config, FdBundle& fdBundle, int pidfile) {\n    // Run the update monitor process.  This process runs two subprocesses:  the sandstorm server\n    // and the auto-updater.\n\n    if (runningAsRoot) {\n      // Fix permissions on pidfile. We do this here rather than back where we opened it because\n      // a previous version failed to do this and we want it fixed immediately on upgrade.\n      KJ_SYSCALL(fchown(pidfile, 0, config.uids.gid));\n      KJ_SYSCALL(fchmod(pidfile, 0660));\n\n      // Additionally, fix permissions on sandcats-related data, which was originally owned by root\n      fixSandcatsPermissions(config);\n\n      // Fix permissions on /var/sandstorm, which was originally owned by root:root.\n      KJ_SYSCALL(chown(\"../var/sandstorm\", 0, config.uids.gid));\n      KJ_SYSCALL(chmod(\"../var/sandstorm\", 0770));\n\n      // Fix permissions on /var/sandstorm/grains, which originally had mode 0730 because grain\n      // IDs were secret.\n      KJ_SYSCALL(chmod(\"../var/sandstorm/grains\", 0770));\n    }\n\n    cleanupOldVersions();\n\n    // Clean up the temp directory.\n    KJ_REQUIRE(changedDir);\n\n    static const char* const TMPDIRS[2] = { \"../tmp\", \"../var/sandstorm/tmp\" };\n    for (const char* tmpDir: TMPDIRS) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        if (access(tmpDir, F_OK) == 0) {\n          recursivelyDelete(tmpDir);\n        }\n        mkdir(tmpDir, 0770);\n        KJ_SYSCALL(chmod(tmpDir, 0770 | S_ISVTX));\n        if (runningAsRoot) {\n          KJ_SYSCALL(chown(tmpDir, 0, config.uids.gid));\n        }\n      })) {\n        KJ_LOG(WARNING, \"failed to clean up tmpdir; leaving it for now\", tmpDir, *exception);\n      }\n    }\n\n    auto sigfd = prepareMonitoringLoop();\n\n    pid_t updaterPid = startUpdater(config, fdBundle, false);\n\n    pid_t sandstormPid = fork();\n    if (sandstormPid == 0) {\n      runServerMonitor(config, fdBundle);\n      KJ_UNREACHABLE;\n    }\n\n    for (;;) {\n      // Wait for a signal -- any signal.\n      struct signalfd_siginfo siginfo;\n      KJ_SYSCALL(read(sigfd, &siginfo, sizeof(siginfo)));\n\n      if (siginfo.ssi_signo == SIGCHLD) {\n        // Some child exited.\n\n        // Reap zombies until there are no more.\n        bool updaterDied = false;\n        bool updaterSucceeded = false;\n        bool sandstormDied = false;\n        for (;;) {\n          int status;\n          pid_t deadPid = waitpid(-1, &status, WNOHANG);\n          if (deadPid <= 0) {\n            // No more zombies.\n            break;\n          } else if (deadPid == updaterPid) {\n            updaterDied = true;\n            updaterSucceeded = WIFEXITED(status) && WEXITSTATUS(status) == 0;\n          } else if (deadPid == sandstormPid) {\n            sandstormDied = true;\n          }\n        }\n\n        if (updaterSucceeded) {\n          context.warning(\"** Restarting to apply update\");\n          killChild(\"Server Monitor\", sandstormPid);\n          restartForUpdate(pidfile, fdBundle);\n          KJ_UNREACHABLE;\n        } else if (updaterDied) {\n          context.warning(\"** Updater died; restarting it\");\n          updaterPid = startUpdater(config, fdBundle, true);\n        } else if (sandstormDied) {\n          context.exitError(\"** Server monitor died. Aborting.\");\n          KJ_UNREACHABLE;\n        }\n      } else if (siginfo.ssi_signo == SIGINT) {\n        // Frontend startup or shutdown request, used with run-dev.\n\n        if (!siginfo.ssi_int) {\n          // We have to close all the listen ports otherwise run-dev won't be able to open them\n          // for itself. Note that we never re-open them here in the parent process, meaning that\n          // if you stop-fe and then start-fe and then do an update, you won't get a zero-downtime\n          // update. This only affects developers so whatever.\n          fdBundle.closeAll();\n        }\n\n        // Pass along to server monitor.\n        union sigval sigval;\n        memset(&sigval, 0, sizeof(sigval));\n        sigval.sival_int = siginfo.ssi_int;\n        KJ_SYSCALL(sigqueue(sandstormPid, SIGINT, sigval));\n      } else {\n        // Kill updater if it is running.\n        if (updaterPid != 0) {\n          KJ_SYSCALL(kill(updaterPid, SIGKILL));\n        }\n\n        // Shutdown server.\n        KJ_SYSCALL(kill(sandstormPid, SIGTERM));\n        int status;\n        KJ_SYSCALL(waitpid(sandstormPid, &status, 0));\n\n        // Handle signal.\n        if (siginfo.ssi_signo == SIGHUP) {\n          context.warning(\"** Restarting\");\n          restartForUpdate(pidfile, fdBundle);\n        } else {\n          // SIGTERM or something.\n          context.exitInfo(\"** Exiting\");\n        }\n        KJ_UNREACHABLE;\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "readConfig",
          "args": [],
          "line": 766
        },
        "resolved": true,
        "details": {
          "function_name": "readConfig",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1561-1597",
          "snippet": "Config readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;",
            "else if (key == \"PORT\")",
            "else if (key == \"MONGO_PORT\")",
            "else if (key == \"BIND_IP\")",
            "else if (key == \"BASE_URL\")",
            "else if (key == \"WILDCARD_HOST\")",
            "else if (key == \"WILDCARD_PARENT_URL\")",
            "else if (key == \"DDP_DEFAULT_CONNECTION_URL\")",
            "else if (key == \"MAIL_URL\")",
            "else if (key == \"UPDATE_CHANNEL\")",
            "else if (key == \"SANDCATS_BASE_DOMAIN\")",
            "else if (key == \"ALLOW_DEMO_ACCOUNTS\")",
            "else if (key == \"ALLOW_DEV_ACCOUNTS\")",
            "else if (key == \"IS_TESTING\")",
            "else if (key == \"HIDE_TROUBLESHOOTING\")",
            "else if (key == \"SMTP_LISTEN_PORT\")"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\nelse if (key == \"PORT\");\nelse if (key == \"MONGO_PORT\");\nelse if (key == \"BIND_IP\");\nelse if (key == \"BASE_URL\");\nelse if (key == \"WILDCARD_HOST\");\nelse if (key == \"WILDCARD_PARENT_URL\");\nelse if (key == \"DDP_DEFAULT_CONNECTION_URL\");\nelse if (key == \"MAIL_URL\");\nelse if (key == \"UPDATE_CHANNEL\");\nelse if (key == \"SANDCATS_BASE_DOMAIN\");\nelse if (key == \"ALLOW_DEMO_ACCOUNTS\");\nelse if (key == \"ALLOW_DEV_ACCOUNTS\");\nelse if (key == \"IS_TESTING\");\nelse if (key == \"HIDE_TROUBLESHOOTING\");\nelse if (key == \"SMTP_LISTEN_PORT\");\n\nConfig readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }"
        }
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 765
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "getpid",
          "args": [],
          "line": 755
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::AutoCloseFd inheritedPidfile;\nstd::map<uint, kj::AutoCloseFd> inheritedTcpPorts;\nbool unsharedUidNamespace = false;\nbool runningAsRoot = getuid() == 0;\n\nkj::MainBuilder::Validity continue_() {\n    if (getpid() != 1) {\n      return \"This command is for internal use only.\";\n    }\n\n    if (unsharedUidNamespace) {\n      // Even if getuid() return zero, we aren't really root, it's just that we mapped our UID to\n      // zero in the UID namespace.\n      runningAsRoot = false;\n    }\n\n    changeToInstallDir();\n    Config config = readConfig();\n    FdBundle fdBundle(config, kj::mv(inheritedTcpPorts));\n    runUpdateMonitor(config, fdBundle, inheritedPidfile);\n  }"
  },
  {
    "function_name": "Validity inheritPidfileFd",
    "container": "kj::MainBuilder",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "432-752",
    "snippet": "class RunBundleMain {\n  // Main class for the Sandstorm bundle runner.  This is a convenience tool for running the\n  // Sandstorm binary bundle, which is a packaged chroot environment containing everything needed\n  // to run a Sandstorm server.  Just unpack and run!\n\n  struct Config;\n\npublic:\n  RunBundleMain(kj::ProcessContext& context): context(context) {\n    // Make sure we didn't inherit a weird signal mask from the parent process.\n    clearSignalMask();\n    umask(0022);\n\n    if (!isKernelNewEnough()) {\n      context.exitError(\n          \"ERROR: Your Linux kernel is too old. You need at least kernel version 3.10.\");\n    }\n  }\n\n  kj::MainFunc getMain() {\n    static const char* VERSION = \"Sandstorm version \" SANDSTORM_VERSION;\n\n    {\n      auto programName = context.getProgramName();\n      if (programName.endsWith(\"supervisor\")) {  // historically \"sandstorm-supervisor\"\n        alternateMain = kj::heap<SupervisorMain>(context);\n        return alternateMain->getMain();\n      } else if (programName == \"spk\" || programName.endsWith(\"/spk\")) {\n        alternateMain = getSpkMain(context);\n        return alternateMain->getMain();\n      } else if (programName == \"backup\" || programName.endsWith(\"/backup\")) {\n        alternateMain = kj::heap<BackupMain>(context);\n        return alternateMain->getMain();\n      }\n    }\n\n    return kj::MainBuilder(context, VERSION,\n            \"Controls the Sandstorm server.\\n\\n\"\n            \"Something not working? Check the logs in SANDSTORM_HOME/var/log.\")\n        .addSubCommand(\"start\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION, \"Starts the Sandstorm server (default).\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, start))\n                  .build();\n            },\n            \"Start the sandstorm server.\")\n        .addSubCommand(\"stop\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION, \"Stops the Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, stop))\n                  .build();\n            },\n            \"Stop the sandstorm server.\")\n        .addSubCommand(\"start-fe\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                    \"Starts the Sandstorm front-end after it has previously been stopped using \"\n                    \"the `stop-fe` command.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, startFe))\n                  .build();\n            },\n            \"Undo previous stop-fe.\")\n        .addSubCommand(\"stop-fe\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                    \"Stops the Sandstorm front-end, but leaves Mongo running. Useful when you \"\n                    \"want to run the front-end in dev mode in front of the existing database \"\n                    \"and grains.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, stopFe))\n                  .build();\n            },\n            \"Stop the sandstorm front-end.\")\n        .addSubCommand(\"status\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Checks whether Sandstorm is running. Prints the pid and exits successfully \"\n                      \"if so; exits with an error otherwise.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, status))\n                  .build();\n            },\n            \"Check if Sandstorm is running.\")\n        .addSubCommand(\"restart\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION, \"Restarts Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, restart))\n                  .build();\n            },\n            \"Restart Sandstorm server.\")\n        .addSubCommand(\"mongo\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                  \"Runs MongoDB shell, connecting to the already-running Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, mongo))\n                  .build();\n            },\n            \"Run MongoDB shell.\")\n        .addSubCommand(\"update\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Updates the Sandstorm platform to a new version. If <release> is provided \"\n                      \"and specifies a bundle file (something like sandstorm-1234.tar.xz) it is \"\n                      \"used as the update. If <release> is a channel name, e.g. \\\"dev\\\", we \"\n                      \"securely check the web for an update. If <release> is not provided, we \"\n                      \"use the channel specified in the config file.\")\n                  .expectOptionalArg(\"<release>\", KJ_BIND_METHOD(*this, setUpdateFile))\n                  .callAfterParsing(KJ_BIND_METHOD(*this, update))\n                  .build();\n            },\n            \"Update the Sandstorm platform.\")\n        .addSubCommand(\"spk\",\n            [this]() {\n              alternateMain = getSpkMain(context);\n              return alternateMain->getMain();\n            },\n            \"Manipulate spk files.\")\n        .addSubCommand(\"continue\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"For internal use only: Continues running Sandstorm after an update. \"\n                      \"This command is invoked by the Sandstorm server itself. Do not run it \"\n                      \"directly.\")\n                  .addOption({\"userns\"}, [this]() { unsharedUidNamespace = true; return true; },\n                      \"Pass this flag if the parent has already set up and entered a UID \"\n                      \"namespace.\")\n                  .expectArg(\"<pidfile-fd>\", KJ_BIND_METHOD(*this, inheritPidfileFd))\n                  .expectZeroOrMoreArgs(\"<fd>:tcp:<port>\", KJ_BIND_METHOD(*this, inheritFd))\n                  .callAfterParsing(KJ_BIND_METHOD(*this, continue_))\n                  .build();\n            },\n            \"For internal use only.\")\n        .addSubCommand(\"dev\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"For internal use only: Runs an app in dev mode. This command is \"\n                      \"invoked by the `spk` tool. Do not run it directly.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, dev))\n                  .build();\n            },\n            \"For internal use only.\")\n        .addSubCommand(\"admin-token\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Generates a new admin token that you can use to access the admin settings \"\n                      \"page. This is meant for initial setup, or if an admin account is locked out.\")\n                  .addOption({'q', \"quiet\"}, [this]() { shortOutput = true; return true; },\n                      \"Output only the token.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, adminToken))\n                  .build();\n            },\n            \"Generate admin token.\")\n        .addSubCommand(\"uninstall\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Uninstalls Sandstorm.\")\n                  .addOption({\"delete-user-data\"}, [this]() { deleteUserData = true; return true; },\n                      \"Also delete all user data.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, uninstall))\n                  .build();\n            },\n            \"Uninstall Sandstorm.\")\n        .build();\n  }\n\n  kj::MainBuilder::Validity start() {\n    changeToInstallDir();\n    const Config config = readConfig();\n\n    // Check / lock the pidfile.\n    auto pidfile = raiiOpen(\"../var/pid/sandstorm.pid\", O_RDWR | O_CREAT | O_CLOEXEC, 0660);\n    {\n      struct flock lock;\n      memset(&lock, 0, sizeof(lock));\n      lock.l_type = F_WRLCK;\n      lock.l_whence = SEEK_SET;\n      lock.l_start = 0;\n      lock.l_len = 0;  // entire file\n      if (fcntl(pidfile, F_SETLK, &lock) < 0) {\n        int error = errno;\n        if (error == EACCES || error == EAGAIN) {\n          context.exitInfo(kj::str(\"Sandstorm is already running.  PID = \", readAll(pidfile)));\n        } else {\n          KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLK)\", error);\n        }\n      }\n\n      // It's ours.  Truncate for now so we can write in the new PID later.\n      KJ_SYSCALL(ftruncate(pidfile, 0));\n    }\n\n    if (!runningAsRoot) unshareUidNamespaceOnce();\n\n    // Unshare PID namespace so that daemon process becomes the root process of its own PID\n    // namespace and therefore if it dies the whole namespace is killed.\n    KJ_SYSCALL(unshare(CLONE_NEWPID));\n\n    // Daemonize ourselves.\n    pid_t mainPid;  // PID of the main process as seen *outside* the PID namespace.\n    {\n      int pipeFds[2];\n      KJ_SYSCALL(pipe2(pipeFds, O_CLOEXEC));\n      kj::AutoCloseFd pipeIn(pipeFds[0]), pipeOut(pipeFds[1]);\n\n      KJ_SYSCALL(mainPid = fork());\n      if (mainPid != 0) {\n        // Tell the child process its own PID, since being in a PID namespace its own getpid() will\n        // unhelpfully return 1.\n        pipeIn = nullptr;\n        kj::FdOutputStream(kj::mv(pipeOut)).write(&mainPid, sizeof(mainPid));\n\n        // Write the pidfile before exiting.\n        {\n          auto pidstr = kj::str(mainPid, '\\n');\n          kj::FdOutputStream((int)pidfile).write(pidstr.begin(), pidstr.size());\n        }\n\n        // Exit success.\n        context.exitInfo(kj::str(\"Sandstorm started. PID = \", mainPid));\n        return true;\n      }\n\n      // Read our (global) PID in from the parent process.\n      pipeOut = nullptr;\n      kj::FdInputStream(kj::mv(pipeIn)).read(&mainPid, sizeof(mainPid));\n    }\n\n    // Since we unshared the PID namespace, the first fork() should have produced pid 1 in the\n    // new namespace.  That means that if this pid ever exits, everything under it dies.  That's\n    // perfect!  Otherwise we'd have to carefully kill node and mongo separately.\n    KJ_ASSERT(getpid() == 1, \"unshare(CLONE_NEWPID) didn't do what I expected.\", getpid());\n\n    // Lock the pidfile and make sure it still belongs to us.\n    //\n    // We need to wait for the parent process to release its lock, so we use F_SETLKW.\n    // However, if another Sandstorm server is started simultaneously and manages to steal\n    // ownership, we want to detect this and exit, so we take a shared (read-only) lock.\n    {\n      struct flock lock;\n      memset(&lock, 0, sizeof(lock));\n      lock.l_type = F_RDLCK;\n      lock.l_whence = SEEK_SET;\n      lock.l_start = 0;\n      lock.l_len = 0;  // entire file\n      KJ_SYSCALL(fcntl(pidfile, F_SETLKW, &lock));\n\n      // Verify that we still own the file.\n      KJ_SYSCALL(lseek(pidfile, 0, SEEK_SET));\n      pid_t pidfilePid = KJ_ASSERT_NONNULL(parseUInt(trim(readAll(pidfile)), 10));\n      if (pidfilePid != mainPid) {\n        context.exitInfo(kj::str(\n            \"Oops, Sandstorm PID \", pidfilePid, \" just started. \"\n            \"PID \", mainPid, \" exiting in deference.\"));\n      }\n    }\n\n    // Redirect stdio.\n    {\n      auto logFd = raiiOpen(\"../var/log/sandstorm.log\", O_WRONLY | O_APPEND | O_CREAT, 0660);\n      if (runningAsRoot) { KJ_SYSCALL(fchown(logFd, config.uids.uid, config.uids.gid)); }\n      KJ_SYSCALL(dup2(logFd, STDOUT_FILENO));\n      KJ_SYSCALL(dup2(logFd, STDERR_FILENO));\n    }\n    {\n      auto nullFd = raiiOpen(\"/dev/null\", O_RDONLY);\n      KJ_SYSCALL(dup2(nullFd, STDIN_FILENO));\n    }\n\n    // Write time to log.\n    time_t now;\n    time(&now);\n    context.warning(kj::str(\"** Starting Sandstorm at: \", ctime(&now)));\n\n    // Detach from controlling terminal and make ourselves session leader.\n    KJ_SYSCALL(setsid());\n\n    FdBundle fdBundle(config);\n\n    runUpdateMonitor(config, fdBundle, pidfile);\n  }\n\n  kj::MainBuilder::Validity inheritFd(kj::StringPtr mapping) {\n    auto parts = split(mapping, ':');\n    if (parts.size() != 3) {\n      return \"invalid syntax for port mapping\";\n    }\n\n    int fd;\n    KJ_IF_MAYBE(p, parseUInt(kj::str(parts[0]), 10)) {\n      fd = *p;\n    } else {\n      return \"invalid fd\";\n    }\n\n    kj::String type = kj::str(parts[1]);\n    if (type != \"tcp\") {\n      return \"invalid type\";\n    }\n\n    uint port;\n    KJ_IF_MAYBE(p, parseUInt(kj::str(parts[2]), 10)) {\n      port = *p;\n    } else {\n      return \"invalid port\";\n    }\n\n    KJ_SYSCALL(ioctl(fd, FIOCLEX));  // set CLOEXEC\n    if (!inheritedTcpPorts.insert(std::make_pair(port, kj::AutoCloseFd(fd))).second) {\n      return \"duplicate port\";\n    }\n\n    return true;\n  }\n\n  kj::MainBuilder::Validity inheritPidfileFd(kj::StringPtr pidfileFdStr) {\n    KJ_IF_MAYBE(p, parseUInt(pidfileFdStr, 10)) {\n      inheritedPidfile = kj::AutoCloseFd(*p);\n      KJ_SYSCALL(ioctl(inheritedPidfile, FIOCLEX));  // set CLOEXEC\n      return true;\n    } else {\n      return \"invalid fd\";\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;",
      "kj::Own<AbstractMain> alternateMain;",
      "kj::AutoCloseFd inheritedPidfile;",
      "std::map<uint, kj::AutoCloseFd> inheritedTcpPorts;",
      "bool unsharedUidNamespace = false;",
      "bool runningAsRoot = getuid() == 0;",
      "bool shortOutput = false;",
      "bool deleteUserData = false;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "ioctl(inheritedPidfile, FIOCLEX)"
          ],
          "line": 747
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ioctl",
          "args": [
            "inheritedPidfile",
            "FIOCLEX"
          ],
          "line": 747
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::AutoCloseFd",
          "args": [
            "*p"
          ],
          "line": 746
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "p",
            "parseUInt(pidfileFdStr, 10)"
          ],
          "line": 745
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1662-1665",
          "snippet": "KJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKJ_IF_MAYBE(portValue, maybePortValue) {\n      auto ports = parsePorts(config.httpsPort, *portValue);\n      config.ports = kj::mv(ports);\n    }"
        }
      },
      {
        "call_info": {
          "callee": "parseUInt",
          "args": [
            "pidfileFdStr",
            "10"
          ],
          "line": 745
        },
        "resolved": true,
        "details": {
          "function_name": "parseUInt64",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "223-230",
          "snippet": "kj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "parts[1]"
          ],
          "line": 724
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "parts[0]"
          ],
          "line": 718
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "parts.size",
          "args": [],
          "line": 713
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "split",
          "args": [
            "mapping",
            "':'"
          ],
          "line": 712
        },
        "resolved": true,
        "details": {
          "function_name": "splitFirst",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "448-457",
          "snippet": "kj::Maybe<kj::ArrayPtr<const char>> splitFirst(kj::ArrayPtr<const char>& input, char delim) {\n  for (size_t i: kj::indices(input)) {\n    if (input[i] == delim) {\n      auto result = input.slice(0, i);\n      input = input.slice(i + 1, input.size());\n      return result;\n    }\n  }\n  return nullptr;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<kj::ArrayPtr<const char>> splitFirst(kj::ArrayPtr<const char>& input, char delim) {\n  for (size_t i: kj::indices(input)) {\n    if (input[i] == delim) {\n      auto result = input.slice(0, i);\n      input = input.slice(i + 1, input.size());\n      return result;\n    }\n  }\n  return nullptr;\n}"
        }
      },
      {
        "call_info": {
          "callee": "runUpdateMonitor",
          "args": [
            "config",
            "fdBundle",
            "pidfile"
          ],
          "line": 708
        },
        "resolved": true,
        "details": {
          "function_name": "runUpdateMonitor",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1791-1920",
          "snippet": "[[noreturn]] void runUpdateMonitor(const Config& config, FdBundle& fdBundle, int pidfile) {\n    // Run the update monitor process.  This process runs two subprocesses:  the sandstorm server\n    // and the auto-updater.\n\n    if (runningAsRoot) {\n      // Fix permissions on pidfile. We do this here rather than back where we opened it because\n      // a previous version failed to do this and we want it fixed immediately on upgrade.\n      KJ_SYSCALL(fchown(pidfile, 0, config.uids.gid));\n      KJ_SYSCALL(fchmod(pidfile, 0660));\n\n      // Additionally, fix permissions on sandcats-related data, which was originally owned by root\n      fixSandcatsPermissions(config);\n\n      // Fix permissions on /var/sandstorm, which was originally owned by root:root.\n      KJ_SYSCALL(chown(\"../var/sandstorm\", 0, config.uids.gid));\n      KJ_SYSCALL(chmod(\"../var/sandstorm\", 0770));\n\n      // Fix permissions on /var/sandstorm/grains, which originally had mode 0730 because grain\n      // IDs were secret.\n      KJ_SYSCALL(chmod(\"../var/sandstorm/grains\", 0770));\n    }\n\n    cleanupOldVersions();\n\n    // Clean up the temp directory.\n    KJ_REQUIRE(changedDir);\n\n    static const char* const TMPDIRS[2] = { \"../tmp\", \"../var/sandstorm/tmp\" };\n    for (const char* tmpDir: TMPDIRS) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        if (access(tmpDir, F_OK) == 0) {\n          recursivelyDelete(tmpDir);\n        }\n        mkdir(tmpDir, 0770);\n        KJ_SYSCALL(chmod(tmpDir, 0770 | S_ISVTX));\n        if (runningAsRoot) {\n          KJ_SYSCALL(chown(tmpDir, 0, config.uids.gid));\n        }\n      })) {\n        KJ_LOG(WARNING, \"failed to clean up tmpdir; leaving it for now\", tmpDir, *exception);\n      }\n    }\n\n    auto sigfd = prepareMonitoringLoop();\n\n    pid_t updaterPid = startUpdater(config, fdBundle, false);\n\n    pid_t sandstormPid = fork();\n    if (sandstormPid == 0) {\n      runServerMonitor(config, fdBundle);\n      KJ_UNREACHABLE;\n    }\n\n    for (;;) {\n      // Wait for a signal -- any signal.\n      struct signalfd_siginfo siginfo;\n      KJ_SYSCALL(read(sigfd, &siginfo, sizeof(siginfo)));\n\n      if (siginfo.ssi_signo == SIGCHLD) {\n        // Some child exited.\n\n        // Reap zombies until there are no more.\n        bool updaterDied = false;\n        bool updaterSucceeded = false;\n        bool sandstormDied = false;\n        for (;;) {\n          int status;\n          pid_t deadPid = waitpid(-1, &status, WNOHANG);\n          if (deadPid <= 0) {\n            // No more zombies.\n            break;\n          } else if (deadPid == updaterPid) {\n            updaterDied = true;\n            updaterSucceeded = WIFEXITED(status) && WEXITSTATUS(status) == 0;\n          } else if (deadPid == sandstormPid) {\n            sandstormDied = true;\n          }\n        }\n\n        if (updaterSucceeded) {\n          context.warning(\"** Restarting to apply update\");\n          killChild(\"Server Monitor\", sandstormPid);\n          restartForUpdate(pidfile, fdBundle);\n          KJ_UNREACHABLE;\n        } else if (updaterDied) {\n          context.warning(\"** Updater died; restarting it\");\n          updaterPid = startUpdater(config, fdBundle, true);\n        } else if (sandstormDied) {\n          context.exitError(\"** Server monitor died. Aborting.\");\n          KJ_UNREACHABLE;\n        }\n      } else if (siginfo.ssi_signo == SIGINT) {\n        // Frontend startup or shutdown request, used with run-dev.\n\n        if (!siginfo.ssi_int) {\n          // We have to close all the listen ports otherwise run-dev won't be able to open them\n          // for itself. Note that we never re-open them here in the parent process, meaning that\n          // if you stop-fe and then start-fe and then do an update, you won't get a zero-downtime\n          // update. This only affects developers so whatever.\n          fdBundle.closeAll();\n        }\n\n        // Pass along to server monitor.\n        union sigval sigval;\n        memset(&sigval, 0, sizeof(sigval));\n        sigval.sival_int = siginfo.ssi_int;\n        KJ_SYSCALL(sigqueue(sandstormPid, SIGINT, sigval));\n      } else {\n        // Kill updater if it is running.\n        if (updaterPid != 0) {\n          KJ_SYSCALL(kill(updaterPid, SIGKILL));\n        }\n\n        // Shutdown server.\n        KJ_SYSCALL(kill(sandstormPid, SIGTERM));\n        int status;\n        KJ_SYSCALL(waitpid(sandstormPid, &status, 0));\n\n        // Handle signal.\n        if (siginfo.ssi_signo == SIGHUP) {\n          context.warning(\"** Restarting\");\n          restartForUpdate(pidfile, fdBundle);\n        } else {\n          // SIGTERM or something.\n          context.exitInfo(\"** Exiting\");\n        }\n        KJ_UNREACHABLE;\n      }\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "union sigval sigval;",
            "bool changedDir = false;",
            "bool runningAsRoot = getuid() == 0;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nunion sigval sigval;\nbool changedDir = false;\nbool runningAsRoot = getuid() == 0;\n\n[[noreturn]] void runUpdateMonitor(const Config& config, FdBundle& fdBundle, int pidfile) {\n    // Run the update monitor process.  This process runs two subprocesses:  the sandstorm server\n    // and the auto-updater.\n\n    if (runningAsRoot) {\n      // Fix permissions on pidfile. We do this here rather than back where we opened it because\n      // a previous version failed to do this and we want it fixed immediately on upgrade.\n      KJ_SYSCALL(fchown(pidfile, 0, config.uids.gid));\n      KJ_SYSCALL(fchmod(pidfile, 0660));\n\n      // Additionally, fix permissions on sandcats-related data, which was originally owned by root\n      fixSandcatsPermissions(config);\n\n      // Fix permissions on /var/sandstorm, which was originally owned by root:root.\n      KJ_SYSCALL(chown(\"../var/sandstorm\", 0, config.uids.gid));\n      KJ_SYSCALL(chmod(\"../var/sandstorm\", 0770));\n\n      // Fix permissions on /var/sandstorm/grains, which originally had mode 0730 because grain\n      // IDs were secret.\n      KJ_SYSCALL(chmod(\"../var/sandstorm/grains\", 0770));\n    }\n\n    cleanupOldVersions();\n\n    // Clean up the temp directory.\n    KJ_REQUIRE(changedDir);\n\n    static const char* const TMPDIRS[2] = { \"../tmp\", \"../var/sandstorm/tmp\" };\n    for (const char* tmpDir: TMPDIRS) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        if (access(tmpDir, F_OK) == 0) {\n          recursivelyDelete(tmpDir);\n        }\n        mkdir(tmpDir, 0770);\n        KJ_SYSCALL(chmod(tmpDir, 0770 | S_ISVTX));\n        if (runningAsRoot) {\n          KJ_SYSCALL(chown(tmpDir, 0, config.uids.gid));\n        }\n      })) {\n        KJ_LOG(WARNING, \"failed to clean up tmpdir; leaving it for now\", tmpDir, *exception);\n      }\n    }\n\n    auto sigfd = prepareMonitoringLoop();\n\n    pid_t updaterPid = startUpdater(config, fdBundle, false);\n\n    pid_t sandstormPid = fork();\n    if (sandstormPid == 0) {\n      runServerMonitor(config, fdBundle);\n      KJ_UNREACHABLE;\n    }\n\n    for (;;) {\n      // Wait for a signal -- any signal.\n      struct signalfd_siginfo siginfo;\n      KJ_SYSCALL(read(sigfd, &siginfo, sizeof(siginfo)));\n\n      if (siginfo.ssi_signo == SIGCHLD) {\n        // Some child exited.\n\n        // Reap zombies until there are no more.\n        bool updaterDied = false;\n        bool updaterSucceeded = false;\n        bool sandstormDied = false;\n        for (;;) {\n          int status;\n          pid_t deadPid = waitpid(-1, &status, WNOHANG);\n          if (deadPid <= 0) {\n            // No more zombies.\n            break;\n          } else if (deadPid == updaterPid) {\n            updaterDied = true;\n            updaterSucceeded = WIFEXITED(status) && WEXITSTATUS(status) == 0;\n          } else if (deadPid == sandstormPid) {\n            sandstormDied = true;\n          }\n        }\n\n        if (updaterSucceeded) {\n          context.warning(\"** Restarting to apply update\");\n          killChild(\"Server Monitor\", sandstormPid);\n          restartForUpdate(pidfile, fdBundle);\n          KJ_UNREACHABLE;\n        } else if (updaterDied) {\n          context.warning(\"** Updater died; restarting it\");\n          updaterPid = startUpdater(config, fdBundle, true);\n        } else if (sandstormDied) {\n          context.exitError(\"** Server monitor died. Aborting.\");\n          KJ_UNREACHABLE;\n        }\n      } else if (siginfo.ssi_signo == SIGINT) {\n        // Frontend startup or shutdown request, used with run-dev.\n\n        if (!siginfo.ssi_int) {\n          // We have to close all the listen ports otherwise run-dev won't be able to open them\n          // for itself. Note that we never re-open them here in the parent process, meaning that\n          // if you stop-fe and then start-fe and then do an update, you won't get a zero-downtime\n          // update. This only affects developers so whatever.\n          fdBundle.closeAll();\n        }\n\n        // Pass along to server monitor.\n        union sigval sigval;\n        memset(&sigval, 0, sizeof(sigval));\n        sigval.sival_int = siginfo.ssi_int;\n        KJ_SYSCALL(sigqueue(sandstormPid, SIGINT, sigval));\n      } else {\n        // Kill updater if it is running.\n        if (updaterPid != 0) {\n          KJ_SYSCALL(kill(updaterPid, SIGKILL));\n        }\n\n        // Shutdown server.\n        KJ_SYSCALL(kill(sandstormPid, SIGTERM));\n        int status;\n        KJ_SYSCALL(waitpid(sandstormPid, &status, 0));\n\n        // Handle signal.\n        if (siginfo.ssi_signo == SIGHUP) {\n          context.warning(\"** Restarting\");\n          restartForUpdate(pidfile, fdBundle);\n        } else {\n          // SIGTERM or something.\n          context.exitInfo(\"** Exiting\");\n        }\n        KJ_UNREACHABLE;\n      }\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setsid()"
          ],
          "line": 704
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setsid",
          "args": [],
          "line": 704
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.warning",
          "args": [
            "kj::str(\"** Starting Sandstorm at: \", ctime(&now))"
          ],
          "line": 701
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"** Starting Sandstorm at: \"",
            "ctime(&now)"
          ],
          "line": 701
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ctime",
          "args": [
            "&now"
          ],
          "line": 701
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "time",
          "args": [
            "&now"
          ],
          "line": 700
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(nullFd, STDIN_FILENO)"
          ],
          "line": 695
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "nullFd",
            "STDIN_FILENO"
          ],
          "line": 695
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"/dev/null\"",
            "O_RDONLY"
          ],
          "line": 694
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(logFd, STDERR_FILENO)"
          ],
          "line": 691
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "logFd",
            "STDERR_FILENO"
          ],
          "line": 691
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(logFd, STDOUT_FILENO)"
          ],
          "line": 690
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "logFd",
            "STDOUT_FILENO"
          ],
          "line": 690
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fchown(logFd, config.uids.uid, config.uids.gid)"
          ],
          "line": 689
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fchown",
          "args": [
            "logFd",
            "config.uids.uid",
            "config.uids.gid"
          ],
          "line": 689
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "\"../var/log/sandstorm.log\"",
            "O_WRONLY | O_APPEND | O_CREAT",
            "0660"
          ],
          "line": 688
        },
        "resolved": true,
        "details": {
          "function_name": "raiiOpenIfExists",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "71-82",
          "snippet": "kj::Maybe<kj::AutoCloseFd> raiiOpenIfExists(kj::StringPtr name, int flags, mode_t mode) {\n  int fd = open(name.cStr(), flags, mode);\n  if (fd == -1) {\n    if (errno == ENOENT) {\n      return nullptr;\n    } else {\n      KJ_FAIL_SYSCALL(\"open\", errno, name);\n    }\n  } else {\n    return kj::AutoCloseFd(fd);\n  }\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<kj::AutoCloseFd> raiiOpenIfExists(kj::StringPtr name, int flags, mode_t mode) {\n  int fd = open(name.cStr(), flags, mode);\n  if (fd == -1) {\n    if (errno == ENOENT) {\n      return nullptr;\n    } else {\n      KJ_FAIL_SYSCALL(\"open\", errno, name);\n    }\n  } else {\n    return kj::AutoCloseFd(fd);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "kj::str(\n            \"Oops, Sandstorm PID \", pidfilePid, \" just started. \"\n            \"PID \", mainPid, \" exiting in deference.\")"
          ],
          "line": 680
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Oops, Sandstorm PID \"",
            "pidfilePid",
            "\" just started. \"\n            \"PID \"",
            "mainPid",
            "\" exiting in deference.\""
          ],
          "line": 680
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT_NONNULL",
          "args": [
            "parseUInt(trim(readAll(pidfile)), 10)"
          ],
          "line": 678
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "trim",
          "args": [
            "readAll(pidfile)"
          ],
          "line": 678
        },
        "resolved": true,
        "details": {
          "function_name": "trim",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "202-204",
          "snippet": "kj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String trim(kj::ArrayPtr<const char> slice) {\n  return kj::heapString(trimArray(slice));\n}"
        }
      },
      {
        "call_info": {
          "callee": "readAll",
          "args": [
            "pidfile"
          ],
          "line": 678
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "lseek(pidfile, 0, SEEK_SET)"
          ],
          "line": 677
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "lseek",
          "args": [
            "pidfile",
            "0",
            "SEEK_SET"
          ],
          "line": 677
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fcntl(pidfile, F_SETLKW, &lock)"
          ],
          "line": 674
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fcntl",
          "args": [
            "pidfile",
            "F_SETLKW",
            "&lock"
          ],
          "line": 674
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&lock",
            "0",
            "sizeof(lock)"
          ],
          "line": 669
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "getpid() == 1",
            "\"unshare(CLONE_NEWPID) didn't do what I expected.\"",
            "getpid()"
          ],
          "line": 660
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getpid",
          "args": [],
          "line": 660
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getpid",
          "args": [],
          "line": 660
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdInputStream",
          "args": [
            "&mainPid",
            "sizeof(mainPid)"
          ],
          "line": 654
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdInputStream",
          "args": [
            "kj::mv(pipeIn)"
          ],
          "line": 654
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "pipeIn"
          ],
          "line": 654
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "kj::str(\"Sandstorm started. PID = \", mainPid)"
          ],
          "line": 648
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Sandstorm started. PID = \"",
            "mainPid"
          ],
          "line": 648
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "pidstr.begin()",
            "pidstr.size()"
          ],
          "line": 644
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pidstr.begin",
          "args": [],
          "line": 644
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "(int)pidfile"
          ],
          "line": 644
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "mainPid",
            "'\\n'"
          ],
          "line": 643
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "&mainPid",
            "sizeof(mainPid)"
          ],
          "line": 639
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "kj::mv(pipeOut)"
          ],
          "line": 639
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "pipeOut"
          ],
          "line": 639
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "mainPid = fork()"
          ],
          "line": 634
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fork",
          "args": [],
          "line": 634
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "pipe2(pipeFds, O_CLOEXEC)"
          ],
          "line": 631
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pipe2",
          "args": [
            "pipeFds",
            "O_CLOEXEC"
          ],
          "line": 631
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unshare(CLONE_NEWPID)"
          ],
          "line": 625
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unshare",
          "args": [
            "CLONE_NEWPID"
          ],
          "line": 625
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unshareUidNamespaceOnce",
          "args": [],
          "line": 621
        },
        "resolved": true,
        "details": {
          "function_name": "unshareUidNamespaceOnce",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1306-1326",
          "snippet": "void unshareUidNamespaceOnce() {\n    if (!unsharedUidNamespace) {\n      uid_t uid = getuid();\n      gid_t gid = getgid();\n\n      KJ_SYSCALL(unshare(CLONE_NEWUSER));\n\n      // Set up the UID namespace. We map ourselves as UID zero because this allows capabilities\n      // to be inherited through exec(), which we need to support update and restart. With any\n      // other UID, capabilities can only be inherited through exec() if the target exec'd file\n      // has its inheritable capabilities set filled. By default, the inheritable capability set\n      // for all files is empty, and only the filesystem's superuser (i.e. not us) can change them.\n      // But if our UID is zero, then the file's attributes are ignored and all capabilities are\n      // inherited.\n      writeSetgroupsIfPresent(\"deny\\n\");\n      writeUserNSMap(\"uid\", kj::str(\"0 \", uid, \" 1\\n\"));\n      writeUserNSMap(\"gid\", kj::str(\"0 \", gid, \" 1\\n\"));\n\n      unsharedUidNamespace = true;\n    }\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool unsharedUidNamespace = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool unsharedUidNamespace = false;\n\nvoid unshareUidNamespaceOnce() {\n    if (!unsharedUidNamespace) {\n      uid_t uid = getuid();\n      gid_t gid = getgid();\n\n      KJ_SYSCALL(unshare(CLONE_NEWUSER));\n\n      // Set up the UID namespace. We map ourselves as UID zero because this allows capabilities\n      // to be inherited through exec(), which we need to support update and restart. With any\n      // other UID, capabilities can only be inherited through exec() if the target exec'd file\n      // has its inheritable capabilities set filled. By default, the inheritable capability set\n      // for all files is empty, and only the filesystem's superuser (i.e. not us) can change them.\n      // But if our UID is zero, then the file's attributes are ignored and all capabilities are\n      // inherited.\n      writeSetgroupsIfPresent(\"deny\\n\");\n      writeUserNSMap(\"uid\", kj::str(\"0 \", uid, \" 1\\n\"));\n      writeUserNSMap(\"gid\", kj::str(\"0 \", gid, \" 1\\n\"));\n\n      unsharedUidNamespace = true;\n    }\n  }"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "ftruncate(pidfile, 0)"
          ],
          "line": 618
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ftruncate",
          "args": [
            "pidfile",
            "0"
          ],
          "line": 618
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"fcntl(pidfile, F_SETLK)\"",
            "error"
          ],
          "line": 613
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitInfo",
          "args": [
            "kj::str(\"Sandstorm is already running.  PID = \", readAll(pidfile))"
          ],
          "line": 611
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"Sandstorm is already running.  PID = \"",
            "readAll(pidfile)"
          ],
          "line": 611
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fcntl",
          "args": [
            "pidfile",
            "F_SETLK",
            "&lock"
          ],
          "line": 608
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&lock",
            "0",
            "sizeof(lock)"
          ],
          "line": 603
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "readConfig",
          "args": [],
          "line": 597
        },
        "resolved": true,
        "details": {
          "function_name": "readConfig",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1561-1597",
          "snippet": "Config readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;",
            "else if (key == \"PORT\")",
            "else if (key == \"MONGO_PORT\")",
            "else if (key == \"BIND_IP\")",
            "else if (key == \"BASE_URL\")",
            "else if (key == \"WILDCARD_HOST\")",
            "else if (key == \"WILDCARD_PARENT_URL\")",
            "else if (key == \"DDP_DEFAULT_CONNECTION_URL\")",
            "else if (key == \"MAIL_URL\")",
            "else if (key == \"UPDATE_CHANNEL\")",
            "else if (key == \"SANDCATS_BASE_DOMAIN\")",
            "else if (key == \"ALLOW_DEMO_ACCOUNTS\")",
            "else if (key == \"ALLOW_DEV_ACCOUNTS\")",
            "else if (key == \"IS_TESTING\")",
            "else if (key == \"HIDE_TROUBLESHOOTING\")",
            "else if (key == \"SMTP_LISTEN_PORT\")"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\nelse if (key == \"PORT\");\nelse if (key == \"MONGO_PORT\");\nelse if (key == \"BIND_IP\");\nelse if (key == \"BASE_URL\");\nelse if (key == \"WILDCARD_HOST\");\nelse if (key == \"WILDCARD_PARENT_URL\");\nelse if (key == \"DDP_DEFAULT_CONNECTION_URL\");\nelse if (key == \"MAIL_URL\");\nelse if (key == \"UPDATE_CHANNEL\");\nelse if (key == \"SANDCATS_BASE_DOMAIN\");\nelse if (key == \"ALLOW_DEMO_ACCOUNTS\");\nelse if (key == \"ALLOW_DEV_ACCOUNTS\");\nelse if (key == \"IS_TESTING\");\nelse if (key == \"HIDE_TROUBLESHOOTING\");\nelse if (key == \"SMTP_LISTEN_PORT\");\n\nConfig readConfig() {\n    // Read and return the config file.\n    //\n    // If parseUids is true, we initialize `uids` from SERVER_USER.  This requires shelling\n    // out to id(1).  If false, we ignore SERVER_USER.\n\n    KJ_REQUIRE(changedDir);\n\n    Config config;\n\n    config.uids.uid = getuid();\n    config.uids.gid = getgid();\n\n    // Store the PORT and HTTPS_PORT values in variables here so we can\n    // process them at the end.\n    kj::Maybe<kj::String> maybePortValue = nullptr;\n\n    auto lines = splitLines(readAll(\"../sandstorm.conf\"));\n    for (auto& line: lines) {\n      auto equalsPos = KJ_ASSERT_NONNULL(line.findFirst('='), \"Invalid config line\", line);\n      auto key = trim(line.slice(0, equalsPos));\n      auto value = trim(line.slice(equalsPos + 1));\n\n      if (key == \"SERVER_USER\") {\n        KJ_IF_MAYBE(u, getUserIds(value)) {\n          config.uids = kj::mv(*u);\n          KJ_REQUIRE(config.uids.uid != 0, \"Sandstorm cannot run as root.\");\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value SERVER_USER\", value);\n        }\n      } else if (key == \"HTTPS_PORT\") {\n        KJ_IF_MAYBE(p, parseUInt(value, 10)) {\n          config.httpsPort = *p;\n        } else {\n          KJ_FAIL_REQUIRE(\"invalid config value HTTPS_PORT\", value);\n        }\n      }"
        }
      },
      {
        "call_info": {
          "callee": "changeToInstallDir",
          "args": [],
          "line": 596
        },
        "resolved": true,
        "details": {
          "function_name": "changeToInstallDir",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1198-1201",
          "snippet": "void changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "bool changedDir = false;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool changedDir = false;\n\nvoid changeToInstallDir() {\n    KJ_SYSCALL(chdir(getInstallDir().cStr()));\n    changedDir = true;\n  }"
        }
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"uninstall\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Uninstalls Sandstorm.\")\n                  .addOption({\"delete-user-data\"}, [this]() { deleteUserData = true; return true; },\n                      \"Also delete all user data.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, uninstall))\n                  .build();\n            }",
            "\"Uninstall Sandstorm.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 584
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "KJ_BIND_METHOD(*this, uninstall)"
          ],
          "line": 584
        },
        "resolved": true,
        "details": {
          "function_name": "Validity inheritPidfileFd",
          "container": "kj::MainBuilder",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "432-752",
          "snippet": "class RunBundleMain {\n  // Main class for the Sandstorm bundle runner.  This is a convenience tool for running the\n  // Sandstorm binary bundle, which is a packaged chroot environment containing everything needed\n  // to run a Sandstorm server.  Just unpack and run!\n\n  struct Config;\n\npublic:\n  RunBundleMain(kj::ProcessContext& context): context(context) {\n    // Make sure we didn't inherit a weird signal mask from the parent process.\n    clearSignalMask();\n    umask(0022);\n\n    if (!isKernelNewEnough()) {\n      context.exitError(\n          \"ERROR: Your Linux kernel is too old. You need at least kernel version 3.10.\");\n    }\n  }\n\n  kj::MainFunc getMain() {\n    static const char* VERSION = \"Sandstorm version \" SANDSTORM_VERSION;\n\n    {\n      auto programName = context.getProgramName();\n      if (programName.endsWith(\"supervisor\")) {  // historically \"sandstorm-supervisor\"\n        alternateMain = kj::heap<SupervisorMain>(context);\n        return alternateMain->getMain();\n      } else if (programName == \"spk\" || programName.endsWith(\"/spk\")) {\n        alternateMain = getSpkMain(context);\n        return alternateMain->getMain();\n      } else if (programName == \"backup\" || programName.endsWith(\"/backup\")) {\n        alternateMain = kj::heap<BackupMain>(context);\n        return alternateMain->getMain();\n      }\n    }\n\n    return kj::MainBuilder(context, VERSION,\n            \"Controls the Sandstorm server.\\n\\n\"\n            \"Something not working? Check the logs in SANDSTORM_HOME/var/log.\")\n        .addSubCommand(\"start\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION, \"Starts the Sandstorm server (default).\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, start))\n                  .build();\n            },\n            \"Start the sandstorm server.\")\n        .addSubCommand(\"stop\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION, \"Stops the Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, stop))\n                  .build();\n            },\n            \"Stop the sandstorm server.\")\n        .addSubCommand(\"start-fe\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                    \"Starts the Sandstorm front-end after it has previously been stopped using \"\n                    \"the `stop-fe` command.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, startFe))\n                  .build();\n            },\n            \"Undo previous stop-fe.\")\n        .addSubCommand(\"stop-fe\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                    \"Stops the Sandstorm front-end, but leaves Mongo running. Useful when you \"\n                    \"want to run the front-end in dev mode in front of the existing database \"\n                    \"and grains.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, stopFe))\n                  .build();\n            },\n            \"Stop the sandstorm front-end.\")\n        .addSubCommand(\"status\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Checks whether Sandstorm is running. Prints the pid and exits successfully \"\n                      \"if so; exits with an error otherwise.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, status))\n                  .build();\n            },\n            \"Check if Sandstorm is running.\")\n        .addSubCommand(\"restart\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION, \"Restarts Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, restart))\n                  .build();\n            },\n            \"Restart Sandstorm server.\")\n        .addSubCommand(\"mongo\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                  \"Runs MongoDB shell, connecting to the already-running Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, mongo))\n                  .build();\n            },\n            \"Run MongoDB shell.\")\n        .addSubCommand(\"update\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Updates the Sandstorm platform to a new version. If <release> is provided \"\n                      \"and specifies a bundle file (something like sandstorm-1234.tar.xz) it is \"\n                      \"used as the update. If <release> is a channel name, e.g. \\\"dev\\\", we \"\n                      \"securely check the web for an update. If <release> is not provided, we \"\n                      \"use the channel specified in the config file.\")\n                  .expectOptionalArg(\"<release>\", KJ_BIND_METHOD(*this, setUpdateFile))\n                  .callAfterParsing(KJ_BIND_METHOD(*this, update))\n                  .build();\n            },\n            \"Update the Sandstorm platform.\")\n        .addSubCommand(\"spk\",\n            [this]() {\n              alternateMain = getSpkMain(context);\n              return alternateMain->getMain();\n            },\n            \"Manipulate spk files.\")\n        .addSubCommand(\"continue\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"For internal use only: Continues running Sandstorm after an update. \"\n                      \"This command is invoked by the Sandstorm server itself. Do not run it \"\n                      \"directly.\")\n                  .addOption({\"userns\"}, [this]() { unsharedUidNamespace = true; return true; },\n                      \"Pass this flag if the parent has already set up and entered a UID \"\n                      \"namespace.\")\n                  .expectArg(\"<pidfile-fd>\", KJ_BIND_METHOD(*this, inheritPidfileFd))\n                  .expectZeroOrMoreArgs(\"<fd>:tcp:<port>\", KJ_BIND_METHOD(*this, inheritFd))\n                  .callAfterParsing(KJ_BIND_METHOD(*this, continue_))\n                  .build();\n            },\n            \"For internal use only.\")\n        .addSubCommand(\"dev\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"For internal use only: Runs an app in dev mode. This command is \"\n                      \"invoked by the `spk` tool. Do not run it directly.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, dev))\n                  .build();\n            },\n            \"For internal use only.\")\n        .addSubCommand(\"admin-token\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Generates a new admin token that you can use to access the admin settings \"\n                      \"page. This is meant for initial setup, or if an admin account is locked out.\")\n                  .addOption({'q', \"quiet\"}, [this]() { shortOutput = true; return true; },\n                      \"Output only the token.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, adminToken))\n                  .build();\n            },\n            \"Generate admin token.\")\n        .addSubCommand(\"uninstall\",\n            [this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Uninstalls Sandstorm.\")\n                  .addOption({\"delete-user-data\"}, [this]() { deleteUserData = true; return true; },\n                      \"Also delete all user data.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, uninstall))\n                  .build();\n            },\n            \"Uninstall Sandstorm.\")\n        .build();\n  }\n\n  kj::MainBuilder::Validity start() {\n    changeToInstallDir();\n    const Config config = readConfig();\n\n    // Check / lock the pidfile.\n    auto pidfile = raiiOpen(\"../var/pid/sandstorm.pid\", O_RDWR | O_CREAT | O_CLOEXEC, 0660);\n    {\n      struct flock lock;\n      memset(&lock, 0, sizeof(lock));\n      lock.l_type = F_WRLCK;\n      lock.l_whence = SEEK_SET;\n      lock.l_start = 0;\n      lock.l_len = 0;  // entire file\n      if (fcntl(pidfile, F_SETLK, &lock) < 0) {\n        int error = errno;\n        if (error == EACCES || error == EAGAIN) {\n          context.exitInfo(kj::str(\"Sandstorm is already running.  PID = \", readAll(pidfile)));\n        } else {\n          KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLK)\", error);\n        }\n      }\n\n      // It's ours.  Truncate for now so we can write in the new PID later.\n      KJ_SYSCALL(ftruncate(pidfile, 0));\n    }\n\n    if (!runningAsRoot) unshareUidNamespaceOnce();\n\n    // Unshare PID namespace so that daemon process becomes the root process of its own PID\n    // namespace and therefore if it dies the whole namespace is killed.\n    KJ_SYSCALL(unshare(CLONE_NEWPID));\n\n    // Daemonize ourselves.\n    pid_t mainPid;  // PID of the main process as seen *outside* the PID namespace.\n    {\n      int pipeFds[2];\n      KJ_SYSCALL(pipe2(pipeFds, O_CLOEXEC));\n      kj::AutoCloseFd pipeIn(pipeFds[0]), pipeOut(pipeFds[1]);\n\n      KJ_SYSCALL(mainPid = fork());\n      if (mainPid != 0) {\n        // Tell the child process its own PID, since being in a PID namespace its own getpid() will\n        // unhelpfully return 1.\n        pipeIn = nullptr;\n        kj::FdOutputStream(kj::mv(pipeOut)).write(&mainPid, sizeof(mainPid));\n\n        // Write the pidfile before exiting.\n        {\n          auto pidstr = kj::str(mainPid, '\\n');\n          kj::FdOutputStream((int)pidfile).write(pidstr.begin(), pidstr.size());\n        }\n\n        // Exit success.\n        context.exitInfo(kj::str(\"Sandstorm started. PID = \", mainPid));\n        return true;\n      }\n\n      // Read our (global) PID in from the parent process.\n      pipeOut = nullptr;\n      kj::FdInputStream(kj::mv(pipeIn)).read(&mainPid, sizeof(mainPid));\n    }\n\n    // Since we unshared the PID namespace, the first fork() should have produced pid 1 in the\n    // new namespace.  That means that if this pid ever exits, everything under it dies.  That's\n    // perfect!  Otherwise we'd have to carefully kill node and mongo separately.\n    KJ_ASSERT(getpid() == 1, \"unshare(CLONE_NEWPID) didn't do what I expected.\", getpid());\n\n    // Lock the pidfile and make sure it still belongs to us.\n    //\n    // We need to wait for the parent process to release its lock, so we use F_SETLKW.\n    // However, if another Sandstorm server is started simultaneously and manages to steal\n    // ownership, we want to detect this and exit, so we take a shared (read-only) lock.\n    {\n      struct flock lock;\n      memset(&lock, 0, sizeof(lock));\n      lock.l_type = F_RDLCK;\n      lock.l_whence = SEEK_SET;\n      lock.l_start = 0;\n      lock.l_len = 0;  // entire file\n      KJ_SYSCALL(fcntl(pidfile, F_SETLKW, &lock));\n\n      // Verify that we still own the file.\n      KJ_SYSCALL(lseek(pidfile, 0, SEEK_SET));\n      pid_t pidfilePid = KJ_ASSERT_NONNULL(parseUInt(trim(readAll(pidfile)), 10));\n      if (pidfilePid != mainPid) {\n        context.exitInfo(kj::str(\n            \"Oops, Sandstorm PID \", pidfilePid, \" just started. \"\n            \"PID \", mainPid, \" exiting in deference.\"));\n      }\n    }\n\n    // Redirect stdio.\n    {\n      auto logFd = raiiOpen(\"../var/log/sandstorm.log\", O_WRONLY | O_APPEND | O_CREAT, 0660);\n      if (runningAsRoot) { KJ_SYSCALL(fchown(logFd, config.uids.uid, config.uids.gid)); }\n      KJ_SYSCALL(dup2(logFd, STDOUT_FILENO));\n      KJ_SYSCALL(dup2(logFd, STDERR_FILENO));\n    }\n    {\n      auto nullFd = raiiOpen(\"/dev/null\", O_RDONLY);\n      KJ_SYSCALL(dup2(nullFd, STDIN_FILENO));\n    }\n\n    // Write time to log.\n    time_t now;\n    time(&now);\n    context.warning(kj::str(\"** Starting Sandstorm at: \", ctime(&now)));\n\n    // Detach from controlling terminal and make ourselves session leader.\n    KJ_SYSCALL(setsid());\n\n    FdBundle fdBundle(config);\n\n    runUpdateMonitor(config, fdBundle, pidfile);\n  }\n\n  kj::MainBuilder::Validity inheritFd(kj::StringPtr mapping) {\n    auto parts = split(mapping, ':');\n    if (parts.size() != 3) {\n      return \"invalid syntax for port mapping\";\n    }\n\n    int fd;\n    KJ_IF_MAYBE(p, parseUInt(kj::str(parts[0]), 10)) {\n      fd = *p;\n    } else {\n      return \"invalid fd\";\n    }\n\n    kj::String type = kj::str(parts[1]);\n    if (type != \"tcp\") {\n      return \"invalid type\";\n    }\n\n    uint port;\n    KJ_IF_MAYBE(p, parseUInt(kj::str(parts[2]), 10)) {\n      port = *p;\n    } else {\n      return \"invalid port\";\n    }\n\n    KJ_SYSCALL(ioctl(fd, FIOCLEX));  // set CLOEXEC\n    if (!inheritedTcpPorts.insert(std::make_pair(port, kj::AutoCloseFd(fd))).second) {\n      return \"duplicate port\";\n    }\n\n    return true;\n  }\n\n  kj::MainBuilder::Validity inheritPidfileFd(kj::StringPtr pidfileFdStr) {\n    KJ_IF_MAYBE(p, parseUInt(pidfileFdStr, 10)) {\n      inheritedPidfile = kj::AutoCloseFd(*p);\n      KJ_SYSCALL(ioctl(inheritedPidfile, FIOCLEX));  // set CLOEXEC\n      return true;\n    } else {\n      return \"invalid fd\";\n    }\n  }",
          "note": "cyclic_reference_detected"
        }
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "uninstall"
          ],
          "line": 588
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "{\"delete-user-data\"}",
            "[this]() { deleteUserData = true; return true; }",
            "\"Also delete all user data.\""
          ],
          "line": 584
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Uninstalls Sandstorm.\""
          ],
          "line": 584
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"admin-token\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Generates a new admin token that you can use to access the admin settings \"\n                      \"page. This is meant for initial setup, or if an admin account is locked out.\")\n                  .addOption({'q', \"quiet\"}, [this]() { shortOutput = true; return true; },\n                      \"Output only the token.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, adminToken))\n                  .build();\n            }",
            "\"Generate admin token.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 573
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "adminToken"
          ],
          "line": 578
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "{'q', \"quiet\"}",
            "[this]() { shortOutput = true; return true; }",
            "\"Output only the token.\""
          ],
          "line": 573
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Generates a new admin token that you can use to access the admin settings \"\n                      \"page. This is meant for initial setup, or if an admin account is locked out.\""
          ],
          "line": 573
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"dev\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"For internal use only: Runs an app in dev mode. This command is \"\n                      \"invoked by the `spk` tool. Do not run it directly.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, dev))\n                  .build();\n            }",
            "\"For internal use only.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 564
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "dev"
          ],
          "line": 567
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"For internal use only: Runs an app in dev mode. This command is \"\n                      \"invoked by the `spk` tool. Do not run it directly.\""
          ],
          "line": 564
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"continue\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"For internal use only: Continues running Sandstorm after an update. \"\n                      \"This command is invoked by the Sandstorm server itself. Do not run it \"\n                      \"directly.\")\n                  .addOption({\"userns\"}, [this]() { unsharedUidNamespace = true; return true; },\n                      \"Pass this flag if the parent has already set up and entered a UID \"\n                      \"namespace.\")\n                  .expectArg(\"<pidfile-fd>\", KJ_BIND_METHOD(*this, inheritPidfileFd))\n                  .expectZeroOrMoreArgs(\"<fd>:tcp:<port>\", KJ_BIND_METHOD(*this, inheritFd))\n                  .callAfterParsing(KJ_BIND_METHOD(*this, continue_))\n                  .build();\n            }",
            "\"For internal use only.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 549
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "continue_"
          ],
          "line": 558
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"<fd>:tcp:<port>\"",
            "KJ_BIND_METHOD(*this, inheritFd)"
          ],
          "line": 549
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "inheritFd"
          ],
          "line": 557
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"<pidfile-fd>\"",
            "KJ_BIND_METHOD(*this, inheritPidfileFd)"
          ],
          "line": 549
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "inheritPidfileFd"
          ],
          "line": 556
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "{\"userns\"}",
            "[this]() { unsharedUidNamespace = true; return true; }",
            "\"Pass this flag if the parent has already set up and entered a UID \"\n                      \"namespace.\""
          ],
          "line": 549
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"For internal use only: Continues running Sandstorm after an update. \"\n                      \"This command is invoked by the Sandstorm server itself. Do not run it \"\n                      \"directly.\""
          ],
          "line": 549
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"spk\"",
            "[this]() {\n              alternateMain = getSpkMain(context);\n              return alternateMain->getMain();\n            }",
            "\"Manipulate spk files.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "alternateMain->getMain",
          "args": [],
          "line": 544
        },
        "resolved": true,
        "details": {
          "function_name": "getMain",
          "container": "SupervisorMain",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/supervisor.c++",
          "lines": "562-595",
          "snippet": "kj::MainFunc SupervisorMain::getMain() {\n  return kj::MainBuilder(context, \"Sandstorm version \" SANDSTORM_VERSION,\n                         \"Runs a Sandstorm grain supervisor for the grain <grain-id>, which is \"\n                         \"an instance of app <app-id>.  Executes <command> inside the grain \"\n                         \"sandbox.\")\n      .addOptionWithArg({\"uid\"}, KJ_BIND_METHOD(*this, setUid), \"<uid>\",\n                        \"Use setuid sandbox rather than userns. Must start as root, but swiches \"\n                        \"to <uid> to run the app.\")\n      .addOptionWithArg({\"pkg\"}, KJ_BIND_METHOD(*this, setPkg), \"<path>\",\n                        \"Set directory containing the app package.  \"\n                        \"Defaults to '$SANDSTORM_HOME/var/sandstorm/apps/<app-name>'.\")\n      .addOptionWithArg({\"var\"}, KJ_BIND_METHOD(*this, setVar), \"<path>\",\n                        \"Set directory where grain's mutable persistent data will be stored.  \"\n                        \"Defaults to '$SANDSTORM_HOME/var/sandstorm/grains/<grain-id>'.\")\n      .addOptionWithArg({'e', \"env\"}, KJ_BIND_METHOD(*this, addEnv), \"<name>=<val>\",\n                        \"Set the environment variable <name> to <val> inside the sandbox.  Note \"\n                        \"that *no* environment variables are set by default.\")\n      .addOption({\"proc\"}, [this]() { setMountProc(true); return true; },\n                 \"Mount procfs inside the sandbox.  For security reasons, this is NOT \"\n                 \"RECOMMENDED during normal use, but it may be useful for debugging.\")\n      .addOption({\"stdio\"}, [this]() { keepStdio = true; return true; },\n                 \"Don't redirect the sandbox's stdio.  Useful for debugging.\")\n      .addOption({\"dev\"}, [this]() { devmode = true; return true; },\n                 \"Allow some system calls useful for debugging which are blocked in production.\")\n      .addOption({\"seccomp-dump-pfc\"}, [this]() { seccompDumpPfc = true; return true; },\n                 \"Dump libseccomp PFC output.\")\n      .addOption({'n', \"new\"}, [this]() { setIsNew(true); return true; },\n                 \"Initializes a new grain.  (Otherwise, runs an existing one.)\")\n      .expectArg(\"<app-name>\", KJ_BIND_METHOD(*this, setAppName))\n      .expectArg(\"<grain-id>\", KJ_BIND_METHOD(*this, setGrainId))\n      .expectOneOrMoreArgs(\"<command>\", KJ_BIND_METHOD(*this, addCommandArg))\n      .callAfterParsing(KJ_BIND_METHOD(*this, run))\n      .build();\n}",
          "includes": [
            "#include \"util.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <sandstorm/supervisor.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <seccomp.h>",
            "#include <sys/resource.h>",
            "#include <sys/eventfd.h>",
            "#include <linux/rtnetlink.h>",
            "#include <linux/netlink.h>",
            "#include <execinfo.h>",
            "#include <unordered_map>",
            "#include <map>",
            "#include <sys/inotify.h>",
            "#include <grp.h>",
            "#include <pwd.h>",
            "#include <dirent.h>",
            "#include <sched.h>",
            "#include <limits.h>",
            "#include <stdlib.h>",
            "#include <errno.h>",
            "#include <fcntl.h>",
            "#include <linux/netfilter/nf_nat.h>",
            "#include <sandstorm/ip_tables.h>  // created by Makefile from <linux/netfilter_ipv4/ip_tables.h>",
            "#include <linux/route.h>",
            "#include <linux/sockios.h>",
            "#include <sys/syscall.h>",
            "#include <sys/ptrace.h>",
            "#include <sys/capability.h>",
            "#include <sys/prctl.h>",
            "#include <sys/mount.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <sys/wait.h>",
            "#include <sys/time.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <netinet/in.h> // needs to be included before sys/capability.h",
            "#include <unistd.h>",
            "#include <capnp/rpc.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/io.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/async-io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>",
            "#include \"supervisor.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <sandstorm/supervisor.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <seccomp.h>\n#include <sys/resource.h>\n#include <sys/eventfd.h>\n#include <linux/rtnetlink.h>\n#include <linux/netlink.h>\n#include <execinfo.h>\n#include <unordered_map>\n#include <map>\n#include <sys/inotify.h>\n#include <grp.h>\n#include <pwd.h>\n#include <dirent.h>\n#include <sched.h>\n#include <limits.h>\n#include <stdlib.h>\n#include <errno.h>\n#include <fcntl.h>\n#include <linux/netfilter/nf_nat.h>\n#include <sandstorm/ip_tables.h>  // created by Makefile from <linux/netfilter_ipv4/ip_tables.h>\n#include <linux/route.h>\n#include <linux/sockios.h>\n#include <sys/syscall.h>\n#include <sys/ptrace.h>\n#include <sys/capability.h>\n#include <sys/prctl.h>\n#include <sys/mount.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <sys/wait.h>\n#include <sys/time.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <netinet/in.h> // needs to be included before sys/capability.h\n#include <unistd.h>\n#include <capnp/rpc.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/io.h>\n#include <kj/async-unix.h>\n#include <kj/async-io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n#include \"supervisor.h\"\n\nSupervisorMain {\n  kj::MainFunc SupervisorMain::getMain() {\n    return kj::MainBuilder(context, \"Sandstorm version \" SANDSTORM_VERSION,\n                           \"Runs a Sandstorm grain supervisor for the grain <grain-id>, which is \"\n                           \"an instance of app <app-id>.  Executes <command> inside the grain \"\n                           \"sandbox.\")\n        .addOptionWithArg({\"uid\"}, KJ_BIND_METHOD(*this, setUid), \"<uid>\",\n                          \"Use setuid sandbox rather than userns. Must start as root, but swiches \"\n                          \"to <uid> to run the app.\")\n        .addOptionWithArg({\"pkg\"}, KJ_BIND_METHOD(*this, setPkg), \"<path>\",\n                          \"Set directory containing the app package.  \"\n                          \"Defaults to '$SANDSTORM_HOME/var/sandstorm/apps/<app-name>'.\")\n        .addOptionWithArg({\"var\"}, KJ_BIND_METHOD(*this, setVar), \"<path>\",\n                          \"Set directory where grain's mutable persistent data will be stored.  \"\n                          \"Defaults to '$SANDSTORM_HOME/var/sandstorm/grains/<grain-id>'.\")\n        .addOptionWithArg({'e', \"env\"}, KJ_BIND_METHOD(*this, addEnv), \"<name>=<val>\",\n                          \"Set the environment variable <name> to <val> inside the sandbox.  Note \"\n                          \"that *no* environment variables are set by default.\")\n        .addOption({\"proc\"}, [this]() { setMountProc(true); return true; },\n                   \"Mount procfs inside the sandbox.  For security reasons, this is NOT \"\n                   \"RECOMMENDED during normal use, but it may be useful for debugging.\")\n        .addOption({\"stdio\"}, [this]() { keepStdio = true; return true; },\n                   \"Don't redirect the sandbox's stdio.  Useful for debugging.\")\n        .addOption({\"dev\"}, [this]() { devmode = true; return true; },\n                   \"Allow some system calls useful for debugging which are blocked in production.\")\n        .addOption({\"seccomp-dump-pfc\"}, [this]() { seccompDumpPfc = true; return true; },\n                   \"Dump libseccomp PFC output.\")\n        .addOption({'n', \"new\"}, [this]() { setIsNew(true); return true; },\n                   \"Initializes a new grain.  (Otherwise, runs an existing one.)\")\n        .expectArg(\"<app-name>\", KJ_BIND_METHOD(*this, setAppName))\n        .expectArg(\"<grain-id>\", KJ_BIND_METHOD(*this, setGrainId))\n        .expectOneOrMoreArgs(\"<command>\", KJ_BIND_METHOD(*this, addCommandArg))\n        .callAfterParsing(KJ_BIND_METHOD(*this, run))\n        .build();\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "getSpkMain",
          "args": [
            "context"
          ],
          "line": 543
        },
        "resolved": true,
        "details": {
          "function_name": "getSpkMain",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/spk.c++",
          "lines": "2432-2434",
          "snippet": "kj::Own<AbstractMain> getSpkMain(kj::ProcessContext& context) {\n  return kj::heap<SpkTool>(context);\n}",
          "includes": [
            "#include \"appid-replacements.h\"",
            "#include \"id-to-text.h\"",
            "#include \"util.h\"",
            "#include \"send-fd.h\"",
            "#include \"union-fs.h\"",
            "#include \"fuse.h\"",
            "#include \"version.h\"",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <sandstorm/app-index/submit.capnp.h>",
            "#include <poll.h>",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema-parser.h>",
            "#include <sys/xattr.h>",
            "#include <map>",
            "#include <set>",
            "#include <dirent.h>",
            "#include <stdlib.h>",
            "#include <sandstorm/appid-replacements.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <errno.h>",
            "#include <sys/mman.h>",
            "#include <sys/wait.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdio.h>",
            "#include <fcntl.h>",
            "#include <unistd.h>",
            "#include <sodium/crypto_hash_sha512.h>",
            "#include <sodium/crypto_hash_sha256.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize-packed.h>",
            "#include <capnp/serialize.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include \"spk.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"appid-replacements.h\"\n#include \"id-to-text.h\"\n#include \"util.h\"\n#include \"send-fd.h\"\n#include \"union-fs.h\"\n#include \"fuse.h\"\n#include \"version.h\"\n#include <sodium/crypto_generichash_blake2b.h>\n#include <sandstorm/app-index/submit.capnp.h>\n#include <poll.h>\n#include <time.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema-parser.h>\n#include <sys/xattr.h>\n#include <map>\n#include <set>\n#include <dirent.h>\n#include <stdlib.h>\n#include <sandstorm/appid-replacements.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <sys/wait.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <unistd.h>\n#include <sodium/crypto_hash_sha512.h>\n#include <sodium/crypto_hash_sha256.h>\n#include <sodium/crypto_sign.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include \"spk.h\"\n\nkj::Own<AbstractMain> getSpkMain(kj::ProcessContext& context) {\n  return kj::heap<SpkTool>(context);\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"update\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Updates the Sandstorm platform to a new version. If <release> is provided \"\n                      \"and specifies a bundle file (something like sandstorm-1234.tar.xz) it is \"\n                      \"used as the update. If <release> is a channel name, e.g. \\\"dev\\\", we \"\n                      \"securely check the web for an update. If <release> is not provided, we \"\n                      \"use the channel specified in the config file.\")\n                  .expectOptionalArg(\"<release>\", KJ_BIND_METHOD(*this, setUpdateFile))\n                  .callAfterParsing(KJ_BIND_METHOD(*this, update))\n                  .build();\n            }",
            "\"Update the Sandstorm platform.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 530
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "update"
          ],
          "line": 537
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"<release>\"",
            "KJ_BIND_METHOD(*this, setUpdateFile)"
          ],
          "line": 530
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "setUpdateFile"
          ],
          "line": 536
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Updates the Sandstorm platform to a new version. If <release> is provided \"\n                      \"and specifies a bundle file (something like sandstorm-1234.tar.xz) it is \"\n                      \"used as the update. If <release> is a channel name, e.g. \\\"dev\\\", we \"\n                      \"securely check the web for an update. If <release> is not provided, we \"\n                      \"use the channel specified in the config file.\""
          ],
          "line": 530
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"mongo\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION,\n                  \"Runs MongoDB shell, connecting to the already-running Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, mongo))\n                  .build();\n            }",
            "\"Run MongoDB shell.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 522
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "mongo"
          ],
          "line": 524
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Runs MongoDB shell, connecting to the already-running Sandstorm server.\""
          ],
          "line": 522
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"restart\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION, \"Restarts Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, restart))\n                  .build();\n            }",
            "\"Restart Sandstorm server.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 515
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "restart"
          ],
          "line": 516
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Restarts Sandstorm server.\""
          ],
          "line": 515
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"status\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION,\n                      \"Checks whether Sandstorm is running. Prints the pid and exits successfully \"\n                      \"if so; exits with an error otherwise.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, status))\n                  .build();\n            }",
            "\"Check if Sandstorm is running.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 506
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "status"
          ],
          "line": 509
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Checks whether Sandstorm is running. Prints the pid and exits successfully \"\n                      \"if so; exits with an error otherwise.\""
          ],
          "line": 506
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"stop-fe\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION,\n                    \"Stops the Sandstorm front-end, but leaves Mongo running. Useful when you \"\n                    \"want to run the front-end in dev mode in front of the existing database \"\n                    \"and grains.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, stopFe))\n                  .build();\n            }",
            "\"Stop the sandstorm front-end.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 496
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "stopFe"
          ],
          "line": 500
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Stops the Sandstorm front-end, but leaves Mongo running. Useful when you \"\n                    \"want to run the front-end in dev mode in front of the existing database \"\n                    \"and grains.\""
          ],
          "line": 496
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"start-fe\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION,\n                    \"Starts the Sandstorm front-end after it has previously been stopped using \"\n                    \"the `stop-fe` command.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, startFe))\n                  .build();\n            }",
            "\"Undo previous stop-fe.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 487
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "startFe"
          ],
          "line": 490
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Starts the Sandstorm front-end after it has previously been stopped using \"\n                    \"the `stop-fe` command.\""
          ],
          "line": 487
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"stop\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION, \"Stops the Sandstorm server.\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, stop))\n                  .build();\n            }",
            "\"Stop the sandstorm server.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 480
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "stop"
          ],
          "line": 481
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Stops the Sandstorm server.\""
          ],
          "line": 480
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "\"start\"",
            "[this]() {\n              return kj::MainBuilder(context, VERSION, \"Starts the Sandstorm server (default).\")\n                  .callAfterParsing(KJ_BIND_METHOD(*this, start))\n                  .build();\n            }",
            "\"Start the sandstorm server.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [],
          "line": 473
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_BIND_METHOD",
          "args": [
            "*this",
            "start"
          ],
          "line": 474
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Starts the Sandstorm server (default).\""
          ],
          "line": 473
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::MainBuilder",
          "args": [
            "context",
            "VERSION",
            "\"Controls the Sandstorm server.\\n\\n\"\n            \"Something not working? Check the logs in SANDSTORM_HOME/var/log.\""
          ],
          "line": 468
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heap<BackupMain>",
          "args": [
            "context"
          ],
          "line": 463
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "programName.endsWith",
          "args": [
            "\"/backup\""
          ],
          "line": 462
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "programName.endsWith",
          "args": [
            "\"/spk\""
          ],
          "line": 459
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heap<SupervisorMain>",
          "args": [
            "context"
          ],
          "line": 457
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "programName.endsWith",
          "args": [
            "\"supervisor\""
          ],
          "line": 456
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getProgramName",
          "args": [],
          "line": 455
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.exitError",
          "args": [
            "\"ERROR: Your Linux kernel is too old. You need at least kernel version 3.10.\""
          ],
          "line": 446
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "isKernelNewEnough",
          "args": [],
          "line": 445
        },
        "resolved": true,
        "details": {
          "function_name": "isKernelNewEnough",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "173-181",
          "snippet": "bool isKernelNewEnough() {\n  auto version = getKernelVersion();\n  if (version.major < 3 || (version.major == 3 && version.minor < 10)) {\n    // Insufficient kernel version.\n    return false;\n  }\n\n  return true;\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool isKernelNewEnough() {\n  auto version = getKernelVersion();\n  if (version.major < 3 || (version.major == 3 && version.minor < 10)) {\n    // Insufficient kernel version.\n    return false;\n  }\n\n  return true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "umask",
          "args": [
            "0022"
          ],
          "line": 443
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "clearSignalMask",
          "args": [],
          "line": 442
        },
        "resolved": true,
        "details": {
          "function_name": "clearSignalMask",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "1499-1503",
          "snippet": "void clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid clearSignalMask() {\n    sigset_t sigset;\n    KJ_SYSCALL(sigemptyset(&sigset));\n    KJ_SYSCALL(sigprocmask(SIG_SETMASK, &sigset, nullptr));\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\nkj::Own<AbstractMain> alternateMain;\nkj::AutoCloseFd inheritedPidfile;\nstd::map<uint, kj::AutoCloseFd> inheritedTcpPorts;\nbool unsharedUidNamespace = false;\nbool runningAsRoot = getuid() == 0;\nbool shortOutput = false;\nbool deleteUserData = false;\n\nkj {\n  MainBuilder {\n    class RunBundleMain {\n      // Main class for the Sandstorm bundle runner.  This is a convenience tool for running the\n      // Sandstorm binary bundle, which is a packaged chroot environment containing everything needed\n      // to run a Sandstorm server.  Just unpack and run!\n    \n      struct Config;\n    \n    public:\n      RunBundleMain(kj::ProcessContext& context): context(context) {\n        // Make sure we didn't inherit a weird signal mask from the parent process.\n        clearSignalMask();\n        umask(0022);\n    \n        if (!isKernelNewEnough()) {\n          context.exitError(\n              \"ERROR: Your Linux kernel is too old. You need at least kernel version 3.10.\");\n        }\n      }\n    \n      kj::MainFunc getMain() {\n        static const char* VERSION = \"Sandstorm version \" SANDSTORM_VERSION;\n    \n        {\n          auto programName = context.getProgramName();\n          if (programName.endsWith(\"supervisor\")) {  // historically \"sandstorm-supervisor\"\n            alternateMain = kj::heap<SupervisorMain>(context);\n            return alternateMain->getMain();\n          } else if (programName == \"spk\" || programName.endsWith(\"/spk\")) {\n            alternateMain = getSpkMain(context);\n            return alternateMain->getMain();\n          } else if (programName == \"backup\" || programName.endsWith(\"/backup\")) {\n            alternateMain = kj::heap<BackupMain>(context);\n            return alternateMain->getMain();\n          }\n        }\n    \n        return kj::MainBuilder(context, VERSION,\n                \"Controls the Sandstorm server.\\n\\n\"\n                \"Something not working? Check the logs in SANDSTORM_HOME/var/log.\")\n            .addSubCommand(\"start\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION, \"Starts the Sandstorm server (default).\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, start))\n                      .build();\n                },\n                \"Start the sandstorm server.\")\n            .addSubCommand(\"stop\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION, \"Stops the Sandstorm server.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, stop))\n                      .build();\n                },\n                \"Stop the sandstorm server.\")\n            .addSubCommand(\"start-fe\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                        \"Starts the Sandstorm front-end after it has previously been stopped using \"\n                        \"the `stop-fe` command.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, startFe))\n                      .build();\n                },\n                \"Undo previous stop-fe.\")\n            .addSubCommand(\"stop-fe\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                        \"Stops the Sandstorm front-end, but leaves Mongo running. Useful when you \"\n                        \"want to run the front-end in dev mode in front of the existing database \"\n                        \"and grains.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, stopFe))\n                      .build();\n                },\n                \"Stop the sandstorm front-end.\")\n            .addSubCommand(\"status\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"Checks whether Sandstorm is running. Prints the pid and exits successfully \"\n                          \"if so; exits with an error otherwise.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, status))\n                      .build();\n                },\n                \"Check if Sandstorm is running.\")\n            .addSubCommand(\"restart\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION, \"Restarts Sandstorm server.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, restart))\n                      .build();\n                },\n                \"Restart Sandstorm server.\")\n            .addSubCommand(\"mongo\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                      \"Runs MongoDB shell, connecting to the already-running Sandstorm server.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, mongo))\n                      .build();\n                },\n                \"Run MongoDB shell.\")\n            .addSubCommand(\"update\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"Updates the Sandstorm platform to a new version. If <release> is provided \"\n                          \"and specifies a bundle file (something like sandstorm-1234.tar.xz) it is \"\n                          \"used as the update. If <release> is a channel name, e.g. \\\"dev\\\", we \"\n                          \"securely check the web for an update. If <release> is not provided, we \"\n                          \"use the channel specified in the config file.\")\n                      .expectOptionalArg(\"<release>\", KJ_BIND_METHOD(*this, setUpdateFile))\n                      .callAfterParsing(KJ_BIND_METHOD(*this, update))\n                      .build();\n                },\n                \"Update the Sandstorm platform.\")\n            .addSubCommand(\"spk\",\n                [this]() {\n                  alternateMain = getSpkMain(context);\n                  return alternateMain->getMain();\n                },\n                \"Manipulate spk files.\")\n            .addSubCommand(\"continue\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"For internal use only: Continues running Sandstorm after an update. \"\n                          \"This command is invoked by the Sandstorm server itself. Do not run it \"\n                          \"directly.\")\n                      .addOption({\"userns\"}, [this]() { unsharedUidNamespace = true; return true; },\n                          \"Pass this flag if the parent has already set up and entered a UID \"\n                          \"namespace.\")\n                      .expectArg(\"<pidfile-fd>\", KJ_BIND_METHOD(*this, inheritPidfileFd))\n                      .expectZeroOrMoreArgs(\"<fd>:tcp:<port>\", KJ_BIND_METHOD(*this, inheritFd))\n                      .callAfterParsing(KJ_BIND_METHOD(*this, continue_))\n                      .build();\n                },\n                \"For internal use only.\")\n            .addSubCommand(\"dev\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"For internal use only: Runs an app in dev mode. This command is \"\n                          \"invoked by the `spk` tool. Do not run it directly.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, dev))\n                      .build();\n                },\n                \"For internal use only.\")\n            .addSubCommand(\"admin-token\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"Generates a new admin token that you can use to access the admin settings \"\n                          \"page. This is meant for initial setup, or if an admin account is locked out.\")\n                      .addOption({'q', \"quiet\"}, [this]() { shortOutput = true; return true; },\n                          \"Output only the token.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, adminToken))\n                      .build();\n                },\n                \"Generate admin token.\")\n            .addSubCommand(\"uninstall\",\n                [this]() {\n                  return kj::MainBuilder(context, VERSION,\n                          \"Uninstalls Sandstorm.\")\n                      .addOption({\"delete-user-data\"}, [this]() { deleteUserData = true; return true; },\n                          \"Also delete all user data.\")\n                      .callAfterParsing(KJ_BIND_METHOD(*this, uninstall))\n                      .build();\n                },\n                \"Uninstall Sandstorm.\")\n            .build();\n      }\n    \n      kj::MainBuilder::Validity start() {\n        changeToInstallDir();\n        const Config config = readConfig();\n    \n        // Check / lock the pidfile.\n        auto pidfile = raiiOpen(\"../var/pid/sandstorm.pid\", O_RDWR | O_CREAT | O_CLOEXEC, 0660);\n        {\n          struct flock lock;\n          memset(&lock, 0, sizeof(lock));\n          lock.l_type = F_WRLCK;\n          lock.l_whence = SEEK_SET;\n          lock.l_start = 0;\n          lock.l_len = 0;  // entire file\n          if (fcntl(pidfile, F_SETLK, &lock) < 0) {\n            int error = errno;\n            if (error == EACCES || error == EAGAIN) {\n              context.exitInfo(kj::str(\"Sandstorm is already running.  PID = \", readAll(pidfile)));\n            } else {\n              KJ_FAIL_SYSCALL(\"fcntl(pidfile, F_SETLK)\", error);\n            }\n          }\n    \n          // It's ours.  Truncate for now so we can write in the new PID later.\n          KJ_SYSCALL(ftruncate(pidfile, 0));\n        }\n    \n        if (!runningAsRoot) unshareUidNamespaceOnce();\n    \n        // Unshare PID namespace so that daemon process becomes the root process of its own PID\n        // namespace and therefore if it dies the whole namespace is killed.\n        KJ_SYSCALL(unshare(CLONE_NEWPID));\n    \n        // Daemonize ourselves.\n        pid_t mainPid;  // PID of the main process as seen *outside* the PID namespace.\n        {\n          int pipeFds[2];\n          KJ_SYSCALL(pipe2(pipeFds, O_CLOEXEC));\n          kj::AutoCloseFd pipeIn(pipeFds[0]), pipeOut(pipeFds[1]);\n    \n          KJ_SYSCALL(mainPid = fork());\n          if (mainPid != 0) {\n            // Tell the child process its own PID, since being in a PID namespace its own getpid() will\n            // unhelpfully return 1.\n            pipeIn = nullptr;\n            kj::FdOutputStream(kj::mv(pipeOut)).write(&mainPid, sizeof(mainPid));\n    \n            // Write the pidfile before exiting.\n            {\n              auto pidstr = kj::str(mainPid, '\\n');\n              kj::FdOutputStream((int)pidfile).write(pidstr.begin(), pidstr.size());\n            }\n    \n            // Exit success.\n            context.exitInfo(kj::str(\"Sandstorm started. PID = \", mainPid));\n            return true;\n          }\n    \n          // Read our (global) PID in from the parent process.\n          pipeOut = nullptr;\n          kj::FdInputStream(kj::mv(pipeIn)).read(&mainPid, sizeof(mainPid));\n        }\n    \n        // Since we unshared the PID namespace, the first fork() should have produced pid 1 in the\n        // new namespace.  That means that if this pid ever exits, everything under it dies.  That's\n        // perfect!  Otherwise we'd have to carefully kill node and mongo separately.\n        KJ_ASSERT(getpid() == 1, \"unshare(CLONE_NEWPID) didn't do what I expected.\", getpid());\n    \n        // Lock the pidfile and make sure it still belongs to us.\n        //\n        // We need to wait for the parent process to release its lock, so we use F_SETLKW.\n        // However, if another Sandstorm server is started simultaneously and manages to steal\n        // ownership, we want to detect this and exit, so we take a shared (read-only) lock.\n        {\n          struct flock lock;\n          memset(&lock, 0, sizeof(lock));\n          lock.l_type = F_RDLCK;\n          lock.l_whence = SEEK_SET;\n          lock.l_start = 0;\n          lock.l_len = 0;  // entire file\n          KJ_SYSCALL(fcntl(pidfile, F_SETLKW, &lock));\n    \n          // Verify that we still own the file.\n          KJ_SYSCALL(lseek(pidfile, 0, SEEK_SET));\n          pid_t pidfilePid = KJ_ASSERT_NONNULL(parseUInt(trim(readAll(pidfile)), 10));\n          if (pidfilePid != mainPid) {\n            context.exitInfo(kj::str(\n                \"Oops, Sandstorm PID \", pidfilePid, \" just started. \"\n                \"PID \", mainPid, \" exiting in deference.\"));\n          }\n        }\n    \n        // Redirect stdio.\n        {\n          auto logFd = raiiOpen(\"../var/log/sandstorm.log\", O_WRONLY | O_APPEND | O_CREAT, 0660);\n          if (runningAsRoot) { KJ_SYSCALL(fchown(logFd, config.uids.uid, config.uids.gid)); }\n          KJ_SYSCALL(dup2(logFd, STDOUT_FILENO));\n          KJ_SYSCALL(dup2(logFd, STDERR_FILENO));\n        }\n        {\n          auto nullFd = raiiOpen(\"/dev/null\", O_RDONLY);\n          KJ_SYSCALL(dup2(nullFd, STDIN_FILENO));\n        }\n    \n        // Write time to log.\n        time_t now;\n        time(&now);\n        context.warning(kj::str(\"** Starting Sandstorm at: \", ctime(&now)));\n    \n        // Detach from controlling terminal and make ourselves session leader.\n        KJ_SYSCALL(setsid());\n    \n        FdBundle fdBundle(config);\n    \n        runUpdateMonitor(config, fdBundle, pidfile);\n      }\n    \n      kj::MainBuilder::Validity inheritFd(kj::StringPtr mapping) {\n        auto parts = split(mapping, ':');\n        if (parts.size() != 3) {\n          return \"invalid syntax for port mapping\";\n        }\n    \n        int fd;\n        KJ_IF_MAYBE(p, parseUInt(kj::str(parts[0]), 10)) {\n          fd = *p;\n        } else {\n          return \"invalid fd\";\n        }\n    \n        kj::String type = kj::str(parts[1]);\n        if (type != \"tcp\") {\n          return \"invalid type\";\n        }\n    \n        uint port;\n        KJ_IF_MAYBE(p, parseUInt(kj::str(parts[2]), 10)) {\n          port = *p;\n        } else {\n          return \"invalid port\";\n        }\n    \n        KJ_SYSCALL(ioctl(fd, FIOCLEX));  // set CLOEXEC\n        if (!inheritedTcpPorts.insert(std::make_pair(port, kj::AutoCloseFd(fd))).second) {\n          return \"duplicate port\";\n        }\n    \n        return true;\n      }\n    \n      kj::MainBuilder::Validity inheritPidfileFd(kj::StringPtr pidfileFdStr) {\n        KJ_IF_MAYBE(p, parseUInt(pidfileFdStr, 10)) {\n          inheritedPidfile = kj::AutoCloseFd(*p);\n          KJ_SYSCALL(ioctl(inheritedPidfile, FIOCLEX));  // set CLOEXEC\n          return true;\n        } else {\n          return \"invalid fd\";\n        }\n      }\n  }\n}"
  },
  {
    "function_name": "getPipe",
    "container": "CurlRequest",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "420-420",
    "snippet": "int getPipe() { return pipeFd; }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nCurlRequest {\n  int getPipe() { return pipeFd; }\n}"
  },
  {
    "function_name": "CurlRequest",
    "container": "CurlRequest",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "389-397",
    "snippet": "explicit CurlRequest(kj::StringPtr url, int outFd): url(kj::heapString(url)) {\n    KJ_SYSCALL(pid = fork());\n    if (pid == 0) {\n      KJ_SYSCALL(dup2(outFd, STDOUT_FILENO));\n      KJ_SYSCALL(execlp(\"curl\", \"curl\", isatty(STDERR_FILENO) ? \"-f\" : \"-fs\",\n                        url.cStr(), EXEC_END_ARGS), url);\n      KJ_UNREACHABLE;\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "execlp(\"curl\", \"curl\", isatty(STDERR_FILENO) ? \"-f\" : \"-fs\",\n                        url.cStr(), EXEC_END_ARGS)",
            "url"
          ],
          "line": 393
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "execlp",
          "args": [
            "\"curl\"",
            "\"curl\"",
            "isatty(STDERR_FILENO) ? \"-f\" : \"-fs\"",
            "url.cStr()",
            "EXEC_END_ARGS"
          ],
          "line": 393
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "url.cStr",
          "args": [],
          "line": 394
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "isatty",
          "args": [
            "STDERR_FILENO"
          ],
          "line": 393
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(outFd, STDOUT_FILENO)"
          ],
          "line": 392
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "outFd",
            "STDOUT_FILENO"
          ],
          "line": 392
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "pid = fork()"
          ],
          "line": 390
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fork",
          "args": [],
          "line": 390
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "url"
          ],
          "line": 389
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nCurlRequest {\n  explicit CurlRequest(kj::StringPtr url, int outFd): url(kj::heapString(url)) {\n      KJ_SYSCALL(pid = fork());\n      if (pid == 0) {\n        KJ_SYSCALL(dup2(outFd, STDOUT_FILENO));\n        KJ_SYSCALL(execlp(\"curl\", \"curl\", isatty(STDERR_FILENO) ? \"-f\" : \"-fs\",\n                          url.cStr(), EXEC_END_ARGS), url);\n        KJ_UNREACHABLE;\n      }\n    }\n}"
  },
  {
    "function_name": "CurlRequest",
    "container": "CurlRequest",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "370-387",
    "snippet": "explicit CurlRequest(kj::StringPtr url): url(kj::heapString(url)) {\n    int pipeFds[2];\n    KJ_SYSCALL(pipe(pipeFds));\n    kj::AutoCloseFd pipeInput(pipeFds[0]), pipeOutput(pipeFds[1]);\n\n    KJ_SYSCALL(pid = fork());\n    if (pid == 0) {\n      KJ_SYSCALL(dup2(pipeOutput, STDOUT_FILENO));\n      pipeInput = nullptr;\n      pipeOutput = nullptr;\n\n      KJ_SYSCALL(execlp(\"curl\", \"curl\", isatty(STDERR_FILENO) ? \"-f\" : \"-fs\",\n                        url.cStr(), EXEC_END_ARGS), url);\n      KJ_UNREACHABLE;\n    } else {\n      pipeFd = kj::mv(pipeInput);\n    }\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "pid_t pid;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "pipeInput"
          ],
          "line": 385
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "execlp(\"curl\", \"curl\", isatty(STDERR_FILENO) ? \"-f\" : \"-fs\",\n                        url.cStr(), EXEC_END_ARGS)",
            "url"
          ],
          "line": 381
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "execlp",
          "args": [
            "\"curl\"",
            "\"curl\"",
            "isatty(STDERR_FILENO) ? \"-f\" : \"-fs\"",
            "url.cStr()",
            "EXEC_END_ARGS"
          ],
          "line": 381
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "url.cStr",
          "args": [],
          "line": 382
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "isatty",
          "args": [
            "STDERR_FILENO"
          ],
          "line": 381
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(pipeOutput, STDOUT_FILENO)"
          ],
          "line": 377
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "pipeOutput",
            "STDOUT_FILENO"
          ],
          "line": 377
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "pid = fork()"
          ],
          "line": 375
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fork",
          "args": [],
          "line": 375
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "pipe(pipeFds)"
          ],
          "line": 372
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pipe",
          "args": [
            "pipeFds"
          ],
          "line": 372
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "url"
          ],
          "line": 370
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\npid_t pid;\n\nCurlRequest {\n  explicit CurlRequest(kj::StringPtr url): url(kj::heapString(url)) {\n      int pipeFds[2];\n      KJ_SYSCALL(pipe(pipeFds));\n      kj::AutoCloseFd pipeInput(pipeFds[0]), pipeOutput(pipeFds[1]);\n  \n      KJ_SYSCALL(pid = fork());\n      if (pid == 0) {\n        KJ_SYSCALL(dup2(pipeOutput, STDOUT_FILENO));\n        pipeInput = nullptr;\n        pipeOutput = nullptr;\n  \n        KJ_SYSCALL(execlp(\"curl\", \"curl\", isatty(STDERR_FILENO) ? \"-f\" : \"-fs\",\n                          url.cStr(), EXEC_END_ARGS), url);\n        KJ_UNREACHABLE;\n      } else {\n        pipeFd = kj::mv(pipeInput);\n      }\n    }\n}"
  },
  {
    "function_name": "getUserIds",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "304-364",
    "snippet": "kj::Maybe<UserIds> getUserIds(kj::StringPtr name) {\n  // We can't use getpwnam() in a statically-linked binary, so we shell out to id(1).  lol.\n\n  int fds[2];\n  KJ_SYSCALL(pipe2(fds, O_CLOEXEC));\n\n  pid_t child;\n  KJ_SYSCALL(child = fork());\n  if (child == 0) {\n    // id(1) actually localizes the word \"groups\". Make sure the locale is set to C to prevent this.\n    KJ_SYSCALL(setenv(\"LANG\", \"C\", true));\n    KJ_SYSCALL(unsetenv(\"LANGUAGE\"));\n    KJ_SYSCALL(unsetenv(\"LC_ALL\"));\n    KJ_SYSCALL(unsetenv(\"LC_MESSAGES\"));\n\n    KJ_SYSCALL(dup2(fds[1], STDOUT_FILENO));\n    KJ_SYSCALL(execlp(\"id\", \"id\", name.cStr(), EXEC_END_ARGS));\n    KJ_UNREACHABLE;\n  }\n\n  close(fds[1]);\n  KJ_DEFER(close(fds[0]));\n\n  auto idOutput = readAll(fds[0]);\n\n  int status;\n  KJ_SYSCALL(waitpid(child, &status, 0));\n  if (!WIFEXITED(status) || WEXITSTATUS(status) != 0) {\n    return nullptr;\n  }\n\n  idParser::Input input(idOutput.begin(), idOutput.end());\n  KJ_IF_MAYBE(assignments, idParser::parser(input)) {\n    UserIds result;\n    bool sawUid = false, sawGid = false;\n    for (auto& assignment: *assignments) {\n      if (assignment.name == \"uid\") {\n        KJ_ASSERT(assignment.values.size() == 1, \"failed to parse output of id(1)\", idOutput);\n        result.uid = assignment.values[0];\n        sawUid = true;\n      } else if (assignment.name == \"gid\") {\n        KJ_ASSERT(assignment.values.size() == 1, \"failed to parse output of id(1)\", idOutput);\n        result.gid = assignment.values[0];\n        sawGid = true;\n      } else if (assignment.name == \"groups\") {\n        result.groups = KJ_MAP(g, assignment.values) -> gid_t { return g; };\n      }\n    }\n\n    KJ_ASSERT(sawUid, \"id(1) didn't return uid?\", idOutput);\n    KJ_ASSERT(sawGid, \"id(1) didn't return gid?\", idOutput);\n    if (result.groups.size() == 0) {\n      result.groups = kj::heapArray<gid_t>(1);\n      result.groups[0] = result.gid;\n    }\n\n    return kj::mv(result);\n  } else {\n    KJ_FAIL_ASSERT(\"failed to parse output of id(1)\", idOutput, input.getBest() - idOutput.begin());\n  }\n}",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_FAIL_ASSERT",
          "args": [
            "\"failed to parse output of id(1)\"",
            "idOutput",
            "input.getBest() - idOutput.begin()"
          ],
          "line": 362
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "idOutput.begin",
          "args": [],
          "line": 362
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "input.getBest",
          "args": [],
          "line": 362
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "result"
          ],
          "line": 360
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapArray<gid_t>",
          "args": [
            "1"
          ],
          "line": 356
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "result.groups.size",
          "args": [],
          "line": 355
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "sawGid",
            "\"id(1) didn't return gid?\"",
            "idOutput"
          ],
          "line": 354
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "sawUid",
            "\"id(1) didn't return uid?\"",
            "idOutput"
          ],
          "line": 353
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_MAP",
          "args": [
            "g",
            "assignment.values"
          ],
          "line": 349
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "assignment.values.size() == 1",
            "\"failed to parse output of id(1)\"",
            "idOutput"
          ],
          "line": 345
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "assignment.values.size() == 1",
            "\"failed to parse output of id(1)\"",
            "idOutput"
          ],
          "line": 341
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "idOutput.end",
          "args": [],
          "line": 335
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "idOutput.begin",
          "args": [],
          "line": 335
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "WEXITSTATUS",
          "args": [
            "status"
          ],
          "line": 331
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "WIFEXITED",
          "args": [
            "status"
          ],
          "line": 331
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "waitpid(child, &status, 0)"
          ],
          "line": 330
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "waitpid",
          "args": [
            "child",
            "&status",
            "0"
          ],
          "line": 330
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "readAll",
          "args": [
            "fds[0]"
          ],
          "line": 327
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_DEFER",
          "args": [
            "close(fds[0])"
          ],
          "line": 325
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "close",
          "args": [
            "fds[0]"
          ],
          "line": 325
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "close",
          "args": [
            "fds[1]"
          ],
          "line": 324
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "execlp(\"id\", \"id\", name.cStr(), EXEC_END_ARGS)"
          ],
          "line": 320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "execlp",
          "args": [
            "\"id\"",
            "\"id\"",
            "name.cStr()",
            "EXEC_END_ARGS"
          ],
          "line": 320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "name.cStr",
          "args": [],
          "line": 320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "dup2(fds[1], STDOUT_FILENO)"
          ],
          "line": 319
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dup2",
          "args": [
            "fds[1]",
            "STDOUT_FILENO"
          ],
          "line": 319
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unsetenv(\"LC_MESSAGES\")"
          ],
          "line": 317
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unsetenv",
          "args": [
            "\"LC_MESSAGES\""
          ],
          "line": 317
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unsetenv(\"LC_ALL\")"
          ],
          "line": 316
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unsetenv",
          "args": [
            "\"LC_ALL\""
          ],
          "line": 316
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "unsetenv(\"LANGUAGE\")"
          ],
          "line": 315
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unsetenv",
          "args": [
            "\"LANGUAGE\""
          ],
          "line": 315
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "setenv(\"LANG\", \"C\", true)"
          ],
          "line": 314
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setenv",
          "args": [
            "\"LANG\"",
            "\"C\"",
            "true"
          ],
          "line": 314
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "child = fork()"
          ],
          "line": 311
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fork",
          "args": [],
          "line": 311
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "pipe2(fds, O_CLOEXEC)"
          ],
          "line": 308
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pipe2",
          "args": [
            "fds",
            "O_CLOEXEC"
          ],
          "line": 308
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::Maybe<UserIds> getUserIds(kj::StringPtr name) {\n  // We can't use getpwnam() in a statically-linked binary, so we shell out to id(1).  lol.\n\n  int fds[2];\n  KJ_SYSCALL(pipe2(fds, O_CLOEXEC));\n\n  pid_t child;\n  KJ_SYSCALL(child = fork());\n  if (child == 0) {\n    // id(1) actually localizes the word \"groups\". Make sure the locale is set to C to prevent this.\n    KJ_SYSCALL(setenv(\"LANG\", \"C\", true));\n    KJ_SYSCALL(unsetenv(\"LANGUAGE\"));\n    KJ_SYSCALL(unsetenv(\"LC_ALL\"));\n    KJ_SYSCALL(unsetenv(\"LC_MESSAGES\"));\n\n    KJ_SYSCALL(dup2(fds[1], STDOUT_FILENO));\n    KJ_SYSCALL(execlp(\"id\", \"id\", name.cStr(), EXEC_END_ARGS));\n    KJ_UNREACHABLE;\n  }\n\n  close(fds[1]);\n  KJ_DEFER(close(fds[0]));\n\n  auto idOutput = readAll(fds[0]);\n\n  int status;\n  KJ_SYSCALL(waitpid(child, &status, 0));\n  if (!WIFEXITED(status) || WEXITSTATUS(status) != 0) {\n    return nullptr;\n  }\n\n  idParser::Input input(idOutput.begin(), idOutput.end());\n  KJ_IF_MAYBE(assignments, idParser::parser(input)) {\n    UserIds result;\n    bool sawUid = false, sawGid = false;\n    for (auto& assignment: *assignments) {\n      if (assignment.name == \"uid\") {\n        KJ_ASSERT(assignment.values.size() == 1, \"failed to parse output of id(1)\", idOutput);\n        result.uid = assignment.values[0];\n        sawUid = true;\n      } else if (assignment.name == \"gid\") {\n        KJ_ASSERT(assignment.values.size() == 1, \"failed to parse output of id(1)\", idOutput);\n        result.gid = assignment.values[0];\n        sawGid = true;\n      } else if (assignment.name == \"groups\") {\n        result.groups = KJ_MAP(g, assignment.values) -> gid_t { return g; };\n      }\n    }\n\n    KJ_ASSERT(sawUid, \"id(1) didn't return uid?\", idOutput);\n    KJ_ASSERT(sawGid, \"id(1) didn't return gid?\", idOutput);\n    if (result.groups.size() == 0) {\n      result.groups = kj::heapArray<gid_t>(1);\n      result.groups[0] = result.gid;\n    }\n\n    return kj::mv(result);\n  } else {\n    KJ_FAIL_ASSERT(\"failed to parse output of id(1)\", idOutput, input.getBest() - idOutput.begin());\n  }\n}"
  },
  {
    "function_name": "parsePorts",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "277-291",
    "snippet": "kj::Array<uint> parsePorts(kj::Maybe<uint> httpsPort, kj::StringPtr portList) {\n  auto portsSplitOnComma = split(portList, ',');\n  size_t numHttpPorts = portsSplitOnComma.size();\n  size_t numHttpsPorts;\n  kj::Array<uint> result;\n\n  // If the configuration has a https port, then add it first.\n  KJ_IF_MAYBE(portNumber, httpsPort) {\n    numHttpsPorts = 1;\n    result = kj::heapArray<uint>(numHttpsPorts + numHttpPorts);\n    result[0] = *portNumber;\n  } else {\n    numHttpsPorts = 0;\n    result = kj::heapArray<uint>(numHttpsPorts + numHttpPorts);\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::heapArray<uint>",
          "args": [
            "numHttpsPorts + numHttpPorts"
          ],
          "line": 290
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapArray<uint>",
          "args": [
            "numHttpsPorts + numHttpPorts"
          ],
          "line": 286
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "portsSplitOnComma.size",
          "args": [],
          "line": 279
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "split",
          "args": [
            "portList",
            "','"
          ],
          "line": 278
        },
        "resolved": true,
        "details": {
          "function_name": "splitFirst",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "448-457",
          "snippet": "kj::Maybe<kj::ArrayPtr<const char>> splitFirst(kj::ArrayPtr<const char>& input, char delim) {\n  for (size_t i: kj::indices(input)) {\n    if (input[i] == delim) {\n      auto result = input.slice(0, i);\n      input = input.slice(i + 1, input.size());\n      return result;\n    }\n  }\n  return nullptr;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<kj::ArrayPtr<const char>> splitFirst(kj::ArrayPtr<const char>& input, char delim) {\n  for (size_t i: kj::indices(input)) {\n    if (input[i] == delim) {\n      auto result = input.slice(0, i);\n      input = input.slice(i + 1, input.size());\n      return result;\n    }\n  }\n  return nullptr;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::Array<uint> parsePorts(kj::Maybe<uint> httpsPort, kj::StringPtr portList) {\n  auto portsSplitOnComma = split(portList, ',');\n  size_t numHttpPorts = portsSplitOnComma.size();\n  size_t numHttpsPorts;\n  kj::Array<uint> result;\n\n  // If the configuration has a https port, then add it first.\n  KJ_IF_MAYBE(portNumber, httpsPort) {\n    numHttpsPorts = 1;\n    result = kj::heapArray<uint>(numHttpsPorts + numHttpPorts);\n    result[0] = *portNumber;\n  } else {\n    numHttpsPorts = 0;\n    result = kj::heapArray<uint>(numHttpsPorts + numHttpPorts);\n  }"
  },
  {
    "function_name": "delimited",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "230-242",
    "snippet": "auto delimited(SubParser& subParser) -> decltype(auto) {\n  // Create a parser that parses several instances of subParser separated by the given delimiter.\n\n  typedef p::OutputType<SubParser, Input> Element;\n  return p::transform(p::sequence(subParser,\n      p::many(p::sequence(p::exactChar<delimiter>(), subParser))),\n      [](Element&& first, kj::Array<Element>&& rest) {\n    auto result = kj::heapArrayBuilder<Element>(rest.size() + 1);\n    result.add(kj::mv(first));\n    for (auto& e: rest) result.add(kj::mv(e));\n    return result.finish();\n  });\n}",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "p::transform",
          "args": [
            "p::sequence(subParser,\n      p::many(p::sequence(p::exactChar<delimiter>(), subParser)))",
            "[](Element&& first, kj::Array<Element>&& rest) {\n    auto result = kj::heapArrayBuilder<Element>(rest.size() + 1);\n    result.add(kj::mv(first));\n    for (auto& e: rest) result.add(kj::mv(e));\n    return result.finish();\n  }"
          ],
          "line": 234
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "result.finish",
          "args": [],
          "line": 240
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "result.add",
          "args": [
            "kj::mv(e)"
          ],
          "line": 239
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "e"
          ],
          "line": 239
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "result.add",
          "args": [
            "kj::mv(first)"
          ],
          "line": 238
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "first"
          ],
          "line": 238
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapArrayBuilder<Element>",
          "args": [
            "rest.size() + 1"
          ],
          "line": 237
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rest.size",
          "args": [],
          "line": 237
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "p::sequence",
          "args": [
            "subParser",
            "p::many(p::sequence(p::exactChar<delimiter>(), subParser))"
          ],
          "line": 234
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "p::many",
          "args": [
            "p::sequence(p::exactChar<delimiter>(), subParser)"
          ],
          "line": 235
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "p::sequence",
          "args": [
            "p::exactChar<delimiter>()",
            "subParser"
          ],
          "line": 235
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "p::exactChar<delimiter>",
          "args": [],
          "line": 235
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nauto delimited(SubParser& subParser) -> decltype(auto) {\n  // Create a parser that parses several instances of subParser separated by the given delimiter.\n\n  typedef p::OutputType<SubParser, Input> Element;\n  return p::transform(p::sequence(subParser,\n      p::many(p::sequence(p::exactChar<delimiter>(), subParser))),\n      [](Element&& first, kj::Array<Element>&& rest) {\n    auto result = kj::heapArrayBuilder<Element>(rest.size() + 1);\n    result.add(kj::mv(first));\n    for (auto& e: rest) result.add(kj::mv(e));\n    return result.finish();\n  });\n}"
  },
  {
    "function_name": "isUserNsAvailable",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "183-212",
    "snippet": "bool isUserNsAvailable() {\n  Subprocess child([]() {\n    if (getuid() == 0) {\n      if (setuid(1000) < 0) {\n        // setuid() failed?\n        return 2;\n      }\n    }\n\n    if (unshare(CLONE_NEWUSER) < 0) {\n      return 1;\n    }\n\n    return 0;\n  });\n\n  int status = child.waitForExit();\n  switch (status) {\n    case 0:\n      return true;\n    case 1:\n      return false;\n    case 2:\n      KJ_LOG(ERROR, \"setuid() failed when trying to test if unprivileged userns works\");\n      return true;\n    default:\n      KJ_LOG(ERROR, \"userns test process exited with unexpected status code\", status);\n      return true;\n  }\n}",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_LOG",
          "args": [
            "ERROR",
            "\"userns test process exited with unexpected status code\"",
            "status"
          ],
          "line": 209
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_LOG",
          "args": [
            "ERROR",
            "\"setuid() failed when trying to test if unprivileged userns works\""
          ],
          "line": 206
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "child.waitForExit",
          "args": [],
          "line": 199
        },
        "resolved": true,
        "details": {
          "function_name": "waitForExit",
          "container": "Subprocess",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "998-1008",
          "snippet": "int Subprocess::waitForExit() {\n  int status = waitForExitOrSignal();\n  if (WIFEXITED(status)) {\n    return WEXITSTATUS(status);\n  } else if (WIFSIGNALED(status)) {\n    int signo = WTERMSIG(status);\n    KJ_FAIL_ASSERT(\"child process killed by signal\", name, signo, strsignal(signo));\n  } else {\n    KJ_FAIL_ASSERT(\"unknown child wait status\", name, status);\n  }\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nSubprocess {\n  int Subprocess::waitForExit() {\n    int status = waitForExitOrSignal();\n    if (WIFEXITED(status)) {\n      return WEXITSTATUS(status);\n    } else if (WIFSIGNALED(status)) {\n      int signo = WTERMSIG(status);\n      KJ_FAIL_ASSERT(\"child process killed by signal\", name, signo, strsignal(signo));\n    } else {\n      KJ_FAIL_ASSERT(\"unknown child wait status\", name, status);\n    }\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "unshare",
          "args": [
            "CLONE_NEWUSER"
          ],
          "line": 192
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setuid",
          "args": [
            "1000"
          ],
          "line": 186
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getuid",
          "args": [],
          "line": 185
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool isUserNsAvailable() {\n  Subprocess child([]() {\n    if (getuid() == 0) {\n      if (setuid(1000) < 0) {\n        // setuid() failed?\n        return 2;\n      }\n    }\n\n    if (unshare(CLONE_NEWUSER) < 0) {\n      return 1;\n    }\n\n    return 0;\n  });\n\n  int status = child.waitForExit();\n  switch (status) {\n    case 0:\n      return true;\n    case 1:\n      return false;\n    case 2:\n      KJ_LOG(ERROR, \"setuid() failed when trying to test if unprivileged userns works\");\n      return true;\n    default:\n      KJ_LOG(ERROR, \"userns test process exited with unexpected status code\", status);\n      return true;\n  }\n}"
  },
  {
    "function_name": "isKernelNewEnough",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "173-181",
    "snippet": "bool isKernelNewEnough() {\n  auto version = getKernelVersion();\n  if (version.major < 3 || (version.major == 3 && version.minor < 10)) {\n    // Insufficient kernel version.\n    return false;\n  }\n\n  return true;\n}",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "getKernelVersion",
          "args": [],
          "line": 174
        },
        "resolved": true,
        "details": {
          "function_name": "getKernelVersion",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "150-170",
          "snippet": "KernelVersion getKernelVersion() {\n  struct utsname uts;\n  KJ_SYSCALL(uname(&uts));\n  kj::StringPtr release = uts.release;\n\n  auto parser = kj::parse::transform(kj::parse::sequence(\n      kj::parse::oneOrMore(kj::parse::digit),\n      kj::parse::exactChar<'.'>(),\n      kj::parse::oneOrMore(kj::parse::digit)),\n      [](kj::Array<char> major, kj::Array<char> minor) {\n    return KernelVersion {\n      KJ_ASSERT_NONNULL(parseUInt(kj::heapString(major), 10)),\n      KJ_ASSERT_NONNULL(parseUInt(kj::heapString(minor), 10))\n    };\n  });\n  kj::parse::IteratorInput<char, const char*> input(release.begin(), release.end());\n  KJ_IF_MAYBE(version, parser(input)) {\n    return *version;\n  } else {\n    KJ_FAIL_ASSERT(\"Couldn't parse kernel version.\", release);\n  }",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKernelVersion getKernelVersion() {\n  struct utsname uts;\n  KJ_SYSCALL(uname(&uts));\n  kj::StringPtr release = uts.release;\n\n  auto parser = kj::parse::transform(kj::parse::sequence(\n      kj::parse::oneOrMore(kj::parse::digit),\n      kj::parse::exactChar<'.'>(),\n      kj::parse::oneOrMore(kj::parse::digit)),\n      [](kj::Array<char> major, kj::Array<char> minor) {\n    return KernelVersion {\n      KJ_ASSERT_NONNULL(parseUInt(kj::heapString(major), 10)),\n      KJ_ASSERT_NONNULL(parseUInt(kj::heapString(minor), 10))\n    };\n  });\n  kj::parse::IteratorInput<char, const char*> input(release.begin(), release.end());\n  KJ_IF_MAYBE(version, parser(input)) {\n    return *version;\n  } else {\n    KJ_FAIL_ASSERT(\"Couldn't parse kernel version.\", release);\n  }"
        }
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nbool isKernelNewEnough() {\n  auto version = getKernelVersion();\n  if (version.major < 3 || (version.major == 3 && version.minor < 10)) {\n    // Insufficient kernel version.\n    return false;\n  }\n\n  return true;\n}"
  },
  {
    "function_name": "getKernelVersion",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "150-170",
    "snippet": "KernelVersion getKernelVersion() {\n  struct utsname uts;\n  KJ_SYSCALL(uname(&uts));\n  kj::StringPtr release = uts.release;\n\n  auto parser = kj::parse::transform(kj::parse::sequence(\n      kj::parse::oneOrMore(kj::parse::digit),\n      kj::parse::exactChar<'.'>(),\n      kj::parse::oneOrMore(kj::parse::digit)),\n      [](kj::Array<char> major, kj::Array<char> minor) {\n    return KernelVersion {\n      KJ_ASSERT_NONNULL(parseUInt(kj::heapString(major), 10)),\n      KJ_ASSERT_NONNULL(parseUInt(kj::heapString(minor), 10))\n    };\n  });\n  kj::parse::IteratorInput<char, const char*> input(release.begin(), release.end());\n  KJ_IF_MAYBE(version, parser(input)) {\n    return *version;\n  } else {\n    KJ_FAIL_ASSERT(\"Couldn't parse kernel version.\", release);\n  }",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_FAIL_ASSERT",
          "args": [
            "\"Couldn't parse kernel version.\"",
            "release"
          ],
          "line": 169
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "release.end",
          "args": [],
          "line": 165
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "release.begin",
          "args": [],
          "line": 165
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::parse::transform",
          "args": [
            "kj::parse::sequence(\n      kj::parse::oneOrMore(kj::parse::digit),\n      kj::parse::exactChar<'.'>(),\n      kj::parse::oneOrMore(kj::parse::digit))",
            "[](kj::Array<char> major, kj::Array<char> minor) {\n    return KernelVersion {\n      KJ_ASSERT_NONNULL(parseUInt(kj::heapString(major), 10)),\n      KJ_ASSERT_NONNULL(parseUInt(kj::heapString(minor), 10))\n    };\n  }"
          ],
          "line": 155
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT_NONNULL",
          "args": [
            "parseUInt(kj::heapString(minor), 10)"
          ],
          "line": 162
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "parseUInt",
          "args": [
            "kj::heapString(minor)",
            "10"
          ],
          "line": 162
        },
        "resolved": true,
        "details": {
          "function_name": "parseUInt64",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "223-230",
          "snippet": "kj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Maybe<uint64_t> parseUInt64(kj::StringPtr s, int base) {\n  char* end;\n  uint64_t result = strtoull(s.cStr(), &end, base);\n  if (s.size() == 0 || *end != '\\0') {\n    return nullptr;\n  }\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "minor"
          ],
          "line": 162
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT_NONNULL",
          "args": [
            "parseUInt(kj::heapString(major), 10)"
          ],
          "line": 161
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::heapString",
          "args": [
            "major"
          ],
          "line": 161
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::parse::sequence",
          "args": [
            "kj::parse::oneOrMore(kj::parse::digit)",
            "kj::parse::exactChar<'.'>()",
            "kj::parse::oneOrMore(kj::parse::digit)"
          ],
          "line": 155
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::parse::oneOrMore",
          "args": [
            "kj::parse::digit"
          ],
          "line": 158
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::parse::exactChar<'.'>",
          "args": [],
          "line": 157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::parse::oneOrMore",
          "args": [
            "kj::parse::digit"
          ],
          "line": 156
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "uname(&uts)"
          ],
          "line": 152
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "uname",
          "args": [
            "&uts"
          ],
          "line": 152
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nKernelVersion getKernelVersion() {\n  struct utsname uts;\n  KJ_SYSCALL(uname(&uts));\n  kj::StringPtr release = uts.release;\n\n  auto parser = kj::parse::transform(kj::parse::sequence(\n      kj::parse::oneOrMore(kj::parse::digit),\n      kj::parse::exactChar<'.'>(),\n      kj::parse::oneOrMore(kj::parse::digit)),\n      [](kj::Array<char> major, kj::Array<char> minor) {\n    return KernelVersion {\n      KJ_ASSERT_NONNULL(parseUInt(kj::heapString(major), 10)),\n      KJ_ASSERT_NONNULL(parseUInt(kj::heapString(minor), 10))\n    };\n  });\n  kj::parse::IteratorInput<char, const char*> input(release.begin(), release.end());\n  KJ_IF_MAYBE(version, parser(input)) {\n    return *version;\n  } else {\n    KJ_FAIL_ASSERT(\"Couldn't parse kernel version.\", release);\n  }"
  },
  {
    "function_name": "fileHasLine",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "126-141",
    "snippet": "static bool fileHasLine(kj::StringPtr filename, kj::StringPtr expectedLine) {\n  // Returns true if the given text file contains a line matching exactly the given string.\n  auto file = raiiOpenIfExists(filename, O_RDONLY | O_CLOEXEC);\n  KJ_IF_MAYBE(f, file) {\n    for (auto& line: splitLines(readAll(*f))) {\n      if (line == expectedLine) {\n        return true;\n      }\n    }\n    // File doesn't contain line.\n    return false;\n  } else {\n    // File doesn't exist at all.\n    return false;\n  }\n}",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "splitLines",
          "args": [
            "readAll(*f)"
          ],
          "line": 130
        },
        "resolved": true,
        "details": {
          "function_name": "splitLines",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "387-414",
          "snippet": "kj::Array<kj::String> splitLines(kj::StringPtr input) {\n  size_t lineStart = 0;\n  kj::Vector<kj::String> results;\n  for (size_t i = 0; i < input.size(); i++) {\n    if (input[i] == '\\n' || input[i] == '#') {\n      bool hasComment = input[i] == '#';\n      auto line = trim(input.slice(lineStart, i));\n      if (line.size() > 0) {\n        results.add(kj::mv(line));\n      }\n      if (hasComment) {\n        // Ignore through newline.\n        ++i;\n        while (i < input.size() && input[i] != '\\n') ++i;\n      }\n      lineStart = i + 1;\n    }\n  }\n\n  if (lineStart < input.size()) {\n    auto lastLine = trim(input.slice(lineStart));\n    if (lastLine.size() > 0) {\n      results.add(kj::mv(lastLine));\n    }\n  }\n\n  return results.releaseAsArray();\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Array<kj::String> splitLines(kj::StringPtr input) {\n  size_t lineStart = 0;\n  kj::Vector<kj::String> results;\n  for (size_t i = 0; i < input.size(); i++) {\n    if (input[i] == '\\n' || input[i] == '#') {\n      bool hasComment = input[i] == '#';\n      auto line = trim(input.slice(lineStart, i));\n      if (line.size() > 0) {\n        results.add(kj::mv(line));\n      }\n      if (hasComment) {\n        // Ignore through newline.\n        ++i;\n        while (i < input.size() && input[i] != '\\n') ++i;\n      }\n      lineStart = i + 1;\n    }\n  }\n\n  if (lineStart < input.size()) {\n    auto lastLine = trim(input.slice(lineStart));\n    if (lastLine.size() > 0) {\n      results.add(kj::mv(lastLine));\n    }\n  }\n\n  return results.releaseAsArray();\n}"
        }
      },
      {
        "call_info": {
          "callee": "readAll",
          "args": [
            "*f"
          ],
          "line": 130
        },
        "resolved": true,
        "details": {
          "function_name": "readAll",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "383-385",
          "snippet": "kj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String readAll(kj::StringPtr name) {\n  return readAll(raiiOpen(name, O_RDONLY));\n}"
        }
      },
      {
        "call_info": {
          "callee": "raiiOpenIfExists",
          "args": [
            "filename",
            "O_RDONLY | O_CLOEXEC"
          ],
          "line": 128
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nstatic bool fileHasLine(kj::StringPtr filename, kj::StringPtr expectedLine) {\n  // Returns true if the given text file contains a line matching exactly the given string.\n  auto file = raiiOpenIfExists(filename, O_RDONLY | O_CLOEXEC);\n  KJ_IF_MAYBE(f, file) {\n    for (auto& line: splitLines(readAll(*f))) {\n      if (line == expectedLine) {\n        return true;\n      }\n    }\n    // File doesn't contain line.\n    return false;\n  } else {\n    // File doesn't exist at all.\n    return false;\n  }\n}"
  },
  {
    "function_name": "symlinkPointsInto",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "101-124",
    "snippet": "static bool symlinkPointsInto(kj::StringPtr symlink, kj::StringPtr targetPrefix) {\n  // Returns true if the given path names a symlink whose target has the given prefix, false if\n  // it points elsewhere or doesn't exist or isn't a symlink.\nretry:\n  char buffer[PATH_MAX];\n  ssize_t n = readlink(symlink.cStr(), buffer, sizeof(buffer) - 1);\n  if (n < 0) {\n    int error = errno;\n    switch (error) {\n      case ENOENT:\n      case ENOTDIR:\n      case EINVAL:\n        // File (or parent directory) dosen't exist or isn't a symlink.\n        return false;\n      case EINTR:\n        goto retry;\n      default:\n        KJ_FAIL_SYSCALL(\"readlink(symlink)\", error, symlink);\n    }\n  } else {\n    buffer[n] = '\\0';\n    return kj::StringPtr(buffer, n).startsWith(targetPrefix);\n  }\n}",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::StringPtr",
          "args": [
            "targetPrefix"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::StringPtr",
          "args": [
            "buffer",
            "n"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"readlink(symlink)\"",
            "error",
            "symlink"
          ],
          "line": 118
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "readlink",
          "args": [
            "symlink.cStr()",
            "buffer",
            "sizeof(buffer) - 1"
          ],
          "line": 106
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "symlink.cStr",
          "args": [],
          "line": 106
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nstatic bool symlinkPointsInto(kj::StringPtr symlink, kj::StringPtr targetPrefix) {\n  // Returns true if the given path names a symlink whose target has the given prefix, false if\n  // it points elsewhere or doesn't exist or isn't a symlink.\nretry:\n  char buffer[PATH_MAX];\n  ssize_t n = readlink(symlink.cStr(), buffer, sizeof(buffer) - 1);\n  if (n < 0) {\n    int error = errno;\n    switch (error) {\n      case ENOENT:\n      case ENOTDIR:\n      case EINVAL:\n        // File (or parent directory) dosen't exist or isn't a symlink.\n        return false;\n      case EINTR:\n        goto retry;\n      default:\n        KJ_FAIL_SYSCALL(\"readlink(symlink)\", error, symlink);\n    }\n  } else {\n    buffer[n] = '\\0';\n    return kj::StringPtr(buffer, n).startsWith(targetPrefix);\n  }\n}"
  },
  {
    "function_name": "prepareMonitoringLoop",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "82-99",
    "snippet": "kj::AutoCloseFd prepareMonitoringLoop() {\n  // Prepare to run a loop where we monitor some children and also receive signals.  Returns a\n  // signalfd.\n\n  // Set up signal mask to catch events that should lead to shutdown.\n  sigset_t sigmask;\n  KJ_SYSCALL(sigemptyset(&sigmask));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGTERM));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGINT));   // request front-end shutdown\n  KJ_SYSCALL(sigaddset(&sigmask, SIGCHLD));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGHUP));\n  KJ_SYSCALL(sigprocmask(SIG_BLOCK, &sigmask, nullptr));\n\n  // Receive signals on a signalfd.\n  int sigfd;\n  KJ_SYSCALL(sigfd = signalfd(-1, &sigmask, SFD_CLOEXEC));\n  return kj::AutoCloseFd(sigfd);\n}",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::AutoCloseFd",
          "args": [
            "sigfd"
          ],
          "line": 98
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigfd = signalfd(-1, &sigmask, SFD_CLOEXEC)"
          ],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "signalfd",
          "args": [
            "-1",
            "&sigmask",
            "SFD_CLOEXEC"
          ],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigprocmask(SIG_BLOCK, &sigmask, nullptr)"
          ],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sigprocmask",
          "args": [
            "SIG_BLOCK",
            "&sigmask",
            "nullptr"
          ],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigaddset(&sigmask, SIGHUP)"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sigaddset",
          "args": [
            "&sigmask",
            "SIGHUP"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigaddset(&sigmask, SIGCHLD)"
          ],
          "line": 91
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sigaddset",
          "args": [
            "&sigmask",
            "SIGCHLD"
          ],
          "line": 91
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigaddset(&sigmask, SIGINT)"
          ],
          "line": 90
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sigaddset",
          "args": [
            "&sigmask",
            "SIGINT"
          ],
          "line": 90
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigaddset(&sigmask, SIGTERM)"
          ],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sigaddset",
          "args": [
            "&sigmask",
            "SIGTERM"
          ],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigemptyset(&sigmask)"
          ],
          "line": 88
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sigemptyset",
          "args": [
            "&sigmask"
          ],
          "line": 88
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nkj::AutoCloseFd prepareMonitoringLoop() {\n  // Prepare to run a loop where we monitor some children and also receive signals.  Returns a\n  // signalfd.\n\n  // Set up signal mask to catch events that should lead to shutdown.\n  sigset_t sigmask;\n  KJ_SYSCALL(sigemptyset(&sigmask));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGTERM));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGINT));   // request front-end shutdown\n  KJ_SYSCALL(sigaddset(&sigmask, SIGCHLD));\n  KJ_SYSCALL(sigaddset(&sigmask, SIGHUP));\n  KJ_SYSCALL(sigprocmask(SIG_BLOCK, &sigmask, nullptr));\n\n  // Receive signals on a signalfd.\n  int sigfd;\n  KJ_SYSCALL(sigfd = signalfd(-1, &sigmask, SFD_CLOEXEC));\n  return kj::AutoCloseFd(sigfd);\n}"
  },
  {
    "function_name": "registerAlarmHandler",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "75-80",
    "snippet": "void registerAlarmHandler() {\n  struct sigaction action;\n  memset(&action, 0, sizeof(action));\n  action.sa_handler = &alarmHandler;\n  KJ_SYSCALL(sigaction(SIGALRM, &action, nullptr));\n}",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "sigaction(SIGALRM, &action, nullptr)"
          ],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sigaction",
          "args": [
            "SIGALRM",
            "&action",
            "nullptr"
          ],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&action",
            "0",
            "sizeof(action)"
          ],
          "line": 77
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid registerAlarmHandler() {\n  struct sigaction action;\n  memset(&action, 0, sizeof(action));\n  action.sa_handler = &alarmHandler;\n  KJ_SYSCALL(sigaction(SIGALRM, &action, nullptr));\n}"
  },
  {
    "function_name": "alarmHandler",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
    "lines": "72-74",
    "snippet": "void alarmHandler(int) {\n  alarmed = true;\n}",
    "includes": [
      "#include \"backup.h\"",
      "#include \"backend.h\"",
      "#include \"spk.h\"",
      "#include \"util.h\"",
      "#include \"supervisor.h\"",
      "#include \"send-fd.h\"",
      "#include \"version.h\"",
      "#include <arpa/inet.h>",
      "#include <dirent.h>",
      "#include <netdb.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdio.h>  // rename()",
      "#include <time.h>",
      "#include <ctype.h>",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <grp.h>",
      "#include <sched.h>",
      "#include <linux/securebits.h>",
      "#include <sys/ioctl.h>",
      "#include <sys/eventfd.h>",
      "#include <sys/capability.h>",
      "#include <sys/utsname.h>",
      "#include <sys/syscall.h>",
      "#include <sys/prctl.h>",
      "#include <sys/sendfile.h>",
      "#include <sys/wait.h>",
      "#include <sys/signalfd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <sys/mount.h>",
      "#include <unistd.h>",
      "#include <limits.h>",
      "#include <signal.h>",
      "#include <stdlib.h>",
      "#include <sodium/crypto_sign_ed25519.h>",
      "#include <sodium/randombytes.h>",
      "#include <sandstorm/update-tool.capnp.h>",
      "#include <sandstorm/package.capnp.h>",
      "#include <capnp/compat/json.h>",
      "#include <capnp/serialize.h>",
      "#include <capnp/dynamic.h>",
      "#include <capnp/schema.h>",
      "#include <kj/parse/char.h>",
      "#include <kj/parse/common.h>",
      "#include <kj/io.h>",
      "#include <kj/debug.h>",
      "#include <kj/main.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nvoid alarmHandler(int) {\n  alarmed = true;\n}"
  }
]