[
  {
    "function_name": "upload",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "619-622",
    "snippet": "kj::Promise<void> Indexer::upload(UploadContext context) {\n  context.getResults(capnp::MessageSize { 4, 1 }).setStream(newUploadStream());\n  return kj::READY_NOW;\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [
            "newUploadStream()"
          ],
          "line": 620
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "newUploadStream",
          "args": [],
          "line": 620
        },
        "resolved": true,
        "details": {
          "function_name": "newUploadStream",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "615-617",
          "snippet": "AppIndex::UploadStream::Client Indexer::newUploadStream() {\n  return kj::heap<UploadStreamImpl>();\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  AppIndex::UploadStream::Client Indexer::newUploadStream() {\n    return kj::heap<UploadStreamImpl>();\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.getResults",
          "args": [
            "capnp::MessageSize { 4, 1 }"
          ],
          "line": 620
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::Promise<void> Indexer::upload(UploadContext context) {\n    context.getResults(capnp::MessageSize { 4, 1 }).setStream(newUploadStream());\n    return kj::READY_NOW;\n  }\n}"
  },
  {
    "function_name": "newUploadStream",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "615-617",
    "snippet": "AppIndex::UploadStream::Client Indexer::newUploadStream() {\n  return kj::heap<UploadStreamImpl>();\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::heap<UploadStreamImpl>",
          "args": [],
          "line": 616
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  AppIndex::UploadStream::Client Indexer::newUploadStream() {\n    return kj::heap<UploadStreamImpl>();\n  }\n}"
  },
  {
    "function_name": "getResult",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "551-606",
    "snippet": "kj::Promise<void> getResult(GetResultContext context) override {\n    KJ_REQUIRE(!getResultCalled, \"can only call getResult() once\");\n    getResultCalled = true;\n    return doneCalledPaf.promise.then([this]() {\n      capnp::MallocMessageBuilder infoMessage;\n      auto info = infoMessage.getRoot<spk::VerifiedInfo>();\n      KJ_SYSCALL(lseek(spkFile.getFd(), 0, SEEK_SET));\n      verifySpk(spkFile.getFd(), openTemporary(\"/var/tmp\"), info);\n      auto metadata = info.getMetadata();\n      auto author = metadata.getAuthor();\n      KJ_ASSERT(author.hasContactEmail(),\n          \"package metadata is missing contact email; we need an email address to which to send \"\n          \"notifications regarding the app listing\");\n      KJ_ASSERT(metadata.getCategories().size() > 0,\n          \"package metadata does not list any categories (genres); you must list at least one!\");\n      auto shortDescription = metadata.getShortDescription().getDefaultText();\n      KJ_ASSERT(shortDescription.size() > 0 && shortDescription.size() < 25,\n          \"bad shortDescription; please provide a 1-to-3 word short description to display \"\n          \"under the app title, e.g. \\\"Document editor\\\"\");\n\n      KJ_IF_MAYBE(previous, sandstorm::raiiOpenIfExists(\n          kj::str(\"/var/apps/\", appIdString(info.getAppId()), \"/metadata\"), O_RDONLY)) {\n        capnp::StreamFdMessageReader reader(previous->get());\n        auto previouslyPublished = reader.getRoot<spk::VerifiedInfo>();\n        KJ_ASSERT(info.getVersion() > previouslyPublished.getVersion(),\n            \"oops, it looks like you forgot to bump appVersion -- it must be greater than the \"\n            \"previous published version of this app\", previouslyPublished.getVersion());\n      }\n\n      auto packageDir = kj::str(\"/var/packages/\", packageIdString(info.getPackageId()));\n      auto spkFilename = kj::str(packageDir, \"/spk\");\n      if (access(spkFilename.cStr(), F_OK) < 0) {\n        mkdir(packageDir.cStr(), 0777);\n\n        {\n          StagingFile metadataFile(packageDir);\n          capnp::writeMessageToFd(metadataFile.getFd(), infoMessage);\n          metadataFile.finalize(kj::str(packageDir, \"/metadata\"));\n        }\n\n        {\n          capnp::MallocMessageBuilder statusMessage;\n          statusMessage.initRoot<SubmissionStatus>();  // default content is what we want\n          StagingFile statusFile(packageDir);\n          capnp::writeMessageToFd(statusFile.getFd(), statusMessage);\n          statusFile.finalize(kj::str(packageDir, \"/status\"));\n        }\n\n        // Finalize the spk last because its existence implies that the metadata and status already\n        // exist.\n        spkFile.finalize(spkFilename);\n\n        // TODO(soon): Check keybase info.\n      }\n    });\n  }",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "doneCalledPaf.promise.then",
          "args": [
            "[this]() {\n      capnp::MallocMessageBuilder infoMessage;\n      auto info = infoMessage.getRoot<spk::VerifiedInfo>();\n      KJ_SYSCALL(lseek(spkFile.getFd(), 0, SEEK_SET));\n      verifySpk(spkFile.getFd(), openTemporary(\"/var/tmp\"), info);\n      auto metadata = info.getMetadata();\n      auto author = metadata.getAuthor();\n      KJ_ASSERT(author.hasContactEmail(),\n          \"package metadata is missing contact email; we need an email address to which to send \"\n          \"notifications regarding the app listing\");\n      KJ_ASSERT(metadata.getCategories().size() > 0,\n          \"package metadata does not list any categories (genres); you must list at least one!\");\n      auto shortDescription = metadata.getShortDescription().getDefaultText();\n      KJ_ASSERT(shortDescription.size() > 0 && shortDescription.size() < 25,\n          \"bad shortDescription; please provide a 1-to-3 word short description to display \"\n          \"under the app title, e.g. \\\"Document editor\\\"\");\n\n      KJ_IF_MAYBE(previous, sandstorm::raiiOpenIfExists(\n          kj::str(\"/var/apps/\", appIdString(info.getAppId()), \"/metadata\"), O_RDONLY)) {\n        capnp::StreamFdMessageReader reader(previous->get());\n        auto previouslyPublished = reader.getRoot<spk::VerifiedInfo>();\n        KJ_ASSERT(info.getVersion() > previouslyPublished.getVersion(),\n            \"oops, it looks like you forgot to bump appVersion -- it must be greater than the \"\n            \"previous published version of this app\", previouslyPublished.getVersion());\n      }\n\n      auto packageDir = kj::str(\"/var/packages/\", packageIdString(info.getPackageId()));\n      auto spkFilename = kj::str(packageDir, \"/spk\");\n      if (access(spkFilename.cStr(), F_OK) < 0) {\n        mkdir(packageDir.cStr(), 0777);\n\n        {\n          StagingFile metadataFile(packageDir);\n          capnp::writeMessageToFd(metadataFile.getFd(), infoMessage);\n          metadataFile.finalize(kj::str(packageDir, \"/metadata\"));\n        }\n\n        {\n          capnp::MallocMessageBuilder statusMessage;\n          statusMessage.initRoot<SubmissionStatus>();  // default content is what we want\n          StagingFile statusFile(packageDir);\n          capnp::writeMessageToFd(statusFile.getFd(), statusMessage);\n          statusFile.finalize(kj::str(packageDir, \"/status\"));\n        }\n\n        // Finalize the spk last because its existence implies that the metadata and status already\n        // exist.\n        spkFile.finalize(spkFilename);\n\n        // TODO(soon): Check keybase info.\n      }\n    }"
          ],
          "line": 554
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "spkFile.finalize",
          "args": [
            "spkFilename"
          ],
          "line": 601
        },
        "resolved": true,
        "details": {
          "function_name": "finalize",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "55-60",
          "snippet": "void finalize(kj::StringPtr path) {\n    KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n    KJ_SYSCALL(fsync(fd));\n    KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n    finalized = true;\n  }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  void finalize(kj::StringPtr path) {\n      KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n      KJ_SYSCALL(fsync(fd));\n      KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n      finalized = true;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "packageDir",
            "\"/status\""
          ],
          "line": 596
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::writeMessageToFd",
          "args": [
            "statusFile.getFd()",
            "statusMessage"
          ],
          "line": 595
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "statusFile.getFd",
          "args": [],
          "line": 595
        },
        "resolved": true,
        "details": {
          "function_name": "getFd",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "62-62",
          "snippet": "int getFd() { return fd; }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  int getFd() { return fd; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "statusMessage.initRoot<SubmissionStatus>",
          "args": [],
          "line": 593
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "packageDir",
            "\"/metadata\""
          ],
          "line": 588
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::writeMessageToFd",
          "args": [
            "metadataFile.getFd()",
            "infoMessage"
          ],
          "line": 587
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkdir",
          "args": [
            "packageDir.cStr()",
            "0777"
          ],
          "line": 583
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "packageDir.cStr",
          "args": [],
          "line": 583
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "spkFilename.cStr()",
            "F_OK"
          ],
          "line": 582
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "spkFilename.cStr",
          "args": [],
          "line": 582
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "packageDir",
            "\"/spk\""
          ],
          "line": 581
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageIdString(info.getPackageId())"
          ],
          "line": 580
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "packageIdString",
          "args": [
            "info.getPackageId()"
          ],
          "line": 580
        },
        "resolved": true,
        "details": {
          "function_name": "packageIdString",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/id-to-text.c++",
          "lines": "189-192",
          "snippet": "kj::String packageIdString(kj::ArrayPtr<const kj::byte> packageId) {\n  KJ_ASSERT(packageId.size() == PACKAGE_ID_BYTE_SIZE);\n  return hexEncode(packageId);\n}",
          "includes": [
            "#include \"util.h\"",
            "#include \"id-to-text.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include \"id-to-text.h\"\n\nkj::String packageIdString(kj::ArrayPtr<const kj::byte> packageId) {\n  KJ_ASSERT(packageId.size() == PACKAGE_ID_BYTE_SIZE);\n  return hexEncode(packageId);\n}"
        }
      },
      {
        "call_info": {
          "callee": "info.getPackageId",
          "args": [],
          "line": 580
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "info.getVersion() > previouslyPublished.getVersion()",
            "\"oops, it looks like you forgot to bump appVersion -- it must be greater than the \"\n            \"previous published version of this app\"",
            "previouslyPublished.getVersion()"
          ],
          "line": 575
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "previouslyPublished.getVersion",
          "args": [],
          "line": 577
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "previouslyPublished.getVersion",
          "args": [],
          "line": 575
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getVersion",
          "args": [],
          "line": 575
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reader.getRoot<spk::VerifiedInfo>",
          "args": [],
          "line": 574
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "previous->get",
          "args": [],
          "line": 573
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "previous",
            "sandstorm::raiiOpenIfExists(\n          kj::str(\"/var/apps/\", appIdString(info.getAppId()), \"/metadata\"), O_RDONLY)"
          ],
          "line": 571
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": "BridgeProxy",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/bridge-proxy.c++",
          "lines": "144-150",
          "snippet": "KJ_IF_MAYBE(auth, headers.get(hAuthorization)) {\n      if (auth->startsWith(\"bearer \") || auth->startsWith(\"Bearer \")) {\n        auto token = auth->slice(strlen(\"bearer \"));\n        auto session = getHttpSession(token);\n        return dispatchToSession(kj::mv(session), method, url, headers, requestBody, response);\n      }\n    }",
          "includes": [
            "#include \"util.h\"",
            "#include <kj/debug.h>",
            "#include <capnp/compat/json.h>",
            "#include <sandstorm/bridge-proxy.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <map>",
            "#include \"bridge-proxy.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include <kj/debug.h>\n#include <capnp/compat/json.h>\n#include <sandstorm/bridge-proxy.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <map>\n#include \"bridge-proxy.h\"\n\nBridgeProxy {\n  KJ_IF_MAYBE(auth, headers.get(hAuthorization)) {\n        if (auth->startsWith(\"bearer \") || auth->startsWith(\"Bearer \")) {\n          auto token = auth->slice(strlen(\"bearer \"));\n          auto session = getHttpSession(token);\n          return dispatchToSession(kj::mv(session), method, url, headers, requestBody, response);\n        }\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "sandstorm::raiiOpenIfExists",
          "args": [
            "kj::str(\"/var/apps/\", appIdString(info.getAppId()), \"/metadata\")",
            "O_RDONLY"
          ],
          "line": 571
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/apps/\"",
            "appIdString(info.getAppId())",
            "\"/metadata\""
          ],
          "line": 572
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "appIdString",
          "args": [
            "info.getAppId()"
          ],
          "line": 572
        },
        "resolved": true,
        "details": {
          "function_name": "appIdString",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/id-to-text.c++",
          "lines": "171-174",
          "snippet": "kj::String appIdString(kj::ArrayPtr<const kj::byte> appId) {\n  KJ_REQUIRE(appId.size() == APP_ID_BYTE_SIZE);\n  return base32Encode(appId);\n}",
          "includes": [
            "#include \"util.h\"",
            "#include \"id-to-text.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include \"id-to-text.h\"\n\nkj::String appIdString(kj::ArrayPtr<const kj::byte> appId) {\n  KJ_REQUIRE(appId.size() == APP_ID_BYTE_SIZE);\n  return base32Encode(appId);\n}"
        }
      },
      {
        "call_info": {
          "callee": "info.getAppId",
          "args": [],
          "line": 572
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "shortDescription.size() > 0 && shortDescription.size() < 25",
            "\"bad shortDescription; please provide a 1-to-3 word short description to display \"\n          \"under the app title, e.g. \\\"Document editor\\\"\""
          ],
          "line": 567
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "shortDescription.size",
          "args": [],
          "line": 567
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "metadata.getShortDescription",
          "args": [],
          "line": 566
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getShortDescription",
          "args": [],
          "line": 566
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "metadata.getCategories().size() > 0",
            "\"package metadata does not list any categories (genres); you must list at least one!\""
          ],
          "line": 564
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getCategories",
          "args": [],
          "line": 564
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getCategories",
          "args": [],
          "line": 564
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "author.hasContactEmail()",
            "\"package metadata is missing contact email; we need an email address to which to send \"\n          \"notifications regarding the app listing\""
          ],
          "line": 561
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "author.hasContactEmail",
          "args": [],
          "line": 561
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getAuthor",
          "args": [],
          "line": 560
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getMetadata",
          "args": [],
          "line": 559
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "verifySpk",
          "args": [
            "spkFile.getFd()",
            "openTemporary(\"/var/tmp\")",
            "info"
          ],
          "line": 558
        },
        "resolved": true,
        "details": {
          "function_name": "verifySpk",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/spk.c++",
          "lines": "2443-2447",
          "snippet": "void verifySpk(int spkfd, int tmpfile, spk::VerifiedInfo::Builder output) {\n  SpkTool::verifyImpl(spkfd, tmpfile, output, [](kj::StringPtr problem) -> kj::String {\n    KJ_FAIL_ASSERT(\"spk verification failed\", problem);\n  });\n}",
          "includes": [
            "#include \"appid-replacements.h\"",
            "#include \"id-to-text.h\"",
            "#include \"util.h\"",
            "#include \"send-fd.h\"",
            "#include \"union-fs.h\"",
            "#include \"fuse.h\"",
            "#include \"version.h\"",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <sandstorm/app-index/submit.capnp.h>",
            "#include <poll.h>",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema-parser.h>",
            "#include <sys/xattr.h>",
            "#include <map>",
            "#include <set>",
            "#include <dirent.h>",
            "#include <stdlib.h>",
            "#include <sandstorm/appid-replacements.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <errno.h>",
            "#include <sys/mman.h>",
            "#include <sys/wait.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdio.h>",
            "#include <fcntl.h>",
            "#include <unistd.h>",
            "#include <sodium/crypto_hash_sha512.h>",
            "#include <sodium/crypto_hash_sha256.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize-packed.h>",
            "#include <capnp/serialize.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include \"spk.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "friend void verifySpk(int spkfd, int tmpfile, spk::VerifiedInfo::Builder output);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"appid-replacements.h\"\n#include \"id-to-text.h\"\n#include \"util.h\"\n#include \"send-fd.h\"\n#include \"union-fs.h\"\n#include \"fuse.h\"\n#include \"version.h\"\n#include <sodium/crypto_generichash_blake2b.h>\n#include <sandstorm/app-index/submit.capnp.h>\n#include <poll.h>\n#include <time.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema-parser.h>\n#include <sys/xattr.h>\n#include <map>\n#include <set>\n#include <dirent.h>\n#include <stdlib.h>\n#include <sandstorm/appid-replacements.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <errno.h>\n#include <sys/mman.h>\n#include <sys/wait.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <unistd.h>\n#include <sodium/crypto_hash_sha512.h>\n#include <sodium/crypto_hash_sha256.h>\n#include <sodium/crypto_sign.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include \"spk.h\"\n\nfriend void verifySpk(int spkfd, int tmpfile, spk::VerifiedInfo::Builder output);\n\nvoid verifySpk(int spkfd, int tmpfile, spk::VerifiedInfo::Builder output) {\n  SpkTool::verifyImpl(spkfd, tmpfile, output, [](kj::StringPtr problem) -> kj::String {\n    KJ_FAIL_ASSERT(\"spk verification failed\", problem);\n  });\n}"
        }
      },
      {
        "call_info": {
          "callee": "openTemporary",
          "args": [
            "\"/var/tmp\""
          ],
          "line": 558
        },
        "resolved": true,
        "details": {
          "function_name": "openTemporary",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "232-241",
          "snippet": "kj::AutoCloseFd openTemporary(kj::StringPtr near) {\n  // TODO(someday):  Use O_TMPFILE?  New in Linux 3.11.\n\n  int fd;\n  auto name = kj::str(near, \".XXXXXX\");\n  KJ_SYSCALL(fd = mkostemp(name.begin(), O_CLOEXEC), name);\n  kj::AutoCloseFd result(fd);\n  KJ_SYSCALL(unlink(name.cStr()));\n  return result;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::AutoCloseFd openTemporary(kj::StringPtr near) {\n  // TODO(someday):  Use O_TMPFILE?  New in Linux 3.11.\n\n  int fd;\n  auto name = kj::str(near, \".XXXXXX\");\n  KJ_SYSCALL(fd = mkostemp(name.begin(), O_CLOEXEC), name);\n  kj::AutoCloseFd result(fd);\n  KJ_SYSCALL(unlink(name.cStr()));\n  return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "lseek(spkFile.getFd(), 0, SEEK_SET)"
          ],
          "line": 557
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "lseek",
          "args": [
            "spkFile.getFd()",
            "0",
            "SEEK_SET"
          ],
          "line": 557
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "infoMessage.getRoot<spk::VerifiedInfo>",
          "args": [],
          "line": 556
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "!getResultCalled",
            "\"can only call getResult() once\""
          ],
          "line": 552
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nkj::Promise<void> getResult(GetResultContext context) override {\n    KJ_REQUIRE(!getResultCalled, \"can only call getResult() once\");\n    getResultCalled = true;\n    return doneCalledPaf.promise.then([this]() {\n      capnp::MallocMessageBuilder infoMessage;\n      auto info = infoMessage.getRoot<spk::VerifiedInfo>();\n      KJ_SYSCALL(lseek(spkFile.getFd(), 0, SEEK_SET));\n      verifySpk(spkFile.getFd(), openTemporary(\"/var/tmp\"), info);\n      auto metadata = info.getMetadata();\n      auto author = metadata.getAuthor();\n      KJ_ASSERT(author.hasContactEmail(),\n          \"package metadata is missing contact email; we need an email address to which to send \"\n          \"notifications regarding the app listing\");\n      KJ_ASSERT(metadata.getCategories().size() > 0,\n          \"package metadata does not list any categories (genres); you must list at least one!\");\n      auto shortDescription = metadata.getShortDescription().getDefaultText();\n      KJ_ASSERT(shortDescription.size() > 0 && shortDescription.size() < 25,\n          \"bad shortDescription; please provide a 1-to-3 word short description to display \"\n          \"under the app title, e.g. \\\"Document editor\\\"\");\n\n      KJ_IF_MAYBE(previous, sandstorm::raiiOpenIfExists(\n          kj::str(\"/var/apps/\", appIdString(info.getAppId()), \"/metadata\"), O_RDONLY)) {\n        capnp::StreamFdMessageReader reader(previous->get());\n        auto previouslyPublished = reader.getRoot<spk::VerifiedInfo>();\n        KJ_ASSERT(info.getVersion() > previouslyPublished.getVersion(),\n            \"oops, it looks like you forgot to bump appVersion -- it must be greater than the \"\n            \"previous published version of this app\", previouslyPublished.getVersion());\n      }\n\n      auto packageDir = kj::str(\"/var/packages/\", packageIdString(info.getPackageId()));\n      auto spkFilename = kj::str(packageDir, \"/spk\");\n      if (access(spkFilename.cStr(), F_OK) < 0) {\n        mkdir(packageDir.cStr(), 0777);\n\n        {\n          StagingFile metadataFile(packageDir);\n          capnp::writeMessageToFd(metadataFile.getFd(), infoMessage);\n          metadataFile.finalize(kj::str(packageDir, \"/metadata\"));\n        }\n\n        {\n          capnp::MallocMessageBuilder statusMessage;\n          statusMessage.initRoot<SubmissionStatus>();  // default content is what we want\n          StagingFile statusFile(packageDir);\n          capnp::writeMessageToFd(statusFile.getFd(), statusMessage);\n          statusFile.finalize(kj::str(packageDir, \"/status\"));\n        }\n\n        // Finalize the spk last because its existence implies that the metadata and status already\n        // exist.\n        spkFile.finalize(spkFilename);\n\n        // TODO(soon): Check keybase info.\n      }\n    });\n  }"
  },
  {
    "function_name": "done",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "544-549",
    "snippet": "kj::Promise<void> done(DoneContext context) override {\n    KJ_REQUIRE(!doneCalled, \"can only call done() once\");\n    doneCalled = true;\n    doneCalledPaf.fulfiller->fulfill();\n    return kj::READY_NOW;\n  }",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "doneCalledPaf.fulfiller->fulfill",
          "args": [],
          "line": 547
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "!doneCalled",
            "\"can only call done() once\""
          ],
          "line": 545
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nkj::Promise<void> done(DoneContext context) override {\n    KJ_REQUIRE(!doneCalled, \"can only call done() once\");\n    doneCalled = true;\n    doneCalledPaf.fulfiller->fulfill();\n    return kj::READY_NOW;\n  }"
  },
  {
    "function_name": "write",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "537-542",
    "snippet": "kj::Promise<void> write(WriteContext context) override {\n    KJ_REQUIRE(!doneCalled, \"called write() after done()\");\n    auto data = context.getParams().getData();\n    kj::FdOutputStream(spkFile.getFd()).write(data.begin(), data.size());\n    return kj::READY_NOW;\n  }",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "data.begin()",
            "data.size()"
          ],
          "line": 540
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "data.size",
          "args": [],
          "line": 540
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "data.begin",
          "args": [],
          "line": 540
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "spkFile.getFd()"
          ],
          "line": 540
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "spkFile.getFd",
          "args": [],
          "line": 540
        },
        "resolved": true,
        "details": {
          "function_name": "getFd",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "62-62",
          "snippet": "int getFd() { return fd; }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  int getFd() { return fd; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "context.getParams",
          "args": [],
          "line": 539
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context.getParams",
          "args": [],
          "line": 539
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "!doneCalled",
            "\"called write() after done()\""
          ],
          "line": 538
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nkj::Promise<void> write(WriteContext context) override {\n    KJ_REQUIRE(!doneCalled, \"called write() after done()\");\n    auto data = context.getParams().getData();\n    kj::FdOutputStream(spkFile.getFd()).write(data.begin(), data.size());\n    return kj::READY_NOW;\n  }"
  },
  {
    "function_name": "UploadStreamImpl",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "533-534",
    "snippet": "UploadStreamImpl()\n      : spkFile(\"/var/tmp\") {}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nUploadStreamImpl()\n      : spkFile(\"/var/tmp\") {}"
  },
  {
    "function_name": "getReviewQueueJson",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "486-527",
    "snippet": "kj::String Indexer::getReviewQueueJson() {\n  kj::Vector<kj::String> reviewIds;\n\n  for (auto& packageId: listDirectory(\"/var/packages\")) {\n    KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n      auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n      auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n\n      KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n\n      capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n      auto status = statusMessage.getRoot<SubmissionStatus>();\n      if (status.isPending() && status.getRequestState() != SubmissionState::IGNORE) {\n        reviewIds.add(kj::str(packageId));\n      }\n    })) {\n      KJ_LOG(ERROR, \"error processing package\", packageId, *exception);\n    }\n  }\n\n  capnp::MallocMessageBuilder scratch;\n  auto orphan = scratch.getOrphanage().newOrphan<capnp::List<spk::VerifiedInfo>>(reviewIds.size());\n  auto list = orphan.get();\n  uint i = 0;\n\n  for (auto& packageId: reviewIds) {\n    auto metadataFile = kj::str(\"/var/packages/\", packageId, \"/metadata\");\n    capnp::StreamFdMessageReader metadataMessage(raiiOpen(metadataFile, O_RDONLY));\n    list.setWithCaveats(i++, metadataMessage.getRoot<spk::VerifiedInfo>());\n  }\n\n  AppIdJsonHandler appIdHandler;\n  PackageIdJsonHandler packageIdHandler;\n  DataHandler dataHandler;\n  capnp::JsonCodec json;\n  json.addTypeHandler(appIdHandler);\n  json.addTypeHandler(packageIdHandler);\n  json.addTypeHandler(dataHandler);\n  json.setPrettyPrint(true);\n\n  return json.encode(list);\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "json.encode",
          "args": [
            "list"
          ],
          "line": 526
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "json.setPrettyPrint",
          "args": [
            "true"
          ],
          "line": 524
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "json.addTypeHandler",
          "args": [
            "dataHandler"
          ],
          "line": 523
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "json.addTypeHandler",
          "args": [
            "packageIdHandler"
          ],
          "line": 522
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "json.addTypeHandler",
          "args": [
            "appIdHandler"
          ],
          "line": 521
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "list.setWithCaveats",
          "args": [
            "i++",
            "metadataMessage.getRoot<spk::VerifiedInfo>()"
          ],
          "line": 514
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadataMessage.getRoot<spk::VerifiedInfo>",
          "args": [],
          "line": 514
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageId",
            "\"/metadata\""
          ],
          "line": 512
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "orphan.get",
          "args": [],
          "line": 508
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "scratch.getOrphanage",
          "args": [
            "reviewIds.size()"
          ],
          "line": 507
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reviewIds.size",
          "args": [],
          "line": 507
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "scratch.getOrphanage",
          "args": [],
          "line": 507
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_LOG",
          "args": [
            "ERROR",
            "\"error processing package\"",
            "packageId",
            "*exception"
          ],
          "line": 502
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "exception",
            "kj::runCatchingExceptions([&]() {\n      auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n      auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n\n      KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n\n      capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n      auto status = statusMessage.getRoot<SubmissionStatus>();\n      if (status.isPending() && status.getRequestState() != SubmissionState::IGNORE) {\n        reviewIds.add(kj::str(packageId));\n      }\n    })"
          ],
          "line": 490
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": "BridgeProxy",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/bridge-proxy.c++",
          "lines": "144-150",
          "snippet": "KJ_IF_MAYBE(auth, headers.get(hAuthorization)) {\n      if (auth->startsWith(\"bearer \") || auth->startsWith(\"Bearer \")) {\n        auto token = auth->slice(strlen(\"bearer \"));\n        auto session = getHttpSession(token);\n        return dispatchToSession(kj::mv(session), method, url, headers, requestBody, response);\n      }\n    }",
          "includes": [
            "#include \"util.h\"",
            "#include <kj/debug.h>",
            "#include <capnp/compat/json.h>",
            "#include <sandstorm/bridge-proxy.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <map>",
            "#include \"bridge-proxy.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include <kj/debug.h>\n#include <capnp/compat/json.h>\n#include <sandstorm/bridge-proxy.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <map>\n#include \"bridge-proxy.h\"\n\nBridgeProxy {\n  KJ_IF_MAYBE(auth, headers.get(hAuthorization)) {\n        if (auth->startsWith(\"bearer \") || auth->startsWith(\"Bearer \")) {\n          auto token = auth->slice(strlen(\"bearer \"));\n          auto session = getHttpSession(token);\n          return dispatchToSession(kj::mv(session), method, url, headers, requestBody, response);\n        }\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::runCatchingExceptions",
          "args": [
            "[&]() {\n      auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n      auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n\n      KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n\n      capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n      auto status = statusMessage.getRoot<SubmissionStatus>();\n      if (status.isPending() && status.getRequestState() != SubmissionState::IGNORE) {\n        reviewIds.add(kj::str(packageId));\n      }\n    }"
          ],
          "line": 490
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reviewIds.add",
          "args": [
            "kj::str(packageId)"
          ],
          "line": 499
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "packageId"
          ],
          "line": 499
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.getRequestState",
          "args": [],
          "line": 498
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.isPending",
          "args": [],
          "line": 498
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "statusMessage.getRoot<SubmissionStatus>",
          "args": [],
          "line": 497
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "access(spkFile.cStr(), F_OK)"
          ],
          "line": 494
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "spkFile.cStr()",
            "F_OK"
          ],
          "line": 494
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "spkFile.cStr",
          "args": [],
          "line": 494
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageId",
            "\"/status\""
          ],
          "line": 492
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageId",
            "\"/spk\""
          ],
          "line": 491
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "listDirectory",
          "args": [
            "\"/var/packages\""
          ],
          "line": 489
        },
        "resolved": true,
        "details": {
          "function_name": "listDirectoryFd",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "292-297",
          "snippet": "kj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}"
        }
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::getReviewQueueJson() {\n    kj::Vector<kj::String> reviewIds;\n  \n    for (auto& packageId: listDirectory(\"/var/packages\")) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n        auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n  \n        KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n  \n        capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n        auto status = statusMessage.getRoot<SubmissionStatus>();\n        if (status.isPending() && status.getRequestState() != SubmissionState::IGNORE) {\n          reviewIds.add(kj::str(packageId));\n        }\n      })) {\n        KJ_LOG(ERROR, \"error processing package\", packageId, *exception);\n      }\n    }\n  \n    capnp::MallocMessageBuilder scratch;\n    auto orphan = scratch.getOrphanage().newOrphan<capnp::List<spk::VerifiedInfo>>(reviewIds.size());\n    auto list = orphan.get();\n    uint i = 0;\n  \n    for (auto& packageId: reviewIds) {\n      auto metadataFile = kj::str(\"/var/packages/\", packageId, \"/metadata\");\n      capnp::StreamFdMessageReader metadataMessage(raiiOpen(metadataFile, O_RDONLY));\n      list.setWithCaveats(i++, metadataMessage.getRoot<spk::VerifiedInfo>());\n    }\n  \n    AppIdJsonHandler appIdHandler;\n    PackageIdJsonHandler packageIdHandler;\n    DataHandler dataHandler;\n    capnp::JsonCodec json;\n    json.addTypeHandler(appIdHandler);\n    json.addTypeHandler(packageIdHandler);\n    json.addTypeHandler(dataHandler);\n    json.setPrettyPrint(true);\n  \n    return json.encode(list);\n  }\n}"
  },
  {
    "function_name": "categoryName",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "471-482",
    "snippet": "capnp::Text::Reader Indexer::categoryName(spk::Category category) {\n  auto categories = capnp::Schema::from<spk::Category>().getEnumerants();\n  auto categoryId = static_cast<uint>(category);\n  if (categoryId < categories.size()) {\n    for (auto annotation: categories[categoryId].getProto().getAnnotations()) {\n      if (annotation.getId() == 0x8d51dd236606d205) {\n        return annotation.getValue().getStruct().getAs<spk::CategoryInfo>().getTitle();\n      }\n    }\n  }\n  return \"Other\";\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "annotation.getValue",
          "args": [],
          "line": 477
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "annotation.getValue",
          "args": [],
          "line": 477
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "annotation.getValue",
          "args": [],
          "line": 477
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "annotation.getValue",
          "args": [],
          "line": 477
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "annotation.getId",
          "args": [],
          "line": 476
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "categories[categoryId].getProto",
          "args": [],
          "line": 475
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "categories[categoryId].getProto",
          "args": [],
          "line": 475
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "categories.size",
          "args": [],
          "line": 474
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "static_cast<uint>",
          "args": [
            "category"
          ],
          "line": 473
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::Schema::from<spk::Category>",
          "args": [],
          "line": 472
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::Schema::from<spk::Category>",
          "args": [],
          "line": 472
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  capnp::Text::Reader Indexer::categoryName(spk::Category category) {\n    auto categories = capnp::Schema::from<spk::Category>().getEnumerants();\n    auto categoryId = static_cast<uint>(category);\n    if (categoryId < categories.size()) {\n      for (auto annotation: categories[categoryId].getProto().getAnnotations()) {\n        if (annotation.getId() == 0x8d51dd236606d205) {\n          return annotation.getValue().getStruct().getAs<spk::CategoryInfo>().getTitle();\n        }\n      }\n    }\n    return \"Other\";\n  }\n}"
  },
  {
    "function_name": "writeImage",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "453-469",
    "snippet": "kj::String Indexer::writeImage(kj::ArrayPtr<const byte> data, kj::StringPtr extension) {\n  // Hash the data to determine the filename.\n  byte hash[16];\n  crypto_generichash_blake2b(hash, sizeof(hash), data.begin(), data.size(), nullptr, 0);\n\n  // Write if not already present.\n  auto basename = kj::str(hexEncode(hash), extension);\n  auto filename = kj::str(\"/var/www/images/\", basename);\n\n  if (access(filename.cStr(), F_OK) < 0) {\n    StagingFile file(\"/var/www/images\");\n    kj::FdOutputStream(file.getFd()).write(data.begin(), data.size());\n    file.finalize(filename);\n  }\n\n  return basename;\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "file.finalize",
          "args": [
            "filename"
          ],
          "line": 465
        },
        "resolved": true,
        "details": {
          "function_name": "finalize",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "55-60",
          "snippet": "void finalize(kj::StringPtr path) {\n    KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n    KJ_SYSCALL(fsync(fd));\n    KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n    finalized = true;\n  }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  void finalize(kj::StringPtr path) {\n      KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n      KJ_SYSCALL(fsync(fd));\n      KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n      finalized = true;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "data.begin()",
            "data.size()"
          ],
          "line": 464
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "data.size",
          "args": [],
          "line": 464
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "data.begin",
          "args": [],
          "line": 464
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "file.getFd()"
          ],
          "line": 464
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "file.getFd",
          "args": [],
          "line": 464
        },
        "resolved": true,
        "details": {
          "function_name": "getFd",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "62-62",
          "snippet": "int getFd() { return fd; }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  int getFd() { return fd; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "filename.cStr()",
            "F_OK"
          ],
          "line": 462
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "filename.cStr",
          "args": [],
          "line": 462
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/www/images/\"",
            "basename"
          ],
          "line": 460
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "hexEncode(hash)",
            "extension"
          ],
          "line": 459
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "hexEncode",
          "args": [
            "hash"
          ],
          "line": 459
        },
        "resolved": true,
        "details": {
          "function_name": "hexEncode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "784-787",
          "snippet": "kj::String hexEncode(kj::ArrayPtr<const byte> input) {\n  const char DIGITS[] = \"0123456789abcdef\";\n  return kj::strArray(KJ_MAP(b, input) { return kj::heapArray<char>({DIGITS[b/16], DIGITS[b%16]}); }, \"\");\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String hexEncode(kj::ArrayPtr<const byte> input) {\n  const char DIGITS[] = \"0123456789abcdef\";\n  return kj::strArray(KJ_MAP(b, input) { return kj::heapArray<char>({DIGITS[b/16], DIGITS[b%16]}); }, \"\");\n}"
        }
      },
      {
        "call_info": {
          "callee": "crypto_generichash_blake2b",
          "args": [
            "hash",
            "sizeof(hash)",
            "data.begin()",
            "data.size()",
            "nullptr",
            "0"
          ],
          "line": 456
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "data.begin",
          "args": [],
          "line": 456
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::writeImage(kj::ArrayPtr<const byte> data, kj::StringPtr extension) {\n    // Hash the data to determine the filename.\n    byte hash[16];\n    crypto_generichash_blake2b(hash, sizeof(hash), data.begin(), data.size(), nullptr, 0);\n  \n    // Write if not already present.\n    auto basename = kj::str(hexEncode(hash), extension);\n    auto filename = kj::str(\"/var/www/images/\", basename);\n  \n    if (access(filename.cStr(), F_OK) < 0) {\n      StagingFile file(\"/var/www/images\");\n      kj::FdOutputStream(file.getFd()).write(data.begin(), data.size());\n      file.finalize(filename);\n    }\n  \n    return basename;\n  }\n}"
  },
  {
    "function_name": "writeScreenshot",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "438-451",
    "snippet": "kj::String Indexer::writeScreenshot(spk::Metadata::Screenshot::Reader screenshot) {\n  switch (screenshot.which()) {\n    case spk::Metadata::Screenshot::PNG:\n      return writeImage(screenshot.getPng(), \".png\");\n\n    case spk::Metadata::Screenshot::JPEG:\n      return writeImage(screenshot.getJpeg().asBytes(), \".jpeg\");\n\n    case spk::Metadata::Screenshot::UNKNOWN:\n      break;\n  }\n\n  KJ_FAIL_ASSERT(\"unknown screenshot type\", (uint)screenshot.which());\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_FAIL_ASSERT",
          "args": [
            "\"unknown screenshot type\"",
            "(uint)screenshot.which()"
          ],
          "line": 450
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "screenshot.which",
          "args": [],
          "line": 450
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "writeImage",
          "args": [
            "screenshot.getJpeg().asBytes()",
            "\".jpeg\""
          ],
          "line": 444
        },
        "resolved": true,
        "details": {
          "function_name": "writeImage",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "453-469",
          "snippet": "kj::String Indexer::writeImage(kj::ArrayPtr<const byte> data, kj::StringPtr extension) {\n  // Hash the data to determine the filename.\n  byte hash[16];\n  crypto_generichash_blake2b(hash, sizeof(hash), data.begin(), data.size(), nullptr, 0);\n\n  // Write if not already present.\n  auto basename = kj::str(hexEncode(hash), extension);\n  auto filename = kj::str(\"/var/www/images/\", basename);\n\n  if (access(filename.cStr(), F_OK) < 0) {\n    StagingFile file(\"/var/www/images\");\n    kj::FdOutputStream(file.getFd()).write(data.begin(), data.size());\n    file.finalize(filename);\n  }\n\n  return basename;\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::writeImage(kj::ArrayPtr<const byte> data, kj::StringPtr extension) {\n    // Hash the data to determine the filename.\n    byte hash[16];\n    crypto_generichash_blake2b(hash, sizeof(hash), data.begin(), data.size(), nullptr, 0);\n  \n    // Write if not already present.\n    auto basename = kj::str(hexEncode(hash), extension);\n    auto filename = kj::str(\"/var/www/images/\", basename);\n  \n    if (access(filename.cStr(), F_OK) < 0) {\n      StagingFile file(\"/var/www/images\");\n      kj::FdOutputStream(file.getFd()).write(data.begin(), data.size());\n      file.finalize(filename);\n    }\n  \n    return basename;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "screenshot.getJpeg",
          "args": [],
          "line": 444
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "screenshot.getJpeg",
          "args": [],
          "line": 444
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "screenshot.getPng",
          "args": [],
          "line": 441
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "screenshot.which",
          "args": [],
          "line": 439
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::writeScreenshot(spk::Metadata::Screenshot::Reader screenshot) {\n    switch (screenshot.which()) {\n      case spk::Metadata::Screenshot::PNG:\n        return writeImage(screenshot.getPng(), \".png\");\n  \n      case spk::Metadata::Screenshot::JPEG:\n        return writeImage(screenshot.getJpeg().asBytes(), \".jpeg\");\n  \n      case spk::Metadata::Screenshot::UNKNOWN:\n        break;\n    }\n  \n    KJ_FAIL_ASSERT(\"unknown screenshot type\", (uint)screenshot.which());\n  }\n}"
  },
  {
    "function_name": "writeIcon",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "421-436",
    "snippet": "kj::String Indexer::writeIcon(spk::Metadata::Icon::Reader icon) {\n  switch (icon.which()) {\n    case spk::Metadata::Icon::SVG:\n      return writeImage(icon.getSvg().asBytes(), \".svg\");\n\n    case spk::Metadata::Icon::PNG: {\n      auto png = icon.getPng();\n      return writeImage(png.hasDpi2x() ? png.getDpi2x() : png.getDpi1x(), \".png\");\n    }\n\n    case spk::Metadata::Icon::UNKNOWN:\n      break;\n  }\n\n  KJ_FAIL_ASSERT(\"unknown icon type\", (uint)icon.which());\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_FAIL_ASSERT",
          "args": [
            "\"unknown icon type\"",
            "(uint)icon.which()"
          ],
          "line": 435
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "icon.which",
          "args": [],
          "line": 435
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "writeImage",
          "args": [
            "png.hasDpi2x() ? png.getDpi2x() : png.getDpi1x()",
            "\".png\""
          ],
          "line": 428
        },
        "resolved": true,
        "details": {
          "function_name": "writeImage",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "453-469",
          "snippet": "kj::String Indexer::writeImage(kj::ArrayPtr<const byte> data, kj::StringPtr extension) {\n  // Hash the data to determine the filename.\n  byte hash[16];\n  crypto_generichash_blake2b(hash, sizeof(hash), data.begin(), data.size(), nullptr, 0);\n\n  // Write if not already present.\n  auto basename = kj::str(hexEncode(hash), extension);\n  auto filename = kj::str(\"/var/www/images/\", basename);\n\n  if (access(filename.cStr(), F_OK) < 0) {\n    StagingFile file(\"/var/www/images\");\n    kj::FdOutputStream(file.getFd()).write(data.begin(), data.size());\n    file.finalize(filename);\n  }\n\n  return basename;\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::writeImage(kj::ArrayPtr<const byte> data, kj::StringPtr extension) {\n    // Hash the data to determine the filename.\n    byte hash[16];\n    crypto_generichash_blake2b(hash, sizeof(hash), data.begin(), data.size(), nullptr, 0);\n  \n    // Write if not already present.\n    auto basename = kj::str(hexEncode(hash), extension);\n    auto filename = kj::str(\"/var/www/images/\", basename);\n  \n    if (access(filename.cStr(), F_OK) < 0) {\n      StagingFile file(\"/var/www/images\");\n      kj::FdOutputStream(file.getFd()).write(data.begin(), data.size());\n      file.finalize(filename);\n    }\n  \n    return basename;\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "png.getDpi1x",
          "args": [],
          "line": 428
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "png.getDpi2x",
          "args": [],
          "line": 428
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "png.hasDpi2x",
          "args": [],
          "line": 428
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "icon.getPng",
          "args": [],
          "line": 427
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "icon.getSvg",
          "args": [],
          "line": 424
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "icon.getSvg",
          "args": [],
          "line": 424
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "icon.which",
          "args": [],
          "line": 422
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::writeIcon(spk::Metadata::Icon::Reader icon) {\n    switch (icon.which()) {\n      case spk::Metadata::Icon::SVG:\n        return writeImage(icon.getSvg().asBytes(), \".svg\");\n  \n      case spk::Metadata::Icon::PNG: {\n        auto png = icon.getPng();\n        return writeImage(png.hasDpi2x() ? png.getDpi2x() : png.getDpi1x(), \".png\");\n      }\n  \n      case spk::Metadata::Icon::UNKNOWN:\n        break;\n    }\n  \n    KJ_FAIL_ASSERT(\"unknown icon type\", (uint)icon.which());\n  }\n}"
  },
  {
    "function_name": "updateIndex",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "416-419",
    "snippet": "void Indexer::updateIndex() {\n  updateIndexInternal(\"/var/www/apps\", false);\n  updateIndexInternal(\"/var/www/experimental\", true);\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "updateIndexInternal",
          "args": [
            "\"/var/www/experimental\"",
            "true"
          ],
          "line": 418
        },
        "resolved": true,
        "details": {
          "function_name": "updateIndexInternal",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "213-414",
          "snippet": "void Indexer::updateIndexInternal(kj::StringPtr outputDir, bool experimental) {\n  capnp::MallocMessageBuilder scratch;\n  auto orphanage = scratch.getOrphanage();\n\n  struct AppEntry {\n    kj::String appId;\n    uint version = 0;\n    capnp::Orphan<AppIndexForMarket::App> summary;\n    capnp::Orphan<AppDetailsForMarket> details;\n  };\n  std::map<kj::StringPtr, AppEntry> appMap;\n\n  for (auto& packageId: listDirectory(\"/var/packages\")) {\n    KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n      auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n      auto metadataFile = kj::str(\"/var/packages/\", packageId, \"/metadata\");\n      auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n\n      KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n\n      capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n      auto status = statusMessage.getRoot<SubmissionStatus>();\n      auto include = experimental ? status.isPending() : status.isApproved();\n      if (include && status.getRequestState() == SubmissionState::PUBLISH) {\n        capnp::StreamFdMessageReader metadataMessage(raiiOpen(metadataFile, O_RDONLY));\n        auto info = metadataMessage.getRoot<spk::VerifiedInfo>();\n        auto metadata = info.getMetadata();\n\n        // Hard-link spk. Note that we intentionally continue to publish outdated SPKs unless\n        // the author un-publishes them.\n        auto spkLinkName = kj::str(\"/var/www/packages/\", packageId);\n        while (link(spkFile.cStr(), spkLinkName.cStr()) < 0) {\n          int error = errno;\n          if (error == EEXIST) {\n            // Already linked.\n            break;\n          } else if (error != EINTR) {\n            KJ_FAIL_SYSCALL(\"link(spkFile, spkLinkName)\", error, spkFile, spkLinkName);\n          }\n        }\n\n        // Update entry.\n        auto appId = appIdString(info.getAppId());\n        auto iter = appMap.find(appId);\n        if (iter == appMap.end() || info.getVersion() >= iter->second.version) {\n          auto summaryOrphan = orphanage.newOrphan<AppIndexForMarket::App>();\n          auto summary = summaryOrphan.get();\n          auto detailsOrphan = orphanage.newOrphan<AppDetailsForMarket>();\n          auto details = detailsOrphan.get();\n\n          summary.setAppId(info.getAppId());\n          summary.setName(info.getTitle().getDefaultText());\n          summary.setVersion(info.getMarketingVersion().getDefaultText());\n          summary.setVersionNumber(info.getVersion());\n          summary.setPackageId(info.getPackageId());\n\n          auto icons = metadata.getIcons();\n\n          if (icons.hasMarket() || icons.hasAppGrid()) {\n            summary.setImageId(writeIcon(\n                icons.hasMarket() ? icons.getMarket() : icons.getAppGrid()));\n          }\n\n          if (metadata.hasWebsite()) summary.setWebLink(metadata.getWebsite());\n          if (metadata.hasCodeUrl()) summary.setCodeLink(metadata.getCodeUrl());\n\n          summary.setIsOpenSource(metadata.getLicense().isOpenSource());\n          summary.setCategories(KJ_MAP(c, metadata.getCategories()) { return categoryName(c); });\n\n          if (info.hasAuthorPgpKeyFingerprint()) {\n            KJ_IF_MAYBE(fd, raiiOpenIfExists(\n                kj::str(\"/var/keybase/\", info.getAuthorPgpKeyFingerprint()), O_RDONLY)) {\n              capnp::StreamFdMessageReader reader(fd->get());\n              auto keybase = reader.getRoot<KeybaseIdentity>();\n              auto author = summary.initAuthor();\n              author.setName(keybase.getName());\n              author.setKeybaseUsername(keybase.getKeybaseHandle());\n              if (keybase.hasPicture()) author.setPicture(keybase.getPicture());\n\n              auto github = keybase.getGithubHandles();\n              if (github.size() > 0) author.setGithubUsername(github[0]);\n              auto twitter = keybase.getTwitterHandles();\n              if (twitter.size() > 0) author.setTwitterUsername(twitter[0]);\n              auto hackernews = keybase.getHackernewsHandles();\n              if (hackernews.size() > 0) author.setHackernewsUsername(hackernews[0]);\n              auto reddit = keybase.getRedditHandles();\n              if (reddit.size() > 0) author.setRedditUsername(reddit[0]);\n            }\n          }\n\n          auto author = metadata.getAuthor();\n          if (author.hasUpstreamAuthor()) {\n            summary.setUpstreamAuthor(author.getUpstreamAuthor());\n          }\n\n          // TODO(soon): Additional HTML sanitization? Client should be doing that already...\n          summary.setShortDescription(metadata.getShortDescription().getDefaultText());\n          details.setDescription(metadata.getDescription().getDefaultText());\n\n          auto screenshots = metadata.getScreenshots();\n          auto screenshotsOut = details.initScreenshots(screenshots.size());\n          for (auto i: kj::indices(screenshots)) {\n            auto screenshot = screenshots[i];\n            auto screenshotOut = screenshotsOut[i];\n            screenshotOut.setImageId(writeScreenshot(screenshot));\n            screenshotOut.setWidth(screenshot.getWidth());\n            screenshotOut.setHeight(screenshot.getHeight());\n          }\n\n          auto license = metadata.getLicense();\n          switch (license.which()) {\n            case spk::Metadata::License::NONE:\n              break;\n            case spk::Metadata::License::OPEN_SOURCE: {\n              auto osiLicenses = capnp::Schema::from<spk::OpenSourceLicense>().getEnumerants();\n              auto licenseId = static_cast<uint>(license.getOpenSource());\n              if (licenseId < osiLicenses.size()) {\n                for (auto annotation: osiLicenses[licenseId].getProto().getAnnotations()) {\n                  if (annotation.getId() == 0x9476412d0315d869ull) {\n                    details.setLicense(\n                        annotation.getValue().getStruct().getAs<spk::OsiLicenseInfo>().getTitle());\n                    break;\n                    // The first person to submit a pull request removing this comment will receive\n                    // a free Sandstorm t-shirt. Yes, really. Sandstorm employees are not eligible,\n                    // but should still mention to Kenton that they saw this.\n                  }\n                }\n              }\n              break;\n            }\n            case spk::Metadata::License::PROPRIETARY:\n              details.setLicense(\"Proprietary\");\n              break;\n            case spk::Metadata::License::PUBLIC_DOMAIN:\n              details.setLicense(\"Public Domain\");\n              break;\n          }\n\n          time_t publishTime = status.getPublishDate();\n          char timeStr[32];\n          KJ_ASSERT(strftime(timeStr, sizeof(timeStr), \"%FT%TZ\", gmtime(&publishTime)) > 0);\n          summary.setCreatedAt(timeStr);\n\n          kj::String appIdCopy = kj::str(appId);\n          auto& slot = appMap[appIdCopy];\n          if (slot.appId == nullptr) slot.appId = kj::mv(appIdCopy);\n          slot.version = info.getVersion();\n          slot.summary = kj::mv(summaryOrphan);\n          slot.details = kj::mv(detailsOrphan);\n        }\n      }\n    })) {\n      KJ_LOG(ERROR, \"error processing package\", packageId, *exception);\n    }\n  }\n\n  KJ_IF_MAYBE(descriptionsFd, raiiOpenIfExists(\"/var/descriptions\", O_RDONLY)) {\n    capnp::StreamFdMessageReader reader(kj::mv(*descriptionsFd));\n    for (auto override: reader.getRoot<ShortDescriptionOverrides>().getItems()) {\n      auto iter = appMap.find(override.getAppId());\n      if (iter != appMap.end()) {\n        iter->second.summary.get().setShortDescription(override.getShortDescription());\n      }\n    }\n  }\n\n  AppIdJsonHandler appIdHandler;\n  PackageIdJsonHandler packageIdHandler;\n  capnp::JsonCodec json;\n  json.addTypeHandler(appIdHandler);\n  json.addTypeHandler(packageIdHandler);\n\n  capnp::MallocMessageBuilder indexMessage;\n  auto indexData = indexMessage.initRoot<AppIndexForMarket>();\n  auto apps = indexData.initApps(appMap.size());\n  uint i = 0;\n  for (auto& appEntry: appMap) {\n    apps.setWithCaveats(i++, appEntry.second.summary.getReader());\n\n    auto text = json.encode(appEntry.second.details.getReader());\n    StagingFile file(outputDir);\n    kj::FdOutputStream(file.getFd()).write(text.begin(), text.size());\n    file.finalize(kj::str(outputDir, \"/\", appEntry.first, \".json\"));\n\n    if (!experimental) {\n      // Write the symlink under /var/apps.\n      auto target = kj::str(\"../packages/\",\n          packageIdString(appEntry.second.summary.getReader().getPackageId()));\n      auto linkPath = kj::str(\"/var/apps/\", appEntry.first);\n      auto tmpLinkPath = kj::str(linkPath, \".tmp\");\n      unlink(tmpLinkPath.cStr());  // just in case\n      KJ_SYSCALL(symlink(target.cStr(), tmpLinkPath.cStr()));\n      KJ_SYSCALL(rename(tmpLinkPath.cStr(), linkPath.cStr()));\n    }\n  }\n  KJ_ASSERT(i == apps.size());\n\n  auto text = json.encode(indexData);\n  StagingFile file(outputDir);\n  kj::FdOutputStream(file.getFd()).write(text.begin(), text.size());\n  file.finalize(kj::str(outputDir, \"/index.json\"));\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::updateIndexInternal(kj::StringPtr outputDir, bool experimental) {\n    capnp::MallocMessageBuilder scratch;\n    auto orphanage = scratch.getOrphanage();\n  \n    struct AppEntry {\n      kj::String appId;\n      uint version = 0;\n      capnp::Orphan<AppIndexForMarket::App> summary;\n      capnp::Orphan<AppDetailsForMarket> details;\n    };\n    std::map<kj::StringPtr, AppEntry> appMap;\n  \n    for (auto& packageId: listDirectory(\"/var/packages\")) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n        auto metadataFile = kj::str(\"/var/packages/\", packageId, \"/metadata\");\n        auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n  \n        KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n  \n        capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n        auto status = statusMessage.getRoot<SubmissionStatus>();\n        auto include = experimental ? status.isPending() : status.isApproved();\n        if (include && status.getRequestState() == SubmissionState::PUBLISH) {\n          capnp::StreamFdMessageReader metadataMessage(raiiOpen(metadataFile, O_RDONLY));\n          auto info = metadataMessage.getRoot<spk::VerifiedInfo>();\n          auto metadata = info.getMetadata();\n  \n          // Hard-link spk. Note that we intentionally continue to publish outdated SPKs unless\n          // the author un-publishes them.\n          auto spkLinkName = kj::str(\"/var/www/packages/\", packageId);\n          while (link(spkFile.cStr(), spkLinkName.cStr()) < 0) {\n            int error = errno;\n            if (error == EEXIST) {\n              // Already linked.\n              break;\n            } else if (error != EINTR) {\n              KJ_FAIL_SYSCALL(\"link(spkFile, spkLinkName)\", error, spkFile, spkLinkName);\n            }\n          }\n  \n          // Update entry.\n          auto appId = appIdString(info.getAppId());\n          auto iter = appMap.find(appId);\n          if (iter == appMap.end() || info.getVersion() >= iter->second.version) {\n            auto summaryOrphan = orphanage.newOrphan<AppIndexForMarket::App>();\n            auto summary = summaryOrphan.get();\n            auto detailsOrphan = orphanage.newOrphan<AppDetailsForMarket>();\n            auto details = detailsOrphan.get();\n  \n            summary.setAppId(info.getAppId());\n            summary.setName(info.getTitle().getDefaultText());\n            summary.setVersion(info.getMarketingVersion().getDefaultText());\n            summary.setVersionNumber(info.getVersion());\n            summary.setPackageId(info.getPackageId());\n  \n            auto icons = metadata.getIcons();\n  \n            if (icons.hasMarket() || icons.hasAppGrid()) {\n              summary.setImageId(writeIcon(\n                  icons.hasMarket() ? icons.getMarket() : icons.getAppGrid()));\n            }\n  \n            if (metadata.hasWebsite()) summary.setWebLink(metadata.getWebsite());\n            if (metadata.hasCodeUrl()) summary.setCodeLink(metadata.getCodeUrl());\n  \n            summary.setIsOpenSource(metadata.getLicense().isOpenSource());\n            summary.setCategories(KJ_MAP(c, metadata.getCategories()) { return categoryName(c); });\n  \n            if (info.hasAuthorPgpKeyFingerprint()) {\n              KJ_IF_MAYBE(fd, raiiOpenIfExists(\n                  kj::str(\"/var/keybase/\", info.getAuthorPgpKeyFingerprint()), O_RDONLY)) {\n                capnp::StreamFdMessageReader reader(fd->get());\n                auto keybase = reader.getRoot<KeybaseIdentity>();\n                auto author = summary.initAuthor();\n                author.setName(keybase.getName());\n                author.setKeybaseUsername(keybase.getKeybaseHandle());\n                if (keybase.hasPicture()) author.setPicture(keybase.getPicture());\n  \n                auto github = keybase.getGithubHandles();\n                if (github.size() > 0) author.setGithubUsername(github[0]);\n                auto twitter = keybase.getTwitterHandles();\n                if (twitter.size() > 0) author.setTwitterUsername(twitter[0]);\n                auto hackernews = keybase.getHackernewsHandles();\n                if (hackernews.size() > 0) author.setHackernewsUsername(hackernews[0]);\n                auto reddit = keybase.getRedditHandles();\n                if (reddit.size() > 0) author.setRedditUsername(reddit[0]);\n              }\n            }\n  \n            auto author = metadata.getAuthor();\n            if (author.hasUpstreamAuthor()) {\n              summary.setUpstreamAuthor(author.getUpstreamAuthor());\n            }\n  \n            // TODO(soon): Additional HTML sanitization? Client should be doing that already...\n            summary.setShortDescription(metadata.getShortDescription().getDefaultText());\n            details.setDescription(metadata.getDescription().getDefaultText());\n  \n            auto screenshots = metadata.getScreenshots();\n            auto screenshotsOut = details.initScreenshots(screenshots.size());\n            for (auto i: kj::indices(screenshots)) {\n              auto screenshot = screenshots[i];\n              auto screenshotOut = screenshotsOut[i];\n              screenshotOut.setImageId(writeScreenshot(screenshot));\n              screenshotOut.setWidth(screenshot.getWidth());\n              screenshotOut.setHeight(screenshot.getHeight());\n            }\n  \n            auto license = metadata.getLicense();\n            switch (license.which()) {\n              case spk::Metadata::License::NONE:\n                break;\n              case spk::Metadata::License::OPEN_SOURCE: {\n                auto osiLicenses = capnp::Schema::from<spk::OpenSourceLicense>().getEnumerants();\n                auto licenseId = static_cast<uint>(license.getOpenSource());\n                if (licenseId < osiLicenses.size()) {\n                  for (auto annotation: osiLicenses[licenseId].getProto().getAnnotations()) {\n                    if (annotation.getId() == 0x9476412d0315d869ull) {\n                      details.setLicense(\n                          annotation.getValue().getStruct().getAs<spk::OsiLicenseInfo>().getTitle());\n                      break;\n                      // The first person to submit a pull request removing this comment will receive\n                      // a free Sandstorm t-shirt. Yes, really. Sandstorm employees are not eligible,\n                      // but should still mention to Kenton that they saw this.\n                    }\n                  }\n                }\n                break;\n              }\n              case spk::Metadata::License::PROPRIETARY:\n                details.setLicense(\"Proprietary\");\n                break;\n              case spk::Metadata::License::PUBLIC_DOMAIN:\n                details.setLicense(\"Public Domain\");\n                break;\n            }\n  \n            time_t publishTime = status.getPublishDate();\n            char timeStr[32];\n            KJ_ASSERT(strftime(timeStr, sizeof(timeStr), \"%FT%TZ\", gmtime(&publishTime)) > 0);\n            summary.setCreatedAt(timeStr);\n  \n            kj::String appIdCopy = kj::str(appId);\n            auto& slot = appMap[appIdCopy];\n            if (slot.appId == nullptr) slot.appId = kj::mv(appIdCopy);\n            slot.version = info.getVersion();\n            slot.summary = kj::mv(summaryOrphan);\n            slot.details = kj::mv(detailsOrphan);\n          }\n        }\n      })) {\n        KJ_LOG(ERROR, \"error processing package\", packageId, *exception);\n      }\n    }\n  \n    KJ_IF_MAYBE(descriptionsFd, raiiOpenIfExists(\"/var/descriptions\", O_RDONLY)) {\n      capnp::StreamFdMessageReader reader(kj::mv(*descriptionsFd));\n      for (auto override: reader.getRoot<ShortDescriptionOverrides>().getItems()) {\n        auto iter = appMap.find(override.getAppId());\n        if (iter != appMap.end()) {\n          iter->second.summary.get().setShortDescription(override.getShortDescription());\n        }\n      }\n    }\n  \n    AppIdJsonHandler appIdHandler;\n    PackageIdJsonHandler packageIdHandler;\n    capnp::JsonCodec json;\n    json.addTypeHandler(appIdHandler);\n    json.addTypeHandler(packageIdHandler);\n  \n    capnp::MallocMessageBuilder indexMessage;\n    auto indexData = indexMessage.initRoot<AppIndexForMarket>();\n    auto apps = indexData.initApps(appMap.size());\n    uint i = 0;\n    for (auto& appEntry: appMap) {\n      apps.setWithCaveats(i++, appEntry.second.summary.getReader());\n  \n      auto text = json.encode(appEntry.second.details.getReader());\n      StagingFile file(outputDir);\n      kj::FdOutputStream(file.getFd()).write(text.begin(), text.size());\n      file.finalize(kj::str(outputDir, \"/\", appEntry.first, \".json\"));\n  \n      if (!experimental) {\n        // Write the symlink under /var/apps.\n        auto target = kj::str(\"../packages/\",\n            packageIdString(appEntry.second.summary.getReader().getPackageId()));\n        auto linkPath = kj::str(\"/var/apps/\", appEntry.first);\n        auto tmpLinkPath = kj::str(linkPath, \".tmp\");\n        unlink(tmpLinkPath.cStr());  // just in case\n        KJ_SYSCALL(symlink(target.cStr(), tmpLinkPath.cStr()));\n        KJ_SYSCALL(rename(tmpLinkPath.cStr(), linkPath.cStr()));\n      }\n    }\n    KJ_ASSERT(i == apps.size());\n  \n    auto text = json.encode(indexData);\n    StagingFile file(outputDir);\n    kj::FdOutputStream(file.getFd()).write(text.begin(), text.size());\n    file.finalize(kj::str(outputDir, \"/index.json\"));\n  }\n}"
        }
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::updateIndex() {\n    updateIndexInternal(\"/var/www/apps\", false);\n    updateIndexInternal(\"/var/www/experimental\", true);\n  }\n}"
  },
  {
    "function_name": "updateIndexInternal",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "213-414",
    "snippet": "void Indexer::updateIndexInternal(kj::StringPtr outputDir, bool experimental) {\n  capnp::MallocMessageBuilder scratch;\n  auto orphanage = scratch.getOrphanage();\n\n  struct AppEntry {\n    kj::String appId;\n    uint version = 0;\n    capnp::Orphan<AppIndexForMarket::App> summary;\n    capnp::Orphan<AppDetailsForMarket> details;\n  };\n  std::map<kj::StringPtr, AppEntry> appMap;\n\n  for (auto& packageId: listDirectory(\"/var/packages\")) {\n    KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n      auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n      auto metadataFile = kj::str(\"/var/packages/\", packageId, \"/metadata\");\n      auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n\n      KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n\n      capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n      auto status = statusMessage.getRoot<SubmissionStatus>();\n      auto include = experimental ? status.isPending() : status.isApproved();\n      if (include && status.getRequestState() == SubmissionState::PUBLISH) {\n        capnp::StreamFdMessageReader metadataMessage(raiiOpen(metadataFile, O_RDONLY));\n        auto info = metadataMessage.getRoot<spk::VerifiedInfo>();\n        auto metadata = info.getMetadata();\n\n        // Hard-link spk. Note that we intentionally continue to publish outdated SPKs unless\n        // the author un-publishes them.\n        auto spkLinkName = kj::str(\"/var/www/packages/\", packageId);\n        while (link(spkFile.cStr(), spkLinkName.cStr()) < 0) {\n          int error = errno;\n          if (error == EEXIST) {\n            // Already linked.\n            break;\n          } else if (error != EINTR) {\n            KJ_FAIL_SYSCALL(\"link(spkFile, spkLinkName)\", error, spkFile, spkLinkName);\n          }\n        }\n\n        // Update entry.\n        auto appId = appIdString(info.getAppId());\n        auto iter = appMap.find(appId);\n        if (iter == appMap.end() || info.getVersion() >= iter->second.version) {\n          auto summaryOrphan = orphanage.newOrphan<AppIndexForMarket::App>();\n          auto summary = summaryOrphan.get();\n          auto detailsOrphan = orphanage.newOrphan<AppDetailsForMarket>();\n          auto details = detailsOrphan.get();\n\n          summary.setAppId(info.getAppId());\n          summary.setName(info.getTitle().getDefaultText());\n          summary.setVersion(info.getMarketingVersion().getDefaultText());\n          summary.setVersionNumber(info.getVersion());\n          summary.setPackageId(info.getPackageId());\n\n          auto icons = metadata.getIcons();\n\n          if (icons.hasMarket() || icons.hasAppGrid()) {\n            summary.setImageId(writeIcon(\n                icons.hasMarket() ? icons.getMarket() : icons.getAppGrid()));\n          }\n\n          if (metadata.hasWebsite()) summary.setWebLink(metadata.getWebsite());\n          if (metadata.hasCodeUrl()) summary.setCodeLink(metadata.getCodeUrl());\n\n          summary.setIsOpenSource(metadata.getLicense().isOpenSource());\n          summary.setCategories(KJ_MAP(c, metadata.getCategories()) { return categoryName(c); });\n\n          if (info.hasAuthorPgpKeyFingerprint()) {\n            KJ_IF_MAYBE(fd, raiiOpenIfExists(\n                kj::str(\"/var/keybase/\", info.getAuthorPgpKeyFingerprint()), O_RDONLY)) {\n              capnp::StreamFdMessageReader reader(fd->get());\n              auto keybase = reader.getRoot<KeybaseIdentity>();\n              auto author = summary.initAuthor();\n              author.setName(keybase.getName());\n              author.setKeybaseUsername(keybase.getKeybaseHandle());\n              if (keybase.hasPicture()) author.setPicture(keybase.getPicture());\n\n              auto github = keybase.getGithubHandles();\n              if (github.size() > 0) author.setGithubUsername(github[0]);\n              auto twitter = keybase.getTwitterHandles();\n              if (twitter.size() > 0) author.setTwitterUsername(twitter[0]);\n              auto hackernews = keybase.getHackernewsHandles();\n              if (hackernews.size() > 0) author.setHackernewsUsername(hackernews[0]);\n              auto reddit = keybase.getRedditHandles();\n              if (reddit.size() > 0) author.setRedditUsername(reddit[0]);\n            }\n          }\n\n          auto author = metadata.getAuthor();\n          if (author.hasUpstreamAuthor()) {\n            summary.setUpstreamAuthor(author.getUpstreamAuthor());\n          }\n\n          // TODO(soon): Additional HTML sanitization? Client should be doing that already...\n          summary.setShortDescription(metadata.getShortDescription().getDefaultText());\n          details.setDescription(metadata.getDescription().getDefaultText());\n\n          auto screenshots = metadata.getScreenshots();\n          auto screenshotsOut = details.initScreenshots(screenshots.size());\n          for (auto i: kj::indices(screenshots)) {\n            auto screenshot = screenshots[i];\n            auto screenshotOut = screenshotsOut[i];\n            screenshotOut.setImageId(writeScreenshot(screenshot));\n            screenshotOut.setWidth(screenshot.getWidth());\n            screenshotOut.setHeight(screenshot.getHeight());\n          }\n\n          auto license = metadata.getLicense();\n          switch (license.which()) {\n            case spk::Metadata::License::NONE:\n              break;\n            case spk::Metadata::License::OPEN_SOURCE: {\n              auto osiLicenses = capnp::Schema::from<spk::OpenSourceLicense>().getEnumerants();\n              auto licenseId = static_cast<uint>(license.getOpenSource());\n              if (licenseId < osiLicenses.size()) {\n                for (auto annotation: osiLicenses[licenseId].getProto().getAnnotations()) {\n                  if (annotation.getId() == 0x9476412d0315d869ull) {\n                    details.setLicense(\n                        annotation.getValue().getStruct().getAs<spk::OsiLicenseInfo>().getTitle());\n                    break;\n                    // The first person to submit a pull request removing this comment will receive\n                    // a free Sandstorm t-shirt. Yes, really. Sandstorm employees are not eligible,\n                    // but should still mention to Kenton that they saw this.\n                  }\n                }\n              }\n              break;\n            }\n            case spk::Metadata::License::PROPRIETARY:\n              details.setLicense(\"Proprietary\");\n              break;\n            case spk::Metadata::License::PUBLIC_DOMAIN:\n              details.setLicense(\"Public Domain\");\n              break;\n          }\n\n          time_t publishTime = status.getPublishDate();\n          char timeStr[32];\n          KJ_ASSERT(strftime(timeStr, sizeof(timeStr), \"%FT%TZ\", gmtime(&publishTime)) > 0);\n          summary.setCreatedAt(timeStr);\n\n          kj::String appIdCopy = kj::str(appId);\n          auto& slot = appMap[appIdCopy];\n          if (slot.appId == nullptr) slot.appId = kj::mv(appIdCopy);\n          slot.version = info.getVersion();\n          slot.summary = kj::mv(summaryOrphan);\n          slot.details = kj::mv(detailsOrphan);\n        }\n      }\n    })) {\n      KJ_LOG(ERROR, \"error processing package\", packageId, *exception);\n    }\n  }\n\n  KJ_IF_MAYBE(descriptionsFd, raiiOpenIfExists(\"/var/descriptions\", O_RDONLY)) {\n    capnp::StreamFdMessageReader reader(kj::mv(*descriptionsFd));\n    for (auto override: reader.getRoot<ShortDescriptionOverrides>().getItems()) {\n      auto iter = appMap.find(override.getAppId());\n      if (iter != appMap.end()) {\n        iter->second.summary.get().setShortDescription(override.getShortDescription());\n      }\n    }\n  }\n\n  AppIdJsonHandler appIdHandler;\n  PackageIdJsonHandler packageIdHandler;\n  capnp::JsonCodec json;\n  json.addTypeHandler(appIdHandler);\n  json.addTypeHandler(packageIdHandler);\n\n  capnp::MallocMessageBuilder indexMessage;\n  auto indexData = indexMessage.initRoot<AppIndexForMarket>();\n  auto apps = indexData.initApps(appMap.size());\n  uint i = 0;\n  for (auto& appEntry: appMap) {\n    apps.setWithCaveats(i++, appEntry.second.summary.getReader());\n\n    auto text = json.encode(appEntry.second.details.getReader());\n    StagingFile file(outputDir);\n    kj::FdOutputStream(file.getFd()).write(text.begin(), text.size());\n    file.finalize(kj::str(outputDir, \"/\", appEntry.first, \".json\"));\n\n    if (!experimental) {\n      // Write the symlink under /var/apps.\n      auto target = kj::str(\"../packages/\",\n          packageIdString(appEntry.second.summary.getReader().getPackageId()));\n      auto linkPath = kj::str(\"/var/apps/\", appEntry.first);\n      auto tmpLinkPath = kj::str(linkPath, \".tmp\");\n      unlink(tmpLinkPath.cStr());  // just in case\n      KJ_SYSCALL(symlink(target.cStr(), tmpLinkPath.cStr()));\n      KJ_SYSCALL(rename(tmpLinkPath.cStr(), linkPath.cStr()));\n    }\n  }\n  KJ_ASSERT(i == apps.size());\n\n  auto text = json.encode(indexData);\n  StagingFile file(outputDir);\n  kj::FdOutputStream(file.getFd()).write(text.begin(), text.size());\n  file.finalize(kj::str(outputDir, \"/index.json\"));\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "file.finalize",
          "args": [
            "kj::str(outputDir, \"/index.json\")"
          ],
          "line": 413
        },
        "resolved": true,
        "details": {
          "function_name": "finalize",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "55-60",
          "snippet": "void finalize(kj::StringPtr path) {\n    KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n    KJ_SYSCALL(fsync(fd));\n    KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n    finalized = true;\n  }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  void finalize(kj::StringPtr path) {\n      KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n      KJ_SYSCALL(fsync(fd));\n      KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n      finalized = true;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "outputDir",
            "\"/index.json\""
          ],
          "line": 413
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "text.begin()",
            "text.size()"
          ],
          "line": 412
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "text.size",
          "args": [],
          "line": 412
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "text.begin",
          "args": [],
          "line": 412
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "file.getFd()"
          ],
          "line": 412
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "file.getFd",
          "args": [],
          "line": 412
        },
        "resolved": true,
        "details": {
          "function_name": "getFd",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "62-62",
          "snippet": "int getFd() { return fd; }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  int getFd() { return fd; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "json.encode",
          "args": [
            "indexData"
          ],
          "line": 410
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "i == apps.size()"
          ],
          "line": 408
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "rename(tmpLinkPath.cStr(), linkPath.cStr())"
          ],
          "line": 405
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rename",
          "args": [
            "tmpLinkPath.cStr()",
            "linkPath.cStr()"
          ],
          "line": 405
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "linkPath.cStr",
          "args": [],
          "line": 405
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "tmpLinkPath.cStr",
          "args": [],
          "line": 405
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "symlink(target.cStr(), tmpLinkPath.cStr())"
          ],
          "line": 404
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "symlink",
          "args": [
            "target.cStr()",
            "tmpLinkPath.cStr()"
          ],
          "line": 404
        },
        "resolved": true,
        "details": {
          "function_name": "symlinkPointsInto",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/run-bundle.c++",
          "lines": "101-124",
          "snippet": "static bool symlinkPointsInto(kj::StringPtr symlink, kj::StringPtr targetPrefix) {\n  // Returns true if the given path names a symlink whose target has the given prefix, false if\n  // it points elsewhere or doesn't exist or isn't a symlink.\nretry:\n  char buffer[PATH_MAX];\n  ssize_t n = readlink(symlink.cStr(), buffer, sizeof(buffer) - 1);\n  if (n < 0) {\n    int error = errno;\n    switch (error) {\n      case ENOENT:\n      case ENOTDIR:\n      case EINVAL:\n        // File (or parent directory) dosen't exist or isn't a symlink.\n        return false;\n      case EINTR:\n        goto retry;\n      default:\n        KJ_FAIL_SYSCALL(\"readlink(symlink)\", error, symlink);\n    }\n  } else {\n    buffer[n] = '\\0';\n    return kj::StringPtr(buffer, n).startsWith(targetPrefix);\n  }\n}",
          "includes": [
            "#include \"backup.h\"",
            "#include \"backend.h\"",
            "#include \"spk.h\"",
            "#include \"util.h\"",
            "#include \"supervisor.h\"",
            "#include \"send-fd.h\"",
            "#include \"version.h\"",
            "#include <arpa/inet.h>",
            "#include <dirent.h>",
            "#include <netdb.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdio.h>  // rename()",
            "#include <time.h>",
            "#include <ctype.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <grp.h>",
            "#include <sched.h>",
            "#include <linux/securebits.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/eventfd.h>",
            "#include <sys/capability.h>",
            "#include <sys/utsname.h>",
            "#include <sys/syscall.h>",
            "#include <sys/prctl.h>",
            "#include <sys/sendfile.h>",
            "#include <sys/wait.h>",
            "#include <sys/signalfd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <sys/mount.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <signal.h>",
            "#include <stdlib.h>",
            "#include <sodium/crypto_sign_ed25519.h>",
            "#include <sodium/randombytes.h>",
            "#include <sandstorm/update-tool.capnp.h>",
            "#include <sandstorm/package.capnp.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/dynamic.h>",
            "#include <capnp/schema.h>",
            "#include <kj/parse/char.h>",
            "#include <kj/parse/common.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"backup.h\"\n#include \"backend.h\"\n#include \"spk.h\"\n#include \"util.h\"\n#include \"supervisor.h\"\n#include \"send-fd.h\"\n#include \"version.h\"\n#include <arpa/inet.h>\n#include <dirent.h>\n#include <netdb.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdio.h>  // rename()\n#include <time.h>\n#include <ctype.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <grp.h>\n#include <sched.h>\n#include <linux/securebits.h>\n#include <sys/ioctl.h>\n#include <sys/eventfd.h>\n#include <sys/capability.h>\n#include <sys/utsname.h>\n#include <sys/syscall.h>\n#include <sys/prctl.h>\n#include <sys/sendfile.h>\n#include <sys/wait.h>\n#include <sys/signalfd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <sys/mount.h>\n#include <unistd.h>\n#include <limits.h>\n#include <signal.h>\n#include <stdlib.h>\n#include <sodium/crypto_sign_ed25519.h>\n#include <sodium/randombytes.h>\n#include <sandstorm/update-tool.capnp.h>\n#include <sandstorm/package.capnp.h>\n#include <capnp/compat/json.h>\n#include <capnp/serialize.h>\n#include <capnp/dynamic.h>\n#include <capnp/schema.h>\n#include <kj/parse/char.h>\n#include <kj/parse/common.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nstatic bool symlinkPointsInto(kj::StringPtr symlink, kj::StringPtr targetPrefix) {\n  // Returns true if the given path names a symlink whose target has the given prefix, false if\n  // it points elsewhere or doesn't exist or isn't a symlink.\nretry:\n  char buffer[PATH_MAX];\n  ssize_t n = readlink(symlink.cStr(), buffer, sizeof(buffer) - 1);\n  if (n < 0) {\n    int error = errno;\n    switch (error) {\n      case ENOENT:\n      case ENOTDIR:\n      case EINVAL:\n        // File (or parent directory) dosen't exist or isn't a symlink.\n        return false;\n      case EINTR:\n        goto retry;\n      default:\n        KJ_FAIL_SYSCALL(\"readlink(symlink)\", error, symlink);\n    }\n  } else {\n    buffer[n] = '\\0';\n    return kj::StringPtr(buffer, n).startsWith(targetPrefix);\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "tmpLinkPath.cStr",
          "args": [],
          "line": 404
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "target.cStr",
          "args": [],
          "line": 404
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "tmpLinkPath.cStr()"
          ],
          "line": 403
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "tmpLinkPath.cStr",
          "args": [],
          "line": 403
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "linkPath",
            "\".tmp\""
          ],
          "line": 402
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/apps/\"",
            "appEntry.first"
          ],
          "line": 401
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"../packages/\"",
            "packageIdString(appEntry.second.summary.getReader().getPackageId())"
          ],
          "line": 399
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "packageIdString",
          "args": [
            "appEntry.second.summary.getReader().getPackageId()"
          ],
          "line": 400
        },
        "resolved": true,
        "details": {
          "function_name": "packageIdString",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/id-to-text.c++",
          "lines": "189-192",
          "snippet": "kj::String packageIdString(kj::ArrayPtr<const kj::byte> packageId) {\n  KJ_ASSERT(packageId.size() == PACKAGE_ID_BYTE_SIZE);\n  return hexEncode(packageId);\n}",
          "includes": [
            "#include \"util.h\"",
            "#include \"id-to-text.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include \"id-to-text.h\"\n\nkj::String packageIdString(kj::ArrayPtr<const kj::byte> packageId) {\n  KJ_ASSERT(packageId.size() == PACKAGE_ID_BYTE_SIZE);\n  return hexEncode(packageId);\n}"
        }
      },
      {
        "call_info": {
          "callee": "appEntry.second.summary.getReader",
          "args": [],
          "line": 400
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "appEntry.second.summary.getReader",
          "args": [],
          "line": 400
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "outputDir",
            "\"/\"",
            "appEntry.first",
            "\".json\""
          ],
          "line": 395
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "text.begin()",
            "text.size()"
          ],
          "line": 394
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "text.begin",
          "args": [],
          "line": 394
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::FdOutputStream",
          "args": [
            "file.getFd()"
          ],
          "line": 394
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "json.encode",
          "args": [
            "appEntry.second.details.getReader()"
          ],
          "line": 392
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "appEntry.second.details.getReader",
          "args": [],
          "line": 392
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "apps.setWithCaveats",
          "args": [
            "i++",
            "appEntry.second.summary.getReader()"
          ],
          "line": 390
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "appEntry.second.summary.getReader",
          "args": [],
          "line": 390
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexData.initApps",
          "args": [
            "appMap.size()"
          ],
          "line": 387
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "indexMessage.initRoot<AppIndexForMarket>",
          "args": [],
          "line": 386
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "json.addTypeHandler",
          "args": [
            "packageIdHandler"
          ],
          "line": 383
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "json.addTypeHandler",
          "args": [
            "appIdHandler"
          ],
          "line": 382
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "iter->second.summary.get",
          "args": [
            "override.getShortDescription()"
          ],
          "line": 374
        },
        "resolved": true,
        "details": {
          "function_name": "get",
          "container": "ReviewSession",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/app-index.c++",
          "lines": "279-307",
          "snippet": "kj::Promise<void> get(GetContext context) override {\n    return kj::evalNow([&]() -> kj::Promise<void> {\n      auto path = context.getParams().getPath();\n      if (path == \"\") {\n        auto content = context.getResults().initContent();\n        content.setMimeType(\"text/html; charset=utf-8\");\n        content.initBody().setBytes(REVIEW_APP_HTML->asBytes());\n      } else if (path == \"queue\") {\n        auto content = context.getResults().initContent();\n        content.setMimeType(\"application/json\");\n        content.initBody().setBytes(indexer.getReviewQueueJson().asBytes());\n      } else if (path == \"public-id\") {\n        context.releaseParams();\n        return session.getPublicIdRequest().send().then([context](auto&& result) mutable {\n          auto content = context.getResults().initContent();\n          content.setMimeType(\"application/json\");\n          content.initBody().setBytes(capnp::JsonCodec().encode(result).asBytes());\n        });\n      } else {\n        auto error = context.getResults().initClientError();\n        error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n        error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n      }\n\n      return kj::READY_NOW;\n    }).catch_([context](kj::Exception&& e) mutable {\n      handleError(context, kj::mv(e));\n    });\n  }",
          "includes": [
            "#include \"indexer.h\"",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include <sandstorm/util.h>",
            "#include <sandstorm/hack-session.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <sandstorm/web-session.capnp.h>",
            "#include <sandstorm/grain.capnp.h>",
            "#include <map>",
            "#include <sodium/crypto_sign.h>",
            "#include <ctype.h>",
            "#include <errno.h>",
            "#include <dirent.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <fcntl.h>",
            "#include <stdio.h>",
            "#include <stdlib.h>",
            "#include <unistd.h>",
            "#include <capnp/compat/json.h>",
            "#include <capnp/membrane.h>",
            "#include <capnp/serialize-packed.h>",
            "#include <capnp/serialize.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async-io.h>",
            "#include <kj/io.h>",
            "#include <kj/debug.h>",
            "#include <kj/main.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"indexer.h\"\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include <sandstorm/util.h>\n#include <sandstorm/hack-session.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <sandstorm/web-session.capnp.h>\n#include <sandstorm/grain.capnp.h>\n#include <map>\n#include <sodium/crypto_sign.h>\n#include <ctype.h>\n#include <errno.h>\n#include <dirent.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <capnp/compat/json.h>\n#include <capnp/membrane.h>\n#include <capnp/serialize-packed.h>\n#include <capnp/serialize.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async-io.h>\n#include <kj/io.h>\n#include <kj/debug.h>\n#include <kj/main.h>\n\nReviewSession {\n  kj::Promise<void> get(GetContext context) override {\n      return kj::evalNow([&]() -> kj::Promise<void> {\n        auto path = context.getParams().getPath();\n        if (path == \"\") {\n          auto content = context.getResults().initContent();\n          content.setMimeType(\"text/html; charset=utf-8\");\n          content.initBody().setBytes(REVIEW_APP_HTML->asBytes());\n        } else if (path == \"queue\") {\n          auto content = context.getResults().initContent();\n          content.setMimeType(\"application/json\");\n          content.initBody().setBytes(indexer.getReviewQueueJson().asBytes());\n        } else if (path == \"public-id\") {\n          context.releaseParams();\n          return session.getPublicIdRequest().send().then([context](auto&& result) mutable {\n            auto content = context.getResults().initContent();\n            content.setMimeType(\"application/json\");\n            content.initBody().setBytes(capnp::JsonCodec().encode(result).asBytes());\n          });\n        } else {\n          auto error = context.getResults().initClientError();\n          error.setStatusCode(WebSession::Response::ClientErrorCode::NOT_FOUND);\n          error.setDescriptionHtml(\"<html><body><pre>404 not found</pre></body></html>\");\n        }\n  \n        return kj::READY_NOW;\n      }).catch_([context](kj::Exception&& e) mutable {\n        handleError(context, kj::mv(e));\n      });\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "override.getShortDescription",
          "args": [],
          "line": 374
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "iter->second.summary.get",
          "args": [],
          "line": 374
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "appMap.end",
          "args": [],
          "line": 373
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "appMap.find",
          "args": [
            "override.getAppId()"
          ],
          "line": 372
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "override.getAppId",
          "args": [],
          "line": 372
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reader.getRoot<ShortDescriptionOverrides>",
          "args": [],
          "line": 371
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reader.getRoot<ShortDescriptionOverrides>",
          "args": [],
          "line": 371
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "*descriptionsFd"
          ],
          "line": 370
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_IF_MAYBE",
          "args": [
            "descriptionsFd",
            "raiiOpenIfExists(\"/var/descriptions\", O_RDONLY)"
          ],
          "line": 369
        },
        "resolved": true,
        "details": {
          "function_name": "KJ_IF_MAYBE",
          "container": "BridgeProxy",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/bridge-proxy.c++",
          "lines": "144-150",
          "snippet": "KJ_IF_MAYBE(auth, headers.get(hAuthorization)) {\n      if (auth->startsWith(\"bearer \") || auth->startsWith(\"Bearer \")) {\n        auto token = auth->slice(strlen(\"bearer \"));\n        auto session = getHttpSession(token);\n        return dispatchToSession(kj::mv(session), method, url, headers, requestBody, response);\n      }\n    }",
          "includes": [
            "#include \"util.h\"",
            "#include <kj/debug.h>",
            "#include <capnp/compat/json.h>",
            "#include <sandstorm/bridge-proxy.capnp.h>",
            "#include <sandstorm/api-session.capnp.h>",
            "#include <map>",
            "#include \"bridge-proxy.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include <kj/debug.h>\n#include <capnp/compat/json.h>\n#include <sandstorm/bridge-proxy.capnp.h>\n#include <sandstorm/api-session.capnp.h>\n#include <map>\n#include \"bridge-proxy.h\"\n\nBridgeProxy {\n  KJ_IF_MAYBE(auth, headers.get(hAuthorization)) {\n        if (auth->startsWith(\"bearer \") || auth->startsWith(\"Bearer \")) {\n          auto token = auth->slice(strlen(\"bearer \"));\n          auto session = getHttpSession(token);\n          return dispatchToSession(kj::mv(session), method, url, headers, requestBody, response);\n        }\n      }\n}"
        }
      },
      {
        "call_info": {
          "callee": "raiiOpenIfExists",
          "args": [
            "\"/var/descriptions\"",
            "O_RDONLY"
          ],
          "line": 369
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_LOG",
          "args": [
            "ERROR",
            "\"error processing package\"",
            "packageId",
            "*exception"
          ],
          "line": 365
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::runCatchingExceptions",
          "args": [
            "[&]() {\n      auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n      auto metadataFile = kj::str(\"/var/packages/\", packageId, \"/metadata\");\n      auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n\n      KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n\n      capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n      auto status = statusMessage.getRoot<SubmissionStatus>();\n      auto include = experimental ? status.isPending() : status.isApproved();\n      if (include && status.getRequestState() == SubmissionState::PUBLISH) {\n        capnp::StreamFdMessageReader metadataMessage(raiiOpen(metadataFile, O_RDONLY));\n        auto info = metadataMessage.getRoot<spk::VerifiedInfo>();\n        auto metadata = info.getMetadata();\n\n        // Hard-link spk. Note that we intentionally continue to publish outdated SPKs unless\n        // the author un-publishes them.\n        auto spkLinkName = kj::str(\"/var/www/packages/\", packageId);\n        while (link(spkFile.cStr(), spkLinkName.cStr()) < 0) {\n          int error = errno;\n          if (error == EEXIST) {\n            // Already linked.\n            break;\n          } else if (error != EINTR) {\n            KJ_FAIL_SYSCALL(\"link(spkFile, spkLinkName)\", error, spkFile, spkLinkName);\n          }\n        }\n\n        // Update entry.\n        auto appId = appIdString(info.getAppId());\n        auto iter = appMap.find(appId);\n        if (iter == appMap.end() || info.getVersion() >= iter->second.version) {\n          auto summaryOrphan = orphanage.newOrphan<AppIndexForMarket::App>();\n          auto summary = summaryOrphan.get();\n          auto detailsOrphan = orphanage.newOrphan<AppDetailsForMarket>();\n          auto details = detailsOrphan.get();\n\n          summary.setAppId(info.getAppId());\n          summary.setName(info.getTitle().getDefaultText());\n          summary.setVersion(info.getMarketingVersion().getDefaultText());\n          summary.setVersionNumber(info.getVersion());\n          summary.setPackageId(info.getPackageId());\n\n          auto icons = metadata.getIcons();\n\n          if (icons.hasMarket() || icons.hasAppGrid()) {\n            summary.setImageId(writeIcon(\n                icons.hasMarket() ? icons.getMarket() : icons.getAppGrid()));\n          }\n\n          if (metadata.hasWebsite()) summary.setWebLink(metadata.getWebsite());\n          if (metadata.hasCodeUrl()) summary.setCodeLink(metadata.getCodeUrl());\n\n          summary.setIsOpenSource(metadata.getLicense().isOpenSource());\n          summary.setCategories(KJ_MAP(c, metadata.getCategories()) { return categoryName(c); });\n\n          if (info.hasAuthorPgpKeyFingerprint()) {\n            KJ_IF_MAYBE(fd, raiiOpenIfExists(\n                kj::str(\"/var/keybase/\", info.getAuthorPgpKeyFingerprint()), O_RDONLY)) {\n              capnp::StreamFdMessageReader reader(fd->get());\n              auto keybase = reader.getRoot<KeybaseIdentity>();\n              auto author = summary.initAuthor();\n              author.setName(keybase.getName());\n              author.setKeybaseUsername(keybase.getKeybaseHandle());\n              if (keybase.hasPicture()) author.setPicture(keybase.getPicture());\n\n              auto github = keybase.getGithubHandles();\n              if (github.size() > 0) author.setGithubUsername(github[0]);\n              auto twitter = keybase.getTwitterHandles();\n              if (twitter.size() > 0) author.setTwitterUsername(twitter[0]);\n              auto hackernews = keybase.getHackernewsHandles();\n              if (hackernews.size() > 0) author.setHackernewsUsername(hackernews[0]);\n              auto reddit = keybase.getRedditHandles();\n              if (reddit.size() > 0) author.setRedditUsername(reddit[0]);\n            }\n          }\n\n          auto author = metadata.getAuthor();\n          if (author.hasUpstreamAuthor()) {\n            summary.setUpstreamAuthor(author.getUpstreamAuthor());\n          }\n\n          // TODO(soon): Additional HTML sanitization? Client should be doing that already...\n          summary.setShortDescription(metadata.getShortDescription().getDefaultText());\n          details.setDescription(metadata.getDescription().getDefaultText());\n\n          auto screenshots = metadata.getScreenshots();\n          auto screenshotsOut = details.initScreenshots(screenshots.size());\n          for (auto i: kj::indices(screenshots)) {\n            auto screenshot = screenshots[i];\n            auto screenshotOut = screenshotsOut[i];\n            screenshotOut.setImageId(writeScreenshot(screenshot));\n            screenshotOut.setWidth(screenshot.getWidth());\n            screenshotOut.setHeight(screenshot.getHeight());\n          }\n\n          auto license = metadata.getLicense();\n          switch (license.which()) {\n            case spk::Metadata::License::NONE:\n              break;\n            case spk::Metadata::License::OPEN_SOURCE: {\n              auto osiLicenses = capnp::Schema::from<spk::OpenSourceLicense>().getEnumerants();\n              auto licenseId = static_cast<uint>(license.getOpenSource());\n              if (licenseId < osiLicenses.size()) {\n                for (auto annotation: osiLicenses[licenseId].getProto().getAnnotations()) {\n                  if (annotation.getId() == 0x9476412d0315d869ull) {\n                    details.setLicense(\n                        annotation.getValue().getStruct().getAs<spk::OsiLicenseInfo>().getTitle());\n                    break;\n                    // The first person to submit a pull request removing this comment will receive\n                    // a free Sandstorm t-shirt. Yes, really. Sandstorm employees are not eligible,\n                    // but should still mention to Kenton that they saw this.\n                  }\n                }\n              }\n              break;\n            }\n            case spk::Metadata::License::PROPRIETARY:\n              details.setLicense(\"Proprietary\");\n              break;\n            case spk::Metadata::License::PUBLIC_DOMAIN:\n              details.setLicense(\"Public Domain\");\n              break;\n          }\n\n          time_t publishTime = status.getPublishDate();\n          char timeStr[32];\n          KJ_ASSERT(strftime(timeStr, sizeof(timeStr), \"%FT%TZ\", gmtime(&publishTime)) > 0);\n          summary.setCreatedAt(timeStr);\n\n          kj::String appIdCopy = kj::str(appId);\n          auto& slot = appMap[appIdCopy];\n          if (slot.appId == nullptr) slot.appId = kj::mv(appIdCopy);\n          slot.version = info.getVersion();\n          slot.summary = kj::mv(summaryOrphan);\n          slot.details = kj::mv(detailsOrphan);\n        }\n      }\n    }"
          ],
          "line": 226
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "detailsOrphan"
          ],
          "line": 361
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "summaryOrphan"
          ],
          "line": 360
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getVersion",
          "args": [],
          "line": 359
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::mv",
          "args": [
            "appIdCopy"
          ],
          "line": 358
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "appId"
          ],
          "line": 356
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setCreatedAt",
          "args": [
            "timeStr"
          ],
          "line": 354
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "strftime(timeStr, sizeof(timeStr), \"%FT%TZ\", gmtime(&publishTime)) > 0"
          ],
          "line": 353
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strftime",
          "args": [
            "timeStr",
            "sizeof(timeStr)",
            "\"%FT%TZ\"",
            "gmtime(&publishTime)"
          ],
          "line": 353
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gmtime",
          "args": [
            "&publishTime"
          ],
          "line": 353
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.getPublishDate",
          "args": [],
          "line": 351
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "details.setLicense",
          "args": [
            "\"Public Domain\""
          ],
          "line": 347
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "details.setLicense",
          "args": [
            "\"Proprietary\""
          ],
          "line": 344
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "details.setLicense",
          "args": [
            "annotation.getValue().getStruct().getAs<spk::OsiLicenseInfo>().getTitle()"
          ],
          "line": 332
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "annotation.getValue",
          "args": [],
          "line": 333
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "annotation.getValue",
          "args": [],
          "line": 333
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "annotation.getValue",
          "args": [],
          "line": 333
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "annotation.getValue",
          "args": [],
          "line": 333
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "annotation.getId",
          "args": [],
          "line": 331
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "osiLicenses[licenseId].getProto",
          "args": [],
          "line": 330
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "osiLicenses[licenseId].getProto",
          "args": [],
          "line": 330
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "static_cast<uint>",
          "args": [
            "license.getOpenSource()"
          ],
          "line": 328
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "license.getOpenSource",
          "args": [],
          "line": 328
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::Schema::from<spk::OpenSourceLicense>",
          "args": [],
          "line": 327
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::Schema::from<spk::OpenSourceLicense>",
          "args": [],
          "line": 327
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "license.which",
          "args": [],
          "line": 323
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getLicense",
          "args": [],
          "line": 322
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "screenshotOut.setHeight",
          "args": [
            "screenshot.getHeight()"
          ],
          "line": 319
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "screenshot.getHeight",
          "args": [],
          "line": 319
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "screenshotOut.setWidth",
          "args": [
            "screenshot.getWidth()"
          ],
          "line": 318
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "screenshot.getWidth",
          "args": [],
          "line": 318
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "screenshotOut.setImageId",
          "args": [
            "writeScreenshot(screenshot)"
          ],
          "line": 317
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "writeScreenshot",
          "args": [
            "screenshot"
          ],
          "line": 317
        },
        "resolved": true,
        "details": {
          "function_name": "writeScreenshot",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "438-451",
          "snippet": "kj::String Indexer::writeScreenshot(spk::Metadata::Screenshot::Reader screenshot) {\n  switch (screenshot.which()) {\n    case spk::Metadata::Screenshot::PNG:\n      return writeImage(screenshot.getPng(), \".png\");\n\n    case spk::Metadata::Screenshot::JPEG:\n      return writeImage(screenshot.getJpeg().asBytes(), \".jpeg\");\n\n    case spk::Metadata::Screenshot::UNKNOWN:\n      break;\n  }\n\n  KJ_FAIL_ASSERT(\"unknown screenshot type\", (uint)screenshot.which());\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::writeScreenshot(spk::Metadata::Screenshot::Reader screenshot) {\n    switch (screenshot.which()) {\n      case spk::Metadata::Screenshot::PNG:\n        return writeImage(screenshot.getPng(), \".png\");\n  \n      case spk::Metadata::Screenshot::JPEG:\n        return writeImage(screenshot.getJpeg().asBytes(), \".jpeg\");\n  \n      case spk::Metadata::Screenshot::UNKNOWN:\n        break;\n    }\n  \n    KJ_FAIL_ASSERT(\"unknown screenshot type\", (uint)screenshot.which());\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::indices",
          "args": [
            "screenshots"
          ],
          "line": 314
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "details.initScreenshots",
          "args": [
            "screenshots.size()"
          ],
          "line": 313
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getScreenshots",
          "args": [],
          "line": 312
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "details.setDescription",
          "args": [
            "metadata.getDescription().getDefaultText()"
          ],
          "line": 310
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getDescription",
          "args": [],
          "line": 310
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getDescription",
          "args": [],
          "line": 310
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setShortDescription",
          "args": [
            "metadata.getShortDescription().getDefaultText()"
          ],
          "line": 309
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getShortDescription",
          "args": [],
          "line": 309
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getShortDescription",
          "args": [],
          "line": 309
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setUpstreamAuthor",
          "args": [
            "author.getUpstreamAuthor()"
          ],
          "line": 305
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "author.getUpstreamAuthor",
          "args": [],
          "line": 305
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "author.hasUpstreamAuthor",
          "args": [],
          "line": 304
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getAuthor",
          "args": [],
          "line": 303
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "author.setRedditUsername",
          "args": [
            "reddit[0]"
          ],
          "line": 299
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.getRedditHandles",
          "args": [],
          "line": 298
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "author.setHackernewsUsername",
          "args": [
            "hackernews[0]"
          ],
          "line": 297
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.getHackernewsHandles",
          "args": [],
          "line": 296
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "author.setTwitterUsername",
          "args": [
            "twitter[0]"
          ],
          "line": 295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.getTwitterHandles",
          "args": [],
          "line": 294
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "author.setGithubUsername",
          "args": [
            "github[0]"
          ],
          "line": 293
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.getGithubHandles",
          "args": [],
          "line": 292
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "author.setPicture",
          "args": [
            "keybase.getPicture()"
          ],
          "line": 290
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.getPicture",
          "args": [],
          "line": 290
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.hasPicture",
          "args": [],
          "line": 290
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "author.setKeybaseUsername",
          "args": [
            "keybase.getKeybaseHandle()"
          ],
          "line": 289
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.getKeybaseHandle",
          "args": [],
          "line": 289
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "author.setName",
          "args": [
            "keybase.getName()"
          ],
          "line": 288
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keybase.getName",
          "args": [],
          "line": 288
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.initAuthor",
          "args": [],
          "line": 287
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reader.getRoot<KeybaseIdentity>",
          "args": [],
          "line": 286
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fd->get",
          "args": [],
          "line": 285
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpenIfExists",
          "args": [
            "kj::str(\"/var/keybase/\", info.getAuthorPgpKeyFingerprint())",
            "O_RDONLY"
          ],
          "line": 283
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/keybase/\"",
            "info.getAuthorPgpKeyFingerprint()"
          ],
          "line": 284
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getAuthorPgpKeyFingerprint",
          "args": [],
          "line": 284
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.hasAuthorPgpKeyFingerprint",
          "args": [],
          "line": 282
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setCategories",
          "args": [
            "KJ_MAP(c, metadata.getCategories()){ return categoryName(c); }"
          ],
          "line": 280
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "categoryName",
          "args": [
            "c"
          ],
          "line": 280
        },
        "resolved": true,
        "details": {
          "function_name": "categoryName",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "471-482",
          "snippet": "capnp::Text::Reader Indexer::categoryName(spk::Category category) {\n  auto categories = capnp::Schema::from<spk::Category>().getEnumerants();\n  auto categoryId = static_cast<uint>(category);\n  if (categoryId < categories.size()) {\n    for (auto annotation: categories[categoryId].getProto().getAnnotations()) {\n      if (annotation.getId() == 0x8d51dd236606d205) {\n        return annotation.getValue().getStruct().getAs<spk::CategoryInfo>().getTitle();\n      }\n    }\n  }\n  return \"Other\";\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  capnp::Text::Reader Indexer::categoryName(spk::Category category) {\n    auto categories = capnp::Schema::from<spk::Category>().getEnumerants();\n    auto categoryId = static_cast<uint>(category);\n    if (categoryId < categories.size()) {\n      for (auto annotation: categories[categoryId].getProto().getAnnotations()) {\n        if (annotation.getId() == 0x8d51dd236606d205) {\n          return annotation.getValue().getStruct().getAs<spk::CategoryInfo>().getTitle();\n        }\n      }\n    }\n    return \"Other\";\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "KJ_MAP",
          "args": [
            "c",
            "metadata.getCategories()"
          ],
          "line": 280
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getCategories",
          "args": [],
          "line": 280
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setIsOpenSource",
          "args": [
            "metadata.getLicense().isOpenSource()"
          ],
          "line": 279
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getLicense",
          "args": [],
          "line": 279
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getLicense",
          "args": [],
          "line": 279
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setCodeLink",
          "args": [
            "metadata.getCodeUrl()"
          ],
          "line": 277
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getCodeUrl",
          "args": [],
          "line": 277
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.hasCodeUrl",
          "args": [],
          "line": 277
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setWebLink",
          "args": [
            "metadata.getWebsite()"
          ],
          "line": 276
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getWebsite",
          "args": [],
          "line": 276
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.hasWebsite",
          "args": [],
          "line": 276
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setImageId",
          "args": [
            "writeIcon(\n                icons.hasMarket() ? icons.getMarket() : icons.getAppGrid())"
          ],
          "line": 272
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "writeIcon",
          "args": [
            "icons.hasMarket() ? icons.getMarket() : icons.getAppGrid()"
          ],
          "line": 272
        },
        "resolved": true,
        "details": {
          "function_name": "writeIcon",
          "container": "Indexer",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "421-436",
          "snippet": "kj::String Indexer::writeIcon(spk::Metadata::Icon::Reader icon) {\n  switch (icon.which()) {\n    case spk::Metadata::Icon::SVG:\n      return writeImage(icon.getSvg().asBytes(), \".svg\");\n\n    case spk::Metadata::Icon::PNG: {\n      auto png = icon.getPng();\n      return writeImage(png.hasDpi2x() ? png.getDpi2x() : png.getDpi1x(), \".png\");\n    }\n\n    case spk::Metadata::Icon::UNKNOWN:\n      break;\n  }\n\n  KJ_FAIL_ASSERT(\"unknown icon type\", (uint)icon.which());\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::writeIcon(spk::Metadata::Icon::Reader icon) {\n    switch (icon.which()) {\n      case spk::Metadata::Icon::SVG:\n        return writeImage(icon.getSvg().asBytes(), \".svg\");\n  \n      case spk::Metadata::Icon::PNG: {\n        auto png = icon.getPng();\n        return writeImage(png.hasDpi2x() ? png.getDpi2x() : png.getDpi1x(), \".png\");\n      }\n  \n      case spk::Metadata::Icon::UNKNOWN:\n        break;\n    }\n  \n    KJ_FAIL_ASSERT(\"unknown icon type\", (uint)icon.which());\n  }\n}"
        }
      },
      {
        "call_info": {
          "callee": "icons.getAppGrid",
          "args": [],
          "line": 273
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "icons.getMarket",
          "args": [],
          "line": 273
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "icons.hasMarket",
          "args": [],
          "line": 273
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "icons.hasAppGrid",
          "args": [],
          "line": 271
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "icons.hasMarket",
          "args": [],
          "line": 271
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata.getIcons",
          "args": [],
          "line": 269
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setPackageId",
          "args": [
            "info.getPackageId()"
          ],
          "line": 267
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getPackageId",
          "args": [],
          "line": 267
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setVersionNumber",
          "args": [
            "info.getVersion()"
          ],
          "line": 266
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getVersion",
          "args": [],
          "line": 266
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setVersion",
          "args": [
            "info.getMarketingVersion().getDefaultText()"
          ],
          "line": 265
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getMarketingVersion",
          "args": [],
          "line": 265
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getMarketingVersion",
          "args": [],
          "line": 265
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setName",
          "args": [
            "info.getTitle().getDefaultText()"
          ],
          "line": 264
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getTitle",
          "args": [],
          "line": 264
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getTitle",
          "args": [],
          "line": 264
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summary.setAppId",
          "args": [
            "info.getAppId()"
          ],
          "line": 263
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getAppId",
          "args": [],
          "line": 263
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "detailsOrphan.get",
          "args": [],
          "line": 261
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "orphanage.newOrphan<AppDetailsForMarket>",
          "args": [],
          "line": 260
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "summaryOrphan.get",
          "args": [],
          "line": 259
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "orphanage.newOrphan<AppIndexForMarket::App>",
          "args": [],
          "line": 258
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getVersion",
          "args": [],
          "line": 257
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "appMap.end",
          "args": [],
          "line": 257
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "appMap.find",
          "args": [
            "appId"
          ],
          "line": 256
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "appIdString",
          "args": [
            "info.getAppId()"
          ],
          "line": 255
        },
        "resolved": true,
        "details": {
          "function_name": "appIdString",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/id-to-text.c++",
          "lines": "171-174",
          "snippet": "kj::String appIdString(kj::ArrayPtr<const kj::byte> appId) {\n  KJ_REQUIRE(appId.size() == APP_ID_BYTE_SIZE);\n  return base32Encode(appId);\n}",
          "includes": [
            "#include \"util.h\"",
            "#include \"id-to-text.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"util.h\"\n#include \"id-to-text.h\"\n\nkj::String appIdString(kj::ArrayPtr<const kj::byte> appId) {\n  KJ_REQUIRE(appId.size() == APP_ID_BYTE_SIZE);\n  return base32Encode(appId);\n}"
        }
      },
      {
        "call_info": {
          "callee": "info.getAppId",
          "args": [],
          "line": 255
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"link(spkFile, spkLinkName)\"",
            "error",
            "spkFile",
            "spkLinkName"
          ],
          "line": 250
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "spkLinkName.cStr",
          "args": [],
          "line": 244
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "spkFile.cStr",
          "args": [],
          "line": 244
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/www/packages/\"",
            "packageId"
          ],
          "line": 243
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "info.getMetadata",
          "args": [],
          "line": 239
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadataMessage.getRoot<spk::VerifiedInfo>",
          "args": [],
          "line": 238
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.getRequestState",
          "args": [],
          "line": 236
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.isApproved",
          "args": [],
          "line": 235
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.isPending",
          "args": [],
          "line": 235
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "statusMessage.getRoot<SubmissionStatus>",
          "args": [],
          "line": 234
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "access(spkFile.cStr(), F_OK)"
          ],
          "line": 231
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "spkFile.cStr()",
            "F_OK"
          ],
          "line": 231
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "spkFile.cStr",
          "args": [],
          "line": 231
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageId",
            "\"/status\""
          ],
          "line": 229
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageId",
            "\"/metadata\""
          ],
          "line": 228
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageId",
            "\"/spk\""
          ],
          "line": 227
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "listDirectory",
          "args": [
            "\"/var/packages\""
          ],
          "line": 225
        },
        "resolved": true,
        "details": {
          "function_name": "listDirectoryFd",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "292-297",
          "snippet": "kj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::Array<kj::String> listDirectoryFd(int dirfd) {\n  // We can't actually use `dirfd` directly because we'd mess up the seek state and because\n  // closedir() unfortunately always closes the FD even if opened with fdopendir(). So instead\n  // we delegate to listDirectoryAt() which will open a new FD.\n  return listDirectoryAt(dirfd, \".\");\n}"
        }
      },
      {
        "call_info": {
          "callee": "scratch.getOrphanage",
          "args": [],
          "line": 215
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::updateIndexInternal(kj::StringPtr outputDir, bool experimental) {\n    capnp::MallocMessageBuilder scratch;\n    auto orphanage = scratch.getOrphanage();\n  \n    struct AppEntry {\n      kj::String appId;\n      uint version = 0;\n      capnp::Orphan<AppIndexForMarket::App> summary;\n      capnp::Orphan<AppDetailsForMarket> details;\n    };\n    std::map<kj::StringPtr, AppEntry> appMap;\n  \n    for (auto& packageId: listDirectory(\"/var/packages\")) {\n      KJ_IF_MAYBE(exception, kj::runCatchingExceptions([&]() {\n        auto spkFile = kj::str(\"/var/packages/\", packageId, \"/spk\");\n        auto metadataFile = kj::str(\"/var/packages/\", packageId, \"/metadata\");\n        auto statusFile = kj::str(\"/var/packages/\", packageId, \"/status\");\n  \n        KJ_SYSCALL(access(spkFile.cStr(), F_OK));\n  \n        capnp::StreamFdMessageReader statusMessage(raiiOpen(statusFile, O_RDONLY));\n        auto status = statusMessage.getRoot<SubmissionStatus>();\n        auto include = experimental ? status.isPending() : status.isApproved();\n        if (include && status.getRequestState() == SubmissionState::PUBLISH) {\n          capnp::StreamFdMessageReader metadataMessage(raiiOpen(metadataFile, O_RDONLY));\n          auto info = metadataMessage.getRoot<spk::VerifiedInfo>();\n          auto metadata = info.getMetadata();\n  \n          // Hard-link spk. Note that we intentionally continue to publish outdated SPKs unless\n          // the author un-publishes them.\n          auto spkLinkName = kj::str(\"/var/www/packages/\", packageId);\n          while (link(spkFile.cStr(), spkLinkName.cStr()) < 0) {\n            int error = errno;\n            if (error == EEXIST) {\n              // Already linked.\n              break;\n            } else if (error != EINTR) {\n              KJ_FAIL_SYSCALL(\"link(spkFile, spkLinkName)\", error, spkFile, spkLinkName);\n            }\n          }\n  \n          // Update entry.\n          auto appId = appIdString(info.getAppId());\n          auto iter = appMap.find(appId);\n          if (iter == appMap.end() || info.getVersion() >= iter->second.version) {\n            auto summaryOrphan = orphanage.newOrphan<AppIndexForMarket::App>();\n            auto summary = summaryOrphan.get();\n            auto detailsOrphan = orphanage.newOrphan<AppDetailsForMarket>();\n            auto details = detailsOrphan.get();\n  \n            summary.setAppId(info.getAppId());\n            summary.setName(info.getTitle().getDefaultText());\n            summary.setVersion(info.getMarketingVersion().getDefaultText());\n            summary.setVersionNumber(info.getVersion());\n            summary.setPackageId(info.getPackageId());\n  \n            auto icons = metadata.getIcons();\n  \n            if (icons.hasMarket() || icons.hasAppGrid()) {\n              summary.setImageId(writeIcon(\n                  icons.hasMarket() ? icons.getMarket() : icons.getAppGrid()));\n            }\n  \n            if (metadata.hasWebsite()) summary.setWebLink(metadata.getWebsite());\n            if (metadata.hasCodeUrl()) summary.setCodeLink(metadata.getCodeUrl());\n  \n            summary.setIsOpenSource(metadata.getLicense().isOpenSource());\n            summary.setCategories(KJ_MAP(c, metadata.getCategories()) { return categoryName(c); });\n  \n            if (info.hasAuthorPgpKeyFingerprint()) {\n              KJ_IF_MAYBE(fd, raiiOpenIfExists(\n                  kj::str(\"/var/keybase/\", info.getAuthorPgpKeyFingerprint()), O_RDONLY)) {\n                capnp::StreamFdMessageReader reader(fd->get());\n                auto keybase = reader.getRoot<KeybaseIdentity>();\n                auto author = summary.initAuthor();\n                author.setName(keybase.getName());\n                author.setKeybaseUsername(keybase.getKeybaseHandle());\n                if (keybase.hasPicture()) author.setPicture(keybase.getPicture());\n  \n                auto github = keybase.getGithubHandles();\n                if (github.size() > 0) author.setGithubUsername(github[0]);\n                auto twitter = keybase.getTwitterHandles();\n                if (twitter.size() > 0) author.setTwitterUsername(twitter[0]);\n                auto hackernews = keybase.getHackernewsHandles();\n                if (hackernews.size() > 0) author.setHackernewsUsername(hackernews[0]);\n                auto reddit = keybase.getRedditHandles();\n                if (reddit.size() > 0) author.setRedditUsername(reddit[0]);\n              }\n            }\n  \n            auto author = metadata.getAuthor();\n            if (author.hasUpstreamAuthor()) {\n              summary.setUpstreamAuthor(author.getUpstreamAuthor());\n            }\n  \n            // TODO(soon): Additional HTML sanitization? Client should be doing that already...\n            summary.setShortDescription(metadata.getShortDescription().getDefaultText());\n            details.setDescription(metadata.getDescription().getDefaultText());\n  \n            auto screenshots = metadata.getScreenshots();\n            auto screenshotsOut = details.initScreenshots(screenshots.size());\n            for (auto i: kj::indices(screenshots)) {\n              auto screenshot = screenshots[i];\n              auto screenshotOut = screenshotsOut[i];\n              screenshotOut.setImageId(writeScreenshot(screenshot));\n              screenshotOut.setWidth(screenshot.getWidth());\n              screenshotOut.setHeight(screenshot.getHeight());\n            }\n  \n            auto license = metadata.getLicense();\n            switch (license.which()) {\n              case spk::Metadata::License::NONE:\n                break;\n              case spk::Metadata::License::OPEN_SOURCE: {\n                auto osiLicenses = capnp::Schema::from<spk::OpenSourceLicense>().getEnumerants();\n                auto licenseId = static_cast<uint>(license.getOpenSource());\n                if (licenseId < osiLicenses.size()) {\n                  for (auto annotation: osiLicenses[licenseId].getProto().getAnnotations()) {\n                    if (annotation.getId() == 0x9476412d0315d869ull) {\n                      details.setLicense(\n                          annotation.getValue().getStruct().getAs<spk::OsiLicenseInfo>().getTitle());\n                      break;\n                      // The first person to submit a pull request removing this comment will receive\n                      // a free Sandstorm t-shirt. Yes, really. Sandstorm employees are not eligible,\n                      // but should still mention to Kenton that they saw this.\n                    }\n                  }\n                }\n                break;\n              }\n              case spk::Metadata::License::PROPRIETARY:\n                details.setLicense(\"Proprietary\");\n                break;\n              case spk::Metadata::License::PUBLIC_DOMAIN:\n                details.setLicense(\"Public Domain\");\n                break;\n            }\n  \n            time_t publishTime = status.getPublishDate();\n            char timeStr[32];\n            KJ_ASSERT(strftime(timeStr, sizeof(timeStr), \"%FT%TZ\", gmtime(&publishTime)) > 0);\n            summary.setCreatedAt(timeStr);\n  \n            kj::String appIdCopy = kj::str(appId);\n            auto& slot = appMap[appIdCopy];\n            if (slot.appId == nullptr) slot.appId = kj::mv(appIdCopy);\n            slot.version = info.getVersion();\n            slot.summary = kj::mv(summaryOrphan);\n            slot.details = kj::mv(detailsOrphan);\n          }\n        }\n      })) {\n        KJ_LOG(ERROR, \"error processing package\", packageId, *exception);\n      }\n    }\n  \n    KJ_IF_MAYBE(descriptionsFd, raiiOpenIfExists(\"/var/descriptions\", O_RDONLY)) {\n      capnp::StreamFdMessageReader reader(kj::mv(*descriptionsFd));\n      for (auto override: reader.getRoot<ShortDescriptionOverrides>().getItems()) {\n        auto iter = appMap.find(override.getAppId());\n        if (iter != appMap.end()) {\n          iter->second.summary.get().setShortDescription(override.getShortDescription());\n        }\n      }\n    }\n  \n    AppIdJsonHandler appIdHandler;\n    PackageIdJsonHandler packageIdHandler;\n    capnp::JsonCodec json;\n    json.addTypeHandler(appIdHandler);\n    json.addTypeHandler(packageIdHandler);\n  \n    capnp::MallocMessageBuilder indexMessage;\n    auto indexData = indexMessage.initRoot<AppIndexForMarket>();\n    auto apps = indexData.initApps(appMap.size());\n    uint i = 0;\n    for (auto& appEntry: appMap) {\n      apps.setWithCaveats(i++, appEntry.second.summary.getReader());\n  \n      auto text = json.encode(appEntry.second.details.getReader());\n      StagingFile file(outputDir);\n      kj::FdOutputStream(file.getFd()).write(text.begin(), text.size());\n      file.finalize(kj::str(outputDir, \"/\", appEntry.first, \".json\"));\n  \n      if (!experimental) {\n        // Write the symlink under /var/apps.\n        auto target = kj::str(\"../packages/\",\n            packageIdString(appEntry.second.summary.getReader().getPackageId()));\n        auto linkPath = kj::str(\"/var/apps/\", appEntry.first);\n        auto tmpLinkPath = kj::str(linkPath, \".tmp\");\n        unlink(tmpLinkPath.cStr());  // just in case\n        KJ_SYSCALL(symlink(target.cStr(), tmpLinkPath.cStr()));\n        KJ_SYSCALL(rename(tmpLinkPath.cStr(), linkPath.cStr()));\n      }\n    }\n    KJ_ASSERT(i == apps.size());\n  \n    auto text = json.encode(indexData);\n    StagingFile file(outputDir);\n    kj::FdOutputStream(file.getFd()).write(text.begin(), text.size());\n    file.finalize(kj::str(outputDir, \"/index.json\"));\n  }\n}"
  },
  {
    "function_name": "decode",
    "container": "DataHandler",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "204-208",
    "snippet": "capnp::Orphan<capnp::Data> decode(\n      const capnp::JsonCodec& codec, capnp::JsonValue::Reader input,\n      capnp::Orphanage orphanage) const override {\n    KJ_UNIMPLEMENTED(\"DataHandler::decode\");\n  }",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_UNIMPLEMENTED",
          "args": [
            "\"DataHandler::decode\""
          ],
          "line": 207
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nDataHandler {\n  capnp::Orphan<capnp::Data> decode(\n        const capnp::JsonCodec& codec, capnp::JsonValue::Reader input,\n        capnp::Orphanage orphanage) const override {\n      KJ_UNIMPLEMENTED(\"DataHandler::decode\");\n    }\n}"
  },
  {
    "function_name": "encode",
    "container": "DataHandler",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "199-202",
    "snippet": "void encode(const capnp::JsonCodec& codec, capnp::Data::Reader input,\n              capnp::JsonValue::Builder output) const override {\n    output.setString(base64Encode(input, false));\n  }",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "output.setString",
          "args": [
            "base64Encode(input, false)"
          ],
          "line": 201
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "base64Encode",
          "args": [
            "input",
            "false"
          ],
          "line": 201
        },
        "resolved": true,
        "details": {
          "function_name": "base64Encode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.c++",
          "lines": "630-670",
          "snippet": "kj::String base64Encode(kj::ArrayPtr<const byte> input, bool breakLines) {\n  /* set up a destination buffer large enough to hold the encoded data */\n  // equivalent to ceil(input.size() / 3) * 4\n  auto numChars = (input.size() + 2) / 3 * 4;\n  if (breakLines) {\n    // Add space for newline characters.\n    uint lineCount = numChars / CHARS_PER_LINE;\n    if (numChars % CHARS_PER_LINE > 0) {\n      // Partial line.\n      ++lineCount;\n    }\n    numChars = numChars + lineCount;\n  }\n  auto output = kj::heapString(numChars);\n  /* keep track of our encoded position */\n  char* c = output.begin();\n  /* store the number of bytes encoded by a single call */\n  int cnt = 0;\n  size_t total = 0;\n  /* we need an encoder state */\n  base64_encodestate s;\n\n  /*---------- START ENCODING ----------*/\n  /* initialise the encoder state */\n  base64_init_encodestate(&s);\n  /* gather data from the input and send it to the output */\n  cnt = base64_encode_block((const char *)input.begin(), input.size(), c, &s, breakLines);\n  c += cnt;\n  total += cnt;\n\n  /* since we have encoded the entire input string, we know that\n     there is no more input data; finalise the encoding */\n  cnt = base64_encode_blockend(c, &s, breakLines);\n  c += cnt;\n  total += cnt;\n  /*---------- STOP ENCODING  ----------*/\n\n  KJ_ASSERT(total == output.size(), total, output.size());\n\n  return output;\n}",
          "includes": [
            "#include <sys/sendfile.h>",
            "#include <sys/socket.h>",
            "#include <sys/mman.h>",
            "#include <map>",
            "#include <sys/wait.h>",
            "#include <signal.h>",
            "#include <syscall.h>",
            "#include <dirent.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <ctype.h>",
            "#include <kj/async-unix.h>",
            "#include <kj/vector.h>",
            "#include <errno.h>",
            "#include \"util.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/sendfile.h>\n#include <sys/socket.h>\n#include <sys/mman.h>\n#include <map>\n#include <sys/wait.h>\n#include <signal.h>\n#include <syscall.h>\n#include <dirent.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <ctype.h>\n#include <kj/async-unix.h>\n#include <kj/vector.h>\n#include <errno.h>\n#include \"util.h\"\n\nkj::String base64Encode(kj::ArrayPtr<const byte> input, bool breakLines) {\n  /* set up a destination buffer large enough to hold the encoded data */\n  // equivalent to ceil(input.size() / 3) * 4\n  auto numChars = (input.size() + 2) / 3 * 4;\n  if (breakLines) {\n    // Add space for newline characters.\n    uint lineCount = numChars / CHARS_PER_LINE;\n    if (numChars % CHARS_PER_LINE > 0) {\n      // Partial line.\n      ++lineCount;\n    }\n    numChars = numChars + lineCount;\n  }\n  auto output = kj::heapString(numChars);\n  /* keep track of our encoded position */\n  char* c = output.begin();\n  /* store the number of bytes encoded by a single call */\n  int cnt = 0;\n  size_t total = 0;\n  /* we need an encoder state */\n  base64_encodestate s;\n\n  /*---------- START ENCODING ----------*/\n  /* initialise the encoder state */\n  base64_init_encodestate(&s);\n  /* gather data from the input and send it to the output */\n  cnt = base64_encode_block((const char *)input.begin(), input.size(), c, &s, breakLines);\n  c += cnt;\n  total += cnt;\n\n  /* since we have encoded the entire input string, we know that\n     there is no more input data; finalise the encoding */\n  cnt = base64_encode_blockend(c, &s, breakLines);\n  c += cnt;\n  total += cnt;\n  /*---------- STOP ENCODING  ----------*/\n\n  KJ_ASSERT(total == output.size(), total, output.size());\n\n  return output;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nDataHandler {\n  void encode(const capnp::JsonCodec& codec, capnp::Data::Reader input,\n                capnp::JsonValue::Builder output) const override {\n      output.setString(base64Encode(input, false));\n    }\n}"
  },
  {
    "function_name": "getAppTitle",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "187-191",
    "snippet": "kj::String Indexer::getAppTitle(kj::StringPtr packageId) {\n  capnp::StreamFdMessageReader message(\n      sandstorm::raiiOpen(kj::str(\"/var/packages/\", packageId, \"/metadata\"), O_RDONLY));\n  return kj::str(message.getRoot<spk::VerifiedInfo>().getTitle().getDefaultText());\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "message.getRoot<spk::VerifiedInfo>().getTitle().getDefaultText()"
          ],
          "line": 190
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "message.getRoot<spk::VerifiedInfo>",
          "args": [],
          "line": 190
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "message.getRoot<spk::VerifiedInfo>",
          "args": [],
          "line": 190
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "message.getRoot<spk::VerifiedInfo>",
          "args": [],
          "line": 190
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sandstorm::raiiOpen",
          "args": [
            "kj::str(\"/var/packages/\", packageId, \"/metadata\")",
            "O_RDONLY"
          ],
          "line": 189
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageId",
            "\"/metadata\""
          ],
          "line": 189
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  kj::String Indexer::getAppTitle(kj::StringPtr packageId) {\n    capnp::StreamFdMessageReader message(\n        sandstorm::raiiOpen(kj::str(\"/var/packages/\", packageId, \"/metadata\"), O_RDONLY));\n    return kj::str(message.getRoot<spk::VerifiedInfo>().getTitle().getDefaultText());\n  }\n}"
  },
  {
    "function_name": "getSubmissionStatus",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "172-185",
    "snippet": "void Indexer::getSubmissionStatus(kj::StringPtr packageId, capnp::MessageBuilder& output) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), output);\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "capnp::readMessageCopyFromFd",
          "args": [
            "raiiOpen(statusFile, O_RDONLY)",
            "output"
          ],
          "line": 184
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "statusFile",
            "O_RDONLY"
          ],
          "line": 184
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "packageDir",
            "\"/status\""
          ],
          "line": 183
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "access(spkFile.cStr(), F_OK)",
            "\"no such package; try uploading it again\""
          ],
          "line": 180
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "spkFile.cStr()",
            "F_OK"
          ],
          "line": 180
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "spkFile.cStr",
          "args": [],
          "line": 180
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "packageDir",
            "\"/spk\""
          ],
          "line": 179
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageId"
          ],
          "line": 178
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "isalnum(c)",
            "\"invalid package ID\"",
            "packageId"
          ],
          "line": 175
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "isalnum",
          "args": [
            "c"
          ],
          "line": 175
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "packageId.size() == 32",
            "\"invalid package ID\"",
            "packageId"
          ],
          "line": 173
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "packageId.size",
          "args": [],
          "line": 173
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::getSubmissionStatus(kj::StringPtr packageId, capnp::MessageBuilder& output) {\n    KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n    for (auto c: packageId) {\n      KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n    }\n  \n    auto packageDir = kj::str(\"/var/packages/\", packageId);\n    auto spkFile = kj::str(packageDir, \"/spk\");\n    KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n               \"no such package; try uploading it again\");\n  \n    auto statusFile = kj::str(packageDir, \"/status\");\n    capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), output);\n  }\n}"
  },
  {
    "function_name": "setSubmissionState",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "160-170",
    "snippet": "bool Indexer::setSubmissionState(kj::StringPtr packageId, SubmissionState state,\n                                 uint64_t sequence) {\n  return updatePackageStatus(packageId, [&](auto&& status) {\n    if (status.getRequestState() == state) return false;\n    KJ_REQUIRE(sequence >= status.getNextSequenceNumber(),\n               \"bad sequence number in request; replay attack?\");\n    status.setRequestState(state);\n    status.setNextSequenceNumber(sequence + 1);\n    return true;\n  });\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "updatePackageStatus",
          "args": [
            "packageId",
            "[&](auto&& status) {\n    if (status.getRequestState() == state) return false;\n    KJ_REQUIRE(sequence >= status.getNextSequenceNumber(),\n               \"bad sequence number in request; replay attack?\");\n    status.setRequestState(state);\n    status.setNextSequenceNumber(sequence + 1);\n    return true;\n  }"
          ],
          "line": 162
        },
        "resolved": true,
        "details": {
          "function_name": "updatePackageStatus",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "109-135",
          "snippet": "static bool updatePackageStatus(kj::StringPtr packageId, Func&& func) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::MallocMessageBuilder statusMessage;\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), statusMessage);\n  auto status = statusMessage.getRoot<SubmissionStatus>();\n  if (!func(status)) return false;\n  if (status.getPublishDate() == 0 &&\n      status.getRequestState() == SubmissionState::PUBLISH &&\n      status.isApproved()) {\n    status.setPublishDate(time(nullptr));\n  }\n\n  StagingFile newStatus(packageDir);\n  capnp::writeMessageToFd(newStatus.getFd(), statusMessage);\n  newStatus.finalize(statusFile);\n  return true;\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nstatic bool updatePackageStatus(kj::StringPtr packageId, Func&& func) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::MallocMessageBuilder statusMessage;\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), statusMessage);\n  auto status = statusMessage.getRoot<SubmissionStatus>();\n  if (!func(status)) return false;\n  if (status.getPublishDate() == 0 &&\n      status.getRequestState() == SubmissionState::PUBLISH &&\n      status.isApproved()) {\n    status.setPublishDate(time(nullptr));\n  }\n\n  StagingFile newStatus(packageDir);\n  capnp::writeMessageToFd(newStatus.getFd(), statusMessage);\n  newStatus.finalize(statusFile);\n  return true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "status.setNextSequenceNumber",
          "args": [
            "sequence + 1"
          ],
          "line": 167
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.setRequestState",
          "args": [
            "state"
          ],
          "line": 166
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "sequence >= status.getNextSequenceNumber()",
            "\"bad sequence number in request; replay attack?\""
          ],
          "line": 164
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.getNextSequenceNumber",
          "args": [],
          "line": 164
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.getRequestState",
          "args": [],
          "line": 163
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  bool Indexer::setSubmissionState(kj::StringPtr packageId, SubmissionState state,\n                                   uint64_t sequence) {\n    return updatePackageStatus(packageId, [&](auto&& status) {\n      if (status.getRequestState() == state) return false;\n      KJ_REQUIRE(sequence >= status.getNextSequenceNumber(),\n                 \"bad sequence number in request; replay attack?\");\n      status.setRequestState(state);\n      status.setNextSequenceNumber(sequence + 1);\n      return true;\n    });\n  }\n}"
  },
  {
    "function_name": "reject",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "153-158",
    "snippet": "void Indexer::reject(kj::StringPtr packageId, kj::StringPtr reason) {\n  updatePackageStatus(packageId, [&](auto&& status) {\n    status.setNeedsUpdate(reason);\n    return true;\n  });\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "updatePackageStatus",
          "args": [
            "packageId",
            "[&](auto&& status) {\n    status.setNeedsUpdate(reason);\n    return true;\n  }"
          ],
          "line": 154
        },
        "resolved": true,
        "details": {
          "function_name": "updatePackageStatus",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "109-135",
          "snippet": "static bool updatePackageStatus(kj::StringPtr packageId, Func&& func) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::MallocMessageBuilder statusMessage;\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), statusMessage);\n  auto status = statusMessage.getRoot<SubmissionStatus>();\n  if (!func(status)) return false;\n  if (status.getPublishDate() == 0 &&\n      status.getRequestState() == SubmissionState::PUBLISH &&\n      status.isApproved()) {\n    status.setPublishDate(time(nullptr));\n  }\n\n  StagingFile newStatus(packageDir);\n  capnp::writeMessageToFd(newStatus.getFd(), statusMessage);\n  newStatus.finalize(statusFile);\n  return true;\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nstatic bool updatePackageStatus(kj::StringPtr packageId, Func&& func) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::MallocMessageBuilder statusMessage;\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), statusMessage);\n  auto status = statusMessage.getRoot<SubmissionStatus>();\n  if (!func(status)) return false;\n  if (status.getPublishDate() == 0 &&\n      status.getRequestState() == SubmissionState::PUBLISH &&\n      status.isApproved()) {\n    status.setPublishDate(time(nullptr));\n  }\n\n  StagingFile newStatus(packageDir);\n  capnp::writeMessageToFd(newStatus.getFd(), statusMessage);\n  newStatus.finalize(statusFile);\n  return true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "status.setNeedsUpdate",
          "args": [
            "reason"
          ],
          "line": 155
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::reject(kj::StringPtr packageId, kj::StringPtr reason) {\n    updatePackageStatus(packageId, [&](auto&& status) {\n      status.setNeedsUpdate(reason);\n      return true;\n    });\n  }\n}"
  },
  {
    "function_name": "unapprove",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "145-151",
    "snippet": "void Indexer::unapprove(kj::StringPtr packageId) {\n  updatePackageStatus(packageId, [](auto&& status) {\n    if (status.isPending()) return false;\n    status.setPending();\n    return true;\n  });\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "updatePackageStatus",
          "args": [
            "packageId",
            "[](auto&& status) {\n    if (status.isPending()) return false;\n    status.setPending();\n    return true;\n  }"
          ],
          "line": 146
        },
        "resolved": true,
        "details": {
          "function_name": "updatePackageStatus",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "109-135",
          "snippet": "static bool updatePackageStatus(kj::StringPtr packageId, Func&& func) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::MallocMessageBuilder statusMessage;\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), statusMessage);\n  auto status = statusMessage.getRoot<SubmissionStatus>();\n  if (!func(status)) return false;\n  if (status.getPublishDate() == 0 &&\n      status.getRequestState() == SubmissionState::PUBLISH &&\n      status.isApproved()) {\n    status.setPublishDate(time(nullptr));\n  }\n\n  StagingFile newStatus(packageDir);\n  capnp::writeMessageToFd(newStatus.getFd(), statusMessage);\n  newStatus.finalize(statusFile);\n  return true;\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nstatic bool updatePackageStatus(kj::StringPtr packageId, Func&& func) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::MallocMessageBuilder statusMessage;\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), statusMessage);\n  auto status = statusMessage.getRoot<SubmissionStatus>();\n  if (!func(status)) return false;\n  if (status.getPublishDate() == 0 &&\n      status.getRequestState() == SubmissionState::PUBLISH &&\n      status.isApproved()) {\n    status.setPublishDate(time(nullptr));\n  }\n\n  StagingFile newStatus(packageDir);\n  capnp::writeMessageToFd(newStatus.getFd(), statusMessage);\n  newStatus.finalize(statusFile);\n  return true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "status.setPending",
          "args": [],
          "line": 148
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.isPending",
          "args": [],
          "line": 147
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::unapprove(kj::StringPtr packageId) {\n    updatePackageStatus(packageId, [](auto&& status) {\n      if (status.isPending()) return false;\n      status.setPending();\n      return true;\n    });\n  }\n}"
  },
  {
    "function_name": "approve",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "137-143",
    "snippet": "void Indexer::approve(kj::StringPtr packageId, kj::StringPtr url) {\n  updatePackageStatus(packageId, [&](auto&& status) {\n    if (status.isApproved()) return false;\n    status.setApproved(url);\n    return true;\n  });\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "updatePackageStatus",
          "args": [
            "packageId",
            "[&](auto&& status) {\n    if (status.isApproved()) return false;\n    status.setApproved(url);\n    return true;\n  }"
          ],
          "line": 138
        },
        "resolved": true,
        "details": {
          "function_name": "updatePackageStatus",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "109-135",
          "snippet": "static bool updatePackageStatus(kj::StringPtr packageId, Func&& func) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::MallocMessageBuilder statusMessage;\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), statusMessage);\n  auto status = statusMessage.getRoot<SubmissionStatus>();\n  if (!func(status)) return false;\n  if (status.getPublishDate() == 0 &&\n      status.getRequestState() == SubmissionState::PUBLISH &&\n      status.isApproved()) {\n    status.setPublishDate(time(nullptr));\n  }\n\n  StagingFile newStatus(packageDir);\n  capnp::writeMessageToFd(newStatus.getFd(), statusMessage);\n  newStatus.finalize(statusFile);\n  return true;\n}",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nstatic bool updatePackageStatus(kj::StringPtr packageId, Func&& func) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::MallocMessageBuilder statusMessage;\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), statusMessage);\n  auto status = statusMessage.getRoot<SubmissionStatus>();\n  if (!func(status)) return false;\n  if (status.getPublishDate() == 0 &&\n      status.getRequestState() == SubmissionState::PUBLISH &&\n      status.isApproved()) {\n    status.setPublishDate(time(nullptr));\n  }\n\n  StagingFile newStatus(packageDir);\n  capnp::writeMessageToFd(newStatus.getFd(), statusMessage);\n  newStatus.finalize(statusFile);\n  return true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "status.setApproved",
          "args": [
            "url"
          ],
          "line": 140
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.isApproved",
          "args": [],
          "line": 139
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::approve(kj::StringPtr packageId, kj::StringPtr url) {\n    updatePackageStatus(packageId, [&](auto&& status) {\n      if (status.isApproved()) return false;\n      status.setApproved(url);\n      return true;\n    });\n  }\n}"
  },
  {
    "function_name": "updatePackageStatus",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "109-135",
    "snippet": "static bool updatePackageStatus(kj::StringPtr packageId, Func&& func) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::MallocMessageBuilder statusMessage;\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), statusMessage);\n  auto status = statusMessage.getRoot<SubmissionStatus>();\n  if (!func(status)) return false;\n  if (status.getPublishDate() == 0 &&\n      status.getRequestState() == SubmissionState::PUBLISH &&\n      status.isApproved()) {\n    status.setPublishDate(time(nullptr));\n  }\n\n  StagingFile newStatus(packageDir);\n  capnp::writeMessageToFd(newStatus.getFd(), statusMessage);\n  newStatus.finalize(statusFile);\n  return true;\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "newStatus.finalize",
          "args": [
            "statusFile"
          ],
          "line": 133
        },
        "resolved": true,
        "details": {
          "function_name": "finalize",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "55-60",
          "snippet": "void finalize(kj::StringPtr path) {\n    KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n    KJ_SYSCALL(fsync(fd));\n    KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n    finalized = true;\n  }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  void finalize(kj::StringPtr path) {\n      KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n      KJ_SYSCALL(fsync(fd));\n      KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n      finalized = true;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "capnp::writeMessageToFd",
          "args": [
            "newStatus.getFd()",
            "statusMessage"
          ],
          "line": 132
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "newStatus.getFd",
          "args": [],
          "line": 132
        },
        "resolved": true,
        "details": {
          "function_name": "getFd",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "62-62",
          "snippet": "int getFd() { return fd; }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  int getFd() { return fd; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "status.setPublishDate",
          "args": [
            "time(nullptr)"
          ],
          "line": 128
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "time",
          "args": [
            "nullptr"
          ],
          "line": 128
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.isApproved",
          "args": [],
          "line": 127
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.getRequestState",
          "args": [],
          "line": 126
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "status.getPublishDate",
          "args": [],
          "line": 125
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "func",
          "args": [
            "status"
          ],
          "line": 124
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "statusMessage.getRoot<SubmissionStatus>",
          "args": [],
          "line": 123
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::readMessageCopyFromFd",
          "args": [
            "raiiOpen(statusFile, O_RDONLY)",
            "statusMessage"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "raiiOpen",
          "args": [
            "statusFile",
            "O_RDONLY"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "packageDir",
            "\"/status\""
          ],
          "line": 120
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "access(spkFile.cStr(), F_OK)",
            "\"no such package; try uploading it again\""
          ],
          "line": 117
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "spkFile.cStr()",
            "F_OK"
          ],
          "line": 117
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "spkFile.cStr",
          "args": [],
          "line": 117
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "packageDir",
            "\"/spk\""
          ],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageId"
          ],
          "line": 115
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "isalnum(c)",
            "\"invalid package ID\"",
            "packageId"
          ],
          "line": 112
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "isalnum",
          "args": [
            "c"
          ],
          "line": 112
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "packageId.size() == 32",
            "\"invalid package ID\"",
            "packageId"
          ],
          "line": 110
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "packageId.size",
          "args": [],
          "line": 110
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nstatic bool updatePackageStatus(kj::StringPtr packageId, Func&& func) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n  KJ_SYSCALL(access(spkFile.cStr(), F_OK),\n             \"no such package; try uploading it again\");\n\n  auto statusFile = kj::str(packageDir, \"/status\");\n  capnp::MallocMessageBuilder statusMessage;\n  capnp::readMessageCopyFromFd(raiiOpen(statusFile, O_RDONLY), statusMessage);\n  auto status = statusMessage.getRoot<SubmissionStatus>();\n  if (!func(status)) return false;\n  if (status.getPublishDate() == 0 &&\n      status.getRequestState() == SubmissionState::PUBLISH &&\n      status.isApproved()) {\n    status.setPublishDate(time(nullptr));\n  }\n\n  StagingFile newStatus(packageDir);\n  capnp::writeMessageToFd(newStatus.getFd(), statusMessage);\n  newStatus.finalize(statusFile);\n  return true;\n}"
  },
  {
    "function_name": "tryGetPublicKey",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "78-106",
    "snippet": "bool Indexer::tryGetPublicKey(kj::StringPtr packageId, byte publicKey[crypto_sign_PUBLICKEYBYTES]) {\n  KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n  for (auto c: packageId) {\n    KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n  }\n\n  auto packageDir = kj::str(\"/var/packages/\", packageId);\n  auto spkFile = kj::str(packageDir, \"/spk\");\n\n  while (access(spkFile.cStr(), F_OK) < 0) {\n    int error = errno;\n    if (error == ENOENT) {\n      return false;\n    } else if (error != EINTR) {\n      KJ_FAIL_SYSCALL(\"access(spkFile, F_OK)\", error, spkFile);\n    }\n  }\n\n  auto infoFile = kj::str(packageDir, \"/metadata\");\n  capnp::StreamFdMessageReader infoMessage(raiiOpen(infoFile, O_RDONLY));\n\n  auto bytes = capnp::AnyStruct::Reader(\n      infoMessage.getRoot<spk::VerifiedInfo>().getAppId()).getDataSection();\n  KJ_ASSERT(bytes.size() == crypto_sign_PUBLICKEYBYTES);\n  static_assert(crypto_sign_PUBLICKEYBYTES == APP_ID_BYTE_SIZE, \"app ID size changed?\");\n  memcpy(publicKey, sandstorm::getPublicKeyForApp(bytes).begin(), crypto_sign_PUBLICKEYBYTES);\n\n  return true;\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "publicKey",
            "sandstorm::getPublicKeyForApp(bytes).begin()",
            "crypto_sign_PUBLICKEYBYTES"
          ],
          "line": 103
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sandstorm::getPublicKeyForApp",
          "args": [],
          "line": 103
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sandstorm::getPublicKeyForApp",
          "args": [
            "bytes"
          ],
          "line": 103
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_ASSERT",
          "args": [
            "bytes.size() == crypto_sign_PUBLICKEYBYTES"
          ],
          "line": 101
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bytes.size",
          "args": [],
          "line": 101
        },
        "resolved": true,
        "details": {
          "function_name": "size",
          "container": "StructyMessage",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/util.h",
          "lines": "139-139",
          "snippet": "size_t size() { return pos - bytes; }",
          "includes": [
            "#include <set>",
            "#include <sandstorm/util.capnp.h>",
            "#include <capnp/rpc-twoparty.h>",
            "#include <kj/async.h>",
            "#include <kj/function.h>",
            "#include <unistd.h>",
            "#include <kj/vector.h>",
            "#include <kj/debug.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include <sys/stat.h>",
            "#include <kj/one-of.h>",
            "#include <kj/io.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <set>\n#include <sandstorm/util.capnp.h>\n#include <capnp/rpc-twoparty.h>\n#include <kj/async.h>\n#include <kj/function.h>\n#include <unistd.h>\n#include <kj/vector.h>\n#include <kj/debug.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <kj/one-of.h>\n#include <kj/io.h>\n\nStructyMessage {\n  size_t size() { return pos - bytes; }\n}"
        }
      },
      {
        "call_info": {
          "callee": "capnp::AnyStruct::Reader",
          "args": [],
          "line": 99
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::AnyStruct::Reader",
          "args": [
            "infoMessage.getRoot<spk::VerifiedInfo>().getAppId()"
          ],
          "line": 99
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "infoMessage.getRoot<spk::VerifiedInfo>",
          "args": [],
          "line": 100
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "infoMessage.getRoot<spk::VerifiedInfo>",
          "args": [],
          "line": 100
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "packageDir",
            "\"/metadata\""
          ],
          "line": 96
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_FAIL_SYSCALL",
          "args": [
            "\"access(spkFile, F_OK)\"",
            "error",
            "spkFile"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "access",
          "args": [
            "spkFile.cStr()",
            "F_OK"
          ],
          "line": 87
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "spkFile.cStr",
          "args": [],
          "line": 87
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "packageDir",
            "\"/spk\""
          ],
          "line": 85
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/packages/\"",
            "packageId"
          ],
          "line": 84
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "isalnum(c)",
            "\"invalid package ID\"",
            "packageId"
          ],
          "line": 81
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "isalnum",
          "args": [
            "c"
          ],
          "line": 81
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "packageId.size() == 32",
            "\"invalid package ID\"",
            "packageId"
          ],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  bool Indexer::tryGetPublicKey(kj::StringPtr packageId, byte publicKey[crypto_sign_PUBLICKEYBYTES]) {\n    KJ_REQUIRE(packageId.size() == 32, \"invalid package ID\", packageId);\n    for (auto c: packageId) {\n      KJ_REQUIRE(isalnum(c), \"invalid package ID\", packageId);\n    }\n  \n    auto packageDir = kj::str(\"/var/packages/\", packageId);\n    auto spkFile = kj::str(packageDir, \"/spk\");\n  \n    while (access(spkFile.cStr(), F_OK) < 0) {\n      int error = errno;\n      if (error == ENOENT) {\n        return false;\n      } else if (error != EINTR) {\n        KJ_FAIL_SYSCALL(\"access(spkFile, F_OK)\", error, spkFile);\n      }\n    }\n  \n    auto infoFile = kj::str(packageDir, \"/metadata\");\n    capnp::StreamFdMessageReader infoMessage(raiiOpen(infoFile, O_RDONLY));\n  \n    auto bytes = capnp::AnyStruct::Reader(\n        infoMessage.getRoot<spk::VerifiedInfo>().getAppId()).getDataSection();\n    KJ_ASSERT(bytes.size() == crypto_sign_PUBLICKEYBYTES);\n    static_assert(crypto_sign_PUBLICKEYBYTES == APP_ID_BYTE_SIZE, \"app ID size changed?\");\n    memcpy(publicKey, sandstorm::getPublicKeyForApp(bytes).begin(), crypto_sign_PUBLICKEYBYTES);\n  \n    return true;\n  }\n}"
  },
  {
    "function_name": "addKeybaseProfile",
    "container": "Indexer",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "72-76",
    "snippet": "void Indexer::addKeybaseProfile(kj::StringPtr fingerprint, capnp::MallocMessageBuilder& message) {\n  StagingFile file(\"/var/keybase\");\n  capnp::writeMessageToFd(file.getFd(), message);\n  file.finalize(kj::str(\"/var/keybase/\", fingerprint));\n}",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "file.finalize",
          "args": [
            "kj::str(\"/var/keybase/\", fingerprint)"
          ],
          "line": 75
        },
        "resolved": true,
        "details": {
          "function_name": "finalize",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "55-60",
          "snippet": "void finalize(kj::StringPtr path) {\n    KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n    KJ_SYSCALL(fsync(fd));\n    KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n    finalized = true;\n  }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  void finalize(kj::StringPtr path) {\n      KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n      KJ_SYSCALL(fsync(fd));\n      KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n      finalized = true;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "\"/var/keybase/\"",
            "fingerprint"
          ],
          "line": 75
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "capnp::writeMessageToFd",
          "args": [
            "file.getFd()",
            "message"
          ],
          "line": 74
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "file.getFd",
          "args": [],
          "line": 74
        },
        "resolved": true,
        "details": {
          "function_name": "getFd",
          "container": "StagingFile",
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
          "lines": "62-62",
          "snippet": "int getFd() { return fd; }",
          "includes": [
            "#include <stdio.h>  // rename()",
            "#include <capnp/compat/json.h>",
            "#include <capnp/schema.h>",
            "#include <time.h>",
            "#include <sodium/crypto_sign.h>",
            "#include <sodium/crypto_generichash_blake2b.h>",
            "#include <map>",
            "#include <stdlib.h>",
            "#include <capnp/serialize.h>",
            "#include <sandstorm/appid-replacements.h>",
            "#include <sandstorm/id-to-text.h>",
            "#include <sandstorm/spk.h>",
            "#include <sandstorm/app-index/app-index.capnp.h>",
            "#include \"indexer.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  int getFd() { return fd; }\n}"
        }
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nIndexer {\n  void Indexer::addKeybaseProfile(kj::StringPtr fingerprint, capnp::MallocMessageBuilder& message) {\n    StagingFile file(\"/var/keybase\");\n    capnp::writeMessageToFd(file.getFd(), message);\n    file.finalize(kj::str(\"/var/keybase/\", fingerprint));\n  }\n}"
  },
  {
    "function_name": "getFd",
    "container": "StagingFile",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "62-62",
    "snippet": "int getFd() { return fd; }",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  int getFd() { return fd; }\n}"
  },
  {
    "function_name": "finalize",
    "container": "StagingFile",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "55-60",
    "snippet": "void finalize(kj::StringPtr path) {\n    KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n    KJ_SYSCALL(fsync(fd));\n    KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n    finalized = true;\n  }",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "rename(name.cStr(), path.cStr())"
          ],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rename",
          "args": [
            "name.cStr()",
            "path.cStr()"
          ],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "path.cStr",
          "args": [],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "name.cStr",
          "args": [],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fsync(fd)"
          ],
          "line": 57
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fsync",
          "args": [
            "fd"
          ],
          "line": 57
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_REQUIRE",
          "args": [
            "!finalized",
            "\"can't call finalize() twice\""
          ],
          "line": 56
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  void finalize(kj::StringPtr path) {\n      KJ_REQUIRE(!finalized, \"can't call finalize() twice\");\n      KJ_SYSCALL(fsync(fd));\n      KJ_SYSCALL(rename(name.cStr(), path.cStr()));\n      finalized = true;\n    }\n}"
  },
  {
    "function_name": "StagingFile",
    "container": "StagingFile",
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2017-6200/repo/src/sandstorm/app-index/indexer.c++",
    "lines": "41-46",
    "snippet": "explicit StagingFile(kj::StringPtr targetDir)\n      : name(kj::str(targetDir, \"/.tmp.XXXXXX\")) {\n    int fd_;\n    KJ_SYSCALL(fd_ = mkstemp(name.begin()));\n    fd = kj::AutoCloseFd(fd_);\n  }",
    "includes": [
      "#include <stdio.h>  // rename()",
      "#include <capnp/compat/json.h>",
      "#include <capnp/schema.h>",
      "#include <time.h>",
      "#include <sodium/crypto_sign.h>",
      "#include <sodium/crypto_generichash_blake2b.h>",
      "#include <map>",
      "#include <stdlib.h>",
      "#include <capnp/serialize.h>",
      "#include <sandstorm/appid-replacements.h>",
      "#include <sandstorm/id-to-text.h>",
      "#include <sandstorm/spk.h>",
      "#include <sandstorm/app-index/app-index.capnp.h>",
      "#include \"indexer.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kj::AutoCloseFd",
          "args": [
            "fd_"
          ],
          "line": 45
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KJ_SYSCALL",
          "args": [
            "fd_ = mkstemp(name.begin())"
          ],
          "line": 44
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mkstemp",
          "args": [
            "name.begin()"
          ],
          "line": 44
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "name.begin",
          "args": [],
          "line": 44
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kj::str",
          "args": [
            "targetDir",
            "\"/.tmp.XXXXXX\""
          ],
          "line": 42
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <stdio.h>  // rename()\n#include <capnp/compat/json.h>\n#include <capnp/schema.h>\n#include <time.h>\n#include <sodium/crypto_sign.h>\n#include <sodium/crypto_generichash_blake2b.h>\n#include <map>\n#include <stdlib.h>\n#include <capnp/serialize.h>\n#include <sandstorm/appid-replacements.h>\n#include <sandstorm/id-to-text.h>\n#include <sandstorm/spk.h>\n#include <sandstorm/app-index/app-index.capnp.h>\n#include \"indexer.h\"\n\nStagingFile {\n  explicit StagingFile(kj::StringPtr targetDir)\n        : name(kj::str(targetDir, \"/.tmp.XXXXXX\")) {\n      int fd_;\n      KJ_SYSCALL(fd_ = mkstemp(name.begin()));\n      fd = kj::AutoCloseFd(fd_);\n    }\n}"
  }
]