[
  {
    "function_name": "git_win32_get_error_message",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2016-10130/repo/src/win32/error.c",
    "lines": "16-53",
    "snippet": "char *git_win32_get_error_message(DWORD error_code)\n{\n\tLPWSTR lpMsgBuf = NULL;\n\tHMODULE hModule = NULL;\n\tchar *utf8_msg = NULL;\n\tDWORD dwFlags =\n\t\tFORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_IGNORE_INSERTS;\n\n\tif (!error_code)\n\t\treturn NULL;\n\n#ifdef GIT_WINHTTP\n\t/* Errors raised by WinHTTP are not in the system resource table */\n\tif (error_code >= WINHTTP_ERROR_BASE &&\n\t\terror_code <= WINHTTP_ERROR_LAST)\n\t\thModule = GetModuleHandleW(L\"winhttp\");\n#endif\n\n\tGIT_UNUSED(hModule);\n\n\tif (hModule)\n\t\tdwFlags |= FORMAT_MESSAGE_FROM_HMODULE;\n\telse\n\t\tdwFlags |= FORMAT_MESSAGE_FROM_SYSTEM;\n\n\tif (FormatMessageW(dwFlags, hModule, error_code,\n\t\tMAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),\n\t\t(LPWSTR)&lpMsgBuf, 0, NULL)) {\n\t\t/* Convert the message to UTF-8. If this fails, we will\n\t\t * return NULL, which is a condition expected by the caller */\n\t\tif (git__utf16_to_8_alloc(&utf8_msg, lpMsgBuf) < 0)\n\t\t\tutf8_msg = NULL;\n\n\t\tLocalFree(lpMsgBuf);\n\t}\n\n\treturn utf8_msg;\n}",
    "includes": [
      "# include <winhttp.h>",
      "#include \"utf-conv.h\"",
      "#include \"error.h\"",
      "#include \"common.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "LocalFree",
          "args": [
            "lpMsgBuf"
          ],
          "line": 49
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "git__utf16_to_8_alloc",
          "args": [
            "&utf8_msg",
            "lpMsgBuf"
          ],
          "line": 46
        },
        "resolved": true,
        "details": {
          "function_name": "git__utf16_to_8_alloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2016-10130/repo/src/win32/utf-conv.c",
          "lines": "113-147",
          "snippet": "int git__utf16_to_8_alloc(char **dest, const wchar_t *src)\n{\n\tint utf8_size;\n\n\t*dest = NULL;\n\n\t/* Length of -1 indicates NULL termination of the input string */\n\tutf8_size = WideCharToMultiByte(CP_UTF8, WC_ERR_INVALID_CHARS, src, -1, NULL, 0, NULL, NULL);\n\n\tif (!utf8_size) {\n\t\tgit__set_errno();\n\t\treturn -1;\n\t}\n\n\t*dest = git__malloc(utf8_size);\n\n\tif (!*dest) {\n\t\terrno = ENOMEM;\n\t\treturn -1;\n\t}\n\n\tutf8_size = WideCharToMultiByte(CP_UTF8, WC_ERR_INVALID_CHARS, src, -1, *dest, utf8_size, NULL, NULL);\n\n\tif (!utf8_size) {\n\t\tgit__set_errno();\n\n\t\tgit__free(*dest);\n\t\t*dest = NULL;\n\t}\n\n\t/* Subtract 1 from the result to turn 0 into -1 (an error code) and to not count the NULL\n\t * terminator as part of the string's length. MultiByteToWideChar never returns int's minvalue,\n\t * so underflow is not possible */\n\treturn utf8_size - 1;\n}",
          "includes": [
            "#include \"utf-conv.h\"",
            "#include \"common.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"utf-conv.h\"\n#include \"common.h\"\n\nint git__utf16_to_8_alloc(char **dest, const wchar_t *src)\n{\n\tint utf8_size;\n\n\t*dest = NULL;\n\n\t/* Length of -1 indicates NULL termination of the input string */\n\tutf8_size = WideCharToMultiByte(CP_UTF8, WC_ERR_INVALID_CHARS, src, -1, NULL, 0, NULL, NULL);\n\n\tif (!utf8_size) {\n\t\tgit__set_errno();\n\t\treturn -1;\n\t}\n\n\t*dest = git__malloc(utf8_size);\n\n\tif (!*dest) {\n\t\terrno = ENOMEM;\n\t\treturn -1;\n\t}\n\n\tutf8_size = WideCharToMultiByte(CP_UTF8, WC_ERR_INVALID_CHARS, src, -1, *dest, utf8_size, NULL, NULL);\n\n\tif (!utf8_size) {\n\t\tgit__set_errno();\n\n\t\tgit__free(*dest);\n\t\t*dest = NULL;\n\t}\n\n\t/* Subtract 1 from the result to turn 0 into -1 (an error code) and to not count the NULL\n\t * terminator as part of the string's length. MultiByteToWideChar never returns int's minvalue,\n\t * so underflow is not possible */\n\treturn utf8_size - 1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "FormatMessageW",
          "args": [
            "dwFlags",
            "hModule",
            "error_code",
            "MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT)",
            "(LPWSTR)&lpMsgBuf",
            "0",
            "NULL"
          ],
          "line": 41
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAKELANGID",
          "args": [
            "LANG_NEUTRAL",
            "SUBLANG_DEFAULT"
          ],
          "line": 42
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GIT_UNUSED",
          "args": [
            "hModule"
          ],
          "line": 34
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GetModuleHandleW",
          "args": [
            "L\"winhttp\""
          ],
          "line": 31
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "# include <winhttp.h>\n#include \"utf-conv.h\"\n#include \"error.h\"\n#include \"common.h\"\n\nchar *git_win32_get_error_message(DWORD error_code)\n{\n\tLPWSTR lpMsgBuf = NULL;\n\tHMODULE hModule = NULL;\n\tchar *utf8_msg = NULL;\n\tDWORD dwFlags =\n\t\tFORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_IGNORE_INSERTS;\n\n\tif (!error_code)\n\t\treturn NULL;\n\n#ifdef GIT_WINHTTP\n\t/* Errors raised by WinHTTP are not in the system resource table */\n\tif (error_code >= WINHTTP_ERROR_BASE &&\n\t\terror_code <= WINHTTP_ERROR_LAST)\n\t\thModule = GetModuleHandleW(L\"winhttp\");\n#endif\n\n\tGIT_UNUSED(hModule);\n\n\tif (hModule)\n\t\tdwFlags |= FORMAT_MESSAGE_FROM_HMODULE;\n\telse\n\t\tdwFlags |= FORMAT_MESSAGE_FROM_SYSTEM;\n\n\tif (FormatMessageW(dwFlags, hModule, error_code,\n\t\tMAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),\n\t\t(LPWSTR)&lpMsgBuf, 0, NULL)) {\n\t\t/* Convert the message to UTF-8. If this fails, we will\n\t\t * return NULL, which is a condition expected by the caller */\n\t\tif (git__utf16_to_8_alloc(&utf8_msg, lpMsgBuf) < 0)\n\t\t\tutf8_msg = NULL;\n\n\t\tLocalFree(lpMsgBuf);\n\t}\n\n\treturn utf8_msg;\n}"
  }
]