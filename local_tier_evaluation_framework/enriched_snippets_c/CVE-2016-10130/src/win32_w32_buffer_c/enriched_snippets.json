[
  {
    "function_name": "git_buf_put_w",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2016-10130/repo/src/win32/w32_buffer.c",
    "lines": "23-54",
    "snippet": "int git_buf_put_w(git_buf *buf, const wchar_t *string_w, size_t len_w)\n{\n\tint utf8_len, utf8_write_len;\n\tsize_t new_size;\n\n\tif (!len_w)\n\t\treturn 0;\n\n\tassert(string_w);\n\n\t/* Measure the string necessary for conversion */\n\tif ((utf8_len = WideCharToMultiByte(CP_UTF8, WC_ERR_INVALID_CHARS, string_w, len_w, NULL, 0, NULL, NULL)) == 0)\n\t\treturn 0;\n\n\tassert(utf8_len > 0);\n\n\tGITERR_CHECK_ALLOC_ADD(&new_size, buf->size, (size_t)utf8_len);\n\tGITERR_CHECK_ALLOC_ADD(&new_size, new_size, 1);\n\n\tif (git_buf_grow(buf, new_size) < 0)\n\t\treturn -1;\n\n\tif ((utf8_write_len = WideCharToMultiByte(\n\t\t\tCP_UTF8, WC_ERR_INVALID_CHARS, string_w, len_w, &buf->ptr[buf->size], utf8_len, NULL, NULL)) == 0)\n\t\treturn handle_wc_error();\n\n\tassert(utf8_write_len == utf8_len);\n\n\tbuf->size += utf8_write_len;\n\tbuf->ptr[buf->size] = '\\0';\n\treturn 0;\n}",
    "includes": [
      "#include \"utf-conv.h\"",
      "#include \"../buffer.h\"",
      "#include \"w32_buffer.h\"",
      "#include \"common.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "assert",
          "args": [
            "utf8_write_len == utf8_len"
          ],
          "line": 49
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "handle_wc_error",
          "args": [],
          "line": 47
        },
        "resolved": true,
        "details": {
          "function_name": "handle_wc_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2016-10130/repo/src/win32/w32_buffer.c",
          "lines": "13-21",
          "snippet": "GIT_INLINE(int) handle_wc_error(void)\n{\n\tif (GetLastError() == ERROR_INSUFFICIENT_BUFFER)\n\t\terrno = ENAMETOOLONG;\n\telse\n\t\terrno = EINVAL;\n\n\treturn -1;\n}",
          "includes": [
            "#include \"utf-conv.h\"",
            "#include \"../buffer.h\"",
            "#include \"w32_buffer.h\"",
            "#include \"common.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"utf-conv.h\"\n#include \"../buffer.h\"\n#include \"w32_buffer.h\"\n#include \"common.h\"\n\nGIT_INLINE(int) handle_wc_error(void)\n{\n\tif (GetLastError() == ERROR_INSUFFICIENT_BUFFER)\n\t\terrno = ENAMETOOLONG;\n\telse\n\t\terrno = EINVAL;\n\n\treturn -1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "WideCharToMultiByte",
          "args": [
            "CP_UTF8",
            "WC_ERR_INVALID_CHARS",
            "string_w",
            "len_w",
            "&buf->ptr[buf->size]",
            "utf8_len",
            "NULL",
            "NULL"
          ],
          "line": 45
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "git_buf_grow",
          "args": [
            "buf",
            "new_size"
          ],
          "line": 42
        },
        "resolved": true,
        "details": {
          "function_name": "git_buf_grow_by",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2016-10130/repo/src/buffer.c",
          "lines": "106-116",
          "snippet": "int git_buf_grow_by(git_buf *buffer, size_t additional_size)\n{\n\tsize_t newsize;\n\n\tif (GIT_ADD_SIZET_OVERFLOW(&newsize, buffer->size, additional_size)) {\n\t\tbuffer->ptr = git_buf__oom;\n\t\treturn -1;\n\t}\n\n\treturn git_buf_try_grow(buffer, newsize, true);\n}",
          "includes": [
            "#include <ctype.h>",
            "#include \"buf_text.h\"",
            "#include \"git2/buffer.h\"",
            "#include \"posix.h\"",
            "#include \"buffer.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "char git_buf__oom[1];"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <ctype.h>\n#include \"buf_text.h\"\n#include \"git2/buffer.h\"\n#include \"posix.h\"\n#include \"buffer.h\"\n\nchar git_buf__oom[1];\n\nint git_buf_grow_by(git_buf *buffer, size_t additional_size)\n{\n\tsize_t newsize;\n\n\tif (GIT_ADD_SIZET_OVERFLOW(&newsize, buffer->size, additional_size)) {\n\t\tbuffer->ptr = git_buf__oom;\n\t\treturn -1;\n\t}\n\n\treturn git_buf_try_grow(buffer, newsize, true);\n}"
        }
      },
      {
        "call_info": {
          "callee": "GITERR_CHECK_ALLOC_ADD",
          "args": [
            "&new_size",
            "new_size",
            "1"
          ],
          "line": 40
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "GITERR_CHECK_ALLOC_ADD",
          "args": [
            "&new_size",
            "buf->size",
            "(size_t)utf8_len"
          ],
          "line": 39
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "assert",
          "args": [
            "utf8_len > 0"
          ],
          "line": 37
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "WideCharToMultiByte",
          "args": [
            "CP_UTF8",
            "WC_ERR_INVALID_CHARS",
            "string_w",
            "len_w",
            "NULL",
            "0",
            "NULL",
            "NULL"
          ],
          "line": 34
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "assert",
          "args": [
            "string_w"
          ],
          "line": 31
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"utf-conv.h\"\n#include \"../buffer.h\"\n#include \"w32_buffer.h\"\n#include \"common.h\"\n\nint git_buf_put_w(git_buf *buf, const wchar_t *string_w, size_t len_w)\n{\n\tint utf8_len, utf8_write_len;\n\tsize_t new_size;\n\n\tif (!len_w)\n\t\treturn 0;\n\n\tassert(string_w);\n\n\t/* Measure the string necessary for conversion */\n\tif ((utf8_len = WideCharToMultiByte(CP_UTF8, WC_ERR_INVALID_CHARS, string_w, len_w, NULL, 0, NULL, NULL)) == 0)\n\t\treturn 0;\n\n\tassert(utf8_len > 0);\n\n\tGITERR_CHECK_ALLOC_ADD(&new_size, buf->size, (size_t)utf8_len);\n\tGITERR_CHECK_ALLOC_ADD(&new_size, new_size, 1);\n\n\tif (git_buf_grow(buf, new_size) < 0)\n\t\treturn -1;\n\n\tif ((utf8_write_len = WideCharToMultiByte(\n\t\t\tCP_UTF8, WC_ERR_INVALID_CHARS, string_w, len_w, &buf->ptr[buf->size], utf8_len, NULL, NULL)) == 0)\n\t\treturn handle_wc_error();\n\n\tassert(utf8_write_len == utf8_len);\n\n\tbuf->size += utf8_write_len;\n\tbuf->ptr[buf->size] = '\\0';\n\treturn 0;\n}"
  },
  {
    "function_name": "handle_wc_error",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2016-10130/repo/src/win32/w32_buffer.c",
    "lines": "13-21",
    "snippet": "GIT_INLINE(int) handle_wc_error(void)\n{\n\tif (GetLastError() == ERROR_INSUFFICIENT_BUFFER)\n\t\terrno = ENAMETOOLONG;\n\telse\n\t\terrno = EINVAL;\n\n\treturn -1;\n}",
    "includes": [
      "#include \"utf-conv.h\"",
      "#include \"../buffer.h\"",
      "#include \"w32_buffer.h\"",
      "#include \"common.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "GetLastError",
          "args": [],
          "line": 15
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"utf-conv.h\"\n#include \"../buffer.h\"\n#include \"w32_buffer.h\"\n#include \"common.h\"\n\nGIT_INLINE(int) handle_wc_error(void)\n{\n\tif (GetLastError() == ERROR_INSUFFICIENT_BUFFER)\n\t\terrno = ENAMETOOLONG;\n\telse\n\t\terrno = EINVAL;\n\n\treturn -1;\n}"
  }
]