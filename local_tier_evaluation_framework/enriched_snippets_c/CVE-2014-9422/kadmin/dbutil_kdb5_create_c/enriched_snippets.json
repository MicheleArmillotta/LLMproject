[
  {
    "function_name": "add_principal",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/dbutil/kdb5_create.c",
    "lines": "373-445",
    "snippet": "static krb5_error_code\nadd_principal(context, princ, op, pblock)\n    krb5_context context;\n    krb5_principal princ;\n    enum ap_op op;\n    struct realm_info *pblock;\n{\n    krb5_error_code \t  retval;\n    krb5_db_entry \t  entry;\n\n    krb5_timestamp\t  now;\n    struct iterate_args\t  iargs;\n\n    int\t\t\t  nentries = 1;\n\n    memset((char *) &entry, 0, sizeof(entry));\n\n    entry.len = KRB5_KDB_V1_BASE_LENGTH;\n    entry.attributes = pblock->flags;\n    entry.max_life = pblock->max_life;\n    entry.max_renewable_life = pblock->max_rlife;\n    entry.expiration = pblock->expiration;\n\n    if ((retval = krb5_copy_principal(context, princ, &entry.princ)))\n\tgoto error_out;\n\n    if ((retval = krb5_timeofday(context, &now)))\n\tgoto error_out;\n\n    if ((retval = krb5_dbe_update_mod_princ_data(context, &entry,\n\t\t\t\t\t\t now, &db_create_princ)))\n\tgoto error_out;\n\n    switch (op) {\n    case MASTER_KEY:\n\tif ((entry.key_data=(krb5_key_data*)malloc(sizeof(krb5_key_data)))\n\t    == NULL)\n\t    goto error_out;\n\tmemset((char *) entry.key_data, 0, sizeof(krb5_key_data));\n\tentry.n_key_data = 1;\n\n\tentry.attributes |= KRB5_KDB_DISALLOW_ALL_TIX;\n\tif ((retval = krb5_dbekd_encrypt_key_data(context, pblock->key,\n\t\t\t\t\t\t  &master_keyblock, NULL, \n\t\t\t\t\t\t  1, entry.key_data)))\n\t    return retval;\n\tbreak;\n    case TGT_KEY:\n\tiargs.ctx = context;\n\tiargs.rblock = pblock;\n\tiargs.dbentp = &entry;\n\t/*\n\t * Iterate through the key/salt list, ignoring salt types.\n\t */\n\tif ((retval = krb5_keysalt_iterate(pblock->kslist,\n\t\t\t\t\t   pblock->nkslist,\n\t\t\t\t\t   1,\n\t\t\t\t\t   tgt_keysalt_iterate,\n\t\t\t\t\t   (krb5_pointer) &iargs)))\n\t    return retval;\n\tbreak;\n    case NULL_KEY:\n\treturn EOPNOTSUPP;\n    default:\n\tbreak;\n    }\n\n    retval = krb5_db_put_principal(context, &entry, &nentries);\n\nerror_out:;\n    krb5_dbe_free_contents(context, &entry);\n    return retval;\n}",
    "includes": [
      "#include \"kdb5_util.h\"",
      "#include <krb5/adm_proto.h>",
      "#include <kadm5/adb.h>",
      "#include <kadm5/admin.h>",
      "#include <k5-int.h>",
      "#include <stdio.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "struct realm_info {\n    krb5_deltat max_life;\n    krb5_deltat max_rlife;\n    krb5_timestamp expiration;\n    krb5_flags flags;\n    krb5_keyblock *key;\n    krb5_int32 nkslist;\n    krb5_key_salt_tuple *kslist;\n} rblock = { /* XXX */\n    KRB5_KDB_MAX_LIFE,\n    KRB5_KDB_MAX_RLIFE,\n    KRB5_KDB_EXPIRATION,\n    KRB5_KDB_DEF_FLAGS,\n    (krb5_keyblock *) NULL,\n    1,\n    &def_kslist\n};",
      "static krb5_error_code add_principal \n\t(krb5_context,\n\t krb5_principal,\n\t enum ap_op,\n\t struct realm_info *);",
      "extern krb5_keyblock master_keyblock;",
      "krb5_principal_data db_create_princ = {\n        0,\t\t\t\t\t/* magic number */\n\t{0, 0, 0},\t\t\t\t/* krb5_data realm */\n\tdb_creator_entries,\t\t\t/* krb5_data *data */\n\t1,\t\t\t\t\t/* int length */\n\tKRB5_NT_SRV_INST\t\t\t/* int type */\n};"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "krb5_dbe_free_contents",
          "args": [
            "context",
            "&entry"
          ],
          "line": 443
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_put_principal",
          "args": [
            "context",
            "&entry",
            "&nentries"
          ],
          "line": 440
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_keysalt_iterate",
          "args": [
            "pblock->kslist",
            "pblock->nkslist",
            "1",
            "tgt_keysalt_iterate",
            "(krb5_pointer) &iargs"
          ],
          "line": 427
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_dbekd_encrypt_key_data",
          "args": [
            "context",
            "pblock->key",
            "&master_keyblock",
            "NULL",
            "1",
            "entry.key_data"
          ],
          "line": 415
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "(char *) entry.key_data",
            "0",
            "sizeof(krb5_key_data)"
          ],
          "line": 411
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "sizeof(krb5_key_data)"
          ],
          "line": 408
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_dbe_update_mod_princ_data",
          "args": [
            "context",
            "&entry",
            "now",
            "&db_create_princ"
          ],
          "line": 402
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_timeofday",
          "args": [
            "context",
            "&now"
          ],
          "line": 399
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_copy_principal",
          "args": [
            "context",
            "princ",
            "&entry.princ"
          ],
          "line": 396
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "(char *) &entry",
            "0",
            "sizeof(entry)"
          ],
          "line": 388
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"kdb5_util.h\"\n#include <krb5/adm_proto.h>\n#include <kadm5/adb.h>\n#include <kadm5/admin.h>\n#include <k5-int.h>\n#include <stdio.h>\n\nstruct realm_info {\n    krb5_deltat max_life;\n    krb5_deltat max_rlife;\n    krb5_timestamp expiration;\n    krb5_flags flags;\n    krb5_keyblock *key;\n    krb5_int32 nkslist;\n    krb5_key_salt_tuple *kslist;\n} rblock = { /* XXX */\n    KRB5_KDB_MAX_LIFE,\n    KRB5_KDB_MAX_RLIFE,\n    KRB5_KDB_EXPIRATION,\n    KRB5_KDB_DEF_FLAGS,\n    (krb5_keyblock *) NULL,\n    1,\n    &def_kslist\n};\nstatic krb5_error_code add_principal \n\t(krb5_context,\n\t krb5_principal,\n\t enum ap_op,\n\t struct realm_info *);\nextern krb5_keyblock master_keyblock;\nkrb5_principal_data db_create_princ = {\n        0,\t\t\t\t\t/* magic number */\n\t{0, 0, 0},\t\t\t\t/* krb5_data realm */\n\tdb_creator_entries,\t\t\t/* krb5_data *data */\n\t1,\t\t\t\t\t/* int length */\n\tKRB5_NT_SRV_INST\t\t\t/* int type */\n};\n\nstatic krb5_error_code\nadd_principal(context, princ, op, pblock)\n    krb5_context context;\n    krb5_principal princ;\n    enum ap_op op;\n    struct realm_info *pblock;\n{\n    krb5_error_code \t  retval;\n    krb5_db_entry \t  entry;\n\n    krb5_timestamp\t  now;\n    struct iterate_args\t  iargs;\n\n    int\t\t\t  nentries = 1;\n\n    memset((char *) &entry, 0, sizeof(entry));\n\n    entry.len = KRB5_KDB_V1_BASE_LENGTH;\n    entry.attributes = pblock->flags;\n    entry.max_life = pblock->max_life;\n    entry.max_renewable_life = pblock->max_rlife;\n    entry.expiration = pblock->expiration;\n\n    if ((retval = krb5_copy_principal(context, princ, &entry.princ)))\n\tgoto error_out;\n\n    if ((retval = krb5_timeofday(context, &now)))\n\tgoto error_out;\n\n    if ((retval = krb5_dbe_update_mod_princ_data(context, &entry,\n\t\t\t\t\t\t now, &db_create_princ)))\n\tgoto error_out;\n\n    switch (op) {\n    case MASTER_KEY:\n\tif ((entry.key_data=(krb5_key_data*)malloc(sizeof(krb5_key_data)))\n\t    == NULL)\n\t    goto error_out;\n\tmemset((char *) entry.key_data, 0, sizeof(krb5_key_data));\n\tentry.n_key_data = 1;\n\n\tentry.attributes |= KRB5_KDB_DISALLOW_ALL_TIX;\n\tif ((retval = krb5_dbekd_encrypt_key_data(context, pblock->key,\n\t\t\t\t\t\t  &master_keyblock, NULL, \n\t\t\t\t\t\t  1, entry.key_data)))\n\t    return retval;\n\tbreak;\n    case TGT_KEY:\n\tiargs.ctx = context;\n\tiargs.rblock = pblock;\n\tiargs.dbentp = &entry;\n\t/*\n\t * Iterate through the key/salt list, ignoring salt types.\n\t */\n\tif ((retval = krb5_keysalt_iterate(pblock->kslist,\n\t\t\t\t\t   pblock->nkslist,\n\t\t\t\t\t   1,\n\t\t\t\t\t   tgt_keysalt_iterate,\n\t\t\t\t\t   (krb5_pointer) &iargs)))\n\t    return retval;\n\tbreak;\n    case NULL_KEY:\n\treturn EOPNOTSUPP;\n    default:\n\tbreak;\n    }\n\n    retval = krb5_db_put_principal(context, &entry, &nentries);\n\nerror_out:;\n    krb5_dbe_free_contents(context, &entry);\n    return retval;\n}"
  },
  {
    "function_name": "tgt_keysalt_iterate",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/dbutil/kdb5_create.c",
    "lines": "329-371",
    "snippet": "static krb5_error_code\ntgt_keysalt_iterate(ksent, ptr)\n    krb5_key_salt_tuple\t*ksent;\n    krb5_pointer\tptr;\n{\n    krb5_context\tcontext;\n    krb5_error_code\tkret;\n    struct iterate_args\t*iargs;\n    krb5_keyblock\tkey;\n    krb5_int32\t\tind;\n    krb5_data\tpwd;\n\n    iargs = (struct iterate_args *) ptr;\n    kret = 0;\n\n    context = iargs->ctx;\n\n    /*\n     * Convert the master key password into a key for this particular\n     * encryption system.\n     */\n    pwd.data = mkey_password;\n    pwd.length = strlen(mkey_password);\n    kret = krb5_c_random_seed(context, &pwd);\n    if (kret)\n\treturn kret;\n\n    if (!(kret = krb5_dbe_create_key_data(iargs->ctx, iargs->dbentp))) {\n\tind = iargs->dbentp->n_key_data-1;\n\tif (!(kret = krb5_c_make_random_key(context, ksent->ks_enctype,\n\t\t\t\t\t    &key))) {\n\t    kret = krb5_dbekd_encrypt_key_data(context,\n\t\t\t\t\t       iargs->rblock->key,\n\t\t\t\t\t       &key, \n\t\t\t\t\t       NULL,\n\t\t\t\t\t       1,\n\t\t\t\t\t       &iargs->dbentp->key_data[ind]);\n\t    krb5_free_keyblock_contents(context, &key);\n\t}\n    }\n\n    return(kret);\n}",
    "includes": [
      "#include \"kdb5_util.h\"",
      "#include <krb5/adm_proto.h>",
      "#include <kadm5/adb.h>",
      "#include <kadm5/admin.h>",
      "#include <k5-int.h>",
      "#include <stdio.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "struct realm_info {\n    krb5_deltat max_life;\n    krb5_deltat max_rlife;\n    krb5_timestamp expiration;\n    krb5_flags flags;\n    krb5_keyblock *key;\n    krb5_int32 nkslist;\n    krb5_key_salt_tuple *kslist;\n} rblock = { /* XXX */\n    KRB5_KDB_MAX_LIFE,\n    KRB5_KDB_MAX_RLIFE,\n    KRB5_KDB_EXPIRATION,\n    KRB5_KDB_DEF_FLAGS,\n    (krb5_keyblock *) NULL,\n    1,\n    &def_kslist\n};",
      "extern char *mkey_password;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "krb5_free_keyblock_contents",
          "args": [
            "context",
            "&key"
          ],
          "line": 366
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_dbekd_encrypt_key_data",
          "args": [
            "context",
            "iargs->rblock->key",
            "&key",
            "NULL",
            "1",
            "&iargs->dbentp->key_data[ind]"
          ],
          "line": 360
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_c_make_random_key",
          "args": [
            "context",
            "ksent->ks_enctype",
            "&key"
          ],
          "line": 358
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_dbe_create_key_data",
          "args": [
            "iargs->ctx",
            "iargs->dbentp"
          ],
          "line": 356
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_c_random_seed",
          "args": [
            "context",
            "&pwd"
          ],
          "line": 352
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "mkey_password"
          ],
          "line": 351
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"kdb5_util.h\"\n#include <krb5/adm_proto.h>\n#include <kadm5/adb.h>\n#include <kadm5/admin.h>\n#include <k5-int.h>\n#include <stdio.h>\n\nstruct realm_info {\n    krb5_deltat max_life;\n    krb5_deltat max_rlife;\n    krb5_timestamp expiration;\n    krb5_flags flags;\n    krb5_keyblock *key;\n    krb5_int32 nkslist;\n    krb5_key_salt_tuple *kslist;\n} rblock = { /* XXX */\n    KRB5_KDB_MAX_LIFE,\n    KRB5_KDB_MAX_RLIFE,\n    KRB5_KDB_EXPIRATION,\n    KRB5_KDB_DEF_FLAGS,\n    (krb5_keyblock *) NULL,\n    1,\n    &def_kslist\n};\nextern char *mkey_password;\n\nstatic krb5_error_code\ntgt_keysalt_iterate(ksent, ptr)\n    krb5_key_salt_tuple\t*ksent;\n    krb5_pointer\tptr;\n{\n    krb5_context\tcontext;\n    krb5_error_code\tkret;\n    struct iterate_args\t*iargs;\n    krb5_keyblock\tkey;\n    krb5_int32\t\tind;\n    krb5_data\tpwd;\n\n    iargs = (struct iterate_args *) ptr;\n    kret = 0;\n\n    context = iargs->ctx;\n\n    /*\n     * Convert the master key password into a key for this particular\n     * encryption system.\n     */\n    pwd.data = mkey_password;\n    pwd.length = strlen(mkey_password);\n    kret = krb5_c_random_seed(context, &pwd);\n    if (kret)\n\treturn kret;\n\n    if (!(kret = krb5_dbe_create_key_data(iargs->ctx, iargs->dbentp))) {\n\tind = iargs->dbentp->n_key_data-1;\n\tif (!(kret = krb5_c_make_random_key(context, ksent->ks_enctype,\n\t\t\t\t\t    &key))) {\n\t    kret = krb5_dbekd_encrypt_key_data(context,\n\t\t\t\t\t       iargs->rblock->key,\n\t\t\t\t\t       &key, \n\t\t\t\t\t       NULL,\n\t\t\t\t\t       1,\n\t\t\t\t\t       &iargs->dbentp->key_data[ind]);\n\t    krb5_free_keyblock_contents(context, &key);\n\t}\n    }\n\n    return(kret);\n}"
  },
  {
    "function_name": "kdb5_create",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/dbutil/kdb5_create.c",
    "lines": "152-327",
    "snippet": "void kdb5_create(argc, argv)\n   int argc;\n   char *argv[];\n{\n    int optchar;\n\n    krb5_error_code retval;\n    char *mkey_fullname;\n    char *pw_str = 0;\n    unsigned int pw_size = 0;\n    int do_stash = 0;\n    krb5_int32 crflags = KRB5_KDB_CREATE_BTREE;\n    krb5_data pwd, seed;\n\t   \n    if (strrchr(argv[0], '/'))\n\targv[0] = strrchr(argv[0], '/')+1;\n\n    while ((optchar = getopt(argc, argv, \"s\")) != -1) {\n\tswitch(optchar) {\n\tcase 's':\n\t    do_stash++;\n\t    break;\n\tcase 'h':\n\t    crflags = KRB5_KDB_CREATE_HASH;\n\tcase '?':\n\tdefault:\n\t    usage();\n\t    return;\n\t}\n    }\n\n    rblock.max_life = global_params.max_life;\n    rblock.max_rlife = global_params.max_rlife;\n    rblock.expiration = global_params.expiration;\n    rblock.flags = global_params.flags;\n    rblock.nkslist = global_params.num_keysalts;\n    rblock.kslist = global_params.keysalts;\n\n    retval = krb5_db_set_name(util_context, global_params.dbname);\n    if (!retval) retval = EEXIST;\n\n    if (retval == EEXIST || retval == EACCES || retval == EPERM) {\n\t/* it exists ! */\n\tcom_err(argv[0], 0, \"The database '%s' appears to already exist\",\n\t\tglobal_params.dbname);\n\texit_status++; return;\n    }\n\n    printf (\"Loading random data\\n\");\n    retval = krb5_c_random_os_entropy (util_context, 1, NULL);\n    if (retval) {\n      com_err (argv[0], retval, \"Loading random data\");\n      exit_status++; return;\n    }\n    \n    /* assemble & parse the master key name */\n\n    if ((retval = krb5_db_setup_mkey_name(util_context,\n\t\t\t\t\t  global_params.mkey_name,\n\t\t\t\t\t  global_params.realm,  \n\t\t\t\t\t  &mkey_fullname, &master_princ))) {\n\tcom_err(argv[0], retval, \"while setting up master key name\");\n\texit_status++; return;\n    }\n\n    krb5_princ_set_realm_data(util_context, &db_create_princ, global_params.realm);\n    krb5_princ_set_realm_length(util_context, &db_create_princ, strlen(global_params.realm));\n    krb5_princ_set_realm_data(util_context, &tgt_princ, global_params.realm);\n    krb5_princ_set_realm_length(util_context, &tgt_princ, strlen(global_params.realm));\n    krb5_princ_component(util_context, &tgt_princ,1)->data = global_params.realm;\n    krb5_princ_component(util_context, &tgt_princ,1)->length = strlen(global_params.realm);\n\n    printf(\"Initializing database '%s' for realm '%s',\\n\\\nmaster key name '%s'\\n\",\n\t   global_params.dbname, global_params.realm, mkey_fullname);\n\n    if (!mkey_password) {\n\tprintf(\"You will be prompted for the database Master Password.\\n\");\n\tprintf(\"It is important that you NOT FORGET this password.\\n\");\n\tfflush(stdout);\n\n\tpw_size = 1024;\n\tpw_str = malloc(pw_size);\n\t\n\tretval = krb5_read_password(util_context, KRB5_KDC_MKEY_1, KRB5_KDC_MKEY_2,\n\t\t\t\t    pw_str, &pw_size);\n\tif (retval) {\n\t    com_err(argv[0], retval, \"while reading master key from keyboard\");\n\t    exit_status++; return;\n\t}\n\tmkey_password = pw_str;\n    }\n\n    pwd.data = mkey_password;\n    pwd.length = strlen(mkey_password);\n    retval = krb5_principal2salt(util_context, master_princ, &master_salt);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while calculating master key salt\");\n\texit_status++; return;\n    }\n\n    retval = krb5_c_string_to_key(util_context, master_keyblock.enctype, \n\t\t\t\t  &pwd, &master_salt, &master_keyblock);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while transforming master key from password\");\n\texit_status++; return;\n    }\n\n    rblock.key = &master_keyblock;\n\n    seed.length = master_keyblock.length;\n    seed.data = master_keyblock.contents;\n\n    if ((retval = krb5_c_random_seed(util_context, &seed))) {\n\tcom_err(argv[0], retval, \"while initializing random key generator\");\n\texit_status++; return;\n    }\n    if ((retval = krb5_db_create(util_context,\n\t\t\t\t global_params.dbname, crflags))) {\n\tcom_err(argv[0], retval, \"while creating database '%s'\",\n\t\tglobal_params.dbname);\n\texit_status++; return;\n    }\n    if ((retval = krb5_db_fini(util_context))) {\n        com_err(argv[0], retval, \"while closing current database\");\n        exit_status++; return;\n    }\n    if ((retval = krb5_db_set_name(util_context, global_params.dbname))) {\n        com_err(argv[0], retval, \"while setting active database to '%s'\",\n                global_params.dbname);\n        exit_status++; return;\n    }\n    if ((retval = krb5_db_init(util_context))) {\n\tcom_err(argv[0], retval, \"while initializing the database '%s'\",\n\t\tglobal_params.dbname);\n\texit_status++; return;\n    }\n\n    if ((retval = add_principal(util_context, master_princ, MASTER_KEY, &rblock)) ||\n\t(retval = add_principal(util_context, &tgt_princ, TGT_KEY, &rblock))) {\n\t(void) krb5_db_fini(util_context);\n\tcom_err(argv[0], retval, \"while adding entries to the database\");\n\texit_status++; return;\n    }\n    /*\n     * Always stash the master key so kadm5_create does not prompt for\n     * it; delete the file below if it was not requested.  DO NOT EXIT\n     * BEFORE DELETING THE KEYFILE if do_stash is not set.\n     */\n    retval = krb5_db_store_mkey(util_context,\n\t\t\t    global_params.stash_file,\n\t\t\t    master_princ,\n\t\t\t    &master_keyblock);\n    if (retval) {\n\tcom_err(argv[0], errno, \"while storing key\");\n\tprintf(\"Warning: couldn't stash master key.\\n\");\n    }\n    /* clean up */\n    (void) krb5_db_fini(util_context);\n    memset((char *)master_keyblock.contents, 0, master_keyblock.length);\n    free(master_keyblock.contents);\n    if (pw_str) {\n\tmemset(pw_str, 0, pw_size);\n\tfree(pw_str);\n    }\n    free(master_salt.data);\n\n    if (kadm5_create(&global_params)) {\n\t if (!do_stash) unlink(global_params.stash_file);\n\t exit_status++;\n\t return;\n    }\n    if (!do_stash) unlink(global_params.stash_file);\n\n    return;\n}",
    "includes": [
      "#include \"kdb5_util.h\"",
      "#include <krb5/adm_proto.h>",
      "#include <kadm5/adb.h>",
      "#include <kadm5/admin.h>",
      "#include <k5-int.h>",
      "#include <stdio.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "struct realm_info {\n    krb5_deltat max_life;\n    krb5_deltat max_rlife;\n    krb5_timestamp expiration;\n    krb5_flags flags;\n    krb5_keyblock *key;\n    krb5_int32 nkslist;\n    krb5_key_salt_tuple *kslist;\n} rblock = { /* XXX */\n    KRB5_KDB_MAX_LIFE,\n    KRB5_KDB_MAX_RLIFE,\n    KRB5_KDB_EXPIRATION,\n    KRB5_KDB_DEF_FLAGS,\n    (krb5_keyblock *) NULL,\n    1,\n    &def_kslist\n};",
      "extern krb5_keyblock master_keyblock;",
      "extern krb5_principal master_princ;",
      "krb5_data master_salt;",
      "krb5_principal_data tgt_princ = {\n        0,\t\t\t\t\t/* magic number */\n\t{0, 0, 0},\t\t\t\t/* krb5_data realm */\n\ttgt_princ_entries,\t\t\t/* krb5_data *data */\n\t2,\t\t\t\t\t/* int length */\n\tKRB5_NT_SRV_INST\t\t\t/* int type */\n};",
      "krb5_principal_data db_create_princ = {\n        0,\t\t\t\t\t/* magic number */\n\t{0, 0, 0},\t\t\t\t/* krb5_data realm */\n\tdb_creator_entries,\t\t\t/* krb5_data *data */\n\t1,\t\t\t\t\t/* int length */\n\tKRB5_NT_SRV_INST\t\t\t/* int type */\n};",
      "extern char *mkey_password;",
      "extern int exit_status;",
      "extern kadm5_config_params global_params;",
      "extern krb5_context util_context;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "global_params.stash_file"
          ],
          "line": 324
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "global_params.stash_file"
          ],
          "line": 320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kadm5_create",
          "args": [
            "&global_params"
          ],
          "line": 319
        },
        "resolved": true,
        "details": {
          "function_name": "kadm5_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/dbutil/kadm5_create.c",
          "lines": "68-99",
          "snippet": "int kadm5_create(kadm5_config_params *params)\n{\n     int retval;\n     krb5_context context;\n\n     kadm5_config_params lparams;\n\n     if ((retval = krb5_init_context(&context)))\n\t  exit(ERR);\n\n     /*\n      * The lock file has to exist before calling kadm5_init, but\n      * params->admin_lockfile may not be set yet...\n      */\n     if ((retval = kadm5_get_config_params(context, NULL, NULL,\n\t\t\t\t\t   params, &lparams))) {\n\t  com_err(progname, retval, \"while looking up the Kerberos configuration\");\n\t  return 1;\n     }\n\n     if ((retval = osa_adb_create_policy_db(&lparams))) {\n\t  com_err(progname, retval, str_CREATING_POLICY_DB);\n\t  return 1;\n     }\n\n     retval = kadm5_create_magic_princs(&lparams, context);\n\n     kadm5_free_config_params(context, &lparams);\n     krb5_free_context(context);\n\n     return retval;\n}",
          "includes": [
            "#include \"kdb5_util.h\"",
            "#include <krb5/kdb.h>",
            "#include <krb5.h>",
            "#include <krb5/adm_proto.h>",
            "#include <kadm5/admin.h>",
            "#include <kadm5/adb.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include \"string_table.h\""
          ],
          "macros_used": [
            "#define ERR 1"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"kdb5_util.h\"\n#include <krb5/kdb.h>\n#include <krb5.h>\n#include <krb5/adm_proto.h>\n#include <kadm5/admin.h>\n#include <kadm5/adb.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include \"string_table.h\"\n\n#define ERR 1\n\nint kadm5_create(kadm5_config_params *params)\n{\n     int retval;\n     krb5_context context;\n\n     kadm5_config_params lparams;\n\n     if ((retval = krb5_init_context(&context)))\n\t  exit(ERR);\n\n     /*\n      * The lock file has to exist before calling kadm5_init, but\n      * params->admin_lockfile may not be set yet...\n      */\n     if ((retval = kadm5_get_config_params(context, NULL, NULL,\n\t\t\t\t\t   params, &lparams))) {\n\t  com_err(progname, retval, \"while looking up the Kerberos configuration\");\n\t  return 1;\n     }\n\n     if ((retval = osa_adb_create_policy_db(&lparams))) {\n\t  com_err(progname, retval, str_CREATING_POLICY_DB);\n\t  return 1;\n     }\n\n     retval = kadm5_create_magic_princs(&lparams, context);\n\n     kadm5_free_config_params(context, &lparams);\n     krb5_free_context(context);\n\n     return retval;\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "master_salt.data"
          ],
          "line": 317
        },
        "resolved": true,
        "details": {
          "function_name": "free_policy_ent",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/testing/util/tcl_ovsec_kadm.c",
          "lines": "939-943",
          "snippet": "static void free_policy_ent(ovsec_kadm_policy_ent_t *policy)\n{\n     free(*policy);\n     *policy = 0;\n}",
          "includes": [
            "#include \"tcl_kadm5.h\"",
            "#include <stdlib.h>",
            "#include <errno.h>",
            "#include <k5-int.h>",
            "#include <com_err.h>",
            "#include <kadm5/admin.h>",
            "#include <tcl/tcl.h>",
            "#include <tcl.h>",
            "#include <string.h>",
            "#include <stdio.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"tcl_kadm5.h\"\n#include <stdlib.h>\n#include <errno.h>\n#include <k5-int.h>\n#include <com_err.h>\n#include <kadm5/admin.h>\n#include <tcl/tcl.h>\n#include <tcl.h>\n#include <string.h>\n#include <stdio.h>\n\nstatic void free_policy_ent(ovsec_kadm_policy_ent_t *policy)\n{\n     free(*policy);\n     *policy = 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "pw_str",
            "0",
            "pw_size"
          ],
          "line": 314
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "(char *)master_keyblock.contents",
            "0",
            "master_keyblock.length"
          ],
          "line": 311
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_fini",
          "args": [
            "util_context"
          ],
          "line": 310
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "printf",
          "args": [
            "\"Warning: couldn't stash master key.\\n\""
          ],
          "line": 307
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "errno",
            "\"while storing key\""
          ],
          "line": 306
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_store_mkey",
          "args": [
            "util_context",
            "global_params.stash_file",
            "master_princ",
            "&master_keyblock"
          ],
          "line": 301
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while adding entries to the database\""
          ],
          "line": 293
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_fini",
          "args": [
            "util_context"
          ],
          "line": 292
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "add_principal",
          "args": [
            "util_context",
            "&tgt_princ",
            "TGT_KEY",
            "&rblock"
          ],
          "line": 291
        },
        "resolved": true,
        "details": {
          "function_name": "add_principal",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/dbutil/kdb5_create.c",
          "lines": "373-445",
          "snippet": "static krb5_error_code\nadd_principal(context, princ, op, pblock)\n    krb5_context context;\n    krb5_principal princ;\n    enum ap_op op;\n    struct realm_info *pblock;\n{\n    krb5_error_code \t  retval;\n    krb5_db_entry \t  entry;\n\n    krb5_timestamp\t  now;\n    struct iterate_args\t  iargs;\n\n    int\t\t\t  nentries = 1;\n\n    memset((char *) &entry, 0, sizeof(entry));\n\n    entry.len = KRB5_KDB_V1_BASE_LENGTH;\n    entry.attributes = pblock->flags;\n    entry.max_life = pblock->max_life;\n    entry.max_renewable_life = pblock->max_rlife;\n    entry.expiration = pblock->expiration;\n\n    if ((retval = krb5_copy_principal(context, princ, &entry.princ)))\n\tgoto error_out;\n\n    if ((retval = krb5_timeofday(context, &now)))\n\tgoto error_out;\n\n    if ((retval = krb5_dbe_update_mod_princ_data(context, &entry,\n\t\t\t\t\t\t now, &db_create_princ)))\n\tgoto error_out;\n\n    switch (op) {\n    case MASTER_KEY:\n\tif ((entry.key_data=(krb5_key_data*)malloc(sizeof(krb5_key_data)))\n\t    == NULL)\n\t    goto error_out;\n\tmemset((char *) entry.key_data, 0, sizeof(krb5_key_data));\n\tentry.n_key_data = 1;\n\n\tentry.attributes |= KRB5_KDB_DISALLOW_ALL_TIX;\n\tif ((retval = krb5_dbekd_encrypt_key_data(context, pblock->key,\n\t\t\t\t\t\t  &master_keyblock, NULL, \n\t\t\t\t\t\t  1, entry.key_data)))\n\t    return retval;\n\tbreak;\n    case TGT_KEY:\n\tiargs.ctx = context;\n\tiargs.rblock = pblock;\n\tiargs.dbentp = &entry;\n\t/*\n\t * Iterate through the key/salt list, ignoring salt types.\n\t */\n\tif ((retval = krb5_keysalt_iterate(pblock->kslist,\n\t\t\t\t\t   pblock->nkslist,\n\t\t\t\t\t   1,\n\t\t\t\t\t   tgt_keysalt_iterate,\n\t\t\t\t\t   (krb5_pointer) &iargs)))\n\t    return retval;\n\tbreak;\n    case NULL_KEY:\n\treturn EOPNOTSUPP;\n    default:\n\tbreak;\n    }\n\n    retval = krb5_db_put_principal(context, &entry, &nentries);\n\nerror_out:;\n    krb5_dbe_free_contents(context, &entry);\n    return retval;\n}",
          "includes": [
            "#include \"kdb5_util.h\"",
            "#include <krb5/adm_proto.h>",
            "#include <kadm5/adb.h>",
            "#include <kadm5/admin.h>",
            "#include <k5-int.h>",
            "#include <stdio.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "struct realm_info {\n    krb5_deltat max_life;\n    krb5_deltat max_rlife;\n    krb5_timestamp expiration;\n    krb5_flags flags;\n    krb5_keyblock *key;\n    krb5_int32 nkslist;\n    krb5_key_salt_tuple *kslist;\n} rblock = { /* XXX */\n    KRB5_KDB_MAX_LIFE,\n    KRB5_KDB_MAX_RLIFE,\n    KRB5_KDB_EXPIRATION,\n    KRB5_KDB_DEF_FLAGS,\n    (krb5_keyblock *) NULL,\n    1,\n    &def_kslist\n};",
            "static krb5_error_code add_principal \n\t(krb5_context,\n\t krb5_principal,\n\t enum ap_op,\n\t struct realm_info *);",
            "extern krb5_keyblock master_keyblock;",
            "krb5_principal_data db_create_princ = {\n        0,\t\t\t\t\t/* magic number */\n\t{0, 0, 0},\t\t\t\t/* krb5_data realm */\n\tdb_creator_entries,\t\t\t/* krb5_data *data */\n\t1,\t\t\t\t\t/* int length */\n\tKRB5_NT_SRV_INST\t\t\t/* int type */\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"kdb5_util.h\"\n#include <krb5/adm_proto.h>\n#include <kadm5/adb.h>\n#include <kadm5/admin.h>\n#include <k5-int.h>\n#include <stdio.h>\n\nstruct realm_info {\n    krb5_deltat max_life;\n    krb5_deltat max_rlife;\n    krb5_timestamp expiration;\n    krb5_flags flags;\n    krb5_keyblock *key;\n    krb5_int32 nkslist;\n    krb5_key_salt_tuple *kslist;\n} rblock = { /* XXX */\n    KRB5_KDB_MAX_LIFE,\n    KRB5_KDB_MAX_RLIFE,\n    KRB5_KDB_EXPIRATION,\n    KRB5_KDB_DEF_FLAGS,\n    (krb5_keyblock *) NULL,\n    1,\n    &def_kslist\n};\nstatic krb5_error_code add_principal \n\t(krb5_context,\n\t krb5_principal,\n\t enum ap_op,\n\t struct realm_info *);\nextern krb5_keyblock master_keyblock;\nkrb5_principal_data db_create_princ = {\n        0,\t\t\t\t\t/* magic number */\n\t{0, 0, 0},\t\t\t\t/* krb5_data realm */\n\tdb_creator_entries,\t\t\t/* krb5_data *data */\n\t1,\t\t\t\t\t/* int length */\n\tKRB5_NT_SRV_INST\t\t\t/* int type */\n};\n\nstatic krb5_error_code\nadd_principal(context, princ, op, pblock)\n    krb5_context context;\n    krb5_principal princ;\n    enum ap_op op;\n    struct realm_info *pblock;\n{\n    krb5_error_code \t  retval;\n    krb5_db_entry \t  entry;\n\n    krb5_timestamp\t  now;\n    struct iterate_args\t  iargs;\n\n    int\t\t\t  nentries = 1;\n\n    memset((char *) &entry, 0, sizeof(entry));\n\n    entry.len = KRB5_KDB_V1_BASE_LENGTH;\n    entry.attributes = pblock->flags;\n    entry.max_life = pblock->max_life;\n    entry.max_renewable_life = pblock->max_rlife;\n    entry.expiration = pblock->expiration;\n\n    if ((retval = krb5_copy_principal(context, princ, &entry.princ)))\n\tgoto error_out;\n\n    if ((retval = krb5_timeofday(context, &now)))\n\tgoto error_out;\n\n    if ((retval = krb5_dbe_update_mod_princ_data(context, &entry,\n\t\t\t\t\t\t now, &db_create_princ)))\n\tgoto error_out;\n\n    switch (op) {\n    case MASTER_KEY:\n\tif ((entry.key_data=(krb5_key_data*)malloc(sizeof(krb5_key_data)))\n\t    == NULL)\n\t    goto error_out;\n\tmemset((char *) entry.key_data, 0, sizeof(krb5_key_data));\n\tentry.n_key_data = 1;\n\n\tentry.attributes |= KRB5_KDB_DISALLOW_ALL_TIX;\n\tif ((retval = krb5_dbekd_encrypt_key_data(context, pblock->key,\n\t\t\t\t\t\t  &master_keyblock, NULL, \n\t\t\t\t\t\t  1, entry.key_data)))\n\t    return retval;\n\tbreak;\n    case TGT_KEY:\n\tiargs.ctx = context;\n\tiargs.rblock = pblock;\n\tiargs.dbentp = &entry;\n\t/*\n\t * Iterate through the key/salt list, ignoring salt types.\n\t */\n\tif ((retval = krb5_keysalt_iterate(pblock->kslist,\n\t\t\t\t\t   pblock->nkslist,\n\t\t\t\t\t   1,\n\t\t\t\t\t   tgt_keysalt_iterate,\n\t\t\t\t\t   (krb5_pointer) &iargs)))\n\t    return retval;\n\tbreak;\n    case NULL_KEY:\n\treturn EOPNOTSUPP;\n    default:\n\tbreak;\n    }\n\n    retval = krb5_db_put_principal(context, &entry, &nentries);\n\nerror_out:;\n    krb5_dbe_free_contents(context, &entry);\n    return retval;\n}"
        }
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while initializing the database '%s'\"",
            "global_params.dbname"
          ],
          "line": 285
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_init",
          "args": [
            "util_context"
          ],
          "line": 284
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while setting active database to '%s'\"",
            "global_params.dbname"
          ],
          "line": 280
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_set_name",
          "args": [
            "util_context",
            "global_params.dbname"
          ],
          "line": 279
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while closing current database\""
          ],
          "line": 276
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_fini",
          "args": [
            "util_context"
          ],
          "line": 275
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while creating database '%s'\"",
            "global_params.dbname"
          ],
          "line": 271
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_create",
          "args": [
            "util_context",
            "global_params.dbname",
            "crflags"
          ],
          "line": 269
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while initializing random key generator\""
          ],
          "line": 266
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_c_random_seed",
          "args": [
            "util_context",
            "&seed"
          ],
          "line": 265
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while transforming master key from password\""
          ],
          "line": 256
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_c_string_to_key",
          "args": [
            "util_context",
            "master_keyblock.enctype",
            "&pwd",
            "&master_salt",
            "&master_keyblock"
          ],
          "line": 253
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while calculating master key salt\""
          ],
          "line": 249
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_principal2salt",
          "args": [
            "util_context",
            "master_princ",
            "&master_salt"
          ],
          "line": 247
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "mkey_password"
          ],
          "line": 246
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while reading master key from keyboard\""
          ],
          "line": 239
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_read_password",
          "args": [
            "util_context",
            "KRB5_KDC_MKEY_1",
            "KRB5_KDC_MKEY_2",
            "pw_str",
            "&pw_size"
          ],
          "line": 236
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "pw_size"
          ],
          "line": 234
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fflush",
          "args": [
            "stdout"
          ],
          "line": 231
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "printf",
          "args": [
            "\"It is important that you NOT FORGET this password.\\n\""
          ],
          "line": 230
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "printf",
          "args": [
            "\"You will be prompted for the database Master Password.\\n\""
          ],
          "line": 229
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "printf",
          "args": [
            "\"Initializing database '%s' for realm '%s',\\n\\\nmaster key name '%s'\\n\"",
            "global_params.dbname",
            "global_params.realm",
            "mkey_fullname"
          ],
          "line": 224
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "global_params.realm"
          ],
          "line": 222
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_princ_component",
          "args": [
            "util_context",
            "&tgt_princ",
            "1"
          ],
          "line": 222
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_princ_component",
          "args": [
            "util_context",
            "&tgt_princ",
            "1"
          ],
          "line": 221
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_princ_set_realm_length",
          "args": [
            "util_context",
            "&tgt_princ",
            "strlen(global_params.realm)"
          ],
          "line": 220
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "global_params.realm"
          ],
          "line": 220
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_princ_set_realm_data",
          "args": [
            "util_context",
            "&tgt_princ",
            "global_params.realm"
          ],
          "line": 219
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_princ_set_realm_length",
          "args": [
            "util_context",
            "&db_create_princ",
            "strlen(global_params.realm)"
          ],
          "line": 218
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "global_params.realm"
          ],
          "line": 218
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_princ_set_realm_data",
          "args": [
            "util_context",
            "&db_create_princ",
            "global_params.realm"
          ],
          "line": 217
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while setting up master key name\""
          ],
          "line": 213
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_setup_mkey_name",
          "args": [
            "util_context",
            "global_params.mkey_name",
            "global_params.realm",
            "&mkey_fullname",
            "&master_princ"
          ],
          "line": 209
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"Loading random data\""
          ],
          "line": 203
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_c_random_os_entropy",
          "args": [
            "util_context",
            "1",
            "NULL"
          ],
          "line": 201
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "printf",
          "args": [
            "\"Loading random data\\n\""
          ],
          "line": 200
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "0",
            "\"The database '%s' appears to already exist\"",
            "global_params.dbname"
          ],
          "line": 195
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_set_name",
          "args": [
            "util_context",
            "global_params.dbname"
          ],
          "line": 190
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "usage",
          "args": [],
          "line": 178
        },
        "resolved": true,
        "details": {
          "function_name": "usage",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/dbutil/kdb5_util.c",
          "lines": "82-98",
          "snippet": "void usage()\n{\n     fprintf(stderr, \"Usage: \"\n\t   \"kdb5_util [-r realm] [-d dbname] [-k mkeytype] [-M mkeyname]\\n\"\n\t     \"\\t        [-sf stashfilename] [-m] cmd [cmd_options]\\n\"\n\t     \"\\tcreate\t[-s]\\n\"\n\t     \"\\tdestroy\t[-f]\\n\"\n\t     \"\\tstash\t[-f keyfile]\\n\"\n\t     \"\\tdump\t[-old] [-ov] [-b6] [-verbose]\\n\"\n\t     \"\\t\t[-mkey_convert] [-new_mkey_file mkey_file]\\n\"\n\t     \"\\t\t[-rev] [-recurse] [filename [princs...]]\\n\"\n\t     \"\\tload\t[-old] [-ov] [-b6] [-verbose] [-update] filename\\n\"\n\t     \"\\tdump_v4\t[-S] [filename]\\n\"\n\t     \"\\tload_v4\t[-S] [-t] [-n] [-v] [-K] [-s stashfile] inputfile\\n\"\n\t     \"\\tark\t[-e etype_list] principal\\n\");\n     exit(1);\n}",
          "includes": [
            "#include \"kdb5_util.h\"",
            "#include <time.h>",
            "#include <kadm5/adb.h>",
            "#include <krb5/adm_proto.h>",
            "#include <kadm5/admin.h>",
            "#include <k5-int.h>",
            "#include <stdio.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"kdb5_util.h\"\n#include <time.h>\n#include <kadm5/adb.h>\n#include <krb5/adm_proto.h>\n#include <kadm5/admin.h>\n#include <k5-int.h>\n#include <stdio.h>\n\nvoid usage()\n{\n     fprintf(stderr, \"Usage: \"\n\t   \"kdb5_util [-r realm] [-d dbname] [-k mkeytype] [-M mkeyname]\\n\"\n\t     \"\\t        [-sf stashfilename] [-m] cmd [cmd_options]\\n\"\n\t     \"\\tcreate\t[-s]\\n\"\n\t     \"\\tdestroy\t[-f]\\n\"\n\t     \"\\tstash\t[-f keyfile]\\n\"\n\t     \"\\tdump\t[-old] [-ov] [-b6] [-verbose]\\n\"\n\t     \"\\t\t[-mkey_convert] [-new_mkey_file mkey_file]\\n\"\n\t     \"\\t\t[-rev] [-recurse] [filename [princs...]]\\n\"\n\t     \"\\tload\t[-old] [-ov] [-b6] [-verbose] [-update] filename\\n\"\n\t     \"\\tdump_v4\t[-S] [filename]\\n\"\n\t     \"\\tload_v4\t[-S] [-t] [-n] [-v] [-K] [-s stashfile] inputfile\\n\"\n\t     \"\\tark\t[-e etype_list] principal\\n\");\n     exit(1);\n}"
        }
      },
      {
        "call_info": {
          "callee": "getopt",
          "args": [
            "argc",
            "argv",
            "\"s\""
          ],
          "line": 169
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strrchr",
          "args": [
            "argv[0]",
            "'/'"
          ],
          "line": 167
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strrchr",
          "args": [
            "argv[0]",
            "'/'"
          ],
          "line": 166
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"kdb5_util.h\"\n#include <krb5/adm_proto.h>\n#include <kadm5/adb.h>\n#include <kadm5/admin.h>\n#include <k5-int.h>\n#include <stdio.h>\n\nstruct realm_info {\n    krb5_deltat max_life;\n    krb5_deltat max_rlife;\n    krb5_timestamp expiration;\n    krb5_flags flags;\n    krb5_keyblock *key;\n    krb5_int32 nkslist;\n    krb5_key_salt_tuple *kslist;\n} rblock = { /* XXX */\n    KRB5_KDB_MAX_LIFE,\n    KRB5_KDB_MAX_RLIFE,\n    KRB5_KDB_EXPIRATION,\n    KRB5_KDB_DEF_FLAGS,\n    (krb5_keyblock *) NULL,\n    1,\n    &def_kslist\n};\nextern krb5_keyblock master_keyblock;\nextern krb5_principal master_princ;\nkrb5_data master_salt;\nkrb5_principal_data tgt_princ = {\n        0,\t\t\t\t\t/* magic number */\n\t{0, 0, 0},\t\t\t\t/* krb5_data realm */\n\ttgt_princ_entries,\t\t\t/* krb5_data *data */\n\t2,\t\t\t\t\t/* int length */\n\tKRB5_NT_SRV_INST\t\t\t/* int type */\n};\nkrb5_principal_data db_create_princ = {\n        0,\t\t\t\t\t/* magic number */\n\t{0, 0, 0},\t\t\t\t/* krb5_data realm */\n\tdb_creator_entries,\t\t\t/* krb5_data *data */\n\t1,\t\t\t\t\t/* int length */\n\tKRB5_NT_SRV_INST\t\t\t/* int type */\n};\nextern char *mkey_password;\nextern int exit_status;\nextern kadm5_config_params global_params;\nextern krb5_context util_context;\n\nvoid kdb5_create(argc, argv)\n   int argc;\n   char *argv[];\n{\n    int optchar;\n\n    krb5_error_code retval;\n    char *mkey_fullname;\n    char *pw_str = 0;\n    unsigned int pw_size = 0;\n    int do_stash = 0;\n    krb5_int32 crflags = KRB5_KDB_CREATE_BTREE;\n    krb5_data pwd, seed;\n\t   \n    if (strrchr(argv[0], '/'))\n\targv[0] = strrchr(argv[0], '/')+1;\n\n    while ((optchar = getopt(argc, argv, \"s\")) != -1) {\n\tswitch(optchar) {\n\tcase 's':\n\t    do_stash++;\n\t    break;\n\tcase 'h':\n\t    crflags = KRB5_KDB_CREATE_HASH;\n\tcase '?':\n\tdefault:\n\t    usage();\n\t    return;\n\t}\n    }\n\n    rblock.max_life = global_params.max_life;\n    rblock.max_rlife = global_params.max_rlife;\n    rblock.expiration = global_params.expiration;\n    rblock.flags = global_params.flags;\n    rblock.nkslist = global_params.num_keysalts;\n    rblock.kslist = global_params.keysalts;\n\n    retval = krb5_db_set_name(util_context, global_params.dbname);\n    if (!retval) retval = EEXIST;\n\n    if (retval == EEXIST || retval == EACCES || retval == EPERM) {\n\t/* it exists ! */\n\tcom_err(argv[0], 0, \"The database '%s' appears to already exist\",\n\t\tglobal_params.dbname);\n\texit_status++; return;\n    }\n\n    printf (\"Loading random data\\n\");\n    retval = krb5_c_random_os_entropy (util_context, 1, NULL);\n    if (retval) {\n      com_err (argv[0], retval, \"Loading random data\");\n      exit_status++; return;\n    }\n    \n    /* assemble & parse the master key name */\n\n    if ((retval = krb5_db_setup_mkey_name(util_context,\n\t\t\t\t\t  global_params.mkey_name,\n\t\t\t\t\t  global_params.realm,  \n\t\t\t\t\t  &mkey_fullname, &master_princ))) {\n\tcom_err(argv[0], retval, \"while setting up master key name\");\n\texit_status++; return;\n    }\n\n    krb5_princ_set_realm_data(util_context, &db_create_princ, global_params.realm);\n    krb5_princ_set_realm_length(util_context, &db_create_princ, strlen(global_params.realm));\n    krb5_princ_set_realm_data(util_context, &tgt_princ, global_params.realm);\n    krb5_princ_set_realm_length(util_context, &tgt_princ, strlen(global_params.realm));\n    krb5_princ_component(util_context, &tgt_princ,1)->data = global_params.realm;\n    krb5_princ_component(util_context, &tgt_princ,1)->length = strlen(global_params.realm);\n\n    printf(\"Initializing database '%s' for realm '%s',\\n\\\nmaster key name '%s'\\n\",\n\t   global_params.dbname, global_params.realm, mkey_fullname);\n\n    if (!mkey_password) {\n\tprintf(\"You will be prompted for the database Master Password.\\n\");\n\tprintf(\"It is important that you NOT FORGET this password.\\n\");\n\tfflush(stdout);\n\n\tpw_size = 1024;\n\tpw_str = malloc(pw_size);\n\t\n\tretval = krb5_read_password(util_context, KRB5_KDC_MKEY_1, KRB5_KDC_MKEY_2,\n\t\t\t\t    pw_str, &pw_size);\n\tif (retval) {\n\t    com_err(argv[0], retval, \"while reading master key from keyboard\");\n\t    exit_status++; return;\n\t}\n\tmkey_password = pw_str;\n    }\n\n    pwd.data = mkey_password;\n    pwd.length = strlen(mkey_password);\n    retval = krb5_principal2salt(util_context, master_princ, &master_salt);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while calculating master key salt\");\n\texit_status++; return;\n    }\n\n    retval = krb5_c_string_to_key(util_context, master_keyblock.enctype, \n\t\t\t\t  &pwd, &master_salt, &master_keyblock);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while transforming master key from password\");\n\texit_status++; return;\n    }\n\n    rblock.key = &master_keyblock;\n\n    seed.length = master_keyblock.length;\n    seed.data = master_keyblock.contents;\n\n    if ((retval = krb5_c_random_seed(util_context, &seed))) {\n\tcom_err(argv[0], retval, \"while initializing random key generator\");\n\texit_status++; return;\n    }\n    if ((retval = krb5_db_create(util_context,\n\t\t\t\t global_params.dbname, crflags))) {\n\tcom_err(argv[0], retval, \"while creating database '%s'\",\n\t\tglobal_params.dbname);\n\texit_status++; return;\n    }\n    if ((retval = krb5_db_fini(util_context))) {\n        com_err(argv[0], retval, \"while closing current database\");\n        exit_status++; return;\n    }\n    if ((retval = krb5_db_set_name(util_context, global_params.dbname))) {\n        com_err(argv[0], retval, \"while setting active database to '%s'\",\n                global_params.dbname);\n        exit_status++; return;\n    }\n    if ((retval = krb5_db_init(util_context))) {\n\tcom_err(argv[0], retval, \"while initializing the database '%s'\",\n\t\tglobal_params.dbname);\n\texit_status++; return;\n    }\n\n    if ((retval = add_principal(util_context, master_princ, MASTER_KEY, &rblock)) ||\n\t(retval = add_principal(util_context, &tgt_princ, TGT_KEY, &rblock))) {\n\t(void) krb5_db_fini(util_context);\n\tcom_err(argv[0], retval, \"while adding entries to the database\");\n\texit_status++; return;\n    }\n    /*\n     * Always stash the master key so kadm5_create does not prompt for\n     * it; delete the file below if it was not requested.  DO NOT EXIT\n     * BEFORE DELETING THE KEYFILE if do_stash is not set.\n     */\n    retval = krb5_db_store_mkey(util_context,\n\t\t\t    global_params.stash_file,\n\t\t\t    master_princ,\n\t\t\t    &master_keyblock);\n    if (retval) {\n\tcom_err(argv[0], errno, \"while storing key\");\n\tprintf(\"Warning: couldn't stash master key.\\n\");\n    }\n    /* clean up */\n    (void) krb5_db_fini(util_context);\n    memset((char *)master_keyblock.contents, 0, master_keyblock.length);\n    free(master_keyblock.contents);\n    if (pw_str) {\n\tmemset(pw_str, 0, pw_size);\n\tfree(pw_str);\n    }\n    free(master_salt.data);\n\n    if (kadm5_create(&global_params)) {\n\t if (!do_stash) unlink(global_params.stash_file);\n\t exit_status++;\n\t return;\n    }\n    if (!do_stash) unlink(global_params.stash_file);\n\n    return;\n}"
  }
]