[
  {
    "function_name": "kdb5_stash",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/dbutil/kdb5_stash.c",
    "lines": "69-181",
    "snippet": "void\nkdb5_stash(argc, argv)\n    int argc;\n    char *argv[];\n{\n    extern char *optarg;\n    extern int optind;\n    int optchar;\n    krb5_error_code retval;\n    char *dbname = (char *) NULL;\n    char *realm = 0;\n    char *mkey_name = 0;\n    char *mkey_fullname;\n    char *keyfile = 0;\n    krb5_context context;\n\n    if (strrchr(argv[0], '/'))\n\targv[0] = strrchr(argv[0], '/')+1;\n\n    /* Tell upwards to close the policy db cause we don't */\n    close_policy_db = 1; \n\n    krb5_init_context(&context);\n\n    dbname = global_params.dbname;\n    realm = global_params.realm;\n    mkey_name = global_params.mkey_name;\n    keyfile = global_params.stash_file;\n\n    optind = 1;\n    while ((optchar = getopt(argc, argv, \"f:\")) != -1) {\n\tswitch(optchar) {\n\tcase 'f':\n\t    keyfile = optarg;\n\t    break;\n\tcase '?':\n\tdefault:\n\t    usage();\n\t    return;\n\t}\n    }\n\n    if (!krb5_c_valid_enctype(master_keyblock.enctype)) {\n\tchar tmp[32];\n\tif (krb5_enctype_to_string(master_keyblock.enctype, tmp, sizeof(tmp)))\n\t    com_err(argv[0], KRB5_PROG_KEYTYPE_NOSUPP,\n\t\t    \"while setting up enctype %d\", master_keyblock.enctype);\n\telse\n\t    com_err(argv[0], KRB5_PROG_KEYTYPE_NOSUPP, tmp);\n\texit_status++; return; \n    }\n\n    retval = krb5_db_set_name(context, dbname);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while setting active database to '%s'\",\n\t\tdbname);\n\texit_status++; return; \n    }\n\n    /* assemble & parse the master key name */\n    retval = krb5_db_setup_mkey_name(context, mkey_name, realm, \n\t\t\t\t     &mkey_fullname, &master_princ);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while setting up master key name\");\n\texit_status++; return; \n    }\n\n    retval = krb5_db_init(context);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while initializing the database '%s'\",\n\t\tdbname);\n\texit_status++; return; \n    }\n\n    /* TRUE here means read the keyboard, but only once */\n    retval = krb5_db_fetch_mkey(context, master_princ,\n\t\t\t\tmaster_keyblock.enctype,\n\t\t\t\tTRUE, FALSE, (char *) NULL,\n\t\t\t\t0, &master_keyblock);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while reading master key\");\n\t(void) krb5_db_fini(context);\n\texit_status++; return; \n    }\n\n    retval = krb5_db_verify_master_key(context, master_princ, \n\t\t\t\t       &master_keyblock);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while verifying master key\");\n\t(void) krb5_db_fini(context);\n\texit_status++; return; \n    }\t\n\n    retval = krb5_db_store_mkey(context, keyfile, master_princ, \n\t\t\t\t&master_keyblock);\n    if (retval) {\n\tcom_err(argv[0], errno, \"while storing key\");\n\tmemset((char *)master_keyblock.contents, 0, master_keyblock.length);\n\t(void) krb5_db_fini(context);\n\texit_status++; return; \n    }\n    memset((char *)master_keyblock.contents, 0, master_keyblock.length);\n\n    retval = krb5_db_fini(context);\n    if (retval) {\n\tcom_err(argv[0], retval, \"closing database '%s'\", dbname);\n\texit_status++; return; \n    }\n\n    krb5_free_context(context);\n    exit_status = 0;\n    return; \n}",
    "includes": [
      "#include \"kdb5_util.h\"",
      "#include <stdio.h>",
      "#include <kadm5/admin.h>",
      "#include \"com_err.h\"",
      "#include \"k5-int.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "extern krb5_keyblock master_keyblock;",
      "extern krb5_principal master_princ;",
      "extern kadm5_config_params global_params;",
      "extern int exit_status;",
      "extern int close_policy_db;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "krb5_free_context",
          "args": [
            "context"
          ],
          "line": 178
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"closing database '%s'\"",
            "dbname"
          ],
          "line": 174
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_fini",
          "args": [
            "context"
          ],
          "line": 172
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "(char *)master_keyblock.contents",
            "0",
            "master_keyblock.length"
          ],
          "line": 170
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_fini",
          "args": [
            "context"
          ],
          "line": 167
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "(char *)master_keyblock.contents",
            "0",
            "master_keyblock.length"
          ],
          "line": 166
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "errno",
            "\"while storing key\""
          ],
          "line": 165
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_store_mkey",
          "args": [
            "context",
            "keyfile",
            "master_princ",
            "&master_keyblock"
          ],
          "line": 162
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_fini",
          "args": [
            "context"
          ],
          "line": 158
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while verifying master key\""
          ],
          "line": 157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_verify_master_key",
          "args": [
            "context",
            "master_princ",
            "&master_keyblock"
          ],
          "line": 154
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_fini",
          "args": [
            "context"
          ],
          "line": 150
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while reading master key\""
          ],
          "line": 149
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_fetch_mkey",
          "args": [
            "context",
            "master_princ",
            "master_keyblock.enctype",
            "TRUE",
            "FALSE",
            "(char *) NULL",
            "0",
            "&master_keyblock"
          ],
          "line": 144
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while initializing the database '%s'\"",
            "dbname"
          ],
          "line": 138
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_init",
          "args": [
            "context"
          ],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while setting up master key name\""
          ],
          "line": 132
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_setup_mkey_name",
          "args": [
            "context",
            "mkey_name",
            "realm",
            "&mkey_fullname",
            "&master_princ"
          ],
          "line": 129
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "retval",
            "\"while setting active database to '%s'\"",
            "dbname"
          ],
          "line": 123
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_db_set_name",
          "args": [
            "context",
            "dbname"
          ],
          "line": 121
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "KRB5_PROG_KEYTYPE_NOSUPP",
            "tmp"
          ],
          "line": 117
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "argv[0]",
            "KRB5_PROG_KEYTYPE_NOSUPP",
            "\"while setting up enctype %d\"",
            "master_keyblock.enctype"
          ],
          "line": 114
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_enctype_to_string",
          "args": [
            "master_keyblock.enctype",
            "tmp",
            "sizeof(tmp)"
          ],
          "line": 113
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_c_valid_enctype",
          "args": [
            "master_keyblock.enctype"
          ],
          "line": 111
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "usage",
          "args": [],
          "line": 106
        },
        "resolved": true,
        "details": {
          "function_name": "usage",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/dbutil/kdb5_util.c",
          "lines": "82-98",
          "snippet": "void usage()\n{\n     fprintf(stderr, \"Usage: \"\n\t   \"kdb5_util [-r realm] [-d dbname] [-k mkeytype] [-M mkeyname]\\n\"\n\t     \"\\t        [-sf stashfilename] [-m] cmd [cmd_options]\\n\"\n\t     \"\\tcreate\t[-s]\\n\"\n\t     \"\\tdestroy\t[-f]\\n\"\n\t     \"\\tstash\t[-f keyfile]\\n\"\n\t     \"\\tdump\t[-old] [-ov] [-b6] [-verbose]\\n\"\n\t     \"\\t\t[-mkey_convert] [-new_mkey_file mkey_file]\\n\"\n\t     \"\\t\t[-rev] [-recurse] [filename [princs...]]\\n\"\n\t     \"\\tload\t[-old] [-ov] [-b6] [-verbose] [-update] filename\\n\"\n\t     \"\\tdump_v4\t[-S] [filename]\\n\"\n\t     \"\\tload_v4\t[-S] [-t] [-n] [-v] [-K] [-s stashfile] inputfile\\n\"\n\t     \"\\tark\t[-e etype_list] principal\\n\");\n     exit(1);\n}",
          "includes": [
            "#include \"kdb5_util.h\"",
            "#include <time.h>",
            "#include <kadm5/adb.h>",
            "#include <krb5/adm_proto.h>",
            "#include <kadm5/admin.h>",
            "#include <k5-int.h>",
            "#include <stdio.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"kdb5_util.h\"\n#include <time.h>\n#include <kadm5/adb.h>\n#include <krb5/adm_proto.h>\n#include <kadm5/admin.h>\n#include <k5-int.h>\n#include <stdio.h>\n\nvoid usage()\n{\n     fprintf(stderr, \"Usage: \"\n\t   \"kdb5_util [-r realm] [-d dbname] [-k mkeytype] [-M mkeyname]\\n\"\n\t     \"\\t        [-sf stashfilename] [-m] cmd [cmd_options]\\n\"\n\t     \"\\tcreate\t[-s]\\n\"\n\t     \"\\tdestroy\t[-f]\\n\"\n\t     \"\\tstash\t[-f keyfile]\\n\"\n\t     \"\\tdump\t[-old] [-ov] [-b6] [-verbose]\\n\"\n\t     \"\\t\t[-mkey_convert] [-new_mkey_file mkey_file]\\n\"\n\t     \"\\t\t[-rev] [-recurse] [filename [princs...]]\\n\"\n\t     \"\\tload\t[-old] [-ov] [-b6] [-verbose] [-update] filename\\n\"\n\t     \"\\tdump_v4\t[-S] [filename]\\n\"\n\t     \"\\tload_v4\t[-S] [-t] [-n] [-v] [-K] [-s stashfile] inputfile\\n\"\n\t     \"\\tark\t[-e etype_list] principal\\n\");\n     exit(1);\n}"
        }
      },
      {
        "call_info": {
          "callee": "getopt",
          "args": [
            "argc",
            "argv",
            "\"f:\""
          ],
          "line": 99
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_init_context",
          "args": [
            "&context"
          ],
          "line": 91
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strrchr",
          "args": [
            "argv[0]",
            "'/'"
          ],
          "line": 86
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strrchr",
          "args": [
            "argv[0]",
            "'/'"
          ],
          "line": 85
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"kdb5_util.h\"\n#include <stdio.h>\n#include <kadm5/admin.h>\n#include \"com_err.h\"\n#include \"k5-int.h\"\n\nextern krb5_keyblock master_keyblock;\nextern krb5_principal master_princ;\nextern kadm5_config_params global_params;\nextern int exit_status;\nextern int close_policy_db;\n\nvoid\nkdb5_stash(argc, argv)\n    int argc;\n    char *argv[];\n{\n    extern char *optarg;\n    extern int optind;\n    int optchar;\n    krb5_error_code retval;\n    char *dbname = (char *) NULL;\n    char *realm = 0;\n    char *mkey_name = 0;\n    char *mkey_fullname;\n    char *keyfile = 0;\n    krb5_context context;\n\n    if (strrchr(argv[0], '/'))\n\targv[0] = strrchr(argv[0], '/')+1;\n\n    /* Tell upwards to close the policy db cause we don't */\n    close_policy_db = 1; \n\n    krb5_init_context(&context);\n\n    dbname = global_params.dbname;\n    realm = global_params.realm;\n    mkey_name = global_params.mkey_name;\n    keyfile = global_params.stash_file;\n\n    optind = 1;\n    while ((optchar = getopt(argc, argv, \"f:\")) != -1) {\n\tswitch(optchar) {\n\tcase 'f':\n\t    keyfile = optarg;\n\t    break;\n\tcase '?':\n\tdefault:\n\t    usage();\n\t    return;\n\t}\n    }\n\n    if (!krb5_c_valid_enctype(master_keyblock.enctype)) {\n\tchar tmp[32];\n\tif (krb5_enctype_to_string(master_keyblock.enctype, tmp, sizeof(tmp)))\n\t    com_err(argv[0], KRB5_PROG_KEYTYPE_NOSUPP,\n\t\t    \"while setting up enctype %d\", master_keyblock.enctype);\n\telse\n\t    com_err(argv[0], KRB5_PROG_KEYTYPE_NOSUPP, tmp);\n\texit_status++; return; \n    }\n\n    retval = krb5_db_set_name(context, dbname);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while setting active database to '%s'\",\n\t\tdbname);\n\texit_status++; return; \n    }\n\n    /* assemble & parse the master key name */\n    retval = krb5_db_setup_mkey_name(context, mkey_name, realm, \n\t\t\t\t     &mkey_fullname, &master_princ);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while setting up master key name\");\n\texit_status++; return; \n    }\n\n    retval = krb5_db_init(context);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while initializing the database '%s'\",\n\t\tdbname);\n\texit_status++; return; \n    }\n\n    /* TRUE here means read the keyboard, but only once */\n    retval = krb5_db_fetch_mkey(context, master_princ,\n\t\t\t\tmaster_keyblock.enctype,\n\t\t\t\tTRUE, FALSE, (char *) NULL,\n\t\t\t\t0, &master_keyblock);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while reading master key\");\n\t(void) krb5_db_fini(context);\n\texit_status++; return; \n    }\n\n    retval = krb5_db_verify_master_key(context, master_princ, \n\t\t\t\t       &master_keyblock);\n    if (retval) {\n\tcom_err(argv[0], retval, \"while verifying master key\");\n\t(void) krb5_db_fini(context);\n\texit_status++; return; \n    }\t\n\n    retval = krb5_db_store_mkey(context, keyfile, master_princ, \n\t\t\t\t&master_keyblock);\n    if (retval) {\n\tcom_err(argv[0], errno, \"while storing key\");\n\tmemset((char *)master_keyblock.contents, 0, master_keyblock.length);\n\t(void) krb5_db_fini(context);\n\texit_status++; return; \n    }\n    memset((char *)master_keyblock.contents, 0, master_keyblock.length);\n\n    retval = krb5_db_fini(context);\n    if (retval) {\n\tcom_err(argv[0], retval, \"closing database '%s'\", dbname);\n\texit_status++; return; \n    }\n\n    krb5_free_context(context);\n    exit_status = 0;\n    return; \n}"
  }
]