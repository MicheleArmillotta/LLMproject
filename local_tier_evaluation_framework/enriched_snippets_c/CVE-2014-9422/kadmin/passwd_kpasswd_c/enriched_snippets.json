[
  {
    "function_name": "kpasswd",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/passwd/kpasswd.c",
    "lines": "73-280",
    "snippet": "int\nkpasswd(context, argc, argv)\n   krb5_context context;\n   int argc;\n   char *argv[];\n{\n  int code;\n  krb5_ccache ccache = NULL;\n  krb5_principal princ = 0;\n  char *princ_str;\n  struct passwd *pw = 0;\n  unsigned int pwsize;\n  char password[255];  /* I don't really like 255 but that's what kinit uses */\n  char msg_ret[1024], admin_realm[1024];\n  ovsec_kadm_principal_ent_t principal_entry = NULL;\n  ovsec_kadm_policy_ent_t policy_entry = NULL;\n  void *server_handle;\n\n  if (argc > 2) {\n      com_err(whoami, KPW_STR_USAGE, 0);\n      return(7);\n      /*NOTREACHED*/\n    }\n\n  /************************************\n   *  Get principal name to change    * \n   ************************************/\n\n  /* Look on the command line first, followed by the default credential\n     cache, followed by defaulting to the Unix user name */\n\n  if (argc == 2)\n    princ_str = strdup(argv[1]);\n  else {\n    code = krb5_cc_default(context, &ccache);\n    /* If we succeed, find who is in the credential cache */\n    if (code == 0) {\n      /* Get default principal from cache if one exists */\n      code = krb5_cc_get_principal(context, ccache, &princ);\n      /* if we got a principal, unparse it, otherwise get out of the if\n\t with an error code */\n      (void) krb5_cc_close(context, ccache);\n      if (code == 0) {\n\tcode = krb5_unparse_name(context, princ, &princ_str);\n\tif (code != 0) {\n\t  com_err(whoami,  code, string_text(KPW_STR_UNPARSE_NAME));\n\t  return(MISC_EXIT_STATUS);\n\t}\n      }\n    }\n\n    /* this is a crock.. we want to compare against */\n    /* \"KRB5_CC_DOESNOTEXIST\" but there is no such error code, and */\n    /* both the file and stdio types return FCC_NOFILE.  If there is */\n    /* ever another ccache type (or if the error codes are ever */\n    /* fixed), this code will have to be updated. */\n    if (code && code != KRB5_FCC_NOFILE) {\n      com_err(whoami, code, string_text(KPW_STR_WHILE_LOOKING_AT_CC));\n      return(MISC_EXIT_STATUS);\n    }\n\n    /* if either krb5_cc failed check the passwd file */\n    if (code != 0) {\n      pw = getpwuid( getuid());\n      if (pw == NULL) {\n\tcom_err(whoami, 0, string_text(KPW_STR_NOT_IN_PASSWD_FILE));\n\treturn(MISC_EXIT_STATUS);\n      }\n      princ_str = strdup(pw->pw_name);\n    }\n  }    \n  \n  display_intro_message(string_text(KPW_STR_CHANGING_PW_FOR), princ_str);\n\n  /* Need to get a krb5_principal, unless we started from with one from\n     the credential cache */\n\n  if (! princ) {\n      code = krb5_parse_name (context, princ_str, &princ);\n      if (code != 0) {\n\t  com_err(whoami, code, string_text(KPW_STR_PARSE_NAME), princ_str);\n\t  free(princ_str);\n\t  return(MISC_EXIT_STATUS);\n      }\n  }\n  \n  pwsize = sizeof(password);\n  code = read_old_password(context, password, &pwsize);\n\n  if (code != 0) {\n    memset(password, 0, sizeof(password));\n    com_err(whoami, code, string_text(KPW_STR_WHILE_READING_PASSWORD));\n    krb5_free_principal(context, princ);\n    free(princ_str);\n    return(MISC_EXIT_STATUS);\n  }\n  if (pwsize == 0) {\n    memset(password, 0, sizeof(password));\n    com_err(whoami, 0, string_text(KPW_STR_NO_PASSWORD_READ));\n    krb5_free_principal(context, princ);\n    free(princ_str);\n    return(5);\n  }\n\n  admin_realm[0] = '\\0';\n  strncat(admin_realm, krb5_princ_realm(context, princ)->data, \n\t  krb5_princ_realm(context, princ)->length);\n\n  code = ovsec_kadm_init(princ_str, password, KADM5_CHANGEPW_SERVICE,\n\t\t\t admin_realm /* we probably should take a -r */\n\t\t\t             /* someday */,\n\t\t\t OVSEC_KADM_STRUCT_VERSION,\n\t\t\t OVSEC_KADM_API_VERSION_1,\n\t\t\t &server_handle);\n  if (code != 0) {\n    if (code == OVSEC_KADM_BAD_PASSWORD)\n      com_err(whoami, 0, string_text(KPW_STR_OLD_PASSWORD_INCORRECT));\n    else \n      com_err(whoami, 0, string_text(KPW_STR_CANT_OPEN_ADMIN_SERVER), admin_realm,\n\t      error_message(code));\n    krb5_free_principal(context, princ);\n    free(princ_str);\n    return((code == OVSEC_KADM_BAD_PASSWORD)?2:3);\n  }\n\n  /* Explain policy restrictions on new password if any. */\n  /* Note: copy of this exists in login (kverify.c/get_verified_in_tkt). */\n\n  code = ovsec_kadm_get_principal(server_handle, princ, &principal_entry);\n  if (code != 0) {\n    com_err(whoami, 0,\n\t    string_text((code == OVSEC_KADM_UNK_PRINC)\n\t\t\t? KPW_STR_PRIN_UNKNOWN : KPW_STR_CANT_GET_POLICY_INFO),\n\t    princ_str);\n    krb5_free_principal(context, princ);\n    free(princ_str);\n    (void) ovsec_kadm_destroy(server_handle);\n    return((code == OVSEC_KADM_UNK_PRINC) ? 1 : MISC_EXIT_STATUS);\n  }\n  if ((principal_entry->aux_attributes & OVSEC_KADM_POLICY) != 0) {\n    code = ovsec_kadm_get_policy(server_handle,\n\t\t\t\t principal_entry->policy, &policy_entry);\n    if (code != 0) {\n      /* doesn't matter which error comes back, there's no nice recovery\n\t or need to differentiate to the user */\n      com_err(whoami, 0,\n\t      string_text(KPW_STR_CANT_GET_POLICY_INFO), princ_str);\n      (void) ovsec_kadm_free_principal_ent(server_handle, principal_entry);\n      krb5_free_principal(context, princ);\n      free(princ_str);\n      (void) ovsec_kadm_destroy(server_handle);\n      return(MISC_EXIT_STATUS);\n    }\n    com_err(whoami, 0, string_text(KPW_STR_POLICY_EXPLANATION),\n\t    princ_str, principal_entry->policy,\n\t    policy_entry->pw_min_length, policy_entry->pw_min_classes);\n\n    code = ovsec_kadm_free_principal_ent(server_handle, principal_entry);\n    if (code) {\n\t(void) ovsec_kadm_free_policy_ent(server_handle, policy_entry);\n\tkrb5_free_principal(context, princ);\n\tfree(princ_str);\n\tcom_err(whoami, code, string_text(KPW_STR_WHILE_FREEING_PRINCIPAL));\n\t(void) ovsec_kadm_destroy(server_handle);\n\treturn(MISC_EXIT_STATUS);\n    }\n\n    code = ovsec_kadm_free_policy_ent(server_handle, policy_entry);\n    if (code) {\n\tkrb5_free_principal(context, princ);\n\tfree(princ_str);\n\tcom_err(whoami, code, string_text(KPW_STR_WHILE_FREEING_POLICY));\n\t(void) ovsec_kadm_destroy(server_handle);\n\treturn(MISC_EXIT_STATUS);\n    }\n  }\n  else {\n    /* kpasswd *COULD* output something here to encourage the choice\n       of good passwords, in the absence of an enforced policy. */\n      code = ovsec_kadm_free_principal_ent(server_handle, principal_entry);\n      if (code) {\n\t  krb5_free_principal(context, princ);\n\t  free(princ_str);\n\t  com_err(whoami, code, string_text(KPW_STR_WHILE_FREEING_PRINCIPAL));\n\t  (void) ovsec_kadm_destroy(server_handle);\n\t  return(MISC_EXIT_STATUS);\n      }\n  }\n\n  pwsize = sizeof(password);\n  code = read_new_password(server_handle, password, &pwsize, msg_ret, princ);\n  memset(password, 0, sizeof(password));\n\n  if (code)\n    com_err(whoami, 0, msg_ret);\n\n  krb5_free_principal(context, princ);\n  free(princ_str);\n\n  (void) ovsec_kadm_destroy(server_handle);\n  \n  if (code == KRB5_LIBOS_CANTREADPWD)\n     return(5);\n  else if (code)\n     return(4);\n  else\n     return(0);\n}",
    "includes": [
      "#include <string.h>",
      "#include <pwd.h>",
      "#include <stdio.h>",
      "#include \"kpasswd.h\"",
      "#include \"kpasswd_strings.h\"",
      "#include <krb5.h>",
      "#include <kadm5/admin.h>"
    ],
    "macros_used": [
      "#define MISC_EXIT_STATUS 6",
      "#define string_text error_message"
    ],
    "globals_used": [
      "extern char *whoami;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "ovsec_kadm_destroy",
          "args": [
            "server_handle"
          ],
          "line": 272
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "princ_str"
          ],
          "line": 270
        },
        "resolved": true,
        "details": {
          "function_name": "free_policy_ent",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/testing/util/tcl_ovsec_kadm.c",
          "lines": "939-943",
          "snippet": "static void free_policy_ent(ovsec_kadm_policy_ent_t *policy)\n{\n     free(*policy);\n     *policy = 0;\n}",
          "includes": [
            "#include \"tcl_kadm5.h\"",
            "#include <stdlib.h>",
            "#include <errno.h>",
            "#include <k5-int.h>",
            "#include <com_err.h>",
            "#include <kadm5/admin.h>",
            "#include <tcl/tcl.h>",
            "#include <tcl.h>",
            "#include <string.h>",
            "#include <stdio.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"tcl_kadm5.h\"\n#include <stdlib.h>\n#include <errno.h>\n#include <k5-int.h>\n#include <com_err.h>\n#include <kadm5/admin.h>\n#include <tcl/tcl.h>\n#include <tcl.h>\n#include <string.h>\n#include <stdio.h>\n\nstatic void free_policy_ent(ovsec_kadm_policy_ent_t *policy)\n{\n     free(*policy);\n     *policy = 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "krb5_free_principal",
          "args": [
            "context",
            "princ"
          ],
          "line": 269
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "0",
            "msg_ret"
          ],
          "line": 267
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "password",
            "0",
            "sizeof(password)"
          ],
          "line": 264
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "read_new_password",
          "args": [
            "server_handle",
            "password",
            "&pwsize",
            "msg_ret",
            "princ"
          ],
          "line": 263
        },
        "resolved": true,
        "details": {
          "function_name": "read_new_password",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/passwd/xm_kpasswd.c",
          "lines": "354-398",
          "snippet": "long\nread_new_password(server_handle, password, pwsize, msg_ret, princ)\n     void *server_handle;\n     char *password;\n     unsigned int *pwsize;\n     char *msg_ret;\n     krb5_principal princ;\n{\n  char *password2 = (char *) malloc(*pwsize * sizeof(char));\n  int pwsize2 = *pwsize;\n\n  SetStandardCursor();\n\n  if (password2 == NULL)\n    {\n      strcpy(msg_ret, error_message(ENOMEM));\n      SetWatchCursor();\n      return(ENOMEM);\n    }\n\n  XtManageChild(new_lbl); XtUnmanageChild(old_lbl);\n  read_password(password, pwsize);\n  XtManageChild(again_lbl); XtUnmanageChild(new_lbl);\n  read_password(password2, &pwsize2);\n\n  if (strcmp(password, password2))\n    {\n      memset(password, 0, *pwsize);\n\n      memset(password2, 0, pwsize2);\n      free(password2);\n      \n      strcpy(msg_ret, string_text(CHPASS_UTIL_NEW_PASSWORD_MISMATCH));\n      SetWatchCursor();\n      return(KRB5_LIBOS_BADPWDMATCH);\n    }\n\n  memset(password2, 0, pwsize2);\n  free(password2);\n\n  SetWatchCursor();\n  return (ovsec_kadm_chpass_principal_util(server_handle, princ, password,\n                                            NULL /* don't need new pw back */,\n                                            msg_ret));\n}",
          "includes": [
            "#\tinclude <varargs.h>",
            "#\tinclude <stdarg.h>",
            "#include <X11/Shell.h>",
            "#include <X11/cursorfont.h>",
            "#include <Xm/Separator.h>",
            "#include <Xm/Label.h>",
            "#include <Xm/PushB.h>",
            "#include <Xm/Text.h>",
            "#include <Xm/Form.h>",
            "#include <Xm/ScrolledW.h>",
            "#include <Xm/MessageB.h>",
            "#include <Xm/Xm.h>",
            "#include <string.h>",
            "#include <pwd.h>",
            "#include <stdio.h>",
            "#include \"kpasswd_strings.h\"",
            "#include <krb5.h>",
            "#include <kadm5/admin.h>"
          ],
          "macros_used": [
            "#define string_text error_message"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#\tinclude <varargs.h>\n#\tinclude <stdarg.h>\n#include <X11/Shell.h>\n#include <X11/cursorfont.h>\n#include <Xm/Separator.h>\n#include <Xm/Label.h>\n#include <Xm/PushB.h>\n#include <Xm/Text.h>\n#include <Xm/Form.h>\n#include <Xm/ScrolledW.h>\n#include <Xm/MessageB.h>\n#include <Xm/Xm.h>\n#include <string.h>\n#include <pwd.h>\n#include <stdio.h>\n#include \"kpasswd_strings.h\"\n#include <krb5.h>\n#include <kadm5/admin.h>\n\n#define string_text error_message\n\nlong\nread_new_password(server_handle, password, pwsize, msg_ret, princ)\n     void *server_handle;\n     char *password;\n     unsigned int *pwsize;\n     char *msg_ret;\n     krb5_principal princ;\n{\n  char *password2 = (char *) malloc(*pwsize * sizeof(char));\n  int pwsize2 = *pwsize;\n\n  SetStandardCursor();\n\n  if (password2 == NULL)\n    {\n      strcpy(msg_ret, error_message(ENOMEM));\n      SetWatchCursor();\n      return(ENOMEM);\n    }\n\n  XtManageChild(new_lbl); XtUnmanageChild(old_lbl);\n  read_password(password, pwsize);\n  XtManageChild(again_lbl); XtUnmanageChild(new_lbl);\n  read_password(password2, &pwsize2);\n\n  if (strcmp(password, password2))\n    {\n      memset(password, 0, *pwsize);\n\n      memset(password2, 0, pwsize2);\n      free(password2);\n      \n      strcpy(msg_ret, string_text(CHPASS_UTIL_NEW_PASSWORD_MISMATCH));\n      SetWatchCursor();\n      return(KRB5_LIBOS_BADPWDMATCH);\n    }\n\n  memset(password2, 0, pwsize2);\n  free(password2);\n\n  SetWatchCursor();\n  return (ovsec_kadm_chpass_principal_util(server_handle, princ, password,\n                                            NULL /* don't need new pw back */,\n                                            msg_ret));\n}"
        }
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_destroy",
          "args": [
            "server_handle"
          ],
          "line": 257
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "code",
            "string_text(KPW_STR_WHILE_FREEING_PRINCIPAL)"
          ],
          "line": 256
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_WHILE_FREEING_PRINCIPAL"
          ],
          "line": 256
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_free_principal",
          "args": [
            "context",
            "princ"
          ],
          "line": 254
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_free_principal_ent",
          "args": [
            "server_handle",
            "principal_entry"
          ],
          "line": 252
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_destroy",
          "args": [
            "server_handle"
          ],
          "line": 245
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "code",
            "string_text(KPW_STR_WHILE_FREEING_POLICY)"
          ],
          "line": 244
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_WHILE_FREEING_POLICY"
          ],
          "line": 244
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_free_principal",
          "args": [
            "context",
            "princ"
          ],
          "line": 242
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_free_policy_ent",
          "args": [
            "server_handle",
            "policy_entry"
          ],
          "line": 240
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_destroy",
          "args": [
            "server_handle"
          ],
          "line": 236
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "code",
            "string_text(KPW_STR_WHILE_FREEING_PRINCIPAL)"
          ],
          "line": 235
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_WHILE_FREEING_PRINCIPAL"
          ],
          "line": 235
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_free_principal",
          "args": [
            "context",
            "princ"
          ],
          "line": 233
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_free_policy_ent",
          "args": [
            "server_handle",
            "policy_entry"
          ],
          "line": 232
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_free_principal_ent",
          "args": [
            "server_handle",
            "principal_entry"
          ],
          "line": 230
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "0",
            "string_text(KPW_STR_POLICY_EXPLANATION)",
            "princ_str",
            "principal_entry->policy",
            "policy_entry->pw_min_length",
            "policy_entry->pw_min_classes"
          ],
          "line": 226
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_POLICY_EXPLANATION"
          ],
          "line": 226
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_destroy",
          "args": [
            "server_handle"
          ],
          "line": 223
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_free_principal",
          "args": [
            "context",
            "princ"
          ],
          "line": 221
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_free_principal_ent",
          "args": [
            "server_handle",
            "principal_entry"
          ],
          "line": 220
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "0",
            "string_text(KPW_STR_CANT_GET_POLICY_INFO)",
            "princ_str"
          ],
          "line": 218
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_CANT_GET_POLICY_INFO"
          ],
          "line": 219
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_get_policy",
          "args": [
            "server_handle",
            "principal_entry->policy",
            "&policy_entry"
          ],
          "line": 213
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_destroy",
          "args": [
            "server_handle"
          ],
          "line": 209
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_free_principal",
          "args": [
            "context",
            "princ"
          ],
          "line": 207
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "0",
            "string_text((code == OVSEC_KADM_UNK_PRINC)\n\t\t\t? KPW_STR_PRIN_UNKNOWN : KPW_STR_CANT_GET_POLICY_INFO)",
            "princ_str"
          ],
          "line": 203
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "(code == OVSEC_KADM_UNK_PRINC)\n\t\t\t? KPW_STR_PRIN_UNKNOWN : KPW_STR_CANT_GET_POLICY_INFO"
          ],
          "line": 204
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_get_principal",
          "args": [
            "server_handle",
            "princ",
            "&principal_entry"
          ],
          "line": 201
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_free_principal",
          "args": [
            "context",
            "princ"
          ],
          "line": 193
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "0",
            "string_text(KPW_STR_CANT_OPEN_ADMIN_SERVER)",
            "admin_realm",
            "error_message(code)"
          ],
          "line": 191
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "error_message",
          "args": [
            "code"
          ],
          "line": 192
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_CANT_OPEN_ADMIN_SERVER"
          ],
          "line": 191
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "0",
            "string_text(KPW_STR_OLD_PASSWORD_INCORRECT)"
          ],
          "line": 189
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_OLD_PASSWORD_INCORRECT"
          ],
          "line": 189
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ovsec_kadm_init",
          "args": [
            "princ_str",
            "password",
            "KADM5_CHANGEPW_SERVICE",
            "admin_realm/* we probably should take a -r *//* someday */",
            "OVSEC_KADM_STRUCT_VERSION",
            "OVSEC_KADM_API_VERSION_1",
            "&server_handle"
          ],
          "line": 181
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strncat",
          "args": [
            "admin_realm",
            "krb5_princ_realm(context, princ)->data",
            "krb5_princ_realm(context, princ)->length"
          ],
          "line": 178
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_princ_realm",
          "args": [
            "context",
            "princ"
          ],
          "line": 179
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_princ_realm",
          "args": [
            "context",
            "princ"
          ],
          "line": 178
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_free_principal",
          "args": [
            "context",
            "princ"
          ],
          "line": 172
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "0",
            "string_text(KPW_STR_NO_PASSWORD_READ)"
          ],
          "line": 171
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_NO_PASSWORD_READ"
          ],
          "line": 171
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "password",
            "0",
            "sizeof(password)"
          ],
          "line": 170
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_free_principal",
          "args": [
            "context",
            "princ"
          ],
          "line": 165
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "code",
            "string_text(KPW_STR_WHILE_READING_PASSWORD)"
          ],
          "line": 164
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_WHILE_READING_PASSWORD"
          ],
          "line": 164
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "password",
            "0",
            "sizeof(password)"
          ],
          "line": 163
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "read_old_password",
          "args": [
            "context",
            "password",
            "&pwsize"
          ],
          "line": 160
        },
        "resolved": true,
        "details": {
          "function_name": "read_old_password",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/passwd/xm_kpasswd.c",
          "lines": "340-352",
          "snippet": "long\nread_old_password(context, password, pwsize)\n     krb5_context context;\n     char *password;\n     unsigned int *pwsize;\n{\n  long code;\n\n  XtManageChild(old_lbl);\n  code = read_password(password, pwsize);\n  SetWatchCursor();\n  return code;\n}",
          "includes": [
            "#\tinclude <varargs.h>",
            "#\tinclude <stdarg.h>",
            "#include <X11/Shell.h>",
            "#include <X11/cursorfont.h>",
            "#include <Xm/Separator.h>",
            "#include <Xm/Label.h>",
            "#include <Xm/PushB.h>",
            "#include <Xm/Text.h>",
            "#include <Xm/Form.h>",
            "#include <Xm/ScrolledW.h>",
            "#include <Xm/MessageB.h>",
            "#include <Xm/Xm.h>",
            "#include <string.h>",
            "#include <pwd.h>",
            "#include <stdio.h>",
            "#include \"kpasswd_strings.h\"",
            "#include <krb5.h>",
            "#include <kadm5/admin.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#\tinclude <varargs.h>\n#\tinclude <stdarg.h>\n#include <X11/Shell.h>\n#include <X11/cursorfont.h>\n#include <Xm/Separator.h>\n#include <Xm/Label.h>\n#include <Xm/PushB.h>\n#include <Xm/Text.h>\n#include <Xm/Form.h>\n#include <Xm/ScrolledW.h>\n#include <Xm/MessageB.h>\n#include <Xm/Xm.h>\n#include <string.h>\n#include <pwd.h>\n#include <stdio.h>\n#include \"kpasswd_strings.h\"\n#include <krb5.h>\n#include <kadm5/admin.h>\n\nlong\nread_old_password(context, password, pwsize)\n     krb5_context context;\n     char *password;\n     unsigned int *pwsize;\n{\n  long code;\n\n  XtManageChild(old_lbl);\n  code = read_password(password, pwsize);\n  SetWatchCursor();\n  return code;\n}"
        }
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "code",
            "string_text(KPW_STR_PARSE_NAME)",
            "princ_str"
          ],
          "line": 153
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_PARSE_NAME"
          ],
          "line": 153
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_parse_name",
          "args": [
            "context",
            "princ_str",
            "&princ"
          ],
          "line": 151
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "display_intro_message",
          "args": [
            "string_text(KPW_STR_CHANGING_PW_FOR)",
            "princ_str"
          ],
          "line": 145
        },
        "resolved": true,
        "details": {
          "function_name": "display_intro_message",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_cpp_ICV/CVE-2014-9422/repo/src/kadmin/passwd/xm_kpasswd.c",
          "lines": "323-337",
          "snippet": "void\ndisplay_intro_message(fmt_string, arg_string)\n     const char *fmt_string;\n     const char *arg_string;\n{\n  XmString xmstr;\n  char buf[1024];\n\n  sprintf(buf, fmt_string, arg_string);\n\n  xmstr = XmStringCreateLtoR(buf, XmSTRING_DEFAULT_CHARSET);\n  XtVaSetValues(main_lbl, XmNlabelString, xmstr, NULL);\n  XmStringFree(xmstr);\n  XtManageChild(main_lbl);\n}",
          "includes": [
            "#\tinclude <varargs.h>",
            "#\tinclude <stdarg.h>",
            "#include <X11/Shell.h>",
            "#include <X11/cursorfont.h>",
            "#include <Xm/Separator.h>",
            "#include <Xm/Label.h>",
            "#include <Xm/PushB.h>",
            "#include <Xm/Text.h>",
            "#include <Xm/Form.h>",
            "#include <Xm/ScrolledW.h>",
            "#include <Xm/MessageB.h>",
            "#include <Xm/Xm.h>",
            "#include <string.h>",
            "#include <pwd.h>",
            "#include <stdio.h>",
            "#include \"kpasswd_strings.h\"",
            "#include <krb5.h>",
            "#include <kadm5/admin.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "Widget quit_btn, help_btn, old_lbl, new_lbl, again_lbl, main_lbl;"
          ],
          "called_functions": [],
          "contextual_snippet": "#\tinclude <varargs.h>\n#\tinclude <stdarg.h>\n#include <X11/Shell.h>\n#include <X11/cursorfont.h>\n#include <Xm/Separator.h>\n#include <Xm/Label.h>\n#include <Xm/PushB.h>\n#include <Xm/Text.h>\n#include <Xm/Form.h>\n#include <Xm/ScrolledW.h>\n#include <Xm/MessageB.h>\n#include <Xm/Xm.h>\n#include <string.h>\n#include <pwd.h>\n#include <stdio.h>\n#include \"kpasswd_strings.h\"\n#include <krb5.h>\n#include <kadm5/admin.h>\n\nWidget quit_btn, help_btn, old_lbl, new_lbl, again_lbl, main_lbl;\n\nvoid\ndisplay_intro_message(fmt_string, arg_string)\n     const char *fmt_string;\n     const char *arg_string;\n{\n  XmString xmstr;\n  char buf[1024];\n\n  sprintf(buf, fmt_string, arg_string);\n\n  xmstr = XmStringCreateLtoR(buf, XmSTRING_DEFAULT_CHARSET);\n  XtVaSetValues(main_lbl, XmNlabelString, xmstr, NULL);\n  XmStringFree(xmstr);\n  XtManageChild(main_lbl);\n}"
        }
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_CHANGING_PW_FOR"
          ],
          "line": 145
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "pw->pw_name"
          ],
          "line": 141
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "0",
            "string_text(KPW_STR_NOT_IN_PASSWD_FILE)"
          ],
          "line": 138
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_NOT_IN_PASSWD_FILE"
          ],
          "line": 138
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getpwuid",
          "args": [
            "getuid()"
          ],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getuid",
          "args": [],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "code",
            "string_text(KPW_STR_WHILE_LOOKING_AT_CC)"
          ],
          "line": 130
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_WHILE_LOOKING_AT_CC"
          ],
          "line": 130
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "code",
            "string_text(KPW_STR_UNPARSE_NAME)"
          ],
          "line": 118
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_text",
          "args": [
            "KPW_STR_UNPARSE_NAME"
          ],
          "line": 118
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_unparse_name",
          "args": [
            "context",
            "princ",
            "&princ_str"
          ],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_cc_close",
          "args": [
            "context",
            "ccache"
          ],
          "line": 114
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_cc_get_principal",
          "args": [
            "context",
            "ccache",
            "&princ"
          ],
          "line": 111
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_cc_default",
          "args": [
            "context",
            "&ccache"
          ],
          "line": 107
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "argv[1]"
          ],
          "line": 105
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "com_err",
          "args": [
            "whoami",
            "KPW_STR_USAGE",
            "0"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <string.h>\n#include <pwd.h>\n#include <stdio.h>\n#include \"kpasswd.h\"\n#include \"kpasswd_strings.h\"\n#include <krb5.h>\n#include <kadm5/admin.h>\n\n#define MISC_EXIT_STATUS 6\n#define string_text error_message\n\nextern char *whoami;\n\nint\nkpasswd(context, argc, argv)\n   krb5_context context;\n   int argc;\n   char *argv[];\n{\n  int code;\n  krb5_ccache ccache = NULL;\n  krb5_principal princ = 0;\n  char *princ_str;\n  struct passwd *pw = 0;\n  unsigned int pwsize;\n  char password[255];  /* I don't really like 255 but that's what kinit uses */\n  char msg_ret[1024], admin_realm[1024];\n  ovsec_kadm_principal_ent_t principal_entry = NULL;\n  ovsec_kadm_policy_ent_t policy_entry = NULL;\n  void *server_handle;\n\n  if (argc > 2) {\n      com_err(whoami, KPW_STR_USAGE, 0);\n      return(7);\n      /*NOTREACHED*/\n    }\n\n  /************************************\n   *  Get principal name to change    * \n   ************************************/\n\n  /* Look on the command line first, followed by the default credential\n     cache, followed by defaulting to the Unix user name */\n\n  if (argc == 2)\n    princ_str = strdup(argv[1]);\n  else {\n    code = krb5_cc_default(context, &ccache);\n    /* If we succeed, find who is in the credential cache */\n    if (code == 0) {\n      /* Get default principal from cache if one exists */\n      code = krb5_cc_get_principal(context, ccache, &princ);\n      /* if we got a principal, unparse it, otherwise get out of the if\n\t with an error code */\n      (void) krb5_cc_close(context, ccache);\n      if (code == 0) {\n\tcode = krb5_unparse_name(context, princ, &princ_str);\n\tif (code != 0) {\n\t  com_err(whoami,  code, string_text(KPW_STR_UNPARSE_NAME));\n\t  return(MISC_EXIT_STATUS);\n\t}\n      }\n    }\n\n    /* this is a crock.. we want to compare against */\n    /* \"KRB5_CC_DOESNOTEXIST\" but there is no such error code, and */\n    /* both the file and stdio types return FCC_NOFILE.  If there is */\n    /* ever another ccache type (or if the error codes are ever */\n    /* fixed), this code will have to be updated. */\n    if (code && code != KRB5_FCC_NOFILE) {\n      com_err(whoami, code, string_text(KPW_STR_WHILE_LOOKING_AT_CC));\n      return(MISC_EXIT_STATUS);\n    }\n\n    /* if either krb5_cc failed check the passwd file */\n    if (code != 0) {\n      pw = getpwuid( getuid());\n      if (pw == NULL) {\n\tcom_err(whoami, 0, string_text(KPW_STR_NOT_IN_PASSWD_FILE));\n\treturn(MISC_EXIT_STATUS);\n      }\n      princ_str = strdup(pw->pw_name);\n    }\n  }    \n  \n  display_intro_message(string_text(KPW_STR_CHANGING_PW_FOR), princ_str);\n\n  /* Need to get a krb5_principal, unless we started from with one from\n     the credential cache */\n\n  if (! princ) {\n      code = krb5_parse_name (context, princ_str, &princ);\n      if (code != 0) {\n\t  com_err(whoami, code, string_text(KPW_STR_PARSE_NAME), princ_str);\n\t  free(princ_str);\n\t  return(MISC_EXIT_STATUS);\n      }\n  }\n  \n  pwsize = sizeof(password);\n  code = read_old_password(context, password, &pwsize);\n\n  if (code != 0) {\n    memset(password, 0, sizeof(password));\n    com_err(whoami, code, string_text(KPW_STR_WHILE_READING_PASSWORD));\n    krb5_free_principal(context, princ);\n    free(princ_str);\n    return(MISC_EXIT_STATUS);\n  }\n  if (pwsize == 0) {\n    memset(password, 0, sizeof(password));\n    com_err(whoami, 0, string_text(KPW_STR_NO_PASSWORD_READ));\n    krb5_free_principal(context, princ);\n    free(princ_str);\n    return(5);\n  }\n\n  admin_realm[0] = '\\0';\n  strncat(admin_realm, krb5_princ_realm(context, princ)->data, \n\t  krb5_princ_realm(context, princ)->length);\n\n  code = ovsec_kadm_init(princ_str, password, KADM5_CHANGEPW_SERVICE,\n\t\t\t admin_realm /* we probably should take a -r */\n\t\t\t             /* someday */,\n\t\t\t OVSEC_KADM_STRUCT_VERSION,\n\t\t\t OVSEC_KADM_API_VERSION_1,\n\t\t\t &server_handle);\n  if (code != 0) {\n    if (code == OVSEC_KADM_BAD_PASSWORD)\n      com_err(whoami, 0, string_text(KPW_STR_OLD_PASSWORD_INCORRECT));\n    else \n      com_err(whoami, 0, string_text(KPW_STR_CANT_OPEN_ADMIN_SERVER), admin_realm,\n\t      error_message(code));\n    krb5_free_principal(context, princ);\n    free(princ_str);\n    return((code == OVSEC_KADM_BAD_PASSWORD)?2:3);\n  }\n\n  /* Explain policy restrictions on new password if any. */\n  /* Note: copy of this exists in login (kverify.c/get_verified_in_tkt). */\n\n  code = ovsec_kadm_get_principal(server_handle, princ, &principal_entry);\n  if (code != 0) {\n    com_err(whoami, 0,\n\t    string_text((code == OVSEC_KADM_UNK_PRINC)\n\t\t\t? KPW_STR_PRIN_UNKNOWN : KPW_STR_CANT_GET_POLICY_INFO),\n\t    princ_str);\n    krb5_free_principal(context, princ);\n    free(princ_str);\n    (void) ovsec_kadm_destroy(server_handle);\n    return((code == OVSEC_KADM_UNK_PRINC) ? 1 : MISC_EXIT_STATUS);\n  }\n  if ((principal_entry->aux_attributes & OVSEC_KADM_POLICY) != 0) {\n    code = ovsec_kadm_get_policy(server_handle,\n\t\t\t\t principal_entry->policy, &policy_entry);\n    if (code != 0) {\n      /* doesn't matter which error comes back, there's no nice recovery\n\t or need to differentiate to the user */\n      com_err(whoami, 0,\n\t      string_text(KPW_STR_CANT_GET_POLICY_INFO), princ_str);\n      (void) ovsec_kadm_free_principal_ent(server_handle, principal_entry);\n      krb5_free_principal(context, princ);\n      free(princ_str);\n      (void) ovsec_kadm_destroy(server_handle);\n      return(MISC_EXIT_STATUS);\n    }\n    com_err(whoami, 0, string_text(KPW_STR_POLICY_EXPLANATION),\n\t    princ_str, principal_entry->policy,\n\t    policy_entry->pw_min_length, policy_entry->pw_min_classes);\n\n    code = ovsec_kadm_free_principal_ent(server_handle, principal_entry);\n    if (code) {\n\t(void) ovsec_kadm_free_policy_ent(server_handle, policy_entry);\n\tkrb5_free_principal(context, princ);\n\tfree(princ_str);\n\tcom_err(whoami, code, string_text(KPW_STR_WHILE_FREEING_PRINCIPAL));\n\t(void) ovsec_kadm_destroy(server_handle);\n\treturn(MISC_EXIT_STATUS);\n    }\n\n    code = ovsec_kadm_free_policy_ent(server_handle, policy_entry);\n    if (code) {\n\tkrb5_free_principal(context, princ);\n\tfree(princ_str);\n\tcom_err(whoami, code, string_text(KPW_STR_WHILE_FREEING_POLICY));\n\t(void) ovsec_kadm_destroy(server_handle);\n\treturn(MISC_EXIT_STATUS);\n    }\n  }\n  else {\n    /* kpasswd *COULD* output something here to encourage the choice\n       of good passwords, in the absence of an enforced policy. */\n      code = ovsec_kadm_free_principal_ent(server_handle, principal_entry);\n      if (code) {\n\t  krb5_free_principal(context, princ);\n\t  free(princ_str);\n\t  com_err(whoami, code, string_text(KPW_STR_WHILE_FREEING_PRINCIPAL));\n\t  (void) ovsec_kadm_destroy(server_handle);\n\t  return(MISC_EXIT_STATUS);\n      }\n  }\n\n  pwsize = sizeof(password);\n  code = read_new_password(server_handle, password, &pwsize, msg_ret, princ);\n  memset(password, 0, sizeof(password));\n\n  if (code)\n    com_err(whoami, 0, msg_ret);\n\n  krb5_free_principal(context, princ);\n  free(princ_str);\n\n  (void) ovsec_kadm_destroy(server_handle);\n  \n  if (code == KRB5_LIBOS_CANTREADPWD)\n     return(5);\n  else if (code)\n     return(4);\n  else\n     return(0);\n}"
  }
]