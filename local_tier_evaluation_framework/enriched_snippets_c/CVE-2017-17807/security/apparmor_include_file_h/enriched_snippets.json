[
  {
    "function_name": "aa_map_file_to_perms",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/include/file.h",
    "lines": "217-236",
    "snippet": "static inline u32 aa_map_file_to_perms(struct file *file)\n{\n\tint flags = file->f_flags;\n\tu32 perms = 0;\n\n\tif (file->f_mode & FMODE_WRITE)\n\t\tperms |= MAY_WRITE;\n\tif (file->f_mode & FMODE_READ)\n\t\tperms |= MAY_READ;\n\n\tif ((flags & O_APPEND) && (perms & MAY_WRITE))\n\t\tperms = (perms & ~MAY_WRITE) | MAY_APPEND;\n\t/* trunc implies write permission */\n\tif (flags & O_TRUNC)\n\t\tperms |= MAY_WRITE;\n\tif (flags & O_CREAT)\n\t\tperms |= AA_MAY_CREATE;\n\n\treturn perms;\n}",
    "includes": [
      "#include \"perms.h\"",
      "#include \"match.h\"",
      "#include \"domain.h\"",
      "#include <linux/spinlock.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"perms.h\"\n#include \"match.h\"\n#include \"domain.h\"\n#include <linux/spinlock.h>\n\nstatic inline u32 aa_map_file_to_perms(struct file *file)\n{\n\tint flags = file->f_flags;\n\tu32 perms = 0;\n\n\tif (file->f_mode & FMODE_WRITE)\n\t\tperms |= MAY_WRITE;\n\tif (file->f_mode & FMODE_READ)\n\t\tperms |= MAY_READ;\n\n\tif ((flags & O_APPEND) && (perms & MAY_WRITE))\n\t\tperms = (perms & ~MAY_WRITE) | MAY_APPEND;\n\t/* trunc implies write permission */\n\tif (flags & O_TRUNC)\n\t\tperms |= MAY_WRITE;\n\tif (flags & O_CREAT)\n\t\tperms |= AA_MAY_CREATE;\n\n\treturn perms;\n}"
  },
  {
    "function_name": "aa_free_file_rules",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/include/file.h",
    "lines": "205-209",
    "snippet": "static inline void aa_free_file_rules(struct aa_file_rules *rules)\n{\n\taa_put_dfa(rules->dfa);\n\taa_free_domain_entries(&rules->trans);\n}",
    "includes": [
      "#include \"perms.h\"",
      "#include \"match.h\"",
      "#include \"domain.h\"",
      "#include <linux/spinlock.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "aa_free_domain_entries",
          "args": [
            "&rules->trans"
          ],
          "line": 208
        },
        "resolved": true,
        "details": {
          "function_name": "aa_free_domain_entries",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/domain.c",
          "lines": "38-50",
          "snippet": "void aa_free_domain_entries(struct aa_domain *domain)\n{\n\tint i;\n\tif (domain) {\n\t\tif (!domain->table)\n\t\t\treturn;\n\n\t\tfor (i = 0; i < domain->size; i++)\n\t\t\tkzfree(domain->table[i]);\n\t\tkzfree(domain->table);\n\t\tdomain->table = NULL;\n\t}\n}",
          "includes": [
            "#include \"include/policy_ns.h\"",
            "#include \"include/policy.h\"",
            "#include \"include/path.h\"",
            "#include \"include/match.h\"",
            "#include \"include/ipc.h\"",
            "#include \"include/file.h\"",
            "#include \"include/domain.h\"",
            "#include \"include/context.h\"",
            "#include \"include/apparmorfs.h\"",
            "#include \"include/audit.h\"",
            "#include <linux/personality.h>",
            "#include <linux/tracehook.h>",
            "#include <linux/syscalls.h>",
            "#include <linux/mount.h>",
            "#include <linux/file.h>",
            "#include <linux/fdtable.h>",
            "#include <linux/errno.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"include/policy_ns.h\"\n#include \"include/policy.h\"\n#include \"include/path.h\"\n#include \"include/match.h\"\n#include \"include/ipc.h\"\n#include \"include/file.h\"\n#include \"include/domain.h\"\n#include \"include/context.h\"\n#include \"include/apparmorfs.h\"\n#include \"include/audit.h\"\n#include <linux/personality.h>\n#include <linux/tracehook.h>\n#include <linux/syscalls.h>\n#include <linux/mount.h>\n#include <linux/file.h>\n#include <linux/fdtable.h>\n#include <linux/errno.h>\n\nvoid aa_free_domain_entries(struct aa_domain *domain)\n{\n\tint i;\n\tif (domain) {\n\t\tif (!domain->table)\n\t\t\treturn;\n\n\t\tfor (i = 0; i < domain->size; i++)\n\t\t\tkzfree(domain->table[i]);\n\t\tkzfree(domain->table);\n\t\tdomain->table = NULL;\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "aa_put_dfa",
          "args": [
            "rules->dfa"
          ],
          "line": 207
        },
        "resolved": true,
        "details": {
          "function_name": "aa_put_dfa",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/include/match.h",
          "lines": "156-160",
          "snippet": "static inline void aa_put_dfa(struct aa_dfa *dfa)\n{\n\tif (dfa)\n\t\tkref_put(&dfa->count, aa_dfa_free_kref);\n}",
          "includes": [
            "#include <linux/kref.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <linux/kref.h>\n\nstatic inline void aa_put_dfa(struct aa_dfa *dfa)\n{\n\tif (dfa)\n\t\tkref_put(&dfa->count, aa_dfa_free_kref);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"perms.h\"\n#include \"match.h\"\n#include \"domain.h\"\n#include <linux/spinlock.h>\n\nstatic inline void aa_free_file_rules(struct aa_file_rules *rules)\n{\n\taa_put_dfa(rules->dfa);\n\taa_free_domain_entries(&rules->trans);\n}"
  },
  {
    "function_name": "dfa_map_xindex",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/include/file.h",
    "lines": "115-139",
    "snippet": "static inline u16 dfa_map_xindex(u16 mask)\n{\n\tu16 old_index = (mask >> 10) & 0xf;\n\tu16 index = 0;\n\n\tif (mask & 0x100)\n\t\tindex |= AA_X_UNSAFE;\n\tif (mask & 0x200)\n\t\tindex |= AA_X_INHERIT;\n\tif (mask & 0x80)\n\t\tindex |= AA_X_UNCONFINED;\n\n\tif (old_index == 1) {\n\t\tindex |= AA_X_UNCONFINED;\n\t} else if (old_index == 2) {\n\t\tindex |= AA_X_NAME;\n\t} else if (old_index == 3) {\n\t\tindex |= AA_X_NAME | AA_X_CHILD;\n\t} else if (old_index) {\n\t\tindex |= AA_X_TABLE;\n\t\tindex |= old_index - 4;\n\t}\n\n\treturn index;\n}",
    "includes": [
      "#include \"perms.h\"",
      "#include \"match.h\"",
      "#include \"domain.h\"",
      "#include <linux/spinlock.h>"
    ],
    "macros_used": [
      "#define AA_X_UNCONFINED\t\t0x8000",
      "#define AA_X_INHERIT\t\t0x4000",
      "#define AA_X_CHILD\t\t0x2000\t/* make >AA_X_NONE apply to children */",
      "#define AA_X_UNSAFE\t\t0x1000",
      "#define AA_X_TABLE\t\t0x0800\t/* use a specified name ->n# */",
      "#define AA_X_NAME\t\t0x0400\t/* use executable name px */"
    ],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"perms.h\"\n#include \"match.h\"\n#include \"domain.h\"\n#include <linux/spinlock.h>\n\n#define AA_X_UNCONFINED\t\t0x8000\n#define AA_X_INHERIT\t\t0x4000\n#define AA_X_CHILD\t\t0x2000\t/* make >AA_X_NONE apply to children */\n#define AA_X_UNSAFE\t\t0x1000\n#define AA_X_TABLE\t\t0x0800\t/* use a specified name ->n# */\n#define AA_X_NAME\t\t0x0400\t/* use executable name px */\n\nstatic inline u16 dfa_map_xindex(u16 mask)\n{\n\tu16 old_index = (mask >> 10) & 0xf;\n\tu16 index = 0;\n\n\tif (mask & 0x100)\n\t\tindex |= AA_X_UNSAFE;\n\tif (mask & 0x200)\n\t\tindex |= AA_X_INHERIT;\n\tif (mask & 0x80)\n\t\tindex |= AA_X_UNCONFINED;\n\n\tif (old_index == 1) {\n\t\tindex |= AA_X_UNCONFINED;\n\t} else if (old_index == 2) {\n\t\tindex |= AA_X_NAME;\n\t} else if (old_index == 3) {\n\t\tindex |= AA_X_NAME | AA_X_CHILD;\n\t} else if (old_index) {\n\t\tindex |= AA_X_TABLE;\n\t\tindex |= old_index - 4;\n\t}\n\n\treturn index;\n}"
  },
  {
    "function_name": "aa_get_file_label",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/include/file.h",
    "lines": "80-83",
    "snippet": "static inline struct aa_label *aa_get_file_label(struct aa_file_ctx *ctx)\n{\n\treturn aa_get_label_rcu(&ctx->label);\n}",
    "includes": [
      "#include \"perms.h\"",
      "#include \"match.h\"",
      "#include \"domain.h\"",
      "#include <linux/spinlock.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "aa_get_label_rcu",
          "args": [
            "&ctx->label"
          ],
          "line": 82
        },
        "resolved": true,
        "details": {
          "function_name": "aa_get_label_rcu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/include/label.h",
          "lines": "372-383",
          "snippet": "static inline struct aa_label *aa_get_label_rcu(struct aa_label __rcu **l)\n{\n\tstruct aa_label *c;\n\n\trcu_read_lock();\n\tdo {\n\t\tc = rcu_dereference(*l);\n\t} while (c && !kref_get_unless_zero(&c->count));\n\trcu_read_unlock();\n\n\treturn c;\n}",
          "includes": [
            "#include \"lib.h\"",
            "#include \"apparmor.h\"",
            "#include <linux/rcupdate.h>",
            "#include <linux/rbtree.h>",
            "#include <linux/audit.h>",
            "#include <linux/atomic.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"lib.h\"\n#include \"apparmor.h\"\n#include <linux/rcupdate.h>\n#include <linux/rbtree.h>\n#include <linux/audit.h>\n#include <linux/atomic.h>\n\nstatic inline struct aa_label *aa_get_label_rcu(struct aa_label __rcu **l)\n{\n\tstruct aa_label *c;\n\n\trcu_read_lock();\n\tdo {\n\t\tc = rcu_dereference(*l);\n\t} while (c && !kref_get_unless_zero(&c->count));\n\trcu_read_unlock();\n\n\treturn c;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"perms.h\"\n#include \"match.h\"\n#include \"domain.h\"\n#include <linux/spinlock.h>\n\nstatic inline struct aa_label *aa_get_file_label(struct aa_file_ctx *ctx)\n{\n\treturn aa_get_label_rcu(&ctx->label);\n}"
  },
  {
    "function_name": "aa_free_file_ctx",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/include/file.h",
    "lines": "72-78",
    "snippet": "static inline void aa_free_file_ctx(struct aa_file_ctx *ctx)\n{\n\tif (ctx) {\n\t\taa_put_label(rcu_access_pointer(ctx->label));\n\t\tkzfree(ctx);\n\t}\n}",
    "includes": [
      "#include \"perms.h\"",
      "#include \"match.h\"",
      "#include \"domain.h\"",
      "#include <linux/spinlock.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "kzfree",
          "args": [
            "ctx"
          ],
          "line": 76
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "aa_put_label",
          "args": [
            "rcu_access_pointer(ctx->label)"
          ],
          "line": 75
        },
        "resolved": true,
        "details": {
          "function_name": "aa_put_label",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/include/label.h",
          "lines": "416-420",
          "snippet": "static inline void aa_put_label(struct aa_label *l)\n{\n\tif (l)\n\t\tkref_put(&l->count, aa_label_kref);\n}",
          "includes": [
            "#include \"lib.h\"",
            "#include \"apparmor.h\"",
            "#include <linux/rcupdate.h>",
            "#include <linux/rbtree.h>",
            "#include <linux/audit.h>",
            "#include <linux/atomic.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"lib.h\"\n#include \"apparmor.h\"\n#include <linux/rcupdate.h>\n#include <linux/rbtree.h>\n#include <linux/audit.h>\n#include <linux/atomic.h>\n\nstatic inline void aa_put_label(struct aa_label *l)\n{\n\tif (l)\n\t\tkref_put(&l->count, aa_label_kref);\n}"
        }
      },
      {
        "call_info": {
          "callee": "rcu_access_pointer",
          "args": [
            "ctx->label"
          ],
          "line": 75
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"perms.h\"\n#include \"match.h\"\n#include \"domain.h\"\n#include <linux/spinlock.h>\n\nstatic inline void aa_free_file_ctx(struct aa_file_ctx *ctx)\n{\n\tif (ctx) {\n\t\taa_put_label(rcu_access_pointer(ctx->label));\n\t\tkzfree(ctx);\n\t}\n}"
  },
  {
    "function_name": "aa_alloc_file_ctx",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/include/file.h",
    "lines": "55-66",
    "snippet": "static inline struct aa_file_ctx *aa_alloc_file_ctx(struct aa_label *label,\n\t\t\t\t\t\t    gfp_t gfp)\n{\n\tstruct aa_file_ctx *ctx;\n\n\tctx = kzalloc(sizeof(struct aa_file_ctx), gfp);\n\tif (ctx) {\n\t\tspin_lock_init(&ctx->lock);\n\t\trcu_assign_pointer(ctx->label, aa_get_label(label));\n\t}\n\treturn ctx;\n}",
    "includes": [
      "#include \"perms.h\"",
      "#include \"match.h\"",
      "#include \"domain.h\"",
      "#include <linux/spinlock.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "rcu_assign_pointer",
          "args": [
            "ctx->label",
            "aa_get_label(label)"
          ],
          "line": 63
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "aa_get_label",
          "args": [
            "label"
          ],
          "line": 63
        },
        "resolved": true,
        "details": {
          "function_name": "aa_get_label_rcu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/include/label.h",
          "lines": "372-383",
          "snippet": "static inline struct aa_label *aa_get_label_rcu(struct aa_label __rcu **l)\n{\n\tstruct aa_label *c;\n\n\trcu_read_lock();\n\tdo {\n\t\tc = rcu_dereference(*l);\n\t} while (c && !kref_get_unless_zero(&c->count));\n\trcu_read_unlock();\n\n\treturn c;\n}",
          "includes": [
            "#include \"lib.h\"",
            "#include \"apparmor.h\"",
            "#include <linux/rcupdate.h>",
            "#include <linux/rbtree.h>",
            "#include <linux/audit.h>",
            "#include <linux/atomic.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"lib.h\"\n#include \"apparmor.h\"\n#include <linux/rcupdate.h>\n#include <linux/rbtree.h>\n#include <linux/audit.h>\n#include <linux/atomic.h>\n\nstatic inline struct aa_label *aa_get_label_rcu(struct aa_label __rcu **l)\n{\n\tstruct aa_label *c;\n\n\trcu_read_lock();\n\tdo {\n\t\tc = rcu_dereference(*l);\n\t} while (c && !kref_get_unless_zero(&c->count));\n\trcu_read_unlock();\n\n\treturn c;\n}"
        }
      },
      {
        "call_info": {
          "callee": "spin_lock_init",
          "args": [
            "&ctx->lock"
          ],
          "line": 62
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kzalloc",
          "args": [
            "sizeof(struct aa_file_ctx)",
            "gfp"
          ],
          "line": 60
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"perms.h\"\n#include \"match.h\"\n#include \"domain.h\"\n#include <linux/spinlock.h>\n\nstatic inline struct aa_file_ctx *aa_alloc_file_ctx(struct aa_label *label,\n\t\t\t\t\t\t    gfp_t gfp)\n{\n\tstruct aa_file_ctx *ctx;\n\n\tctx = kzalloc(sizeof(struct aa_file_ctx), gfp);\n\tif (ctx) {\n\t\tspin_lock_init(&ctx->lock);\n\t\trcu_assign_pointer(ctx->label, aa_get_label(label));\n\t}\n\treturn ctx;\n}"
  }
]