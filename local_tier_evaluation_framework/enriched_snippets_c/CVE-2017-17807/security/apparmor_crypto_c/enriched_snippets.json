[
  {
    "function_name": "init_profile_hash",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/crypto.c",
    "lines": "108-127",
    "snippet": "static int __init init_profile_hash(void)\n{\n\tstruct crypto_shash *tfm;\n\n\tif (!apparmor_initialized)\n\t\treturn 0;\n\n\ttfm = crypto_alloc_shash(\"sha1\", 0, CRYPTO_ALG_ASYNC);\n\tif (IS_ERR(tfm)) {\n\t\tint error = PTR_ERR(tfm);\n\t\tAA_ERROR(\"failed to setup profile sha1 hashing: %d\\n\", error);\n\t\treturn error;\n\t}\n\tapparmor_tfm = tfm;\n\tapparmor_hash_size = crypto_shash_digestsize(apparmor_tfm);\n\n\taa_info_message(\"AppArmor sha1 policy hashing enabled\");\n\n\treturn 0;\n}",
    "includes": [
      "#include \"include/crypto.h\"",
      "#include \"include/apparmor.h\"",
      "#include <crypto/hash.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static unsigned int apparmor_hash_size;",
      "static struct crypto_shash *apparmor_tfm;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "aa_info_message",
          "args": [
            "\"AppArmor sha1 policy hashing enabled\""
          ],
          "line": 124
        },
        "resolved": true,
        "details": {
          "function_name": "aa_info_message",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/lib.c",
          "lines": "126-135",
          "snippet": "void aa_info_message(const char *str)\n{\n\tif (audit_enabled) {\n\t\tDEFINE_AUDIT_DATA(sa, LSM_AUDIT_DATA_NONE, NULL);\n\n\t\taad(&sa)->info = str;\n\t\taa_audit_msg(AUDIT_APPARMOR_STATUS, &sa, NULL);\n\t}\n\tprintk(KERN_INFO \"AppArmor: %s\\n\", str);\n}",
          "includes": [
            "#include \"include/policy.h\"",
            "#include \"include/perms.h\"",
            "#include \"include/lib.h\"",
            "#include \"include/apparmor.h\"",
            "#include \"include/audit.h\"",
            "#include <linux/vmalloc.h>",
            "#include <linux/string.h>",
            "#include <linux/slab.h>",
            "#include <linux/mm.h>",
            "#include <linux/ctype.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"include/policy.h\"\n#include \"include/perms.h\"\n#include \"include/lib.h\"\n#include \"include/apparmor.h\"\n#include \"include/audit.h\"\n#include <linux/vmalloc.h>\n#include <linux/string.h>\n#include <linux/slab.h>\n#include <linux/mm.h>\n#include <linux/ctype.h>\n\nvoid aa_info_message(const char *str)\n{\n\tif (audit_enabled) {\n\t\tDEFINE_AUDIT_DATA(sa, LSM_AUDIT_DATA_NONE, NULL);\n\n\t\taad(&sa)->info = str;\n\t\taa_audit_msg(AUDIT_APPARMOR_STATUS, &sa, NULL);\n\t}\n\tprintk(KERN_INFO \"AppArmor: %s\\n\", str);\n}"
        }
      },
      {
        "call_info": {
          "callee": "crypto_shash_digestsize",
          "args": [
            "apparmor_tfm"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "AA_ERROR",
          "args": [
            "\"failed to setup profile sha1 hashing: %d\\n\"",
            "error"
          ],
          "line": 118
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "PTR_ERR",
          "args": [
            "tfm"
          ],
          "line": 117
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "IS_ERR",
          "args": [
            "tfm"
          ],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "crypto_alloc_shash",
          "args": [
            "\"sha1\"",
            "0",
            "CRYPTO_ALG_ASYNC"
          ],
          "line": 115
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"include/crypto.h\"\n#include \"include/apparmor.h\"\n#include <crypto/hash.h>\n\nstatic unsigned int apparmor_hash_size;\nstatic struct crypto_shash *apparmor_tfm;\n\nstatic int __init init_profile_hash(void)\n{\n\tstruct crypto_shash *tfm;\n\n\tif (!apparmor_initialized)\n\t\treturn 0;\n\n\ttfm = crypto_alloc_shash(\"sha1\", 0, CRYPTO_ALG_ASYNC);\n\tif (IS_ERR(tfm)) {\n\t\tint error = PTR_ERR(tfm);\n\t\tAA_ERROR(\"failed to setup profile sha1 hashing: %d\\n\", error);\n\t\treturn error;\n\t}\n\tapparmor_tfm = tfm;\n\tapparmor_hash_size = crypto_shash_digestsize(apparmor_tfm);\n\n\taa_info_message(\"AppArmor sha1 policy hashing enabled\");\n\n\treturn 0;\n}"
  },
  {
    "function_name": "aa_calc_profile_hash",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/crypto.c",
    "lines": "66-106",
    "snippet": "int aa_calc_profile_hash(struct aa_profile *profile, u32 version, void *start,\n\t\t\t size_t len)\n{\n\tSHASH_DESC_ON_STACK(desc, apparmor_tfm);\n\tint error = -ENOMEM;\n\t__le32 le32_version = cpu_to_le32(version);\n\n\tif (!aa_g_hash_policy)\n\t\treturn 0;\n\n\tif (!apparmor_tfm)\n\t\treturn 0;\n\n\tprofile->hash = kzalloc(apparmor_hash_size, GFP_KERNEL);\n\tif (!profile->hash)\n\t\tgoto fail;\n\n\tdesc->tfm = apparmor_tfm;\n\tdesc->flags = 0;\n\n\terror = crypto_shash_init(desc);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_update(desc, (u8 *) &le32_version, 4);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_update(desc, (u8 *) start, len);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_final(desc, profile->hash);\n\tif (error)\n\t\tgoto fail;\n\n\treturn 0;\n\nfail:\n\tkfree(profile->hash);\n\tprofile->hash = NULL;\n\n\treturn error;\n}",
    "includes": [
      "#include \"include/crypto.h\"",
      "#include \"include/apparmor.h\"",
      "#include <crypto/hash.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static unsigned int apparmor_hash_size;",
      "static struct crypto_shash *apparmor_tfm;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "kfree",
          "args": [
            "profile->hash"
          ],
          "line": 102
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "crypto_shash_final",
          "args": [
            "desc",
            "profile->hash"
          ],
          "line": 95
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "crypto_shash_update",
          "args": [
            "desc",
            "(u8 *) start",
            "len"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "crypto_shash_update",
          "args": [
            "desc",
            "(u8 *) &le32_version",
            "4"
          ],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "crypto_shash_init",
          "args": [
            "desc"
          ],
          "line": 86
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kzalloc",
          "args": [
            "apparmor_hash_size",
            "GFP_KERNEL"
          ],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "cpu_to_le32",
          "args": [
            "version"
          ],
          "line": 71
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "SHASH_DESC_ON_STACK",
          "args": [
            "desc",
            "apparmor_tfm"
          ],
          "line": 69
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"include/crypto.h\"\n#include \"include/apparmor.h\"\n#include <crypto/hash.h>\n\nstatic unsigned int apparmor_hash_size;\nstatic struct crypto_shash *apparmor_tfm;\n\nint aa_calc_profile_hash(struct aa_profile *profile, u32 version, void *start,\n\t\t\t size_t len)\n{\n\tSHASH_DESC_ON_STACK(desc, apparmor_tfm);\n\tint error = -ENOMEM;\n\t__le32 le32_version = cpu_to_le32(version);\n\n\tif (!aa_g_hash_policy)\n\t\treturn 0;\n\n\tif (!apparmor_tfm)\n\t\treturn 0;\n\n\tprofile->hash = kzalloc(apparmor_hash_size, GFP_KERNEL);\n\tif (!profile->hash)\n\t\tgoto fail;\n\n\tdesc->tfm = apparmor_tfm;\n\tdesc->flags = 0;\n\n\terror = crypto_shash_init(desc);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_update(desc, (u8 *) &le32_version, 4);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_update(desc, (u8 *) start, len);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_final(desc, profile->hash);\n\tif (error)\n\t\tgoto fail;\n\n\treturn 0;\n\nfail:\n\tkfree(profile->hash);\n\tprofile->hash = NULL;\n\n\treturn error;\n}"
  },
  {
    "function_name": "aa_calc_hash",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/crypto.c",
    "lines": "32-64",
    "snippet": "char *aa_calc_hash(void *data, size_t len)\n{\n\tSHASH_DESC_ON_STACK(desc, apparmor_tfm);\n\tchar *hash = NULL;\n\tint error = -ENOMEM;\n\n\tif (!apparmor_tfm)\n\t\treturn NULL;\n\n\thash = kzalloc(apparmor_hash_size, GFP_KERNEL);\n\tif (!hash)\n\t\tgoto fail;\n\n\tdesc->tfm = apparmor_tfm;\n\tdesc->flags = 0;\n\n\terror = crypto_shash_init(desc);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_update(desc, (u8 *) data, len);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_final(desc, hash);\n\tif (error)\n\t\tgoto fail;\n\n\treturn hash;\n\nfail:\n\tkfree(hash);\n\n\treturn ERR_PTR(error);\n}",
    "includes": [
      "#include \"include/crypto.h\"",
      "#include \"include/apparmor.h\"",
      "#include <crypto/hash.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static unsigned int apparmor_hash_size;",
      "static struct crypto_shash *apparmor_tfm;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "ERR_PTR",
          "args": [
            "error"
          ],
          "line": 63
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kfree",
          "args": [
            "hash"
          ],
          "line": 61
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "crypto_shash_final",
          "args": [
            "desc",
            "hash"
          ],
          "line": 54
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "crypto_shash_update",
          "args": [
            "desc",
            "(u8 *) data",
            "len"
          ],
          "line": 51
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "crypto_shash_init",
          "args": [
            "desc"
          ],
          "line": 48
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kzalloc",
          "args": [
            "apparmor_hash_size",
            "GFP_KERNEL"
          ],
          "line": 41
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "SHASH_DESC_ON_STACK",
          "args": [
            "desc",
            "apparmor_tfm"
          ],
          "line": 34
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"include/crypto.h\"\n#include \"include/apparmor.h\"\n#include <crypto/hash.h>\n\nstatic unsigned int apparmor_hash_size;\nstatic struct crypto_shash *apparmor_tfm;\n\nchar *aa_calc_hash(void *data, size_t len)\n{\n\tSHASH_DESC_ON_STACK(desc, apparmor_tfm);\n\tchar *hash = NULL;\n\tint error = -ENOMEM;\n\n\tif (!apparmor_tfm)\n\t\treturn NULL;\n\n\thash = kzalloc(apparmor_hash_size, GFP_KERNEL);\n\tif (!hash)\n\t\tgoto fail;\n\n\tdesc->tfm = apparmor_tfm;\n\tdesc->flags = 0;\n\n\terror = crypto_shash_init(desc);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_update(desc, (u8 *) data, len);\n\tif (error)\n\t\tgoto fail;\n\terror = crypto_shash_final(desc, hash);\n\tif (error)\n\t\tgoto fail;\n\n\treturn hash;\n\nfail:\n\tkfree(hash);\n\n\treturn ERR_PTR(error);\n}"
  },
  {
    "function_name": "aa_hash_size",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/apparmor/crypto.c",
    "lines": "27-30",
    "snippet": "unsigned int aa_hash_size(void)\n{\n\treturn apparmor_hash_size;\n}",
    "includes": [
      "#include \"include/crypto.h\"",
      "#include \"include/apparmor.h\"",
      "#include <crypto/hash.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static unsigned int apparmor_hash_size;"
    ],
    "called_functions": [],
    "contextual_snippet": "#include \"include/crypto.h\"\n#include \"include/apparmor.h\"\n#include <crypto/hash.h>\n\nstatic unsigned int apparmor_hash_size;\n\nunsigned int aa_hash_size(void)\n{\n\treturn apparmor_hash_size;\n}"
  }
]