[
  {
    "function_name": "ima_mok_init",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/integrity/ima/ima_mok.c",
    "lines": "29-54",
    "snippet": "__init int ima_mok_init(void)\n{\n\tstruct key_restriction *restriction;\n\n\tpr_notice(\"Allocating IMA blacklist keyring.\\n\");\n\n\trestriction = kzalloc(sizeof(struct key_restriction), GFP_KERNEL);\n\tif (!restriction)\n\t\tpanic(\"Can't allocate IMA blacklist restriction.\");\n\n\trestriction->check = restrict_link_by_builtin_trusted;\n\n\tima_blacklist_keyring = keyring_alloc(\".ima_blacklist\",\n\t\t\t\tKUIDT_INIT(0), KGIDT_INIT(0), current_cred(),\n\t\t\t\t(KEY_POS_ALL & ~KEY_POS_SETATTR) |\n\t\t\t\tKEY_USR_VIEW | KEY_USR_READ |\n\t\t\t\tKEY_USR_WRITE | KEY_USR_SEARCH,\n\t\t\t\tKEY_ALLOC_NOT_IN_QUOTA,\n\t\t\t\trestriction, NULL);\n\n\tif (IS_ERR(ima_blacklist_keyring))\n\t\tpanic(\"Can't allocate IMA blacklist keyring.\");\n\n\tset_bit(KEY_FLAG_KEEP, &ima_blacklist_keyring->flags);\n\treturn 0;\n}",
    "includes": [
      "#include <keys/system_keyring.h>",
      "#include <linux/slab.h>",
      "#include <linux/init.h>",
      "#include <linux/err.h>",
      "#include <linux/cred.h>",
      "#include <linux/sched.h>",
      "#include <linux/kernel.h>",
      "#include <linux/export.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "struct key *ima_blacklist_keyring;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "set_bit",
          "args": [
            "KEY_FLAG_KEEP",
            "&ima_blacklist_keyring->flags"
          ],
          "line": 52
        },
        "resolved": true,
        "details": {
          "function_name": "ebitmap_node_set_bit",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/selinux/ss/ebitmap.h",
          "lines": "100-108",
          "snippet": "static inline void ebitmap_node_set_bit(struct ebitmap_node *n,\n\t\t\t\t\tunsigned int bit)\n{\n\tunsigned int index = EBITMAP_NODE_INDEX(n, bit);\n\tunsigned int ofs = EBITMAP_NODE_OFFSET(n, bit);\n\n\tBUG_ON(index >= EBITMAP_UNIT_NUMS);\n\tn->maps[index] |= (EBITMAP_BIT << ofs);\n}",
          "includes": [
            "#include <net/netlabel.h>"
          ],
          "macros_used": [
            "#define EBITMAP_BIT\t\t1ULL",
            "#define EBITMAP_UNIT_NUMS\t((EBITMAP_NODE_SIZE-sizeof(void *)-sizeof(u32))\\\n\t\t\t\t\t/ sizeof(unsigned long))"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <net/netlabel.h>\n\n#define EBITMAP_BIT\t\t1ULL\n#define EBITMAP_UNIT_NUMS\t((EBITMAP_NODE_SIZE-sizeof(void *)-sizeof(u32))\\\n\t\t\t\t\t/ sizeof(unsigned long))\n\nstatic inline void ebitmap_node_set_bit(struct ebitmap_node *n,\n\t\t\t\t\tunsigned int bit)\n{\n\tunsigned int index = EBITMAP_NODE_INDEX(n, bit);\n\tunsigned int ofs = EBITMAP_NODE_OFFSET(n, bit);\n\n\tBUG_ON(index >= EBITMAP_UNIT_NUMS);\n\tn->maps[index] |= (EBITMAP_BIT << ofs);\n}"
        }
      },
      {
        "call_info": {
          "callee": "panic",
          "args": [
            "\"Can't allocate IMA blacklist keyring.\""
          ],
          "line": 50
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "IS_ERR",
          "args": [
            "ima_blacklist_keyring"
          ],
          "line": 49
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "keyring_alloc",
          "args": [
            "\".ima_blacklist\"",
            "KUIDT_INIT(0)",
            "KGIDT_INIT(0)",
            "current_cred()",
            "(KEY_POS_ALL & ~KEY_POS_SETATTR) |\n\t\t\t\tKEY_USR_VIEW | KEY_USR_READ |\n\t\t\t\tKEY_USR_WRITE | KEY_USR_SEARCH",
            "KEY_ALLOC_NOT_IN_QUOTA",
            "restriction",
            "NULL"
          ],
          "line": 41
        },
        "resolved": true,
        "details": {
          "function_name": "keyring_alloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-17807/repo/security/keys/keyring.c",
          "lines": "494-514",
          "snippet": "struct key *keyring_alloc(const char *description, kuid_t uid, kgid_t gid,\n\t\t\t  const struct cred *cred, key_perm_t perm,\n\t\t\t  unsigned long flags,\n\t\t\t  struct key_restriction *restrict_link,\n\t\t\t  struct key *dest)\n{\n\tstruct key *keyring;\n\tint ret;\n\n\tkeyring = key_alloc(&key_type_keyring, description,\n\t\t\t    uid, gid, cred, perm, flags, restrict_link);\n\tif (!IS_ERR(keyring)) {\n\t\tret = key_instantiate_and_link(keyring, NULL, 0, dest, NULL);\n\t\tif (ret < 0) {\n\t\t\tkey_put(keyring);\n\t\t\tkeyring = ERR_PTR(ret);\n\t\t}\n\t}\n\n\treturn keyring;\n}",
          "includes": [
            "#include \"internal.h\"",
            "#include <linux/uaccess.h>",
            "#include <linux/assoc_array_priv.h>",
            "#include <keys/user-type.h>",
            "#include <keys/keyring-type.h>",
            "#include <linux/err.h>",
            "#include <linux/seq_file.h>",
            "#include <linux/security.h>",
            "#include <linux/slab.h>",
            "#include <linux/sched.h>",
            "#include <linux/init.h>",
            "#include <linux/module.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void keyring_revoke(struct key *keyring);",
            "static void keyring_destroy(struct key *keyring);",
            "struct key_type key_type_keyring = {\n\t.name\t\t= \"keyring\",\n\t.def_datalen\t= 0,\n\t.preparse\t= keyring_preparse,\n\t.free_preparse\t= keyring_free_preparse,\n\t.instantiate\t= keyring_instantiate,\n\t.revoke\t\t= keyring_revoke,\n\t.destroy\t= keyring_destroy,\n\t.describe\t= keyring_describe,\n\t.read\t\t= keyring_read,\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"internal.h\"\n#include <linux/uaccess.h>\n#include <linux/assoc_array_priv.h>\n#include <keys/user-type.h>\n#include <keys/keyring-type.h>\n#include <linux/err.h>\n#include <linux/seq_file.h>\n#include <linux/security.h>\n#include <linux/slab.h>\n#include <linux/sched.h>\n#include <linux/init.h>\n#include <linux/module.h>\n\nstatic void keyring_revoke(struct key *keyring);\nstatic void keyring_destroy(struct key *keyring);\nstruct key_type key_type_keyring = {\n\t.name\t\t= \"keyring\",\n\t.def_datalen\t= 0,\n\t.preparse\t= keyring_preparse,\n\t.free_preparse\t= keyring_free_preparse,\n\t.instantiate\t= keyring_instantiate,\n\t.revoke\t\t= keyring_revoke,\n\t.destroy\t= keyring_destroy,\n\t.describe\t= keyring_describe,\n\t.read\t\t= keyring_read,\n};\n\nstruct key *keyring_alloc(const char *description, kuid_t uid, kgid_t gid,\n\t\t\t  const struct cred *cred, key_perm_t perm,\n\t\t\t  unsigned long flags,\n\t\t\t  struct key_restriction *restrict_link,\n\t\t\t  struct key *dest)\n{\n\tstruct key *keyring;\n\tint ret;\n\n\tkeyring = key_alloc(&key_type_keyring, description,\n\t\t\t    uid, gid, cred, perm, flags, restrict_link);\n\tif (!IS_ERR(keyring)) {\n\t\tret = key_instantiate_and_link(keyring, NULL, 0, dest, NULL);\n\t\tif (ret < 0) {\n\t\t\tkey_put(keyring);\n\t\t\tkeyring = ERR_PTR(ret);\n\t\t}\n\t}\n\n\treturn keyring;\n}"
        }
      },
      {
        "call_info": {
          "callee": "current_cred",
          "args": [],
          "line": 42
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KGIDT_INIT",
          "args": [
            "0"
          ],
          "line": 42
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "KUIDT_INIT",
          "args": [
            "0"
          ],
          "line": 42
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "panic",
          "args": [
            "\"Can't allocate IMA blacklist restriction.\""
          ],
          "line": 37
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "kzalloc",
          "args": [
            "sizeof(struct key_restriction)",
            "GFP_KERNEL"
          ],
          "line": 35
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pr_notice",
          "args": [
            "\"Allocating IMA blacklist keyring.\\n\""
          ],
          "line": 33
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <keys/system_keyring.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/err.h>\n#include <linux/cred.h>\n#include <linux/sched.h>\n#include <linux/kernel.h>\n#include <linux/export.h>\n\nstruct key *ima_blacklist_keyring;\n\n__init int ima_mok_init(void)\n{\n\tstruct key_restriction *restriction;\n\n\tpr_notice(\"Allocating IMA blacklist keyring.\\n\");\n\n\trestriction = kzalloc(sizeof(struct key_restriction), GFP_KERNEL);\n\tif (!restriction)\n\t\tpanic(\"Can't allocate IMA blacklist restriction.\");\n\n\trestriction->check = restrict_link_by_builtin_trusted;\n\n\tima_blacklist_keyring = keyring_alloc(\".ima_blacklist\",\n\t\t\t\tKUIDT_INIT(0), KGIDT_INIT(0), current_cred(),\n\t\t\t\t(KEY_POS_ALL & ~KEY_POS_SETATTR) |\n\t\t\t\tKEY_USR_VIEW | KEY_USR_READ |\n\t\t\t\tKEY_USR_WRITE | KEY_USR_SEARCH,\n\t\t\t\tKEY_ALLOC_NOT_IN_QUOTA,\n\t\t\t\trestriction, NULL);\n\n\tif (IS_ERR(ima_blacklist_keyring))\n\t\tpanic(\"Can't allocate IMA blacklist keyring.\");\n\n\tset_bit(KEY_FLAG_KEEP, &ima_blacklist_keyring->flags);\n\treturn 0;\n}"
  }
]