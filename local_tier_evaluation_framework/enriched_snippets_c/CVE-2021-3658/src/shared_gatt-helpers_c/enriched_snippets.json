[
  {
    "function_name": "bt_gatt_discover_descriptors",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "1481-1514",
    "snippet": "struct bt_gatt_request *bt_gatt_discover_descriptors(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[4];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\n\top->id = bt_att_send(att, BT_ATT_OP_FIND_INFO_REQ, pdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 1513
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 1509
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "att",
            "BT_ATT_OP_FIND_INFO_REQ",
            "pdu",
            "sizeof(pdu)",
            "discover_descs_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 1504
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "end",
            "pdu + 2"
          ],
          "line": 1502
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_gatt_request",
            "1"
          ],
          "line": 1493
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_descriptors(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[4];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\n\top->id = bt_att_send(att, BT_ATT_OP_FIND_INFO_REQ, pdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}"
  },
  {
    "function_name": "discover_descs_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "1396-1479",
    "snippet": "static void discover_descs_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tuint8_t format;\n\tuint16_t last_handle;\n\tsize_t data_length;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\t/* The PDU should contain the following data (sans opcode):\n\t * - Format (1 octet)\n\t * - Attr Data List (at least 4 octets):\n\t *   -- 2 octets: Attribute handle\n\t *   -- 2 or 16 octets: UUID.\n\t */\n\tif (opcode != BT_ATT_OP_FIND_INFO_RSP || !pdu || length < 5) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tformat = ((uint8_t *) pdu)[0];\n\n\tif (format == 0x01)\n\t\tdata_length = 4;\n\telse if (format == 0x02)\n\t\tdata_length = 18;\n\telse {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif ((length - 1) % data_length) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (!result_append(opcode, pdu + 1, length - 1, data_length, op)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tlast_handle = get_le16(pdu + length - data_length);\n\n\t/*\n\t * If last handle is lower from previous start handle then it is smth\n\t * wrong. Let's stop search, otherwise we might enter infinite loop.\n\t */\n\tif (last_handle < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\top->start_handle = last_handle + 1;\n\n\tif (last_handle != op->end_handle) {\n\t\tuint8_t pdu[4];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_FIND_INFO_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 1478
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "620-636",
          "snippet": "static void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->att",
            "BT_ATT_OP_FIND_INFO_REQ",
            "pdu",
            "sizeof(pdu)",
            "discover_descs_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 1463
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 1466
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "op->end_handle",
            "pdu + 2"
          ],
          "line": 1461
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + length - data_length"
          ],
          "line": 1444
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "result_append",
          "args": [
            "opcode",
            "pdu + 1",
            "length - 1",
            "data_length",
            "op"
          ],
          "line": 1439
        },
        "resolved": true,
        "details": {
          "function_name": "result_append",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "224-243",
          "snippet": "static struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 1408
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "497-507",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discover_descs_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tuint8_t format;\n\tuint16_t last_handle;\n\tsize_t data_length;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\t/* The PDU should contain the following data (sans opcode):\n\t * - Format (1 octet)\n\t * - Attr Data List (at least 4 octets):\n\t *   -- 2 octets: Attribute handle\n\t *   -- 2 or 16 octets: UUID.\n\t */\n\tif (opcode != BT_ATT_OP_FIND_INFO_RSP || !pdu || length < 5) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tformat = ((uint8_t *) pdu)[0];\n\n\tif (format == 0x01)\n\t\tdata_length = 4;\n\telse if (format == 0x02)\n\t\tdata_length = 18;\n\telse {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif ((length - 1) % data_length) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (!result_append(opcode, pdu + 1, length - 1, data_length, op)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tlast_handle = get_le16(pdu + length - data_length);\n\n\t/*\n\t * If last handle is lower from previous start handle then it is smth\n\t * wrong. Let's stop search, otherwise we might enter infinite loop.\n\t */\n\tif (last_handle < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\top->start_handle = last_handle + 1;\n\n\tif (last_handle != op->end_handle) {\n\t\tuint8_t pdu[4];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_FIND_INFO_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "bt_gatt_read_by_type",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "1360-1394",
    "snippet": "bool bt_gatt_read_by_type(struct bt_att *att, uint16_t start, uint16_t end,\n\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[4 + get_uuid_len(uuid)];\n\n\tif (!att || !uuid || uuid->type == BT_UUID_UNSPEC)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\top->uuid = *uuid;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tbt_uuid_to_le(uuid, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\tif (op->id)\n\t\treturn true;\n\n\tfree(op);\n\treturn false;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 1392
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "att",
            "BT_ATT_OP_READ_BY_TYPE_REQ",
            "pdu",
            "sizeof(pdu)",
            "read_by_type_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 1385
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 1387
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_to_le",
          "args": [
            "uuid",
            "pdu + 4"
          ],
          "line": 1383
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "end",
            "pdu + 2"
          ],
          "line": 1382
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_gatt_request",
            "1"
          ],
          "line": 1372
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_uuid_len",
          "args": [
            "uuid"
          ],
          "line": 1367
        },
        "resolved": true,
        "details": {
          "function_name": "get_uuid_len",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "565-571",
          "snippet": "static inline int get_uuid_len(const bt_uuid_t *uuid)\n{\n\tif (!uuid)\n\t\treturn 0;\n\n\treturn (uuid->type == BT_UUID16) ? 2 : 16;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic inline int get_uuid_len(const bt_uuid_t *uuid)\n{\n\tif (!uuid)\n\t\treturn 0;\n\n\treturn (uuid->type == BT_UUID16) ? 2 : 16;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nbool bt_gatt_read_by_type(struct bt_att *att, uint16_t start, uint16_t end,\n\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[4 + get_uuid_len(uuid)];\n\n\tif (!att || !uuid || uuid->type == BT_UUID_UNSPEC)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\top->uuid = *uuid;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tbt_uuid_to_le(uuid, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\tif (op->id)\n\t\treturn true;\n\n\tfree(op);\n\treturn false;\n}"
  },
  {
    "function_name": "read_by_type_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "1288-1358",
    "snippet": "static void read_by_type_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tsize_t data_length;\n\tuint16_t last_handle;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tatt_ecode = process_error(pdu, length);\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_READ_BY_TYPE_RSP || !pdu) {\n\t\tsuccess = false;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tdata_length = ((uint8_t *) pdu)[0];\n\tif (((length - 1) % data_length)) {\n\t\tsuccess = false;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tif (!result_append(opcode, pdu + 1, length - 1, data_length, op)) {\n\t\tsuccess = false;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tlast_handle = get_le16(pdu + length - data_length);\n\n\t/*\n\t * If last handle is lower from previous start handle then it is smth\n\t * wrong. Let's stop search, otherwise we might enter infinite loop.\n\t */\n\tif (last_handle < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\top->start_handle = last_handle + 1;\n\n\tif (last_handle != op->end_handle) {\n\t\tuint8_t pdu[4 + get_uuid_len(&op->uuid)];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tbt_uuid_to_le(&op->uuid, pdu + 4);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 1357
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "620-636",
          "snippet": "static void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->att",
            "BT_ATT_OP_READ_BY_TYPE_REQ",
            "pdu",
            "sizeof(pdu)",
            "read_by_type_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 1342
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 1345
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_to_le",
          "args": [
            "&op->uuid",
            "pdu + 4"
          ],
          "line": 1340
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "op->end_handle",
            "pdu + 2"
          ],
          "line": 1339
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_uuid_len",
          "args": [
            "&op->uuid"
          ],
          "line": 1336
        },
        "resolved": true,
        "details": {
          "function_name": "get_uuid_len",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "565-571",
          "snippet": "static inline int get_uuid_len(const bt_uuid_t *uuid)\n{\n\tif (!uuid)\n\t\treturn 0;\n\n\treturn (uuid->type == BT_UUID16) ? 2 : 16;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic inline int get_uuid_len(const bt_uuid_t *uuid)\n{\n\tif (!uuid)\n\t\treturn 0;\n\n\treturn (uuid->type == BT_UUID16) ? 2 : 16;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + length - data_length"
          ],
          "line": 1322
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "result_append",
          "args": [
            "opcode",
            "pdu + 1",
            "length - 1",
            "data_length",
            "op"
          ],
          "line": 1316
        },
        "resolved": true,
        "details": {
          "function_name": "result_append",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "224-243",
          "snippet": "static struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 1298
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "497-507",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void read_by_type_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tsize_t data_length;\n\tuint16_t last_handle;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tatt_ecode = process_error(pdu, length);\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_READ_BY_TYPE_RSP || !pdu) {\n\t\tsuccess = false;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tdata_length = ((uint8_t *) pdu)[0];\n\tif (((length - 1) % data_length)) {\n\t\tsuccess = false;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tif (!result_append(opcode, pdu + 1, length - 1, data_length, op)) {\n\t\tsuccess = false;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tlast_handle = get_le16(pdu + length - data_length);\n\n\t/*\n\t * If last handle is lower from previous start handle then it is smth\n\t * wrong. Let's stop search, otherwise we might enter infinite loop.\n\t */\n\tif (last_handle < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\top->start_handle = last_handle + 1;\n\n\tif (last_handle != op->end_handle) {\n\t\tuint8_t pdu[4 + get_uuid_len(&op->uuid)];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tbt_uuid_to_le(&op->uuid, pdu + 4);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "bt_gatt_discover_characteristics",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "1253-1286",
    "snippet": "struct bt_gatt_request *bt_gatt_discover_characteristics(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[6];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tput_le16(GATT_CHARAC_UUID, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\tdiscover_chrcs_cb, bt_gatt_request_ref(op),\n\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 1285
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 1281
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "att",
            "BT_ATT_OP_READ_BY_TYPE_REQ",
            "pdu",
            "sizeof(pdu)",
            "discover_chrcs_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 1277
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "GATT_CHARAC_UUID",
            "pdu + 4"
          ],
          "line": 1275
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_gatt_request",
            "1"
          ],
          "line": 1265
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_characteristics(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[6];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tput_le16(GATT_CHARAC_UUID, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\tdiscover_chrcs_cb, bt_gatt_request_ref(op),\n\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}"
  },
  {
    "function_name": "discover_chrcs_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "1174-1251",
    "snippet": "static void discover_chrcs_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tsize_t data_length;\n\tuint16_t last_handle;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\t/* PDU must contain at least the following (sans opcode):\n\t * - Attr Data Length (1 octet)\n\t * - Attr Data List (at least 7 octets):\n\t *   -- 2 octets: Attribute handle\n\t *   -- 1 octet: Characteristic properties\n\t *   -- 2 octets: Characteristic value handle\n\t *   -- 2 or 16 octets: characteristic UUID\n\t */\n\tif (opcode != BT_ATT_OP_READ_BY_TYPE_RSP || !pdu || length < 8) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tdata_length = ((uint8_t *) pdu)[0];\n\n\tif ((data_length != 7 && data_length != 21) ||\n\t\t\t\t\t((length - 1) % data_length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (!result_append(opcode, pdu + 1, length - 1,\n\t\t\t\t\t\t\tdata_length, op)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\tlast_handle = get_le16(pdu + length - data_length);\n\n\t/*\n\t * If last handle is lower from previous start handle then it is smth\n\t * wrong. Let's stop search, otherwise we might enter infinite loop.\n\t */\n\tif (last_handle < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\top->start_handle = last_handle + 1;\n\n\tif (last_handle != op->end_handle) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tput_le16(GATT_CHARAC_UUID, pdu + 4);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_chrcs_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 1250
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "620-636",
          "snippet": "static void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->att",
            "BT_ATT_OP_READ_BY_TYPE_REQ",
            "pdu",
            "sizeof(pdu)",
            "discover_chrcs_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 1235
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 1238
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "GATT_CHARAC_UUID",
            "pdu + 4"
          ],
          "line": 1233
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + length - data_length"
          ],
          "line": 1215
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "result_append",
          "args": [
            "opcode",
            "pdu + 1",
            "length - 1",
            "data_length",
            "op"
          ],
          "line": 1210
        },
        "resolved": true,
        "details": {
          "function_name": "result_append",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "224-243",
          "snippet": "static struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 1185
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "497-507",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discover_chrcs_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tsize_t data_length;\n\tuint16_t last_handle;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\t/* PDU must contain at least the following (sans opcode):\n\t * - Attr Data Length (1 octet)\n\t * - Attr Data List (at least 7 octets):\n\t *   -- 2 octets: Attribute handle\n\t *   -- 1 octet: Characteristic properties\n\t *   -- 2 octets: Characteristic value handle\n\t *   -- 2 or 16 octets: characteristic UUID\n\t */\n\tif (opcode != BT_ATT_OP_READ_BY_TYPE_RSP || !pdu || length < 8) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tdata_length = ((uint8_t *) pdu)[0];\n\n\tif ((data_length != 7 && data_length != 21) ||\n\t\t\t\t\t((length - 1) % data_length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (!result_append(opcode, pdu + 1, length - 1,\n\t\t\t\t\t\t\tdata_length, op)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\tlast_handle = get_le16(pdu + length - data_length);\n\n\t/*\n\t * If last handle is lower from previous start handle then it is smth\n\t * wrong. Let's stop search, otherwise we might enter infinite loop.\n\t */\n\tif (last_handle < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\top->start_handle = last_handle + 1;\n\n\tif (last_handle != op->end_handle) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tput_le16(GATT_CHARAC_UUID, pdu + 4);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_chrcs_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "bt_gatt_discover_included_services",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "1139-1172",
    "snippet": "struct bt_gatt_request *bt_gatt_discover_included_services(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[6];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tput_le16(GATT_INCLUDE_UUID, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\tdiscover_included_cb, bt_gatt_request_ref(op),\n\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 1171
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 1167
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "att",
            "BT_ATT_OP_READ_BY_TYPE_REQ",
            "pdu",
            "sizeof(pdu)",
            "discover_included_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 1163
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "GATT_INCLUDE_UUID",
            "pdu + 4"
          ],
          "line": 1161
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_gatt_request",
            "1"
          ],
          "line": 1151
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_included_services(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[6];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tput_le16(GATT_INCLUDE_UUID, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\tdiscover_included_cb, bt_gatt_request_ref(op),\n\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}"
  },
  {
    "function_name": "discover_included_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "1044-1137",
    "snippet": "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tstruct bt_gatt_result *cur_result;\n\tuint8_t att_ecode = 0;\n\tuint16_t last_handle;\n\tsize_t data_length;\n\tbool success;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tatt_ecode = process_error(pdu, length);\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\tif (opcode != BT_ATT_OP_READ_BY_TYPE_RSP || !pdu || length < 6) {\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\tdata_length = ((const uint8_t *) pdu)[0];\n\n\t/*\n\t * Check if PDU contains data sets with length declared in the beginning\n\t * of frame and if this length is correct.\n\t * Data set length may be 6 or 8 octets:\n\t * 2 octets - include service handle\n\t * 2 octets - start handle of included service\n\t * 2 octets - end handle of included service\n\t * optional 2 octets - Bluetooth UUID of included service\n\t */\n\tif ((data_length != 8 && data_length != 6) ||\n\t\t\t\t\t\t(length - 1) % data_length) {\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\tcur_result = result_append(opcode, pdu + 1, length - 1, data_length,\n\t\t\t\t\t\t\t\t\top);\n\tif (!cur_result) {\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\tif (data_length == 6) {\n\t\tstruct read_incl_data *data;\n\n\t\tdata = new_read_included(cur_result);\n\t\tif (!data) {\n\t\t\tsuccess = false;\n\t\t\tgoto failed;\n\t\t}\n\n\t\tread_included(data);\n\t\treturn;\n\t}\n\n\tlast_handle = get_le16(pdu + length - data_length);\n\n\t/*\n\t * If last handle is lower from previous start handle then it is smth\n\t * wrong. Let's stop search, otherwise we might enter infinite loop.\n\t */\n\tif (last_handle < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\top->start_handle = last_handle + 1;\n\tif (last_handle != op->end_handle) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tput_le16(GATT_INCLUDE_UUID, pdu + 4);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_included_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\tsuccess = true;\n\nfailed:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 1136
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "620-636",
          "snippet": "static void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->att",
            "BT_ATT_OP_READ_BY_TYPE_REQ",
            "pdu",
            "sizeof(pdu)",
            "discover_included_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 1121
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 1124
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "GATT_INCLUDE_UUID",
            "pdu + 4"
          ],
          "line": 1119
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + length - data_length"
          ],
          "line": 1102
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "read_included",
          "args": [
            "data"
          ],
          "line": 1098
        },
        "resolved": true,
        "details": {
          "function_name": "read_included",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "1023-1042",
          "snippet": "static void read_included(struct read_incl_data *data)\n{\n\tstruct bt_gatt_request *op = data->op;\n\tuint8_t pdu[2];\n\n\tmemcpy(pdu, data->result->pdu + 2, sizeof(uint16_t));\n\n\tdata->pos += data->result->data_len;\n\n\tif (bt_att_send(op->att, BT_ATT_OP_READ_REQ, pdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_included_cb,\n\t\t\t\t\t\t\tread_included_ref(data),\n\t\t\t\t\t\t\tread_included_unref))\n\t\treturn;\n\n\tif (op->callback)\n\t\top->callback(false, 0, NULL, data->op->user_data);\n\n\tread_included_unref(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void read_included(struct read_incl_data *data)\n{\n\tstruct bt_gatt_request *op = data->op;\n\tuint8_t pdu[2];\n\n\tmemcpy(pdu, data->result->pdu + 2, sizeof(uint16_t));\n\n\tdata->pos += data->result->data_len;\n\n\tif (bt_att_send(op->att, BT_ATT_OP_READ_REQ, pdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_included_cb,\n\t\t\t\t\t\t\tread_included_ref(data),\n\t\t\t\t\t\t\tread_included_unref))\n\t\treturn;\n\n\tif (op->callback)\n\t\top->callback(false, 0, NULL, data->op->user_data);\n\n\tread_included_unref(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new_read_included",
          "args": [
            "cur_result"
          ],
          "line": 1092
        },
        "resolved": true,
        "details": {
          "function_name": "new_read_included",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "913-922",
          "snippet": "static struct read_incl_data *new_read_included(struct bt_gatt_result *res)\n{\n\tstruct read_incl_data *data;\n\n\tdata = new0(struct read_incl_data, 1);\n\tdata->op = bt_gatt_request_ref(res->op);\n\tdata->result = res;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct read_incl_data *new_read_included(struct bt_gatt_result *res)\n{\n\tstruct read_incl_data *data;\n\n\tdata = new0(struct read_incl_data, 1);\n\tdata->op = bt_gatt_request_ref(res->op);\n\tdata->result = res;\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "result_append",
          "args": [
            "opcode",
            "pdu + 1",
            "length - 1",
            "data_length",
            "op"
          ],
          "line": 1082
        },
        "resolved": true,
        "details": {
          "function_name": "result_append",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "224-243",
          "snippet": "static struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 1055
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "497-507",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tstruct bt_gatt_result *cur_result;\n\tuint8_t att_ecode = 0;\n\tuint16_t last_handle;\n\tsize_t data_length;\n\tbool success;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tatt_ecode = process_error(pdu, length);\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\tif (opcode != BT_ATT_OP_READ_BY_TYPE_RSP || !pdu || length < 6) {\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\tdata_length = ((const uint8_t *) pdu)[0];\n\n\t/*\n\t * Check if PDU contains data sets with length declared in the beginning\n\t * of frame and if this length is correct.\n\t * Data set length may be 6 or 8 octets:\n\t * 2 octets - include service handle\n\t * 2 octets - start handle of included service\n\t * 2 octets - end handle of included service\n\t * optional 2 octets - Bluetooth UUID of included service\n\t */\n\tif ((data_length != 8 && data_length != 6) ||\n\t\t\t\t\t\t(length - 1) % data_length) {\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\tcur_result = result_append(opcode, pdu + 1, length - 1, data_length,\n\t\t\t\t\t\t\t\t\top);\n\tif (!cur_result) {\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\tif (data_length == 6) {\n\t\tstruct read_incl_data *data;\n\n\t\tdata = new_read_included(cur_result);\n\t\tif (!data) {\n\t\t\tsuccess = false;\n\t\t\tgoto failed;\n\t\t}\n\n\t\tread_included(data);\n\t\treturn;\n\t}\n\n\tlast_handle = get_le16(pdu + length - data_length);\n\n\t/*\n\t * If last handle is lower from previous start handle then it is smth\n\t * wrong. Let's stop search, otherwise we might enter infinite loop.\n\t */\n\tif (last_handle < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\top->start_handle = last_handle + 1;\n\tif (last_handle != op->end_handle) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tput_le16(GATT_INCLUDE_UUID, pdu + 4);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_included_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto failed;\n\t}\n\n\tsuccess = true;\n\nfailed:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "read_included",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "1023-1042",
    "snippet": "static void read_included(struct read_incl_data *data)\n{\n\tstruct bt_gatt_request *op = data->op;\n\tuint8_t pdu[2];\n\n\tmemcpy(pdu, data->result->pdu + 2, sizeof(uint16_t));\n\n\tdata->pos += data->result->data_len;\n\n\tif (bt_att_send(op->att, BT_ATT_OP_READ_REQ, pdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_included_cb,\n\t\t\t\t\t\t\tread_included_ref(data),\n\t\t\t\t\t\t\tread_included_unref))\n\t\treturn;\n\n\tif (op->callback)\n\t\top->callback(false, 0, NULL, data->op->user_data);\n\n\tread_included_unref(data);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "read_included_unref",
          "args": [
            "data"
          ],
          "line": 1041
        },
        "resolved": true,
        "details": {
          "function_name": "read_included_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "931-941",
          "snippet": "static void read_included_unref(void *data)\n{\n\tstruct read_incl_data *read_data = data;\n\n\tif (__sync_sub_and_fetch(&read_data->ref_count, 1))\n\t\treturn;\n\n\tasync_req_unref(read_data->op);\n\n\tfree(read_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void read_included_unref(void *data)\n{\n\tstruct read_incl_data *read_data = data;\n\n\tif (__sync_sub_and_fetch(&read_data->ref_count, 1))\n\t\treturn;\n\n\tasync_req_unref(read_data->op);\n\n\tfree(read_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "false",
            "0",
            "NULL",
            "data->op->user_data"
          ],
          "line": 1039
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->att",
            "BT_ATT_OP_READ_REQ",
            "pdu",
            "sizeof(pdu)",
            "read_included_cb",
            "read_included_ref(data)",
            "read_included_unref"
          ],
          "line": 1032
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "read_included_ref",
          "args": [
            "data"
          ],
          "line": 1034
        },
        "resolved": true,
        "details": {
          "function_name": "read_included_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "924-929",
          "snippet": "static struct read_incl_data *read_included_ref(struct read_incl_data *data)\n{\n\t__sync_fetch_and_add(&data->ref_count, 1);\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct read_incl_data *read_included_ref(struct read_incl_data *data)\n{\n\t__sync_fetch_and_add(&data->ref_count, 1);\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "pdu",
            "data->result->pdu + 2",
            "sizeof(uint16_t)"
          ],
          "line": 1028
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void read_included(struct read_incl_data *data)\n{\n\tstruct bt_gatt_request *op = data->op;\n\tuint8_t pdu[2];\n\n\tmemcpy(pdu, data->result->pdu + 2, sizeof(uint16_t));\n\n\tdata->pos += data->result->data_len;\n\n\tif (bt_att_send(op->att, BT_ATT_OP_READ_REQ, pdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_included_cb,\n\t\t\t\t\t\t\tread_included_ref(data),\n\t\t\t\t\t\t\tread_included_unref))\n\t\treturn;\n\n\tif (op->callback)\n\t\top->callback(false, 0, NULL, data->op->user_data);\n\n\tread_included_unref(data);\n}"
  },
  {
    "function_name": "read_included_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "946-1021",
    "snippet": "static void read_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct read_incl_data *data = user_data;\n\tstruct bt_gatt_request *op = data->op;\n\tuint8_t att_ecode = 0;\n\tuint8_t read_pdu[2];\n\tbool success;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_READ_RSP || (!pdu && length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\t/*\n\t * UUID should be in 128 bit format, as it couldn't be read in\n\t * READ_BY_TYPE request\n\t */\n\tif (length != 16) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (!result_append(opcode, pdu, length, length, op)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (data->pos == data->result->pdu_len) {\n\t\tuint16_t last_handle;\n\t\tuint8_t pdu[6];\n\n\t\tlast_handle = get_le16(data->result->pdu + data->pos -\n\t\t\t\t\t\t\tdata->result->data_len);\n\t\tif (last_handle == op->end_handle) {\n\t\t\tsuccess = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tput_le16(last_handle + 1, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tput_le16(GATT_INCLUDE_UUID, pdu + 4);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_included_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tmemcpy(read_pdu, data->result->pdu + data->pos + 2, sizeof(uint16_t));\n\n\tdata->pos += data->result->data_len;\n\n\tif (bt_att_send(op->att, BT_ATT_OP_READ_REQ, read_pdu, sizeof(read_pdu),\n\t\t\t\tread_included_cb, read_included_ref(data),\n\t\t\t\tread_included_unref))\n\t\treturn;\n\n\tread_included_unref(data);\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 1020
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "620-636",
          "snippet": "static void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}"
        }
      },
      {
        "call_info": {
          "callee": "read_included_unref",
          "args": [
            "data"
          ],
          "line": 1016
        },
        "resolved": true,
        "details": {
          "function_name": "read_included_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "931-941",
          "snippet": "static void read_included_unref(void *data)\n{\n\tstruct read_incl_data *read_data = data;\n\n\tif (__sync_sub_and_fetch(&read_data->ref_count, 1))\n\t\treturn;\n\n\tasync_req_unref(read_data->op);\n\n\tfree(read_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void read_included_unref(void *data)\n{\n\tstruct read_incl_data *read_data = data;\n\n\tif (__sync_sub_and_fetch(&read_data->ref_count, 1))\n\t\treturn;\n\n\tasync_req_unref(read_data->op);\n\n\tfree(read_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->att",
            "BT_ATT_OP_READ_REQ",
            "read_pdu",
            "sizeof(read_pdu)",
            "read_included_cb",
            "read_included_ref(data)",
            "read_included_unref"
          ],
          "line": 1011
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "read_included_ref",
          "args": [
            "data"
          ],
          "line": 1012
        },
        "resolved": true,
        "details": {
          "function_name": "read_included_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "924-929",
          "snippet": "static struct read_incl_data *read_included_ref(struct read_incl_data *data)\n{\n\t__sync_fetch_and_add(&data->ref_count, 1);\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct read_incl_data *read_included_ref(struct read_incl_data *data)\n{\n\t__sync_fetch_and_add(&data->ref_count, 1);\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "read_pdu",
            "data->result->pdu + data->pos + 2",
            "sizeof(uint16_t)"
          ],
          "line": 1007
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 998
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "GATT_INCLUDE_UUID",
            "pdu + 4"
          ],
          "line": 993
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "data->result->pdu + data->pos -\n\t\t\t\t\t\t\tdata->result->data_len"
          ],
          "line": 984
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "result_append",
          "args": [
            "opcode",
            "pdu",
            "length",
            "length",
            "op"
          ],
          "line": 975
        },
        "resolved": true,
        "details": {
          "function_name": "result_append",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "224-243",
          "snippet": "static struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 957
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "497-507",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void read_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct read_incl_data *data = user_data;\n\tstruct bt_gatt_request *op = data->op;\n\tuint8_t att_ecode = 0;\n\tuint8_t read_pdu[2];\n\tbool success;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_READ_RSP || (!pdu && length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\t/*\n\t * UUID should be in 128 bit format, as it couldn't be read in\n\t * READ_BY_TYPE request\n\t */\n\tif (length != 16) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (!result_append(opcode, pdu, length, length, op)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (data->pos == data->result->pdu_len) {\n\t\tuint16_t last_handle;\n\t\tuint8_t pdu[6];\n\n\t\tlast_handle = get_le16(data->result->pdu + data->pos -\n\t\t\t\t\t\t\tdata->result->data_len);\n\t\tif (last_handle == op->end_handle) {\n\t\t\tsuccess = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tput_le16(last_handle + 1, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tput_le16(GATT_INCLUDE_UUID, pdu + 4);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_included_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tmemcpy(read_pdu, data->result->pdu + data->pos + 2, sizeof(uint16_t));\n\n\tdata->pos += data->result->data_len;\n\n\tif (bt_att_send(op->att, BT_ATT_OP_READ_REQ, read_pdu, sizeof(read_pdu),\n\t\t\t\tread_included_cb, read_included_ref(data),\n\t\t\t\tread_included_unref))\n\t\treturn;\n\n\tread_included_unref(data);\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "read_included_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "931-941",
    "snippet": "static void read_included_unref(void *data)\n{\n\tstruct read_incl_data *read_data = data;\n\n\tif (__sync_sub_and_fetch(&read_data->ref_count, 1))\n\t\treturn;\n\n\tasync_req_unref(read_data->op);\n\n\tfree(read_data);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "read_data"
          ],
          "line": 940
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "async_req_unref",
          "args": [
            "read_data->op"
          ],
          "line": 938
        },
        "resolved": true,
        "details": {
          "function_name": "async_req_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "613-618",
          "snippet": "static void async_req_unref(void *data)\n{\n\tstruct bt_gatt_request *req = data;\n\n\tbt_gatt_request_unref(req);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void async_req_unref(void *data)\n{\n\tstruct bt_gatt_request *req = data;\n\n\tbt_gatt_request_unref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&read_data->ref_count",
            "1"
          ],
          "line": 935
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void read_included_unref(void *data)\n{\n\tstruct read_incl_data *read_data = data;\n\n\tif (__sync_sub_and_fetch(&read_data->ref_count, 1))\n\t\treturn;\n\n\tasync_req_unref(read_data->op);\n\n\tfree(read_data);\n}"
  },
  {
    "function_name": "read_included_ref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "924-929",
    "snippet": "static struct read_incl_data *read_included_ref(struct read_incl_data *data)\n{\n\t__sync_fetch_and_add(&data->ref_count, 1);\n\n\treturn data;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&data->ref_count",
            "1"
          ],
          "line": 926
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct read_incl_data *read_included_ref(struct read_incl_data *data)\n{\n\t__sync_fetch_and_add(&data->ref_count, 1);\n\n\treturn data;\n}"
  },
  {
    "function_name": "new_read_included",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "913-922",
    "snippet": "static struct read_incl_data *new_read_included(struct bt_gatt_result *res)\n{\n\tstruct read_incl_data *data;\n\n\tdata = new0(struct read_incl_data, 1);\n\tdata->op = bt_gatt_request_ref(res->op);\n\tdata->result = res;\n\n\treturn data;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "res->op"
          ],
          "line": 918
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structread_incl_data",
            "1"
          ],
          "line": 917
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct read_incl_data *new_read_included(struct bt_gatt_result *res)\n{\n\tstruct read_incl_data *data;\n\n\tdata = new0(struct read_incl_data, 1);\n\tdata->op = bt_gatt_request_ref(res->op);\n\tdata->result = res;\n\n\treturn data;\n}"
  },
  {
    "function_name": "bt_gatt_discover_secondary_services",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "895-904",
    "snippet": "struct bt_gatt_request *bt_gatt_discover_secondary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn discover_services(att, uuid, start, end, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy, false);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discover_services",
          "args": [
            "att",
            "uuid",
            "start",
            "end",
            "callback",
            "user_data",
            "destroy",
            "false"
          ],
          "line": 902
        },
        "resolved": true,
        "details": {
          "function_name": "discover_services",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "806-871",
          "snippet": "static struct bt_gatt_request *discover_services(struct bt_att *att,\n\t\t\t\t\tbt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy,\n\t\t\t\t\tbool primary)\n{\n\tstruct bt_gatt_request *op;\n\n\tif (!att)\n\t\treturn NULL;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->start_handle = start;\n\top->end_handle = end;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\t/* set service uuid to primary or secondary */\n\top->service_type = primary ? GATT_PRIM_SVC_UUID : GATT_SND_SVC_UUID;\n\n\t/* If UUID is NULL, then discover all primary services */\n\tif (!uuid) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t} else {\n\t\tuint8_t pdu[6 + get_uuid_len(uuid)];\n\n\t\tif (uuid->type == BT_UUID_UNSPEC) {\n\t\t\tfree(op);\n\t\t\treturn NULL;\n\t\t}\n\n\t\t/* Discover by UUID */\n\t\top->uuid = *uuid;\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\t\tbt_uuid_to_le(&op->uuid, pdu + 6);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t}\n\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic struct bt_gatt_request *discover_services(struct bt_att *att,\n\t\t\t\t\tbt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy,\n\t\t\t\t\tbool primary)\n{\n\tstruct bt_gatt_request *op;\n\n\tif (!att)\n\t\treturn NULL;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->start_handle = start;\n\top->end_handle = end;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\t/* set service uuid to primary or secondary */\n\top->service_type = primary ? GATT_PRIM_SVC_UUID : GATT_SND_SVC_UUID;\n\n\t/* If UUID is NULL, then discover all primary services */\n\tif (!uuid) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t} else {\n\t\tuint8_t pdu[6 + get_uuid_len(uuid)];\n\n\t\tif (uuid->type == BT_UUID_UNSPEC) {\n\t\t\tfree(op);\n\t\t\treturn NULL;\n\t\t}\n\n\t\t/* Discover by UUID */\n\t\top->uuid = *uuid;\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\t\tbt_uuid_to_le(&op->uuid, pdu + 6);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t}\n\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_secondary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn discover_services(att, uuid, start, end, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy, false);\n}"
  },
  {
    "function_name": "bt_gatt_discover_primary_services",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "884-893",
    "snippet": "struct bt_gatt_request *bt_gatt_discover_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn discover_services(att, uuid, start, end, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy, true);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discover_services",
          "args": [
            "att",
            "uuid",
            "start",
            "end",
            "callback",
            "user_data",
            "destroy",
            "true"
          ],
          "line": 891
        },
        "resolved": true,
        "details": {
          "function_name": "discover_services",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "806-871",
          "snippet": "static struct bt_gatt_request *discover_services(struct bt_att *att,\n\t\t\t\t\tbt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy,\n\t\t\t\t\tbool primary)\n{\n\tstruct bt_gatt_request *op;\n\n\tif (!att)\n\t\treturn NULL;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->start_handle = start;\n\top->end_handle = end;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\t/* set service uuid to primary or secondary */\n\top->service_type = primary ? GATT_PRIM_SVC_UUID : GATT_SND_SVC_UUID;\n\n\t/* If UUID is NULL, then discover all primary services */\n\tif (!uuid) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t} else {\n\t\tuint8_t pdu[6 + get_uuid_len(uuid)];\n\n\t\tif (uuid->type == BT_UUID_UNSPEC) {\n\t\t\tfree(op);\n\t\t\treturn NULL;\n\t\t}\n\n\t\t/* Discover by UUID */\n\t\top->uuid = *uuid;\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\t\tbt_uuid_to_le(&op->uuid, pdu + 6);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t}\n\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic struct bt_gatt_request *discover_services(struct bt_att *att,\n\t\t\t\t\tbt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy,\n\t\t\t\t\tbool primary)\n{\n\tstruct bt_gatt_request *op;\n\n\tif (!att)\n\t\treturn NULL;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->start_handle = start;\n\top->end_handle = end;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\t/* set service uuid to primary or secondary */\n\top->service_type = primary ? GATT_PRIM_SVC_UUID : GATT_SND_SVC_UUID;\n\n\t/* If UUID is NULL, then discover all primary services */\n\tif (!uuid) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t} else {\n\t\tuint8_t pdu[6 + get_uuid_len(uuid)];\n\n\t\tif (uuid->type == BT_UUID_UNSPEC) {\n\t\t\tfree(op);\n\t\t\treturn NULL;\n\t\t}\n\n\t\t/* Discover by UUID */\n\t\top->uuid = *uuid;\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\t\tbt_uuid_to_le(&op->uuid, pdu + 6);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t}\n\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn discover_services(att, uuid, start, end, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy, true);\n}"
  },
  {
    "function_name": "bt_gatt_discover_all_primary_services",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "873-882",
    "snippet": "struct bt_gatt_request *bt_gatt_discover_all_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn bt_gatt_discover_primary_services(att, uuid, 0x0001, 0xffff,\n\t\t\t\t\t\t\tcallback, user_data,\n\t\t\t\t\t\t\tdestroy);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_discover_primary_services",
          "args": [
            "att",
            "uuid",
            "0x0001",
            "0xffff",
            "callback",
            "user_data",
            "destroy"
          ],
          "line": 879
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_discover_primary_services",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "884-893",
          "snippet": "struct bt_gatt_request *bt_gatt_discover_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn discover_services(att, uuid, start, end, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy, true);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn discover_services(att, uuid, start, end, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy, true);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_all_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn bt_gatt_discover_primary_services(att, uuid, 0x0001, 0xffff,\n\t\t\t\t\t\t\tcallback, user_data,\n\t\t\t\t\t\t\tdestroy);\n}"
  },
  {
    "function_name": "discover_services",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "806-871",
    "snippet": "static struct bt_gatt_request *discover_services(struct bt_att *att,\n\t\t\t\t\tbt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy,\n\t\t\t\t\tbool primary)\n{\n\tstruct bt_gatt_request *op;\n\n\tif (!att)\n\t\treturn NULL;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->start_handle = start;\n\top->end_handle = end;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\t/* set service uuid to primary or secondary */\n\top->service_type = primary ? GATT_PRIM_SVC_UUID : GATT_SND_SVC_UUID;\n\n\t/* If UUID is NULL, then discover all primary services */\n\tif (!uuid) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t} else {\n\t\tuint8_t pdu[6 + get_uuid_len(uuid)];\n\n\t\tif (uuid->type == BT_UUID_UNSPEC) {\n\t\t\tfree(op);\n\t\t\treturn NULL;\n\t\t}\n\n\t\t/* Discover by UUID */\n\t\top->uuid = *uuid;\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\t\tbt_uuid_to_le(&op->uuid, pdu + 6);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t}\n\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 870
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 866
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "att",
            "BT_ATT_OP_FIND_BY_TYPE_REQ",
            "pdu",
            "sizeof(pdu)",
            "find_by_type_val_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 858
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_to_le",
          "args": [
            "&op->uuid",
            "pdu + 6"
          ],
          "line": 856
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "op->service_type",
            "pdu + 4"
          ],
          "line": 855
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_uuid_len",
          "args": [
            "uuid"
          ],
          "line": 843
        },
        "resolved": true,
        "details": {
          "function_name": "get_uuid_len",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "565-571",
          "snippet": "static inline int get_uuid_len(const bt_uuid_t *uuid)\n{\n\tif (!uuid)\n\t\treturn 0;\n\n\treturn (uuid->type == BT_UUID16) ? 2 : 16;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic inline int get_uuid_len(const bt_uuid_t *uuid)\n{\n\tif (!uuid)\n\t\treturn 0;\n\n\treturn (uuid->type == BT_UUID16) ? 2 : 16;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_gatt_request",
            "1"
          ],
          "line": 819
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic struct bt_gatt_request *discover_services(struct bt_att *att,\n\t\t\t\t\tbt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy,\n\t\t\t\t\tbool primary)\n{\n\tstruct bt_gatt_request *op;\n\n\tif (!att)\n\t\treturn NULL;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->start_handle = start;\n\top->end_handle = end;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\t/* set service uuid to primary or secondary */\n\top->service_type = primary ? GATT_PRIM_SVC_UUID : GATT_SND_SVC_UUID;\n\n\t/* If UUID is NULL, then discover all primary services */\n\tif (!uuid) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t} else {\n\t\tuint8_t pdu[6 + get_uuid_len(uuid)];\n\n\t\tif (uuid->type == BT_UUID_UNSPEC) {\n\t\t\tfree(op);\n\t\t\treturn NULL;\n\t\t}\n\n\t\t/* Discover by UUID */\n\t\top->uuid = *uuid;\n\n\t\tput_le16(start, pdu);\n\t\tput_le16(end, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\t\tbt_uuid_to_le(&op->uuid, pdu + 6);\n\n\t\top->id = bt_att_send(att, BT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t}\n\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}"
  },
  {
    "function_name": "find_by_type_val_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "733-804",
    "snippet": "static void find_by_type_val_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tuint16_t last_end;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\t/* PDU must contain 4 bytes and it must be a multiple of 4, where each\n\t * 4 bytes contain the 16-bit attribute and group end handles.\n\t */\n\tif (opcode != BT_ATT_OP_FIND_BY_TYPE_RSP || !pdu || !length ||\n\t\t\t\t\t\t\t\tlength % 4) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (!result_append(opcode, pdu, length, 4, op)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\t/*\n\t * Each data set contains:\n\t * 2 octets with start handle\n\t * 2 octets with end handle\n\t * last_end is end handle of last data set\n\t */\n\tlast_end = get_le16(pdu + length - 2);\n\n\t/*\n\t* If last handle is lower from previous start handle then it is smth\n\t* wrong. Let's stop search, otherwise we might enter infinite loop.\n\t*/\n\tif (last_end < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\top->start_handle = last_end + 1;\n\n\tif (last_end < op->end_handle) {\n\t\tuint8_t pdu[6 + get_uuid_len(&op->uuid)];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\t\tbt_uuid_to_le(&op->uuid, pdu + 6);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 803
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "620-636",
          "snippet": "static void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->att",
            "BT_ATT_OP_FIND_BY_TYPE_REQ",
            "pdu",
            "sizeof(pdu)",
            "find_by_type_val_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 788
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 791
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_to_le",
          "args": [
            "&op->uuid",
            "pdu + 6"
          ],
          "line": 786
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "op->service_type",
            "pdu + 4"
          ],
          "line": 785
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_uuid_len",
          "args": [
            "&op->uuid"
          ],
          "line": 781
        },
        "resolved": true,
        "details": {
          "function_name": "get_uuid_len",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "565-571",
          "snippet": "static inline int get_uuid_len(const bt_uuid_t *uuid)\n{\n\tif (!uuid)\n\t\treturn 0;\n\n\treturn (uuid->type == BT_UUID16) ? 2 : 16;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic inline int get_uuid_len(const bt_uuid_t *uuid)\n{\n\tif (!uuid)\n\t\treturn 0;\n\n\treturn (uuid->type == BT_UUID16) ? 2 : 16;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + length - 2"
          ],
          "line": 767
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "result_append",
          "args": [
            "opcode",
            "pdu",
            "length",
            "4",
            "op"
          ],
          "line": 756
        },
        "resolved": true,
        "details": {
          "function_name": "result_append",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "224-243",
          "snippet": "static struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 743
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "497-507",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void find_by_type_val_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tuint16_t last_end;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\t/* PDU must contain 4 bytes and it must be a multiple of 4, where each\n\t * 4 bytes contain the 16-bit attribute and group end handles.\n\t */\n\tif (opcode != BT_ATT_OP_FIND_BY_TYPE_RSP || !pdu || !length ||\n\t\t\t\t\t\t\t\tlength % 4) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (!result_append(opcode, pdu, length, 4, op)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\t/*\n\t * Each data set contains:\n\t * 2 octets with start handle\n\t * 2 octets with end handle\n\t * last_end is end handle of last data set\n\t */\n\tlast_end = get_le16(pdu + length - 2);\n\n\t/*\n\t* If last handle is lower from previous start handle then it is smth\n\t* wrong. Let's stop search, otherwise we might enter infinite loop.\n\t*/\n\tif (last_end < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\top->start_handle = last_end + 1;\n\n\tif (last_end < op->end_handle) {\n\t\tuint8_t pdu[6 + get_uuid_len(&op->uuid)];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\t\tbt_uuid_to_le(&op->uuid, pdu + 6);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "read_by_grp_type_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "638-731",
    "snippet": "static void read_by_grp_type_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tstruct bt_gatt_result *cur_result;\n\tsize_t data_length;\n\tsize_t list_length;\n\tuint16_t last_end;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\t/* PDU must contain at least the following (sans opcode):\n\t * - Attr Data Length (1 octet)\n\t * - Attr Data List (at least 6 octets):\n\t *   -- 2 octets: Attribute handle\n\t *   -- 2 octets: End group handle\n\t *   -- 2 or 16 octets: service UUID\n\t */\n\tif (opcode != BT_ATT_OP_READ_BY_GRP_TYPE_RSP || !pdu || length < 7) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tdata_length = ((uint8_t *) pdu)[0];\n\tlist_length = length - 1;\n\n\tif ((data_length != 6 && data_length != 20) ||\n\t\t\t\t\t(list_length % data_length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\t/* PDU is correctly formatted. Get the last end handle to process the\n\t * next request and store the PDU.\n\t */\n\tcur_result = result_append(opcode, pdu + 1, list_length, data_length,\n\t\t\t\t\t\t\t\t\top);\n\tif (!cur_result) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tlast_end = get_le16(pdu + length - data_length + 2);\n\n\t/*\n\t * If last handle is lower from previous start handle then it is smth\n\t * wrong. Let's stop search, otherwise we might enter infinite loop.\n\t */\n\tif (last_end < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\top->start_handle = last_end + 1;\n\n\tif (last_end < op->end_handle) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\t/* Some devices incorrectly return 0xffff as the end group handle when\n\t * the read-by-group-type request is performed within a smaller range.\n\t * Manually set the end group handle that we report in the result to the\n\t * end handle in the original request.\n\t */\n\tif (last_end == 0xffff && last_end != op->end_handle)\n\t\tput_le16(op->end_handle,\n\t\t\t\tcur_result->pdu + length - data_length + 1);\n\n\tsuccess = true;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 730
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "620-636",
          "snippet": "static void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "op->end_handle",
            "cur_result->pdu + length - data_length + 1"
          ],
          "line": 724
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->att",
            "BT_ATT_OP_READ_BY_GRP_TYPE_REQ",
            "pdu",
            "sizeof(pdu)",
            "read_by_grp_type_cb",
            "bt_gatt_request_ref(op)",
            "async_req_unref"
          ],
          "line": 706
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_ref",
          "args": [
            "op"
          ],
          "line": 709
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "573-581",
          "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + length - data_length + 2"
          ],
          "line": 686
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "result_append",
          "args": [
            "opcode",
            "pdu + 1",
            "list_length",
            "data_length",
            "op"
          ],
          "line": 679
        },
        "resolved": true,
        "details": {
          "function_name": "result_append",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "224-243",
          "snippet": "static struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 651
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "497-507",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void read_by_grp_type_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_request *op = user_data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tstruct bt_gatt_result *cur_result;\n\tsize_t data_length;\n\tsize_t list_length;\n\tuint16_t last_end;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\t/* PDU must contain at least the following (sans opcode):\n\t * - Attr Data Length (1 octet)\n\t * - Attr Data List (at least 6 octets):\n\t *   -- 2 octets: Attribute handle\n\t *   -- 2 octets: End group handle\n\t *   -- 2 or 16 octets: service UUID\n\t */\n\tif (opcode != BT_ATT_OP_READ_BY_GRP_TYPE_RSP || !pdu || length < 7) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tdata_length = ((uint8_t *) pdu)[0];\n\tlist_length = length - 1;\n\n\tif ((data_length != 6 && data_length != 20) ||\n\t\t\t\t\t(list_length % data_length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\t/* PDU is correctly formatted. Get the last end handle to process the\n\t * next request and store the PDU.\n\t */\n\tcur_result = result_append(opcode, pdu + 1, list_length, data_length,\n\t\t\t\t\t\t\t\t\top);\n\tif (!cur_result) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tlast_end = get_le16(pdu + length - data_length + 2);\n\n\t/*\n\t * If last handle is lower from previous start handle then it is smth\n\t * wrong. Let's stop search, otherwise we might enter infinite loop.\n\t */\n\tif (last_end < op->start_handle) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\top->start_handle = last_end + 1;\n\n\tif (last_end < op->end_handle) {\n\t\tuint8_t pdu[6];\n\n\t\tput_le16(op->start_handle, pdu);\n\t\tput_le16(op->end_handle, pdu + 2);\n\t\tput_le16(op->service_type, pdu + 4);\n\n\t\top->id = bt_att_send(op->att, BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\t\tif (op->id)\n\t\t\treturn;\n\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\t/* Some devices incorrectly return 0xffff as the end group handle when\n\t * the read-by-group-type request is performed within a smaller range.\n\t * Manually set the end group handle that we report in the result to the\n\t * end handle in the original request.\n\t */\n\tif (last_end == 0xffff && last_end != op->end_handle)\n\t\tput_le16(op->end_handle,\n\t\t\t\tcur_result->pdu + length - data_length + 1);\n\n\tsuccess = true;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "discovery_op_complete",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "620-636",
    "snippet": "static void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "async_req_unref",
          "args": [
            "op"
          ],
          "line": 632
        },
        "resolved": true,
        "details": {
          "function_name": "async_req_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "613-618",
          "snippet": "static void async_req_unref(void *data)\n{\n\tstruct bt_gatt_request *req = data;\n\n\tbt_gatt_request_unref(req);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void async_req_unref(void *data)\n{\n\tstruct bt_gatt_request *req = data;\n\n\tbt_gatt_request_unref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "success",
            "ecode",
            "success ? op->result_head : NULL",
            "op->user_data"
          ],
          "line": 628
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void discovery_op_complete(struct bt_gatt_request *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t ecode)\n{\n\t/* Reset success if there is some result to report */\n\tif (ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND && op->result_head)\n\t\tsuccess = true;\n\n\tif (op->callback)\n\t\top->callback(success, ecode, success ? op->result_head : NULL,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tif (!op->id)\n\t\tasync_req_unref(op);\n\telse\n\t\top->id = 0;\n\n}"
  },
  {
    "function_name": "async_req_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "613-618",
    "snippet": "static void async_req_unref(void *data)\n{\n\tstruct bt_gatt_request *req = data;\n\n\tbt_gatt_request_unref(req);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_request_unref",
          "args": [
            "req"
          ],
          "line": 617
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "583-599",
          "snippet": "void bt_gatt_request_unref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_request_cancel(req);\n\n\tif (req->destroy)\n\t\treq->destroy(req->user_data);\n\n\tresult_destroy(req->result_head);\n\n\tfree(req);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nvoid bt_gatt_request_unref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_request_cancel(req);\n\n\tif (req->destroy)\n\t\treq->destroy(req->user_data);\n\n\tresult_destroy(req->result_head);\n\n\tfree(req);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void async_req_unref(void *data)\n{\n\tstruct bt_gatt_request *req = data;\n\n\tbt_gatt_request_unref(req);\n}"
  },
  {
    "function_name": "bt_gatt_request_cancel",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "601-611",
    "snippet": "void bt_gatt_request_cancel(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (!req->id)\n\t\treturn;\n\n\tbt_att_cancel(req->att, req->id);\n\treq->id = 0;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_cancel",
          "args": [
            "req->att",
            "req->id"
          ],
          "line": 609
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_cancel",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1291-1331",
          "snippet": "bool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nvoid bt_gatt_request_cancel(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (!req->id)\n\t\treturn;\n\n\tbt_att_cancel(req->att, req->id);\n\treq->id = 0;\n}"
  },
  {
    "function_name": "bt_gatt_request_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "583-599",
    "snippet": "void bt_gatt_request_unref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_request_cancel(req);\n\n\tif (req->destroy)\n\t\treq->destroy(req->user_data);\n\n\tresult_destroy(req->result_head);\n\n\tfree(req);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "req"
          ],
          "line": 598
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "result_destroy",
          "args": [
            "req->result_head"
          ],
          "line": 596
        },
        "resolved": true,
        "details": {
          "function_name": "result_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "75-87",
          "snippet": "static void result_destroy(struct bt_gatt_result *result)\n{\n\tstruct bt_gatt_result *next;\n\n\twhile (result) {\n\t\tnext = result->next;\n\n\t\tfree(result->pdu);\n\t\tfree(result);\n\n\t\tresult = next;\n\t}\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void result_destroy(struct bt_gatt_result *result)\n{\n\tstruct bt_gatt_result *next;\n\n\twhile (result) {\n\t\tnext = result->next;\n\n\t\tfree(result->pdu);\n\t\tfree(result);\n\n\t\tresult = next;\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "req->destroy",
          "args": [
            "req->user_data"
          ],
          "line": 594
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_cancel",
          "args": [
            "req"
          ],
          "line": 591
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_cancel",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "601-611",
          "snippet": "void bt_gatt_request_cancel(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (!req->id)\n\t\treturn;\n\n\tbt_att_cancel(req->att, req->id);\n\treq->id = 0;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nvoid bt_gatt_request_cancel(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (!req->id)\n\t\treturn;\n\n\tbt_att_cancel(req->att, req->id);\n\treq->id = 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&req->ref_count",
            "1"
          ],
          "line": 588
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nvoid bt_gatt_request_unref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_request_cancel(req);\n\n\tif (req->destroy)\n\t\treq->destroy(req->user_data);\n\n\tresult_destroy(req->result_head);\n\n\tfree(req);\n}"
  },
  {
    "function_name": "bt_gatt_request_ref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "573-581",
    "snippet": "struct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&req->ref_count",
            "1"
          ],
          "line": 578
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstruct bt_gatt_request *bt_gatt_request_ref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
  },
  {
    "function_name": "get_uuid_len",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "565-571",
    "snippet": "static inline int get_uuid_len(const bt_uuid_t *uuid)\n{\n\tif (!uuid)\n\t\treturn 0;\n\n\treturn (uuid->type == BT_UUID16) ? 2 : 16;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic inline int get_uuid_len(const bt_uuid_t *uuid)\n{\n\tif (!uuid)\n\t\treturn 0;\n\n\treturn (uuid->type == BT_UUID16) ? 2 : 16;\n}"
  },
  {
    "function_name": "bt_gatt_exchange_mtu",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "536-563",
    "snippet": "unsigned int bt_gatt_exchange_mtu(struct bt_att *att, uint16_t client_rx_mtu,\n\t\t\t\t\tbt_gatt_result_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct mtu_op *op;\n\tuint8_t pdu[2];\n\tunsigned int id;\n\n\tif (!att || !client_rx_mtu)\n\t\treturn false;\n\n\top = new0(struct mtu_op, 1);\n\top->att = att;\n\top->client_rx_mtu = client_rx_mtu;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\tput_le16(client_rx_mtu, pdu);\n\n\tid = bt_att_send(att, BT_ATT_OP_MTU_REQ, pdu, sizeof(pdu), mtu_cb, op,\n\t\t\t\t\t\t\t\tdestroy_mtu_op);\n\tif (!id)\n\t\tfree(op);\n\n\treturn id;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 560
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "att",
            "BT_ATT_OP_MTU_REQ",
            "pdu",
            "sizeof(pdu)",
            "mtu_cb",
            "op",
            "destroy_mtu_op"
          ],
          "line": 557
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "client_rx_mtu",
            "pdu"
          ],
          "line": 555
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structmtu_op",
            "1"
          ],
          "line": 548
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nunsigned int bt_gatt_exchange_mtu(struct bt_att *att, uint16_t client_rx_mtu,\n\t\t\t\t\tbt_gatt_result_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct mtu_op *op;\n\tuint8_t pdu[2];\n\tunsigned int id;\n\n\tif (!att || !client_rx_mtu)\n\t\treturn false;\n\n\top = new0(struct mtu_op, 1);\n\top->att = att;\n\top->client_rx_mtu = client_rx_mtu;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\tput_le16(client_rx_mtu, pdu);\n\n\tid = bt_att_send(att, BT_ATT_OP_MTU_REQ, pdu, sizeof(pdu), mtu_cb, op,\n\t\t\t\t\t\t\t\tdestroy_mtu_op);\n\tif (!id)\n\t\tfree(op);\n\n\treturn id;\n}"
  },
  {
    "function_name": "mtu_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "509-534",
    "snippet": "static void mtu_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct mtu_op *op = user_data;\n\tbool success = true;\n\tuint8_t att_ecode = 0;\n\tuint16_t server_rx_mtu;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_MTU_RSP || !pdu || length != 2) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tserver_rx_mtu = get_le16(pdu);\n\tbt_att_set_mtu(op->att, MIN(op->client_rx_mtu, server_rx_mtu));\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, att_ecode, op->user_data);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "success",
            "att_ecode",
            "op->user_data"
          ],
          "line": 533
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_set_mtu",
          "args": [
            "op->att",
            "MIN(op->client_rx_mtu, server_rx_mtu)"
          ],
          "line": 529
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_set_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1117-1137",
          "snippet": "bool bt_att_set_mtu(struct bt_att *att, uint16_t mtu)\n{\n\tvoid *buf;\n\n\tif (!att)\n\t\treturn false;\n\n\tif (mtu < BT_ATT_DEFAULT_LE_MTU)\n\t\treturn false;\n\n\tbuf = malloc(mtu);\n\tif (!buf)\n\t\treturn false;\n\n\tfree(att->buf);\n\n\tatt->mtu = mtu;\n\tatt->buf = buf;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_mtu(struct bt_att *att, uint16_t mtu)\n{\n\tvoid *buf;\n\n\tif (!att)\n\t\treturn false;\n\n\tif (mtu < BT_ATT_DEFAULT_LE_MTU)\n\t\treturn false;\n\n\tbuf = malloc(mtu);\n\tif (!buf)\n\t\treturn false;\n\n\tfree(att->buf);\n\n\tatt->mtu = mtu;\n\tatt->buf = buf;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "op->client_rx_mtu",
            "server_rx_mtu"
          ],
          "line": 529
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu"
          ],
          "line": 528
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 519
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "497-507",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void mtu_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct mtu_op *op = user_data;\n\tbool success = true;\n\tuint8_t att_ecode = 0;\n\tuint16_t server_rx_mtu;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_MTU_RSP || !pdu || length != 2) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tserver_rx_mtu = get_le16(pdu);\n\tbt_att_set_mtu(op->att, MIN(op->client_rx_mtu, server_rx_mtu));\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, att_ecode, op->user_data);\n}"
  },
  {
    "function_name": "process_error",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "497-507",
    "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
  },
  {
    "function_name": "destroy_mtu_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "487-495",
    "snippet": "static void destroy_mtu_op(void *user_data)\n{\n\tstruct mtu_op *op = user_data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 494
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->destroy",
          "args": [
            "op->user_data"
          ],
          "line": 492
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstatic void destroy_mtu_op(void *user_data)\n{\n\tstruct mtu_op *op = user_data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op);\n}"
  },
  {
    "function_name": "bt_gatt_iter_next_read_by_type",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "443-477",
    "snippet": "bool bt_gatt_iter_next_read_by_type(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *handle, uint16_t *length,\n\t\t\t\tconst uint8_t **value)\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\n\tif (!iter || !iter->result || !handle || !length || !value)\n\t\treturn false;\n\n\tif (iter->result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn false;\n\n\t/*\n\t * Check if UUID is set, otherwise results can contain characteristic\n\t * discovery service or included service discovery results\n\t */\n\top = iter->result->op;\n\tif (op->uuid.type == BT_UUID_UNSPEC)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t*handle = get_le16(pdu_ptr);\n\t*length = iter->result->data_len - 2;\n\t*value = pdu_ptr + 2;\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu_ptr"
          ],
          "line": 466
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_next_read_by_type(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *handle, uint16_t *length,\n\t\t\t\tconst uint8_t **value)\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\n\tif (!iter || !iter->result || !handle || !length || !value)\n\t\treturn false;\n\n\tif (iter->result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn false;\n\n\t/*\n\t * Check if UUID is set, otherwise results can contain characteristic\n\t * discovery service or included service discovery results\n\t */\n\top = iter->result->op;\n\tif (op->uuid.type == BT_UUID_UNSPEC)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t*handle = get_le16(pdu_ptr);\n\t*length = iter->result->data_len - 2;\n\t*value = pdu_ptr + 2;\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gatt_iter_next_descriptor",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "418-441",
    "snippet": "bool bt_gatt_iter_next_descriptor(struct bt_gatt_iter *iter, uint16_t *handle,\n\t\t\t\t\t\t\tuint8_t uuid[16])\n{\n\tconst void *pdu_ptr;\n\n\tif (!iter || !iter->result || !handle || !uuid)\n\t\treturn false;\n\n\tif (iter->result->opcode != BT_ATT_OP_FIND_INFO_RSP)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t*handle = get_le16(pdu_ptr);\n\tconvert_uuid_le(pdu_ptr + 2, iter->result->data_len - 2, uuid);\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "convert_uuid_le",
          "args": [
            "pdu_ptr + 2",
            "iter->result->data_len - 2",
            "uuid"
          ],
          "line": 432
        },
        "resolved": true,
        "details": {
          "function_name": "convert_uuid_le",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "192-207",
          "snippet": "static bool convert_uuid_le(const uint8_t *src, size_t len, uint8_t dst[16])\n{\n\tif (len == 16) {\n\t\tbswap_128(src, dst);\n\t\treturn true;\n\t}\n\n\tif (len != 2)\n\t\treturn false;\n\n\tmemcpy(dst, bt_base_uuid, sizeof(bt_base_uuid));\n\tdst[2] = src[1];\n\tdst[3] = src[0];\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const uint8_t bt_base_uuid[16] = {\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,\n\t0x80, 0x00, 0x00, 0x80, 0x5F, 0x9B, 0x34, 0xFB\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic const uint8_t bt_base_uuid[16] = {\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,\n\t0x80, 0x00, 0x00, 0x80, 0x5F, 0x9B, 0x34, 0xFB\n};\n\nstatic bool convert_uuid_le(const uint8_t *src, size_t len, uint8_t dst[16])\n{\n\tif (len == 16) {\n\t\tbswap_128(src, dst);\n\t\treturn true;\n\t}\n\n\tif (len != 2)\n\t\treturn false;\n\n\tmemcpy(dst, bt_base_uuid, sizeof(bt_base_uuid));\n\tdst[2] = src[1];\n\tdst[3] = src[0];\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu_ptr"
          ],
          "line": 431
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_next_descriptor(struct bt_gatt_iter *iter, uint16_t *handle,\n\t\t\t\t\t\t\tuint8_t uuid[16])\n{\n\tconst void *pdu_ptr;\n\n\tif (!iter || !iter->result || !handle || !uuid)\n\t\treturn false;\n\n\tif (iter->result->opcode != BT_ATT_OP_FIND_INFO_RSP)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t*handle = get_le16(pdu_ptr);\n\tconvert_uuid_le(pdu_ptr + 2, iter->result->data_len - 2, uuid);\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gatt_iter_next_characteristic",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "366-416",
    "snippet": "bool bt_gatt_iter_next_characteristic(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *start_handle, uint16_t *end_handle,\n\t\t\t\tuint16_t *value_handle, uint8_t *properties,\n\t\t\t\tuint8_t uuid[16])\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\n\tif (!iter || !iter->result || !start_handle || !end_handle ||\n\t\t\t\t\t!value_handle || !properties || !uuid)\n\t\treturn false;\n\n\tif (iter->result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn false;\n\n\t/* UUID in discovery_op is set in read_by_type and service_discovery */\n\top = iter->result->op;\n\tif (op->uuid.type != BT_UUID_UNSPEC)\n\t\treturn false;\n\t/*\n\t * Data length contains 7 or 21 octets:\n\t * 2 octets: Attribute handle\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (iter->result->data_len != 21 && iter->result->data_len != 7)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t*start_handle = get_le16(pdu_ptr);\n\t*properties = ((uint8_t *) pdu_ptr)[2];\n\t*value_handle = get_le16(pdu_ptr + 3);\n\tconvert_uuid_le(pdu_ptr + 5, iter->result->data_len - 5, uuid);\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\tif (!iter->result) {\n\t\t*end_handle = op->end_handle;\n\t\treturn true;\n\t}\n\n\t*end_handle = get_le16(iter->result->pdu + iter->pos) - 1;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "iter->result->pdu + iter->pos"
          ],
          "line": 413
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "convert_uuid_le",
          "args": [
            "pdu_ptr + 5",
            "iter->result->data_len - 5",
            "uuid"
          ],
          "line": 400
        },
        "resolved": true,
        "details": {
          "function_name": "convert_uuid_le",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "192-207",
          "snippet": "static bool convert_uuid_le(const uint8_t *src, size_t len, uint8_t dst[16])\n{\n\tif (len == 16) {\n\t\tbswap_128(src, dst);\n\t\treturn true;\n\t}\n\n\tif (len != 2)\n\t\treturn false;\n\n\tmemcpy(dst, bt_base_uuid, sizeof(bt_base_uuid));\n\tdst[2] = src[1];\n\tdst[3] = src[0];\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const uint8_t bt_base_uuid[16] = {\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,\n\t0x80, 0x00, 0x00, 0x80, 0x5F, 0x9B, 0x34, 0xFB\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic const uint8_t bt_base_uuid[16] = {\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,\n\t0x80, 0x00, 0x00, 0x80, 0x5F, 0x9B, 0x34, 0xFB\n};\n\nstatic bool convert_uuid_le(const uint8_t *src, size_t len, uint8_t dst[16])\n{\n\tif (len == 16) {\n\t\tbswap_128(src, dst);\n\t\treturn true;\n\t}\n\n\tif (len != 2)\n\t\treturn false;\n\n\tmemcpy(dst, bt_base_uuid, sizeof(bt_base_uuid));\n\tdst[2] = src[1];\n\tdst[3] = src[0];\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_next_characteristic(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *start_handle, uint16_t *end_handle,\n\t\t\t\tuint16_t *value_handle, uint8_t *properties,\n\t\t\t\tuint8_t uuid[16])\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\n\tif (!iter || !iter->result || !start_handle || !end_handle ||\n\t\t\t\t\t!value_handle || !properties || !uuid)\n\t\treturn false;\n\n\tif (iter->result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn false;\n\n\t/* UUID in discovery_op is set in read_by_type and service_discovery */\n\top = iter->result->op;\n\tif (op->uuid.type != BT_UUID_UNSPEC)\n\t\treturn false;\n\t/*\n\t * Data length contains 7 or 21 octets:\n\t * 2 octets: Attribute handle\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (iter->result->data_len != 21 && iter->result->data_len != 7)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t*start_handle = get_le16(pdu_ptr);\n\t*properties = ((uint8_t *) pdu_ptr)[2];\n\t*value_handle = get_le16(pdu_ptr + 3);\n\tconvert_uuid_le(pdu_ptr + 5, iter->result->data_len - 5, uuid);\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\tif (!iter->result) {\n\t\t*end_handle = op->end_handle;\n\t\treturn true;\n\t}\n\n\t*end_handle = get_le16(iter->result->pdu + iter->pos) - 1;\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gatt_iter_next_service",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "325-364",
    "snippet": "bool bt_gatt_iter_next_service(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *start_handle, uint16_t *end_handle,\n\t\t\t\tuint8_t uuid[16])\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\tbt_uuid_t tmp;\n\n\tif (!iter || !iter->result || !start_handle || !end_handle || !uuid)\n\t\treturn false;\n\n\top = iter->result->op;\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\tswitch (iter->result->opcode) {\n\tcase BT_ATT_OP_READ_BY_GRP_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\t\tconvert_uuid_le(pdu_ptr + 4, iter->result->data_len - 4, uuid);\n\t\tbreak;\n\tcase BT_ATT_OP_FIND_BY_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\n\t\tbt_uuid_to_uuid128(&op->uuid, &tmp);\n\t\tmemcpy(uuid, tmp.value.u128.data, 16);\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "uuid",
            "tmp.value.u128.data",
            "16"
          ],
          "line": 350
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid_to_uuid128",
          "args": [
            "&op->uuid",
            "&tmp"
          ],
          "line": 349
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu_ptr + 2"
          ],
          "line": 347
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "convert_uuid_le",
          "args": [
            "pdu_ptr + 4",
            "iter->result->data_len - 4",
            "uuid"
          ],
          "line": 343
        },
        "resolved": true,
        "details": {
          "function_name": "convert_uuid_le",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "192-207",
          "snippet": "static bool convert_uuid_le(const uint8_t *src, size_t len, uint8_t dst[16])\n{\n\tif (len == 16) {\n\t\tbswap_128(src, dst);\n\t\treturn true;\n\t}\n\n\tif (len != 2)\n\t\treturn false;\n\n\tmemcpy(dst, bt_base_uuid, sizeof(bt_base_uuid));\n\tdst[2] = src[1];\n\tdst[3] = src[0];\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const uint8_t bt_base_uuid[16] = {\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,\n\t0x80, 0x00, 0x00, 0x80, 0x5F, 0x9B, 0x34, 0xFB\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic const uint8_t bt_base_uuid[16] = {\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,\n\t0x80, 0x00, 0x00, 0x80, 0x5F, 0x9B, 0x34, 0xFB\n};\n\nstatic bool convert_uuid_le(const uint8_t *src, size_t len, uint8_t dst[16])\n{\n\tif (len == 16) {\n\t\tbswap_128(src, dst);\n\t\treturn true;\n\t}\n\n\tif (len != 2)\n\t\treturn false;\n\n\tmemcpy(dst, bt_base_uuid, sizeof(bt_base_uuid));\n\tdst[2] = src[1];\n\tdst[3] = src[0];\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_next_service(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *start_handle, uint16_t *end_handle,\n\t\t\t\tuint8_t uuid[16])\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\tbt_uuid_t tmp;\n\n\tif (!iter || !iter->result || !start_handle || !end_handle || !uuid)\n\t\treturn false;\n\n\top = iter->result->op;\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\tswitch (iter->result->opcode) {\n\tcase BT_ATT_OP_READ_BY_GRP_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\t\tconvert_uuid_le(pdu_ptr + 4, iter->result->data_len - 4, uuid);\n\t\tbreak;\n\tcase BT_ATT_OP_FIND_BY_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\n\t\tbt_uuid_to_uuid128(&op->uuid, &tmp);\n\t\tmemcpy(uuid, tmp.value.u128.data, 16);\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gatt_iter_next_included_service",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "245-323",
    "snippet": "bool bt_gatt_iter_next_included_service(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *handle, uint16_t *start_handle,\n\t\t\t\tuint16_t *end_handle, uint8_t uuid[16])\n{\n\tstruct bt_gatt_result *read_result;\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\tint i = 0;\n\n\tif (!iter || !iter->result || !handle || !start_handle || !end_handle\n\t\t\t\t\t\t\t\t|| !uuid)\n\t\treturn false;\n\n\n\tif (iter->result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn false;\n\n\t/* UUID in discovery_op is set in read_by_type and service_discovery */\n\top = iter->result->op;\n\tif (op->uuid.type != BT_UUID_UNSPEC)\n\t\treturn false;\n\t/*\n\t * iter->result points to READ_BY_TYPE_RSP with data length containing:\n\t * 2 octets - include service handle\n\t * 2 octets - start handle of included service\n\t * 2 octets - end handle of included service\n\t * optional 2  octets - Bluetooth UUID\n\t */\n\tif (iter->result->data_len != 8 && iter->result->data_len != 6)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t/* This result contains 16 bit UUID */\n\tif (iter->result->data_len == 8) {\n\t\t*handle = get_le16(pdu_ptr);\n\t\t*start_handle = get_le16(pdu_ptr + 2);\n\t\t*end_handle = get_le16(pdu_ptr + 4);\n\t\tconvert_uuid_le(pdu_ptr + 6, 2, uuid);\n\n\t\titer->pos += iter->result->data_len;\n\n\t\tif (iter->pos == iter->result->pdu_len) {\n\t\t\titer->result = iter->result->next;\n\t\t\titer->pos = 0;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t*handle = get_le16(pdu_ptr);\n\t*start_handle = get_le16(pdu_ptr + 2);\n\t*end_handle = get_le16(pdu_ptr + 4);\n\tread_result = iter->result;\n\n\t/*\n\t * Find READ_RSP with include service UUID.\n\t * If number of current data set in READ_BY_TYPE_RSP is n, then we must\n\t * go to n'th PDU next to current item->result\n\t */\n\tfor (read_result = read_result->next; read_result; i++) {\n\t\tif (i >= (iter->pos / iter->result->data_len))\n\t\t\tbreak;\n\n\t\tread_result = read_result->next;\n\t}\n\n\tif (!read_result)\n\t\treturn false;\n\n\tconvert_uuid_le(read_result->pdu, read_result->data_len, uuid);\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = read_result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "convert_uuid_le",
          "args": [
            "read_result->pdu",
            "read_result->data_len",
            "uuid"
          ],
          "line": 315
        },
        "resolved": true,
        "details": {
          "function_name": "convert_uuid_le",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "192-207",
          "snippet": "static bool convert_uuid_le(const uint8_t *src, size_t len, uint8_t dst[16])\n{\n\tif (len == 16) {\n\t\tbswap_128(src, dst);\n\t\treturn true;\n\t}\n\n\tif (len != 2)\n\t\treturn false;\n\n\tmemcpy(dst, bt_base_uuid, sizeof(bt_base_uuid));\n\tdst[2] = src[1];\n\tdst[3] = src[0];\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const uint8_t bt_base_uuid[16] = {\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,\n\t0x80, 0x00, 0x00, 0x80, 0x5F, 0x9B, 0x34, 0xFB\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic const uint8_t bt_base_uuid[16] = {\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,\n\t0x80, 0x00, 0x00, 0x80, 0x5F, 0x9B, 0x34, 0xFB\n};\n\nstatic bool convert_uuid_le(const uint8_t *src, size_t len, uint8_t dst[16])\n{\n\tif (len == 16) {\n\t\tbswap_128(src, dst);\n\t\treturn true;\n\t}\n\n\tif (len != 2)\n\t\treturn false;\n\n\tmemcpy(dst, bt_base_uuid, sizeof(bt_base_uuid));\n\tdst[2] = src[1];\n\tdst[3] = src[0];\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu_ptr + 4"
          ],
          "line": 297
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_next_included_service(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *handle, uint16_t *start_handle,\n\t\t\t\tuint16_t *end_handle, uint8_t uuid[16])\n{\n\tstruct bt_gatt_result *read_result;\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\tint i = 0;\n\n\tif (!iter || !iter->result || !handle || !start_handle || !end_handle\n\t\t\t\t\t\t\t\t|| !uuid)\n\t\treturn false;\n\n\n\tif (iter->result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn false;\n\n\t/* UUID in discovery_op is set in read_by_type and service_discovery */\n\top = iter->result->op;\n\tif (op->uuid.type != BT_UUID_UNSPEC)\n\t\treturn false;\n\t/*\n\t * iter->result points to READ_BY_TYPE_RSP with data length containing:\n\t * 2 octets - include service handle\n\t * 2 octets - start handle of included service\n\t * 2 octets - end handle of included service\n\t * optional 2  octets - Bluetooth UUID\n\t */\n\tif (iter->result->data_len != 8 && iter->result->data_len != 6)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t/* This result contains 16 bit UUID */\n\tif (iter->result->data_len == 8) {\n\t\t*handle = get_le16(pdu_ptr);\n\t\t*start_handle = get_le16(pdu_ptr + 2);\n\t\t*end_handle = get_le16(pdu_ptr + 4);\n\t\tconvert_uuid_le(pdu_ptr + 6, 2, uuid);\n\n\t\titer->pos += iter->result->data_len;\n\n\t\tif (iter->pos == iter->result->pdu_len) {\n\t\t\titer->result = iter->result->next;\n\t\t\titer->pos = 0;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t*handle = get_le16(pdu_ptr);\n\t*start_handle = get_le16(pdu_ptr + 2);\n\t*end_handle = get_le16(pdu_ptr + 4);\n\tread_result = iter->result;\n\n\t/*\n\t * Find READ_RSP with include service UUID.\n\t * If number of current data set in READ_BY_TYPE_RSP is n, then we must\n\t * go to n'th PDU next to current item->result\n\t */\n\tfor (read_result = read_result->next; read_result; i++) {\n\t\tif (i >= (iter->pos / iter->result->data_len))\n\t\t\tbreak;\n\n\t\tread_result = read_result->next;\n\t}\n\n\tif (!read_result)\n\t\treturn false;\n\n\tconvert_uuid_le(read_result->pdu, read_result->data_len, uuid);\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = read_result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}"
  },
  {
    "function_name": "result_append",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "224-243",
    "snippet": "static struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "result_create",
          "args": [
            "opcode",
            "pdu",
            "pdu_len",
            "data_len",
            "op"
          ],
          "line": 231
        },
        "resolved": true,
        "details": {
          "function_name": "result_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "51-73",
          "snippet": "static struct bt_gatt_result *result_create(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\t\tvoid *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = new0(struct bt_gatt_result, 1);\n\tresult->pdu = malloc(pdu_len);\n\tif (!result->pdu) {\n\t\tfree(result);\n\t\treturn NULL;\n\t}\n\n\tresult->opcode = opcode;\n\tresult->pdu_len = pdu_len;\n\tresult->data_len = data_len;\n\tresult->op = op;\n\n\tmemcpy(result->pdu, pdu, pdu_len);\n\n\treturn result;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct bt_gatt_result *result_create(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\t\tvoid *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = new0(struct bt_gatt_result, 1);\n\tresult->pdu = malloc(pdu_len);\n\tif (!result->pdu) {\n\t\tfree(result);\n\t\treturn NULL;\n\t}\n\n\tresult->opcode = opcode;\n\tresult->pdu_len = pdu_len;\n\tresult->data_len = data_len;\n\tresult->op = op;\n\n\tmemcpy(result->pdu, pdu, pdu_len);\n\n\treturn result;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct bt_gatt_result *result_append(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\tstruct bt_gatt_request *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = result_create(opcode, pdu, pdu_len, data_len, op);\n\tif (!result)\n\t\treturn NULL;\n\n\tif (!op->result_head)\n\t\top->result_head = op->result_tail = result;\n\telse {\n\t\top->result_tail->next = result;\n\t\top->result_tail = result;\n\t}\n\n\treturn result;\n}"
  },
  {
    "function_name": "convert_uuid_le",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "192-207",
    "snippet": "static bool convert_uuid_le(const uint8_t *src, size_t len, uint8_t dst[16])\n{\n\tif (len == 16) {\n\t\tbswap_128(src, dst);\n\t\treturn true;\n\t}\n\n\tif (len != 2)\n\t\treturn false;\n\n\tmemcpy(dst, bt_base_uuid, sizeof(bt_base_uuid));\n\tdst[2] = src[1];\n\tdst[3] = src[0];\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static const uint8_t bt_base_uuid[16] = {\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,\n\t0x80, 0x00, 0x00, 0x80, 0x5F, 0x9B, 0x34, 0xFB\n};"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "dst",
            "bt_base_uuid",
            "sizeof(bt_base_uuid)"
          ],
          "line": 202
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bswap_128",
          "args": [
            "src",
            "dst"
          ],
          "line": 195
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic const uint8_t bt_base_uuid[16] = {\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00,\n\t0x80, 0x00, 0x00, 0x80, 0x5F, 0x9B, 0x34, 0xFB\n};\n\nstatic bool convert_uuid_le(const uint8_t *src, size_t len, uint8_t dst[16])\n{\n\tif (len == 16) {\n\t\tbswap_128(src, dst);\n\t\treturn true;\n\t}\n\n\tif (len != 2)\n\t\treturn false;\n\n\tmemcpy(dst, bt_base_uuid, sizeof(bt_base_uuid));\n\tdst[2] = src[1];\n\tdst[3] = src[0];\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gatt_iter_init",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "176-185",
    "snippet": "bool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gatt_result_included_count",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "148-174",
    "snippet": "unsigned int bt_gatt_result_included_count(struct bt_gatt_result *result)\n{\n\tstruct bt_gatt_result *cur;\n\tunsigned int count = 0;\n\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn 0;\n\n\t/*\n\t * Data length can be of length 6 or 8 octets:\n\t * 2 octets - include service handle\n\t * 2 octets - start handle of included service\n\t * 2 octets - end handle of included service\n\t * 2 octets (optionally) - 16 bit Bluetooth UUID\n\t */\n\tif (result->data_len != 6 && result->data_len != 8)\n\t\treturn 0;\n\n\tfor (cur = result; cur; cur = cur->next)\n\t\tif (cur->opcode == BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\t\tcount += cur->pdu_len / cur->data_len;\n\n\treturn count;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nunsigned int bt_gatt_result_included_count(struct bt_gatt_result *result)\n{\n\tstruct bt_gatt_result *cur;\n\tunsigned int count = 0;\n\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn 0;\n\n\t/*\n\t * Data length can be of length 6 or 8 octets:\n\t * 2 octets - include service handle\n\t * 2 octets - start handle of included service\n\t * 2 octets - end handle of included service\n\t * 2 octets (optionally) - 16 bit Bluetooth UUID\n\t */\n\tif (result->data_len != 6 && result->data_len != 8)\n\t\treturn 0;\n\n\tfor (cur = result; cur; cur = cur->next)\n\t\tif (cur->opcode == BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\t\tcount += cur->pdu_len / cur->data_len;\n\n\treturn count;\n}"
  },
  {
    "function_name": "bt_gatt_result_descriptor_count",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "137-146",
    "snippet": "unsigned int bt_gatt_result_descriptor_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_FIND_INFO_RSP)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "result_element_count",
          "args": [
            "result"
          ],
          "line": 145
        },
        "resolved": true,
        "details": {
          "function_name": "result_element_count",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "89-102",
          "snippet": "static unsigned int result_element_count(struct bt_gatt_result *result)\n{\n\tunsigned int count = 0;\n\tstruct bt_gatt_result *cur;\n\n\tcur = result;\n\n\twhile (cur) {\n\t\tcount += cur->pdu_len / cur->data_len;\n\t\tcur = cur->next;\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic unsigned int result_element_count(struct bt_gatt_result *result)\n{\n\tunsigned int count = 0;\n\tstruct bt_gatt_result *cur;\n\n\tcur = result;\n\n\twhile (cur) {\n\t\tcount += cur->pdu_len / cur->data_len;\n\t\tcur = cur->next;\n\t}\n\n\treturn count;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nunsigned int bt_gatt_result_descriptor_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_FIND_INFO_RSP)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}"
  },
  {
    "function_name": "bt_gatt_result_characteristic_count",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "116-135",
    "snippet": "unsigned int bt_gatt_result_characteristic_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn 0;\n\n\t/*\n\t * Data length contains 7 or 21 octets:\n\t * 2 octets: Attribute handle\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (result->data_len != 21 && result->data_len != 7)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "result_element_count",
          "args": [
            "result"
          ],
          "line": 134
        },
        "resolved": true,
        "details": {
          "function_name": "result_element_count",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "89-102",
          "snippet": "static unsigned int result_element_count(struct bt_gatt_result *result)\n{\n\tunsigned int count = 0;\n\tstruct bt_gatt_result *cur;\n\n\tcur = result;\n\n\twhile (cur) {\n\t\tcount += cur->pdu_len / cur->data_len;\n\t\tcur = cur->next;\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic unsigned int result_element_count(struct bt_gatt_result *result)\n{\n\tunsigned int count = 0;\n\tstruct bt_gatt_result *cur;\n\n\tcur = result;\n\n\twhile (cur) {\n\t\tcount += cur->pdu_len / cur->data_len;\n\t\tcur = cur->next;\n\t}\n\n\treturn count;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nunsigned int bt_gatt_result_characteristic_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn 0;\n\n\t/*\n\t * Data length contains 7 or 21 octets:\n\t * 2 octets: Attribute handle\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (result->data_len != 21 && result->data_len != 7)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}"
  },
  {
    "function_name": "bt_gatt_result_service_count",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "104-114",
    "snippet": "unsigned int bt_gatt_result_service_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_GRP_TYPE_RSP &&\n\t\t\tresult->opcode != BT_ATT_OP_FIND_BY_TYPE_RSP)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "result_element_count",
          "args": [
            "result"
          ],
          "line": 113
        },
        "resolved": true,
        "details": {
          "function_name": "result_element_count",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "89-102",
          "snippet": "static unsigned int result_element_count(struct bt_gatt_result *result)\n{\n\tunsigned int count = 0;\n\tstruct bt_gatt_result *cur;\n\n\tcur = result;\n\n\twhile (cur) {\n\t\tcount += cur->pdu_len / cur->data_len;\n\t\tcur = cur->next;\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic unsigned int result_element_count(struct bt_gatt_result *result)\n{\n\tunsigned int count = 0;\n\tstruct bt_gatt_result *cur;\n\n\tcur = result;\n\n\twhile (cur) {\n\t\tcount += cur->pdu_len / cur->data_len;\n\t\tcur = cur->next;\n\t}\n\n\treturn count;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nunsigned int bt_gatt_result_service_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_GRP_TYPE_RSP &&\n\t\t\tresult->opcode != BT_ATT_OP_FIND_BY_TYPE_RSP)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}"
  },
  {
    "function_name": "result_element_count",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "89-102",
    "snippet": "static unsigned int result_element_count(struct bt_gatt_result *result)\n{\n\tunsigned int count = 0;\n\tstruct bt_gatt_result *cur;\n\n\tcur = result;\n\n\twhile (cur) {\n\t\tcount += cur->pdu_len / cur->data_len;\n\t\tcur = cur->next;\n\t}\n\n\treturn count;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic unsigned int result_element_count(struct bt_gatt_result *result)\n{\n\tunsigned int count = 0;\n\tstruct bt_gatt_result *cur;\n\n\tcur = result;\n\n\twhile (cur) {\n\t\tcount += cur->pdu_len / cur->data_len;\n\t\tcur = cur->next;\n\t}\n\n\treturn count;\n}"
  },
  {
    "function_name": "result_destroy",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "75-87",
    "snippet": "static void result_destroy(struct bt_gatt_result *result)\n{\n\tstruct bt_gatt_result *next;\n\n\twhile (result) {\n\t\tnext = result->next;\n\n\t\tfree(result->pdu);\n\t\tfree(result);\n\n\t\tresult = next;\n\t}\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "result"
          ],
          "line": 83
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void result_destroy(struct bt_gatt_result *result)\n{\n\tstruct bt_gatt_result *next;\n\n\twhile (result) {\n\t\tnext = result->next;\n\n\t\tfree(result->pdu);\n\t\tfree(result);\n\n\t\tresult = next;\n\t}\n}"
  },
  {
    "function_name": "result_create",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
    "lines": "51-73",
    "snippet": "static struct bt_gatt_result *result_create(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\t\tvoid *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = new0(struct bt_gatt_result, 1);\n\tresult->pdu = malloc(pdu_len);\n\tif (!result->pdu) {\n\t\tfree(result);\n\t\treturn NULL;\n\t}\n\n\tresult->opcode = opcode;\n\tresult->pdu_len = pdu_len;\n\tresult->data_len = data_len;\n\tresult->op = op;\n\n\tmemcpy(result->pdu, pdu, pdu_len);\n\n\treturn result;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"src/shared/queue.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "result->pdu",
            "pdu",
            "pdu_len"
          ],
          "line": 70
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "result"
          ],
          "line": 61
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "pdu_len"
          ],
          "line": 59
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_gatt_result",
            "1"
          ],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic struct bt_gatt_result *result_create(uint8_t opcode, const void *pdu,\n\t\t\t\t\t\t\tuint16_t pdu_len,\n\t\t\t\t\t\t\tuint16_t data_len,\n\t\t\t\t\t\t\tvoid *op)\n{\n\tstruct bt_gatt_result *result;\n\n\tresult = new0(struct bt_gatt_result, 1);\n\tresult->pdu = malloc(pdu_len);\n\tif (!result->pdu) {\n\t\tfree(result);\n\t\treturn NULL;\n\t}\n\n\tresult->opcode = opcode;\n\tresult->pdu_len = pdu_len;\n\tresult->data_len = data_len;\n\tresult->op = op;\n\n\tmemcpy(result->pdu, pdu, pdu_len);\n\n\treturn result;\n}"
  }
]