[
  {
    "function_name": "bt_gatt_client_get_security",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "3286-3292",
    "snippet": "int bt_gatt_client_get_security(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn -1;\n\n\treturn bt_att_get_security(client->att, NULL);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_get_security",
          "args": [
            "client->att",
            "NULL"
          ],
          "line": 3291
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_security",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1458-1482",
          "snippet": "int bt_att_get_security(struct bt_att *att, uint8_t *enc_size)\n{\n\tstruct bt_security sec;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap) {\n\t\tif (enc_size)\n\t\t\t*enc_size = att->enc_size;\n\n\t\treturn att->io_sec_level;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tlen = sizeof(sec);\n\tif (getsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec, &len) < 0)\n\t\treturn -EIO;\n\n\tif (enc_size)\n\t\t*enc_size = att->enc_size;\n\n\treturn sec.level;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nint bt_att_get_security(struct bt_att *att, uint8_t *enc_size)\n{\n\tstruct bt_security sec;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap) {\n\t\tif (enc_size)\n\t\t\t*enc_size = att->enc_size;\n\n\t\treturn att->io_sec_level;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tlen = sizeof(sec);\n\tif (getsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec, &len) < 0)\n\t\treturn -EIO;\n\n\tif (enc_size)\n\t\t*enc_size = att->enc_size;\n\n\treturn sec.level;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nint bt_gatt_client_get_security(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn -1;\n\n\treturn bt_att_get_security(client->att, NULL);\n}"
  },
  {
    "function_name": "bt_gatt_client_set_security",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "3278-3284",
    "snippet": "bool bt_gatt_client_set_security(struct bt_gatt_client *client, int level)\n{\n\tif (!client)\n\t\treturn false;\n\n\treturn bt_att_set_security(client->att, level);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_set_security",
          "args": [
            "client->att",
            "level"
          ],
          "line": 3283
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_set_security",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1484-1505",
          "snippet": "bool bt_att_set_security(struct bt_att *att, int level)\n{\n\tstruct bt_security sec;\n\n\tif (!att || level < BT_ATT_SECURITY_AUTO ||\n\t\t\t\t\t\tlevel > BT_ATT_SECURITY_HIGH)\n\t\treturn false;\n\n\tif (!att->io_on_l2cap) {\n\t\tatt->io_sec_level = level;\n\t\treturn true;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tsec.level = level;\n\n\tif (setsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec,\n\t\t\t\t\t\t\tsizeof(sec)) < 0)\n\t\treturn false;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_security(struct bt_att *att, int level)\n{\n\tstruct bt_security sec;\n\n\tif (!att || level < BT_ATT_SECURITY_AUTO ||\n\t\t\t\t\t\tlevel > BT_ATT_SECURITY_HIGH)\n\t\treturn false;\n\n\tif (!att->io_on_l2cap) {\n\t\tatt->io_sec_level = level;\n\t\treturn true;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tsec.level = level;\n\n\tif (setsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec,\n\t\t\t\t\t\t\tsizeof(sec)) < 0)\n\t\treturn false;\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nbool bt_gatt_client_set_security(struct bt_gatt_client *client, int level)\n{\n\tif (!client)\n\t\treturn false;\n\n\treturn bt_att_set_security(client->att, level);\n}"
  },
  {
    "function_name": "bt_gatt_client_unregister_notify",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "3254-3276",
    "snippet": "bool bt_gatt_client_unregister_notify(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tunsigned int id)\n{\n\tstruct notify_data *notify_data;\n\n\tif (!client || !id)\n\t\treturn false;\n\n\tnotify_data = queue_remove_if(client->notify_list, match_notify_data_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!notify_data)\n\t\treturn false;\n\n\t/* Remove data if it has been queued */\n\tqueue_remove(notify_data->chrc->reg_notify_queue, notify_data);\n\n\t/* Reset callbacks */\n\tnotify_data->callback = NULL;\n\tnotify_data->notify = NULL;\n\n\tcomplete_unregister_notify(notify_data);\n\treturn true;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "complete_unregister_notify",
          "args": [
            "notify_data"
          ],
          "line": 3274
        },
        "resolved": true,
        "details": {
          "function_name": "complete_unregister_notify",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1790-1812",
          "snippet": "static void complete_unregister_notify(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\t/*\n\t * If a procedure to enable the CCC is still pending, then cancel it and\n\t * return.\n\t */\n\tif (notify_data->att_id) {\n\t\tbt_att_cancel(notify_data->client->att, notify_data->att_id);\n\t\tnotify_data->att_id = 0;\n\t\tgoto done;\n\t}\n\n\tif (__sync_sub_and_fetch(&notify_data->chrc->notify_count, 1) ||\n\t\t\t\t\t\t!notify_data->chrc->ccc_handle)\n\t\tgoto done;\n\n\tnotify_data_write_ccc(notify_data, false, disable_ccc_callback);\n\ndone:\n\tnotify_data_unref(notify_data);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void complete_unregister_notify(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\t/*\n\t * If a procedure to enable the CCC is still pending, then cancel it and\n\t * return.\n\t */\n\tif (notify_data->att_id) {\n\t\tbt_att_cancel(notify_data->client->att, notify_data->att_id);\n\t\tnotify_data->att_id = 0;\n\t\tgoto done;\n\t}\n\n\tif (__sync_sub_and_fetch(&notify_data->chrc->notify_count, 1) ||\n\t\t\t\t\t\t!notify_data->chrc->ccc_handle)\n\t\tgoto done;\n\n\tnotify_data_write_ccc(notify_data, false, disable_ccc_callback);\n\ndone:\n\tnotify_data_unref(notify_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "notify_data->chrc->reg_notify_queue",
            "notify_data"
          ],
          "line": 3268
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_if",
          "args": [
            "client->notify_list",
            "match_notify_data_id",
            "UINT_TO_PTR(id)"
          ],
          "line": 3262
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_if",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "278-316",
          "snippet": "void *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 3263
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nbool bt_gatt_client_unregister_notify(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tunsigned int id)\n{\n\tstruct notify_data *notify_data;\n\n\tif (!client || !id)\n\t\treturn false;\n\n\tnotify_data = queue_remove_if(client->notify_list, match_notify_data_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!notify_data)\n\t\treturn false;\n\n\t/* Remove data if it has been queued */\n\tqueue_remove(notify_data->chrc->reg_notify_queue, notify_data);\n\n\t/* Reset callbacks */\n\tnotify_data->callback = NULL;\n\tnotify_data->notify = NULL;\n\n\tcomplete_unregister_notify(notify_data);\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gatt_client_register_notify",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "3237-3252",
    "snippet": "unsigned int bt_gatt_client_register_notify(struct bt_gatt_client *client,\n\t\t\t\tuint16_t chrc_value_handle,\n\t\t\t\tbt_gatt_client_register_callback_t callback,\n\t\t\t\tbt_gatt_client_notify_callback_t notify,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tif (!client || !client->db || !chrc_value_handle || !callback)\n\t\treturn 0;\n\n\tif (client->in_svc_chngd)\n\t\treturn 0;\n\n\treturn register_notify(client, chrc_value_handle, callback, notify,\n\t\t\t\t\t\t\tuser_data, destroy);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "register_notify",
          "args": [
            "client",
            "chrc_value_handle",
            "callback",
            "notify",
            "user_data",
            "destroy"
          ],
          "line": 3250
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_register_notify",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "3237-3252",
          "snippet": "unsigned int bt_gatt_client_register_notify(struct bt_gatt_client *client,\n\t\t\t\tuint16_t chrc_value_handle,\n\t\t\t\tbt_gatt_client_register_callback_t callback,\n\t\t\t\tbt_gatt_client_notify_callback_t notify,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tif (!client || !client->db || !chrc_value_handle || !callback)\n\t\treturn 0;\n\n\tif (client->in_svc_chngd)\n\t\treturn 0;\n\n\treturn register_notify(client, chrc_value_handle, callback, notify,\n\t\t\t\t\t\t\tuser_data, destroy);\n}",
          "note": "cyclic_reference_detected"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_register_notify(struct bt_gatt_client *client,\n\t\t\t\tuint16_t chrc_value_handle,\n\t\t\t\tbt_gatt_client_register_callback_t callback,\n\t\t\t\tbt_gatt_client_notify_callback_t notify,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tif (!client || !client->db || !chrc_value_handle || !callback)\n\t\treturn 0;\n\n\tif (client->in_svc_chngd)\n\t\treturn 0;\n\n\treturn register_notify(client, chrc_value_handle, callback, notify,\n\t\t\t\t\t\t\tuser_data, destroy);\n}"
  },
  {
    "function_name": "bt_gatt_client_write_execute",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "3187-3235",
    "snippet": "unsigned int bt_gatt_client_write_execute(struct bt_gatt_client *client,\n\t\t\t\t\tunsigned int id,\n\t\t\t\t\tbt_gatt_client_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct write_op *op;\n\tuint8_t pdu;\n\n\tif (!client)\n\t\treturn 0;\n\n\tif (client->in_long_write)\n\t\treturn 0;\n\n\tif (client->reliable_write_session_id != id)\n\t\treturn 0;\n\n\top = new0(struct write_op, 1);\n\n\treq = queue_find(client->pending_requests, match_req_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->client = client;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\tpdu = 0x01;\n\n\treq->data = op;\n\treq->destroy = destroy_write_op;\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_EXEC_WRITE_REQ, &pdu,\n\t\t\t\t\t\tsizeof(pdu), exec_write_cb,\n\t\t\t\t\t\treq, request_unref);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 3230
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "BT_ATT_OP_EXEC_WRITE_REQ",
            "&pdu",
            "sizeof(pdu)",
            "exec_write_cb",
            "req",
            "request_unref"
          ],
          "line": 3225
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 3211
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_find",
          "args": [
            "client->pending_requests",
            "match_req_id",
            "UINT_TO_PTR(id)"
          ],
          "line": 3208
        },
        "resolved": true,
        "details": {
          "function_name": "queue_find",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "231-247",
          "snippet": "void *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 3209
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structwrite_op",
            "1"
          ],
          "line": 3206
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_write_execute(struct bt_gatt_client *client,\n\t\t\t\t\tunsigned int id,\n\t\t\t\t\tbt_gatt_client_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct write_op *op;\n\tuint8_t pdu;\n\n\tif (!client)\n\t\treturn 0;\n\n\tif (client->in_long_write)\n\t\treturn 0;\n\n\tif (client->reliable_write_session_id != id)\n\t\treturn 0;\n\n\top = new0(struct write_op, 1);\n\n\treq = queue_find(client->pending_requests, match_req_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->client = client;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\tpdu = 0x01;\n\n\treq->data = op;\n\treq->destroy = destroy_write_op;\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_EXEC_WRITE_REQ, &pdu,\n\t\t\t\t\t\tsizeof(pdu), exec_write_cb,\n\t\t\t\t\t\treq, request_unref);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn id;\n}"
  },
  {
    "function_name": "exec_write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "3155-3185",
    "snippet": "static void exec_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct write_op *op = req->data;\n\tbool success;\n\tuint8_t att_ecode;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_EXEC_WRITE_RSP || pdu || length) {\n\t\tsuccess = false;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\tatt_ecode = 0;\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, att_ecode, op->user_data);\n\n\top->client->reliable_write_session_id = 0;\n\n\tstart_next_long_write(op->client);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "start_next_long_write",
          "args": [
            "op->client"
          ],
          "line": 3184
        },
        "resolved": true,
        "details": {
          "function_name": "start_next_long_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2750-2770",
          "snippet": "static void start_next_long_write(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (queue_isempty(client->long_write_queue)) {\n\t\tclient->in_long_write = false;\n\t\treturn;\n\t}\n\n\treq  = queue_pop_head(client->long_write_queue);\n\tif (!req)\n\t\treturn;\n\n\thandle_next_prep_write(req);\n\n\t/*\n\t * send_next_prep_write adds an extra ref. Unref here to clean up if\n\t * necessary, since we also added a ref before pushing to the queue.\n\t */\n\trequest_unref(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void start_next_long_write(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (queue_isempty(client->long_write_queue)) {\n\t\tclient->in_long_write = false;\n\t\treturn;\n\t}\n\n\treq  = queue_pop_head(client->long_write_queue);\n\tif (!req)\n\t\treturn;\n\n\thandle_next_prep_write(req);\n\n\t/*\n\t * send_next_prep_write adds an extra ref. Unref here to clean up if\n\t * necessary, since we also added a ref before pushing to the queue.\n\t */\n\trequest_unref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "success",
            "att_ecode",
            "op->user_data"
          ],
          "line": 3180
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 3165
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1357-1367",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void exec_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct write_op *op = req->data;\n\tbool success;\n\tuint8_t att_ecode;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_EXEC_WRITE_RSP || pdu || length) {\n\t\tsuccess = false;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\tatt_ecode = 0;\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, att_ecode, op->user_data);\n\n\top->client->reliable_write_session_id = 0;\n\n\tstart_next_long_write(op->client);\n}"
  },
  {
    "function_name": "bt_gatt_client_prepare_write",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "3067-3153",
    "snippet": "unsigned int bt_gatt_client_prepare_write(struct bt_gatt_client *client,\n\t\t\t\tunsigned int id, uint16_t value_handle,\n\t\t\t\tuint16_t offset, const uint8_t *value,\n\t\t\t\tuint16_t length,\n\t\t\t\tbt_gatt_client_write_long_callback_t callback,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct prep_write_op *op;\n\tuint8_t pdu[4 + length];\n\n\tif (!client)\n\t\treturn 0;\n\n\tif (client->in_long_write)\n\t\treturn 0;\n\n\t/*\n\t * Make sure that client who owns reliable session continues with\n\t * prepare writes or this is brand new reliable session (id == 0)\n\t */\n\tif (id != client->reliable_write_session_id) {\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"There is other reliable write session ongoing %u\",\n\t\t\tclient->reliable_write_session_id);\n\n\t\treturn 0;\n\t}\n\n\treq = get_reliable_request(client, id);\n\tif (!req)\n\t\treturn 0;\n\n\top = (struct prep_write_op *)req->data;\n\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->destroy = destroy_prep_write_op;\n\treq->prep_write = true;\n\n\tput_le16(value_handle, pdu);\n\tput_le16(offset, pdu + 2);\n\tmemcpy(pdu + 4, value, length);\n\n\t/*\n\t * Before sending command we need to remember pdu as we need to validate\n\t * it in the response. Store handle, offset and value. Therefore\n\t * increase length by 4 (handle + offset) as we need it in couple places\n\t * below\n\t */\n\tlength += 4;\n\n\top->pdu = malloc(length);\n\tif (!op->pdu) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\tmemcpy(op->pdu, pdu, length);\n\top->pdu_len = length;\n\n\t/*\n\t * Now we are ready to send command\n\t * Note that request_unref will be done on write execute\n\t */\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_PREP_WRITE_REQ, pdu,\n\t\t\t\t\tsizeof(pdu), prep_write_cb, req,\n\t\t\t\t\tNULL);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\t/*\n\t * Store first request id for prepare write and treat it as a session id\n\t * valid until write execute is done\n\t */\n\tif (client->reliable_write_session_id == 0)\n\t\tclient->reliable_write_session_id = req->id;\n\n\treturn client->reliable_write_session_id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 3141
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "BT_ATT_OP_PREP_WRITE_REQ",
            "pdu",
            "sizeof(pdu)",
            "prep_write_cb",
            "req",
            "NULL"
          ],
          "line": 3136
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "op->pdu",
            "pdu",
            "length"
          ],
          "line": 3129
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "length"
          ],
          "line": 3122
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "pdu + 4",
            "value",
            "length"
          ],
          "line": 3112
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "offset",
            "pdu + 2"
          ],
          "line": 3111
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_reliable_request",
          "args": [
            "client",
            "id"
          ],
          "line": 3097
        },
        "resolved": true,
        "details": {
          "function_name": "get_reliable_request",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "3042-3065",
          "snippet": "static struct request *get_reliable_request(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tunsigned int id)\n{\n\tstruct request *req;\n\tstruct prep_write_op *op;\n\n\top = new0(struct prep_write_op, 1);\n\n\t/* Following prepare writes */\n\tif (id != 0)\n\t\treq = queue_find(client->pending_requests, match_req_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\telse\n\t\treq = request_create(client);\n\n\tif (!req) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treq->data = op;\n\n\treturn req;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *get_reliable_request(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tunsigned int id)\n{\n\tstruct request *req;\n\tstruct prep_write_op *op;\n\n\top = new0(struct prep_write_op, 1);\n\n\t/* Following prepare writes */\n\tif (id != 0)\n\t\treq = queue_find(client->pending_requests, match_req_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\telse\n\t\treq = request_create(client);\n\n\tif (!req) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treq->data = op;\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"There is other reliable write session ongoing %u\"",
            "client->reliable_write_session_id"
          ],
          "line": 3090
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_prepare_write(struct bt_gatt_client *client,\n\t\t\t\tunsigned int id, uint16_t value_handle,\n\t\t\t\tuint16_t offset, const uint8_t *value,\n\t\t\t\tuint16_t length,\n\t\t\t\tbt_gatt_client_write_long_callback_t callback,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct prep_write_op *op;\n\tuint8_t pdu[4 + length];\n\n\tif (!client)\n\t\treturn 0;\n\n\tif (client->in_long_write)\n\t\treturn 0;\n\n\t/*\n\t * Make sure that client who owns reliable session continues with\n\t * prepare writes or this is brand new reliable session (id == 0)\n\t */\n\tif (id != client->reliable_write_session_id) {\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"There is other reliable write session ongoing %u\",\n\t\t\tclient->reliable_write_session_id);\n\n\t\treturn 0;\n\t}\n\n\treq = get_reliable_request(client, id);\n\tif (!req)\n\t\treturn 0;\n\n\top = (struct prep_write_op *)req->data;\n\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->destroy = destroy_prep_write_op;\n\treq->prep_write = true;\n\n\tput_le16(value_handle, pdu);\n\tput_le16(offset, pdu + 2);\n\tmemcpy(pdu + 4, value, length);\n\n\t/*\n\t * Before sending command we need to remember pdu as we need to validate\n\t * it in the response. Store handle, offset and value. Therefore\n\t * increase length by 4 (handle + offset) as we need it in couple places\n\t * below\n\t */\n\tlength += 4;\n\n\top->pdu = malloc(length);\n\tif (!op->pdu) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\tmemcpy(op->pdu, pdu, length);\n\top->pdu_len = length;\n\n\t/*\n\t * Now we are ready to send command\n\t * Note that request_unref will be done on write execute\n\t */\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_PREP_WRITE_REQ, pdu,\n\t\t\t\t\tsizeof(pdu), prep_write_cb, req,\n\t\t\t\t\tNULL);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\t/*\n\t * Store first request id for prepare write and treat it as a session id\n\t * valid until write execute is done\n\t */\n\tif (client->reliable_write_session_id == 0)\n\t\tclient->reliable_write_session_id = req->id;\n\n\treturn client->reliable_write_session_id;\n}"
  },
  {
    "function_name": "get_reliable_request",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "3042-3065",
    "snippet": "static struct request *get_reliable_request(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tunsigned int id)\n{\n\tstruct request *req;\n\tstruct prep_write_op *op;\n\n\top = new0(struct prep_write_op, 1);\n\n\t/* Following prepare writes */\n\tif (id != 0)\n\t\treq = queue_find(client->pending_requests, match_req_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\telse\n\t\treq = request_create(client);\n\n\tif (!req) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treq->data = op;\n\n\treturn req;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 3058
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_create",
          "args": [
            "client"
          ],
          "line": 3055
        },
        "resolved": true,
        "details": {
          "function_name": "request_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "140-157",
          "snippet": "static struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_find",
          "args": [
            "client->pending_requests",
            "match_req_id",
            "UINT_TO_PTR(id)"
          ],
          "line": 3052
        },
        "resolved": true,
        "details": {
          "function_name": "queue_find",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "231-247",
          "snippet": "void *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 3053
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structprep_write_op",
            "1"
          ],
          "line": 3048
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *get_reliable_request(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tunsigned int id)\n{\n\tstruct request *req;\n\tstruct prep_write_op *op;\n\n\top = new0(struct prep_write_op, 1);\n\n\t/* Following prepare writes */\n\tif (id != 0)\n\t\treq = queue_find(client->pending_requests, match_req_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\telse\n\t\treq = request_create(client);\n\n\tif (!req) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treq->data = op;\n\n\treturn req;\n}"
  },
  {
    "function_name": "prep_write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "3002-3040",
    "snippet": "static void prep_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct prep_write_op *op = req->data;\n\tbool success;\n\tuint8_t att_ecode;\n\tbool reliable_error;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\treliable_error = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_PREP_WRITE_RSP) {\n\t\tsuccess = false;\n\t\treliable_error = false;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tif (!pdu || length != op->pdu_len ||\n\t\t\t\t\tmemcmp(pdu, op->pdu, op->pdu_len)) {\n\t\tsuccess = false;\n\t\treliable_error = true;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\treliable_error = false;\n\tatt_ecode = 0;\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, reliable_error, att_ecode, op->user_data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);",
      "static void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "success",
            "reliable_error",
            "att_ecode",
            "op->user_data"
          ],
          "line": 3039
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memcmp",
          "args": [
            "pdu",
            "op->pdu",
            "op->pdu_len"
          ],
          "line": 3026
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 3014
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1357-1367",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\nstatic void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);\n\nstatic void prep_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct prep_write_op *op = req->data;\n\tbool success;\n\tuint8_t att_ecode;\n\tbool reliable_error;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\treliable_error = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_PREP_WRITE_RSP) {\n\t\tsuccess = false;\n\t\treliable_error = false;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tif (!pdu || length != op->pdu_len ||\n\t\t\t\t\tmemcmp(pdu, op->pdu, op->pdu_len)) {\n\t\tsuccess = false;\n\t\treliable_error = true;\n\t\tatt_ecode = 0;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\treliable_error = false;\n\tatt_ecode = 0;\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, reliable_error, att_ecode, op->user_data);\n}"
  },
  {
    "function_name": "destroy_prep_write_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2991-3000",
    "snippet": "static void destroy_prep_write_op(void *data)\n{\n\tstruct prep_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 2999
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->destroy",
          "args": [
            "op->user_data"
          ],
          "line": 2996
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void destroy_prep_write_op(void *data)\n{\n\tstruct prep_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}"
  },
  {
    "function_name": "bt_gatt_client_write_long_value",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2896-2981",
    "snippet": "unsigned int bt_gatt_client_write_long_value(struct bt_gatt_client *client,\n\t\t\t\tbool reliable,\n\t\t\t\tuint16_t value_handle, uint16_t offset,\n\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\tbt_gatt_client_write_long_callback_t callback,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct long_write_op *op;\n\tuint8_t *pdu;\n\n\tif (!client)\n\t\treturn 0;\n\n\tif ((size_t)(length + offset) > UINT16_MAX)\n\t\treturn 0;\n\n\t/* Don't allow writing a 0-length value using this procedure. The\n\t * upper-layer should use bt_gatt_write_value for that instead.\n\t */\n\tif (!length || !value)\n\t\treturn 0;\n\n\top = new0(struct long_write_op, 1);\n\top->value = malloc(length);\n\tif (!op->value) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op->value);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\tmemcpy(op->value, value, length);\n\n\top->client = client;\n\top->reliable = reliable;\n\top->value_handle = value_handle;\n\top->length = length;\n\top->offset = offset;\n\top->cur_length = MIN(length, bt_att_get_mtu(client->att) - 5);\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = long_write_op_free;\n\treq->long_write = true;\n\n\tif (client->in_long_write || client->reliable_write_session_id > 0) {\n\t\tqueue_push_tail(client->long_write_queue, req);\n\t\treturn req->id;\n\t}\n\n\tpdu = malloc(op->cur_length + 4);\n\tif (!pdu) {\n\t\tfree(op->value);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\tput_le16(value_handle, pdu);\n\tput_le16(offset, pdu + 2);\n\tmemcpy(pdu + 4, op->value, op->cur_length);\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\t\tpdu, op->cur_length + 4,\n\t\t\t\t\t\t\tprepare_write_cb, req,\n\t\t\t\t\t\t\trequest_unref);\n\tfree(pdu);\n\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\tclient->in_long_write = true;\n\n\treturn req->id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 2974
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "pdu"
          ],
          "line": 2970
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "BT_ATT_OP_PREP_WRITE_REQ",
            "pdu",
            "op->cur_length + 4",
            "prepare_write_cb",
            "req",
            "request_unref"
          ],
          "line": 2966
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "pdu + 4",
            "op->value",
            "op->cur_length"
          ],
          "line": 2964
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "offset",
            "pdu + 2"
          ],
          "line": 2963
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "op->cur_length + 4"
          ],
          "line": 2955
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "client->long_write_queue",
            "req"
          ],
          "line": 2951
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "length",
            "bt_att_get_mtu(client->att) - 5"
          ],
          "line": 2941
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "client->att"
          ],
          "line": 2941
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "op->value",
            "value",
            "length"
          ],
          "line": 2934
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "request_create",
          "args": [
            "client"
          ],
          "line": 2927
        },
        "resolved": true,
        "details": {
          "function_name": "request_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "140-157",
          "snippet": "static struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structlong_write_op",
            "1"
          ],
          "line": 2920
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_write_long_value(struct bt_gatt_client *client,\n\t\t\t\tbool reliable,\n\t\t\t\tuint16_t value_handle, uint16_t offset,\n\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\tbt_gatt_client_write_long_callback_t callback,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct long_write_op *op;\n\tuint8_t *pdu;\n\n\tif (!client)\n\t\treturn 0;\n\n\tif ((size_t)(length + offset) > UINT16_MAX)\n\t\treturn 0;\n\n\t/* Don't allow writing a 0-length value using this procedure. The\n\t * upper-layer should use bt_gatt_write_value for that instead.\n\t */\n\tif (!length || !value)\n\t\treturn 0;\n\n\top = new0(struct long_write_op, 1);\n\top->value = malloc(length);\n\tif (!op->value) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op->value);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\tmemcpy(op->value, value, length);\n\n\top->client = client;\n\top->reliable = reliable;\n\top->value_handle = value_handle;\n\top->length = length;\n\top->offset = offset;\n\top->cur_length = MIN(length, bt_att_get_mtu(client->att) - 5);\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = long_write_op_free;\n\treq->long_write = true;\n\n\tif (client->in_long_write || client->reliable_write_session_id > 0) {\n\t\tqueue_push_tail(client->long_write_queue, req);\n\t\treturn req->id;\n\t}\n\n\tpdu = malloc(op->cur_length + 4);\n\tif (!pdu) {\n\t\tfree(op->value);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\tput_le16(value_handle, pdu);\n\tput_le16(offset, pdu + 2);\n\tmemcpy(pdu + 4, op->value, op->cur_length);\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\t\tpdu, op->cur_length + 4,\n\t\t\t\t\t\t\tprepare_write_cb, req,\n\t\t\t\t\t\t\trequest_unref);\n\tfree(pdu);\n\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\tclient->in_long_write = true;\n\n\treturn req->id;\n}"
  },
  {
    "function_name": "prepare_write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2833-2894",
    "snippet": "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct long_write_op *op = req->data;\n\tbool success = true;\n\tbool reliable_error = false;\n\tuint8_t att_ecode = 0;\n\tuint16_t next_index;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_PREP_WRITE_RSP) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (op->reliable) {\n\t\tif (!pdu || length != (op->cur_length + 4)) {\n\t\t\tsuccess = false;\n\t\t\treliable_error = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tif (get_le16(pdu) != op->value_handle ||\n\t\t\t\tget_le16(pdu + 2) != (op->offset + op->index)) {\n\t\t\tsuccess = false;\n\t\t\treliable_error = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tif (memcmp(pdu + 4, op->value + op->index, op->cur_length)) {\n\t\t\tsuccess = false;\n\t\t\treliable_error = true;\n\t\t\tgoto done;\n\t\t}\n\t}\n\n\tnext_index = op->index + op->cur_length;\n\tif (next_index == op->length) {\n\t\t/* All bytes written */\n\t\tgoto done;\n\t}\n\n\t/* If the last written length was greater than or equal to what can fit\n\t * inside a PDU, then there is more data to send.\n\t */\n\tif (op->cur_length >= bt_att_get_mtu(op->client->att) - 5) {\n\t\top->index = next_index;\n\t\top->cur_length = MIN(op->length - op->index,\n\t\t\t\t\tbt_att_get_mtu(op->client->att) - 5);\n\t\thandle_next_prep_write(req);\n\t\treturn;\n\t}\n\ndone:\n\tcomplete_write_long_op(req, success, att_ecode, reliable_error);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);",
      "static void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "complete_write_long_op",
          "args": [
            "req",
            "success",
            "att_ecode",
            "reliable_error"
          ],
          "line": 2893
        },
        "resolved": true,
        "details": {
          "function_name": "complete_write_long_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2797-2831",
          "snippet": "static void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error)\n{\n\tstruct long_write_op *op = req->data;\n\tuint8_t pdu;\n\n\top->success = success;\n\top->att_ecode = att_ecode;\n\top->reliable_error = reliable_error;\n\n\tif (success)\n\t\tpdu = 0x01;  /* Write */\n\telse\n\t\tpdu = 0x00;  /* Cancel */\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t&pdu, sizeof(pdu),\n\t\t\t\t\t\t\texecute_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (req->att_id)\n\t\treturn;\n\n\trequest_unref(req);\n\tsuccess = false;\n\n\tbt_gatt_client_ref(op->client);\n\n\tif (op->callback)\n\t\top->callback(success, reliable_error, att_ecode, op->user_data);\n\n\tstart_next_long_write(op->client);\n\n\tbt_gatt_client_unref(op->client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);",
            "static void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\nstatic void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);\n\nstatic void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error)\n{\n\tstruct long_write_op *op = req->data;\n\tuint8_t pdu;\n\n\top->success = success;\n\top->att_ecode = att_ecode;\n\top->reliable_error = reliable_error;\n\n\tif (success)\n\t\tpdu = 0x01;  /* Write */\n\telse\n\t\tpdu = 0x00;  /* Cancel */\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t&pdu, sizeof(pdu),\n\t\t\t\t\t\t\texecute_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (req->att_id)\n\t\treturn;\n\n\trequest_unref(req);\n\tsuccess = false;\n\n\tbt_gatt_client_ref(op->client);\n\n\tif (op->callback)\n\t\top->callback(success, reliable_error, att_ecode, op->user_data);\n\n\tstart_next_long_write(op->client);\n\n\tbt_gatt_client_unref(op->client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "handle_next_prep_write",
          "args": [
            "req"
          ],
          "line": 2888
        },
        "resolved": true,
        "details": {
          "function_name": "handle_next_prep_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2711-2748",
          "snippet": "static void handle_next_prep_write(struct request *req)\n{\n\tstruct long_write_op *op = req->data;\n\tbool success = true;\n\tuint8_t *pdu;\n\n\tpdu = malloc(op->cur_length + 4);\n\tif (!pdu) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tput_le16(op->value_handle, pdu);\n\tput_le16(op->offset + op->index, pdu + 2);\n\tmemcpy(pdu + 4, op->value + op->index, op->cur_length);\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\t\tpdu, op->cur_length + 4,\n\t\t\t\t\t\t\tprepare_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\trequest_unref(req);\n\t\tsuccess = false;\n\t}\n\n\tfree(pdu);\n\n\t/* If so far successful, then the operation should continue.\n\t * Otherwise, there was an error and the procedure should be\n\t * completed.\n\t */\n\tif (success)\n\t\treturn;\n\ndone:\n\tcomplete_write_long_op(req, success, 0, false);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void handle_next_prep_write(struct request *req)\n{\n\tstruct long_write_op *op = req->data;\n\tbool success = true;\n\tuint8_t *pdu;\n\n\tpdu = malloc(op->cur_length + 4);\n\tif (!pdu) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tput_le16(op->value_handle, pdu);\n\tput_le16(op->offset + op->index, pdu + 2);\n\tmemcpy(pdu + 4, op->value + op->index, op->cur_length);\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\t\tpdu, op->cur_length + 4,\n\t\t\t\t\t\t\tprepare_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\trequest_unref(req);\n\t\tsuccess = false;\n\t}\n\n\tfree(pdu);\n\n\t/* If so far successful, then the operation should continue.\n\t * Otherwise, there was an error and the procedure should be\n\t * completed.\n\t */\n\tif (success)\n\t\treturn;\n\ndone:\n\tcomplete_write_long_op(req, success, 0, false);\n}"
        }
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "op->length - op->index",
            "bt_att_get_mtu(op->client->att) - 5"
          ],
          "line": 2886
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "op->client->att"
          ],
          "line": 2887
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcmp",
          "args": [
            "pdu + 4",
            "op->value + op->index",
            "op->cur_length"
          ],
          "line": 2868
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + 2"
          ],
          "line": 2862
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 2845
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1357-1367",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\nstatic void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);\n\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct long_write_op *op = req->data;\n\tbool success = true;\n\tbool reliable_error = false;\n\tuint8_t att_ecode = 0;\n\tuint16_t next_index;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_PREP_WRITE_RSP) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (op->reliable) {\n\t\tif (!pdu || length != (op->cur_length + 4)) {\n\t\t\tsuccess = false;\n\t\t\treliable_error = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tif (get_le16(pdu) != op->value_handle ||\n\t\t\t\tget_le16(pdu + 2) != (op->offset + op->index)) {\n\t\t\tsuccess = false;\n\t\t\treliable_error = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tif (memcmp(pdu + 4, op->value + op->index, op->cur_length)) {\n\t\t\tsuccess = false;\n\t\t\treliable_error = true;\n\t\t\tgoto done;\n\t\t}\n\t}\n\n\tnext_index = op->index + op->cur_length;\n\tif (next_index == op->length) {\n\t\t/* All bytes written */\n\t\tgoto done;\n\t}\n\n\t/* If the last written length was greater than or equal to what can fit\n\t * inside a PDU, then there is more data to send.\n\t */\n\tif (op->cur_length >= bt_att_get_mtu(op->client->att) - 5) {\n\t\top->index = next_index;\n\t\top->cur_length = MIN(op->length - op->index,\n\t\t\t\t\tbt_att_get_mtu(op->client->att) - 5);\n\t\thandle_next_prep_write(req);\n\t\treturn;\n\t}\n\ndone:\n\tcomplete_write_long_op(req, success, att_ecode, reliable_error);\n}"
  },
  {
    "function_name": "complete_write_long_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2797-2831",
    "snippet": "static void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error)\n{\n\tstruct long_write_op *op = req->data;\n\tuint8_t pdu;\n\n\top->success = success;\n\top->att_ecode = att_ecode;\n\top->reliable_error = reliable_error;\n\n\tif (success)\n\t\tpdu = 0x01;  /* Write */\n\telse\n\t\tpdu = 0x00;  /* Cancel */\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t&pdu, sizeof(pdu),\n\t\t\t\t\t\t\texecute_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (req->att_id)\n\t\treturn;\n\n\trequest_unref(req);\n\tsuccess = false;\n\n\tbt_gatt_client_ref(op->client);\n\n\tif (op->callback)\n\t\top->callback(success, reliable_error, att_ecode, op->user_data);\n\n\tstart_next_long_write(op->client);\n\n\tbt_gatt_client_unref(op->client);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);",
      "static void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_client_unref",
          "args": [
            "op->client"
          ],
          "line": 2830
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2004-2013",
          "snippet": "void bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nvoid bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "start_next_long_write",
          "args": [
            "op->client"
          ],
          "line": 2828
        },
        "resolved": true,
        "details": {
          "function_name": "start_next_long_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2750-2770",
          "snippet": "static void start_next_long_write(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (queue_isempty(client->long_write_queue)) {\n\t\tclient->in_long_write = false;\n\t\treturn;\n\t}\n\n\treq  = queue_pop_head(client->long_write_queue);\n\tif (!req)\n\t\treturn;\n\n\thandle_next_prep_write(req);\n\n\t/*\n\t * send_next_prep_write adds an extra ref. Unref here to clean up if\n\t * necessary, since we also added a ref before pushing to the queue.\n\t */\n\trequest_unref(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void start_next_long_write(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (queue_isempty(client->long_write_queue)) {\n\t\tclient->in_long_write = false;\n\t\treturn;\n\t}\n\n\treq  = queue_pop_head(client->long_write_queue);\n\tif (!req)\n\t\treturn;\n\n\thandle_next_prep_write(req);\n\n\t/*\n\t * send_next_prep_write adds an extra ref. Unref here to clean up if\n\t * necessary, since we also added a ref before pushing to the queue.\n\t */\n\trequest_unref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "success",
            "reliable_error",
            "att_ecode",
            "op->user_data"
          ],
          "line": 2826
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_client_ref",
          "args": [
            "op->client"
          ],
          "line": 2823
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1994-2002",
          "snippet": "struct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 2820
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->client->att",
            "BT_ATT_OP_EXEC_WRITE_REQ",
            "&pdu",
            "sizeof(pdu)",
            "execute_write_cb",
            "request_ref(req)",
            "request_unref"
          ],
          "line": 2812
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_ref",
          "args": [
            "req"
          ],
          "line": 2815
        },
        "resolved": true,
        "details": {
          "function_name": "request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "133-138",
          "snippet": "static struct request *request_ref(struct request *req)\n{\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_ref(struct request *req)\n{\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\nstatic void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);\n\nstatic void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error)\n{\n\tstruct long_write_op *op = req->data;\n\tuint8_t pdu;\n\n\top->success = success;\n\top->att_ecode = att_ecode;\n\top->reliable_error = reliable_error;\n\n\tif (success)\n\t\tpdu = 0x01;  /* Write */\n\telse\n\t\tpdu = 0x00;  /* Cancel */\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t&pdu, sizeof(pdu),\n\t\t\t\t\t\t\texecute_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (req->att_id)\n\t\treturn;\n\n\trequest_unref(req);\n\tsuccess = false;\n\n\tbt_gatt_client_ref(op->client);\n\n\tif (op->callback)\n\t\top->callback(success, reliable_error, att_ecode, op->user_data);\n\n\tstart_next_long_write(op->client);\n\n\tbt_gatt_client_unref(op->client);\n}"
  },
  {
    "function_name": "execute_write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2772-2795",
    "snippet": "static void execute_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct long_write_op *op = req->data;\n\tbool success = op->success;\n\tuint8_t att_ecode = op->att_ecode;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t} else if (opcode != BT_ATT_OP_EXEC_WRITE_RSP || pdu || length)\n\t\tsuccess = false;\n\n\tbt_gatt_client_ref(op->client);\n\n\tif (op->callback)\n\t\top->callback(success, op->reliable_error, att_ecode,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tstart_next_long_write(op->client);\n\n\tbt_gatt_client_unref(op->client);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);",
      "static void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_client_unref",
          "args": [
            "op->client"
          ],
          "line": 2794
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2004-2013",
          "snippet": "void bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nvoid bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "start_next_long_write",
          "args": [
            "op->client"
          ],
          "line": 2792
        },
        "resolved": true,
        "details": {
          "function_name": "start_next_long_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2750-2770",
          "snippet": "static void start_next_long_write(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (queue_isempty(client->long_write_queue)) {\n\t\tclient->in_long_write = false;\n\t\treturn;\n\t}\n\n\treq  = queue_pop_head(client->long_write_queue);\n\tif (!req)\n\t\treturn;\n\n\thandle_next_prep_write(req);\n\n\t/*\n\t * send_next_prep_write adds an extra ref. Unref here to clean up if\n\t * necessary, since we also added a ref before pushing to the queue.\n\t */\n\trequest_unref(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void start_next_long_write(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (queue_isempty(client->long_write_queue)) {\n\t\tclient->in_long_write = false;\n\t\treturn;\n\t}\n\n\treq  = queue_pop_head(client->long_write_queue);\n\tif (!req)\n\t\treturn;\n\n\thandle_next_prep_write(req);\n\n\t/*\n\t * send_next_prep_write adds an extra ref. Unref here to clean up if\n\t * necessary, since we also added a ref before pushing to the queue.\n\t */\n\trequest_unref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "success",
            "op->reliable_error",
            "att_ecode",
            "op->user_data"
          ],
          "line": 2789
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_client_ref",
          "args": [
            "op->client"
          ],
          "line": 2786
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1994-2002",
          "snippet": "struct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 2782
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1357-1367",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\nstatic void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);\n\nstatic void execute_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct long_write_op *op = req->data;\n\tbool success = op->success;\n\tuint8_t att_ecode = op->att_ecode;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t} else if (opcode != BT_ATT_OP_EXEC_WRITE_RSP || pdu || length)\n\t\tsuccess = false;\n\n\tbt_gatt_client_ref(op->client);\n\n\tif (op->callback)\n\t\top->callback(success, op->reliable_error, att_ecode,\n\t\t\t\t\t\t\t\top->user_data);\n\n\tstart_next_long_write(op->client);\n\n\tbt_gatt_client_unref(op->client);\n}"
  },
  {
    "function_name": "start_next_long_write",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2750-2770",
    "snippet": "static void start_next_long_write(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (queue_isempty(client->long_write_queue)) {\n\t\tclient->in_long_write = false;\n\t\treturn;\n\t}\n\n\treq  = queue_pop_head(client->long_write_queue);\n\tif (!req)\n\t\treturn;\n\n\thandle_next_prep_write(req);\n\n\t/*\n\t * send_next_prep_write adds an extra ref. Unref here to clean up if\n\t * necessary, since we also added a ref before pushing to the queue.\n\t */\n\trequest_unref(req);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 2769
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "handle_next_prep_write",
          "args": [
            "req"
          ],
          "line": 2763
        },
        "resolved": true,
        "details": {
          "function_name": "handle_next_prep_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2711-2748",
          "snippet": "static void handle_next_prep_write(struct request *req)\n{\n\tstruct long_write_op *op = req->data;\n\tbool success = true;\n\tuint8_t *pdu;\n\n\tpdu = malloc(op->cur_length + 4);\n\tif (!pdu) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tput_le16(op->value_handle, pdu);\n\tput_le16(op->offset + op->index, pdu + 2);\n\tmemcpy(pdu + 4, op->value + op->index, op->cur_length);\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\t\tpdu, op->cur_length + 4,\n\t\t\t\t\t\t\tprepare_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\trequest_unref(req);\n\t\tsuccess = false;\n\t}\n\n\tfree(pdu);\n\n\t/* If so far successful, then the operation should continue.\n\t * Otherwise, there was an error and the procedure should be\n\t * completed.\n\t */\n\tif (success)\n\t\treturn;\n\ndone:\n\tcomplete_write_long_op(req, success, 0, false);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void handle_next_prep_write(struct request *req)\n{\n\tstruct long_write_op *op = req->data;\n\tbool success = true;\n\tuint8_t *pdu;\n\n\tpdu = malloc(op->cur_length + 4);\n\tif (!pdu) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tput_le16(op->value_handle, pdu);\n\tput_le16(op->offset + op->index, pdu + 2);\n\tmemcpy(pdu + 4, op->value + op->index, op->cur_length);\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\t\tpdu, op->cur_length + 4,\n\t\t\t\t\t\t\tprepare_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\trequest_unref(req);\n\t\tsuccess = false;\n\t}\n\n\tfree(pdu);\n\n\t/* If so far successful, then the operation should continue.\n\t * Otherwise, there was an error and the procedure should be\n\t * completed.\n\t */\n\tif (success)\n\t\treturn;\n\ndone:\n\tcomplete_write_long_op(req, success, 0, false);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "client->long_write_queue"
          ],
          "line": 2759
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_isempty",
          "args": [
            "client->long_write_queue"
          ],
          "line": 2754
        },
        "resolved": true,
        "details": {
          "function_name": "queue_isempty",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "380-386",
          "snippet": "bool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void start_next_long_write(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (queue_isempty(client->long_write_queue)) {\n\t\tclient->in_long_write = false;\n\t\treturn;\n\t}\n\n\treq  = queue_pop_head(client->long_write_queue);\n\tif (!req)\n\t\treturn;\n\n\thandle_next_prep_write(req);\n\n\t/*\n\t * send_next_prep_write adds an extra ref. Unref here to clean up if\n\t * necessary, since we also added a ref before pushing to the queue.\n\t */\n\trequest_unref(req);\n}"
  },
  {
    "function_name": "handle_next_prep_write",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2711-2748",
    "snippet": "static void handle_next_prep_write(struct request *req)\n{\n\tstruct long_write_op *op = req->data;\n\tbool success = true;\n\tuint8_t *pdu;\n\n\tpdu = malloc(op->cur_length + 4);\n\tif (!pdu) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tput_le16(op->value_handle, pdu);\n\tput_le16(op->offset + op->index, pdu + 2);\n\tmemcpy(pdu + 4, op->value + op->index, op->cur_length);\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\t\tpdu, op->cur_length + 4,\n\t\t\t\t\t\t\tprepare_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\trequest_unref(req);\n\t\tsuccess = false;\n\t}\n\n\tfree(pdu);\n\n\t/* If so far successful, then the operation should continue.\n\t * Otherwise, there was an error and the procedure should be\n\t * completed.\n\t */\n\tif (success)\n\t\treturn;\n\ndone:\n\tcomplete_write_long_op(req, success, 0, false);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "complete_write_long_op",
          "args": [
            "req",
            "success",
            "0",
            "false"
          ],
          "line": 2747
        },
        "resolved": true,
        "details": {
          "function_name": "complete_write_long_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2797-2831",
          "snippet": "static void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error)\n{\n\tstruct long_write_op *op = req->data;\n\tuint8_t pdu;\n\n\top->success = success;\n\top->att_ecode = att_ecode;\n\top->reliable_error = reliable_error;\n\n\tif (success)\n\t\tpdu = 0x01;  /* Write */\n\telse\n\t\tpdu = 0x00;  /* Cancel */\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t&pdu, sizeof(pdu),\n\t\t\t\t\t\t\texecute_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (req->att_id)\n\t\treturn;\n\n\trequest_unref(req);\n\tsuccess = false;\n\n\tbt_gatt_client_ref(op->client);\n\n\tif (op->callback)\n\t\top->callback(success, reliable_error, att_ecode, op->user_data);\n\n\tstart_next_long_write(op->client);\n\n\tbt_gatt_client_unref(op->client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);",
            "static void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\nstatic void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error);\n\nstatic void complete_write_long_op(struct request *req, bool success,\n\t\t\t\t\tuint8_t att_ecode, bool reliable_error)\n{\n\tstruct long_write_op *op = req->data;\n\tuint8_t pdu;\n\n\top->success = success;\n\top->att_ecode = att_ecode;\n\top->reliable_error = reliable_error;\n\n\tif (success)\n\t\tpdu = 0x01;  /* Write */\n\telse\n\t\tpdu = 0x00;  /* Cancel */\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t&pdu, sizeof(pdu),\n\t\t\t\t\t\t\texecute_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (req->att_id)\n\t\treturn;\n\n\trequest_unref(req);\n\tsuccess = false;\n\n\tbt_gatt_client_ref(op->client);\n\n\tif (op->callback)\n\t\top->callback(success, reliable_error, att_ecode, op->user_data);\n\n\tstart_next_long_write(op->client);\n\n\tbt_gatt_client_unref(op->client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "pdu"
          ],
          "line": 2737
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 2733
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->client->att",
            "BT_ATT_OP_PREP_WRITE_REQ",
            "pdu",
            "op->cur_length + 4",
            "prepare_write_cb",
            "request_ref(req)",
            "request_unref"
          ],
          "line": 2727
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_ref",
          "args": [
            "req"
          ],
          "line": 2730
        },
        "resolved": true,
        "details": {
          "function_name": "request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "133-138",
          "snippet": "static struct request *request_ref(struct request *req)\n{\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_ref(struct request *req)\n{\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "pdu + 4",
            "op->value + op->index",
            "op->cur_length"
          ],
          "line": 2725
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "op->offset + op->index",
            "pdu + 2"
          ],
          "line": 2724
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "op->cur_length + 4"
          ],
          "line": 2717
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void handle_next_prep_write(struct request *req)\n{\n\tstruct long_write_op *op = req->data;\n\tbool success = true;\n\tuint8_t *pdu;\n\n\tpdu = malloc(op->cur_length + 4);\n\tif (!pdu) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tput_le16(op->value_handle, pdu);\n\tput_le16(op->offset + op->index, pdu + 2);\n\tmemcpy(pdu + 4, op->value + op->index, op->cur_length);\n\n\treq->att_id = bt_att_send(op->client->att, BT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\t\tpdu, op->cur_length + 4,\n\t\t\t\t\t\t\tprepare_write_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\trequest_unref(req);\n\t\tsuccess = false;\n\t}\n\n\tfree(pdu);\n\n\t/* If so far successful, then the operation should continue.\n\t * Otherwise, there was an error and the procedure should be\n\t * completed.\n\t */\n\tif (success)\n\t\treturn;\n\ndone:\n\tcomplete_write_long_op(req, success, 0, false);\n}"
  },
  {
    "function_name": "long_write_op_free",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2695-2704",
    "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 2703
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "note": "cyclic_reference_detected"
        }
      },
      {
        "call_info": {
          "callee": "op->destroy",
          "args": [
            "op->user_data"
          ],
          "line": 2700
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
  },
  {
    "function_name": "bt_gatt_client_write_value",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2633-2676",
    "snippet": "unsigned int bt_gatt_client_write_value(struct bt_gatt_client *client,\n\t\t\t\t\tuint16_t value_handle,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tbt_gatt_client_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct write_op *op;\n\tuint8_t pdu[2 + length];\n\n\tif (!client)\n\t\treturn 0;\n\n\top = new0(struct write_op, 1);\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = destroy_write_op;\n\n\tput_le16(value_handle, pdu);\n\tmemcpy(pdu + 2, value, length);\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\t\twrite_cb, req,\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 2671
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "BT_ATT_OP_WRITE_REQ",
            "pdu",
            "sizeof(pdu)",
            "write_cb",
            "req",
            "request_unref"
          ],
          "line": 2665
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "pdu + 2",
            "value",
            "length"
          ],
          "line": 2663
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "value_handle",
            "pdu"
          ],
          "line": 2662
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 2651
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_create",
          "args": [
            "client"
          ],
          "line": 2649
        },
        "resolved": true,
        "details": {
          "function_name": "request_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "140-157",
          "snippet": "static struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structwrite_op",
            "1"
          ],
          "line": 2647
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_write_value(struct bt_gatt_client *client,\n\t\t\t\t\tuint16_t value_handle,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tbt_gatt_client_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct write_op *op;\n\tuint8_t pdu[2 + length];\n\n\tif (!client)\n\t\treturn 0;\n\n\top = new0(struct write_op, 1);\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = destroy_write_op;\n\n\tput_le16(value_handle, pdu);\n\tmemcpy(pdu + 2, value, length);\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\t\twrite_cb, req,\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}"
  },
  {
    "function_name": "write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2611-2631",
    "snippet": "static void write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct write_op *op = req->data;\n\tbool success = true;\n\tuint8_t att_ecode = 0;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_WRITE_RSP || pdu || length)\n\t\tsuccess = false;\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, att_ecode, op->user_data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "success",
            "att_ecode",
            "op->user_data"
          ],
          "line": 2630
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 2621
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1357-1367",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct write_op *op = req->data;\n\tbool success = true;\n\tuint8_t att_ecode = 0;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_WRITE_RSP || pdu || length)\n\t\tsuccess = false;\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, att_ecode, op->user_data);\n}"
  },
  {
    "function_name": "destroy_write_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2601-2609",
    "snippet": "static void destroy_write_op(void *data)\n{\n\tstruct write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 2608
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->destroy",
          "args": [
            "op->user_data"
          ],
          "line": 2606
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void destroy_write_op(void *data)\n{\n\tstruct write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op);\n}"
  },
  {
    "function_name": "bt_gatt_client_write_without_response",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2556-2592",
    "snippet": "unsigned int bt_gatt_client_write_without_response(\n\t\t\t\t\tstruct bt_gatt_client *client,\n\t\t\t\t\tuint16_t value_handle,\n\t\t\t\t\tbool signed_write,\n\t\t\t\t\tconst uint8_t *value, uint16_t length) {\n\tuint8_t pdu[2 + length];\n\tstruct request *req;\n\tint security;\n\tuint8_t op;\n\n\tif (!client)\n\t\treturn 0;\n\n\treq = request_create(client);\n\tif (!req)\n\t\treturn 0;\n\n\t/* Only use signed write if unencrypted */\n\tif (signed_write) {\n\t\tsecurity = bt_att_get_security(client->att, NULL);\n\t\top = security > BT_SECURITY_LOW ?  BT_ATT_OP_WRITE_CMD :\n\t\t\t\t\t\tBT_ATT_OP_SIGNED_WRITE_CMD;\n\t} else\n\t\top = BT_ATT_OP_WRITE_CMD;\n\n\tput_le16(value_handle, pdu);\n\tmemcpy(pdu + 2, value, length);\n\n\treq->att_id = bt_att_send(client->att, op, pdu, sizeof(pdu), NULL, req,\n\t\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 2587
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "op",
            "pdu",
            "sizeof(pdu)",
            "NULL",
            "req",
            "request_unref"
          ],
          "line": 2584
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "pdu + 2",
            "value",
            "length"
          ],
          "line": 2582
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "value_handle",
            "pdu"
          ],
          "line": 2581
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_security",
          "args": [
            "client->att",
            "NULL"
          ],
          "line": 2575
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_security",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1458-1482",
          "snippet": "int bt_att_get_security(struct bt_att *att, uint8_t *enc_size)\n{\n\tstruct bt_security sec;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap) {\n\t\tif (enc_size)\n\t\t\t*enc_size = att->enc_size;\n\n\t\treturn att->io_sec_level;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tlen = sizeof(sec);\n\tif (getsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec, &len) < 0)\n\t\treturn -EIO;\n\n\tif (enc_size)\n\t\t*enc_size = att->enc_size;\n\n\treturn sec.level;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nint bt_att_get_security(struct bt_att *att, uint8_t *enc_size)\n{\n\tstruct bt_security sec;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap) {\n\t\tif (enc_size)\n\t\t\t*enc_size = att->enc_size;\n\n\t\treturn att->io_sec_level;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tlen = sizeof(sec);\n\tif (getsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec, &len) < 0)\n\t\treturn -EIO;\n\n\tif (enc_size)\n\t\t*enc_size = att->enc_size;\n\n\treturn sec.level;\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_create",
          "args": [
            "client"
          ],
          "line": 2569
        },
        "resolved": true,
        "details": {
          "function_name": "request_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "140-157",
          "snippet": "static struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nunsigned int bt_gatt_client_write_without_response(\n\t\t\t\t\tstruct bt_gatt_client *client,\n\t\t\t\t\tuint16_t value_handle,\n\t\t\t\t\tbool signed_write,\n\t\t\t\t\tconst uint8_t *value, uint16_t length) {\n\tuint8_t pdu[2 + length];\n\tstruct request *req;\n\tint security;\n\tuint8_t op;\n\n\tif (!client)\n\t\treturn 0;\n\n\treq = request_create(client);\n\tif (!req)\n\t\treturn 0;\n\n\t/* Only use signed write if unencrypted */\n\tif (signed_write) {\n\t\tsecurity = bt_att_get_security(client->att, NULL);\n\t\top = security > BT_SECURITY_LOW ?  BT_ATT_OP_WRITE_CMD :\n\t\t\t\t\t\tBT_ATT_OP_SIGNED_WRITE_CMD;\n\t} else\n\t\top = BT_ATT_OP_WRITE_CMD;\n\n\tput_le16(value_handle, pdu);\n\tmemcpy(pdu + 2, value, length);\n\n\treq->att_id = bt_att_send(client->att, op, pdu, sizeof(pdu), NULL, req,\n\t\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}"
  },
  {
    "function_name": "bt_gatt_client_read_long_value",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2487-2554",
    "snippet": "unsigned int bt_gatt_client_read_long_value(struct bt_gatt_client *client,\n\t\t\t\t\tuint16_t value_handle, uint16_t offset,\n\t\t\t\t\tbt_gatt_client_read_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct read_long_op *op;\n\tuint8_t att_op;\n\tuint8_t pdu[4];\n\tuint16_t pdu_len;\n\n\tif (!client)\n\t\treturn 0;\n\n\top = new0(struct read_long_op, 1);\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->client = client;\n\top->value_handle = value_handle;\n\top->offset = offset;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = destroy_read_long_op;\n\n\tput_le16(value_handle, pdu);\n\tpdu_len = sizeof(value_handle);\n\n\t/*\n\t * Core v4.2, part F, section 1.3.4.4.5:\n\t * If the attribute value has a fixed length that is less than or equal\n\t * to (ATT_MTU - 3) octets in length, then an Error Response can be sent\n\t * with the error code Attribute Not Long.\n\t *\n\t * To remove need for caller to handle \"Attribute Not Long\" error when\n\t * reading characteristics with short values, use Read Request for\n\t * reading first part of characteristics value instead of Read Blob\n\t * Request. Both are allowed in this case.\n\t */\n\n\tif (op->offset) {\n\t\tatt_op = BT_ATT_OP_READ_BLOB_REQ;\n\t\tpdu_len += sizeof(op->offset);\n\n\t\tput_le16(op->offset, pdu + 2);\n\t} else {\n\t\tatt_op = BT_ATT_OP_READ_REQ;\n\t}\n\n\treq->att_id = bt_att_send(client->att, att_op, pdu, pdu_len,\n\t\t\t\t\tread_long_cb, req, request_unref);\n\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 2549
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "att_op",
            "pdu",
            "pdu_len",
            "read_long_cb",
            "req",
            "request_unref"
          ],
          "line": 2544
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "op->offset",
            "pdu + 2"
          ],
          "line": 2539
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 2506
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_create",
          "args": [
            "client"
          ],
          "line": 2504
        },
        "resolved": true,
        "details": {
          "function_name": "request_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "140-157",
          "snippet": "static struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structread_long_op",
            "1"
          ],
          "line": 2502
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_read_long_value(struct bt_gatt_client *client,\n\t\t\t\t\tuint16_t value_handle, uint16_t offset,\n\t\t\t\t\tbt_gatt_client_read_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct read_long_op *op;\n\tuint8_t att_op;\n\tuint8_t pdu[4];\n\tuint16_t pdu_len;\n\n\tif (!client)\n\t\treturn 0;\n\n\top = new0(struct read_long_op, 1);\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->client = client;\n\top->value_handle = value_handle;\n\top->offset = offset;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = destroy_read_long_op;\n\n\tput_le16(value_handle, pdu);\n\tpdu_len = sizeof(value_handle);\n\n\t/*\n\t * Core v4.2, part F, section 1.3.4.4.5:\n\t * If the attribute value has a fixed length that is less than or equal\n\t * to (ATT_MTU - 3) octets in length, then an Error Response can be sent\n\t * with the error code Attribute Not Long.\n\t *\n\t * To remove need for caller to handle \"Attribute Not Long\" error when\n\t * reading characteristics with short values, use Read Request for\n\t * reading first part of characteristics value instead of Read Blob\n\t * Request. Both are allowed in this case.\n\t */\n\n\tif (op->offset) {\n\t\tatt_op = BT_ATT_OP_READ_BLOB_REQ;\n\t\tpdu_len += sizeof(op->offset);\n\n\t\tput_le16(op->offset, pdu + 2);\n\t} else {\n\t\tatt_op = BT_ATT_OP_READ_REQ;\n\t}\n\n\treq->att_id = bt_att_send(client->att, att_op, pdu, pdu_len,\n\t\t\t\t\tread_long_cb, req, request_unref);\n\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}"
  },
  {
    "function_name": "read_long_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2426-2485",
    "snippet": "static void read_long_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct read_long_op *op = req->data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif ((!op->offset && opcode != BT_ATT_OP_READ_RSP)\n\t\t\t|| (op->offset && opcode != BT_ATT_OP_READ_BLOB_RSP)\n\t\t\t|| (!pdu && length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (!length)\n\t\tgoto success;\n\n\tif (!append_chunk(op, pdu, length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (op->offset >= BT_ATT_MAX_VALUE_LEN)\n\t\tgoto success;\n\n\tif (length >= bt_att_get_mtu(op->client->att) - 1) {\n\t\tuint8_t pdu[4];\n\n\t\tput_le16(op->value_handle, pdu);\n\t\tput_le16(op->offset, pdu + 2);\n\n\t\treq->att_id = bt_att_send(op->client->att,\n\t\t\t\t\t\t\tBT_ATT_OP_READ_BLOB_REQ,\n\t\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_long_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\t\tif (req->att_id)\n\t\t\treturn;\n\n\t\trequest_unref(req);\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\nsuccess:\n\tsuccess = true;\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, att_ecode, op->iov.iov_base,\n\t\t\t\t\t\top->iov.iov_len, op->user_data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "success",
            "att_ecode",
            "op->iov.iov_base",
            "op->iov.iov_len",
            "op->user_data"
          ],
          "line": 2483
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 2473
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "op->client->att",
            "BT_ATT_OP_READ_BLOB_REQ",
            "pdu",
            "sizeof(pdu)",
            "read_long_cb",
            "request_ref(req)",
            "request_unref"
          ],
          "line": 2464
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_ref",
          "args": [
            "req"
          ],
          "line": 2468
        },
        "resolved": true,
        "details": {
          "function_name": "request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "133-138",
          "snippet": "static struct request *request_ref(struct request *req)\n{\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_ref(struct request *req)\n{\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "op->offset",
            "pdu + 2"
          ],
          "line": 2462
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "op->client->att"
          ],
          "line": 2458
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      },
      {
        "call_info": {
          "callee": "append_chunk",
          "args": [
            "op",
            "pdu",
            "length"
          ],
          "line": 2450
        },
        "resolved": true,
        "details": {
          "function_name": "append_chunk",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2403-2424",
          "snippet": "static bool append_chunk(struct read_long_op *op, const uint8_t *data,\n\t\t\t\t\t\t\t\tuint16_t len)\n{\n\tvoid *buf;\n\n\t/* Truncate if the data would exceed maximum length */\n\tif (op->offset + len > BT_ATT_MAX_VALUE_LEN)\n\t\tlen = BT_ATT_MAX_VALUE_LEN - op->offset;\n\n\tbuf = realloc(op->iov.iov_base, op->iov.iov_len + len);\n\tif (!buf)\n\t\treturn false;\n\n\top->iov.iov_base = buf;\n\n\tmemcpy(op->iov.iov_base + op->iov.iov_len, data, len);\n\n\top->iov.iov_len += len;\n\top->offset += len;\n\n\treturn true;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool append_chunk(struct read_long_op *op, const uint8_t *data,\n\t\t\t\t\t\t\t\tuint16_t len)\n{\n\tvoid *buf;\n\n\t/* Truncate if the data would exceed maximum length */\n\tif (op->offset + len > BT_ATT_MAX_VALUE_LEN)\n\t\tlen = BT_ATT_MAX_VALUE_LEN - op->offset;\n\n\tbuf = realloc(op->iov.iov_base, op->iov.iov_len + len);\n\tif (!buf)\n\t\treturn false;\n\n\top->iov.iov_base = buf;\n\n\tmemcpy(op->iov.iov_base + op->iov.iov_len, data, len);\n\n\top->iov.iov_len += len;\n\top->offset += len;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 2436
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1357-1367",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void read_long_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct read_long_op *op = req->data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif ((!op->offset && opcode != BT_ATT_OP_READ_RSP)\n\t\t\t|| (op->offset && opcode != BT_ATT_OP_READ_BLOB_RSP)\n\t\t\t|| (!pdu && length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (!length)\n\t\tgoto success;\n\n\tif (!append_chunk(op, pdu, length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tif (op->offset >= BT_ATT_MAX_VALUE_LEN)\n\t\tgoto success;\n\n\tif (length >= bt_att_get_mtu(op->client->att) - 1) {\n\t\tuint8_t pdu[4];\n\n\t\tput_le16(op->value_handle, pdu);\n\t\tput_le16(op->offset, pdu + 2);\n\n\t\treq->att_id = bt_att_send(op->client->att,\n\t\t\t\t\t\t\tBT_ATT_OP_READ_BLOB_REQ,\n\t\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_long_cb,\n\t\t\t\t\t\t\trequest_ref(req),\n\t\t\t\t\t\t\trequest_unref);\n\t\tif (req->att_id)\n\t\t\treturn;\n\n\t\trequest_unref(req);\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\nsuccess:\n\tsuccess = true;\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, att_ecode, op->iov.iov_base,\n\t\t\t\t\t\top->iov.iov_len, op->user_data);\n}"
  },
  {
    "function_name": "append_chunk",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2403-2424",
    "snippet": "static bool append_chunk(struct read_long_op *op, const uint8_t *data,\n\t\t\t\t\t\t\t\tuint16_t len)\n{\n\tvoid *buf;\n\n\t/* Truncate if the data would exceed maximum length */\n\tif (op->offset + len > BT_ATT_MAX_VALUE_LEN)\n\t\tlen = BT_ATT_MAX_VALUE_LEN - op->offset;\n\n\tbuf = realloc(op->iov.iov_base, op->iov.iov_len + len);\n\tif (!buf)\n\t\treturn false;\n\n\top->iov.iov_base = buf;\n\n\tmemcpy(op->iov.iov_base + op->iov.iov_len, data, len);\n\n\top->iov.iov_len += len;\n\top->offset += len;\n\n\treturn true;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "op->iov.iov_base + op->iov.iov_len",
            "data",
            "len"
          ],
          "line": 2418
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "realloc",
          "args": [
            "op->iov.iov_base",
            "op->iov.iov_len + len"
          ],
          "line": 2412
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool append_chunk(struct read_long_op *op, const uint8_t *data,\n\t\t\t\t\t\t\t\tuint16_t len)\n{\n\tvoid *buf;\n\n\t/* Truncate if the data would exceed maximum length */\n\tif (op->offset + len > BT_ATT_MAX_VALUE_LEN)\n\t\tlen = BT_ATT_MAX_VALUE_LEN - op->offset;\n\n\tbuf = realloc(op->iov.iov_base, op->iov.iov_len + len);\n\tif (!buf)\n\t\treturn false;\n\n\top->iov.iov_base = buf;\n\n\tmemcpy(op->iov.iov_base + op->iov.iov_len, data, len);\n\n\top->iov.iov_len += len;\n\top->offset += len;\n\n\treturn true;\n}"
  },
  {
    "function_name": "destroy_read_long_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2392-2401",
    "snippet": "static void destroy_read_long_op(void *data)\n{\n\tstruct read_long_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->iov.iov_base);\n\tfree(op);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 2400
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->destroy",
          "args": [
            "op->user_data"
          ],
          "line": 2397
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void destroy_read_long_op(void *data)\n{\n\tstruct read_long_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->iov.iov_base);\n\tfree(op);\n}"
  },
  {
    "function_name": "bt_gatt_client_read_multiple",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2330-2379",
    "snippet": "unsigned int bt_gatt_client_read_multiple(struct bt_gatt_client *client,\n\t\t\t\t\tuint16_t *handles, uint8_t num_handles,\n\t\t\t\t\tbt_gatt_client_read_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tuint8_t pdu[num_handles * 2];\n\tstruct request *req;\n\tstruct read_op *op;\n\tint i;\n\n\tif (!client)\n\t\treturn 0;\n\n\tif (num_handles < 2)\n\t\treturn 0;\n\n\tif (num_handles * 2 > bt_att_get_mtu(client->att) - 1)\n\t\treturn 0;\n\n\top = new0(struct read_op, 1);\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = destroy_read_op;\n\n\tfor (i = 0; i < num_handles; i++)\n\t\tput_le16(handles[i], pdu + (2 * i));\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_multiple_cb, req,\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 2374
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "BT_ATT_OP_READ_MULT_REQ",
            "pdu",
            "sizeof(pdu)",
            "read_multiple_cb",
            "req",
            "request_unref"
          ],
          "line": 2368
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "handles[i]",
            "pdu + (2 * i)"
          ],
          "line": 2366
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 2354
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_create",
          "args": [
            "client"
          ],
          "line": 2352
        },
        "resolved": true,
        "details": {
          "function_name": "request_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "140-157",
          "snippet": "static struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structread_op",
            "1"
          ],
          "line": 2350
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "client->att"
          ],
          "line": 2347
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_read_multiple(struct bt_gatt_client *client,\n\t\t\t\t\tuint16_t *handles, uint8_t num_handles,\n\t\t\t\t\tbt_gatt_client_read_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tuint8_t pdu[num_handles * 2];\n\tstruct request *req;\n\tstruct read_op *op;\n\tint i;\n\n\tif (!client)\n\t\treturn 0;\n\n\tif (num_handles < 2)\n\t\treturn 0;\n\n\tif (num_handles * 2 > bt_att_get_mtu(client->att) - 1)\n\t\treturn 0;\n\n\top = new0(struct read_op, 1);\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = destroy_read_op;\n\n\tfor (i = 0; i < num_handles; i++)\n\t\tput_le16(handles[i], pdu + (2 * i));\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_multiple_cb, req,\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}"
  },
  {
    "function_name": "read_multiple_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2303-2328",
    "snippet": "static void read_multiple_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct read_op *op = req->data;\n\tuint8_t att_ecode;\n\tbool success;\n\n\tif (opcode != BT_ATT_OP_READ_MULT_RSP || (!pdu && length)) {\n\t\tsuccess = false;\n\n\t\tif (opcode == BT_ATT_OP_ERROR_RSP)\n\t\t\tatt_ecode = process_error(pdu, length);\n\t\telse\n\t\t\tatt_ecode = 0;\n\n\t\tpdu = NULL;\n\t\tlength = 0;\n\t} else {\n\t\tsuccess = true;\n\t\tatt_ecode = 0;\n\t}\n\n\tif (op->callback)\n\t\top->callback(success, att_ecode, pdu, length, op->user_data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "success",
            "att_ecode",
            "pdu",
            "length",
            "op->user_data"
          ],
          "line": 2327
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 2315
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1357-1367",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void read_multiple_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct read_op *op = req->data;\n\tuint8_t att_ecode;\n\tbool success;\n\n\tif (opcode != BT_ATT_OP_READ_MULT_RSP || (!pdu && length)) {\n\t\tsuccess = false;\n\n\t\tif (opcode == BT_ATT_OP_ERROR_RSP)\n\t\t\tatt_ecode = process_error(pdu, length);\n\t\telse\n\t\t\tatt_ecode = 0;\n\n\t\tpdu = NULL;\n\t\tlength = 0;\n\t} else {\n\t\tsuccess = true;\n\t\tatt_ecode = 0;\n\t}\n\n\tif (op->callback)\n\t\top->callback(success, att_ecode, pdu, length, op->user_data);\n}"
  },
  {
    "function_name": "bt_gatt_client_read_value",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2260-2301",
    "snippet": "unsigned int bt_gatt_client_read_value(struct bt_gatt_client *client,\n\t\t\t\t\tuint16_t value_handle,\n\t\t\t\t\tbt_gatt_client_read_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct read_op *op;\n\tuint8_t pdu[2];\n\n\tif (!client)\n\t\treturn 0;\n\n\top = new0(struct read_op, 1);\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = destroy_read_op;\n\n\tput_le16(value_handle, pdu);\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_READ_REQ,\n\t\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_cb, req,\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "request_unref",
          "args": [
            "req"
          ],
          "line": 2296
        },
        "resolved": true,
        "details": {
          "function_name": "request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "159-173",
          "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "BT_ATT_OP_READ_REQ",
            "pdu",
            "sizeof(pdu)",
            "read_cb",
            "req",
            "request_unref"
          ],
          "line": 2290
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "value_handle",
            "pdu"
          ],
          "line": 2288
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 2277
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "request_create",
          "args": [
            "client"
          ],
          "line": 2275
        },
        "resolved": true,
        "details": {
          "function_name": "request_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "140-157",
          "snippet": "static struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structread_op",
            "1"
          ],
          "line": 2273
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_read_value(struct bt_gatt_client *client,\n\t\t\t\t\tuint16_t value_handle,\n\t\t\t\t\tbt_gatt_client_read_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct read_op *op;\n\tuint8_t pdu[2];\n\n\tif (!client)\n\t\treturn 0;\n\n\top = new0(struct read_op, 1);\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = destroy_read_op;\n\n\tput_le16(value_handle, pdu);\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_READ_REQ,\n\t\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_cb, req,\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}"
  },
  {
    "function_name": "read_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2229-2258",
    "snippet": "static void read_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct read_op *op = req->data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tconst uint8_t *value = NULL;\n\tuint16_t value_len = 0;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_READ_RSP || (!pdu && length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\tvalue_len = length;\n\tif (value_len)\n\t\tvalue = pdu;\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, att_ecode, value, length, op->user_data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "success",
            "att_ecode",
            "value",
            "length",
            "op->user_data"
          ],
          "line": 2257
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 2241
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1357-1367",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void read_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct read_op *op = req->data;\n\tbool success;\n\tuint8_t att_ecode = 0;\n\tconst uint8_t *value = NULL;\n\tuint16_t value_len = 0;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tsuccess = false;\n\t\tatt_ecode = process_error(pdu, length);\n\t\tgoto done;\n\t}\n\n\tif (opcode != BT_ATT_OP_READ_RSP || (!pdu && length)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tsuccess = true;\n\tvalue_len = length;\n\tif (value_len)\n\t\tvalue = pdu;\n\ndone:\n\tif (op->callback)\n\t\top->callback(success, att_ecode, value, length, op->user_data);\n}"
  },
  {
    "function_name": "destroy_read_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2219-2227",
    "snippet": "static void destroy_read_op(void *data)\n{\n\tstruct read_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 2226
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->destroy",
          "args": [
            "op->user_data"
          ],
          "line": 2224
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void destroy_read_op(void *data)\n{\n\tstruct read_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op);\n}"
  },
  {
    "function_name": "bt_gatt_client_cancel_all",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2194-2211",
    "snippet": "bool bt_gatt_client_cancel_all(struct bt_gatt_client *client)\n{\n\tif (!client || !client->att)\n\t\treturn false;\n\n\tqueue_remove_all(client->pending_requests, NULL, NULL, cancel_pending);\n\n\tif (client->discovery_req) {\n\t\tbt_gatt_request_cancel(client->discovery_req);\n\t\tbt_gatt_request_unref(client->discovery_req);\n\t\tclient->discovery_req = NULL;\n\t}\n\n\tif (client->mtu_req_id)\n\t\tbt_att_cancel(client->att, client->mtu_req_id);\n\n\treturn true;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_cancel",
          "args": [
            "client->att",
            "client->mtu_req_id"
          ],
          "line": 2208
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_cancel",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1291-1331",
          "snippet": "bool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_unref",
          "args": [
            "client->discovery_req"
          ],
          "line": 2203
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "583-599",
          "snippet": "void bt_gatt_request_unref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_request_cancel(req);\n\n\tif (req->destroy)\n\t\treq->destroy(req->user_data);\n\n\tresult_destroy(req->result_head);\n\n\tfree(req);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nvoid bt_gatt_request_unref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_request_cancel(req);\n\n\tif (req->destroy)\n\t\treq->destroy(req->user_data);\n\n\tresult_destroy(req->result_head);\n\n\tfree(req);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_request_cancel",
          "args": [
            "client->discovery_req"
          ],
          "line": 2202
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_cancel",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "601-611",
          "snippet": "void bt_gatt_request_cancel(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (!req->id)\n\t\treturn;\n\n\tbt_att_cancel(req->att, req->id);\n\treq->id = 0;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nvoid bt_gatt_request_cancel(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (!req->id)\n\t\treturn;\n\n\tbt_att_cancel(req->att, req->id);\n\treq->id = 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_all",
          "args": [
            "client->pending_requests",
            "NULL",
            "NULL",
            "cancel_pending"
          ],
          "line": 2199
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "318-362",
          "snippet": "unsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nbool bt_gatt_client_cancel_all(struct bt_gatt_client *client)\n{\n\tif (!client || !client->att)\n\t\treturn false;\n\n\tqueue_remove_all(client->pending_requests, NULL, NULL, cancel_pending);\n\n\tif (client->discovery_req) {\n\t\tbt_gatt_request_cancel(client->discovery_req);\n\t\tbt_gatt_request_unref(client->discovery_req);\n\t\tclient->discovery_req = NULL;\n\t}\n\n\tif (client->mtu_req_id)\n\t\tbt_att_cancel(client->att, client->mtu_req_id);\n\n\treturn true;\n}"
  },
  {
    "function_name": "cancel_pending",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2189-2192",
    "snippet": "static void cancel_pending(void *data)\n{\n\tcancel_request(data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "cancel_request",
          "args": [
            "data"
          ],
          "line": 2191
        },
        "resolved": true,
        "details": {
          "function_name": "cancel_request",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2161-2172",
          "snippet": "static bool cancel_request(struct request *req)\n{\n\treq->removed = true;\n\n\tif (req->long_write)\n\t\treturn cancel_long_write_req(req->client, req);\n\n\tif (req->prep_write)\n\t\treturn cancel_prep_write_session(req->client, req);\n\n\treturn bt_att_cancel(req->client->att, req->att_id);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool cancel_request(struct request *req)\n{\n\treq->removed = true;\n\n\tif (req->long_write)\n\t\treturn cancel_long_write_req(req->client, req);\n\n\tif (req->prep_write)\n\t\treturn cancel_prep_write_session(req->client, req);\n\n\treturn bt_att_cancel(req->client->att, req->att_id);\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void cancel_pending(void *data)\n{\n\tcancel_request(data);\n}"
  },
  {
    "function_name": "bt_gatt_client_cancel",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2174-2187",
    "snippet": "bool bt_gatt_client_cancel(struct bt_gatt_client *client, unsigned int id)\n{\n\tstruct request *req;\n\n\tif (!client || !id || !client->att)\n\t\treturn false;\n\n\treq = queue_remove_if(client->pending_requests, match_req_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!req)\n\t\treturn false;\n\n\treturn cancel_request(req);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "cancel_request",
          "args": [
            "req"
          ],
          "line": 2186
        },
        "resolved": true,
        "details": {
          "function_name": "cancel_request",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2161-2172",
          "snippet": "static bool cancel_request(struct request *req)\n{\n\treq->removed = true;\n\n\tif (req->long_write)\n\t\treturn cancel_long_write_req(req->client, req);\n\n\tif (req->prep_write)\n\t\treturn cancel_prep_write_session(req->client, req);\n\n\treturn bt_att_cancel(req->client->att, req->att_id);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool cancel_request(struct request *req)\n{\n\treq->removed = true;\n\n\tif (req->long_write)\n\t\treturn cancel_long_write_req(req->client, req);\n\n\tif (req->prep_write)\n\t\treturn cancel_prep_write_session(req->client, req);\n\n\treturn bt_att_cancel(req->client->att, req->att_id);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_if",
          "args": [
            "client->pending_requests",
            "match_req_id",
            "UINT_TO_PTR(id)"
          ],
          "line": 2181
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_if",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "278-316",
          "snippet": "void *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 2182
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nbool bt_gatt_client_cancel(struct bt_gatt_client *client, unsigned int id)\n{\n\tstruct request *req;\n\n\tif (!client || !id || !client->att)\n\t\treturn false;\n\n\treq = queue_remove_if(client->pending_requests, match_req_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!req)\n\t\treturn false;\n\n\treturn cancel_request(req);\n}"
  },
  {
    "function_name": "cancel_request",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2161-2172",
    "snippet": "static bool cancel_request(struct request *req)\n{\n\treq->removed = true;\n\n\tif (req->long_write)\n\t\treturn cancel_long_write_req(req->client, req);\n\n\tif (req->prep_write)\n\t\treturn cancel_prep_write_session(req->client, req);\n\n\treturn bt_att_cancel(req->client->att, req->att_id);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_cancel",
          "args": [
            "req->client->att",
            "req->att_id"
          ],
          "line": 2171
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_cancel",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1291-1331",
          "snippet": "bool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "cancel_prep_write_session",
          "args": [
            "req->client",
            "req"
          ],
          "line": 2169
        },
        "resolved": true,
        "details": {
          "function_name": "cancel_prep_write_session",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2150-2159",
          "snippet": "static bool cancel_prep_write_session(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tstruct request *req)\n{\n\tuint8_t pdu = 0x00;\n\n\treturn !!bt_att_send(client->att, BT_ATT_OP_EXEC_WRITE_REQ, &pdu,\n\t\t\t\t\t\t\tsizeof(pdu),\n\t\t\t\t\t\t\tcancel_prep_write_cb,\n\t\t\t\t\t\t\treq, request_unref);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool cancel_prep_write_session(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tstruct request *req)\n{\n\tuint8_t pdu = 0x00;\n\n\treturn !!bt_att_send(client->att, BT_ATT_OP_EXEC_WRITE_REQ, &pdu,\n\t\t\t\t\t\t\tsizeof(pdu),\n\t\t\t\t\t\t\tcancel_prep_write_cb,\n\t\t\t\t\t\t\treq, request_unref);\n}"
        }
      },
      {
        "call_info": {
          "callee": "cancel_long_write_req",
          "args": [
            "req->client",
            "req"
          ],
          "line": 2166
        },
        "resolved": true,
        "details": {
          "function_name": "cancel_long_write_req",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2121-2139",
          "snippet": "static bool cancel_long_write_req(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tstruct request *req)\n{\n\tuint8_t pdu = 0x00;\n\n\t/*\n\t * att_id == 0 means that request has been queued and no prepare write\n\t * has been sent so far.Let's just remove if from the queue.\n\t * Otherwise execute write needs to be send.\n\t */\n\tif (!req->att_id)\n\t\treturn queue_remove(client->long_write_queue, req);\n\n\treturn !!bt_att_send(client->att, BT_ATT_OP_EXEC_WRITE_REQ, &pdu,\n\t\t\t\t\t\t\tsizeof(pdu),\n\t\t\t\t\t\t\tcancel_long_write_cb,\n\t\t\t\t\t\t\tclient, NULL);\n\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool cancel_long_write_req(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tstruct request *req)\n{\n\tuint8_t pdu = 0x00;\n\n\t/*\n\t * att_id == 0 means that request has been queued and no prepare write\n\t * has been sent so far.Let's just remove if from the queue.\n\t * Otherwise execute write needs to be send.\n\t */\n\tif (!req->att_id)\n\t\treturn queue_remove(client->long_write_queue, req);\n\n\treturn !!bt_att_send(client->att, BT_ATT_OP_EXEC_WRITE_REQ, &pdu,\n\t\t\t\t\t\t\tsizeof(pdu),\n\t\t\t\t\t\t\tcancel_long_write_cb,\n\t\t\t\t\t\t\tclient, NULL);\n\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool cancel_request(struct request *req)\n{\n\treq->removed = true;\n\n\tif (req->long_write)\n\t\treturn cancel_long_write_req(req->client, req);\n\n\tif (req->prep_write)\n\t\treturn cancel_prep_write_session(req->client, req);\n\n\treturn bt_att_cancel(req->client->att, req->att_id);\n}"
  },
  {
    "function_name": "cancel_prep_write_session",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2150-2159",
    "snippet": "static bool cancel_prep_write_session(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tstruct request *req)\n{\n\tuint8_t pdu = 0x00;\n\n\treturn !!bt_att_send(client->att, BT_ATT_OP_EXEC_WRITE_REQ, &pdu,\n\t\t\t\t\t\t\tsizeof(pdu),\n\t\t\t\t\t\t\tcancel_prep_write_cb,\n\t\t\t\t\t\t\treq, request_unref);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "BT_ATT_OP_EXEC_WRITE_REQ",
            "&pdu",
            "sizeof(pdu)",
            "cancel_prep_write_cb",
            "req",
            "request_unref"
          ],
          "line": 2155
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool cancel_prep_write_session(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tstruct request *req)\n{\n\tuint8_t pdu = 0x00;\n\n\treturn !!bt_att_send(client->att, BT_ATT_OP_EXEC_WRITE_REQ, &pdu,\n\t\t\t\t\t\t\tsizeof(pdu),\n\t\t\t\t\t\t\tcancel_prep_write_cb,\n\t\t\t\t\t\t\treq, request_unref);\n}"
  },
  {
    "function_name": "cancel_prep_write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2141-2148",
    "snippet": "static void cancel_prep_write_cb(uint8_t opcode, const void *pdu, uint16_t len,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct bt_gatt_client *client = req->client;\n\n\tclient->reliable_write_session_id = 0;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void cancel_prep_write_cb(uint8_t opcode, const void *pdu, uint16_t len,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct request *req = user_data;\n\tstruct bt_gatt_client *client = req->client;\n\n\tclient->reliable_write_session_id = 0;\n}"
  },
  {
    "function_name": "cancel_long_write_req",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2121-2139",
    "snippet": "static bool cancel_long_write_req(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tstruct request *req)\n{\n\tuint8_t pdu = 0x00;\n\n\t/*\n\t * att_id == 0 means that request has been queued and no prepare write\n\t * has been sent so far.Let's just remove if from the queue.\n\t * Otherwise execute write needs to be send.\n\t */\n\tif (!req->att_id)\n\t\treturn queue_remove(client->long_write_queue, req);\n\n\treturn !!bt_att_send(client->att, BT_ATT_OP_EXEC_WRITE_REQ, &pdu,\n\t\t\t\t\t\t\tsizeof(pdu),\n\t\t\t\t\t\t\tcancel_long_write_cb,\n\t\t\t\t\t\t\tclient, NULL);\n\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "BT_ATT_OP_EXEC_WRITE_REQ",
            "&pdu",
            "sizeof(pdu)",
            "cancel_long_write_cb",
            "client",
            "NULL"
          ],
          "line": 2134
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "client->long_write_queue",
            "req"
          ],
          "line": 2132
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool cancel_long_write_req(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tstruct request *req)\n{\n\tuint8_t pdu = 0x00;\n\n\t/*\n\t * att_id == 0 means that request has been queued and no prepare write\n\t * has been sent so far.Let's just remove if from the queue.\n\t * Otherwise execute write needs to be send.\n\t */\n\tif (!req->att_id)\n\t\treturn queue_remove(client->long_write_queue, req);\n\n\treturn !!bt_att_send(client->att, BT_ATT_OP_EXEC_WRITE_REQ, &pdu,\n\t\t\t\t\t\t\tsizeof(pdu),\n\t\t\t\t\t\t\tcancel_long_write_cb,\n\t\t\t\t\t\t\tclient, NULL);\n\n}"
  },
  {
    "function_name": "cancel_long_write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2112-2119",
    "snippet": "static void cancel_long_write_cb(uint8_t opcode, const void *pdu, uint16_t len,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct bt_gatt_client *client = user_data;\n\n\tif (queue_isempty(client->long_write_queue))\n\t\tclient->in_long_write = false;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_isempty",
          "args": [
            "client->long_write_queue"
          ],
          "line": 2117
        },
        "resolved": true,
        "details": {
          "function_name": "queue_isempty",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "380-386",
          "snippet": "bool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void cancel_long_write_cb(uint8_t opcode, const void *pdu, uint16_t len,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct bt_gatt_client *client = user_data;\n\n\tif (queue_isempty(client->long_write_queue))\n\t\tclient->in_long_write = false;\n}"
  },
  {
    "function_name": "match_req_id",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2104-2110",
    "snippet": "static bool match_req_id(const void *a, const void *b)\n{\n\tconst struct request *req = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn req->id == id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "PTR_TO_UINT",
          "args": [
            "b"
          ],
          "line": 2107
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool match_req_id(const void *a, const void *b)\n{\n\tconst struct request *req = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn req->id == id;\n}"
  },
  {
    "function_name": "bt_gatt_client_get_db",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2096-2102",
    "snippet": "struct gatt_db *bt_gatt_client_get_db(struct bt_gatt_client *client)\n{\n\tif (!client || !client->db)\n\t\treturn NULL;\n\n\treturn client->db;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct gatt_db *bt_gatt_client_get_db(struct bt_gatt_client *client)\n{\n\tif (!client || !client->db)\n\t\treturn NULL;\n\n\treturn client->db;\n}"
  },
  {
    "function_name": "bt_gatt_client_get_mtu",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2088-2094",
    "snippet": "uint16_t bt_gatt_client_get_mtu(struct bt_gatt_client *client)\n{\n\tif (!client || !client->att)\n\t\treturn 0;\n\n\treturn bt_att_get_mtu(client->att);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "client->att"
          ],
          "line": 2093
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nuint16_t bt_gatt_client_get_mtu(struct bt_gatt_client *client)\n{\n\tif (!client || !client->att)\n\t\treturn 0;\n\n\treturn bt_att_get_mtu(client->att);\n}"
  },
  {
    "function_name": "bt_gatt_client_set_debug",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2071-2086",
    "snippet": "bool bt_gatt_client_set_debug(struct bt_gatt_client *client,\n\t\t\t\t\tbt_gatt_client_debug_func_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy) {\n\tif (!client)\n\t\treturn false;\n\n\tif (client->debug_destroy)\n\t\tclient->debug_destroy(client->debug_data);\n\n\tclient->debug_callback = callback;\n\tclient->debug_destroy = destroy;\n\tclient->debug_data = user_data;\n\n\treturn true;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "client->debug_destroy",
          "args": [
            "client->debug_data"
          ],
          "line": 2079
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nbool bt_gatt_client_set_debug(struct bt_gatt_client *client,\n\t\t\t\t\tbt_gatt_client_debug_func_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy) {\n\tif (!client)\n\t\treturn false;\n\n\tif (client->debug_destroy)\n\t\tclient->debug_destroy(client->debug_data);\n\n\tclient->debug_callback = callback;\n\tclient->debug_destroy = destroy;\n\tclient->debug_data = user_data;\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gatt_client_set_service_changed",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2053-2069",
    "snippet": "bool bt_gatt_client_set_service_changed(struct bt_gatt_client *client,\n\t\t\tbt_gatt_client_service_changed_callback_t callback,\n\t\t\tvoid *user_data,\n\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tif (!client)\n\t\treturn false;\n\n\tif (client->svc_chngd_destroy)\n\t\tclient->svc_chngd_destroy(client->svc_chngd_data);\n\n\tclient->svc_chngd_callback = callback;\n\tclient->svc_chngd_destroy = destroy;\n\tclient->svc_chngd_data = user_data;\n\n\treturn true;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "client->svc_chngd_destroy",
          "args": [
            "client->svc_chngd_data"
          ],
          "line": 2062
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nbool bt_gatt_client_set_service_changed(struct bt_gatt_client *client,\n\t\t\tbt_gatt_client_service_changed_callback_t callback,\n\t\t\tvoid *user_data,\n\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tif (!client)\n\t\treturn false;\n\n\tif (client->svc_chngd_destroy)\n\t\tclient->svc_chngd_destroy(client->svc_chngd_data);\n\n\tclient->svc_chngd_callback = callback;\n\tclient->svc_chngd_destroy = destroy;\n\tclient->svc_chngd_data = user_data;\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gatt_client_ready_unregister",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2040-2051",
    "snippet": "bool bt_gatt_client_ready_unregister(struct bt_gatt_client *client,\n\t\t\t\t\t\tunsigned int id)\n{\n\tstruct ready_cb *ready = UINT_TO_PTR(id);\n\n\tif (queue_remove(client->ready_cbs, ready)) {\n\t\tready_destroy(ready);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "ready_destroy",
          "args": [
            "ready"
          ],
          "line": 2046
        },
        "resolved": true,
        "details": {
          "function_name": "ready_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1211-1219",
          "snippet": "static void ready_destroy(void *data)\n{\n\tstruct ready_cb *ready = data;\n\n\tif (ready->destroy)\n\t\tready->destroy(ready->data);\n\n\tfree(ready);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void ready_destroy(void *data)\n{\n\tstruct ready_cb *ready = data;\n\n\tif (ready->destroy)\n\t\tready->destroy(ready->data);\n\n\tfree(ready);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "client->ready_cbs",
            "ready"
          ],
          "line": 2045
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 2043
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nbool bt_gatt_client_ready_unregister(struct bt_gatt_client *client,\n\t\t\t\t\t\tunsigned int id)\n{\n\tstruct ready_cb *ready = UINT_TO_PTR(id);\n\n\tif (queue_remove(client->ready_cbs, ready)) {\n\t\tready_destroy(ready);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
  },
  {
    "function_name": "bt_gatt_client_ready_register",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2020-2038",
    "snippet": "unsigned int bt_gatt_client_ready_register(struct bt_gatt_client *client,\n\t\t\t\t\tbt_gatt_client_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct ready_cb *ready;\n\n\tif (!client)\n\t\treturn 0;\n\n\tready = new0(struct ready_cb, 1);\n\tready->callback = callback;\n\tready->destroy = destroy;\n\tready->data = user_data;\n\n\tqueue_push_tail(client->ready_cbs, ready);\n\n\treturn PTR_TO_UINT(ready);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "PTR_TO_UINT",
          "args": [
            "ready"
          ],
          "line": 2037
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "client->ready_cbs",
            "ready"
          ],
          "line": 2035
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structready_cb",
            "1"
          ],
          "line": 2030
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_ready_register(struct bt_gatt_client *client,\n\t\t\t\t\tbt_gatt_client_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct ready_cb *ready;\n\n\tif (!client)\n\t\treturn 0;\n\n\tready = new0(struct ready_cb, 1);\n\tready->callback = callback;\n\tready->destroy = destroy;\n\tready->data = user_data;\n\n\tqueue_push_tail(client->ready_cbs, ready);\n\n\treturn PTR_TO_UINT(ready);\n}"
  },
  {
    "function_name": "bt_gatt_client_is_ready",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2015-2018",
    "snippet": "bool bt_gatt_client_is_ready(struct bt_gatt_client *client)\n{\n\treturn (client && client->ready);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nbool bt_gatt_client_is_ready(struct bt_gatt_client *client)\n{\n\treturn (client && client->ready);\n}"
  },
  {
    "function_name": "bt_gatt_client_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "2004-2013",
    "snippet": "void bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_client_free",
          "args": [
            "client"
          ],
          "line": 2012
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1859-1891",
          "snippet": "static void bt_gatt_client_free(struct bt_gatt_client *client)\n{\n\tbt_gatt_client_cancel_all(client);\n\n\tqueue_destroy(client->notify_list, notify_data_cleanup);\n\n\tqueue_destroy(client->ready_cbs, ready_destroy);\n\n\tif (client->debug_destroy)\n\t\tclient->debug_destroy(client->debug_data);\n\n\tif (client->att) {\n\t\tbt_att_unregister_disconnect(client->att, client->disc_id);\n\t\tbt_att_unregister(client->att, client->notify_id);\n\t\tbt_att_unregister(client->att, client->ind_id);\n\t\tbt_att_unref(client->att);\n\t}\n\n\tgatt_db_unref(client->db);\n\n\tqueue_destroy(client->clones, NULL);\n\tqueue_destroy(client->svc_chngd_queue, free);\n\tqueue_destroy(client->long_write_queue, request_unref);\n\tqueue_destroy(client->notify_chrcs, notify_chrc_free);\n\tqueue_destroy(client->pending_requests, request_unref);\n\n\tif (client->parent) {\n\t\tqueue_remove(client->parent->clones, client);\n\t\tbt_gatt_client_unref(client->parent);\n\t}\n\n\tfree(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void bt_gatt_client_free(struct bt_gatt_client *client)\n{\n\tbt_gatt_client_cancel_all(client);\n\n\tqueue_destroy(client->notify_list, notify_data_cleanup);\n\n\tqueue_destroy(client->ready_cbs, ready_destroy);\n\n\tif (client->debug_destroy)\n\t\tclient->debug_destroy(client->debug_data);\n\n\tif (client->att) {\n\t\tbt_att_unregister_disconnect(client->att, client->disc_id);\n\t\tbt_att_unregister(client->att, client->notify_id);\n\t\tbt_att_unregister(client->att, client->ind_id);\n\t\tbt_att_unref(client->att);\n\t}\n\n\tgatt_db_unref(client->db);\n\n\tqueue_destroy(client->clones, NULL);\n\tqueue_destroy(client->svc_chngd_queue, free);\n\tqueue_destroy(client->long_write_queue, request_unref);\n\tqueue_destroy(client->notify_chrcs, notify_chrc_free);\n\tqueue_destroy(client->pending_requests, request_unref);\n\n\tif (client->parent) {\n\t\tqueue_remove(client->parent->clones, client);\n\t\tbt_gatt_client_unref(client->parent);\n\t}\n\n\tfree(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&client->ref_count",
            "1"
          ],
          "line": 2009
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nvoid bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}"
  },
  {
    "function_name": "bt_gatt_client_ref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1994-2002",
    "snippet": "struct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&client->ref_count",
            "1"
          ],
          "line": 1999
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}"
  },
  {
    "function_name": "bt_gatt_client_clone",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1971-1992",
    "snippet": "struct bt_gatt_client *bt_gatt_client_clone(struct bt_gatt_client *client)\n{\n\tstruct bt_gatt_client *clone;\n\n\tif (!client)\n\t\treturn NULL;\n\n\tclone = gatt_client_new(client->db, client->att);\n\tif (!clone)\n\t\treturn NULL;\n\n\tqueue_push_tail(client->clones, clone);\n\n\t/*\n\t * Reference the parent since the clones depend on it to propagate\n\t * service changed and ready callbacks.\n\t */\n\tclone->parent = bt_gatt_client_ref(client);\n\tclone->ready = client->ready;\n\n\treturn bt_gatt_client_ref(clone);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_client_ref",
          "args": [
            "clone"
          ],
          "line": 1991
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1994-2002",
          "snippet": "struct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "client->clones",
            "clone"
          ],
          "line": 1982
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_client_new",
          "args": [
            "client->db",
            "client->att"
          ],
          "line": 1978
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_client_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1910-1948",
          "snippet": "static struct bt_gatt_client *gatt_client_new(struct gatt_db *db,\n\t\t\t\t\t\t\tstruct bt_att *att)\n{\n\tstruct bt_gatt_client *client;\n\n\tclient = new0(struct bt_gatt_client, 1);\n\tclient->disc_id = bt_att_register_disconnect(att, att_disconnect_cb,\n\t\t\t\t\t\t\t\tclient, NULL);\n\tif (!client->disc_id)\n\t\tgoto fail;\n\n\tclient->clones = queue_new();\n\tclient->ready_cbs = queue_new();\n\tclient->long_write_queue = queue_new();\n\tclient->svc_chngd_queue = queue_new();\n\tclient->notify_list = queue_new();\n\tclient->notify_chrcs = queue_new();\n\tclient->pending_requests = queue_new();\n\n\tclient->notify_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_NOT,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->notify_id)\n\t\tgoto fail;\n\n\tclient->ind_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_IND,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->ind_id)\n\t\tgoto fail;\n\n\tclient->att = bt_att_ref(att);\n\tclient->db = gatt_db_ref(db);\n\n\treturn client;\n\nfail:\n\tbt_gatt_client_free(client);\n\treturn NULL;\n\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct bt_gatt_client *gatt_client_new(struct gatt_db *db,\n\t\t\t\t\t\t\tstruct bt_att *att)\n{\n\tstruct bt_gatt_client *client;\n\n\tclient = new0(struct bt_gatt_client, 1);\n\tclient->disc_id = bt_att_register_disconnect(att, att_disconnect_cb,\n\t\t\t\t\t\t\t\tclient, NULL);\n\tif (!client->disc_id)\n\t\tgoto fail;\n\n\tclient->clones = queue_new();\n\tclient->ready_cbs = queue_new();\n\tclient->long_write_queue = queue_new();\n\tclient->svc_chngd_queue = queue_new();\n\tclient->notify_list = queue_new();\n\tclient->notify_chrcs = queue_new();\n\tclient->pending_requests = queue_new();\n\n\tclient->notify_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_NOT,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->notify_id)\n\t\tgoto fail;\n\n\tclient->ind_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_IND,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->ind_id)\n\t\tgoto fail;\n\n\tclient->att = bt_att_ref(att);\n\tclient->db = gatt_db_ref(db);\n\n\treturn client;\n\nfail:\n\tbt_gatt_client_free(client);\n\treturn NULL;\n\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct bt_gatt_client *bt_gatt_client_clone(struct bt_gatt_client *client)\n{\n\tstruct bt_gatt_client *clone;\n\n\tif (!client)\n\t\treturn NULL;\n\n\tclone = gatt_client_new(client->db, client->att);\n\tif (!clone)\n\t\treturn NULL;\n\n\tqueue_push_tail(client->clones, clone);\n\n\t/*\n\t * Reference the parent since the clones depend on it to propagate\n\t * service changed and ready callbacks.\n\t */\n\tclone->parent = bt_gatt_client_ref(client);\n\tclone->ready = client->ready;\n\n\treturn bt_gatt_client_ref(clone);\n}"
  },
  {
    "function_name": "bt_gatt_client_new",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1950-1969",
    "snippet": "struct bt_gatt_client *bt_gatt_client_new(struct gatt_db *db,\n\t\t\t\t\t\t\tstruct bt_att *att,\n\t\t\t\t\t\t\tuint16_t mtu)\n{\n\tstruct bt_gatt_client *client;\n\n\tif (!att || !db)\n\t\treturn NULL;\n\n\tclient = gatt_client_new(db, att);\n\tif (!client)\n\t\treturn NULL;\n\n\tif (!gatt_client_init(client, mtu)) {\n\t\tbt_gatt_client_free(client);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_client_ref(client);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_client_ref",
          "args": [
            "client"
          ],
          "line": 1968
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1994-2002",
          "snippet": "struct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_client_free",
          "args": [
            "client"
          ],
          "line": 1964
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1859-1891",
          "snippet": "static void bt_gatt_client_free(struct bt_gatt_client *client)\n{\n\tbt_gatt_client_cancel_all(client);\n\n\tqueue_destroy(client->notify_list, notify_data_cleanup);\n\n\tqueue_destroy(client->ready_cbs, ready_destroy);\n\n\tif (client->debug_destroy)\n\t\tclient->debug_destroy(client->debug_data);\n\n\tif (client->att) {\n\t\tbt_att_unregister_disconnect(client->att, client->disc_id);\n\t\tbt_att_unregister(client->att, client->notify_id);\n\t\tbt_att_unregister(client->att, client->ind_id);\n\t\tbt_att_unref(client->att);\n\t}\n\n\tgatt_db_unref(client->db);\n\n\tqueue_destroy(client->clones, NULL);\n\tqueue_destroy(client->svc_chngd_queue, free);\n\tqueue_destroy(client->long_write_queue, request_unref);\n\tqueue_destroy(client->notify_chrcs, notify_chrc_free);\n\tqueue_destroy(client->pending_requests, request_unref);\n\n\tif (client->parent) {\n\t\tqueue_remove(client->parent->clones, client);\n\t\tbt_gatt_client_unref(client->parent);\n\t}\n\n\tfree(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void bt_gatt_client_free(struct bt_gatt_client *client)\n{\n\tbt_gatt_client_cancel_all(client);\n\n\tqueue_destroy(client->notify_list, notify_data_cleanup);\n\n\tqueue_destroy(client->ready_cbs, ready_destroy);\n\n\tif (client->debug_destroy)\n\t\tclient->debug_destroy(client->debug_data);\n\n\tif (client->att) {\n\t\tbt_att_unregister_disconnect(client->att, client->disc_id);\n\t\tbt_att_unregister(client->att, client->notify_id);\n\t\tbt_att_unregister(client->att, client->ind_id);\n\t\tbt_att_unref(client->att);\n\t}\n\n\tgatt_db_unref(client->db);\n\n\tqueue_destroy(client->clones, NULL);\n\tqueue_destroy(client->svc_chngd_queue, free);\n\tqueue_destroy(client->long_write_queue, request_unref);\n\tqueue_destroy(client->notify_chrcs, notify_chrc_free);\n\tqueue_destroy(client->pending_requests, request_unref);\n\n\tif (client->parent) {\n\t\tqueue_remove(client->parent->clones, client);\n\t\tbt_gatt_client_unref(client->parent);\n\t}\n\n\tfree(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_client_init",
          "args": [
            "client",
            "mtu"
          ],
          "line": 1963
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_client_init",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1707-1762",
          "snippet": "static bool gatt_client_init(struct bt_gatt_client *client, uint16_t mtu)\n{\n\tstruct discovery_op *op;\n\n\tif (client->in_init || client->ready)\n\t\treturn false;\n\n\top = discovery_op_create(client, 0x0001, 0xffff, init_complete, NULL);\n\tif (!op)\n\t\treturn false;\n\n\t/*\n\t * BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part G] page 546:\n\t *\n\t * 4.3.1 Exchange MTU\n\t *\n\t * This sub-procedure shall not be used on a BR/EDR physical link since\n\t * the MTU size is negotiated using L2CAP channel configuration\n\t * procedures.\n\t */\n\tif (bt_att_get_link_type(client->att) == BT_ATT_LINK_BREDR)\n\t\tgoto discover;\n\n\t/* Check if MTU needs to be send */\n\tmtu = MAX(BT_ATT_DEFAULT_LE_MTU, mtu);\n\tif (mtu == BT_ATT_DEFAULT_LE_MTU)\n\t\tgoto discover;\n\n\t/* Configure the MTU */\n\tclient->mtu_req_id = bt_gatt_exchange_mtu(client->att, mtu,\n\t\t\t\t\t\texchange_mtu_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (!client->mtu_req_id) {\n\t\tdiscovery_op_free(op);\n\t\treturn false;\n\t}\n\n\tclient->in_init = true;\n\n\treturn true;\n\ndiscover:\n\tclient->discovery_req = bt_gatt_discover_all_primary_services(\n\t\t\t\t\t\t\tclient->att, NULL,\n\t\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\tif (!client->discovery_req) {\n\t\tdiscovery_op_free(op);\n\t\treturn false;\n\t}\n\n\tclient->in_init = true;\n\treturn true;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool gatt_client_init(struct bt_gatt_client *client, uint16_t mtu)\n{\n\tstruct discovery_op *op;\n\n\tif (client->in_init || client->ready)\n\t\treturn false;\n\n\top = discovery_op_create(client, 0x0001, 0xffff, init_complete, NULL);\n\tif (!op)\n\t\treturn false;\n\n\t/*\n\t * BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part G] page 546:\n\t *\n\t * 4.3.1 Exchange MTU\n\t *\n\t * This sub-procedure shall not be used on a BR/EDR physical link since\n\t * the MTU size is negotiated using L2CAP channel configuration\n\t * procedures.\n\t */\n\tif (bt_att_get_link_type(client->att) == BT_ATT_LINK_BREDR)\n\t\tgoto discover;\n\n\t/* Check if MTU needs to be send */\n\tmtu = MAX(BT_ATT_DEFAULT_LE_MTU, mtu);\n\tif (mtu == BT_ATT_DEFAULT_LE_MTU)\n\t\tgoto discover;\n\n\t/* Configure the MTU */\n\tclient->mtu_req_id = bt_gatt_exchange_mtu(client->att, mtu,\n\t\t\t\t\t\texchange_mtu_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (!client->mtu_req_id) {\n\t\tdiscovery_op_free(op);\n\t\treturn false;\n\t}\n\n\tclient->in_init = true;\n\n\treturn true;\n\ndiscover:\n\tclient->discovery_req = bt_gatt_discover_all_primary_services(\n\t\t\t\t\t\t\tclient->att, NULL,\n\t\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\tif (!client->discovery_req) {\n\t\tdiscovery_op_free(op);\n\t\treturn false;\n\t}\n\n\tclient->in_init = true;\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_client_new",
          "args": [
            "db",
            "att"
          ],
          "line": 1959
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_client_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1910-1948",
          "snippet": "static struct bt_gatt_client *gatt_client_new(struct gatt_db *db,\n\t\t\t\t\t\t\tstruct bt_att *att)\n{\n\tstruct bt_gatt_client *client;\n\n\tclient = new0(struct bt_gatt_client, 1);\n\tclient->disc_id = bt_att_register_disconnect(att, att_disconnect_cb,\n\t\t\t\t\t\t\t\tclient, NULL);\n\tif (!client->disc_id)\n\t\tgoto fail;\n\n\tclient->clones = queue_new();\n\tclient->ready_cbs = queue_new();\n\tclient->long_write_queue = queue_new();\n\tclient->svc_chngd_queue = queue_new();\n\tclient->notify_list = queue_new();\n\tclient->notify_chrcs = queue_new();\n\tclient->pending_requests = queue_new();\n\n\tclient->notify_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_NOT,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->notify_id)\n\t\tgoto fail;\n\n\tclient->ind_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_IND,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->ind_id)\n\t\tgoto fail;\n\n\tclient->att = bt_att_ref(att);\n\tclient->db = gatt_db_ref(db);\n\n\treturn client;\n\nfail:\n\tbt_gatt_client_free(client);\n\treturn NULL;\n\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct bt_gatt_client *gatt_client_new(struct gatt_db *db,\n\t\t\t\t\t\t\tstruct bt_att *att)\n{\n\tstruct bt_gatt_client *client;\n\n\tclient = new0(struct bt_gatt_client, 1);\n\tclient->disc_id = bt_att_register_disconnect(att, att_disconnect_cb,\n\t\t\t\t\t\t\t\tclient, NULL);\n\tif (!client->disc_id)\n\t\tgoto fail;\n\n\tclient->clones = queue_new();\n\tclient->ready_cbs = queue_new();\n\tclient->long_write_queue = queue_new();\n\tclient->svc_chngd_queue = queue_new();\n\tclient->notify_list = queue_new();\n\tclient->notify_chrcs = queue_new();\n\tclient->pending_requests = queue_new();\n\n\tclient->notify_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_NOT,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->notify_id)\n\t\tgoto fail;\n\n\tclient->ind_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_IND,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->ind_id)\n\t\tgoto fail;\n\n\tclient->att = bt_att_ref(att);\n\tclient->db = gatt_db_ref(db);\n\n\treturn client;\n\nfail:\n\tbt_gatt_client_free(client);\n\treturn NULL;\n\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct bt_gatt_client *bt_gatt_client_new(struct gatt_db *db,\n\t\t\t\t\t\t\tstruct bt_att *att,\n\t\t\t\t\t\t\tuint16_t mtu)\n{\n\tstruct bt_gatt_client *client;\n\n\tif (!att || !db)\n\t\treturn NULL;\n\n\tclient = gatt_client_new(db, att);\n\tif (!client)\n\t\treturn NULL;\n\n\tif (!gatt_client_init(client, mtu)) {\n\t\tbt_gatt_client_free(client);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_client_ref(client);\n}"
  },
  {
    "function_name": "gatt_client_new",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1910-1948",
    "snippet": "static struct bt_gatt_client *gatt_client_new(struct gatt_db *db,\n\t\t\t\t\t\t\tstruct bt_att *att)\n{\n\tstruct bt_gatt_client *client;\n\n\tclient = new0(struct bt_gatt_client, 1);\n\tclient->disc_id = bt_att_register_disconnect(att, att_disconnect_cb,\n\t\t\t\t\t\t\t\tclient, NULL);\n\tif (!client->disc_id)\n\t\tgoto fail;\n\n\tclient->clones = queue_new();\n\tclient->ready_cbs = queue_new();\n\tclient->long_write_queue = queue_new();\n\tclient->svc_chngd_queue = queue_new();\n\tclient->notify_list = queue_new();\n\tclient->notify_chrcs = queue_new();\n\tclient->pending_requests = queue_new();\n\n\tclient->notify_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_NOT,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->notify_id)\n\t\tgoto fail;\n\n\tclient->ind_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_IND,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->ind_id)\n\t\tgoto fail;\n\n\tclient->att = bt_att_ref(att);\n\tclient->db = gatt_db_ref(db);\n\n\treturn client;\n\nfail:\n\tbt_gatt_client_free(client);\n\treturn NULL;\n\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_client_free",
          "args": [
            "client"
          ],
          "line": 1945
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1859-1891",
          "snippet": "static void bt_gatt_client_free(struct bt_gatt_client *client)\n{\n\tbt_gatt_client_cancel_all(client);\n\n\tqueue_destroy(client->notify_list, notify_data_cleanup);\n\n\tqueue_destroy(client->ready_cbs, ready_destroy);\n\n\tif (client->debug_destroy)\n\t\tclient->debug_destroy(client->debug_data);\n\n\tif (client->att) {\n\t\tbt_att_unregister_disconnect(client->att, client->disc_id);\n\t\tbt_att_unregister(client->att, client->notify_id);\n\t\tbt_att_unregister(client->att, client->ind_id);\n\t\tbt_att_unref(client->att);\n\t}\n\n\tgatt_db_unref(client->db);\n\n\tqueue_destroy(client->clones, NULL);\n\tqueue_destroy(client->svc_chngd_queue, free);\n\tqueue_destroy(client->long_write_queue, request_unref);\n\tqueue_destroy(client->notify_chrcs, notify_chrc_free);\n\tqueue_destroy(client->pending_requests, request_unref);\n\n\tif (client->parent) {\n\t\tqueue_remove(client->parent->clones, client);\n\t\tbt_gatt_client_unref(client->parent);\n\t}\n\n\tfree(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void bt_gatt_client_free(struct bt_gatt_client *client)\n{\n\tbt_gatt_client_cancel_all(client);\n\n\tqueue_destroy(client->notify_list, notify_data_cleanup);\n\n\tqueue_destroy(client->ready_cbs, ready_destroy);\n\n\tif (client->debug_destroy)\n\t\tclient->debug_destroy(client->debug_data);\n\n\tif (client->att) {\n\t\tbt_att_unregister_disconnect(client->att, client->disc_id);\n\t\tbt_att_unregister(client->att, client->notify_id);\n\t\tbt_att_unregister(client->att, client->ind_id);\n\t\tbt_att_unref(client->att);\n\t}\n\n\tgatt_db_unref(client->db);\n\n\tqueue_destroy(client->clones, NULL);\n\tqueue_destroy(client->svc_chngd_queue, free);\n\tqueue_destroy(client->long_write_queue, request_unref);\n\tqueue_destroy(client->notify_chrcs, notify_chrc_free);\n\tqueue_destroy(client->pending_requests, request_unref);\n\n\tif (client->parent) {\n\t\tqueue_remove(client->parent->clones, client);\n\t\tbt_gatt_client_unref(client->parent);\n\t}\n\n\tfree(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_ref",
          "args": [
            "db"
          ],
          "line": 1940
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "210-218",
          "snippet": "struct gatt_db *gatt_db_ref(struct gatt_db *db)\n{\n\tif (!db)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&db->ref_count, 1);\n\n\treturn db;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db *gatt_db_ref(struct gatt_db *db)\n{\n\tif (!db)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&db->ref_count, 1);\n\n\treturn db;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_ref",
          "args": [
            "att"
          ],
          "line": 1939
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1053-1061",
          "snippet": "struct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstruct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_register",
          "args": [
            "att",
            "BT_ATT_OP_HANDLE_VAL_IND",
            "notify_cb",
            "client",
            "NULL"
          ],
          "line": 1934
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_register",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1402-1429",
          "snippet": "unsigned int bt_att_register(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tbt_att_notify_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !callback || !att->io)\n\t\treturn 0;\n\n\tnotify = new0(struct att_notify, 1);\n\tnotify->opcode = opcode;\n\tnotify->callback = callback;\n\tnotify->destroy = destroy;\n\tnotify->user_data = user_data;\n\n\tif (att->next_reg_id < 1)\n\t\tatt->next_reg_id = 1;\n\n\tnotify->id = att->next_reg_id++;\n\n\tif (!queue_push_tail(att->notify_list, notify)) {\n\t\tfree(notify);\n\t\treturn 0;\n\t}\n\n\treturn notify->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_register(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tbt_att_notify_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !callback || !att->io)\n\t\treturn 0;\n\n\tnotify = new0(struct att_notify, 1);\n\tnotify->opcode = opcode;\n\tnotify->callback = callback;\n\tnotify->destroy = destroy;\n\tnotify->user_data = user_data;\n\n\tif (att->next_reg_id < 1)\n\t\tatt->next_reg_id = 1;\n\n\tnotify->id = att->next_reg_id++;\n\n\tif (!queue_push_tail(att->notify_list, notify)) {\n\t\tfree(notify);\n\t\treturn 0;\n\t}\n\n\treturn notify->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_new",
          "args": [],
          "line": 1927
        },
        "resolved": true,
        "details": {
          "function_name": "queue_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "56-66",
          "snippet": "struct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nstruct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_register_disconnect",
          "args": [
            "att",
            "att_disconnect_cb",
            "client",
            "NULL"
          ],
          "line": 1916
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_register_disconnect",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1178-1204",
          "snippet": "unsigned int bt_att_register_disconnect(struct bt_att *att,\n\t\t\t\t\tbt_att_disconnect_func_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_disconn *disconn;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\tdisconn = new0(struct att_disconn, 1);\n\tdisconn->callback = callback;\n\tdisconn->destroy = destroy;\n\tdisconn->user_data = user_data;\n\n\tif (att->next_reg_id < 1)\n\t\tatt->next_reg_id = 1;\n\n\tdisconn->id = att->next_reg_id++;\n\n\tif (!queue_push_tail(att->disconn_list, disconn)) {\n\t\tfree(disconn);\n\t\treturn 0;\n\t}\n\n\treturn disconn->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_register_disconnect(struct bt_att *att,\n\t\t\t\t\tbt_att_disconnect_func_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_disconn *disconn;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\tdisconn = new0(struct att_disconn, 1);\n\tdisconn->callback = callback;\n\tdisconn->destroy = destroy;\n\tdisconn->user_data = user_data;\n\n\tif (att->next_reg_id < 1)\n\t\tatt->next_reg_id = 1;\n\n\tdisconn->id = att->next_reg_id++;\n\n\tif (!queue_push_tail(att->disconn_list, disconn)) {\n\t\tfree(disconn);\n\t\treturn 0;\n\t}\n\n\treturn disconn->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_gatt_client",
            "1"
          ],
          "line": 1915
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct bt_gatt_client *gatt_client_new(struct gatt_db *db,\n\t\t\t\t\t\t\tstruct bt_att *att)\n{\n\tstruct bt_gatt_client *client;\n\n\tclient = new0(struct bt_gatt_client, 1);\n\tclient->disc_id = bt_att_register_disconnect(att, att_disconnect_cb,\n\t\t\t\t\t\t\t\tclient, NULL);\n\tif (!client->disc_id)\n\t\tgoto fail;\n\n\tclient->clones = queue_new();\n\tclient->ready_cbs = queue_new();\n\tclient->long_write_queue = queue_new();\n\tclient->svc_chngd_queue = queue_new();\n\tclient->notify_list = queue_new();\n\tclient->notify_chrcs = queue_new();\n\tclient->pending_requests = queue_new();\n\n\tclient->notify_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_NOT,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->notify_id)\n\t\tgoto fail;\n\n\tclient->ind_id = bt_att_register(att, BT_ATT_OP_HANDLE_VAL_IND,\n\t\t\t\t\t\tnotify_cb, client, NULL);\n\tif (!client->ind_id)\n\t\tgoto fail;\n\n\tclient->att = bt_att_ref(att);\n\tclient->db = gatt_db_ref(db);\n\n\treturn client;\n\nfail:\n\tbt_gatt_client_free(client);\n\treturn NULL;\n\n}"
  },
  {
    "function_name": "att_disconnect_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1893-1908",
    "snippet": "static void att_disconnect_cb(int err, void *user_data)\n{\n\tstruct bt_gatt_client *client = user_data;\n\tbool in_init = client->in_init;\n\n\tclient->disc_id = 0;\n\n\tbt_att_unref(client->att);\n\tclient->att = NULL;\n\n\tclient->in_init = false;\n\tclient->ready = false;\n\n\tif (in_init)\n\t\tnotify_client_ready(client, false, 0);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "notify_client_ready",
          "args": [
            "client",
            "false",
            "0"
          ],
          "line": 1907
        },
        "resolved": true,
        "details": {
          "function_name": "notify_client_ready",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1221-1250",
          "snippet": "static void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_unref",
          "args": [
            "client->att"
          ],
          "line": 1900
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1063-1075",
          "snippet": "void bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nvoid bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void att_disconnect_cb(int err, void *user_data)\n{\n\tstruct bt_gatt_client *client = user_data;\n\tbool in_init = client->in_init;\n\n\tclient->disc_id = 0;\n\n\tbt_att_unref(client->att);\n\tclient->att = NULL;\n\n\tclient->in_init = false;\n\tclient->ready = false;\n\n\tif (in_init)\n\t\tnotify_client_ready(client, false, 0);\n}"
  },
  {
    "function_name": "bt_gatt_client_free",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1859-1891",
    "snippet": "static void bt_gatt_client_free(struct bt_gatt_client *client)\n{\n\tbt_gatt_client_cancel_all(client);\n\n\tqueue_destroy(client->notify_list, notify_data_cleanup);\n\n\tqueue_destroy(client->ready_cbs, ready_destroy);\n\n\tif (client->debug_destroy)\n\t\tclient->debug_destroy(client->debug_data);\n\n\tif (client->att) {\n\t\tbt_att_unregister_disconnect(client->att, client->disc_id);\n\t\tbt_att_unregister(client->att, client->notify_id);\n\t\tbt_att_unregister(client->att, client->ind_id);\n\t\tbt_att_unref(client->att);\n\t}\n\n\tgatt_db_unref(client->db);\n\n\tqueue_destroy(client->clones, NULL);\n\tqueue_destroy(client->svc_chngd_queue, free);\n\tqueue_destroy(client->long_write_queue, request_unref);\n\tqueue_destroy(client->notify_chrcs, notify_chrc_free);\n\tqueue_destroy(client->pending_requests, request_unref);\n\n\tif (client->parent) {\n\t\tqueue_remove(client->parent->clones, client);\n\t\tbt_gatt_client_unref(client->parent);\n\t}\n\n\tfree(client);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "client"
          ],
          "line": 1890
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_client_unref",
          "args": [
            "client->parent"
          ],
          "line": 1887
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2004-2013",
          "snippet": "void bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nvoid bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "client->parent->clones",
            "client"
          ],
          "line": 1886
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "client->pending_requests",
            "request_unref"
          ],
          "line": 1883
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_unref",
          "args": [
            "client->db"
          ],
          "line": 1877
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "316-325",
          "snippet": "void gatt_db_unref(struct gatt_db *db)\n{\n\tif (!db)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&db->ref_count, 1))\n\t\treturn;\n\n\tgatt_db_destroy(db);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nvoid gatt_db_unref(struct gatt_db *db)\n{\n\tif (!db)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&db->ref_count, 1))\n\t\treturn;\n\n\tgatt_db_destroy(db);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_unref",
          "args": [
            "client->att"
          ],
          "line": 1874
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1063-1075",
          "snippet": "void bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nvoid bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_unregister",
          "args": [
            "client->att",
            "client->ind_id"
          ],
          "line": 1873
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unregister",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1431-1445",
          "snippet": "bool bt_att_unregister(struct bt_att *att, unsigned int id)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tnotify = queue_remove_if(att->notify_list, match_notify_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tdestroy_att_notify(notify);\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_unregister(struct bt_att *att, unsigned int id)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tnotify = queue_remove_if(att->notify_list, match_notify_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tdestroy_att_notify(notify);\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_unregister_disconnect",
          "args": [
            "client->att",
            "client->disc_id"
          ],
          "line": 1871
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unregister_disconnect",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1206-1231",
          "snippet": "bool bt_att_unregister_disconnect(struct bt_att *att, unsigned int id)\n{\n\tstruct att_disconn *disconn;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\t/* Check if disconnect is running */\n\tif (!att->io) {\n\t\tdisconn = queue_find(att->disconn_list, match_disconn_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\t\tif (!disconn)\n\t\t\treturn false;\n\n\t\tdisconn->removed = true;\n\t\treturn true;\n\t}\n\n\tdisconn = queue_remove_if(att->disconn_list, match_disconn_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!disconn)\n\t\treturn false;\n\n\tdestroy_att_disconn(disconn);\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_unregister_disconnect(struct bt_att *att, unsigned int id)\n{\n\tstruct att_disconn *disconn;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\t/* Check if disconnect is running */\n\tif (!att->io) {\n\t\tdisconn = queue_find(att->disconn_list, match_disconn_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\t\tif (!disconn)\n\t\t\treturn false;\n\n\t\tdisconn->removed = true;\n\t\treturn true;\n\t}\n\n\tdisconn = queue_remove_if(att->disconn_list, match_disconn_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!disconn)\n\t\treturn false;\n\n\tdestroy_att_disconn(disconn);\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "client->debug_destroy",
          "args": [
            "client->debug_data"
          ],
          "line": 1868
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_client_cancel_all",
          "args": [
            "client"
          ],
          "line": 1861
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_cancel_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2194-2211",
          "snippet": "bool bt_gatt_client_cancel_all(struct bt_gatt_client *client)\n{\n\tif (!client || !client->att)\n\t\treturn false;\n\n\tqueue_remove_all(client->pending_requests, NULL, NULL, cancel_pending);\n\n\tif (client->discovery_req) {\n\t\tbt_gatt_request_cancel(client->discovery_req);\n\t\tbt_gatt_request_unref(client->discovery_req);\n\t\tclient->discovery_req = NULL;\n\t}\n\n\tif (client->mtu_req_id)\n\t\tbt_att_cancel(client->att, client->mtu_req_id);\n\n\treturn true;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nbool bt_gatt_client_cancel_all(struct bt_gatt_client *client)\n{\n\tif (!client || !client->att)\n\t\treturn false;\n\n\tqueue_remove_all(client->pending_requests, NULL, NULL, cancel_pending);\n\n\tif (client->discovery_req) {\n\t\tbt_gatt_request_cancel(client->discovery_req);\n\t\tbt_gatt_request_unref(client->discovery_req);\n\t\tclient->discovery_req = NULL;\n\t}\n\n\tif (client->mtu_req_id)\n\t\tbt_att_cancel(client->att, client->mtu_req_id);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void bt_gatt_client_free(struct bt_gatt_client *client)\n{\n\tbt_gatt_client_cancel_all(client);\n\n\tqueue_destroy(client->notify_list, notify_data_cleanup);\n\n\tqueue_destroy(client->ready_cbs, ready_destroy);\n\n\tif (client->debug_destroy)\n\t\tclient->debug_destroy(client->debug_data);\n\n\tif (client->att) {\n\t\tbt_att_unregister_disconnect(client->att, client->disc_id);\n\t\tbt_att_unregister(client->att, client->notify_id);\n\t\tbt_att_unregister(client->att, client->ind_id);\n\t\tbt_att_unref(client->att);\n\t}\n\n\tgatt_db_unref(client->db);\n\n\tqueue_destroy(client->clones, NULL);\n\tqueue_destroy(client->svc_chngd_queue, free);\n\tqueue_destroy(client->long_write_queue, request_unref);\n\tqueue_destroy(client->notify_chrcs, notify_chrc_free);\n\tqueue_destroy(client->pending_requests, request_unref);\n\n\tif (client->parent) {\n\t\tqueue_remove(client->parent->clones, client);\n\t\tbt_gatt_client_unref(client->parent);\n\t}\n\n\tfree(client);\n}"
  },
  {
    "function_name": "notify_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1838-1857",
    "snippet": "static void notify_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct bt_gatt_client *client = user_data;\n\tstruct pdu_data pdu_data;\n\n\tbt_gatt_client_ref(client);\n\n\tmemset(&pdu_data, 0, sizeof(pdu_data));\n\tpdu_data.pdu = pdu;\n\tpdu_data.length = length;\n\n\tqueue_foreach(client->notify_list, notify_handler, &pdu_data);\n\n\tif (opcode == BT_ATT_OP_HANDLE_VAL_IND && !client->parent)\n\t\tbt_att_send(client->att, BT_ATT_OP_HANDLE_VAL_CONF, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\tbt_gatt_client_unref(client);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_client_unref",
          "args": [
            "client"
          ],
          "line": 1856
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2004-2013",
          "snippet": "void bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nvoid bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "client->att",
            "BT_ATT_OP_HANDLE_VAL_CONF",
            "NULL",
            "0",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 1853
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_foreach",
          "args": [
            "client->notify_list",
            "notify_handler",
            "&pdu_data"
          ],
          "line": 1850
        },
        "resolved": true,
        "details": {
          "function_name": "queue_foreach",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "203-224",
          "snippet": "void queue_foreach(struct queue *queue, queue_foreach_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue || !function)\n\t\treturn;\n\n\tentry = queue->head;\n\tif (!entry)\n\t\treturn;\n\n\tqueue_ref(queue);\n\twhile (entry && queue->head && queue->ref_count > 1) {\n\t\tstruct queue_entry *next;\n\n\t\tnext = entry->next;\n\t\tfunction(entry->data, user_data);\n\t\tentry = next;\n\t}\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_foreach(struct queue *queue, queue_foreach_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue || !function)\n\t\treturn;\n\n\tentry = queue->head;\n\tif (!entry)\n\t\treturn;\n\n\tqueue_ref(queue);\n\twhile (entry && queue->head && queue->ref_count > 1) {\n\t\tstruct queue_entry *next;\n\n\t\tnext = entry->next;\n\t\tfunction(entry->data, user_data);\n\t\tentry = next;\n\t}\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&pdu_data",
            "0",
            "sizeof(pdu_data)"
          ],
          "line": 1846
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_client_ref",
          "args": [
            "client"
          ],
          "line": 1844
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1994-2002",
          "snippet": "struct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void notify_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct bt_gatt_client *client = user_data;\n\tstruct pdu_data pdu_data;\n\n\tbt_gatt_client_ref(client);\n\n\tmemset(&pdu_data, 0, sizeof(pdu_data));\n\tpdu_data.pdu = pdu;\n\tpdu_data.length = length;\n\n\tqueue_foreach(client->notify_list, notify_handler, &pdu_data);\n\n\tif (opcode == BT_ATT_OP_HANDLE_VAL_IND && !client->parent)\n\t\tbt_att_send(client->att, BT_ATT_OP_HANDLE_VAL_CONF, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\tbt_gatt_client_unref(client);\n}"
  },
  {
    "function_name": "notify_handler",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1814-1836",
    "snippet": "static void notify_handler(void *data, void *user_data)\n{\n\tstruct notify_data *notify_data = data;\n\tstruct pdu_data *pdu_data = user_data;\n\tuint16_t value_handle;\n\tconst uint8_t *value = NULL;\n\n\tvalue_handle = get_le16(pdu_data->pdu);\n\n\tif (notify_data->chrc->value_handle != value_handle)\n\t\treturn;\n\n\tif (pdu_data->length > 2)\n\t\tvalue = pdu_data->pdu + 2;\n\n\t/*\n\t * Even if the notify data has a pending ATT request to write to the\n\t * CCC, there is really no reason not to notify the handlers.\n\t */\n\tif (notify_data->notify)\n\t\tnotify_data->notify(value_handle, value, pdu_data->length - 2,\n\t\t\t\t\t\t\tnotify_data->user_data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "notify_data->notify",
          "args": [
            "value_handle",
            "value",
            "pdu_data->length - 2",
            "notify_data->user_data"
          ],
          "line": 1834
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu_data->pdu"
          ],
          "line": 1821
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void notify_handler(void *data, void *user_data)\n{\n\tstruct notify_data *notify_data = data;\n\tstruct pdu_data *pdu_data = user_data;\n\tuint16_t value_handle;\n\tconst uint8_t *value = NULL;\n\n\tvalue_handle = get_le16(pdu_data->pdu);\n\n\tif (notify_data->chrc->value_handle != value_handle)\n\t\treturn;\n\n\tif (pdu_data->length > 2)\n\t\tvalue = pdu_data->pdu + 2;\n\n\t/*\n\t * Even if the notify data has a pending ATT request to write to the\n\t * CCC, there is really no reason not to notify the handlers.\n\t */\n\tif (notify_data->notify)\n\t\tnotify_data->notify(value_handle, value, pdu_data->length - 2,\n\t\t\t\t\t\t\tnotify_data->user_data);\n}"
  },
  {
    "function_name": "complete_unregister_notify",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1790-1812",
    "snippet": "static void complete_unregister_notify(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\t/*\n\t * If a procedure to enable the CCC is still pending, then cancel it and\n\t * return.\n\t */\n\tif (notify_data->att_id) {\n\t\tbt_att_cancel(notify_data->client->att, notify_data->att_id);\n\t\tnotify_data->att_id = 0;\n\t\tgoto done;\n\t}\n\n\tif (__sync_sub_and_fetch(&notify_data->chrc->notify_count, 1) ||\n\t\t\t\t\t\t!notify_data->chrc->ccc_handle)\n\t\tgoto done;\n\n\tnotify_data_write_ccc(notify_data, false, disable_ccc_callback);\n\ndone:\n\tnotify_data_unref(notify_data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "notify_data_unref",
          "args": [
            "notify_data"
          ],
          "line": 1811
        },
        "resolved": true,
        "details": {
          "function_name": "notify_data_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "207-218",
          "snippet": "static void notify_data_unref(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tif (__sync_sub_and_fetch(&notify_data->ref_count, 1))\n\t\treturn;\n\n\tif (notify_data->destroy)\n\t\tnotify_data->destroy(notify_data->user_data);\n\n\tfree(notify_data);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void notify_data_unref(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tif (__sync_sub_and_fetch(&notify_data->ref_count, 1))\n\t\treturn;\n\n\tif (notify_data->destroy)\n\t\tnotify_data->destroy(notify_data->user_data);\n\n\tfree(notify_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "notify_data_write_ccc",
          "args": [
            "notify_data",
            "false",
            "disable_ccc_callback"
          ],
          "line": 1808
        },
        "resolved": true,
        "details": {
          "function_name": "notify_data_write_ccc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1324-1355",
          "snippet": "static bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&notify_data->chrc->notify_count",
            "1"
          ],
          "line": 1804
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_cancel",
          "args": [
            "notify_data->client->att",
            "notify_data->att_id"
          ],
          "line": 1799
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_cancel",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1291-1331",
          "snippet": "bool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void complete_unregister_notify(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\t/*\n\t * If a procedure to enable the CCC is still pending, then cancel it and\n\t * return.\n\t */\n\tif (notify_data->att_id) {\n\t\tbt_att_cancel(notify_data->client->att, notify_data->att_id);\n\t\tnotify_data->att_id = 0;\n\t\tgoto done;\n\t}\n\n\tif (__sync_sub_and_fetch(&notify_data->chrc->notify_count, 1) ||\n\t\t\t\t\t\t!notify_data->chrc->ccc_handle)\n\t\tgoto done;\n\n\tnotify_data_write_ccc(notify_data, false, disable_ccc_callback);\n\ndone:\n\tnotify_data_unref(notify_data);\n}"
  },
  {
    "function_name": "disable_ccc_callback",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1769-1788",
    "snippet": "static void disable_ccc_callback(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct notify_data *notify_data = user_data;\n\tstruct notify_data *next_data;\n\n\tassert(notify_data->chrc->ccc_write_id);\n\n\tnotify_data->chrc->ccc_write_id = 0;\n\n\t/* This is a best effort procedure, so ignore errors and process any\n\t * queued requests.\n\t */\n\twhile (1) {\n\t\tnext_data = queue_pop_head(notify_data->chrc->reg_notify_queue);\n\t\tif (!next_data || notify_data_write_ccc(notify_data, true,\n\t\t\t\t\t\t\tenable_ccc_callback))\n\t\t\treturn;\n\t}\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "notify_data_write_ccc",
          "args": [
            "notify_data",
            "true",
            "enable_ccc_callback"
          ],
          "line": 1784
        },
        "resolved": true,
        "details": {
          "function_name": "notify_data_write_ccc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1324-1355",
          "snippet": "static bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "notify_data->chrc->reg_notify_queue"
          ],
          "line": 1783
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "assert",
          "args": [
            "notify_data->chrc->ccc_write_id"
          ],
          "line": 1775
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void disable_ccc_callback(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct notify_data *notify_data = user_data;\n\tstruct notify_data *next_data;\n\n\tassert(notify_data->chrc->ccc_write_id);\n\n\tnotify_data->chrc->ccc_write_id = 0;\n\n\t/* This is a best effort procedure, so ignore errors and process any\n\t * queued requests.\n\t */\n\twhile (1) {\n\t\tnext_data = queue_pop_head(notify_data->chrc->reg_notify_queue);\n\t\tif (!next_data || notify_data_write_ccc(notify_data, true,\n\t\t\t\t\t\t\tenable_ccc_callback))\n\t\t\treturn;\n\t}\n}"
  },
  {
    "function_name": "gatt_client_init",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1707-1762",
    "snippet": "static bool gatt_client_init(struct bt_gatt_client *client, uint16_t mtu)\n{\n\tstruct discovery_op *op;\n\n\tif (client->in_init || client->ready)\n\t\treturn false;\n\n\top = discovery_op_create(client, 0x0001, 0xffff, init_complete, NULL);\n\tif (!op)\n\t\treturn false;\n\n\t/*\n\t * BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part G] page 546:\n\t *\n\t * 4.3.1 Exchange MTU\n\t *\n\t * This sub-procedure shall not be used on a BR/EDR physical link since\n\t * the MTU size is negotiated using L2CAP channel configuration\n\t * procedures.\n\t */\n\tif (bt_att_get_link_type(client->att) == BT_ATT_LINK_BREDR)\n\t\tgoto discover;\n\n\t/* Check if MTU needs to be send */\n\tmtu = MAX(BT_ATT_DEFAULT_LE_MTU, mtu);\n\tif (mtu == BT_ATT_DEFAULT_LE_MTU)\n\t\tgoto discover;\n\n\t/* Configure the MTU */\n\tclient->mtu_req_id = bt_gatt_exchange_mtu(client->att, mtu,\n\t\t\t\t\t\texchange_mtu_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (!client->mtu_req_id) {\n\t\tdiscovery_op_free(op);\n\t\treturn false;\n\t}\n\n\tclient->in_init = true;\n\n\treturn true;\n\ndiscover:\n\tclient->discovery_req = bt_gatt_discover_all_primary_services(\n\t\t\t\t\t\t\tclient->att, NULL,\n\t\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\tif (!client->discovery_req) {\n\t\tdiscovery_op_free(op);\n\t\treturn false;\n\t}\n\n\tclient->in_init = true;\n\treturn true;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_free",
          "args": [
            "op"
          ],
          "line": 1756
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "340-350",
          "snippet": "static void discovery_op_free(struct discovery_op *op)\n{\n\tif (op->db_id > 0)\n\t\tgatt_db_unregister(op->client->db, op->db_id);\n\n\tqueue_destroy(op->discov_ranges, free);\n\tqueue_destroy(op->pending_svcs, NULL);\n\tqueue_destroy(op->pending_chrcs, free);\n\tqueue_destroy(op->ext_prop_desc, NULL);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_free(struct discovery_op *op)\n{\n\tif (op->db_id > 0)\n\t\tgatt_db_unregister(op->client->db, op->db_id);\n\n\tqueue_destroy(op->discov_ranges, free);\n\tqueue_destroy(op->pending_svcs, NULL);\n\tqueue_destroy(op->pending_chrcs, free);\n\tqueue_destroy(op->ext_prop_desc, NULL);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_discover_all_primary_services",
          "args": [
            "client->att",
            "NULL",
            "discover_primary_cb",
            "discovery_op_ref(op)",
            "discovery_op_unref"
          ],
          "line": 1750
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_discover_all_primary_services",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "873-882",
          "snippet": "struct bt_gatt_request *bt_gatt_discover_all_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn bt_gatt_discover_primary_services(att, uuid, 0x0001, 0xffff,\n\t\t\t\t\t\t\tcallback, user_data,\n\t\t\t\t\t\t\tdestroy);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_all_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn bt_gatt_discover_primary_services(att, uuid, 0x0001, 0xffff,\n\t\t\t\t\t\t\tcallback, user_data,\n\t\t\t\t\t\t\tdestroy);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_ref",
          "args": [
            "op"
          ],
          "line": 1753
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "446-451",
          "snippet": "static struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_exchange_mtu",
          "args": [
            "client->att",
            "mtu",
            "exchange_mtu_cb",
            "discovery_op_ref(op)",
            "discovery_op_unref"
          ],
          "line": 1736
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_exchange_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "536-563",
          "snippet": "unsigned int bt_gatt_exchange_mtu(struct bt_att *att, uint16_t client_rx_mtu,\n\t\t\t\t\tbt_gatt_result_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct mtu_op *op;\n\tuint8_t pdu[2];\n\tunsigned int id;\n\n\tif (!att || !client_rx_mtu)\n\t\treturn false;\n\n\top = new0(struct mtu_op, 1);\n\top->att = att;\n\top->client_rx_mtu = client_rx_mtu;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\tput_le16(client_rx_mtu, pdu);\n\n\tid = bt_att_send(att, BT_ATT_OP_MTU_REQ, pdu, sizeof(pdu), mtu_cb, op,\n\t\t\t\t\t\t\t\tdestroy_mtu_op);\n\tif (!id)\n\t\tfree(op);\n\n\treturn id;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nunsigned int bt_gatt_exchange_mtu(struct bt_att *att, uint16_t client_rx_mtu,\n\t\t\t\t\tbt_gatt_result_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct mtu_op *op;\n\tuint8_t pdu[2];\n\tunsigned int id;\n\n\tif (!att || !client_rx_mtu)\n\t\treturn false;\n\n\top = new0(struct mtu_op, 1);\n\top->att = att;\n\top->client_rx_mtu = client_rx_mtu;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\tput_le16(client_rx_mtu, pdu);\n\n\tid = bt_att_send(att, BT_ATT_OP_MTU_REQ, pdu, sizeof(pdu), mtu_cb, op,\n\t\t\t\t\t\t\t\tdestroy_mtu_op);\n\tif (!id)\n\t\tfree(op);\n\n\treturn id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "MAX",
          "args": [
            "BT_ATT_DEFAULT_LE_MTU",
            "mtu"
          ],
          "line": 1731
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_get_link_type",
          "args": [
            "client->att"
          ],
          "line": 1727
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_link_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1139-1159",
          "snippet": "uint8_t bt_att_get_link_type(struct bt_att *att)\n{\n\tstruct sockaddr_l2 src;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap)\n\t\treturn BT_ATT_LINK_LOCAL;\n\n\tlen = sizeof(src);\n\tmemset(&src, 0, len);\n\tif (getsockname(att->fd, (void *)&src, &len) < 0)\n\t\treturn -errno;\n\n\tif (src.l2_bdaddr_type == BDADDR_BREDR)\n\t\treturn BT_ATT_LINK_BREDR;\n\n\treturn BT_ATT_LINK_LE;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint8_t bt_att_get_link_type(struct bt_att *att)\n{\n\tstruct sockaddr_l2 src;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap)\n\t\treturn BT_ATT_LINK_LOCAL;\n\n\tlen = sizeof(src);\n\tmemset(&src, 0, len);\n\tif (getsockname(att->fd, (void *)&src, &len) < 0)\n\t\treturn -errno;\n\n\tif (src.l2_bdaddr_type == BDADDR_BREDR)\n\t\treturn BT_ATT_LINK_BREDR;\n\n\treturn BT_ATT_LINK_LE;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_create",
          "args": [
            "client",
            "0x0001",
            "0xffff",
            "init_complete",
            "NULL"
          ],
          "line": 1714
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "403-444",
          "snippet": "static struct discovery_op *discovery_op_create(struct bt_gatt_client *client,\n\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\tdiscovery_op_complete_func_t complete_func,\n\t\t\t\tdiscovery_op_fail_func_t failure_func)\n{\n\tstruct discovery_op *op;\n\tstruct handle_range *range;\n\n\top = new0(struct discovery_op, 1);\n\top->discov_ranges = queue_new();\n\top->pending_svcs = queue_new();\n\top->pending_chrcs = queue_new();\n\top->ext_prop_desc = queue_new();\n\top->client = client;\n\top->complete_func = complete_func;\n\top->failure_func = failure_func;\n\top->start = start;\n\top->end = end;\n\top->last = gatt_db_isempty(client->db) ? 0 : UINT16_MAX;\n\top->svc_first = UINT16_MAX;\n\top->svc_last = 0;\n\n\t/* Load existing services as pending */\n\tgatt_db_foreach_service_in_range(client->db, NULL,\n\t\t\t\t\t discovery_load_services, op,\n\t\t\t\t\t start, end);\n\n\t/*\n\t * Services are only added when set active in which case they are no\n\t * longer pending so it is safe to remove either way.\n\t */\n\top->db_id = gatt_db_register(client->db, discovery_service_changed,\n\t\t\t\t\t\tdiscovery_service_changed,\n\t\t\t\t\t\top, NULL);\n\n\trange = new0(struct handle_range, 1);\n\trange->start = start;\n\trange->end = end;\n\tqueue_push_tail(op->discov_ranges, range);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_create(struct bt_gatt_client *client,\n\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\tdiscovery_op_complete_func_t complete_func,\n\t\t\t\tdiscovery_op_fail_func_t failure_func)\n{\n\tstruct discovery_op *op;\n\tstruct handle_range *range;\n\n\top = new0(struct discovery_op, 1);\n\top->discov_ranges = queue_new();\n\top->pending_svcs = queue_new();\n\top->pending_chrcs = queue_new();\n\top->ext_prop_desc = queue_new();\n\top->client = client;\n\top->complete_func = complete_func;\n\top->failure_func = failure_func;\n\top->start = start;\n\top->end = end;\n\top->last = gatt_db_isempty(client->db) ? 0 : UINT16_MAX;\n\top->svc_first = UINT16_MAX;\n\top->svc_last = 0;\n\n\t/* Load existing services as pending */\n\tgatt_db_foreach_service_in_range(client->db, NULL,\n\t\t\t\t\t discovery_load_services, op,\n\t\t\t\t\t start, end);\n\n\t/*\n\t * Services are only added when set active in which case they are no\n\t * longer pending so it is safe to remove either way.\n\t */\n\top->db_id = gatt_db_register(client->db, discovery_service_changed,\n\t\t\t\t\t\tdiscovery_service_changed,\n\t\t\t\t\t\top, NULL);\n\n\trange = new0(struct handle_range, 1);\n\trange->start = start;\n\trange->end = end;\n\tqueue_push_tail(op->discov_ranges, range);\n\n\treturn op;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool gatt_client_init(struct bt_gatt_client *client, uint16_t mtu)\n{\n\tstruct discovery_op *op;\n\n\tif (client->in_init || client->ready)\n\t\treturn false;\n\n\top = discovery_op_create(client, 0x0001, 0xffff, init_complete, NULL);\n\tif (!op)\n\t\treturn false;\n\n\t/*\n\t * BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part G] page 546:\n\t *\n\t * 4.3.1 Exchange MTU\n\t *\n\t * This sub-procedure shall not be used on a BR/EDR physical link since\n\t * the MTU size is negotiated using L2CAP channel configuration\n\t * procedures.\n\t */\n\tif (bt_att_get_link_type(client->att) == BT_ATT_LINK_BREDR)\n\t\tgoto discover;\n\n\t/* Check if MTU needs to be send */\n\tmtu = MAX(BT_ATT_DEFAULT_LE_MTU, mtu);\n\tif (mtu == BT_ATT_DEFAULT_LE_MTU)\n\t\tgoto discover;\n\n\t/* Configure the MTU */\n\tclient->mtu_req_id = bt_gatt_exchange_mtu(client->att, mtu,\n\t\t\t\t\t\texchange_mtu_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (!client->mtu_req_id) {\n\t\tdiscovery_op_free(op);\n\t\treturn false;\n\t}\n\n\tclient->in_init = true;\n\n\treturn true;\n\ndiscover:\n\tclient->discovery_req = bt_gatt_discover_all_primary_services(\n\t\t\t\t\t\t\tclient->att, NULL,\n\t\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\tif (!client->discovery_req) {\n\t\tdiscovery_op_free(op);\n\t\treturn false;\n\t}\n\n\tclient->in_init = true;\n\treturn true;\n}"
  },
  {
    "function_name": "init_complete",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1680-1705",
    "snippet": "static void init_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tstruct bt_gatt_client *client = op->client;\n\n\tclient->in_init = false;\n\n\tif (!success)\n\t\tgoto fail;\n\n\tif (register_service_changed(client))\n\t\tgoto done;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Failed to register handler for \\\"Service Changed\\\"\");\n\tsuccess = false;\n\nfail:\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Failed to initialize gatt-client\");\n\n\top->success = false;\n\ndone:\n\tnotify_client_ready(client, success, att_ecode);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "notify_client_ready",
          "args": [
            "client",
            "success",
            "att_ecode"
          ],
          "line": 1704
        },
        "resolved": true,
        "details": {
          "function_name": "notify_client_ready",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1221-1250",
          "snippet": "static void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Failed to initialize gatt-client\""
          ],
          "line": 1698
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "register_service_changed",
          "args": [
            "client"
          ],
          "line": 1690
        },
        "resolved": true,
        "details": {
          "function_name": "register_service_changed",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1528-1555",
          "snippet": "static bool register_service_changed(struct bt_gatt_client *client)\n{\n\tbt_uuid_t uuid;\n\tstruct gatt_db_attribute *attr = NULL;\n\n\tbt_uuid16_create(&uuid, SVC_CHNGD_UUID);\n\n\tif (client->svc_chngd_ind_id)\n\t\treturn true;\n\n\tgatt_db_find_by_type(client->db, 0x0001, 0xffff, &uuid,\n\t\t\t\t\t\tget_first_attribute, &attr);\n\tif (!attr)\n\t\treturn true;\n\n\t/*\n\t * Register an indication handler for the \"Service Changed\"\n\t * characteristic and report ready only if the handler is registered\n\t * successfully.\n\t */\n\tclient->svc_chngd_ind_id = register_notify(client,\n\t\t\t\t\tgatt_db_attribute_get_handle(attr),\n\t\t\t\t\tservice_changed_register_cb,\n\t\t\t\t\tservice_changed_cb,\n\t\t\t\t\tclient, NULL);\n\n\treturn client->svc_chngd_ind_id ? true : false;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define SVC_CHNGD_UUID\t0x2a05"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\n#define SVC_CHNGD_UUID\t0x2a05\n\nstatic bool register_service_changed(struct bt_gatt_client *client)\n{\n\tbt_uuid_t uuid;\n\tstruct gatt_db_attribute *attr = NULL;\n\n\tbt_uuid16_create(&uuid, SVC_CHNGD_UUID);\n\n\tif (client->svc_chngd_ind_id)\n\t\treturn true;\n\n\tgatt_db_find_by_type(client->db, 0x0001, 0xffff, &uuid,\n\t\t\t\t\t\tget_first_attribute, &attr);\n\tif (!attr)\n\t\treturn true;\n\n\t/*\n\t * Register an indication handler for the \"Service Changed\"\n\t * characteristic and report ready only if the handler is registered\n\t * successfully.\n\t */\n\tclient->svc_chngd_ind_id = register_notify(client,\n\t\t\t\t\tgatt_db_attribute_get_handle(attr),\n\t\t\t\t\tservice_changed_register_cb,\n\t\t\t\t\tservice_changed_cb,\n\t\t\t\t\tclient, NULL);\n\n\treturn client->svc_chngd_ind_id ? true : false;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void init_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tstruct bt_gatt_client *client = op->client;\n\n\tclient->in_init = false;\n\n\tif (!success)\n\t\tgoto fail;\n\n\tif (register_service_changed(client))\n\t\tgoto done;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Failed to register handler for \\\"Service Changed\\\"\");\n\tsuccess = false;\n\nfail:\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Failed to initialize gatt-client\");\n\n\top->success = false;\n\ndone:\n\tnotify_client_ready(client, success, att_ecode);\n}"
  },
  {
    "function_name": "service_changed_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1644-1678",
    "snippet": "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_client *client = user_data;\n\tstruct service_changed_op *op;\n\tuint16_t start, end;\n\n\tif (length != 4)\n\t\treturn;\n\n\tstart = get_le16(value);\n\tend = get_le16(value + 2);\n\n\tif (start > end) {\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Service Changed received with invalid handles\");\n\t\treturn;\n\t}\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Service Changed received - start: 0x%04x end: 0x%04x\",\n\t\t\tstart, end);\n\n\tif (!client->in_svc_chngd) {\n\t\tprocess_service_changed(client, start, end);\n\t\treturn;\n\t}\n\n\top = new0(struct service_changed_op, 1);\n\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tqueue_push_tail(client->svc_chngd_queue, op);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "client->svc_chngd_queue",
            "op"
          ],
          "line": 1677
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structservice_changed_op",
            "1"
          ],
          "line": 1672
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "process_service_changed",
          "args": [
            "client",
            "start",
            "end"
          ],
          "line": 1668
        },
        "resolved": true,
        "details": {
          "function_name": "process_service_changed",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1614-1642",
          "snippet": "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct discovery_op *op;\n\n\top = discovery_op_create(client, start_handle, end_handle,\n\t\t\t\t\t\tservice_changed_complete,\n\t\t\t\t\t\tservice_changed_failure);\n\tif (!op)\n\t\tgoto fail;\n\n\tclient->discovery_req = bt_gatt_discover_primary_services(client->att,\n\t\t\t\t\t\tNULL, start_handle, end_handle,\n\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req) {\n\t\tclient->in_svc_chngd = true;\n\t\treturn;\n\t}\n\n\tdiscovery_op_free(op);\n\nfail:\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to initiate service discovery\"\n\t\t\t\t\t\" after Service Changed\");\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct discovery_op *op;\n\n\top = discovery_op_create(client, start_handle, end_handle,\n\t\t\t\t\t\tservice_changed_complete,\n\t\t\t\t\t\tservice_changed_failure);\n\tif (!op)\n\t\tgoto fail;\n\n\tclient->discovery_req = bt_gatt_discover_primary_services(client->att,\n\t\t\t\t\t\tNULL, start_handle, end_handle,\n\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req) {\n\t\tclient->in_svc_chngd = true;\n\t\treturn;\n\t}\n\n\tdiscovery_op_free(op);\n\nfail:\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to initiate service discovery\"\n\t\t\t\t\t\" after Service Changed\");\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Service Changed received - start: 0x%04x end: 0x%04x\"",
            "start",
            "end"
          ],
          "line": 1663
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "value + 2"
          ],
          "line": 1655
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_client *client = user_data;\n\tstruct service_changed_op *op;\n\tuint16_t start, end;\n\n\tif (length != 4)\n\t\treturn;\n\n\tstart = get_le16(value);\n\tend = get_le16(value + 2);\n\n\tif (start > end) {\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Service Changed received with invalid handles\");\n\t\treturn;\n\t}\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Service Changed received - start: 0x%04x end: 0x%04x\",\n\t\t\tstart, end);\n\n\tif (!client->in_svc_chngd) {\n\t\tprocess_service_changed(client, start, end);\n\t\treturn;\n\t}\n\n\top = new0(struct service_changed_op, 1);\n\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tqueue_push_tail(client->svc_chngd_queue, op);\n}"
  },
  {
    "function_name": "process_service_changed",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1614-1642",
    "snippet": "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct discovery_op *op;\n\n\top = discovery_op_create(client, start_handle, end_handle,\n\t\t\t\t\t\tservice_changed_complete,\n\t\t\t\t\t\tservice_changed_failure);\n\tif (!op)\n\t\tgoto fail;\n\n\tclient->discovery_req = bt_gatt_discover_primary_services(client->att,\n\t\t\t\t\t\tNULL, start_handle, end_handle,\n\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req) {\n\t\tclient->in_svc_chngd = true;\n\t\treturn;\n\t}\n\n\tdiscovery_op_free(op);\n\nfail:\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to initiate service discovery\"\n\t\t\t\t\t\" after Service Changed\");\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Failed to initiate service discovery\"\n\t\t\t\t\t\" after Service Changed\""
          ],
          "line": 1639
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_free",
          "args": [
            "op"
          ],
          "line": 1636
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "340-350",
          "snippet": "static void discovery_op_free(struct discovery_op *op)\n{\n\tif (op->db_id > 0)\n\t\tgatt_db_unregister(op->client->db, op->db_id);\n\n\tqueue_destroy(op->discov_ranges, free);\n\tqueue_destroy(op->pending_svcs, NULL);\n\tqueue_destroy(op->pending_chrcs, free);\n\tqueue_destroy(op->ext_prop_desc, NULL);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_free(struct discovery_op *op)\n{\n\tif (op->db_id > 0)\n\t\tgatt_db_unregister(op->client->db, op->db_id);\n\n\tqueue_destroy(op->discov_ranges, free);\n\tqueue_destroy(op->pending_svcs, NULL);\n\tqueue_destroy(op->pending_chrcs, free);\n\tqueue_destroy(op->ext_prop_desc, NULL);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_discover_primary_services",
          "args": [
            "client->att",
            "NULL",
            "start_handle",
            "end_handle",
            "discover_primary_cb",
            "discovery_op_ref(op)",
            "discovery_op_unref"
          ],
          "line": 1626
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_discover_primary_services",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "884-893",
          "snippet": "struct bt_gatt_request *bt_gatt_discover_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn discover_services(att, uuid, start, end, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy, true);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn discover_services(att, uuid, start, end, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy, true);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_ref",
          "args": [
            "op"
          ],
          "line": 1629
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "446-451",
          "snippet": "static struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_create",
          "args": [
            "client",
            "start_handle",
            "end_handle",
            "service_changed_complete",
            "service_changed_failure"
          ],
          "line": 1620
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "403-444",
          "snippet": "static struct discovery_op *discovery_op_create(struct bt_gatt_client *client,\n\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\tdiscovery_op_complete_func_t complete_func,\n\t\t\t\tdiscovery_op_fail_func_t failure_func)\n{\n\tstruct discovery_op *op;\n\tstruct handle_range *range;\n\n\top = new0(struct discovery_op, 1);\n\top->discov_ranges = queue_new();\n\top->pending_svcs = queue_new();\n\top->pending_chrcs = queue_new();\n\top->ext_prop_desc = queue_new();\n\top->client = client;\n\top->complete_func = complete_func;\n\top->failure_func = failure_func;\n\top->start = start;\n\top->end = end;\n\top->last = gatt_db_isempty(client->db) ? 0 : UINT16_MAX;\n\top->svc_first = UINT16_MAX;\n\top->svc_last = 0;\n\n\t/* Load existing services as pending */\n\tgatt_db_foreach_service_in_range(client->db, NULL,\n\t\t\t\t\t discovery_load_services, op,\n\t\t\t\t\t start, end);\n\n\t/*\n\t * Services are only added when set active in which case they are no\n\t * longer pending so it is safe to remove either way.\n\t */\n\top->db_id = gatt_db_register(client->db, discovery_service_changed,\n\t\t\t\t\t\tdiscovery_service_changed,\n\t\t\t\t\t\top, NULL);\n\n\trange = new0(struct handle_range, 1);\n\trange->start = start;\n\trange->end = end;\n\tqueue_push_tail(op->discov_ranges, range);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_create(struct bt_gatt_client *client,\n\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\tdiscovery_op_complete_func_t complete_func,\n\t\t\t\tdiscovery_op_fail_func_t failure_func)\n{\n\tstruct discovery_op *op;\n\tstruct handle_range *range;\n\n\top = new0(struct discovery_op, 1);\n\top->discov_ranges = queue_new();\n\top->pending_svcs = queue_new();\n\top->pending_chrcs = queue_new();\n\top->ext_prop_desc = queue_new();\n\top->client = client;\n\top->complete_func = complete_func;\n\top->failure_func = failure_func;\n\top->start = start;\n\top->end = end;\n\top->last = gatt_db_isempty(client->db) ? 0 : UINT16_MAX;\n\top->svc_first = UINT16_MAX;\n\top->svc_last = 0;\n\n\t/* Load existing services as pending */\n\tgatt_db_foreach_service_in_range(client->db, NULL,\n\t\t\t\t\t discovery_load_services, op,\n\t\t\t\t\t start, end);\n\n\t/*\n\t * Services are only added when set active in which case they are no\n\t * longer pending so it is safe to remove either way.\n\t */\n\top->db_id = gatt_db_register(client->db, discovery_service_changed,\n\t\t\t\t\t\tdiscovery_service_changed,\n\t\t\t\t\t\top, NULL);\n\n\trange = new0(struct handle_range, 1);\n\trange->start = start;\n\trange->end = end;\n\tqueue_push_tail(op->discov_ranges, range);\n\n\treturn op;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct discovery_op *op;\n\n\top = discovery_op_create(client, start_handle, end_handle,\n\t\t\t\t\t\tservice_changed_complete,\n\t\t\t\t\t\tservice_changed_failure);\n\tif (!op)\n\t\tgoto fail;\n\n\tclient->discovery_req = bt_gatt_discover_primary_services(client->att,\n\t\t\t\t\t\tNULL, start_handle, end_handle,\n\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req) {\n\t\tclient->in_svc_chngd = true;\n\t\treturn;\n\t}\n\n\tdiscovery_op_free(op);\n\nfail:\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to initiate service discovery\"\n\t\t\t\t\t\" after Service Changed\");\n}"
  },
  {
    "function_name": "service_changed_failure",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1607-1612",
    "snippet": "static void service_changed_failure(struct discovery_op *op)\n{\n\tstruct bt_gatt_client *client = op->client;\n\n\tgatt_db_clear_range(client->db, op->start, op->end);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "gatt_db_clear_range",
          "args": [
            "client->db",
            "op->start",
            "op->end"
          ],
          "line": 1611
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_clear_range",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "457-483",
          "snippet": "bool gatt_db_clear_range(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct clear_range range;\n\n\tif (!db || start_handle > end_handle)\n\t\treturn false;\n\n\t/* Check if it is a full clear */\n\tif (start_handle == 1 && end_handle == UINT16_MAX) {\n\t\tqueue_remove_all(db->services, NULL, NULL,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\t\tgoto done;\n\t}\n\n\trange.start = start_handle;\n\trange.end = end_handle;\n\n\tqueue_remove_all(db->services, match_range, &range,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\ndone:\n\tif (gatt_db_isempty(db))\n\t\tdb->next_handle = 0;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_clear_range(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct clear_range range;\n\n\tif (!db || start_handle > end_handle)\n\t\treturn false;\n\n\t/* Check if it is a full clear */\n\tif (start_handle == 1 && end_handle == UINT16_MAX) {\n\t\tqueue_remove_all(db->services, NULL, NULL,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\t\tgoto done;\n\t}\n\n\trange.start = start_handle;\n\trange.end = end_handle;\n\n\tqueue_remove_all(db->services, match_range, &range,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\ndone:\n\tif (gatt_db_isempty(db))\n\t\tdb->next_handle = 0;\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void service_changed_failure(struct discovery_op *op)\n{\n\tstruct bt_gatt_client *client = op->client;\n\n\tgatt_db_clear_range(client->db, op->start, op->end);\n}"
  },
  {
    "function_name": "service_changed_complete",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1557-1605",
    "snippet": "static void service_changed_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tstruct service_changed_op *next_sc_op;\n\tuint16_t start_handle = op->start;\n\tuint16_t end_handle = op->end;\n\tconst struct queue_entry *entry;\n\n\tclient->in_svc_chngd = false;\n\n\tif (!success && att_ecode != BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND) {\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Failed to discover services within changed range - \"\n\t\t\t\"error: 0x%02x\", att_ecode);\n\n\t\tgatt_db_clear_range(client->db, start_handle, end_handle);\n\t}\n\n\t/* Notify the upper layer of changed services */\n\tif (client->svc_chngd_callback)\n\t\tclient->svc_chngd_callback(start_handle, end_handle,\n\t\t\t\t\t\t\tclient->svc_chngd_data);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tif (clone->svc_chngd_callback)\n\t\t\tclone->svc_chngd_callback(start_handle, end_handle,\n\t\t\t\t\t\t\tclone->svc_chngd_data);\n\t}\n\n\t/* Process any queued events */\n\tnext_sc_op = queue_pop_head(client->svc_chngd_queue);\n\tif (next_sc_op) {\n\t\tprocess_service_changed(client, next_sc_op->start_handle,\n\t\t\t\t\t\t\tnext_sc_op->end_handle);\n\t\tfree(next_sc_op);\n\t\treturn;\n\t}\n\n\tif (register_service_changed(client))\n\t\treturn;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\"Failed to re-register handler for \\\"Service Changed\\\"\");\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Failed to re-register handler for \\\"Service Changed\\\"\""
          ],
          "line": 1603
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "register_service_changed",
          "args": [
            "client"
          ],
          "line": 1600
        },
        "resolved": true,
        "details": {
          "function_name": "register_service_changed",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1528-1555",
          "snippet": "static bool register_service_changed(struct bt_gatt_client *client)\n{\n\tbt_uuid_t uuid;\n\tstruct gatt_db_attribute *attr = NULL;\n\n\tbt_uuid16_create(&uuid, SVC_CHNGD_UUID);\n\n\tif (client->svc_chngd_ind_id)\n\t\treturn true;\n\n\tgatt_db_find_by_type(client->db, 0x0001, 0xffff, &uuid,\n\t\t\t\t\t\tget_first_attribute, &attr);\n\tif (!attr)\n\t\treturn true;\n\n\t/*\n\t * Register an indication handler for the \"Service Changed\"\n\t * characteristic and report ready only if the handler is registered\n\t * successfully.\n\t */\n\tclient->svc_chngd_ind_id = register_notify(client,\n\t\t\t\t\tgatt_db_attribute_get_handle(attr),\n\t\t\t\t\tservice_changed_register_cb,\n\t\t\t\t\tservice_changed_cb,\n\t\t\t\t\tclient, NULL);\n\n\treturn client->svc_chngd_ind_id ? true : false;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define SVC_CHNGD_UUID\t0x2a05"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\n#define SVC_CHNGD_UUID\t0x2a05\n\nstatic bool register_service_changed(struct bt_gatt_client *client)\n{\n\tbt_uuid_t uuid;\n\tstruct gatt_db_attribute *attr = NULL;\n\n\tbt_uuid16_create(&uuid, SVC_CHNGD_UUID);\n\n\tif (client->svc_chngd_ind_id)\n\t\treturn true;\n\n\tgatt_db_find_by_type(client->db, 0x0001, 0xffff, &uuid,\n\t\t\t\t\t\tget_first_attribute, &attr);\n\tif (!attr)\n\t\treturn true;\n\n\t/*\n\t * Register an indication handler for the \"Service Changed\"\n\t * characteristic and report ready only if the handler is registered\n\t * successfully.\n\t */\n\tclient->svc_chngd_ind_id = register_notify(client,\n\t\t\t\t\tgatt_db_attribute_get_handle(attr),\n\t\t\t\t\tservice_changed_register_cb,\n\t\t\t\t\tservice_changed_cb,\n\t\t\t\t\tclient, NULL);\n\n\treturn client->svc_chngd_ind_id ? true : false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "next_sc_op"
          ],
          "line": 1596
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_service_changed",
          "args": [
            "client",
            "next_sc_op->start_handle",
            "next_sc_op->end_handle"
          ],
          "line": 1594
        },
        "resolved": true,
        "details": {
          "function_name": "process_service_changed",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1614-1642",
          "snippet": "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct discovery_op *op;\n\n\top = discovery_op_create(client, start_handle, end_handle,\n\t\t\t\t\t\tservice_changed_complete,\n\t\t\t\t\t\tservice_changed_failure);\n\tif (!op)\n\t\tgoto fail;\n\n\tclient->discovery_req = bt_gatt_discover_primary_services(client->att,\n\t\t\t\t\t\tNULL, start_handle, end_handle,\n\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req) {\n\t\tclient->in_svc_chngd = true;\n\t\treturn;\n\t}\n\n\tdiscovery_op_free(op);\n\nfail:\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to initiate service discovery\"\n\t\t\t\t\t\" after Service Changed\");\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct discovery_op *op;\n\n\top = discovery_op_create(client, start_handle, end_handle,\n\t\t\t\t\t\tservice_changed_complete,\n\t\t\t\t\t\tservice_changed_failure);\n\tif (!op)\n\t\tgoto fail;\n\n\tclient->discovery_req = bt_gatt_discover_primary_services(client->att,\n\t\t\t\t\t\tNULL, start_handle, end_handle,\n\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req) {\n\t\tclient->in_svc_chngd = true;\n\t\treturn;\n\t}\n\n\tdiscovery_op_free(op);\n\nfail:\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to initiate service discovery\"\n\t\t\t\t\t\" after Service Changed\");\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "client->svc_chngd_queue"
          ],
          "line": 1592
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "clone->svc_chngd_callback",
          "args": [
            "start_handle",
            "end_handle",
            "clone->svc_chngd_data"
          ],
          "line": 1587
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "queue_get_entries",
          "args": [
            "client->clones"
          ],
          "line": 1582
        },
        "resolved": true,
        "details": {
          "function_name": "queue_get_entries",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "364-370",
          "snippet": "const struct queue_entry *queue_get_entries(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn NULL;\n\n\treturn queue->head;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nconst struct queue_entry *queue_get_entries(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn NULL;\n\n\treturn queue->head;\n}"
        }
      },
      {
        "call_info": {
          "callee": "client->svc_chngd_callback",
          "args": [
            "start_handle",
            "end_handle",
            "client->svc_chngd_data"
          ],
          "line": 1578
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gatt_db_clear_range",
          "args": [
            "client->db",
            "start_handle",
            "end_handle"
          ],
          "line": 1573
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_clear_range",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "457-483",
          "snippet": "bool gatt_db_clear_range(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct clear_range range;\n\n\tif (!db || start_handle > end_handle)\n\t\treturn false;\n\n\t/* Check if it is a full clear */\n\tif (start_handle == 1 && end_handle == UINT16_MAX) {\n\t\tqueue_remove_all(db->services, NULL, NULL,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\t\tgoto done;\n\t}\n\n\trange.start = start_handle;\n\trange.end = end_handle;\n\n\tqueue_remove_all(db->services, match_range, &range,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\ndone:\n\tif (gatt_db_isempty(db))\n\t\tdb->next_handle = 0;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_clear_range(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct clear_range range;\n\n\tif (!db || start_handle > end_handle)\n\t\treturn false;\n\n\t/* Check if it is a full clear */\n\tif (start_handle == 1 && end_handle == UINT16_MAX) {\n\t\tqueue_remove_all(db->services, NULL, NULL,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\t\tgoto done;\n\t}\n\n\trange.start = start_handle;\n\trange.end = end_handle;\n\n\tqueue_remove_all(db->services, match_range, &range,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\ndone:\n\tif (gatt_db_isempty(db))\n\t\tdb->next_handle = 0;\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);\n\nstatic void service_changed_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tstruct service_changed_op *next_sc_op;\n\tuint16_t start_handle = op->start;\n\tuint16_t end_handle = op->end;\n\tconst struct queue_entry *entry;\n\n\tclient->in_svc_chngd = false;\n\n\tif (!success && att_ecode != BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND) {\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Failed to discover services within changed range - \"\n\t\t\t\"error: 0x%02x\", att_ecode);\n\n\t\tgatt_db_clear_range(client->db, start_handle, end_handle);\n\t}\n\n\t/* Notify the upper layer of changed services */\n\tif (client->svc_chngd_callback)\n\t\tclient->svc_chngd_callback(start_handle, end_handle,\n\t\t\t\t\t\t\tclient->svc_chngd_data);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tif (clone->svc_chngd_callback)\n\t\t\tclone->svc_chngd_callback(start_handle, end_handle,\n\t\t\t\t\t\t\tclone->svc_chngd_data);\n\t}\n\n\t/* Process any queued events */\n\tnext_sc_op = queue_pop_head(client->svc_chngd_queue);\n\tif (next_sc_op) {\n\t\tprocess_service_changed(client, next_sc_op->start_handle,\n\t\t\t\t\t\t\tnext_sc_op->end_handle);\n\t\tfree(next_sc_op);\n\t\treturn;\n\t}\n\n\tif (register_service_changed(client))\n\t\treturn;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\"Failed to re-register handler for \\\"Service Changed\\\"\");\n}"
  },
  {
    "function_name": "register_service_changed",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1528-1555",
    "snippet": "static bool register_service_changed(struct bt_gatt_client *client)\n{\n\tbt_uuid_t uuid;\n\tstruct gatt_db_attribute *attr = NULL;\n\n\tbt_uuid16_create(&uuid, SVC_CHNGD_UUID);\n\n\tif (client->svc_chngd_ind_id)\n\t\treturn true;\n\n\tgatt_db_find_by_type(client->db, 0x0001, 0xffff, &uuid,\n\t\t\t\t\t\tget_first_attribute, &attr);\n\tif (!attr)\n\t\treturn true;\n\n\t/*\n\t * Register an indication handler for the \"Service Changed\"\n\t * characteristic and report ready only if the handler is registered\n\t * successfully.\n\t */\n\tclient->svc_chngd_ind_id = register_notify(client,\n\t\t\t\t\tgatt_db_attribute_get_handle(attr),\n\t\t\t\t\tservice_changed_register_cb,\n\t\t\t\t\tservice_changed_cb,\n\t\t\t\t\tclient, NULL);\n\n\treturn client->svc_chngd_ind_id ? true : false;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define SVC_CHNGD_UUID\t0x2a05"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "register_notify",
          "args": [
            "client",
            "gatt_db_attribute_get_handle(attr)",
            "service_changed_register_cb",
            "service_changed_cb",
            "client",
            "NULL"
          ],
          "line": 1548
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_register_notify",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "3237-3252",
          "snippet": "unsigned int bt_gatt_client_register_notify(struct bt_gatt_client *client,\n\t\t\t\tuint16_t chrc_value_handle,\n\t\t\t\tbt_gatt_client_register_callback_t callback,\n\t\t\t\tbt_gatt_client_notify_callback_t notify,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tif (!client || !client->db || !chrc_value_handle || !callback)\n\t\treturn 0;\n\n\tif (client->in_svc_chngd)\n\t\treturn 0;\n\n\treturn register_notify(client, chrc_value_handle, callback, notify,\n\t\t\t\t\t\t\tuser_data, destroy);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_register_notify(struct bt_gatt_client *client,\n\t\t\t\tuint16_t chrc_value_handle,\n\t\t\t\tbt_gatt_client_register_callback_t callback,\n\t\t\t\tbt_gatt_client_notify_callback_t notify,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tif (!client || !client->db || !chrc_value_handle || !callback)\n\t\treturn 0;\n\n\tif (client->in_svc_chngd)\n\t\treturn 0;\n\n\treturn register_notify(client, chrc_value_handle, callback, notify,\n\t\t\t\t\t\t\tuser_data, destroy);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 1549
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_find_by_type",
          "args": [
            "client->db",
            "0x0001",
            "0xffff",
            "&uuid",
            "get_first_attribute",
            "&attr"
          ],
          "line": 1538
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_find_by_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1114-1133",
          "snippet": "unsigned int gatt_db_find_by_type(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\tuint16_t end_handle,\n\t\t\t\t\t\tconst bt_uuid_t *type,\n\t\t\t\t\t\tgatt_db_attribute_cb_t func,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct find_by_type_value_data data;\n\n\tmemset(&data, 0, sizeof(data));\n\n\tdata.uuid = *type;\n\tdata.start_handle = start_handle;\n\tdata.end_handle = end_handle;\n\tdata.func = func;\n\tdata.user_data = user_data;\n\n\tqueue_foreach(db->services, find_by_type, &data);\n\n\treturn data.num_of_res;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nunsigned int gatt_db_find_by_type(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\tuint16_t end_handle,\n\t\t\t\t\t\tconst bt_uuid_t *type,\n\t\t\t\t\t\tgatt_db_attribute_cb_t func,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct find_by_type_value_data data;\n\n\tmemset(&data, 0, sizeof(data));\n\n\tdata.uuid = *type;\n\tdata.start_handle = start_handle;\n\tdata.end_handle = end_handle;\n\tdata.func = func;\n\tdata.user_data = user_data;\n\n\tqueue_foreach(db->services, find_by_type, &data);\n\n\treturn data.num_of_res;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid16_create",
          "args": [
            "&uuid",
            "SVC_CHNGD_UUID"
          ],
          "line": 1533
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\n#define SVC_CHNGD_UUID\t0x2a05\n\nstatic bool register_service_changed(struct bt_gatt_client *client)\n{\n\tbt_uuid_t uuid;\n\tstruct gatt_db_attribute *attr = NULL;\n\n\tbt_uuid16_create(&uuid, SVC_CHNGD_UUID);\n\n\tif (client->svc_chngd_ind_id)\n\t\treturn true;\n\n\tgatt_db_find_by_type(client->db, 0x0001, 0xffff, &uuid,\n\t\t\t\t\t\tget_first_attribute, &attr);\n\tif (!attr)\n\t\treturn true;\n\n\t/*\n\t * Register an indication handler for the \"Service Changed\"\n\t * characteristic and report ready only if the handler is registered\n\t * successfully.\n\t */\n\tclient->svc_chngd_ind_id = register_notify(client,\n\t\t\t\t\tgatt_db_attribute_get_handle(attr),\n\t\t\t\t\tservice_changed_register_cb,\n\t\t\t\t\tservice_changed_cb,\n\t\t\t\t\tclient, NULL);\n\n\treturn client->svc_chngd_ind_id ? true : false;\n}"
  },
  {
    "function_name": "service_changed_register_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1505-1526",
    "snippet": "static void service_changed_register_cb(uint16_t att_ecode, void *user_data)\n{\n\tbool success;\n\tstruct bt_gatt_client *client = user_data;\n\n\tif (att_ecode) {\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Failed to register handler for \\\"Service Changed\\\"\");\n\t\tsuccess = false;\n\t\tclient->svc_chngd_ind_id = 0;\n\t\tgoto done;\n\t}\n\n\tclient->svc_chngd_registered = true;\n\tsuccess = true;\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Registered handler for \\\"Service Changed\\\": %u\",\n\t\t\tclient->svc_chngd_ind_id);\n\ndone:\n\tnotify_client_ready(client, success, att_ecode);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "notify_client_ready",
          "args": [
            "client",
            "success",
            "att_ecode"
          ],
          "line": 1525
        },
        "resolved": true,
        "details": {
          "function_name": "notify_client_ready",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1221-1250",
          "snippet": "static void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Registered handler for \\\"Service Changed\\\": %u\"",
            "client->svc_chngd_ind_id"
          ],
          "line": 1520
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void service_changed_register_cb(uint16_t att_ecode, void *user_data)\n{\n\tbool success;\n\tstruct bt_gatt_client *client = user_data;\n\n\tif (att_ecode) {\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Failed to register handler for \\\"Service Changed\\\"\");\n\t\tsuccess = false;\n\t\tclient->svc_chngd_ind_id = 0;\n\t\tgoto done;\n\t}\n\n\tclient->svc_chngd_registered = true;\n\tsuccess = true;\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Registered handler for \\\"Service Changed\\\": %u\",\n\t\t\tclient->svc_chngd_ind_id);\n\ndone:\n\tnotify_client_ready(client, success, att_ecode);\n}"
  },
  {
    "function_name": "get_first_attribute",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1494-1503",
    "snippet": "static void get_first_attribute(struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct gatt_db_attribute **stored = user_data;\n\n\tif (*stored)\n\t\treturn;\n\n\t*stored = attrib;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void get_first_attribute(struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct gatt_db_attribute **stored = user_data;\n\n\tif (*stored)\n\t\treturn;\n\n\t*stored = attrib;\n}"
  },
  {
    "function_name": "register_notify",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1418-1492",
    "snippet": "static unsigned int register_notify(struct bt_gatt_client *client,\n\t\t\t\tuint16_t handle,\n\t\t\t\tbt_gatt_client_register_callback_t callback,\n\t\t\t\tbt_gatt_client_notify_callback_t notify,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct notify_data *notify_data;\n\tstruct notify_chrc *chrc = NULL;\n\n\t/* Check if a characteristic ref count has been started already */\n\tchrc = queue_find(client->notify_chrcs, match_notify_chrc_value_handle,\n\t\t\t\t\t\tUINT_TO_PTR(handle));\n\n\tif (!chrc) {\n\t\t/*\n\t\t * Create an entry if the characteristic is known and has a CCC\n\t\t * descriptor.\n\t\t */\n\t\tchrc = notify_chrc_create(client, handle);\n\t\tif (!chrc)\n\t\t\treturn 0;\n\t}\n\n\t/* Fail if we've hit the maximum allowed notify sessions */\n\tif (chrc->notify_count == INT_MAX)\n\t\treturn 0;\n\n\tnotify_data = new0(struct notify_data, 1);\n\tnotify_data->client = client;\n\tnotify_data->ref_count = 1;\n\tnotify_data->chrc = chrc;\n\tnotify_data->callback = callback;\n\tnotify_data->notify = notify;\n\tnotify_data->user_data = user_data;\n\tnotify_data->destroy = destroy;\n\n\t/* Add the handler to the bt_gatt_client's general list */\n\tqueue_push_tail(client->notify_list, notify_data);\n\n\t/* Assign an ID to the handler. */\n\tif (client->next_reg_id < 1)\n\t\tclient->next_reg_id = 1;\n\n\tnotify_data->id = client->next_reg_id++;\n\n\t/* Increment the per-characteristic ref count of notify handlers */\n\t__sync_fetch_and_add(&notify_data->chrc->notify_count, 1);\n\n\t/*\n\t * If a write to the CCC descriptor is in progress, then queue this\n\t * request.\n\t */\n\tif (chrc->ccc_write_id) {\n\t\tqueue_push_tail(chrc->reg_notify_queue, notify_data);\n\t\treturn notify_data->id;\n\t}\n\n\t/*\n\t * If the ref count > 1, then notifications are already enabled.\n\t */\n\tif (chrc->notify_count > 1 || !chrc->ccc_handle) {\n\t\tcomplete_notify_request(notify_data);\n\t\treturn notify_data->id;\n\t}\n\n\t/* Write to the CCC descriptor */\n\tif (!notify_data_write_ccc(notify_data, true, enable_ccc_callback)) {\n\t\tqueue_remove(client->notify_list, notify_data);\n\t\tfree(notify_data);\n\t\treturn 0;\n\t}\n\n\treturn notify_data->id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "notify_data"
          ],
          "line": 1487
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "client->notify_list",
            "notify_data"
          ],
          "line": 1486
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "notify_data_write_ccc",
          "args": [
            "notify_data",
            "true",
            "enable_ccc_callback"
          ],
          "line": 1485
        },
        "resolved": true,
        "details": {
          "function_name": "notify_data_write_ccc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1324-1355",
          "snippet": "static bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "complete_notify_request",
          "args": [
            "notify_data"
          ],
          "line": 1480
        },
        "resolved": true,
        "details": {
          "function_name": "complete_notify_request",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1314-1322",
          "snippet": "static void complete_notify_request(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tnotify_data->att_id = 0;\n\n\tif (notify_data->callback)\n\t\tnotify_data->callback(0, notify_data->user_data);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void complete_notify_request(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tnotify_data->att_id = 0;\n\n\tif (notify_data->callback)\n\t\tnotify_data->callback(0, notify_data->user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "chrc->reg_notify_queue",
            "notify_data"
          ],
          "line": 1472
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&notify_data->chrc->notify_count",
            "1"
          ],
          "line": 1465
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structnotify_data",
            "1"
          ],
          "line": 1446
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "notify_chrc_create",
          "args": [
            "client",
            "handle"
          ],
          "line": 1437
        },
        "resolved": true,
        "details": {
          "function_name": "notify_chrc_create",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "236-281",
          "snippet": "static struct notify_chrc *notify_chrc_create(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t value_handle)\n{\n\tstruct gatt_db_attribute *attr, *ccc;\n\tstruct notify_chrc *chrc;\n\tbt_uuid_t uuid;\n\tuint8_t properties;\n\n\t/* Check that chrc_value_handle belongs to a known characteristic */\n\tattr = gatt_db_get_attribute(client->db, value_handle - 1);\n\tif (!attr)\n\t\treturn NULL;\n\n\tbt_uuid16_create(&uuid, GATT_CHARAC_UUID);\n\tif (bt_uuid_cmp(&uuid, gatt_db_attribute_get_type(attr)))\n\t\treturn NULL;\n\n\tif (!gatt_db_attribute_get_char_data(attr, NULL, NULL, &properties,\n\t\t\t\t\t\t\t\tNULL, NULL))\n\t\treturn NULL;\n\n\tchrc = new0(struct notify_chrc, 1);\n\n\tchrc->reg_notify_queue = queue_new();\n\tif (!chrc->reg_notify_queue) {\n\t\tfree(chrc);\n\t\treturn NULL;\n\t}\n\n\t/*\n\t * Find the CCC characteristic. Some characteristics that allow\n\t * notifications may not have a CCC descriptor. We treat these as\n\t * automatically successful.\n\t */\n\tccc = NULL;\n\tgatt_db_service_foreach_desc(attr, find_ccc, &ccc);\n\tif (ccc)\n\t\tchrc->ccc_handle = gatt_db_attribute_get_handle(ccc);\n\n\tchrc->value_handle = value_handle;\n\tchrc->properties = properties;\n\n\tqueue_push_tail(client->notify_chrcs, chrc);\n\n\treturn chrc;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct notify_chrc *notify_chrc_create(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t value_handle)\n{\n\tstruct gatt_db_attribute *attr, *ccc;\n\tstruct notify_chrc *chrc;\n\tbt_uuid_t uuid;\n\tuint8_t properties;\n\n\t/* Check that chrc_value_handle belongs to a known characteristic */\n\tattr = gatt_db_get_attribute(client->db, value_handle - 1);\n\tif (!attr)\n\t\treturn NULL;\n\n\tbt_uuid16_create(&uuid, GATT_CHARAC_UUID);\n\tif (bt_uuid_cmp(&uuid, gatt_db_attribute_get_type(attr)))\n\t\treturn NULL;\n\n\tif (!gatt_db_attribute_get_char_data(attr, NULL, NULL, &properties,\n\t\t\t\t\t\t\t\tNULL, NULL))\n\t\treturn NULL;\n\n\tchrc = new0(struct notify_chrc, 1);\n\n\tchrc->reg_notify_queue = queue_new();\n\tif (!chrc->reg_notify_queue) {\n\t\tfree(chrc);\n\t\treturn NULL;\n\t}\n\n\t/*\n\t * Find the CCC characteristic. Some characteristics that allow\n\t * notifications may not have a CCC descriptor. We treat these as\n\t * automatically successful.\n\t */\n\tccc = NULL;\n\tgatt_db_service_foreach_desc(attr, find_ccc, &ccc);\n\tif (ccc)\n\t\tchrc->ccc_handle = gatt_db_attribute_get_handle(ccc);\n\n\tchrc->value_handle = value_handle;\n\tchrc->properties = properties;\n\n\tqueue_push_tail(client->notify_chrcs, chrc);\n\n\treturn chrc;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_find",
          "args": [
            "client->notify_chrcs",
            "match_notify_chrc_value_handle",
            "UINT_TO_PTR(handle)"
          ],
          "line": 1429
        },
        "resolved": true,
        "details": {
          "function_name": "queue_find",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "231-247",
          "snippet": "void *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "handle"
          ],
          "line": 1430
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic unsigned int register_notify(struct bt_gatt_client *client,\n\t\t\t\tuint16_t handle,\n\t\t\t\tbt_gatt_client_register_callback_t callback,\n\t\t\t\tbt_gatt_client_notify_callback_t notify,\n\t\t\t\tvoid *user_data,\n\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct notify_data *notify_data;\n\tstruct notify_chrc *chrc = NULL;\n\n\t/* Check if a characteristic ref count has been started already */\n\tchrc = queue_find(client->notify_chrcs, match_notify_chrc_value_handle,\n\t\t\t\t\t\tUINT_TO_PTR(handle));\n\n\tif (!chrc) {\n\t\t/*\n\t\t * Create an entry if the characteristic is known and has a CCC\n\t\t * descriptor.\n\t\t */\n\t\tchrc = notify_chrc_create(client, handle);\n\t\tif (!chrc)\n\t\t\treturn 0;\n\t}\n\n\t/* Fail if we've hit the maximum allowed notify sessions */\n\tif (chrc->notify_count == INT_MAX)\n\t\treturn 0;\n\n\tnotify_data = new0(struct notify_data, 1);\n\tnotify_data->client = client;\n\tnotify_data->ref_count = 1;\n\tnotify_data->chrc = chrc;\n\tnotify_data->callback = callback;\n\tnotify_data->notify = notify;\n\tnotify_data->user_data = user_data;\n\tnotify_data->destroy = destroy;\n\n\t/* Add the handler to the bt_gatt_client's general list */\n\tqueue_push_tail(client->notify_list, notify_data);\n\n\t/* Assign an ID to the handler. */\n\tif (client->next_reg_id < 1)\n\t\tclient->next_reg_id = 1;\n\n\tnotify_data->id = client->next_reg_id++;\n\n\t/* Increment the per-characteristic ref count of notify handlers */\n\t__sync_fetch_and_add(&notify_data->chrc->notify_count, 1);\n\n\t/*\n\t * If a write to the CCC descriptor is in progress, then queue this\n\t * request.\n\t */\n\tif (chrc->ccc_write_id) {\n\t\tqueue_push_tail(chrc->reg_notify_queue, notify_data);\n\t\treturn notify_data->id;\n\t}\n\n\t/*\n\t * If the ref count > 1, then notifications are already enabled.\n\t */\n\tif (chrc->notify_count > 1 || !chrc->ccc_handle) {\n\t\tcomplete_notify_request(notify_data);\n\t\treturn notify_data->id;\n\t}\n\n\t/* Write to the CCC descriptor */\n\tif (!notify_data_write_ccc(notify_data, true, enable_ccc_callback)) {\n\t\tqueue_remove(client->notify_list, notify_data);\n\t\tfree(notify_data);\n\t\treturn 0;\n\t}\n\n\treturn notify_data->id;\n}"
  },
  {
    "function_name": "match_notify_chrc_value_handle",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1410-1416",
    "snippet": "static bool match_notify_chrc_value_handle(const void *a, const void *b)\n{\n\tconst struct notify_chrc *chrc = a;\n\tuint16_t value_handle = PTR_TO_UINT(b);\n\n\treturn chrc->value_handle == value_handle;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "PTR_TO_UINT",
          "args": [
            "b"
          ],
          "line": 1413
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool match_notify_chrc_value_handle(const void *a, const void *b)\n{\n\tconst struct notify_chrc *chrc = a;\n\tuint16_t value_handle = PTR_TO_UINT(b);\n\n\treturn chrc->value_handle == value_handle;\n}"
  },
  {
    "function_name": "enable_ccc_callback",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1369-1408",
    "snippet": "static void enable_ccc_callback(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct notify_data *notify_data = user_data;\n\tuint8_t att_ecode;\n\n\tassert(notify_data->chrc->ccc_write_id);\n\n\tnotify_data->chrc->ccc_write_id = 0;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tatt_ecode = process_error(pdu, length);\n\n\t\t/* Failed to enable. Complete the current request and move on to\n\t\t * the next one in the queue. If there was an error sending the\n\t\t * write request, then just move on to the next queued entry.\n\t\t */\n\t\tqueue_remove(notify_data->client->notify_list, notify_data);\n\t\tnotify_data->callback(att_ecode, notify_data->user_data);\n\n\t\twhile ((notify_data = queue_pop_head(\n\t\t\t\t\tnotify_data->chrc->reg_notify_queue))) {\n\n\t\t\tif (notify_data_write_ccc(notify_data, true,\n\t\t\t\t\t\t\tenable_ccc_callback))\n\t\t\t\treturn;\n\t\t}\n\n\t\treturn;\n\t}\n\n\t/* Success! Report success for all remaining requests. */\n\tbt_gatt_client_ref(notify_data->client);\n\n\tcomplete_notify_request(notify_data);\n\tqueue_remove_all(notify_data->chrc->reg_notify_queue, NULL, NULL,\n\t\t\t\t\t\tcomplete_notify_request);\n\n\tbt_gatt_client_unref(notify_data->client);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_client_unref",
          "args": [
            "notify_data->client"
          ],
          "line": 1407
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2004-2013",
          "snippet": "void bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nvoid bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_all",
          "args": [
            "notify_data->chrc->reg_notify_queue",
            "NULL",
            "NULL",
            "complete_notify_request"
          ],
          "line": 1404
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "318-362",
          "snippet": "unsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}"
        }
      },
      {
        "call_info": {
          "callee": "complete_notify_request",
          "args": [
            "notify_data"
          ],
          "line": 1403
        },
        "resolved": true,
        "details": {
          "function_name": "complete_notify_request",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1314-1322",
          "snippet": "static void complete_notify_request(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tnotify_data->att_id = 0;\n\n\tif (notify_data->callback)\n\t\tnotify_data->callback(0, notify_data->user_data);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void complete_notify_request(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tnotify_data->att_id = 0;\n\n\tif (notify_data->callback)\n\t\tnotify_data->callback(0, notify_data->user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_client_ref",
          "args": [
            "notify_data->client"
          ],
          "line": 1401
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1994-2002",
          "snippet": "struct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}"
        }
      },
      {
        "call_info": {
          "callee": "notify_data_write_ccc",
          "args": [
            "notify_data",
            "true",
            "enable_ccc_callback"
          ],
          "line": 1392
        },
        "resolved": true,
        "details": {
          "function_name": "notify_data_write_ccc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1324-1355",
          "snippet": "static bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "notify_data->chrc->reg_notify_queue"
          ],
          "line": 1389
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "notify_data->callback",
          "args": [
            "att_ecode",
            "notify_data->user_data"
          ],
          "line": 1387
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "notify_data->client->notify_list",
            "notify_data"
          ],
          "line": 1386
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_error",
          "args": [
            "pdu",
            "length"
          ],
          "line": 1380
        },
        "resolved": true,
        "details": {
          "function_name": "process_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1357-1367",
          "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
        }
      },
      {
        "call_info": {
          "callee": "assert",
          "args": [
            "notify_data->chrc->ccc_write_id"
          ],
          "line": 1375
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void enable_ccc_callback(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct notify_data *notify_data = user_data;\n\tuint8_t att_ecode;\n\n\tassert(notify_data->chrc->ccc_write_id);\n\n\tnotify_data->chrc->ccc_write_id = 0;\n\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\tatt_ecode = process_error(pdu, length);\n\n\t\t/* Failed to enable. Complete the current request and move on to\n\t\t * the next one in the queue. If there was an error sending the\n\t\t * write request, then just move on to the next queued entry.\n\t\t */\n\t\tqueue_remove(notify_data->client->notify_list, notify_data);\n\t\tnotify_data->callback(att_ecode, notify_data->user_data);\n\n\t\twhile ((notify_data = queue_pop_head(\n\t\t\t\t\tnotify_data->chrc->reg_notify_queue))) {\n\n\t\t\tif (notify_data_write_ccc(notify_data, true,\n\t\t\t\t\t\t\tenable_ccc_callback))\n\t\t\t\treturn;\n\t\t}\n\n\t\treturn;\n\t}\n\n\t/* Success! Report success for all remaining requests. */\n\tbt_gatt_client_ref(notify_data->client);\n\n\tcomplete_notify_request(notify_data);\n\tqueue_remove_all(notify_data->chrc->reg_notify_queue, NULL, NULL,\n\t\t\t\t\t\tcomplete_notify_request);\n\n\tbt_gatt_client_unref(notify_data->client);\n}"
  },
  {
    "function_name": "process_error",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1357-1367",
    "snippet": "static uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic uint8_t process_error(const void *pdu, uint16_t length)\n{\n\tconst struct bt_att_pdu_error_rsp *error_pdu;\n\n\tif (!pdu || length != sizeof(struct bt_att_pdu_error_rsp))\n\t\treturn 0;\n\n\terror_pdu = pdu;\n\n\treturn error_pdu->ecode;\n}"
  },
  {
    "function_name": "notify_data_write_ccc",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1324-1355",
    "snippet": "static bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "notify_data->client->att",
            "BT_ATT_OP_WRITE_REQ",
            "pdu",
            "sizeof(pdu)",
            "callback",
            "notify_data_ref(notify_data)",
            "notify_data_unref"
          ],
          "line": 1348
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "notify_data_ref",
          "args": [
            "notify_data"
          ],
          "line": 1350
        },
        "resolved": true,
        "details": {
          "function_name": "notify_data_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "200-205",
          "snippet": "static struct notify_data *notify_data_ref(struct notify_data *notify_data)\n{\n\t__sync_fetch_and_add(&notify_data->ref_count, 1);\n\n\treturn notify_data;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct notify_data *notify_data_ref(struct notify_data *notify_data)\n{\n\t__sync_fetch_and_add(&notify_data->ref_count, 1);\n\n\treturn notify_data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "notify_data->chrc->ccc_handle",
            "pdu"
          ],
          "line": 1332
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "pdu",
            "0",
            "sizeof(pdu)"
          ],
          "line": 1331
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "assert",
          "args": [
            "notify_data->chrc->ccc_handle"
          ],
          "line": 1330
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}"
  },
  {
    "function_name": "complete_notify_request",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1314-1322",
    "snippet": "static void complete_notify_request(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tnotify_data->att_id = 0;\n\n\tif (notify_data->callback)\n\t\tnotify_data->callback(0, notify_data->user_data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "notify_data->callback",
          "args": [
            "0",
            "notify_data->user_data"
          ],
          "line": 1321
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void complete_notify_request(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tnotify_data->att_id = 0;\n\n\tif (notify_data->callback)\n\t\tnotify_data->callback(0, notify_data->user_data);\n}"
  },
  {
    "function_name": "exchange_mtu_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1252-1300",
    "snippet": "static void exchange_mtu_cb(bool success, uint8_t att_ecode, void *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\n\top->success = success;\n\tclient->mtu_req_id = 0;\n\n\tif (!success) {\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"MTU Exchange failed. ATT ECODE: 0x%02x\",\n\t\t\t\tatt_ecode);\n\n\t\t/*\n\t\t * BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part G] page 546\n\t\t * If the Error Response is sent by the server with the Error\n\t\t * Code set to RequestNot Supported , the Attribute Opcode is\n\t\t * not supported and the default MTU shall be used.\n\t\t */\n\t\tif (att_ecode == BT_ATT_ERROR_REQUEST_NOT_SUPPORTED)\n\t\t\tgoto discover;\n\n\t\tclient->in_init = false;\n\t\tnotify_client_ready(client, success, att_ecode);\n\n\t\treturn;\n\t}\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"MTU exchange complete, with MTU: %u\",\n\t\t\t\t\tbt_att_get_mtu(client->att));\n\ndiscover:\n\tclient->discovery_req = bt_gatt_discover_all_primary_services(\n\t\t\t\t\t\t\tclient->att, NULL,\n\t\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req)\n\t\treturn;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Failed to initiate primary service discovery\");\n\n\tclient->in_init = false;\n\tnotify_client_ready(client, false, att_ecode);\n\n\tdiscovery_op_unref(op);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_unref",
          "args": [
            "op"
          ],
          "line": 1299
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "453-464",
          "snippet": "static void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "notify_client_ready",
          "args": [
            "client",
            "false",
            "att_ecode"
          ],
          "line": 1297
        },
        "resolved": true,
        "details": {
          "function_name": "notify_client_ready",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1221-1250",
          "snippet": "static void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Failed to initiate primary service discovery\""
          ],
          "line": 1293
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_discover_all_primary_services",
          "args": [
            "client->att",
            "NULL",
            "discover_primary_cb",
            "discovery_op_ref(op)",
            "discovery_op_unref"
          ],
          "line": 1285
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_discover_all_primary_services",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "873-882",
          "snippet": "struct bt_gatt_request *bt_gatt_discover_all_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn bt_gatt_discover_primary_services(att, uuid, 0x0001, 0xffff,\n\t\t\t\t\t\t\tcallback, user_data,\n\t\t\t\t\t\t\tdestroy);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_all_primary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn bt_gatt_discover_primary_services(att, uuid, 0x0001, 0xffff,\n\t\t\t\t\t\t\tcallback, user_data,\n\t\t\t\t\t\t\tdestroy);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_ref",
          "args": [
            "op"
          ],
          "line": 1288
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "446-451",
          "snippet": "static struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "client->att"
          ],
          "line": 1282
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void exchange_mtu_cb(bool success, uint8_t att_ecode, void *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\n\top->success = success;\n\tclient->mtu_req_id = 0;\n\n\tif (!success) {\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"MTU Exchange failed. ATT ECODE: 0x%02x\",\n\t\t\t\tatt_ecode);\n\n\t\t/*\n\t\t * BLUETOOTH SPECIFICATION Version 4.2 [Vol 3, Part G] page 546\n\t\t * If the Error Response is sent by the server with the Error\n\t\t * Code set to RequestNot Supported , the Attribute Opcode is\n\t\t * not supported and the default MTU shall be used.\n\t\t */\n\t\tif (att_ecode == BT_ATT_ERROR_REQUEST_NOT_SUPPORTED)\n\t\t\tgoto discover;\n\n\t\tclient->in_init = false;\n\t\tnotify_client_ready(client, success, att_ecode);\n\n\t\treturn;\n\t}\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"MTU exchange complete, with MTU: %u\",\n\t\t\t\t\tbt_att_get_mtu(client->att));\n\ndiscover:\n\tclient->discovery_req = bt_gatt_discover_all_primary_services(\n\t\t\t\t\t\t\tclient->att, NULL,\n\t\t\t\t\t\t\tdiscover_primary_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req)\n\t\treturn;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\"Failed to initiate primary service discovery\");\n\n\tclient->in_init = false;\n\tnotify_client_ready(client, false, att_ecode);\n\n\tdiscovery_op_unref(op);\n}"
  },
  {
    "function_name": "notify_client_ready",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1221-1250",
    "snippet": "static void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_client_unref",
          "args": [
            "client"
          ],
          "line": 1249
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2004-2013",
          "snippet": "void bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nvoid bt_gatt_client_unref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&client->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_client_free(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "notify_client_ready",
          "args": [
            "clone",
            "success",
            "att_ecode"
          ],
          "line": 1246
        },
        "resolved": true,
        "details": {
          "function_name": "notify_client_ready",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1221-1250",
          "snippet": "static void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}",
          "note": "cyclic_reference_detected"
        }
      },
      {
        "call_info": {
          "callee": "queue_get_entries",
          "args": [
            "client->clones"
          ],
          "line": 1242
        },
        "resolved": true,
        "details": {
          "function_name": "queue_get_entries",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "364-370",
          "snippet": "const struct queue_entry *queue_get_entries(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn NULL;\n\n\treturn queue->head;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nconst struct queue_entry *queue_get_entries(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn NULL;\n\n\treturn queue->head;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_all",
          "args": [
            "client->ready_cbs",
            "NULL",
            "NULL",
            "ready_destroy"
          ],
          "line": 1239
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "318-362",
          "snippet": "unsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}"
        }
      },
      {
        "call_info": {
          "callee": "ready->callback",
          "args": [
            "success",
            "att_ecode",
            "ready->data"
          ],
          "line": 1236
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_client_ref",
          "args": [
            "client"
          ],
          "line": 1229
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1994-2002",
          "snippet": "struct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstruct bt_gatt_client *bt_gatt_client_ref(struct bt_gatt_client *client)\n{\n\tif (!client)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&client->ref_count, 1);\n\n\treturn client;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}"
  },
  {
    "function_name": "ready_destroy",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1211-1219",
    "snippet": "static void ready_destroy(void *data)\n{\n\tstruct ready_cb *ready = data;\n\n\tif (ready->destroy)\n\t\tready->destroy(ready->data);\n\n\tfree(ready);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "ready"
          ],
          "line": 1218
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "ready->destroy",
          "args": [
            "ready->data"
          ],
          "line": 1216
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void ready_destroy(void *data)\n{\n\tstruct ready_cb *ready = data;\n\n\tif (ready->destroy)\n\t\tready->destroy(ready->data);\n\n\tfree(ready);\n}"
  },
  {
    "function_name": "discover_primary_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1114-1209",
    "snippet": "static void discover_primary_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tstruct bt_gatt_iter iter;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t start, end;\n\tuint128_t u128;\n\tbt_uuid_t uuid;\n\tchar uuid_str[MAX_LEN_UUID_STR];\n\n\tdiscovery_req_clear(client);\n\n\tif (!success) {\n\t\t/* Reset error in case of not found */\n\t\tswitch (att_ecode) {\n\t\tcase BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND:\n\t\t\tsuccess = true;\n\t\t\tatt_ecode = 0;\n\t\t\tgoto secondary;\n\t\tdefault:\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Primary service discovery failed.\"\n\t\t\t\t\t\" ATT ECODE: 0x%02x\", att_ecode);\n\t\t\tgoto done;\n\t\t}\n\t}\n\n\tif (!result || !bt_gatt_iter_init(&iter, result)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Primary services found: %u\",\n\t\t\t\t\tbt_gatt_result_service_count(result));\n\n\twhile (bt_gatt_iter_next_service(&iter, &start, &end, u128.data)) {\n\t\tbt_uuid128_create(&uuid, u128);\n\n\t\t/* Log debug message. */\n\t\tbt_uuid_to_string(&uuid, uuid_str, sizeof(uuid_str));\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"start: 0x%04x, end: 0x%04x, uuid: %s\",\n\t\t\t\tstart, end, uuid_str);\n\n\t\tattr = gatt_db_insert_service(client->db, start, &uuid, true,\n\t\t\t\t\t\t\tend - start + 1);\n\t\tif (!attr) {\n\t\t\tgatt_db_clear_range(client->db, start, end);\n\t\t\tattr = gatt_db_insert_service(client->db, start, &uuid,\n\t\t\t\t\t\t\ttrue, end - start + 1);\n\t\t\tif (!attr) {\n\t\t\t\tutil_debug(client->debug_callback,\n\t\t\t\t\t\tclient->debug_data,\n\t\t\t\t\t\t\"Failed to store service\");\n\t\t\t\tsuccess = false;\n\t\t\t\tgoto done;\n\t\t\t}\n\t\t\t/* Database has changed adjust last handle */\n\t\t\top->last = end;\n\t\t}\n\n\t\t/* Update pending list */\n\t\tdiscovery_found_service(op, attr, start, end);\n\t}\n\nsecondary:\n\t/*\n\t * Version 4.2 [Vol 1, Part A] page 101:\n\t * A secondary service is a service that provides auxiliary\n\t * functionality of a device and is referenced from at least one\n\t * primary service on the device.\n\t */\n\tif (queue_isempty(op->pending_svcs))\n\t\tgoto done;\n\n\t/* Discover secondary services */\n\tclient->discovery_req = bt_gatt_discover_secondary_services(client->att,\n\t\t\t\t\t\tNULL, op->start, op->end,\n\t\t\t\t\t\tdiscover_secondary_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req)\n\t\treturn;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to start secondary service discovery\");\n\tdiscovery_op_unref(op);\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 1208
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "352-385",
          "snippet": "static void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_unref",
          "args": [
            "op"
          ],
          "line": 1204
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "453-464",
          "snippet": "static void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Failed to start secondary service discovery\""
          ],
          "line": 1202
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_discover_secondary_services",
          "args": [
            "client->att",
            "NULL",
            "op->start",
            "op->end",
            "discover_secondary_cb",
            "discovery_op_ref(op)",
            "discovery_op_unref"
          ],
          "line": 1194
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_discover_secondary_services",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "895-904",
          "snippet": "struct bt_gatt_request *bt_gatt_discover_secondary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn discover_services(att, uuid, start, end, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy, false);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_secondary_services(\n\t\t\t\t\tstruct bt_att *att, bt_uuid_t *uuid,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\treturn discover_services(att, uuid, start, end, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy, false);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_ref",
          "args": [
            "op"
          ],
          "line": 1197
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "446-451",
          "snippet": "static struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_isempty",
          "args": [
            "op->pending_svcs"
          ],
          "line": 1190
        },
        "resolved": true,
        "details": {
          "function_name": "queue_isempty",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "380-386",
          "snippet": "bool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_found_service",
          "args": [
            "op",
            "attr",
            "start",
            "end"
          ],
          "line": 1180
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_found_service",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "986-1012",
          "snippet": "static void discovery_found_service(struct discovery_op *op,\n\t\t\t\t\tstruct gatt_db_attribute *attr,\n\t\t\t\t\tuint16_t start, uint16_t end)\n{\n\t/* Skip if service already active */\n\tif (!gatt_db_service_get_active(attr)) {\n\t\t/* Skip if there are no attributes */\n\t\tif (end == start)\n\t\t\tgatt_db_service_set_active(attr, true);\n\t\telse\n\t\t\tqueue_push_tail(op->pending_svcs, attr);\n\n\t\tif (start < op->svc_first)\n\t\t\top->svc_first = start;\n\t\tif (end > op->svc_last)\n\t\t\top->svc_last = end;\n\t} else {\n\t\t/* Remove from pending if active */\n\t\tqueue_remove(op->pending_svcs, attr);\n\n\t\tremove_discov_range(op, start, end);\n\t}\n\n\t/* Update last handle */\n\tif (end > op->last)\n\t\top->last = end;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_found_service(struct discovery_op *op,\n\t\t\t\t\tstruct gatt_db_attribute *attr,\n\t\t\t\t\tuint16_t start, uint16_t end)\n{\n\t/* Skip if service already active */\n\tif (!gatt_db_service_get_active(attr)) {\n\t\t/* Skip if there are no attributes */\n\t\tif (end == start)\n\t\t\tgatt_db_service_set_active(attr, true);\n\t\telse\n\t\t\tqueue_push_tail(op->pending_svcs, attr);\n\n\t\tif (start < op->svc_first)\n\t\t\top->svc_first = start;\n\t\tif (end > op->svc_last)\n\t\t\top->svc_last = end;\n\t} else {\n\t\t/* Remove from pending if active */\n\t\tqueue_remove(op->pending_svcs, attr);\n\n\t\tremove_discov_range(op, start, end);\n\t}\n\n\t/* Update last handle */\n\tif (end > op->last)\n\t\top->last = end;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_insert_service",
          "args": [
            "client->db",
            "start",
            "&uuid",
            "true",
            "end - start + 1"
          ],
          "line": 1166
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_insert_service",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "518-581",
          "snippet": "struct gatt_db_attribute *gatt_db_insert_service(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle,\n\t\t\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\t\t\tbool primary,\n\t\t\t\t\t\t\tuint16_t num_handles)\n{\n\tstruct gatt_db_service *service, *after;\n\n\tafter = NULL;\n\n\tif (!db || handle < 1)\n\t\treturn NULL;\n\n\tif (num_handles < 1 || (handle + num_handles - 1) > UINT16_MAX)\n\t\treturn NULL;\n\n\tservice = find_insert_loc(db, handle, handle + num_handles - 1, &after);\n\tif (service) {\n\t\tconst bt_uuid_t *type;\n\t\tbt_uuid_t value;\n\n\t\tif (primary)\n\t\t\ttype = &primary_service_uuid;\n\t\telse\n\t\t\ttype = &secondary_service_uuid;\n\n\t\tgatt_db_attribute_get_service_uuid(service->attributes[0],\n\t\t\t\t\t\t\t\t\t&value);\n\n\t\t/* Check if service match */\n\t\tif (!bt_uuid_cmp(&service->attributes[0]->uuid, type) &&\n\t\t\t\t!bt_uuid_cmp(&value, uuid) &&\n\t\t\t\tservice->num_handles == num_handles &&\n\t\t\t\tservice->attributes[0]->handle == handle)\n\t\t\treturn service->attributes[0];\n\n\t\treturn NULL;\n\t}\n\n\tservice = gatt_db_service_create(uuid, handle, primary, num_handles);\n\n\tif (!service)\n\t\treturn NULL;\n\n\tif (after) {\n\t\tif (!queue_push_after(db->services, after, service))\n\t\t\tgoto fail;\n\t} else if (!queue_push_head(db->services, service)) {\n\t\tgoto fail;\n\t}\n\n\tservice->db = db;\n\tservice->attributes[0]->handle = handle;\n\tservice->num_handles = num_handles;\n\n\t/* Fast-forward next_handle if the new service was added to the end */\n\tdb->next_handle = MAX(handle + num_handles, db->next_handle);\n\n\treturn service->attributes[0];\n\nfail:\n\tgatt_db_service_destroy(service);\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const bt_uuid_t primary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_PRIM_SVC_UUID };",
            "static const bt_uuid_t secondary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_SND_SVC_UUID };"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstatic const bt_uuid_t primary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_PRIM_SVC_UUID };\nstatic const bt_uuid_t secondary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_SND_SVC_UUID };\n\nstruct gatt_db_attribute *gatt_db_insert_service(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle,\n\t\t\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\t\t\tbool primary,\n\t\t\t\t\t\t\tuint16_t num_handles)\n{\n\tstruct gatt_db_service *service, *after;\n\n\tafter = NULL;\n\n\tif (!db || handle < 1)\n\t\treturn NULL;\n\n\tif (num_handles < 1 || (handle + num_handles - 1) > UINT16_MAX)\n\t\treturn NULL;\n\n\tservice = find_insert_loc(db, handle, handle + num_handles - 1, &after);\n\tif (service) {\n\t\tconst bt_uuid_t *type;\n\t\tbt_uuid_t value;\n\n\t\tif (primary)\n\t\t\ttype = &primary_service_uuid;\n\t\telse\n\t\t\ttype = &secondary_service_uuid;\n\n\t\tgatt_db_attribute_get_service_uuid(service->attributes[0],\n\t\t\t\t\t\t\t\t\t&value);\n\n\t\t/* Check if service match */\n\t\tif (!bt_uuid_cmp(&service->attributes[0]->uuid, type) &&\n\t\t\t\t!bt_uuid_cmp(&value, uuid) &&\n\t\t\t\tservice->num_handles == num_handles &&\n\t\t\t\tservice->attributes[0]->handle == handle)\n\t\t\treturn service->attributes[0];\n\n\t\treturn NULL;\n\t}\n\n\tservice = gatt_db_service_create(uuid, handle, primary, num_handles);\n\n\tif (!service)\n\t\treturn NULL;\n\n\tif (after) {\n\t\tif (!queue_push_after(db->services, after, service))\n\t\t\tgoto fail;\n\t} else if (!queue_push_head(db->services, service)) {\n\t\tgoto fail;\n\t}\n\n\tservice->db = db;\n\tservice->attributes[0]->handle = handle;\n\tservice->num_handles = num_handles;\n\n\t/* Fast-forward next_handle if the new service was added to the end */\n\tdb->next_handle = MAX(handle + num_handles, db->next_handle);\n\n\treturn service->attributes[0];\n\nfail:\n\tgatt_db_service_destroy(service);\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_clear_range",
          "args": [
            "client->db",
            "start",
            "end"
          ],
          "line": 1165
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_clear_range",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "457-483",
          "snippet": "bool gatt_db_clear_range(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct clear_range range;\n\n\tif (!db || start_handle > end_handle)\n\t\treturn false;\n\n\t/* Check if it is a full clear */\n\tif (start_handle == 1 && end_handle == UINT16_MAX) {\n\t\tqueue_remove_all(db->services, NULL, NULL,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\t\tgoto done;\n\t}\n\n\trange.start = start_handle;\n\trange.end = end_handle;\n\n\tqueue_remove_all(db->services, match_range, &range,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\ndone:\n\tif (gatt_db_isempty(db))\n\t\tdb->next_handle = 0;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_clear_range(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct clear_range range;\n\n\tif (!db || start_handle > end_handle)\n\t\treturn false;\n\n\t/* Check if it is a full clear */\n\tif (start_handle == 1 && end_handle == UINT16_MAX) {\n\t\tqueue_remove_all(db->services, NULL, NULL,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\t\tgoto done;\n\t}\n\n\trange.start = start_handle;\n\trange.end = end_handle;\n\n\tqueue_remove_all(db->services, match_range, &range,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\ndone:\n\tif (gatt_db_isempty(db))\n\t\tdb->next_handle = 0;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_to_string",
          "args": [
            "&uuid",
            "uuid_str",
            "sizeof(uuid_str)"
          ],
          "line": 1157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid128_create",
          "args": [
            "&uuid",
            "u128"
          ],
          "line": 1154
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_iter_next_service",
          "args": [
            "&iter",
            "&start",
            "&end",
            "u128.data"
          ],
          "line": 1153
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_iter_next_service",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "325-364",
          "snippet": "bool bt_gatt_iter_next_service(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *start_handle, uint16_t *end_handle,\n\t\t\t\tuint8_t uuid[16])\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\tbt_uuid_t tmp;\n\n\tif (!iter || !iter->result || !start_handle || !end_handle || !uuid)\n\t\treturn false;\n\n\top = iter->result->op;\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\tswitch (iter->result->opcode) {\n\tcase BT_ATT_OP_READ_BY_GRP_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\t\tconvert_uuid_le(pdu_ptr + 4, iter->result->data_len - 4, uuid);\n\t\tbreak;\n\tcase BT_ATT_OP_FIND_BY_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\n\t\tbt_uuid_to_uuid128(&op->uuid, &tmp);\n\t\tmemcpy(uuid, tmp.value.u128.data, 16);\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_next_service(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *start_handle, uint16_t *end_handle,\n\t\t\t\tuint8_t uuid[16])\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\tbt_uuid_t tmp;\n\n\tif (!iter || !iter->result || !start_handle || !end_handle || !uuid)\n\t\treturn false;\n\n\top = iter->result->op;\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\tswitch (iter->result->opcode) {\n\tcase BT_ATT_OP_READ_BY_GRP_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\t\tconvert_uuid_le(pdu_ptr + 4, iter->result->data_len - 4, uuid);\n\t\tbreak;\n\tcase BT_ATT_OP_FIND_BY_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\n\t\tbt_uuid_to_uuid128(&op->uuid, &tmp);\n\t\tmemcpy(uuid, tmp.value.u128.data, 16);\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_result_service_count",
          "args": [
            "result"
          ],
          "line": 1151
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_result_service_count",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "104-114",
          "snippet": "unsigned int bt_gatt_result_service_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_GRP_TYPE_RSP &&\n\t\t\tresult->opcode != BT_ATT_OP_FIND_BY_TYPE_RSP)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nunsigned int bt_gatt_result_service_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_GRP_TYPE_RSP &&\n\t\t\tresult->opcode != BT_ATT_OP_FIND_BY_TYPE_RSP)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_iter_init",
          "args": [
            "&iter",
            "result"
          ],
          "line": 1144
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_iter_init",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "176-185",
          "snippet": "bool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_req_clear",
          "args": [
            "client"
          ],
          "line": 1127
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_req_clear",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "466-473",
          "snippet": "static void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void discover_primary_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tstruct bt_gatt_iter iter;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t start, end;\n\tuint128_t u128;\n\tbt_uuid_t uuid;\n\tchar uuid_str[MAX_LEN_UUID_STR];\n\n\tdiscovery_req_clear(client);\n\n\tif (!success) {\n\t\t/* Reset error in case of not found */\n\t\tswitch (att_ecode) {\n\t\tcase BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND:\n\t\t\tsuccess = true;\n\t\t\tatt_ecode = 0;\n\t\t\tgoto secondary;\n\t\tdefault:\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Primary service discovery failed.\"\n\t\t\t\t\t\" ATT ECODE: 0x%02x\", att_ecode);\n\t\t\tgoto done;\n\t\t}\n\t}\n\n\tif (!result || !bt_gatt_iter_init(&iter, result)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Primary services found: %u\",\n\t\t\t\t\tbt_gatt_result_service_count(result));\n\n\twhile (bt_gatt_iter_next_service(&iter, &start, &end, u128.data)) {\n\t\tbt_uuid128_create(&uuid, u128);\n\n\t\t/* Log debug message. */\n\t\tbt_uuid_to_string(&uuid, uuid_str, sizeof(uuid_str));\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"start: 0x%04x, end: 0x%04x, uuid: %s\",\n\t\t\t\tstart, end, uuid_str);\n\n\t\tattr = gatt_db_insert_service(client->db, start, &uuid, true,\n\t\t\t\t\t\t\tend - start + 1);\n\t\tif (!attr) {\n\t\t\tgatt_db_clear_range(client->db, start, end);\n\t\t\tattr = gatt_db_insert_service(client->db, start, &uuid,\n\t\t\t\t\t\t\ttrue, end - start + 1);\n\t\t\tif (!attr) {\n\t\t\t\tutil_debug(client->debug_callback,\n\t\t\t\t\t\tclient->debug_data,\n\t\t\t\t\t\t\"Failed to store service\");\n\t\t\t\tsuccess = false;\n\t\t\t\tgoto done;\n\t\t\t}\n\t\t\t/* Database has changed adjust last handle */\n\t\t\top->last = end;\n\t\t}\n\n\t\t/* Update pending list */\n\t\tdiscovery_found_service(op, attr, start, end);\n\t}\n\nsecondary:\n\t/*\n\t * Version 4.2 [Vol 1, Part A] page 101:\n\t * A secondary service is a service that provides auxiliary\n\t * functionality of a device and is referenced from at least one\n\t * primary service on the device.\n\t */\n\tif (queue_isempty(op->pending_svcs))\n\t\tgoto done;\n\n\t/* Discover secondary services */\n\tclient->discovery_req = bt_gatt_discover_secondary_services(client->att,\n\t\t\t\t\t\tNULL, op->start, op->end,\n\t\t\t\t\t\tdiscover_secondary_cb,\n\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req)\n\t\treturn;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to start secondary service discovery\");\n\tdiscovery_op_unref(op);\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "discover_secondary_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "1014-1112",
    "snippet": "static void discover_secondary_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tstruct bt_gatt_iter iter;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t start, end;\n\tuint128_t u128;\n\tbt_uuid_t uuid;\n\tchar uuid_str[MAX_LEN_UUID_STR];\n\tstruct handle_range *range;\n\n\tdiscovery_req_clear(client);\n\n\tif (!success) {\n\t\tswitch (att_ecode) {\n\t\tcase BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND:\n\t\tcase BT_ATT_ERROR_UNSUPPORTED_GROUP_TYPE:\n\t\t\tsuccess = true;\n\t\t\tatt_ecode = 0;\n\t\t\tgoto next;\n\t\tdefault:\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Secondary service discovery failed.\"\n\t\t\t\t\t\" ATT ECODE: 0x%02x\", att_ecode);\n\t\t\tgoto done;\n\t\t}\n\t}\n\n\tif (!result || !bt_gatt_iter_init(&iter, result)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Secondary services found: %u\",\n\t\t\t\t\tbt_gatt_result_service_count(result));\n\n\twhile (bt_gatt_iter_next_service(&iter, &start, &end, u128.data)) {\n\t\tbt_uuid128_create(&uuid, u128);\n\n\t\t/* Log debug message */\n\t\tbt_uuid_to_string(&uuid, uuid_str, sizeof(uuid_str));\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"start: 0x%04x, end: 0x%04x, uuid: %s\",\n\t\t\t\tstart, end, uuid_str);\n\n\t\t/* Store the service */\n\t\tattr = gatt_db_insert_service(client->db, start, &uuid, false,\n\t\t\t\t\t\t\tend - start + 1);\n\t\tif (!attr) {\n\t\t\tgatt_db_clear_range(client->db, start, end);\n\t\t\tattr = gatt_db_insert_service(client->db, start, &uuid,\n\t\t\t\t\t\t\tfalse, end - start + 1);\n\t\t\tif (!attr) {\n\t\t\t\tutil_debug(client->debug_callback,\n\t\t\t\t\t\tclient->debug_data,\n\t\t\t\t\t\t\"Failed to store service\");\n\t\t\t\tsuccess = false;\n\t\t\t\tgoto done;\n\t\t\t}\n\t\t\t/* Database has changed adjust last handle */\n\t\t\top->last = end;\n\t\t}\n\n\t\t/* Update pending list */\n\t\tdiscovery_found_service(op, attr, start, end);\n\t}\n\nnext:\n\tif (queue_isempty(op->pending_svcs) || queue_isempty(op->discov_ranges))\n\t\tgoto done;\n\n\tif (op->svc_first > 0x0001)\n\t\tremove_discov_range(op, 1, op->svc_first - 1);\n\tif (op->svc_last < 0xffff)\n\t\tremove_discov_range(op, op->svc_last + 1, 0xffff);\n\n\trange = queue_peek_head(op->discov_ranges);\n\n\tclient->discovery_req = bt_gatt_discover_included_services(client->att,\n\t\t\t\t\t\t\trange->start,\n\t\t\t\t\t\t\trange->end,\n\t\t\t\t\t\t\tdiscover_incl_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req)\n\t\treturn;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to start included services discovery\");\n\tdiscovery_op_unref(op);\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 1111
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "352-385",
          "snippet": "static void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_unref",
          "args": [
            "op"
          ],
          "line": 1107
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "453-464",
          "snippet": "static void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Failed to start included services discovery\""
          ],
          "line": 1105
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_discover_included_services",
          "args": [
            "client->att",
            "range->start",
            "range->end",
            "discover_incl_cb",
            "discovery_op_ref(op)",
            "discovery_op_unref"
          ],
          "line": 1096
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_discover_included_services",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "1139-1172",
          "snippet": "struct bt_gatt_request *bt_gatt_discover_included_services(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[6];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tput_le16(GATT_INCLUDE_UUID, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\tdiscover_included_cb, bt_gatt_request_ref(op),\n\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_included_services(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[6];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tput_le16(GATT_INCLUDE_UUID, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\tdiscover_included_cb, bt_gatt_request_ref(op),\n\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_ref",
          "args": [
            "op"
          ],
          "line": 1100
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "446-451",
          "snippet": "static struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_peek_head",
          "args": [
            "op->discov_ranges"
          ],
          "line": 1094
        },
        "resolved": true,
        "details": {
          "function_name": "queue_peek_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "187-193",
          "snippet": "void *queue_peek_head(struct queue *queue)\n{\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\treturn queue->head->data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_peek_head(struct queue *queue)\n{\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\treturn queue->head->data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "remove_discov_range",
          "args": [
            "op",
            "op->svc_last + 1",
            "0xffff"
          ],
          "line": 1092
        },
        "resolved": true,
        "details": {
          "function_name": "remove_discov_range",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "955-984",
          "snippet": "static void remove_discov_range(struct discovery_op *op, uint16_t start,\n\t\t\t\t\t\t\t\tuint16_t end)\n{\n\tstruct handle_range match_range;\n\tstruct handle_range *range, *new_range;\n\n\tmatch_range.start = start;\n\tmatch_range.end = end;\n\n\trange = queue_find(op->discov_ranges, match_handle_range, &match_range);\n\tif (!range)\n\t\treturn;\n\n\tif ((range->start == start) && (range->end == end)) {\n\t\tqueue_remove(op->discov_ranges, range);\n\t\tfree(range);\n\t} else if (range->start == start)\n\t\trange->start = end + 1;\n\telse if (range->end == end)\n\t\trange->end = start - 1;\n\telse {\n\t\tnew_range = new0(struct handle_range, 1);\n\t\tnew_range->start = end + 1;\n\t\tnew_range->end = range->end;\n\n\t\tqueue_push_after(op->discov_ranges, range, new_range);\n\n\t\trange->end = start - 1;\n\t}\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void remove_discov_range(struct discovery_op *op, uint16_t start,\n\t\t\t\t\t\t\t\tuint16_t end)\n{\n\tstruct handle_range match_range;\n\tstruct handle_range *range, *new_range;\n\n\tmatch_range.start = start;\n\tmatch_range.end = end;\n\n\trange = queue_find(op->discov_ranges, match_handle_range, &match_range);\n\tif (!range)\n\t\treturn;\n\n\tif ((range->start == start) && (range->end == end)) {\n\t\tqueue_remove(op->discov_ranges, range);\n\t\tfree(range);\n\t} else if (range->start == start)\n\t\trange->start = end + 1;\n\telse if (range->end == end)\n\t\trange->end = start - 1;\n\telse {\n\t\tnew_range = new0(struct handle_range, 1);\n\t\tnew_range->start = end + 1;\n\t\tnew_range->end = range->end;\n\n\t\tqueue_push_after(op->discov_ranges, range, new_range);\n\n\t\trange->end = start - 1;\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_isempty",
          "args": [
            "op->discov_ranges"
          ],
          "line": 1086
        },
        "resolved": true,
        "details": {
          "function_name": "queue_isempty",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "380-386",
          "snippet": "bool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_found_service",
          "args": [
            "op",
            "attr",
            "start",
            "end"
          ],
          "line": 1082
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_found_service",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "986-1012",
          "snippet": "static void discovery_found_service(struct discovery_op *op,\n\t\t\t\t\tstruct gatt_db_attribute *attr,\n\t\t\t\t\tuint16_t start, uint16_t end)\n{\n\t/* Skip if service already active */\n\tif (!gatt_db_service_get_active(attr)) {\n\t\t/* Skip if there are no attributes */\n\t\tif (end == start)\n\t\t\tgatt_db_service_set_active(attr, true);\n\t\telse\n\t\t\tqueue_push_tail(op->pending_svcs, attr);\n\n\t\tif (start < op->svc_first)\n\t\t\top->svc_first = start;\n\t\tif (end > op->svc_last)\n\t\t\top->svc_last = end;\n\t} else {\n\t\t/* Remove from pending if active */\n\t\tqueue_remove(op->pending_svcs, attr);\n\n\t\tremove_discov_range(op, start, end);\n\t}\n\n\t/* Update last handle */\n\tif (end > op->last)\n\t\top->last = end;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_found_service(struct discovery_op *op,\n\t\t\t\t\tstruct gatt_db_attribute *attr,\n\t\t\t\t\tuint16_t start, uint16_t end)\n{\n\t/* Skip if service already active */\n\tif (!gatt_db_service_get_active(attr)) {\n\t\t/* Skip if there are no attributes */\n\t\tif (end == start)\n\t\t\tgatt_db_service_set_active(attr, true);\n\t\telse\n\t\t\tqueue_push_tail(op->pending_svcs, attr);\n\n\t\tif (start < op->svc_first)\n\t\t\top->svc_first = start;\n\t\tif (end > op->svc_last)\n\t\t\top->svc_last = end;\n\t} else {\n\t\t/* Remove from pending if active */\n\t\tqueue_remove(op->pending_svcs, attr);\n\n\t\tremove_discov_range(op, start, end);\n\t}\n\n\t/* Update last handle */\n\tif (end > op->last)\n\t\top->last = end;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_insert_service",
          "args": [
            "client->db",
            "start",
            "&uuid",
            "false",
            "end - start + 1"
          ],
          "line": 1068
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_insert_service",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "518-581",
          "snippet": "struct gatt_db_attribute *gatt_db_insert_service(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle,\n\t\t\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\t\t\tbool primary,\n\t\t\t\t\t\t\tuint16_t num_handles)\n{\n\tstruct gatt_db_service *service, *after;\n\n\tafter = NULL;\n\n\tif (!db || handle < 1)\n\t\treturn NULL;\n\n\tif (num_handles < 1 || (handle + num_handles - 1) > UINT16_MAX)\n\t\treturn NULL;\n\n\tservice = find_insert_loc(db, handle, handle + num_handles - 1, &after);\n\tif (service) {\n\t\tconst bt_uuid_t *type;\n\t\tbt_uuid_t value;\n\n\t\tif (primary)\n\t\t\ttype = &primary_service_uuid;\n\t\telse\n\t\t\ttype = &secondary_service_uuid;\n\n\t\tgatt_db_attribute_get_service_uuid(service->attributes[0],\n\t\t\t\t\t\t\t\t\t&value);\n\n\t\t/* Check if service match */\n\t\tif (!bt_uuid_cmp(&service->attributes[0]->uuid, type) &&\n\t\t\t\t!bt_uuid_cmp(&value, uuid) &&\n\t\t\t\tservice->num_handles == num_handles &&\n\t\t\t\tservice->attributes[0]->handle == handle)\n\t\t\treturn service->attributes[0];\n\n\t\treturn NULL;\n\t}\n\n\tservice = gatt_db_service_create(uuid, handle, primary, num_handles);\n\n\tif (!service)\n\t\treturn NULL;\n\n\tif (after) {\n\t\tif (!queue_push_after(db->services, after, service))\n\t\t\tgoto fail;\n\t} else if (!queue_push_head(db->services, service)) {\n\t\tgoto fail;\n\t}\n\n\tservice->db = db;\n\tservice->attributes[0]->handle = handle;\n\tservice->num_handles = num_handles;\n\n\t/* Fast-forward next_handle if the new service was added to the end */\n\tdb->next_handle = MAX(handle + num_handles, db->next_handle);\n\n\treturn service->attributes[0];\n\nfail:\n\tgatt_db_service_destroy(service);\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const bt_uuid_t primary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_PRIM_SVC_UUID };",
            "static const bt_uuid_t secondary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_SND_SVC_UUID };"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstatic const bt_uuid_t primary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_PRIM_SVC_UUID };\nstatic const bt_uuid_t secondary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_SND_SVC_UUID };\n\nstruct gatt_db_attribute *gatt_db_insert_service(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle,\n\t\t\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\t\t\tbool primary,\n\t\t\t\t\t\t\tuint16_t num_handles)\n{\n\tstruct gatt_db_service *service, *after;\n\n\tafter = NULL;\n\n\tif (!db || handle < 1)\n\t\treturn NULL;\n\n\tif (num_handles < 1 || (handle + num_handles - 1) > UINT16_MAX)\n\t\treturn NULL;\n\n\tservice = find_insert_loc(db, handle, handle + num_handles - 1, &after);\n\tif (service) {\n\t\tconst bt_uuid_t *type;\n\t\tbt_uuid_t value;\n\n\t\tif (primary)\n\t\t\ttype = &primary_service_uuid;\n\t\telse\n\t\t\ttype = &secondary_service_uuid;\n\n\t\tgatt_db_attribute_get_service_uuid(service->attributes[0],\n\t\t\t\t\t\t\t\t\t&value);\n\n\t\t/* Check if service match */\n\t\tif (!bt_uuid_cmp(&service->attributes[0]->uuid, type) &&\n\t\t\t\t!bt_uuid_cmp(&value, uuid) &&\n\t\t\t\tservice->num_handles == num_handles &&\n\t\t\t\tservice->attributes[0]->handle == handle)\n\t\t\treturn service->attributes[0];\n\n\t\treturn NULL;\n\t}\n\n\tservice = gatt_db_service_create(uuid, handle, primary, num_handles);\n\n\tif (!service)\n\t\treturn NULL;\n\n\tif (after) {\n\t\tif (!queue_push_after(db->services, after, service))\n\t\t\tgoto fail;\n\t} else if (!queue_push_head(db->services, service)) {\n\t\tgoto fail;\n\t}\n\n\tservice->db = db;\n\tservice->attributes[0]->handle = handle;\n\tservice->num_handles = num_handles;\n\n\t/* Fast-forward next_handle if the new service was added to the end */\n\tdb->next_handle = MAX(handle + num_handles, db->next_handle);\n\n\treturn service->attributes[0];\n\nfail:\n\tgatt_db_service_destroy(service);\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_clear_range",
          "args": [
            "client->db",
            "start",
            "end"
          ],
          "line": 1067
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_clear_range",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "457-483",
          "snippet": "bool gatt_db_clear_range(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct clear_range range;\n\n\tif (!db || start_handle > end_handle)\n\t\treturn false;\n\n\t/* Check if it is a full clear */\n\tif (start_handle == 1 && end_handle == UINT16_MAX) {\n\t\tqueue_remove_all(db->services, NULL, NULL,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\t\tgoto done;\n\t}\n\n\trange.start = start_handle;\n\trange.end = end_handle;\n\n\tqueue_remove_all(db->services, match_range, &range,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\ndone:\n\tif (gatt_db_isempty(db))\n\t\tdb->next_handle = 0;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_clear_range(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct clear_range range;\n\n\tif (!db || start_handle > end_handle)\n\t\treturn false;\n\n\t/* Check if it is a full clear */\n\tif (start_handle == 1 && end_handle == UINT16_MAX) {\n\t\tqueue_remove_all(db->services, NULL, NULL,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\t\tgoto done;\n\t}\n\n\trange.start = start_handle;\n\trange.end = end_handle;\n\n\tqueue_remove_all(db->services, match_range, &range,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\ndone:\n\tif (gatt_db_isempty(db))\n\t\tdb->next_handle = 0;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_to_string",
          "args": [
            "&uuid",
            "uuid_str",
            "sizeof(uuid_str)"
          ],
          "line": 1058
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid128_create",
          "args": [
            "&uuid",
            "u128"
          ],
          "line": 1055
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_iter_next_service",
          "args": [
            "&iter",
            "&start",
            "&end",
            "u128.data"
          ],
          "line": 1054
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_iter_next_service",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "325-364",
          "snippet": "bool bt_gatt_iter_next_service(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *start_handle, uint16_t *end_handle,\n\t\t\t\tuint8_t uuid[16])\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\tbt_uuid_t tmp;\n\n\tif (!iter || !iter->result || !start_handle || !end_handle || !uuid)\n\t\treturn false;\n\n\top = iter->result->op;\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\tswitch (iter->result->opcode) {\n\tcase BT_ATT_OP_READ_BY_GRP_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\t\tconvert_uuid_le(pdu_ptr + 4, iter->result->data_len - 4, uuid);\n\t\tbreak;\n\tcase BT_ATT_OP_FIND_BY_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\n\t\tbt_uuid_to_uuid128(&op->uuid, &tmp);\n\t\tmemcpy(uuid, tmp.value.u128.data, 16);\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_next_service(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *start_handle, uint16_t *end_handle,\n\t\t\t\tuint8_t uuid[16])\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\tbt_uuid_t tmp;\n\n\tif (!iter || !iter->result || !start_handle || !end_handle || !uuid)\n\t\treturn false;\n\n\top = iter->result->op;\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\tswitch (iter->result->opcode) {\n\tcase BT_ATT_OP_READ_BY_GRP_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\t\tconvert_uuid_le(pdu_ptr + 4, iter->result->data_len - 4, uuid);\n\t\tbreak;\n\tcase BT_ATT_OP_FIND_BY_TYPE_RSP:\n\t\t*start_handle = get_le16(pdu_ptr);\n\t\t*end_handle = get_le16(pdu_ptr + 2);\n\n\t\tbt_uuid_to_uuid128(&op->uuid, &tmp);\n\t\tmemcpy(uuid, tmp.value.u128.data, 16);\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_result_service_count",
          "args": [
            "result"
          ],
          "line": 1052
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_result_service_count",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "104-114",
          "snippet": "unsigned int bt_gatt_result_service_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_GRP_TYPE_RSP &&\n\t\t\tresult->opcode != BT_ATT_OP_FIND_BY_TYPE_RSP)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nunsigned int bt_gatt_result_service_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_GRP_TYPE_RSP &&\n\t\t\tresult->opcode != BT_ATT_OP_FIND_BY_TYPE_RSP)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_iter_init",
          "args": [
            "&iter",
            "result"
          ],
          "line": 1045
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_iter_init",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "176-185",
          "snippet": "bool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_req_clear",
          "args": [
            "client"
          ],
          "line": 1028
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_req_clear",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "466-473",
          "snippet": "static void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void discover_secondary_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tstruct bt_gatt_iter iter;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t start, end;\n\tuint128_t u128;\n\tbt_uuid_t uuid;\n\tchar uuid_str[MAX_LEN_UUID_STR];\n\tstruct handle_range *range;\n\n\tdiscovery_req_clear(client);\n\n\tif (!success) {\n\t\tswitch (att_ecode) {\n\t\tcase BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND:\n\t\tcase BT_ATT_ERROR_UNSUPPORTED_GROUP_TYPE:\n\t\t\tsuccess = true;\n\t\t\tatt_ecode = 0;\n\t\t\tgoto next;\n\t\tdefault:\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Secondary service discovery failed.\"\n\t\t\t\t\t\" ATT ECODE: 0x%02x\", att_ecode);\n\t\t\tgoto done;\n\t\t}\n\t}\n\n\tif (!result || !bt_gatt_iter_init(&iter, result)) {\n\t\tsuccess = false;\n\t\tgoto done;\n\t}\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Secondary services found: %u\",\n\t\t\t\t\tbt_gatt_result_service_count(result));\n\n\twhile (bt_gatt_iter_next_service(&iter, &start, &end, u128.data)) {\n\t\tbt_uuid128_create(&uuid, u128);\n\n\t\t/* Log debug message */\n\t\tbt_uuid_to_string(&uuid, uuid_str, sizeof(uuid_str));\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"start: 0x%04x, end: 0x%04x, uuid: %s\",\n\t\t\t\tstart, end, uuid_str);\n\n\t\t/* Store the service */\n\t\tattr = gatt_db_insert_service(client->db, start, &uuid, false,\n\t\t\t\t\t\t\tend - start + 1);\n\t\tif (!attr) {\n\t\t\tgatt_db_clear_range(client->db, start, end);\n\t\t\tattr = gatt_db_insert_service(client->db, start, &uuid,\n\t\t\t\t\t\t\tfalse, end - start + 1);\n\t\t\tif (!attr) {\n\t\t\t\tutil_debug(client->debug_callback,\n\t\t\t\t\t\tclient->debug_data,\n\t\t\t\t\t\t\"Failed to store service\");\n\t\t\t\tsuccess = false;\n\t\t\t\tgoto done;\n\t\t\t}\n\t\t\t/* Database has changed adjust last handle */\n\t\t\top->last = end;\n\t\t}\n\n\t\t/* Update pending list */\n\t\tdiscovery_found_service(op, attr, start, end);\n\t}\n\nnext:\n\tif (queue_isempty(op->pending_svcs) || queue_isempty(op->discov_ranges))\n\t\tgoto done;\n\n\tif (op->svc_first > 0x0001)\n\t\tremove_discov_range(op, 1, op->svc_first - 1);\n\tif (op->svc_last < 0xffff)\n\t\tremove_discov_range(op, op->svc_last + 1, 0xffff);\n\n\trange = queue_peek_head(op->discov_ranges);\n\n\tclient->discovery_req = bt_gatt_discover_included_services(client->att,\n\t\t\t\t\t\t\trange->start,\n\t\t\t\t\t\t\trange->end,\n\t\t\t\t\t\t\tdiscover_incl_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\tif (client->discovery_req)\n\t\treturn;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to start included services discovery\");\n\tdiscovery_op_unref(op);\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "discovery_found_service",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "986-1012",
    "snippet": "static void discovery_found_service(struct discovery_op *op,\n\t\t\t\t\tstruct gatt_db_attribute *attr,\n\t\t\t\t\tuint16_t start, uint16_t end)\n{\n\t/* Skip if service already active */\n\tif (!gatt_db_service_get_active(attr)) {\n\t\t/* Skip if there are no attributes */\n\t\tif (end == start)\n\t\t\tgatt_db_service_set_active(attr, true);\n\t\telse\n\t\t\tqueue_push_tail(op->pending_svcs, attr);\n\n\t\tif (start < op->svc_first)\n\t\t\top->svc_first = start;\n\t\tif (end > op->svc_last)\n\t\t\top->svc_last = end;\n\t} else {\n\t\t/* Remove from pending if active */\n\t\tqueue_remove(op->pending_svcs, attr);\n\n\t\tremove_discov_range(op, start, end);\n\t}\n\n\t/* Update last handle */\n\tif (end > op->last)\n\t\top->last = end;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "remove_discov_range",
          "args": [
            "op",
            "start",
            "end"
          ],
          "line": 1006
        },
        "resolved": true,
        "details": {
          "function_name": "remove_discov_range",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "955-984",
          "snippet": "static void remove_discov_range(struct discovery_op *op, uint16_t start,\n\t\t\t\t\t\t\t\tuint16_t end)\n{\n\tstruct handle_range match_range;\n\tstruct handle_range *range, *new_range;\n\n\tmatch_range.start = start;\n\tmatch_range.end = end;\n\n\trange = queue_find(op->discov_ranges, match_handle_range, &match_range);\n\tif (!range)\n\t\treturn;\n\n\tif ((range->start == start) && (range->end == end)) {\n\t\tqueue_remove(op->discov_ranges, range);\n\t\tfree(range);\n\t} else if (range->start == start)\n\t\trange->start = end + 1;\n\telse if (range->end == end)\n\t\trange->end = start - 1;\n\telse {\n\t\tnew_range = new0(struct handle_range, 1);\n\t\tnew_range->start = end + 1;\n\t\tnew_range->end = range->end;\n\n\t\tqueue_push_after(op->discov_ranges, range, new_range);\n\n\t\trange->end = start - 1;\n\t}\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void remove_discov_range(struct discovery_op *op, uint16_t start,\n\t\t\t\t\t\t\t\tuint16_t end)\n{\n\tstruct handle_range match_range;\n\tstruct handle_range *range, *new_range;\n\n\tmatch_range.start = start;\n\tmatch_range.end = end;\n\n\trange = queue_find(op->discov_ranges, match_handle_range, &match_range);\n\tif (!range)\n\t\treturn;\n\n\tif ((range->start == start) && (range->end == end)) {\n\t\tqueue_remove(op->discov_ranges, range);\n\t\tfree(range);\n\t} else if (range->start == start)\n\t\trange->start = end + 1;\n\telse if (range->end == end)\n\t\trange->end = start - 1;\n\telse {\n\t\tnew_range = new0(struct handle_range, 1);\n\t\tnew_range->start = end + 1;\n\t\tnew_range->end = range->end;\n\n\t\tqueue_push_after(op->discov_ranges, range, new_range);\n\n\t\trange->end = start - 1;\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "op->pending_svcs",
            "attr"
          ],
          "line": 1004
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "op->pending_svcs",
            "attr"
          ],
          "line": 996
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_service_set_active",
          "args": [
            "attr",
            "true"
          ],
          "line": 994
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_service_set_active",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "975-992",
          "snippet": "bool gatt_db_service_set_active(struct gatt_db_attribute *attrib, bool active)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tif (service->active == active)\n\t\treturn true;\n\n\tservice->active = active;\n\n\tnotify_service_changed(service->db, service, active);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_service_set_active(struct gatt_db_attribute *attrib, bool active)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tif (service->active == active)\n\t\treturn true;\n\n\tservice->active = active;\n\n\tnotify_service_changed(service->db, service, active);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_service_get_active",
          "args": [
            "attr"
          ],
          "line": 991
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_service_get_active",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "994-1000",
          "snippet": "bool gatt_db_service_get_active(struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn false;\n\n\treturn attrib->service->active;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_service_get_active(struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn false;\n\n\treturn attrib->service->active;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_found_service(struct discovery_op *op,\n\t\t\t\t\tstruct gatt_db_attribute *attr,\n\t\t\t\t\tuint16_t start, uint16_t end)\n{\n\t/* Skip if service already active */\n\tif (!gatt_db_service_get_active(attr)) {\n\t\t/* Skip if there are no attributes */\n\t\tif (end == start)\n\t\t\tgatt_db_service_set_active(attr, true);\n\t\telse\n\t\t\tqueue_push_tail(op->pending_svcs, attr);\n\n\t\tif (start < op->svc_first)\n\t\t\top->svc_first = start;\n\t\tif (end > op->svc_last)\n\t\t\top->svc_last = end;\n\t} else {\n\t\t/* Remove from pending if active */\n\t\tqueue_remove(op->pending_svcs, attr);\n\n\t\tremove_discov_range(op, start, end);\n\t}\n\n\t/* Update last handle */\n\tif (end > op->last)\n\t\top->last = end;\n}"
  },
  {
    "function_name": "remove_discov_range",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "955-984",
    "snippet": "static void remove_discov_range(struct discovery_op *op, uint16_t start,\n\t\t\t\t\t\t\t\tuint16_t end)\n{\n\tstruct handle_range match_range;\n\tstruct handle_range *range, *new_range;\n\n\tmatch_range.start = start;\n\tmatch_range.end = end;\n\n\trange = queue_find(op->discov_ranges, match_handle_range, &match_range);\n\tif (!range)\n\t\treturn;\n\n\tif ((range->start == start) && (range->end == end)) {\n\t\tqueue_remove(op->discov_ranges, range);\n\t\tfree(range);\n\t} else if (range->start == start)\n\t\trange->start = end + 1;\n\telse if (range->end == end)\n\t\trange->end = start - 1;\n\telse {\n\t\tnew_range = new0(struct handle_range, 1);\n\t\tnew_range->start = end + 1;\n\t\tnew_range->end = range->end;\n\n\t\tqueue_push_after(op->discov_ranges, range, new_range);\n\n\t\trange->end = start - 1;\n\t}\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_push_after",
          "args": [
            "op->discov_ranges",
            "range",
            "new_range"
          ],
          "line": 980
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_after",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "131-161",
          "snippet": "bool queue_push_after(struct queue *queue, void *entry, void *data)\n{\n\tstruct queue_entry *qentry, *tmp, *new_entry;\n\n\tqentry = NULL;\n\n\tif (!queue)\n\t\treturn false;\n\n\tfor (tmp = queue->head; tmp; tmp = tmp->next) {\n\t\tif (tmp->data == entry) {\n\t\t\tqentry = tmp;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (!qentry)\n\t\treturn false;\n\n\tnew_entry = queue_entry_new(data);\n\n\tnew_entry->next = qentry->next;\n\n\tif (!qentry->next)\n\t\tqueue->tail = new_entry;\n\n\tqentry->next = new_entry;\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_after(struct queue *queue, void *entry, void *data)\n{\n\tstruct queue_entry *qentry, *tmp, *new_entry;\n\n\tqentry = NULL;\n\n\tif (!queue)\n\t\treturn false;\n\n\tfor (tmp = queue->head; tmp; tmp = tmp->next) {\n\t\tif (tmp->data == entry) {\n\t\t\tqentry = tmp;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (!qentry)\n\t\treturn false;\n\n\tnew_entry = queue_entry_new(data);\n\n\tnew_entry->next = qentry->next;\n\n\tif (!qentry->next)\n\t\tqueue->tail = new_entry;\n\n\tqentry->next = new_entry;\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structhandle_range",
            "1"
          ],
          "line": 976
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "range"
          ],
          "line": 970
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "op->discov_ranges",
            "range"
          ],
          "line": 969
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_find",
          "args": [
            "op->discov_ranges",
            "match_handle_range",
            "&match_range"
          ],
          "line": 964
        },
        "resolved": true,
        "details": {
          "function_name": "queue_find",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "231-247",
          "snippet": "void *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void remove_discov_range(struct discovery_op *op, uint16_t start,\n\t\t\t\t\t\t\t\tuint16_t end)\n{\n\tstruct handle_range match_range;\n\tstruct handle_range *range, *new_range;\n\n\tmatch_range.start = start;\n\tmatch_range.end = end;\n\n\trange = queue_find(op->discov_ranges, match_handle_range, &match_range);\n\tif (!range)\n\t\treturn;\n\n\tif ((range->start == start) && (range->end == end)) {\n\t\tqueue_remove(op->discov_ranges, range);\n\t\tfree(range);\n\t} else if (range->start == start)\n\t\trange->start = end + 1;\n\telse if (range->end == end)\n\t\trange->end = start - 1;\n\telse {\n\t\tnew_range = new0(struct handle_range, 1);\n\t\tnew_range->start = end + 1;\n\t\tnew_range->end = range->end;\n\n\t\tqueue_push_after(op->discov_ranges, range, new_range);\n\n\t\trange->end = start - 1;\n\t}\n}"
  },
  {
    "function_name": "match_handle_range",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "946-953",
    "snippet": "static bool match_handle_range(const void *data, const void *match_data)\n{\n\tconst struct handle_range *range = data;\n\tconst struct handle_range *match_range = match_data;\n\n\treturn (match_range->start >= range->start) &&\n\t\t\t\t\t(match_range->start <= range->end);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool match_handle_range(const void *data, const void *match_data)\n{\n\tconst struct handle_range *range = data;\n\tconst struct handle_range *match_range = match_data;\n\n\treturn (match_range->start >= range->start) &&\n\t\t\t\t\t(match_range->start <= range->end);\n}"
  },
  {
    "function_name": "discover_chrcs_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "835-944",
    "snippet": "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tstruct bt_gatt_iter iter;\n\tstruct chrc *chrc_data;\n\tuint16_t start, end, value;\n\tuint8_t properties;\n\tuint128_t u128;\n\tbt_uuid_t uuid;\n\tchar uuid_str[MAX_LEN_UUID_STR];\n\tunsigned int chrc_count;\n\tbool discovering;\n\n\tdiscovery_req_clear(client);\n\n\tif (!success) {\n\t\tif (att_ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND) {\n\t\t\tsuccess = true;\n\t\t\tgoto next;\n\t\t}\n\n\t\tgoto done;\n\t}\n\n\tif (!result || !bt_gatt_iter_init(&iter, result))\n\t\tgoto failed;\n\n\tchrc_count = bt_gatt_result_characteristic_count(result);\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Characteristics found: %u\", chrc_count);\n\n\tif (chrc_count == 0)\n\t\tgoto failed;\n\n\twhile (bt_gatt_iter_next_characteristic(&iter, &start, &end, &value,\n\t\t\t\t\t\t&properties, u128.data)) {\n\t\tbt_uuid128_create(&uuid, u128);\n\n\t\t/* Log debug message */\n\t\tbt_uuid_to_string(&uuid, uuid_str, sizeof(uuid_str));\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"start: 0x%04x, end: 0x%04x, value: 0x%04x, \"\n\t\t\t\t\"props: 0x%02x, uuid: %s\",\n\t\t\t\tstart, end, value, properties, uuid_str);\n\n\t\tchrc_data = new0(struct chrc, 1);\n\n\t\tchrc_data->start_handle = start;\n\t\tchrc_data->end_handle = end;\n\t\tchrc_data->value_handle = value;\n\t\tchrc_data->properties = properties;\n\t\tchrc_data->uuid = uuid;\n\n\t\tqueue_push_tail(op->pending_chrcs, chrc_data);\n\t}\n\nnext:\n\t/*\n\t * Before attempting to process discovered characteristics make sure we\n\t * discovered all missing ranges.\n\t */\n\tif (queue_length(op->discov_ranges)) {\n\t\tstruct handle_range *range;\n\n\t\trange = queue_peek_head(op->discov_ranges);\n\t\tif (!range)\n\t\t\tgoto failed;\n\n\t\tclient->discovery_req =\n\t\t\tbt_gatt_discover_included_services(client->att,\n\t\t\t\t\t\t\trange->start,\n\t\t\t\t\t\t\trange->end,\n\t\t\t\t\t\t\tdiscover_incl_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\t\tif (client->discovery_req)\n\t\t\treturn;\n\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to start included services discovery\");\n\n\t\tdiscovery_op_unref(op);\n\n\t\tgoto failed;\n\t}\n\n\t/*\n\t * Sequentially discover descriptors for each characteristic and insert\n\t * the characteristics into the database as we proceed.\n\t */\n\tif (!discover_descs(op, &discovering))\n\t\tgoto failed;\n\n\tif (discovering)\n\t\treturn;\n\n\t/* Done with the current service */\n\tgatt_db_service_set_active(op->cur_svc, true);\n\n\tgoto done;\n\nfailed:\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 943
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "352-385",
          "snippet": "static void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_service_set_active",
          "args": [
            "op->cur_svc",
            "true"
          ],
          "line": 935
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_service_set_active",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "975-992",
          "snippet": "bool gatt_db_service_set_active(struct gatt_db_attribute *attrib, bool active)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tif (service->active == active)\n\t\treturn true;\n\n\tservice->active = active;\n\n\tnotify_service_changed(service->db, service, active);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_service_set_active(struct gatt_db_attribute *attrib, bool active)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tif (service->active == active)\n\t\treturn true;\n\n\tservice->active = active;\n\n\tnotify_service_changed(service->db, service, active);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discover_descs",
          "args": [
            "op",
            "&discovering"
          ],
          "line": 928
        },
        "resolved": true,
        "details": {
          "function_name": "discover_descs",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "578-667",
          "snippet": "static bool discover_descs(struct discovery_op *op, bool *discovering)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tstruct gatt_db_attribute *attr;\n\tstruct chrc *chrc_data;\n\tuint16_t desc_start;\n\n\t*discovering = false;\n\n\twhile ((chrc_data = queue_pop_head(op->pending_chrcs))) {\n\t\tstruct gatt_db_attribute *svc;\n\t\tuint16_t start, end;\n\n\t\t/* Adjust current service */\n\t\tsvc = gatt_db_get_service(client->db, chrc_data->value_handle);\n\t\tif (op->cur_svc != svc) {\n\t\t\tif (op->cur_svc) {\n\t\t\t\tqueue_remove(op->pending_svcs, op->cur_svc);\n\n\t\t\t\t/* Done with the current service */\n\t\t\t\tgatt_db_service_set_active(op->cur_svc, true);\n\t\t\t}\n\n\t\t\top->cur_svc = svc;\n\t\t}\n\n\t\tattr = gatt_db_insert_characteristic(client->db,\n\t\t\t\t\t\t\tchrc_data->value_handle,\n\t\t\t\t\t\t\t&chrc_data->uuid, 0,\n\t\t\t\t\t\t\tchrc_data->properties,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\t\tif (!attr) {\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to insert characteristic at 0x%04x\",\n\t\t\t\tchrc_data->value_handle);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (gatt_db_attribute_get_handle(attr) !=\n\t\t\t\t\t\t\tchrc_data->value_handle)\n\t\t\tgoto failed;\n\n\t\tgatt_db_attribute_get_service_handles(svc, &start, &end);\n\n\t\t/*\n\t\t * Ajust end_handle in case the next chrc is not within the\n\t\t * same service.\n\t\t */\n\t\tif (chrc_data->end_handle > end)\n\t\t\tchrc_data->end_handle = end;\n\n\t\t/*\n\t\t * check for descriptors presence, before initializing the\n\t\t * desc_handle and avoid integer overflow during desc_handle\n\t\t * intialization.\n\t\t */\n\t\tif (chrc_data->value_handle >= chrc_data->end_handle) {\n\t\t\tfree(chrc_data);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdesc_start = chrc_data->value_handle + 1;\n\n\t\tclient->discovery_req = bt_gatt_discover_descriptors(\n\t\t\t\t\t\t\tclient->att, desc_start,\n\t\t\t\t\t\t\tchrc_data->end_handle,\n\t\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\t\tif (client->discovery_req) {\n\t\t\t*discovering = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to start descriptor discovery\");\n\t\tdiscovery_op_unref(op);\n\n\t\tgoto failed;\n\t}\n\ndone:\n\tfree(chrc_data);\n\treturn true;\n\nfailed:\n\tfree(chrc_data);\n\treturn false;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);\n\nstatic bool discover_descs(struct discovery_op *op, bool *discovering)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tstruct gatt_db_attribute *attr;\n\tstruct chrc *chrc_data;\n\tuint16_t desc_start;\n\n\t*discovering = false;\n\n\twhile ((chrc_data = queue_pop_head(op->pending_chrcs))) {\n\t\tstruct gatt_db_attribute *svc;\n\t\tuint16_t start, end;\n\n\t\t/* Adjust current service */\n\t\tsvc = gatt_db_get_service(client->db, chrc_data->value_handle);\n\t\tif (op->cur_svc != svc) {\n\t\t\tif (op->cur_svc) {\n\t\t\t\tqueue_remove(op->pending_svcs, op->cur_svc);\n\n\t\t\t\t/* Done with the current service */\n\t\t\t\tgatt_db_service_set_active(op->cur_svc, true);\n\t\t\t}\n\n\t\t\top->cur_svc = svc;\n\t\t}\n\n\t\tattr = gatt_db_insert_characteristic(client->db,\n\t\t\t\t\t\t\tchrc_data->value_handle,\n\t\t\t\t\t\t\t&chrc_data->uuid, 0,\n\t\t\t\t\t\t\tchrc_data->properties,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\t\tif (!attr) {\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to insert characteristic at 0x%04x\",\n\t\t\t\tchrc_data->value_handle);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (gatt_db_attribute_get_handle(attr) !=\n\t\t\t\t\t\t\tchrc_data->value_handle)\n\t\t\tgoto failed;\n\n\t\tgatt_db_attribute_get_service_handles(svc, &start, &end);\n\n\t\t/*\n\t\t * Ajust end_handle in case the next chrc is not within the\n\t\t * same service.\n\t\t */\n\t\tif (chrc_data->end_handle > end)\n\t\t\tchrc_data->end_handle = end;\n\n\t\t/*\n\t\t * check for descriptors presence, before initializing the\n\t\t * desc_handle and avoid integer overflow during desc_handle\n\t\t * intialization.\n\t\t */\n\t\tif (chrc_data->value_handle >= chrc_data->end_handle) {\n\t\t\tfree(chrc_data);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdesc_start = chrc_data->value_handle + 1;\n\n\t\tclient->discovery_req = bt_gatt_discover_descriptors(\n\t\t\t\t\t\t\tclient->att, desc_start,\n\t\t\t\t\t\t\tchrc_data->end_handle,\n\t\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\t\tif (client->discovery_req) {\n\t\t\t*discovering = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to start descriptor discovery\");\n\t\tdiscovery_op_unref(op);\n\n\t\tgoto failed;\n\t}\n\ndone:\n\tfree(chrc_data);\n\treturn true;\n\nfailed:\n\tfree(chrc_data);\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_unref",
          "args": [
            "op"
          ],
          "line": 919
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "453-464",
          "snippet": "static void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Failed to start included services discovery\""
          ],
          "line": 916
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_discover_included_services",
          "args": [
            "client->att",
            "range->start",
            "range->end",
            "discover_incl_cb",
            "discovery_op_ref(op)",
            "discovery_op_unref"
          ],
          "line": 907
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_discover_included_services",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "1139-1172",
          "snippet": "struct bt_gatt_request *bt_gatt_discover_included_services(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[6];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tput_le16(GATT_INCLUDE_UUID, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\tdiscover_included_cb, bt_gatt_request_ref(op),\n\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_included_services(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[6];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tput_le16(GATT_INCLUDE_UUID, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\tdiscover_included_cb, bt_gatt_request_ref(op),\n\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_ref",
          "args": [
            "op"
          ],
          "line": 911
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "446-451",
          "snippet": "static struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_peek_head",
          "args": [
            "op->discov_ranges"
          ],
          "line": 902
        },
        "resolved": true,
        "details": {
          "function_name": "queue_peek_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "187-193",
          "snippet": "void *queue_peek_head(struct queue *queue)\n{\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\treturn queue->head->data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_peek_head(struct queue *queue)\n{\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\treturn queue->head->data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_length",
          "args": [
            "op->discov_ranges"
          ],
          "line": 899
        },
        "resolved": true,
        "details": {
          "function_name": "queue_length",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "372-378",
          "snippet": "unsigned int queue_length(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn 0;\n\n\treturn queue->entries;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_length(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn 0;\n\n\treturn queue->entries;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "op->pending_chrcs",
            "chrc_data"
          ],
          "line": 891
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structchrc",
            "1"
          ],
          "line": 883
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid_to_string",
          "args": [
            "&uuid",
            "uuid_str",
            "sizeof(uuid_str)"
          ],
          "line": 877
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid128_create",
          "args": [
            "&uuid",
            "u128"
          ],
          "line": 874
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_iter_next_characteristic",
          "args": [
            "&iter",
            "&start",
            "&end",
            "&value",
            "&properties",
            "u128.data"
          ],
          "line": 872
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_iter_next_characteristic",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "366-416",
          "snippet": "bool bt_gatt_iter_next_characteristic(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *start_handle, uint16_t *end_handle,\n\t\t\t\tuint16_t *value_handle, uint8_t *properties,\n\t\t\t\tuint8_t uuid[16])\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\n\tif (!iter || !iter->result || !start_handle || !end_handle ||\n\t\t\t\t\t!value_handle || !properties || !uuid)\n\t\treturn false;\n\n\tif (iter->result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn false;\n\n\t/* UUID in discovery_op is set in read_by_type and service_discovery */\n\top = iter->result->op;\n\tif (op->uuid.type != BT_UUID_UNSPEC)\n\t\treturn false;\n\t/*\n\t * Data length contains 7 or 21 octets:\n\t * 2 octets: Attribute handle\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (iter->result->data_len != 21 && iter->result->data_len != 7)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t*start_handle = get_le16(pdu_ptr);\n\t*properties = ((uint8_t *) pdu_ptr)[2];\n\t*value_handle = get_le16(pdu_ptr + 3);\n\tconvert_uuid_le(pdu_ptr + 5, iter->result->data_len - 5, uuid);\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\tif (!iter->result) {\n\t\t*end_handle = op->end_handle;\n\t\treturn true;\n\t}\n\n\t*end_handle = get_le16(iter->result->pdu + iter->pos) - 1;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_next_characteristic(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *start_handle, uint16_t *end_handle,\n\t\t\t\tuint16_t *value_handle, uint8_t *properties,\n\t\t\t\tuint8_t uuid[16])\n{\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\n\tif (!iter || !iter->result || !start_handle || !end_handle ||\n\t\t\t\t\t!value_handle || !properties || !uuid)\n\t\treturn false;\n\n\tif (iter->result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn false;\n\n\t/* UUID in discovery_op is set in read_by_type and service_discovery */\n\top = iter->result->op;\n\tif (op->uuid.type != BT_UUID_UNSPEC)\n\t\treturn false;\n\t/*\n\t * Data length contains 7 or 21 octets:\n\t * 2 octets: Attribute handle\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (iter->result->data_len != 21 && iter->result->data_len != 7)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t*start_handle = get_le16(pdu_ptr);\n\t*properties = ((uint8_t *) pdu_ptr)[2];\n\t*value_handle = get_le16(pdu_ptr + 3);\n\tconvert_uuid_le(pdu_ptr + 5, iter->result->data_len - 5, uuid);\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\tif (!iter->result) {\n\t\t*end_handle = op->end_handle;\n\t\treturn true;\n\t}\n\n\t*end_handle = get_le16(iter->result->pdu + iter->pos) - 1;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_result_characteristic_count",
          "args": [
            "result"
          ],
          "line": 865
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_result_characteristic_count",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "116-135",
          "snippet": "unsigned int bt_gatt_result_characteristic_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn 0;\n\n\t/*\n\t * Data length contains 7 or 21 octets:\n\t * 2 octets: Attribute handle\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (result->data_len != 21 && result->data_len != 7)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nunsigned int bt_gatt_result_characteristic_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn 0;\n\n\t/*\n\t * Data length contains 7 or 21 octets:\n\t * 2 octets: Attribute handle\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (result->data_len != 21 && result->data_len != 7)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_iter_init",
          "args": [
            "&iter",
            "result"
          ],
          "line": 862
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_iter_init",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "176-185",
          "snippet": "bool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_req_clear",
          "args": [
            "client"
          ],
          "line": 851
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_req_clear",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "466-473",
          "snippet": "static void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tstruct bt_gatt_iter iter;\n\tstruct chrc *chrc_data;\n\tuint16_t start, end, value;\n\tuint8_t properties;\n\tuint128_t u128;\n\tbt_uuid_t uuid;\n\tchar uuid_str[MAX_LEN_UUID_STR];\n\tunsigned int chrc_count;\n\tbool discovering;\n\n\tdiscovery_req_clear(client);\n\n\tif (!success) {\n\t\tif (att_ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND) {\n\t\t\tsuccess = true;\n\t\t\tgoto next;\n\t\t}\n\n\t\tgoto done;\n\t}\n\n\tif (!result || !bt_gatt_iter_init(&iter, result))\n\t\tgoto failed;\n\n\tchrc_count = bt_gatt_result_characteristic_count(result);\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Characteristics found: %u\", chrc_count);\n\n\tif (chrc_count == 0)\n\t\tgoto failed;\n\n\twhile (bt_gatt_iter_next_characteristic(&iter, &start, &end, &value,\n\t\t\t\t\t\t&properties, u128.data)) {\n\t\tbt_uuid128_create(&uuid, u128);\n\n\t\t/* Log debug message */\n\t\tbt_uuid_to_string(&uuid, uuid_str, sizeof(uuid_str));\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"start: 0x%04x, end: 0x%04x, value: 0x%04x, \"\n\t\t\t\t\"props: 0x%02x, uuid: %s\",\n\t\t\t\tstart, end, value, properties, uuid_str);\n\n\t\tchrc_data = new0(struct chrc, 1);\n\n\t\tchrc_data->start_handle = start;\n\t\tchrc_data->end_handle = end;\n\t\tchrc_data->value_handle = value;\n\t\tchrc_data->properties = properties;\n\t\tchrc_data->uuid = uuid;\n\n\t\tqueue_push_tail(op->pending_chrcs, chrc_data);\n\t}\n\nnext:\n\t/*\n\t * Before attempting to process discovered characteristics make sure we\n\t * discovered all missing ranges.\n\t */\n\tif (queue_length(op->discov_ranges)) {\n\t\tstruct handle_range *range;\n\n\t\trange = queue_peek_head(op->discov_ranges);\n\t\tif (!range)\n\t\t\tgoto failed;\n\n\t\tclient->discovery_req =\n\t\t\tbt_gatt_discover_included_services(client->att,\n\t\t\t\t\t\t\trange->start,\n\t\t\t\t\t\t\trange->end,\n\t\t\t\t\t\t\tdiscover_incl_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\t\tif (client->discovery_req)\n\t\t\treturn;\n\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to start included services discovery\");\n\n\t\tdiscovery_op_unref(op);\n\n\t\tgoto failed;\n\t}\n\n\t/*\n\t * Sequentially discover descriptors for each characteristic and insert\n\t * the characteristics into the database as we proceed.\n\t */\n\tif (!discover_descs(op, &discovering))\n\t\tgoto failed;\n\n\tif (discovering)\n\t\treturn;\n\n\t/* Done with the current service */\n\tgatt_db_service_set_active(op->cur_svc, true);\n\n\tgoto done;\n\nfailed:\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "discover_descs_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "747-833",
    "snippet": "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tstruct bt_gatt_iter iter;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t handle;\n\tuint128_t u128;\n\tbt_uuid_t uuid;\n\tchar uuid_str[MAX_LEN_UUID_STR];\n\tunsigned int desc_count;\n\tbool discovering;\n\tbt_uuid_t ext_prop_uuid;\n\n\tdiscovery_req_clear(client);\n\n\tif (!success) {\n\t\tif (att_ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND) {\n\t\t\tsuccess = true;\n\t\t\tgoto next;\n\t\t}\n\n\t\tgoto done;\n\t}\n\n\tif (!result || !bt_gatt_iter_init(&iter, result))\n\t\tgoto failed;\n\n\tdesc_count = bt_gatt_result_descriptor_count(result);\n\tif (desc_count == 0)\n\t\tgoto failed;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Descriptors found: %u\", desc_count);\n\n\tbt_uuid16_create(&ext_prop_uuid, GATT_CHARAC_EXT_PROPER_UUID);\n\n\twhile (bt_gatt_iter_next_descriptor(&iter, &handle, u128.data)) {\n\t\tbt_uuid128_create(&uuid, u128);\n\n\t\t/* Log debug message */\n\t\tbt_uuid_to_string(&uuid, uuid_str, sizeof(uuid_str));\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\t\"handle: 0x%04x, uuid: %s\",\n\t\t\t\t\t\thandle, uuid_str);\n\n\t\tattr = gatt_db_insert_descriptor(client->db, handle,\n\t\t\t\t\t\t\t&uuid, 0, NULL, NULL,\n\t\t\t\t\t\t\tNULL);\n\t\tif (!attr) {\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to insert descriptor at 0x%04x\",\n\t\t\t\thandle);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (gatt_db_attribute_get_handle(attr) != handle)\n\t\t\tgoto failed;\n\n\t\tif (!bt_uuid_cmp(&ext_prop_uuid, &uuid))\n\t\t\tqueue_push_tail(op->ext_prop_desc, attr);\n\t}\n\n\t/* If we got extended prop descriptor, lets read it right away */\n\tif (read_ext_prop_desc(op))\n\t\treturn;\n\nnext:\n\tif (!discover_descs(op, &discovering))\n\t\tgoto failed;\n\n\tif (discovering)\n\t\treturn;\n\n\t/* Done with the current service */\n\tgatt_db_service_set_active(op->cur_svc, true);\n\n\tgoto done;\n\nfailed:\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 832
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "352-385",
          "snippet": "static void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_service_set_active",
          "args": [
            "op->cur_svc",
            "true"
          ],
          "line": 824
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_service_set_active",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "975-992",
          "snippet": "bool gatt_db_service_set_active(struct gatt_db_attribute *attrib, bool active)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tif (service->active == active)\n\t\treturn true;\n\n\tservice->active = active;\n\n\tnotify_service_changed(service->db, service, active);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_service_set_active(struct gatt_db_attribute *attrib, bool active)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tif (service->active == active)\n\t\treturn true;\n\n\tservice->active = active;\n\n\tnotify_service_changed(service->db, service, active);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discover_descs",
          "args": [
            "op",
            "&discovering"
          ],
          "line": 817
        },
        "resolved": true,
        "details": {
          "function_name": "discover_descs",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "578-667",
          "snippet": "static bool discover_descs(struct discovery_op *op, bool *discovering)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tstruct gatt_db_attribute *attr;\n\tstruct chrc *chrc_data;\n\tuint16_t desc_start;\n\n\t*discovering = false;\n\n\twhile ((chrc_data = queue_pop_head(op->pending_chrcs))) {\n\t\tstruct gatt_db_attribute *svc;\n\t\tuint16_t start, end;\n\n\t\t/* Adjust current service */\n\t\tsvc = gatt_db_get_service(client->db, chrc_data->value_handle);\n\t\tif (op->cur_svc != svc) {\n\t\t\tif (op->cur_svc) {\n\t\t\t\tqueue_remove(op->pending_svcs, op->cur_svc);\n\n\t\t\t\t/* Done with the current service */\n\t\t\t\tgatt_db_service_set_active(op->cur_svc, true);\n\t\t\t}\n\n\t\t\top->cur_svc = svc;\n\t\t}\n\n\t\tattr = gatt_db_insert_characteristic(client->db,\n\t\t\t\t\t\t\tchrc_data->value_handle,\n\t\t\t\t\t\t\t&chrc_data->uuid, 0,\n\t\t\t\t\t\t\tchrc_data->properties,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\t\tif (!attr) {\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to insert characteristic at 0x%04x\",\n\t\t\t\tchrc_data->value_handle);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (gatt_db_attribute_get_handle(attr) !=\n\t\t\t\t\t\t\tchrc_data->value_handle)\n\t\t\tgoto failed;\n\n\t\tgatt_db_attribute_get_service_handles(svc, &start, &end);\n\n\t\t/*\n\t\t * Ajust end_handle in case the next chrc is not within the\n\t\t * same service.\n\t\t */\n\t\tif (chrc_data->end_handle > end)\n\t\t\tchrc_data->end_handle = end;\n\n\t\t/*\n\t\t * check for descriptors presence, before initializing the\n\t\t * desc_handle and avoid integer overflow during desc_handle\n\t\t * intialization.\n\t\t */\n\t\tif (chrc_data->value_handle >= chrc_data->end_handle) {\n\t\t\tfree(chrc_data);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdesc_start = chrc_data->value_handle + 1;\n\n\t\tclient->discovery_req = bt_gatt_discover_descriptors(\n\t\t\t\t\t\t\tclient->att, desc_start,\n\t\t\t\t\t\t\tchrc_data->end_handle,\n\t\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\t\tif (client->discovery_req) {\n\t\t\t*discovering = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to start descriptor discovery\");\n\t\tdiscovery_op_unref(op);\n\n\t\tgoto failed;\n\t}\n\ndone:\n\tfree(chrc_data);\n\treturn true;\n\nfailed:\n\tfree(chrc_data);\n\treturn false;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);\n\nstatic bool discover_descs(struct discovery_op *op, bool *discovering)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tstruct gatt_db_attribute *attr;\n\tstruct chrc *chrc_data;\n\tuint16_t desc_start;\n\n\t*discovering = false;\n\n\twhile ((chrc_data = queue_pop_head(op->pending_chrcs))) {\n\t\tstruct gatt_db_attribute *svc;\n\t\tuint16_t start, end;\n\n\t\t/* Adjust current service */\n\t\tsvc = gatt_db_get_service(client->db, chrc_data->value_handle);\n\t\tif (op->cur_svc != svc) {\n\t\t\tif (op->cur_svc) {\n\t\t\t\tqueue_remove(op->pending_svcs, op->cur_svc);\n\n\t\t\t\t/* Done with the current service */\n\t\t\t\tgatt_db_service_set_active(op->cur_svc, true);\n\t\t\t}\n\n\t\t\top->cur_svc = svc;\n\t\t}\n\n\t\tattr = gatt_db_insert_characteristic(client->db,\n\t\t\t\t\t\t\tchrc_data->value_handle,\n\t\t\t\t\t\t\t&chrc_data->uuid, 0,\n\t\t\t\t\t\t\tchrc_data->properties,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\t\tif (!attr) {\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to insert characteristic at 0x%04x\",\n\t\t\t\tchrc_data->value_handle);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (gatt_db_attribute_get_handle(attr) !=\n\t\t\t\t\t\t\tchrc_data->value_handle)\n\t\t\tgoto failed;\n\n\t\tgatt_db_attribute_get_service_handles(svc, &start, &end);\n\n\t\t/*\n\t\t * Ajust end_handle in case the next chrc is not within the\n\t\t * same service.\n\t\t */\n\t\tif (chrc_data->end_handle > end)\n\t\t\tchrc_data->end_handle = end;\n\n\t\t/*\n\t\t * check for descriptors presence, before initializing the\n\t\t * desc_handle and avoid integer overflow during desc_handle\n\t\t * intialization.\n\t\t */\n\t\tif (chrc_data->value_handle >= chrc_data->end_handle) {\n\t\t\tfree(chrc_data);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdesc_start = chrc_data->value_handle + 1;\n\n\t\tclient->discovery_req = bt_gatt_discover_descriptors(\n\t\t\t\t\t\t\tclient->att, desc_start,\n\t\t\t\t\t\t\tchrc_data->end_handle,\n\t\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\t\tif (client->discovery_req) {\n\t\t\t*discovering = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to start descriptor discovery\");\n\t\tdiscovery_op_unref(op);\n\n\t\tgoto failed;\n\t}\n\ndone:\n\tfree(chrc_data);\n\treturn true;\n\nfailed:\n\tfree(chrc_data);\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "read_ext_prop_desc",
          "args": [
            "op"
          ],
          "line": 813
        },
        "resolved": true,
        "details": {
          "function_name": "read_ext_prop_desc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "682-700",
          "snippet": "static bool read_ext_prop_desc(struct discovery_op *op)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tuint16_t handle;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_peek_head(op->ext_prop_desc);\n\tif (!attr)\n\t\treturn false;\n\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\tif (!bt_gatt_client_read_value(client, handle, ext_prop_read_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref))\n\t\treturn false;\n\n\treturn true;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool read_ext_prop_desc(struct discovery_op *op)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tuint16_t handle;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_peek_head(op->ext_prop_desc);\n\tif (!attr)\n\t\treturn false;\n\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\tif (!bt_gatt_client_read_value(client, handle, ext_prop_read_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref))\n\t\treturn false;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "op->ext_prop_desc",
            "attr"
          ],
          "line": 809
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_cmp",
          "args": [
            "&ext_prop_uuid",
            "&uuid"
          ],
          "line": 808
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 805
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Failed to insert descriptor at 0x%04x\"",
            "handle"
          ],
          "line": 799
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_insert_descriptor",
          "args": [
            "client->db",
            "handle",
            "&uuid",
            "0",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 795
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_insert_descriptor",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "830-848",
          "snippet": "struct gatt_db_attribute *\ngatt_db_insert_descriptor(struct gatt_db *db,\n\t\t\t\t\tuint16_t handle,\n\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\tuint32_t permissions,\n\t\t\t\t\tgatt_db_read_t read_func,\n\t\t\t\t\tgatt_db_write_t write_func,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct gatt_db_attribute *attrib;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn service_insert_descriptor(attrib->service, handle, uuid,\n\t\t\t\t\tpermissions, read_func, write_func,\n\t\t\t\t\tuser_data);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *\ngatt_db_insert_descriptor(struct gatt_db *db,\n\t\t\t\t\tuint16_t handle,\n\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\tuint32_t permissions,\n\t\t\t\t\tgatt_db_read_t read_func,\n\t\t\t\t\tgatt_db_write_t write_func,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct gatt_db_attribute *attrib;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn service_insert_descriptor(attrib->service, handle, uuid,\n\t\t\t\t\tpermissions, read_func, write_func,\n\t\t\t\t\tuser_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_to_string",
          "args": [
            "&uuid",
            "uuid_str",
            "sizeof(uuid_str)"
          ],
          "line": 790
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid128_create",
          "args": [
            "&uuid",
            "u128"
          ],
          "line": 787
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_iter_next_descriptor",
          "args": [
            "&iter",
            "&handle",
            "u128.data"
          ],
          "line": 786
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_iter_next_descriptor",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "418-441",
          "snippet": "bool bt_gatt_iter_next_descriptor(struct bt_gatt_iter *iter, uint16_t *handle,\n\t\t\t\t\t\t\tuint8_t uuid[16])\n{\n\tconst void *pdu_ptr;\n\n\tif (!iter || !iter->result || !handle || !uuid)\n\t\treturn false;\n\n\tif (iter->result->opcode != BT_ATT_OP_FIND_INFO_RSP)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t*handle = get_le16(pdu_ptr);\n\tconvert_uuid_le(pdu_ptr + 2, iter->result->data_len - 2, uuid);\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_next_descriptor(struct bt_gatt_iter *iter, uint16_t *handle,\n\t\t\t\t\t\t\tuint8_t uuid[16])\n{\n\tconst void *pdu_ptr;\n\n\tif (!iter || !iter->result || !handle || !uuid)\n\t\treturn false;\n\n\tif (iter->result->opcode != BT_ATT_OP_FIND_INFO_RSP)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t*handle = get_le16(pdu_ptr);\n\tconvert_uuid_le(pdu_ptr + 2, iter->result->data_len - 2, uuid);\n\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = iter->result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid16_create",
          "args": [
            "&ext_prop_uuid",
            "GATT_CHARAC_EXT_PROPER_UUID"
          ],
          "line": 784
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_result_descriptor_count",
          "args": [
            "result"
          ],
          "line": 777
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_result_descriptor_count",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "137-146",
          "snippet": "unsigned int bt_gatt_result_descriptor_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_FIND_INFO_RSP)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nunsigned int bt_gatt_result_descriptor_count(struct bt_gatt_result *result)\n{\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_FIND_INFO_RSP)\n\t\treturn 0;\n\n\treturn result_element_count(result);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_iter_init",
          "args": [
            "&iter",
            "result"
          ],
          "line": 774
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_iter_init",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "176-185",
          "snippet": "bool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_req_clear",
          "args": [
            "client"
          ],
          "line": 763
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_req_clear",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "466-473",
          "snippet": "static void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tstruct bt_gatt_iter iter;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t handle;\n\tuint128_t u128;\n\tbt_uuid_t uuid;\n\tchar uuid_str[MAX_LEN_UUID_STR];\n\tunsigned int desc_count;\n\tbool discovering;\n\tbt_uuid_t ext_prop_uuid;\n\n\tdiscovery_req_clear(client);\n\n\tif (!success) {\n\t\tif (att_ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND) {\n\t\t\tsuccess = true;\n\t\t\tgoto next;\n\t\t}\n\n\t\tgoto done;\n\t}\n\n\tif (!result || !bt_gatt_iter_init(&iter, result))\n\t\tgoto failed;\n\n\tdesc_count = bt_gatt_result_descriptor_count(result);\n\tif (desc_count == 0)\n\t\tgoto failed;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Descriptors found: %u\", desc_count);\n\n\tbt_uuid16_create(&ext_prop_uuid, GATT_CHARAC_EXT_PROPER_UUID);\n\n\twhile (bt_gatt_iter_next_descriptor(&iter, &handle, u128.data)) {\n\t\tbt_uuid128_create(&uuid, u128);\n\n\t\t/* Log debug message */\n\t\tbt_uuid_to_string(&uuid, uuid_str, sizeof(uuid_str));\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\t\"handle: 0x%04x, uuid: %s\",\n\t\t\t\t\t\thandle, uuid_str);\n\n\t\tattr = gatt_db_insert_descriptor(client->db, handle,\n\t\t\t\t\t\t\t&uuid, 0, NULL, NULL,\n\t\t\t\t\t\t\tNULL);\n\t\tif (!attr) {\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to insert descriptor at 0x%04x\",\n\t\t\t\thandle);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (gatt_db_attribute_get_handle(attr) != handle)\n\t\t\tgoto failed;\n\n\t\tif (!bt_uuid_cmp(&ext_prop_uuid, &uuid))\n\t\t\tqueue_push_tail(op->ext_prop_desc, attr);\n\t}\n\n\t/* If we got extended prop descriptor, lets read it right away */\n\tif (read_ext_prop_desc(op))\n\t\treturn;\n\nnext:\n\tif (!discover_descs(op, &discovering))\n\t\tgoto failed;\n\n\tif (discovering)\n\t\treturn;\n\n\t/* Done with the current service */\n\tgatt_db_service_set_active(op->cur_svc, true);\n\n\tgoto done;\n\nfailed:\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "ext_prop_read_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "702-745",
    "snippet": "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tbool discovering;\n\tstruct gatt_db_attribute *desc_attr = NULL;\n\n\tif (!success)\n\t\tgoto done;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Ext. prop value: 0x%04x\", (uint16_t)value[0]);\n\n\tdesc_attr = queue_pop_head(op->ext_prop_desc);\n\tif (!desc_attr)\n\t\tgoto failed;\n\n\tif (!gatt_db_attribute_write(desc_attr, 0, value, length, 0, NULL,\n\t\t\t\t\t\text_prop_write_cb, client))\n\t\tgoto failed;\n\n\t/* Any other descriptor to read? */\n\tif (read_ext_prop_desc(op))\n\t\treturn;\n\n\tif (!discover_descs(op, &discovering))\n\t\t\tgoto failed;\n\n\tif (discovering)\n\t\treturn;\n\n\t/* Done with the current service */\n\tgatt_db_service_set_active(op->cur_svc, true);\n\n\tgoto done;\n\nfailed:\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "success",
            "att_ecode"
          ],
          "line": 744
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "352-385",
          "snippet": "static void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_service_set_active",
          "args": [
            "op->cur_svc",
            "true"
          ],
          "line": 736
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_service_set_active",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "975-992",
          "snippet": "bool gatt_db_service_set_active(struct gatt_db_attribute *attrib, bool active)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tif (service->active == active)\n\t\treturn true;\n\n\tservice->active = active;\n\n\tnotify_service_changed(service->db, service, active);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_service_set_active(struct gatt_db_attribute *attrib, bool active)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tif (service->active == active)\n\t\treturn true;\n\n\tservice->active = active;\n\n\tnotify_service_changed(service->db, service, active);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discover_descs",
          "args": [
            "op",
            "&discovering"
          ],
          "line": 729
        },
        "resolved": true,
        "details": {
          "function_name": "discover_descs",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "578-667",
          "snippet": "static bool discover_descs(struct discovery_op *op, bool *discovering)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tstruct gatt_db_attribute *attr;\n\tstruct chrc *chrc_data;\n\tuint16_t desc_start;\n\n\t*discovering = false;\n\n\twhile ((chrc_data = queue_pop_head(op->pending_chrcs))) {\n\t\tstruct gatt_db_attribute *svc;\n\t\tuint16_t start, end;\n\n\t\t/* Adjust current service */\n\t\tsvc = gatt_db_get_service(client->db, chrc_data->value_handle);\n\t\tif (op->cur_svc != svc) {\n\t\t\tif (op->cur_svc) {\n\t\t\t\tqueue_remove(op->pending_svcs, op->cur_svc);\n\n\t\t\t\t/* Done with the current service */\n\t\t\t\tgatt_db_service_set_active(op->cur_svc, true);\n\t\t\t}\n\n\t\t\top->cur_svc = svc;\n\t\t}\n\n\t\tattr = gatt_db_insert_characteristic(client->db,\n\t\t\t\t\t\t\tchrc_data->value_handle,\n\t\t\t\t\t\t\t&chrc_data->uuid, 0,\n\t\t\t\t\t\t\tchrc_data->properties,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\t\tif (!attr) {\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to insert characteristic at 0x%04x\",\n\t\t\t\tchrc_data->value_handle);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (gatt_db_attribute_get_handle(attr) !=\n\t\t\t\t\t\t\tchrc_data->value_handle)\n\t\t\tgoto failed;\n\n\t\tgatt_db_attribute_get_service_handles(svc, &start, &end);\n\n\t\t/*\n\t\t * Ajust end_handle in case the next chrc is not within the\n\t\t * same service.\n\t\t */\n\t\tif (chrc_data->end_handle > end)\n\t\t\tchrc_data->end_handle = end;\n\n\t\t/*\n\t\t * check for descriptors presence, before initializing the\n\t\t * desc_handle and avoid integer overflow during desc_handle\n\t\t * intialization.\n\t\t */\n\t\tif (chrc_data->value_handle >= chrc_data->end_handle) {\n\t\t\tfree(chrc_data);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdesc_start = chrc_data->value_handle + 1;\n\n\t\tclient->discovery_req = bt_gatt_discover_descriptors(\n\t\t\t\t\t\t\tclient->att, desc_start,\n\t\t\t\t\t\t\tchrc_data->end_handle,\n\t\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\t\tif (client->discovery_req) {\n\t\t\t*discovering = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to start descriptor discovery\");\n\t\tdiscovery_op_unref(op);\n\n\t\tgoto failed;\n\t}\n\ndone:\n\tfree(chrc_data);\n\treturn true;\n\nfailed:\n\tfree(chrc_data);\n\treturn false;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);\n\nstatic bool discover_descs(struct discovery_op *op, bool *discovering)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tstruct gatt_db_attribute *attr;\n\tstruct chrc *chrc_data;\n\tuint16_t desc_start;\n\n\t*discovering = false;\n\n\twhile ((chrc_data = queue_pop_head(op->pending_chrcs))) {\n\t\tstruct gatt_db_attribute *svc;\n\t\tuint16_t start, end;\n\n\t\t/* Adjust current service */\n\t\tsvc = gatt_db_get_service(client->db, chrc_data->value_handle);\n\t\tif (op->cur_svc != svc) {\n\t\t\tif (op->cur_svc) {\n\t\t\t\tqueue_remove(op->pending_svcs, op->cur_svc);\n\n\t\t\t\t/* Done with the current service */\n\t\t\t\tgatt_db_service_set_active(op->cur_svc, true);\n\t\t\t}\n\n\t\t\top->cur_svc = svc;\n\t\t}\n\n\t\tattr = gatt_db_insert_characteristic(client->db,\n\t\t\t\t\t\t\tchrc_data->value_handle,\n\t\t\t\t\t\t\t&chrc_data->uuid, 0,\n\t\t\t\t\t\t\tchrc_data->properties,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\t\tif (!attr) {\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to insert characteristic at 0x%04x\",\n\t\t\t\tchrc_data->value_handle);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (gatt_db_attribute_get_handle(attr) !=\n\t\t\t\t\t\t\tchrc_data->value_handle)\n\t\t\tgoto failed;\n\n\t\tgatt_db_attribute_get_service_handles(svc, &start, &end);\n\n\t\t/*\n\t\t * Ajust end_handle in case the next chrc is not within the\n\t\t * same service.\n\t\t */\n\t\tif (chrc_data->end_handle > end)\n\t\t\tchrc_data->end_handle = end;\n\n\t\t/*\n\t\t * check for descriptors presence, before initializing the\n\t\t * desc_handle and avoid integer overflow during desc_handle\n\t\t * intialization.\n\t\t */\n\t\tif (chrc_data->value_handle >= chrc_data->end_handle) {\n\t\t\tfree(chrc_data);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdesc_start = chrc_data->value_handle + 1;\n\n\t\tclient->discovery_req = bt_gatt_discover_descriptors(\n\t\t\t\t\t\t\tclient->att, desc_start,\n\t\t\t\t\t\t\tchrc_data->end_handle,\n\t\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\t\tif (client->discovery_req) {\n\t\t\t*discovering = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to start descriptor discovery\");\n\t\tdiscovery_op_unref(op);\n\n\t\tgoto failed;\n\t}\n\ndone:\n\tfree(chrc_data);\n\treturn true;\n\nfailed:\n\tfree(chrc_data);\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "read_ext_prop_desc",
          "args": [
            "op"
          ],
          "line": 726
        },
        "resolved": true,
        "details": {
          "function_name": "read_ext_prop_desc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "682-700",
          "snippet": "static bool read_ext_prop_desc(struct discovery_op *op)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tuint16_t handle;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_peek_head(op->ext_prop_desc);\n\tif (!attr)\n\t\treturn false;\n\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\tif (!bt_gatt_client_read_value(client, handle, ext_prop_read_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref))\n\t\treturn false;\n\n\treturn true;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool read_ext_prop_desc(struct discovery_op *op)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tuint16_t handle;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_peek_head(op->ext_prop_desc);\n\tif (!attr)\n\t\treturn false;\n\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\tif (!bt_gatt_client_read_value(client, handle, ext_prop_read_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref))\n\t\treturn false;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_write",
          "args": [
            "desc_attr",
            "0",
            "value",
            "length",
            "0",
            "NULL",
            "ext_prop_write_cb",
            "client"
          ],
          "line": 721
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1805-1860",
          "snippet": "bool gatt_db_attribute_write(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\t\tgatt_db_attribute_write_t func,\n\t\t\t\t\tvoid *user_data)\n{\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->write_func) {\n\t\tstruct pending_write *p;\n\n\t\tp = new0(struct pending_write, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->write_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, write_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_writes, p);\n\n\t\tattrib->write_func(attrib, p->id, offset, value, len, opcode,\n\t\t\t\t\t\t\tatt, attrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Nothing to write just skip */\n\tif (len == 0)\n\t\tgoto done;\n\n\t/* For values stored in db allocate on demand */\n\tif (!attrib->value || offset >= attrib->value_len ||\n\t\t\t\tlen > (unsigned) (attrib->value_len - offset)) {\n\t\tvoid *buf;\n\n\t\tbuf = realloc(attrib->value, len + offset);\n\t\tif (!buf)\n\t\t\treturn false;\n\n\t\tattrib->value = buf;\n\n\t\t/* Init data in the first allocation */\n\t\tif (!attrib->value_len)\n\t\t\tmemset(attrib->value, 0, offset);\n\n\t\tattrib->value_len = len + offset;\n\t}\n\n\tmemcpy(&attrib->value[offset], value, len);\n\ndone:\n\tfunc(attrib, 0, user_data);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATTRIBUTE_TIMEOUT 5000"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\n#define ATTRIBUTE_TIMEOUT 5000\n\nbool gatt_db_attribute_write(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\t\tgatt_db_attribute_write_t func,\n\t\t\t\t\tvoid *user_data)\n{\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->write_func) {\n\t\tstruct pending_write *p;\n\n\t\tp = new0(struct pending_write, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->write_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, write_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_writes, p);\n\n\t\tattrib->write_func(attrib, p->id, offset, value, len, opcode,\n\t\t\t\t\t\t\tatt, attrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Nothing to write just skip */\n\tif (len == 0)\n\t\tgoto done;\n\n\t/* For values stored in db allocate on demand */\n\tif (!attrib->value || offset >= attrib->value_len ||\n\t\t\t\tlen > (unsigned) (attrib->value_len - offset)) {\n\t\tvoid *buf;\n\n\t\tbuf = realloc(attrib->value, len + offset);\n\t\tif (!buf)\n\t\t\treturn false;\n\n\t\tattrib->value = buf;\n\n\t\t/* Init data in the first allocation */\n\t\tif (!attrib->value_len)\n\t\t\tmemset(attrib->value, 0, offset);\n\n\t\tattrib->value_len = len + offset;\n\t}\n\n\tmemcpy(&attrib->value[offset], value, len);\n\ndone:\n\tfunc(attrib, 0, user_data);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "op->ext_prop_desc"
          ],
          "line": 717
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Ext. prop value: 0x%04x\"",
            "(uint16_t)value[0]"
          ],
          "line": 714
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tbool discovering;\n\tstruct gatt_db_attribute *desc_attr = NULL;\n\n\tif (!success)\n\t\tgoto done;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Ext. prop value: 0x%04x\", (uint16_t)value[0]);\n\n\tdesc_attr = queue_pop_head(op->ext_prop_desc);\n\tif (!desc_attr)\n\t\tgoto failed;\n\n\tif (!gatt_db_attribute_write(desc_attr, 0, value, length, 0, NULL,\n\t\t\t\t\t\text_prop_write_cb, client))\n\t\tgoto failed;\n\n\t/* Any other descriptor to read? */\n\tif (read_ext_prop_desc(op))\n\t\treturn;\n\n\tif (!discover_descs(op, &discovering))\n\t\t\tgoto failed;\n\n\tif (discovering)\n\t\treturn;\n\n\t/* Done with the current service */\n\tgatt_db_service_set_active(op->cur_svc, true);\n\n\tgoto done;\n\nfailed:\n\tsuccess = false;\n\ndone:\n\tdiscovery_op_complete(op, success, att_ecode);\n}"
  },
  {
    "function_name": "read_ext_prop_desc",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "682-700",
    "snippet": "static bool read_ext_prop_desc(struct discovery_op *op)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tuint16_t handle;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_peek_head(op->ext_prop_desc);\n\tif (!attr)\n\t\treturn false;\n\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\tif (!bt_gatt_client_read_value(client, handle, ext_prop_read_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref))\n\t\treturn false;\n\n\treturn true;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_client_read_value",
          "args": [
            "client",
            "handle",
            "ext_prop_read_cb",
            "discovery_op_ref(op)",
            "discovery_op_unref"
          ],
          "line": 694
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_client_read_value",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2260-2301",
          "snippet": "unsigned int bt_gatt_client_read_value(struct bt_gatt_client *client,\n\t\t\t\t\tuint16_t value_handle,\n\t\t\t\t\tbt_gatt_client_read_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct read_op *op;\n\tuint8_t pdu[2];\n\n\tif (!client)\n\t\treturn 0;\n\n\top = new0(struct read_op, 1);\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = destroy_read_op;\n\n\tput_le16(value_handle, pdu);\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_READ_REQ,\n\t\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_cb, req,\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nunsigned int bt_gatt_client_read_value(struct bt_gatt_client *client,\n\t\t\t\t\tuint16_t value_handle,\n\t\t\t\t\tbt_gatt_client_read_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_client_destroy_func_t destroy)\n{\n\tstruct request *req;\n\tstruct read_op *op;\n\tuint8_t pdu[2];\n\n\tif (!client)\n\t\treturn 0;\n\n\top = new0(struct read_op, 1);\n\n\treq = request_create(client);\n\tif (!req) {\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\n\treq->data = op;\n\treq->destroy = destroy_read_op;\n\n\tput_le16(value_handle, pdu);\n\n\treq->att_id = bt_att_send(client->att, BT_ATT_OP_READ_REQ,\n\t\t\t\t\t\t\tpdu, sizeof(pdu),\n\t\t\t\t\t\t\tread_cb, req,\n\t\t\t\t\t\t\trequest_unref);\n\tif (!req->att_id) {\n\t\top->destroy = NULL;\n\t\trequest_unref(req);\n\t\treturn 0;\n\t}\n\n\treturn req->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_ref",
          "args": [
            "op"
          ],
          "line": 695
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "446-451",
          "snippet": "static struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 692
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_peek_head",
          "args": [
            "op->ext_prop_desc"
          ],
          "line": 688
        },
        "resolved": true,
        "details": {
          "function_name": "queue_peek_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "187-193",
          "snippet": "void *queue_peek_head(struct queue *queue)\n{\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\treturn queue->head->data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_peek_head(struct queue *queue)\n{\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\treturn queue->head->data;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool read_ext_prop_desc(struct discovery_op *op)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tuint16_t handle;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_peek_head(op->ext_prop_desc);\n\tif (!attr)\n\t\treturn false;\n\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\tif (!bt_gatt_client_read_value(client, handle, ext_prop_read_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref))\n\t\treturn false;\n\n\treturn true;\n}"
  },
  {
    "function_name": "ext_prop_write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "669-676",
    "snippet": "static void ext_prop_write_cb(struct gatt_db_attribute *attrib,\n\t\t\t\t\t\tint err, void *user_data)\n{\n\tstruct bt_gatt_client *client = user_data;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\t\"Value set status: %d\", err);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Value set status: %d\"",
            "err"
          ],
          "line": 674
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void ext_prop_write_cb(struct gatt_db_attribute *attrib,\n\t\t\t\t\t\tint err, void *user_data)\n{\n\tstruct bt_gatt_client *client = user_data;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\t\"Value set status: %d\", err);\n}"
  },
  {
    "function_name": "discover_descs",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "578-667",
    "snippet": "static bool discover_descs(struct discovery_op *op, bool *discovering)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tstruct gatt_db_attribute *attr;\n\tstruct chrc *chrc_data;\n\tuint16_t desc_start;\n\n\t*discovering = false;\n\n\twhile ((chrc_data = queue_pop_head(op->pending_chrcs))) {\n\t\tstruct gatt_db_attribute *svc;\n\t\tuint16_t start, end;\n\n\t\t/* Adjust current service */\n\t\tsvc = gatt_db_get_service(client->db, chrc_data->value_handle);\n\t\tif (op->cur_svc != svc) {\n\t\t\tif (op->cur_svc) {\n\t\t\t\tqueue_remove(op->pending_svcs, op->cur_svc);\n\n\t\t\t\t/* Done with the current service */\n\t\t\t\tgatt_db_service_set_active(op->cur_svc, true);\n\t\t\t}\n\n\t\t\top->cur_svc = svc;\n\t\t}\n\n\t\tattr = gatt_db_insert_characteristic(client->db,\n\t\t\t\t\t\t\tchrc_data->value_handle,\n\t\t\t\t\t\t\t&chrc_data->uuid, 0,\n\t\t\t\t\t\t\tchrc_data->properties,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\t\tif (!attr) {\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to insert characteristic at 0x%04x\",\n\t\t\t\tchrc_data->value_handle);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (gatt_db_attribute_get_handle(attr) !=\n\t\t\t\t\t\t\tchrc_data->value_handle)\n\t\t\tgoto failed;\n\n\t\tgatt_db_attribute_get_service_handles(svc, &start, &end);\n\n\t\t/*\n\t\t * Ajust end_handle in case the next chrc is not within the\n\t\t * same service.\n\t\t */\n\t\tif (chrc_data->end_handle > end)\n\t\t\tchrc_data->end_handle = end;\n\n\t\t/*\n\t\t * check for descriptors presence, before initializing the\n\t\t * desc_handle and avoid integer overflow during desc_handle\n\t\t * intialization.\n\t\t */\n\t\tif (chrc_data->value_handle >= chrc_data->end_handle) {\n\t\t\tfree(chrc_data);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdesc_start = chrc_data->value_handle + 1;\n\n\t\tclient->discovery_req = bt_gatt_discover_descriptors(\n\t\t\t\t\t\t\tclient->att, desc_start,\n\t\t\t\t\t\t\tchrc_data->end_handle,\n\t\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\t\tif (client->discovery_req) {\n\t\t\t*discovering = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to start descriptor discovery\");\n\t\tdiscovery_op_unref(op);\n\n\t\tgoto failed;\n\t}\n\ndone:\n\tfree(chrc_data);\n\treturn true;\n\nfailed:\n\tfree(chrc_data);\n\treturn false;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "chrc_data"
          ],
          "line": 665
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_unref",
          "args": [
            "op"
          ],
          "line": 655
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "453-464",
          "snippet": "static void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Failed to start descriptor discovery\""
          ],
          "line": 653
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_discover_descriptors",
          "args": [
            "client->att",
            "desc_start",
            "chrc_data->end_handle",
            "discover_descs_cb",
            "discovery_op_ref(op)",
            "discovery_op_unref"
          ],
          "line": 642
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_discover_descriptors",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "1481-1514",
          "snippet": "struct bt_gatt_request *bt_gatt_discover_descriptors(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[4];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\n\top->id = bt_att_send(att, BT_ATT_OP_FIND_INFO_REQ, pdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_descriptors(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[4];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\n\top->id = bt_att_send(att, BT_ATT_OP_FIND_INFO_REQ, pdu, sizeof(pdu),\n\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\tbt_gatt_request_ref(op),\n\t\t\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_ref",
          "args": [
            "op"
          ],
          "line": 646
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "446-451",
          "snippet": "static struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_service_handles",
          "args": [
            "svc",
            "&start",
            "&end"
          ],
          "line": 621
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_service_handles",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1521-1536",
          "snippet": "bool gatt_db_attribute_get_service_handles(\n\t\t\t\t\tconst struct gatt_db_attribute *attrib,\n\t\t\t\t\tuint16_t *start_handle,\n\t\t\t\t\tuint16_t *end_handle)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tgatt_db_service_get_handles(service, start_handle, end_handle);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_attribute_get_service_handles(\n\t\t\t\t\tconst struct gatt_db_attribute *attrib,\n\t\t\t\t\tuint16_t *start_handle,\n\t\t\t\t\tuint16_t *end_handle)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tgatt_db_service_get_handles(service, start_handle, end_handle);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 617
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_insert_characteristic",
          "args": [
            "client->db",
            "chrc_data->value_handle",
            "&chrc_data->uuid",
            "0",
            "chrc_data->properties",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 604
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_insert_characteristic",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "739-759",
          "snippet": "struct gatt_db_attribute *\ngatt_db_insert_characteristic(struct gatt_db *db,\n\t\t\t\t\tuint16_t handle,\n\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\tuint32_t permissions,\n\t\t\t\t\tuint8_t properties,\n\t\t\t\t\tgatt_db_read_t read_func,\n\t\t\t\t\tgatt_db_write_t write_func,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct gatt_db_attribute *attrib;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn service_insert_characteristic(attrib->service, handle, uuid,\n\t\t\t\t\t\tpermissions, properties,\n\t\t\t\t\t\tread_func, write_func,\n\t\t\t\t\t\tuser_data);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *\ngatt_db_insert_characteristic(struct gatt_db *db,\n\t\t\t\t\tuint16_t handle,\n\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\tuint32_t permissions,\n\t\t\t\t\tuint8_t properties,\n\t\t\t\t\tgatt_db_read_t read_func,\n\t\t\t\t\tgatt_db_write_t write_func,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct gatt_db_attribute *attrib;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn service_insert_characteristic(attrib->service, handle, uuid,\n\t\t\t\t\t\tpermissions, properties,\n\t\t\t\t\t\tread_func, write_func,\n\t\t\t\t\t\tuser_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_service_set_active",
          "args": [
            "op->cur_svc",
            "true"
          ],
          "line": 598
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_service_set_active",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "975-992",
          "snippet": "bool gatt_db_service_set_active(struct gatt_db_attribute *attrib, bool active)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tif (service->active == active)\n\t\treturn true;\n\n\tservice->active = active;\n\n\tnotify_service_changed(service->db, service, active);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_service_set_active(struct gatt_db_attribute *attrib, bool active)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tif (service->active == active)\n\t\treturn true;\n\n\tservice->active = active;\n\n\tnotify_service_changed(service->db, service, active);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "op->pending_svcs",
            "op->cur_svc"
          ],
          "line": 595
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_get_service",
          "args": [
            "client->db",
            "chrc_data->value_handle"
          ],
          "line": 592
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_get_service_with_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1458-1471",
          "snippet": "struct gatt_db_attribute *gatt_db_get_service_with_uuid(struct gatt_db *db,\n\t\t\t\t\t\t\tconst bt_uuid_t *uuid)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!db || !uuid)\n\t\treturn NULL;\n\n\tservice = queue_find(db->services, find_service_with_uuid, uuid);\n\tif (!service)\n\t\treturn NULL;\n\n\treturn service->attributes[0];\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *gatt_db_get_service_with_uuid(struct gatt_db *db,\n\t\t\t\t\t\t\tconst bt_uuid_t *uuid)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!db || !uuid)\n\t\treturn NULL;\n\n\tservice = queue_find(db->services, find_service_with_uuid, uuid);\n\tif (!service)\n\t\treturn NULL;\n\n\treturn service->attributes[0];\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "op->pending_chrcs"
          ],
          "line": 587
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void process_service_changed(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle);\n\nstatic bool discover_descs(struct discovery_op *op, bool *discovering)\n{\n\tstruct bt_gatt_client *client = op->client;\n\tstruct gatt_db_attribute *attr;\n\tstruct chrc *chrc_data;\n\tuint16_t desc_start;\n\n\t*discovering = false;\n\n\twhile ((chrc_data = queue_pop_head(op->pending_chrcs))) {\n\t\tstruct gatt_db_attribute *svc;\n\t\tuint16_t start, end;\n\n\t\t/* Adjust current service */\n\t\tsvc = gatt_db_get_service(client->db, chrc_data->value_handle);\n\t\tif (op->cur_svc != svc) {\n\t\t\tif (op->cur_svc) {\n\t\t\t\tqueue_remove(op->pending_svcs, op->cur_svc);\n\n\t\t\t\t/* Done with the current service */\n\t\t\t\tgatt_db_service_set_active(op->cur_svc, true);\n\t\t\t}\n\n\t\t\top->cur_svc = svc;\n\t\t}\n\n\t\tattr = gatt_db_insert_characteristic(client->db,\n\t\t\t\t\t\t\tchrc_data->value_handle,\n\t\t\t\t\t\t\t&chrc_data->uuid, 0,\n\t\t\t\t\t\t\tchrc_data->properties,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\t\tif (!attr) {\n\t\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to insert characteristic at 0x%04x\",\n\t\t\t\tchrc_data->value_handle);\n\t\t\tgoto failed;\n\t\t}\n\n\t\tif (gatt_db_attribute_get_handle(attr) !=\n\t\t\t\t\t\t\tchrc_data->value_handle)\n\t\t\tgoto failed;\n\n\t\tgatt_db_attribute_get_service_handles(svc, &start, &end);\n\n\t\t/*\n\t\t * Ajust end_handle in case the next chrc is not within the\n\t\t * same service.\n\t\t */\n\t\tif (chrc_data->end_handle > end)\n\t\t\tchrc_data->end_handle = end;\n\n\t\t/*\n\t\t * check for descriptors presence, before initializing the\n\t\t * desc_handle and avoid integer overflow during desc_handle\n\t\t * intialization.\n\t\t */\n\t\tif (chrc_data->value_handle >= chrc_data->end_handle) {\n\t\t\tfree(chrc_data);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdesc_start = chrc_data->value_handle + 1;\n\n\t\tclient->discovery_req = bt_gatt_discover_descriptors(\n\t\t\t\t\t\t\tclient->att, desc_start,\n\t\t\t\t\t\t\tchrc_data->end_handle,\n\t\t\t\t\t\t\tdiscover_descs_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\t\tif (client->discovery_req) {\n\t\t\t*discovering = true;\n\t\t\tgoto done;\n\t\t}\n\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\"Failed to start descriptor discovery\");\n\t\tdiscovery_op_unref(op);\n\n\t\tgoto failed;\n\t}\n\ndone:\n\tfree(chrc_data);\n\treturn true;\n\nfailed:\n\tfree(chrc_data);\n\treturn false;\n}"
  },
  {
    "function_name": "discover_incl_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "479-564",
    "snippet": "static void discover_incl_cb(bool success, uint8_t att_ecode,\n\t\t\t\tstruct bt_gatt_result *result, void *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tstruct bt_gatt_iter iter;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t handle, start, end;\n\tuint128_t u128;\n\tbt_uuid_t uuid;\n\tchar uuid_str[MAX_LEN_UUID_STR];\n\tunsigned int includes_count, i;\n\tstruct handle_range *range;\n\n\tdiscovery_req_clear(client);\n\n\tif (!success) {\n\t\tif (att_ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND)\n\t\t\tgoto next;\n\n\t\tgoto failed;\n\t}\n\n\tif (!result || !bt_gatt_iter_init(&iter, result))\n\t\tgoto failed;\n\n\tincludes_count = bt_gatt_result_included_count(result);\n\tif (includes_count == 0)\n\t\tgoto failed;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\t\"Included services found: %u\",\n\t\t\t\t\t\tincludes_count);\n\n\tfor (i = 0; i < includes_count; i++) {\n\t\tif (!bt_gatt_iter_next_included_service(&iter, &handle, &start,\n\t\t\t\t\t\t\t&end, u128.data))\n\t\t\tbreak;\n\n\t\tbt_uuid128_create(&uuid, u128);\n\n\t\t/* Log debug message */\n\t\tbt_uuid_to_string(&uuid, uuid_str, sizeof(uuid_str));\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"handle: 0x%04x, start: 0x%04x, end: 0x%04x,\"\n\t\t\t\t\"uuid: %s\", handle, start, end, uuid_str);\n\n\t\tattr = gatt_db_get_attribute(client->db, start);\n\t\tif (!attr)\n\t\t\tgoto failed;\n\n\t\tattr = gatt_db_insert_included(client->db, handle, attr);\n\t\tif (!attr)\n\t\t\tgoto failed;\n\n\t\t/*\n\t\t * GATT requires that all include definitions precede\n\t\t * characteristic declarations. Based on the order we're adding\n\t\t * these entries, the correct handle must be assigned to the new\n\t\t * attribute.\n\t\t */\n\t\tif (gatt_db_attribute_get_handle(attr) != handle)\n\t\t\tgoto failed;\n\t}\n\nnext:\n\trange = queue_pop_head(op->discov_ranges);\n\tif (!range)\n\t\tgoto failed;\n\n\tclient->discovery_req = bt_gatt_discover_characteristics(client->att,\n\t\t\t\t\t\t\trange->start,\n\t\t\t\t\t\t\trange->end,\n\t\t\t\t\t\t\tdiscover_chrcs_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\tfree(range);\n\tif (client->discovery_req)\n\t\treturn;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to start characteristic discovery\");\n\tdiscovery_op_unref(op);\nfailed:\n\tdiscovery_op_complete(op, false, att_ecode);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_complete",
          "args": [
            "op",
            "false",
            "att_ecode"
          ],
          "line": 563
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_complete",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "352-385",
          "snippet": "static void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_unref",
          "args": [
            "op"
          ],
          "line": 561
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "453-464",
          "snippet": "static void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "client->debug_callback",
            "client->debug_data",
            "\"Failed to start characteristic discovery\""
          ],
          "line": 559
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "range"
          ],
          "line": 555
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_discover_characteristics",
          "args": [
            "client->att",
            "range->start",
            "range->end",
            "discover_chrcs_cb",
            "discovery_op_ref(op)",
            "discovery_op_unref"
          ],
          "line": 549
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_discover_characteristics",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "1253-1286",
          "snippet": "struct bt_gatt_request *bt_gatt_discover_characteristics(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[6];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tput_le16(GATT_CHARAC_UUID, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\tdiscover_chrcs_cb, bt_gatt_request_ref(op),\n\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nstruct bt_gatt_request *bt_gatt_discover_characteristics(struct bt_att *att,\n\t\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\t\tbt_gatt_request_callback_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_destroy_func_t destroy)\n{\n\tstruct bt_gatt_request *op;\n\tuint8_t pdu[6];\n\n\tif (!att)\n\t\treturn false;\n\n\top = new0(struct bt_gatt_request, 1);\n\top->att = att;\n\top->callback = callback;\n\top->user_data = user_data;\n\top->destroy = destroy;\n\top->start_handle = start;\n\top->end_handle = end;\n\n\tput_le16(start, pdu);\n\tput_le16(end, pdu + 2);\n\tput_le16(GATT_CHARAC_UUID, pdu + 4);\n\n\top->id = bt_att_send(att, BT_ATT_OP_READ_BY_TYPE_REQ, pdu, sizeof(pdu),\n\t\t\t\tdiscover_chrcs_cb, bt_gatt_request_ref(op),\n\t\t\t\tasync_req_unref);\n\tif (!op->id) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_request_ref(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_op_ref",
          "args": [
            "op"
          ],
          "line": 553
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "446-451",
          "snippet": "static struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "op->discov_ranges"
          ],
          "line": 545
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 540
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_insert_included",
          "args": [
            "client->db",
            "handle",
            "attr"
          ],
          "line": 530
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_insert_included",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "962-973",
          "snippet": "struct gatt_db_attribute *\ngatt_db_insert_included(struct gatt_db *db, uint16_t handle,\n\t\t\tstruct gatt_db_attribute *include)\n{\n\tstruct gatt_db_attribute *attrib;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn service_insert_included(attrib->service, handle, include);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *\ngatt_db_insert_included(struct gatt_db *db, uint16_t handle,\n\t\t\tstruct gatt_db_attribute *include)\n{\n\tstruct gatt_db_attribute *attrib;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn service_insert_included(attrib->service, handle, include);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_get_attribute",
          "args": [
            "client->db",
            "start"
          ],
          "line": 526
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_get_attribute",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1423-1445",
          "snippet": "struct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_to_string",
          "args": [
            "&uuid",
            "uuid_str",
            "sizeof(uuid_str)"
          ],
          "line": 521
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid128_create",
          "args": [
            "&uuid",
            "u128"
          ],
          "line": 518
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_gatt_iter_next_included_service",
          "args": [
            "&iter",
            "&handle",
            "&start",
            "&end",
            "u128.data"
          ],
          "line": 514
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_iter_next_included_service",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "245-323",
          "snippet": "bool bt_gatt_iter_next_included_service(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *handle, uint16_t *start_handle,\n\t\t\t\tuint16_t *end_handle, uint8_t uuid[16])\n{\n\tstruct bt_gatt_result *read_result;\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\tint i = 0;\n\n\tif (!iter || !iter->result || !handle || !start_handle || !end_handle\n\t\t\t\t\t\t\t\t|| !uuid)\n\t\treturn false;\n\n\n\tif (iter->result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn false;\n\n\t/* UUID in discovery_op is set in read_by_type and service_discovery */\n\top = iter->result->op;\n\tif (op->uuid.type != BT_UUID_UNSPEC)\n\t\treturn false;\n\t/*\n\t * iter->result points to READ_BY_TYPE_RSP with data length containing:\n\t * 2 octets - include service handle\n\t * 2 octets - start handle of included service\n\t * 2 octets - end handle of included service\n\t * optional 2  octets - Bluetooth UUID\n\t */\n\tif (iter->result->data_len != 8 && iter->result->data_len != 6)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t/* This result contains 16 bit UUID */\n\tif (iter->result->data_len == 8) {\n\t\t*handle = get_le16(pdu_ptr);\n\t\t*start_handle = get_le16(pdu_ptr + 2);\n\t\t*end_handle = get_le16(pdu_ptr + 4);\n\t\tconvert_uuid_le(pdu_ptr + 6, 2, uuid);\n\n\t\titer->pos += iter->result->data_len;\n\n\t\tif (iter->pos == iter->result->pdu_len) {\n\t\t\titer->result = iter->result->next;\n\t\t\titer->pos = 0;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t*handle = get_le16(pdu_ptr);\n\t*start_handle = get_le16(pdu_ptr + 2);\n\t*end_handle = get_le16(pdu_ptr + 4);\n\tread_result = iter->result;\n\n\t/*\n\t * Find READ_RSP with include service UUID.\n\t * If number of current data set in READ_BY_TYPE_RSP is n, then we must\n\t * go to n'th PDU next to current item->result\n\t */\n\tfor (read_result = read_result->next; read_result; i++) {\n\t\tif (i >= (iter->pos / iter->result->data_len))\n\t\t\tbreak;\n\n\t\tread_result = read_result->next;\n\t}\n\n\tif (!read_result)\n\t\treturn false;\n\n\tconvert_uuid_le(read_result->pdu, read_result->data_len, uuid);\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = read_result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_next_included_service(struct bt_gatt_iter *iter,\n\t\t\t\tuint16_t *handle, uint16_t *start_handle,\n\t\t\t\tuint16_t *end_handle, uint8_t uuid[16])\n{\n\tstruct bt_gatt_result *read_result;\n\tstruct bt_gatt_request *op;\n\tconst void *pdu_ptr;\n\tint i = 0;\n\n\tif (!iter || !iter->result || !handle || !start_handle || !end_handle\n\t\t\t\t\t\t\t\t|| !uuid)\n\t\treturn false;\n\n\n\tif (iter->result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn false;\n\n\t/* UUID in discovery_op is set in read_by_type and service_discovery */\n\top = iter->result->op;\n\tif (op->uuid.type != BT_UUID_UNSPEC)\n\t\treturn false;\n\t/*\n\t * iter->result points to READ_BY_TYPE_RSP with data length containing:\n\t * 2 octets - include service handle\n\t * 2 octets - start handle of included service\n\t * 2 octets - end handle of included service\n\t * optional 2  octets - Bluetooth UUID\n\t */\n\tif (iter->result->data_len != 8 && iter->result->data_len != 6)\n\t\treturn false;\n\n\tpdu_ptr = iter->result->pdu + iter->pos;\n\n\t/* This result contains 16 bit UUID */\n\tif (iter->result->data_len == 8) {\n\t\t*handle = get_le16(pdu_ptr);\n\t\t*start_handle = get_le16(pdu_ptr + 2);\n\t\t*end_handle = get_le16(pdu_ptr + 4);\n\t\tconvert_uuid_le(pdu_ptr + 6, 2, uuid);\n\n\t\titer->pos += iter->result->data_len;\n\n\t\tif (iter->pos == iter->result->pdu_len) {\n\t\t\titer->result = iter->result->next;\n\t\t\titer->pos = 0;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t*handle = get_le16(pdu_ptr);\n\t*start_handle = get_le16(pdu_ptr + 2);\n\t*end_handle = get_le16(pdu_ptr + 4);\n\tread_result = iter->result;\n\n\t/*\n\t * Find READ_RSP with include service UUID.\n\t * If number of current data set in READ_BY_TYPE_RSP is n, then we must\n\t * go to n'th PDU next to current item->result\n\t */\n\tfor (read_result = read_result->next; read_result; i++) {\n\t\tif (i >= (iter->pos / iter->result->data_len))\n\t\t\tbreak;\n\n\t\tread_result = read_result->next;\n\t}\n\n\tif (!read_result)\n\t\treturn false;\n\n\tconvert_uuid_le(read_result->pdu, read_result->data_len, uuid);\n\titer->pos += iter->result->data_len;\n\tif (iter->pos == iter->result->pdu_len) {\n\t\titer->result = read_result->next;\n\t\titer->pos = 0;\n\t}\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_result_included_count",
          "args": [
            "result"
          ],
          "line": 505
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_result_included_count",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "148-174",
          "snippet": "unsigned int bt_gatt_result_included_count(struct bt_gatt_result *result)\n{\n\tstruct bt_gatt_result *cur;\n\tunsigned int count = 0;\n\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn 0;\n\n\t/*\n\t * Data length can be of length 6 or 8 octets:\n\t * 2 octets - include service handle\n\t * 2 octets - start handle of included service\n\t * 2 octets - end handle of included service\n\t * 2 octets (optionally) - 16 bit Bluetooth UUID\n\t */\n\tif (result->data_len != 6 && result->data_len != 8)\n\t\treturn 0;\n\n\tfor (cur = result; cur; cur = cur->next)\n\t\tif (cur->opcode == BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\t\tcount += cur->pdu_len / cur->data_len;\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nunsigned int bt_gatt_result_included_count(struct bt_gatt_result *result)\n{\n\tstruct bt_gatt_result *cur;\n\tunsigned int count = 0;\n\n\tif (!result)\n\t\treturn 0;\n\n\tif (result->opcode != BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\treturn 0;\n\n\t/*\n\t * Data length can be of length 6 or 8 octets:\n\t * 2 octets - include service handle\n\t * 2 octets - start handle of included service\n\t * 2 octets - end handle of included service\n\t * 2 octets (optionally) - 16 bit Bluetooth UUID\n\t */\n\tif (result->data_len != 6 && result->data_len != 8)\n\t\treturn 0;\n\n\tfor (cur = result; cur; cur = cur->next)\n\t\tif (cur->opcode == BT_ATT_OP_READ_BY_TYPE_RSP)\n\t\t\tcount += cur->pdu_len / cur->data_len;\n\n\treturn count;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_iter_init",
          "args": [
            "&iter",
            "result"
          ],
          "line": 502
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_iter_init",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "176-185",
          "snippet": "bool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nbool bt_gatt_iter_init(struct bt_gatt_iter *iter, struct bt_gatt_result *result)\n{\n\tif (!iter || !result)\n\t\treturn false;\n\n\titer->result = result;\n\titer->pos = 0;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "discovery_req_clear",
          "args": [
            "client"
          ],
          "line": 493
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_req_clear",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "466-473",
          "snippet": "static void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void discover_incl_cb(bool success, uint8_t att_ecode,\n\t\t\t\tstruct bt_gatt_result *result, void *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\tstruct bt_gatt_client *client = op->client;\n\tstruct bt_gatt_iter iter;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t handle, start, end;\n\tuint128_t u128;\n\tbt_uuid_t uuid;\n\tchar uuid_str[MAX_LEN_UUID_STR];\n\tunsigned int includes_count, i;\n\tstruct handle_range *range;\n\n\tdiscovery_req_clear(client);\n\n\tif (!success) {\n\t\tif (att_ecode == BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND)\n\t\t\tgoto next;\n\n\t\tgoto failed;\n\t}\n\n\tif (!result || !bt_gatt_iter_init(&iter, result))\n\t\tgoto failed;\n\n\tincludes_count = bt_gatt_result_included_count(result);\n\tif (includes_count == 0)\n\t\tgoto failed;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\t\t\"Included services found: %u\",\n\t\t\t\t\t\tincludes_count);\n\n\tfor (i = 0; i < includes_count; i++) {\n\t\tif (!bt_gatt_iter_next_included_service(&iter, &handle, &start,\n\t\t\t\t\t\t\t&end, u128.data))\n\t\t\tbreak;\n\n\t\tbt_uuid128_create(&uuid, u128);\n\n\t\t/* Log debug message */\n\t\tbt_uuid_to_string(&uuid, uuid_str, sizeof(uuid_str));\n\t\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"handle: 0x%04x, start: 0x%04x, end: 0x%04x,\"\n\t\t\t\t\"uuid: %s\", handle, start, end, uuid_str);\n\n\t\tattr = gatt_db_get_attribute(client->db, start);\n\t\tif (!attr)\n\t\t\tgoto failed;\n\n\t\tattr = gatt_db_insert_included(client->db, handle, attr);\n\t\tif (!attr)\n\t\t\tgoto failed;\n\n\t\t/*\n\t\t * GATT requires that all include definitions precede\n\t\t * characteristic declarations. Based on the order we're adding\n\t\t * these entries, the correct handle must be assigned to the new\n\t\t * attribute.\n\t\t */\n\t\tif (gatt_db_attribute_get_handle(attr) != handle)\n\t\t\tgoto failed;\n\t}\n\nnext:\n\trange = queue_pop_head(op->discov_ranges);\n\tif (!range)\n\t\tgoto failed;\n\n\tclient->discovery_req = bt_gatt_discover_characteristics(client->att,\n\t\t\t\t\t\t\trange->start,\n\t\t\t\t\t\t\trange->end,\n\t\t\t\t\t\t\tdiscover_chrcs_cb,\n\t\t\t\t\t\t\tdiscovery_op_ref(op),\n\t\t\t\t\t\t\tdiscovery_op_unref);\n\tfree(range);\n\tif (client->discovery_req)\n\t\treturn;\n\n\tutil_debug(client->debug_callback, client->debug_data,\n\t\t\t\t\"Failed to start characteristic discovery\");\n\tdiscovery_op_unref(op);\nfailed:\n\tdiscovery_op_complete(op, false, att_ecode);\n}"
  },
  {
    "function_name": "discovery_req_clear",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "466-473",
    "snippet": "static void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_request_unref",
          "args": [
            "client->discovery_req"
          ],
          "line": 471
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_request_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-helpers.c",
          "lines": "583-599",
          "snippet": "void bt_gatt_request_unref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_request_cancel(req);\n\n\tif (req->destroy)\n\t\treq->destroy(req->user_data);\n\n\tresult_destroy(req->result_head);\n\n\tfree(req);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/queue.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/queue.h\"\n#include <config.h>\n\nstatic void discover_included_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data);\n\nvoid bt_gatt_request_unref(struct bt_gatt_request *req)\n{\n\tif (!req)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_request_cancel(req);\n\n\tif (req->destroy)\n\t\treq->destroy(req->user_data);\n\n\tresult_destroy(req->result_head);\n\n\tfree(req);\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_req_clear(struct bt_gatt_client *client)\n{\n\tif (!client->discovery_req)\n\t\treturn;\n\n\tbt_gatt_request_unref(client->discovery_req);\n\tclient->discovery_req = NULL;\n}"
  },
  {
    "function_name": "discovery_op_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "453-464",
    "snippet": "static void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "discovery_op_free",
          "args": [
            "op"
          ],
          "line": 463
        },
        "resolved": true,
        "details": {
          "function_name": "discovery_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "340-350",
          "snippet": "static void discovery_op_free(struct discovery_op *op)\n{\n\tif (op->db_id > 0)\n\t\tgatt_db_unregister(op->client->db, op->db_id);\n\n\tqueue_destroy(op->discov_ranges, free);\n\tqueue_destroy(op->pending_svcs, NULL);\n\tqueue_destroy(op->pending_chrcs, free);\n\tqueue_destroy(op->ext_prop_desc, NULL);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_free(struct discovery_op *op)\n{\n\tif (op->db_id > 0)\n\t\tgatt_db_unregister(op->client->db, op->db_id);\n\n\tqueue_destroy(op->discov_ranges, free);\n\tqueue_destroy(op->pending_svcs, NULL);\n\tqueue_destroy(op->pending_chrcs, free);\n\tqueue_destroy(op->ext_prop_desc, NULL);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->failure_func",
          "args": [
            "op"
          ],
          "line": 461
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&op->ref_count",
            "1"
          ],
          "line": 457
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_unref(void *data)\n{\n\tstruct discovery_op *op = data;\n\n\tif (__sync_sub_and_fetch(&op->ref_count, 1))\n\t\treturn;\n\n\tif (!op->success && op->failure_func)\n\t\top->failure_func(op);\n\n\tdiscovery_op_free(op);\n}"
  },
  {
    "function_name": "discovery_op_ref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "446-451",
    "snippet": "static struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&op->ref_count",
            "1"
          ],
          "line": 448
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_ref(struct discovery_op *op)\n{\n\t__sync_fetch_and_add(&op->ref_count, 1);\n\n\treturn op;\n}"
  },
  {
    "function_name": "discovery_op_create",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "403-444",
    "snippet": "static struct discovery_op *discovery_op_create(struct bt_gatt_client *client,\n\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\tdiscovery_op_complete_func_t complete_func,\n\t\t\t\tdiscovery_op_fail_func_t failure_func)\n{\n\tstruct discovery_op *op;\n\tstruct handle_range *range;\n\n\top = new0(struct discovery_op, 1);\n\top->discov_ranges = queue_new();\n\top->pending_svcs = queue_new();\n\top->pending_chrcs = queue_new();\n\top->ext_prop_desc = queue_new();\n\top->client = client;\n\top->complete_func = complete_func;\n\top->failure_func = failure_func;\n\top->start = start;\n\top->end = end;\n\top->last = gatt_db_isempty(client->db) ? 0 : UINT16_MAX;\n\top->svc_first = UINT16_MAX;\n\top->svc_last = 0;\n\n\t/* Load existing services as pending */\n\tgatt_db_foreach_service_in_range(client->db, NULL,\n\t\t\t\t\t discovery_load_services, op,\n\t\t\t\t\t start, end);\n\n\t/*\n\t * Services are only added when set active in which case they are no\n\t * longer pending so it is safe to remove either way.\n\t */\n\top->db_id = gatt_db_register(client->db, discovery_service_changed,\n\t\t\t\t\t\tdiscovery_service_changed,\n\t\t\t\t\t\top, NULL);\n\n\trange = new0(struct handle_range, 1);\n\trange->start = start;\n\trange->end = end;\n\tqueue_push_tail(op->discov_ranges, range);\n\n\treturn op;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "op->discov_ranges",
            "range"
          ],
          "line": 441
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structhandle_range",
            "1"
          ],
          "line": 438
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gatt_db_register",
          "args": [
            "client->db",
            "discovery_service_changed",
            "discovery_service_changed",
            "op",
            "NULL"
          ],
          "line": 434
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_register",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "592-620",
          "snippet": "unsigned int gatt_db_register(struct gatt_db *db,\n\t\t\t\t\tgatt_db_attribute_cb_t service_added,\n\t\t\t\t\tgatt_db_attribute_cb_t service_removed,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tgatt_db_destroy_func_t destroy)\n{\n\tstruct notify *notify;\n\n\tif (!db || !(service_added || service_removed))\n\t\treturn 0;\n\n\tnotify = new0(struct notify, 1);\n\tnotify->service_added = service_added;\n\tnotify->service_removed = service_removed;\n\tnotify->destroy = destroy;\n\tnotify->user_data = user_data;\n\n\tif (db->next_notify_id < 1)\n\t\tdb->next_notify_id = 1;\n\n\tnotify->id = db->next_notify_id++;\n\n\tif (!queue_push_tail(db->notify_list, notify)) {\n\t\tfree(notify);\n\t\treturn 0;\n\t}\n\n\treturn notify->id;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nunsigned int gatt_db_register(struct gatt_db *db,\n\t\t\t\t\tgatt_db_attribute_cb_t service_added,\n\t\t\t\t\tgatt_db_attribute_cb_t service_removed,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tgatt_db_destroy_func_t destroy)\n{\n\tstruct notify *notify;\n\n\tif (!db || !(service_added || service_removed))\n\t\treturn 0;\n\n\tnotify = new0(struct notify, 1);\n\tnotify->service_added = service_added;\n\tnotify->service_removed = service_removed;\n\tnotify->destroy = destroy;\n\tnotify->user_data = user_data;\n\n\tif (db->next_notify_id < 1)\n\t\tdb->next_notify_id = 1;\n\n\tnotify->id = db->next_notify_id++;\n\n\tif (!queue_push_tail(db->notify_list, notify)) {\n\t\tfree(notify);\n\t\treturn 0;\n\t}\n\n\treturn notify->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_foreach_service_in_range",
          "args": [
            "client->db",
            "NULL",
            "discovery_load_services",
            "op",
            "start",
            "end"
          ],
          "line": 426
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_foreach_service_in_range",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1295-1314",
          "snippet": "void gatt_db_foreach_service_in_range(struct gatt_db *db,\n\t\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\t\tgatt_db_attribute_cb_t func,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct foreach_data data;\n\n\tif (!db || !func || start_handle > end_handle)\n\t\treturn;\n\n\tdata.func = func;\n\tdata.uuid = uuid;\n\tdata.user_data = user_data;\n\tdata.start = start_handle;\n\tdata.end = end_handle;\n\n\tqueue_foreach(db->services, foreach_service_in_range, &data);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nvoid gatt_db_foreach_service_in_range(struct gatt_db *db,\n\t\t\t\t\t\tconst bt_uuid_t *uuid,\n\t\t\t\t\t\tgatt_db_attribute_cb_t func,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct foreach_data data;\n\n\tif (!db || !func || start_handle > end_handle)\n\t\treturn;\n\n\tdata.func = func;\n\tdata.uuid = uuid;\n\tdata.user_data = user_data;\n\tdata.start = start_handle;\n\tdata.end = end_handle;\n\n\tqueue_foreach(db->services, foreach_service_in_range, &data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_isempty",
          "args": [
            "client->db"
          ],
          "line": 421
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_isempty",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "327-333",
          "snippet": "bool gatt_db_isempty(struct gatt_db *db)\n{\n\tif (!db)\n\t\treturn true;\n\n\treturn queue_isempty(db->services);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_isempty(struct gatt_db *db)\n{\n\tif (!db)\n\t\treturn true;\n\n\treturn queue_isempty(db->services);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_new",
          "args": [],
          "line": 415
        },
        "resolved": true,
        "details": {
          "function_name": "queue_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "56-66",
          "snippet": "struct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nstruct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structdiscovery_op",
            "1"
          ],
          "line": 411
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct discovery_op *discovery_op_create(struct bt_gatt_client *client,\n\t\t\t\tuint16_t start, uint16_t end,\n\t\t\t\tdiscovery_op_complete_func_t complete_func,\n\t\t\t\tdiscovery_op_fail_func_t failure_func)\n{\n\tstruct discovery_op *op;\n\tstruct handle_range *range;\n\n\top = new0(struct discovery_op, 1);\n\top->discov_ranges = queue_new();\n\top->pending_svcs = queue_new();\n\top->pending_chrcs = queue_new();\n\top->ext_prop_desc = queue_new();\n\top->client = client;\n\top->complete_func = complete_func;\n\top->failure_func = failure_func;\n\top->start = start;\n\top->end = end;\n\top->last = gatt_db_isempty(client->db) ? 0 : UINT16_MAX;\n\top->svc_first = UINT16_MAX;\n\top->svc_last = 0;\n\n\t/* Load existing services as pending */\n\tgatt_db_foreach_service_in_range(client->db, NULL,\n\t\t\t\t\t discovery_load_services, op,\n\t\t\t\t\t start, end);\n\n\t/*\n\t * Services are only added when set active in which case they are no\n\t * longer pending so it is safe to remove either way.\n\t */\n\top->db_id = gatt_db_register(client->db, discovery_service_changed,\n\t\t\t\t\t\tdiscovery_service_changed,\n\t\t\t\t\t\top, NULL);\n\n\trange = new0(struct handle_range, 1);\n\trange->start = start;\n\trange->end = end;\n\tqueue_push_tail(op->discov_ranges, range);\n\n\treturn op;\n}"
  },
  {
    "function_name": "discovery_service_changed",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "395-401",
    "snippet": "static void discovery_service_changed(struct gatt_db_attribute *attr,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\n\tqueue_remove(op->pending_svcs, attr);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "op->pending_svcs",
            "attr"
          ],
          "line": 400
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void discovery_service_changed(struct gatt_db_attribute *attr,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\n\tqueue_remove(op->pending_svcs, attr);\n}"
  },
  {
    "function_name": "discovery_load_services",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "387-393",
    "snippet": "static void discovery_load_services(struct gatt_db_attribute *attr,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\n\tqueue_push_tail(op->pending_svcs, attr);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "op->pending_svcs",
            "attr"
          ],
          "line": 392
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void discovery_load_services(struct gatt_db_attribute *attr,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct discovery_op *op = user_data;\n\n\tqueue_push_tail(op->pending_svcs, attr);\n}"
  },
  {
    "function_name": "discovery_op_complete",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "352-385",
    "snippet": "static void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "op->complete_func",
          "args": [
            "op",
            "success",
            "err"
          ],
          "line": 384
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gatt_db_clear_range",
          "args": [
            "op->client->db",
            "op->last + 1",
            "UINT16_MAX"
          ],
          "line": 381
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_clear_range",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "457-483",
          "snippet": "bool gatt_db_clear_range(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct clear_range range;\n\n\tif (!db || start_handle > end_handle)\n\t\treturn false;\n\n\t/* Check if it is a full clear */\n\tif (start_handle == 1 && end_handle == UINT16_MAX) {\n\t\tqueue_remove_all(db->services, NULL, NULL,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\t\tgoto done;\n\t}\n\n\trange.start = start_handle;\n\trange.end = end_handle;\n\n\tqueue_remove_all(db->services, match_range, &range,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\ndone:\n\tif (gatt_db_isempty(db))\n\t\tdb->next_handle = 0;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_clear_range(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle)\n{\n\tstruct clear_range range;\n\n\tif (!db || start_handle > end_handle)\n\t\treturn false;\n\n\t/* Check if it is a full clear */\n\tif (start_handle == 1 && end_handle == UINT16_MAX) {\n\t\tqueue_remove_all(db->services, NULL, NULL,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\t\tgoto done;\n\t}\n\n\trange.start = start_handle;\n\trange.end = end_handle;\n\n\tqueue_remove_all(db->services, match_range, &range,\n\t\t\t\t\t\tgatt_db_service_destroy);\n\ndone:\n\tif (gatt_db_isempty(db))\n\t\tdb->next_handle = 0;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_remove_service",
          "args": [
            "op->client->db",
            "attr"
          ],
          "line": 376
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_remove_service",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "408-423",
          "snippet": "bool gatt_db_remove_service(struct gatt_db *db,\n\t\t\t\t\tstruct gatt_db_attribute *attrib)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!db || !attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tqueue_remove(db->services, service);\n\n\tgatt_db_service_destroy(service);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_remove_service(struct gatt_db *db,\n\t\t\t\t\tstruct gatt_db_attribute *attrib)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!db || !attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tqueue_remove(db->services, service);\n\n\tgatt_db_service_destroy(service);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "op->client->debug_callback",
            "op->client->debug_data",
            "\"service disappeared: start 0x%04x end 0x%04x\"",
            "start",
            "end"
          ],
          "line": 372
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_service_data",
          "args": [
            "attr",
            "&start",
            "&end",
            "NULL",
            "NULL"
          ],
          "line": 369
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_service_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1538-1566",
          "snippet": "bool gatt_db_attribute_get_service_data(const struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\tuint16_t *start_handle,\n\t\t\t\t\t\t\tuint16_t *end_handle,\n\t\t\t\t\t\t\tbool *primary,\n\t\t\t\t\t\t\tbt_uuid_t *uuid)\n{\n\tstruct gatt_db_service *service;\n\tstruct gatt_db_attribute *decl;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\tdecl = service->attributes[0];\n\n\tgatt_db_service_get_handles(service, start_handle, end_handle);\n\n\tif (primary)\n\t\t*primary = bt_uuid_cmp(&decl->uuid, &secondary_service_uuid);\n\n\tif (!uuid)\n\t\treturn true;\n\n\t/*\n\t * The service declaration attribute value is the 16 or 128 bit service\n\t * UUID.\n\t */\n\treturn le_to_uuid(decl->value, decl->value_len, uuid);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const bt_uuid_t secondary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_SND_SVC_UUID };"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstatic const bt_uuid_t secondary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_SND_SVC_UUID };\n\nbool gatt_db_attribute_get_service_data(const struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\tuint16_t *start_handle,\n\t\t\t\t\t\t\tuint16_t *end_handle,\n\t\t\t\t\t\t\tbool *primary,\n\t\t\t\t\t\t\tbt_uuid_t *uuid)\n{\n\tstruct gatt_db_service *service;\n\tstruct gatt_db_attribute *decl;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\tdecl = service->attributes[0];\n\n\tgatt_db_service_get_handles(service, start_handle, end_handle);\n\n\tif (primary)\n\t\t*primary = bt_uuid_cmp(&decl->uuid, &secondary_service_uuid);\n\n\tif (!uuid)\n\t\treturn true;\n\n\t/*\n\t * The service declaration attribute value is the 16 or 128 bit service\n\t * UUID.\n\t */\n\treturn le_to_uuid(decl->value, decl->value_len, uuid);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_get_entries",
          "args": [
            "op->pending_svcs"
          ],
          "line": 365
        },
        "resolved": true,
        "details": {
          "function_name": "queue_get_entries",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "364-370",
          "snippet": "const struct queue_entry *queue_get_entries(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn NULL;\n\n\treturn queue->head;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nconst struct queue_entry *queue_get_entries(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn NULL;\n\n\treturn queue->head;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_unregister",
          "args": [
            "op->client->db",
            "op->db_id"
          ],
          "line": 361
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_unregister",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "622-637",
          "snippet": "bool gatt_db_unregister(struct gatt_db *db, unsigned int id)\n{\n\tstruct notify *notify;\n\n\tif (!db || !id)\n\t\treturn false;\n\n\tnotify = queue_find(db->notify_list, match_notify_id, UINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tqueue_remove(db->notify_list, notify);\n\tnotify_destroy(notify);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_unregister(struct gatt_db *db, unsigned int id)\n{\n\tstruct notify *notify;\n\n\tif (!db || !id)\n\t\treturn false;\n\n\tnotify = queue_find(db->notify_list, match_notify_id, UINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tqueue_remove(db->notify_list, notify);\n\tnotify_destroy(notify);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_complete(struct discovery_op *op, bool success,\n\t\t\t\t\t\t\t\tuint8_t err)\n{\n\tconst struct queue_entry *svc;\n\n\t/*\n\t * Unregister remove callback so it is not called when clearing unused\n\t * range.\n\t */\n\tgatt_db_unregister(op->client->db, op->db_id);\n\top->db_id = 0;\n\n\t/* Remove services pending */\n\tfor (svc = queue_get_entries(op->pending_svcs); svc; svc = svc->next) {\n\t\tstruct gatt_db_attribute *attr = svc->data;\n\t\tuint16_t start, end;\n\n\t\tgatt_db_attribute_get_service_data(attr, &start, &end,\n\t\t\t\t\t\t\tNULL, NULL);\n\n\t\tutil_debug(op->client->debug_callback, op->client->debug_data,\n\t\t\t\t\"service disappeared: start 0x%04x end 0x%04x\",\n\t\t\t\tstart, end);\n\n\t\tgatt_db_remove_service(op->client->db, attr);\n\t}\n\n\t/* Reset remaining range */\n\tif (op->last != UINT16_MAX)\n\t\tgatt_db_clear_range(op->client->db, op->last + 1, UINT16_MAX);\n\n\top->success = success;\n\top->complete_func(op, success, err);\n}"
  },
  {
    "function_name": "discovery_op_free",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "340-350",
    "snippet": "static void discovery_op_free(struct discovery_op *op)\n{\n\tif (op->db_id > 0)\n\t\tgatt_db_unregister(op->client->db, op->db_id);\n\n\tqueue_destroy(op->discov_ranges, free);\n\tqueue_destroy(op->pending_svcs, NULL);\n\tqueue_destroy(op->pending_chrcs, free);\n\tqueue_destroy(op->ext_prop_desc, NULL);\n\tfree(op);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 349
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "op->ext_prop_desc",
            "NULL"
          ],
          "line": 348
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_unregister",
          "args": [
            "op->client->db",
            "op->db_id"
          ],
          "line": 343
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_unregister",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "622-637",
          "snippet": "bool gatt_db_unregister(struct gatt_db *db, unsigned int id)\n{\n\tstruct notify *notify;\n\n\tif (!db || !id)\n\t\treturn false;\n\n\tnotify = queue_find(db->notify_list, match_notify_id, UINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tqueue_remove(db->notify_list, notify);\n\tnotify_destroy(notify);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_unregister(struct gatt_db *db, unsigned int id)\n{\n\tstruct notify *notify;\n\n\tif (!db || !id)\n\t\treturn false;\n\n\tnotify = queue_find(db->notify_list, match_notify_id, UINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tqueue_remove(db->notify_list, notify);\n\tnotify_destroy(notify);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discovery_op_free(struct discovery_op *op)\n{\n\tif (op->db_id > 0)\n\t\tgatt_db_unregister(op->client->db, op->db_id);\n\n\tqueue_destroy(op->discov_ranges, free);\n\tqueue_destroy(op->pending_svcs, NULL);\n\tqueue_destroy(op->pending_chrcs, free);\n\tqueue_destroy(op->ext_prop_desc, NULL);\n\tfree(op);\n}"
  },
  {
    "function_name": "notify_data_cleanup",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "304-312",
    "snippet": "static void notify_data_cleanup(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tif (notify_data->att_id)\n\t\tbt_att_cancel(notify_data->client->att, notify_data->att_id);\n\n\tnotify_data_unref(notify_data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "notify_data_unref",
          "args": [
            "notify_data"
          ],
          "line": 311
        },
        "resolved": true,
        "details": {
          "function_name": "notify_data_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "207-218",
          "snippet": "static void notify_data_unref(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tif (__sync_sub_and_fetch(&notify_data->ref_count, 1))\n\t\treturn;\n\n\tif (notify_data->destroy)\n\t\tnotify_data->destroy(notify_data->user_data);\n\n\tfree(notify_data);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void notify_data_unref(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tif (__sync_sub_and_fetch(&notify_data->ref_count, 1))\n\t\treturn;\n\n\tif (notify_data->destroy)\n\t\tnotify_data->destroy(notify_data->user_data);\n\n\tfree(notify_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_cancel",
          "args": [
            "notify_data->client->att",
            "notify_data->att_id"
          ],
          "line": 309
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_cancel",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1291-1331",
          "snippet": "bool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void notify_data_cleanup(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tif (notify_data->att_id)\n\t\tbt_att_cancel(notify_data->client->att, notify_data->att_id);\n\n\tnotify_data_unref(notify_data);\n}"
  },
  {
    "function_name": "match_notify_data_id",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "291-297",
    "snippet": "static bool match_notify_data_id(const void *a, const void *b)\n{\n\tconst struct notify_data *notify_data = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn notify_data->id == id;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "PTR_TO_UINT",
          "args": [
            "b"
          ],
          "line": 294
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool match_notify_data_id(const void *a, const void *b)\n{\n\tconst struct notify_data *notify_data = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn notify_data->id == id;\n}"
  },
  {
    "function_name": "notify_chrc_free",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "283-289",
    "snippet": "static void notify_chrc_free(void *data)\n{\n\tstruct notify_chrc *chrc = data;\n\n\tqueue_destroy(chrc->reg_notify_queue, notify_data_unref);\n\tfree(chrc);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "chrc"
          ],
          "line": 288
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "chrc->reg_notify_queue",
            "notify_data_unref"
          ],
          "line": 287
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void notify_chrc_free(void *data)\n{\n\tstruct notify_chrc *chrc = data;\n\n\tqueue_destroy(chrc->reg_notify_queue, notify_data_unref);\n\tfree(chrc);\n}"
  },
  {
    "function_name": "notify_chrc_create",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "236-281",
    "snippet": "static struct notify_chrc *notify_chrc_create(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t value_handle)\n{\n\tstruct gatt_db_attribute *attr, *ccc;\n\tstruct notify_chrc *chrc;\n\tbt_uuid_t uuid;\n\tuint8_t properties;\n\n\t/* Check that chrc_value_handle belongs to a known characteristic */\n\tattr = gatt_db_get_attribute(client->db, value_handle - 1);\n\tif (!attr)\n\t\treturn NULL;\n\n\tbt_uuid16_create(&uuid, GATT_CHARAC_UUID);\n\tif (bt_uuid_cmp(&uuid, gatt_db_attribute_get_type(attr)))\n\t\treturn NULL;\n\n\tif (!gatt_db_attribute_get_char_data(attr, NULL, NULL, &properties,\n\t\t\t\t\t\t\t\tNULL, NULL))\n\t\treturn NULL;\n\n\tchrc = new0(struct notify_chrc, 1);\n\n\tchrc->reg_notify_queue = queue_new();\n\tif (!chrc->reg_notify_queue) {\n\t\tfree(chrc);\n\t\treturn NULL;\n\t}\n\n\t/*\n\t * Find the CCC characteristic. Some characteristics that allow\n\t * notifications may not have a CCC descriptor. We treat these as\n\t * automatically successful.\n\t */\n\tccc = NULL;\n\tgatt_db_service_foreach_desc(attr, find_ccc, &ccc);\n\tif (ccc)\n\t\tchrc->ccc_handle = gatt_db_attribute_get_handle(ccc);\n\n\tchrc->value_handle = value_handle;\n\tchrc->properties = properties;\n\n\tqueue_push_tail(client->notify_chrcs, chrc);\n\n\treturn chrc;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "client->notify_chrcs",
            "chrc"
          ],
          "line": 278
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "ccc"
          ],
          "line": 273
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_service_foreach_desc",
          "args": [
            "attr",
            "find_ccc",
            "&ccc"
          ],
          "line": 271
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_service_foreach_desc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1349-1386",
          "snippet": "void gatt_db_service_foreach_desc(struct gatt_db_attribute *attrib,\n\t\t\t\t\t\tgatt_db_attribute_cb_t func,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct gatt_db_service *service;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t i;\n\n\tif (!attrib || !func)\n\t\treturn;\n\n\t/* Return if this attribute is not a characteristic declaration */\n\tif (bt_uuid_cmp(&characteristic_uuid, &attrib->uuid))\n\t\treturn;\n\n\tservice = attrib->service;\n\n\t/* Start from the attribute following the value handle */\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (service->attributes[i] == attrib) {\n\t\t\ti += 2;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tfor (; i < service->num_handles; i++) {\n\t\tattr = service->attributes[i];\n\t\tif (!attr)\n\t\t\tcontinue;\n\n\t\t/* Return if we reached the end of this characteristic */\n\t\tif (!bt_uuid_cmp(&characteristic_uuid, &attr->uuid) ||\n\t\t\t!bt_uuid_cmp(&included_service_uuid, &attr->uuid))\n\t\t\treturn;\n\n\t\tfunc(attr, user_data);\n\t}\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const bt_uuid_t characteristic_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_CHARAC_UUID };",
            "static const bt_uuid_t included_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_INCLUDE_UUID };"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstatic const bt_uuid_t characteristic_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_CHARAC_UUID };\nstatic const bt_uuid_t included_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_INCLUDE_UUID };\n\nvoid gatt_db_service_foreach_desc(struct gatt_db_attribute *attrib,\n\t\t\t\t\t\tgatt_db_attribute_cb_t func,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct gatt_db_service *service;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t i;\n\n\tif (!attrib || !func)\n\t\treturn;\n\n\t/* Return if this attribute is not a characteristic declaration */\n\tif (bt_uuid_cmp(&characteristic_uuid, &attrib->uuid))\n\t\treturn;\n\n\tservice = attrib->service;\n\n\t/* Start from the attribute following the value handle */\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (service->attributes[i] == attrib) {\n\t\t\ti += 2;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tfor (; i < service->num_handles; i++) {\n\t\tattr = service->attributes[i];\n\t\tif (!attr)\n\t\t\tcontinue;\n\n\t\t/* Return if we reached the end of this characteristic */\n\t\tif (!bt_uuid_cmp(&characteristic_uuid, &attr->uuid) ||\n\t\t\t!bt_uuid_cmp(&included_service_uuid, &attr->uuid))\n\t\t\treturn;\n\n\t\tfunc(attr, user_data);\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "chrc"
          ],
          "line": 261
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_new",
          "args": [],
          "line": 259
        },
        "resolved": true,
        "details": {
          "function_name": "queue_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "56-66",
          "snippet": "struct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nstruct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structnotify_chrc",
            "1"
          ],
          "line": 257
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_char_data",
          "args": [
            "attr",
            "NULL",
            "NULL",
            "&properties",
            "NULL",
            "NULL"
          ],
          "line": 253
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_char_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1625-1664",
          "snippet": "bool gatt_db_attribute_get_char_data(const struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\tuint16_t *handle,\n\t\t\t\t\t\t\tuint16_t *value_handle,\n\t\t\t\t\t\t\tuint8_t *properties,\n\t\t\t\t\t\t\tuint16_t *ext_prop,\n\t\t\t\t\t\t\tbt_uuid_t *uuid)\n{\n\tif (!attrib)\n\t\treturn false;\n\n\tif (bt_uuid_cmp(&characteristic_uuid, &attrib->uuid))\n\t\treturn false;\n\n\t/*\n\t * Characteristic declaration value:\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (!attrib->value || (attrib->value_len != 5 &&\n\t\t\t\t\t\tattrib->value_len != 19))\n\t\treturn false;\n\n\tif (handle)\n\t\t*handle = attrib->handle;\n\n\tif (properties)\n\t\t*properties = attrib->value[0];\n\n\tif (ext_prop)\n\t\t*ext_prop = get_char_extended_prop(attrib);\n\n\tif (value_handle)\n\t\t*value_handle = get_le16(attrib->value + 1);\n\n\tif (!uuid)\n\t\treturn true;\n\n\treturn le_to_uuid(attrib->value + 3, attrib->value_len - 3, uuid);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const bt_uuid_t characteristic_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_CHARAC_UUID };"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstatic const bt_uuid_t characteristic_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_CHARAC_UUID };\n\nbool gatt_db_attribute_get_char_data(const struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\tuint16_t *handle,\n\t\t\t\t\t\t\tuint16_t *value_handle,\n\t\t\t\t\t\t\tuint8_t *properties,\n\t\t\t\t\t\t\tuint16_t *ext_prop,\n\t\t\t\t\t\t\tbt_uuid_t *uuid)\n{\n\tif (!attrib)\n\t\treturn false;\n\n\tif (bt_uuid_cmp(&characteristic_uuid, &attrib->uuid))\n\t\treturn false;\n\n\t/*\n\t * Characteristic declaration value:\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (!attrib->value || (attrib->value_len != 5 &&\n\t\t\t\t\t\tattrib->value_len != 19))\n\t\treturn false;\n\n\tif (handle)\n\t\t*handle = attrib->handle;\n\n\tif (properties)\n\t\t*properties = attrib->value[0];\n\n\tif (ext_prop)\n\t\t*ext_prop = get_char_extended_prop(attrib);\n\n\tif (value_handle)\n\t\t*value_handle = get_le16(attrib->value + 1);\n\n\tif (!uuid)\n\t\treturn true;\n\n\treturn le_to_uuid(attrib->value + 3, attrib->value_len - 3, uuid);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_cmp",
          "args": [
            "&uuid",
            "gatt_db_attribute_get_type(attr)"
          ],
          "line": 250
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_type",
          "args": [
            "attr"
          ],
          "line": 250
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1473-1480",
          "snippet": "const bt_uuid_t *gatt_db_attribute_get_type(\n\t\t\t\t\tconst struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn &attrib->uuid;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nconst bt_uuid_t *gatt_db_attribute_get_type(\n\t\t\t\t\tconst struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn &attrib->uuid;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid16_create",
          "args": [
            "&uuid",
            "GATT_CHARAC_UUID"
          ],
          "line": 249
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gatt_db_get_attribute",
          "args": [
            "client->db",
            "value_handle - 1"
          ],
          "line": 245
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_get_attribute",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1423-1445",
          "snippet": "struct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct notify_chrc *notify_chrc_create(struct bt_gatt_client *client,\n\t\t\t\t\t\t\tuint16_t value_handle)\n{\n\tstruct gatt_db_attribute *attr, *ccc;\n\tstruct notify_chrc *chrc;\n\tbt_uuid_t uuid;\n\tuint8_t properties;\n\n\t/* Check that chrc_value_handle belongs to a known characteristic */\n\tattr = gatt_db_get_attribute(client->db, value_handle - 1);\n\tif (!attr)\n\t\treturn NULL;\n\n\tbt_uuid16_create(&uuid, GATT_CHARAC_UUID);\n\tif (bt_uuid_cmp(&uuid, gatt_db_attribute_get_type(attr)))\n\t\treturn NULL;\n\n\tif (!gatt_db_attribute_get_char_data(attr, NULL, NULL, &properties,\n\t\t\t\t\t\t\t\tNULL, NULL))\n\t\treturn NULL;\n\n\tchrc = new0(struct notify_chrc, 1);\n\n\tchrc->reg_notify_queue = queue_new();\n\tif (!chrc->reg_notify_queue) {\n\t\tfree(chrc);\n\t\treturn NULL;\n\t}\n\n\t/*\n\t * Find the CCC characteristic. Some characteristics that allow\n\t * notifications may not have a CCC descriptor. We treat these as\n\t * automatically successful.\n\t */\n\tccc = NULL;\n\tgatt_db_service_foreach_desc(attr, find_ccc, &ccc);\n\tif (ccc)\n\t\tchrc->ccc_handle = gatt_db_attribute_get_handle(ccc);\n\n\tchrc->value_handle = value_handle;\n\tchrc->properties = properties;\n\n\tqueue_push_tail(client->notify_chrcs, chrc);\n\n\treturn chrc;\n}"
  },
  {
    "function_name": "find_ccc",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "220-234",
    "snippet": "static void find_ccc(struct gatt_db_attribute *attr, void *user_data)\n{\n\tstruct gatt_db_attribute **ccc_ptr = user_data;\n\tbt_uuid_t uuid;\n\n\tif (*ccc_ptr)\n\t\treturn;\n\n\tbt_uuid16_create(&uuid, GATT_CLIENT_CHARAC_CFG_UUID);\n\n\tif (bt_uuid_cmp(&uuid, gatt_db_attribute_get_type(attr)))\n\t\treturn;\n\n\t*ccc_ptr = attr;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_uuid_cmp",
          "args": [
            "&uuid",
            "gatt_db_attribute_get_type(attr)"
          ],
          "line": 230
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_type",
          "args": [
            "attr"
          ],
          "line": 230
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1473-1480",
          "snippet": "const bt_uuid_t *gatt_db_attribute_get_type(\n\t\t\t\t\tconst struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn &attrib->uuid;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nconst bt_uuid_t *gatt_db_attribute_get_type(\n\t\t\t\t\tconst struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn &attrib->uuid;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid16_create",
          "args": [
            "&uuid",
            "GATT_CLIENT_CHARAC_CFG_UUID"
          ],
          "line": 228
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void find_ccc(struct gatt_db_attribute *attr, void *user_data)\n{\n\tstruct gatt_db_attribute **ccc_ptr = user_data;\n\tbt_uuid_t uuid;\n\n\tif (*ccc_ptr)\n\t\treturn;\n\n\tbt_uuid16_create(&uuid, GATT_CLIENT_CHARAC_CFG_UUID);\n\n\tif (bt_uuid_cmp(&uuid, gatt_db_attribute_get_type(attr)))\n\t\treturn;\n\n\t*ccc_ptr = attr;\n}"
  },
  {
    "function_name": "notify_data_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "207-218",
    "snippet": "static void notify_data_unref(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tif (__sync_sub_and_fetch(&notify_data->ref_count, 1))\n\t\treturn;\n\n\tif (notify_data->destroy)\n\t\tnotify_data->destroy(notify_data->user_data);\n\n\tfree(notify_data);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
      "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
      "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
      "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "notify_data"
          ],
          "line": 217
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "notify_data->destroy",
          "args": [
            "notify_data->user_data"
          ],
          "line": 215
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&notify_data->ref_count",
            "1"
          ],
          "line": 211
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void notify_data_unref(void *data)\n{\n\tstruct notify_data *notify_data = data;\n\n\tif (__sync_sub_and_fetch(&notify_data->ref_count, 1))\n\t\treturn;\n\n\tif (notify_data->destroy)\n\t\tnotify_data->destroy(notify_data->user_data);\n\n\tfree(notify_data);\n}"
  },
  {
    "function_name": "notify_data_ref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "200-205",
    "snippet": "static struct notify_data *notify_data_ref(struct notify_data *notify_data)\n{\n\t__sync_fetch_and_add(&notify_data->ref_count, 1);\n\n\treturn notify_data;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&notify_data->ref_count",
            "1"
          ],
          "line": 202
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct notify_data *notify_data_ref(struct notify_data *notify_data)\n{\n\t__sync_fetch_and_add(&notify_data->ref_count, 1);\n\n\treturn notify_data;\n}"
  },
  {
    "function_name": "request_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "159-173",
    "snippet": "static void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "req"
          ],
          "line": 172
        },
        "resolved": true,
        "details": {
          "function_name": "long_write_op_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "2695-2704",
          "snippet": "static void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);",
            "static void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);",
            "static void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);",
            "static void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void discover_chrcs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void discover_descs_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\t\tstruct bt_gatt_result *result,\n\t\t\t\t\t\tvoid *user_data);\nstatic void ext_prop_read_cb(bool success, uint8_t att_ecode,\n\t\t\t\t\tconst uint8_t *value, uint16_t length,\n\t\t\t\t\tvoid *user_data);\nstatic void service_changed_cb(uint16_t value_handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length, void *user_data);\nstatic void prepare_write_cb(uint8_t opcode, const void *pdu, uint16_t length,\n\t\t\t\t\t\t\tvoid *user_data);\n\nstatic void long_write_op_free(void *data)\n{\n\tstruct long_write_op *op = data;\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->value);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove",
          "args": [
            "req->client->pending_requests",
            "req"
          ],
          "line": 170
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_uuid",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/ad.c",
          "lines": "526-541",
          "snippet": "static bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/eir.h\"",
            "#include \"src/shared/ad.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/eir.h\"\n#include \"src/shared/ad.h\"\n\nstatic bool queue_remove_uuid(struct queue *queue, bt_uuid_t *uuid)\n{\n\tbt_uuid_t *removed;\n\n\tif (!queue || !uuid)\n\t\treturn false;\n\n\tremoved = queue_remove_if(queue, uuid_match, uuid);\n\n\tif (removed) {\n\t\tfree(removed);\n\t\treturn true;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "req->destroy",
          "args": [
            "req->data"
          ],
          "line": 167
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&req->ref_count",
            "1"
          ],
          "line": 163
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void request_unref(void *data)\n{\n\tstruct request *req = data;\n\n\tif (__sync_sub_and_fetch(&req->ref_count, 1))\n\t\treturn;\n\n\tif (req->destroy)\n\t\treq->destroy(req->data);\n\n\tif (!req->removed)\n\t\tqueue_remove(req->client->pending_requests, req);\n\n\tfree(req);\n}"
  },
  {
    "function_name": "request_create",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "140-157",
    "snippet": "static struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "request_ref",
          "args": [
            "req"
          ],
          "line": 156
        },
        "resolved": true,
        "details": {
          "function_name": "request_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "133-138",
          "snippet": "static struct request *request_ref(struct request *req)\n{\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_ref(struct request *req)\n{\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "client->pending_requests",
            "req"
          ],
          "line": 152
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structrequest",
            "1"
          ],
          "line": 147
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_create(struct bt_gatt_client *client)\n{\n\tstruct request *req;\n\n\tif (!client->att)\n\t\treturn NULL;\n\n\treq = new0(struct request, 1);\n\n\tif (client->next_request_id < 1)\n\t\tclient->next_request_id = 1;\n\n\tqueue_push_tail(client->pending_requests, req);\n\treq->client = client;\n\treq->id = client->next_request_id++;\n\n\treturn request_ref(req);\n}"
  },
  {
    "function_name": "request_ref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
    "lines": "133-138",
    "snippet": "static struct request *request_ref(struct request *req)\n{\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}",
    "includes": [
      "#include <sys/uio.h>",
      "#include <limits.h>",
      "#include <assert.h>",
      "#include \"src/shared/gatt-client.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&req->ref_count",
            "1"
          ],
          "line": 135
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic struct request *request_ref(struct request *req)\n{\n\t__sync_fetch_and_add(&req->ref_count, 1);\n\n\treturn req;\n}"
  }
]