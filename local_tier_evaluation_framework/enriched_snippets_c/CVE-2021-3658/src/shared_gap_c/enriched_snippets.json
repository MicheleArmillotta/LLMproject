[
  {
    "function_name": "bt_gap_add_peer_irk",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "256-278",
    "snippet": "bool bt_gap_add_peer_irk(struct bt_gap *gap, uint8_t addr_type,\n\t\t\t\t\tuint8_t addr[6], uint8_t key[16])\n{\n\tstruct irk_entry *irk;\n\n\tif (!gap)\n\t\treturn false;\n\n\tif (addr_type > BT_GAP_ADDR_TYPE_LE_RANDOM)\n\t\treturn false;\n\n\tirk = new0(struct irk_entry, 1);\n\tirk->addr_type = addr_type;\n\tmemcpy(irk->addr, addr, 6);\n\tmemcpy(irk->key, key, 16);\n\n\tif (!queue_push_tail(gap->irk_list, irk)) {\n\t\tfree(irk);\n\t\treturn false;\n\t}\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "irk"
          ],
          "line": 273
        },
        "resolved": true,
        "details": {
          "function_name": "irk_entry_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
          "lines": "67-72",
          "snippet": "static void irk_entry_free(void *data)\n{\n\tstruct irk_entry *irk = data;\n\n\tfree(irk);\n}",
          "includes": [
            "#include \"src/shared/gap.h\"",
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void irk_entry_free(void *data)\n{\n\tstruct irk_entry *irk = data;\n\n\tfree(irk);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "gap->irk_list",
            "irk"
          ],
          "line": 272
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "irk->key",
            "key",
            "16"
          ],
          "line": 270
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "irk->addr",
            "addr",
            "6"
          ],
          "line": 269
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structirk_entry",
            "1"
          ],
          "line": 267
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nbool bt_gap_add_peer_irk(struct bt_gap *gap, uint8_t addr_type,\n\t\t\t\t\tuint8_t addr[6], uint8_t key[16])\n{\n\tstruct irk_entry *irk;\n\n\tif (!gap)\n\t\treturn false;\n\n\tif (addr_type > BT_GAP_ADDR_TYPE_LE_RANDOM)\n\t\treturn false;\n\n\tirk = new0(struct irk_entry, 1);\n\tirk->addr_type = addr_type;\n\tmemcpy(irk->addr, addr, 6);\n\tmemcpy(irk->key, key, 16);\n\n\tif (!queue_push_tail(gap->irk_list, irk)) {\n\t\tfree(irk);\n\t\treturn false;\n\t}\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gap_set_local_irk",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "246-254",
    "snippet": "bool bt_gap_set_local_irk(struct bt_gap *gap, uint8_t key[16])\n{\n\tif (!gap)\n\t\treturn false;\n\n\tmemcpy(gap->local_irk, key, 16);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "gap->local_irk",
            "key",
            "16"
          ],
          "line": 251
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nbool bt_gap_set_local_irk(struct bt_gap *gap, uint8_t key[16])\n{\n\tif (!gap)\n\t\treturn false;\n\n\tmemcpy(gap->local_irk, key, 16);\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gap_set_static_addr",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "236-244",
    "snippet": "bool bt_gap_set_static_addr(struct bt_gap *gap, uint8_t addr[6])\n{\n\tif (!gap)\n\t\treturn false;\n\n\tmemcpy(gap->static_addr, addr, 6);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "gap->static_addr",
            "addr",
            "6"
          ],
          "line": 241
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nbool bt_gap_set_static_addr(struct bt_gap *gap, uint8_t addr[6])\n{\n\tif (!gap)\n\t\treturn false;\n\n\tmemcpy(gap->static_addr, addr, 6);\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gap_set_ready_handler",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "219-234",
    "snippet": "bool bt_gap_set_ready_handler(struct bt_gap *gap,\n\t\t\t\tbt_gap_ready_func_t handler, void *user_data,\n\t\t\t\tbt_gap_destroy_func_t destroy)\n{\n\tif (!gap)\n\t\treturn false;\n\n\tif (gap->ready_destroy)\n\t\tgap->ready_destroy(gap->ready_data);\n\n\tgap->ready_handler = handler;\n\tgap->ready_destroy = destroy;\n\tgap->ready_data = user_data;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "gap->ready_destroy",
          "args": [
            "gap->ready_data"
          ],
          "line": 227
        },
        "resolved": true,
        "details": {
          "function_name": "ready_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1211-1219",
          "snippet": "static void ready_destroy(void *data)\n{\n\tstruct ready_cb *ready = data;\n\n\tif (ready->destroy)\n\t\tready->destroy(ready->data);\n\n\tfree(ready);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void ready_destroy(void *data)\n{\n\tstruct ready_cb *ready = data;\n\n\tif (ready->destroy)\n\t\tready->destroy(ready->data);\n\n\tfree(ready);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nbool bt_gap_set_ready_handler(struct bt_gap *gap,\n\t\t\t\tbt_gap_ready_func_t handler, void *user_data,\n\t\t\t\tbt_gap_destroy_func_t destroy)\n{\n\tif (!gap)\n\t\treturn false;\n\n\tif (gap->ready_destroy)\n\t\tgap->ready_destroy(gap->ready_data);\n\n\tgap->ready_handler = handler;\n\tgap->ready_destroy = destroy;\n\tgap->ready_data = user_data;\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gap_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "196-217",
    "snippet": "void bt_gap_unref(struct bt_gap *gap)\n{\n\tif (!gap)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&gap->ref_count, 1))\n\t\treturn;\n\n\tgap->mgmt_ready = false;\n\n\tmgmt_cancel_all(gap->mgmt);\n\tmgmt_unregister_all(gap->mgmt);\n\n\tif (gap->ready_destroy)\n\t\tgap->ready_destroy(gap->ready_data);\n\n\tqueue_destroy(gap->irk_list, irk_entry_free);\n\n\tmgmt_unref(gap->mgmt);\n\n\tfree(gap);\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "gap"
          ],
          "line": 216
        },
        "resolved": true,
        "details": {
          "function_name": "irk_entry_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
          "lines": "67-72",
          "snippet": "static void irk_entry_free(void *data)\n{\n\tstruct irk_entry *irk = data;\n\n\tfree(irk);\n}",
          "includes": [
            "#include \"src/shared/gap.h\"",
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void irk_entry_free(void *data)\n{\n\tstruct irk_entry *irk = data;\n\n\tfree(irk);\n}"
        }
      },
      {
        "call_info": {
          "callee": "mgmt_unref",
          "args": [
            "gap->mgmt"
          ],
          "line": 214
        },
        "resolved": true,
        "details": {
          "function_name": "mgmt_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/mgmt.c",
          "lines": "471-506",
          "snippet": "void mgmt_unref(struct mgmt *mgmt)\n{\n\tif (!mgmt)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&mgmt->ref_count, 1))\n\t\treturn;\n\n\tmgmt_unregister_all(mgmt);\n\tmgmt_cancel_all(mgmt);\n\n\tqueue_destroy(mgmt->reply_queue, NULL);\n\tqueue_destroy(mgmt->request_queue, NULL);\n\n\tio_set_write_handler(mgmt->io, NULL, NULL, NULL);\n\tio_set_read_handler(mgmt->io, NULL, NULL, NULL);\n\n\tio_destroy(mgmt->io);\n\tmgmt->io = NULL;\n\n\tif (mgmt->close_on_unref)\n\t\tclose(mgmt->fd);\n\n\tif (mgmt->debug_destroy)\n\t\tmgmt->debug_destroy(mgmt->debug_data);\n\n\tfree(mgmt->buf);\n\tmgmt->buf = NULL;\n\n\tif (!mgmt->in_notify) {\n\t\tqueue_destroy(mgmt->notify_list, NULL);\n\t\tqueue_destroy(mgmt->pending_list, NULL);\n\t\tfree(mgmt);\n\t\treturn;\n\t}\n}",
          "includes": [
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include \"lib/hci.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/mgmt.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include \"lib/hci.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid mgmt_unref(struct mgmt *mgmt)\n{\n\tif (!mgmt)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&mgmt->ref_count, 1))\n\t\treturn;\n\n\tmgmt_unregister_all(mgmt);\n\tmgmt_cancel_all(mgmt);\n\n\tqueue_destroy(mgmt->reply_queue, NULL);\n\tqueue_destroy(mgmt->request_queue, NULL);\n\n\tio_set_write_handler(mgmt->io, NULL, NULL, NULL);\n\tio_set_read_handler(mgmt->io, NULL, NULL, NULL);\n\n\tio_destroy(mgmt->io);\n\tmgmt->io = NULL;\n\n\tif (mgmt->close_on_unref)\n\t\tclose(mgmt->fd);\n\n\tif (mgmt->debug_destroy)\n\t\tmgmt->debug_destroy(mgmt->debug_data);\n\n\tfree(mgmt->buf);\n\tmgmt->buf = NULL;\n\n\tif (!mgmt->in_notify) {\n\t\tqueue_destroy(mgmt->notify_list, NULL);\n\t\tqueue_destroy(mgmt->pending_list, NULL);\n\t\tfree(mgmt);\n\t\treturn;\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "gap->irk_list",
            "irk_entry_free"
          ],
          "line": 212
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gap->ready_destroy",
          "args": [
            "gap->ready_data"
          ],
          "line": 210
        },
        "resolved": true,
        "details": {
          "function_name": "ready_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1211-1219",
          "snippet": "static void ready_destroy(void *data)\n{\n\tstruct ready_cb *ready = data;\n\n\tif (ready->destroy)\n\t\tready->destroy(ready->data);\n\n\tfree(ready);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void ready_destroy(void *data)\n{\n\tstruct ready_cb *ready = data;\n\n\tif (ready->destroy)\n\t\tready->destroy(ready->data);\n\n\tfree(ready);\n}"
        }
      },
      {
        "call_info": {
          "callee": "mgmt_unregister_all",
          "args": [
            "gap->mgmt"
          ],
          "line": 207
        },
        "resolved": true,
        "details": {
          "function_name": "mgmt_unregister_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/mgmt.c",
          "lines": "788-801",
          "snippet": "bool mgmt_unregister_all(struct mgmt *mgmt)\n{\n\tif (!mgmt)\n\t\treturn false;\n\n\tif (mgmt->in_notify) {\n\t\tqueue_foreach(mgmt->notify_list, mark_notify_removed,\n\t\t\t\t\t\tUINT_TO_PTR(MGMT_INDEX_NONE));\n\t\tmgmt->need_notify_cleanup = true;\n\t} else\n\t\tqueue_remove_all(mgmt->notify_list, NULL, NULL, destroy_notify);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include \"lib/hci.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/mgmt.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include \"lib/hci.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nbool mgmt_unregister_all(struct mgmt *mgmt)\n{\n\tif (!mgmt)\n\t\treturn false;\n\n\tif (mgmt->in_notify) {\n\t\tqueue_foreach(mgmt->notify_list, mark_notify_removed,\n\t\t\t\t\t\tUINT_TO_PTR(MGMT_INDEX_NONE));\n\t\tmgmt->need_notify_cleanup = true;\n\t} else\n\t\tqueue_remove_all(mgmt->notify_list, NULL, NULL, destroy_notify);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "mgmt_cancel_all",
          "args": [
            "gap->mgmt"
          ],
          "line": 206
        },
        "resolved": true,
        "details": {
          "function_name": "mgmt_cancel_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/mgmt.c",
          "lines": "707-717",
          "snippet": "bool mgmt_cancel_all(struct mgmt *mgmt)\n{\n\tif (!mgmt)\n\t\treturn false;\n\n\tqueue_remove_all(mgmt->pending_list, NULL, NULL, destroy_request);\n\tqueue_remove_all(mgmt->reply_queue, NULL, NULL, destroy_request);\n\tqueue_remove_all(mgmt->request_queue, NULL, NULL, destroy_request);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include \"lib/hci.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/mgmt.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include \"lib/hci.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nbool mgmt_cancel_all(struct mgmt *mgmt)\n{\n\tif (!mgmt)\n\t\treturn false;\n\n\tqueue_remove_all(mgmt->pending_list, NULL, NULL, destroy_request);\n\tqueue_remove_all(mgmt->reply_queue, NULL, NULL, destroy_request);\n\tqueue_remove_all(mgmt->request_queue, NULL, NULL, destroy_request);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&gap->ref_count",
            "1"
          ],
          "line": 201
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid bt_gap_unref(struct bt_gap *gap)\n{\n\tif (!gap)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&gap->ref_count, 1))\n\t\treturn;\n\n\tgap->mgmt_ready = false;\n\n\tmgmt_cancel_all(gap->mgmt);\n\tmgmt_unregister_all(gap->mgmt);\n\n\tif (gap->ready_destroy)\n\t\tgap->ready_destroy(gap->ready_data);\n\n\tqueue_destroy(gap->irk_list, irk_entry_free);\n\n\tmgmt_unref(gap->mgmt);\n\n\tfree(gap);\n}"
  },
  {
    "function_name": "bt_gap_ref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "186-194",
    "snippet": "struct bt_gap *bt_gap_ref(struct bt_gap *gap)\n{\n\tif (!gap)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&gap->ref_count, 1);\n\n\treturn gap;\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&gap->ref_count",
            "1"
          ],
          "line": 191
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstruct bt_gap *bt_gap_ref(struct bt_gap *gap)\n{\n\tif (!gap)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&gap->ref_count, 1);\n\n\treturn gap;\n}"
  },
  {
    "function_name": "bt_gap_new_index",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "157-184",
    "snippet": "struct bt_gap *bt_gap_new_index(uint16_t index)\n{\n\tstruct bt_gap *gap;\n\n\tif (index == MGMT_INDEX_NONE)\n\t\treturn NULL;\n\n\tgap = new0(struct bt_gap, 1);\n\tgap->index = index;\n\n\tgap->mgmt = mgmt_new_default();\n\tif (!gap->mgmt) {\n\t\tfree(gap);\n\t\treturn NULL;\n\t}\n\n\tgap->irk_list = queue_new();\n\tgap->mgmt_ready = false;\n\n\tif (!mgmt_send(gap->mgmt, MGMT_OP_READ_VERSION,\n\t\t\t\t\tMGMT_INDEX_NONE, 0, NULL,\n\t\t\t\t\tread_version_complete, gap, NULL)) {\n\t\tmgmt_unref(gap->mgmt);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gap_ref(gap);\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gap_ref",
          "args": [
            "gap"
          ],
          "line": 183
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gap_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
          "lines": "186-194",
          "snippet": "struct bt_gap *bt_gap_ref(struct bt_gap *gap)\n{\n\tif (!gap)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&gap->ref_count, 1);\n\n\treturn gap;\n}",
          "includes": [
            "#include \"src/shared/gap.h\"",
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstruct bt_gap *bt_gap_ref(struct bt_gap *gap)\n{\n\tif (!gap)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&gap->ref_count, 1);\n\n\treturn gap;\n}"
        }
      },
      {
        "call_info": {
          "callee": "mgmt_unref",
          "args": [
            "gap->mgmt"
          ],
          "line": 179
        },
        "resolved": true,
        "details": {
          "function_name": "mgmt_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/mgmt.c",
          "lines": "471-506",
          "snippet": "void mgmt_unref(struct mgmt *mgmt)\n{\n\tif (!mgmt)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&mgmt->ref_count, 1))\n\t\treturn;\n\n\tmgmt_unregister_all(mgmt);\n\tmgmt_cancel_all(mgmt);\n\n\tqueue_destroy(mgmt->reply_queue, NULL);\n\tqueue_destroy(mgmt->request_queue, NULL);\n\n\tio_set_write_handler(mgmt->io, NULL, NULL, NULL);\n\tio_set_read_handler(mgmt->io, NULL, NULL, NULL);\n\n\tio_destroy(mgmt->io);\n\tmgmt->io = NULL;\n\n\tif (mgmt->close_on_unref)\n\t\tclose(mgmt->fd);\n\n\tif (mgmt->debug_destroy)\n\t\tmgmt->debug_destroy(mgmt->debug_data);\n\n\tfree(mgmt->buf);\n\tmgmt->buf = NULL;\n\n\tif (!mgmt->in_notify) {\n\t\tqueue_destroy(mgmt->notify_list, NULL);\n\t\tqueue_destroy(mgmt->pending_list, NULL);\n\t\tfree(mgmt);\n\t\treturn;\n\t}\n}",
          "includes": [
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include \"lib/hci.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/mgmt.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include \"lib/hci.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid mgmt_unref(struct mgmt *mgmt)\n{\n\tif (!mgmt)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&mgmt->ref_count, 1))\n\t\treturn;\n\n\tmgmt_unregister_all(mgmt);\n\tmgmt_cancel_all(mgmt);\n\n\tqueue_destroy(mgmt->reply_queue, NULL);\n\tqueue_destroy(mgmt->request_queue, NULL);\n\n\tio_set_write_handler(mgmt->io, NULL, NULL, NULL);\n\tio_set_read_handler(mgmt->io, NULL, NULL, NULL);\n\n\tio_destroy(mgmt->io);\n\tmgmt->io = NULL;\n\n\tif (mgmt->close_on_unref)\n\t\tclose(mgmt->fd);\n\n\tif (mgmt->debug_destroy)\n\t\tmgmt->debug_destroy(mgmt->debug_data);\n\n\tfree(mgmt->buf);\n\tmgmt->buf = NULL;\n\n\tif (!mgmt->in_notify) {\n\t\tqueue_destroy(mgmt->notify_list, NULL);\n\t\tqueue_destroy(mgmt->pending_list, NULL);\n\t\tfree(mgmt);\n\t\treturn;\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "mgmt_send",
          "args": [
            "gap->mgmt",
            "MGMT_OP_READ_VERSION",
            "MGMT_INDEX_NONE",
            "0",
            "NULL",
            "read_version_complete",
            "gap",
            "NULL"
          ],
          "line": 176
        },
        "resolved": true,
        "details": {
          "function_name": "mgmt_send_nowait",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/mgmt.c",
          "lines": "605-629",
          "snippet": "unsigned int mgmt_send_nowait(struct mgmt *mgmt, uint16_t opcode, uint16_t index,\n\t\t\t\tuint16_t length, const void *param,\n\t\t\t\tmgmt_request_func_t callback,\n\t\t\t\tvoid *user_data, mgmt_destroy_func_t destroy)\n{\n\tstruct mgmt_request *request;\n\n\tif (!mgmt)\n\t\treturn 0;\n\n\trequest = create_request(opcode, index, length, param,\n\t\t\t\t\tcallback, user_data, destroy);\n\tif (!request)\n\t\treturn 0;\n\n\tif (mgmt->next_request_id < 1)\n\t\tmgmt->next_request_id = 1;\n\n\trequest->id = mgmt->next_request_id++;\n\n\tif (!send_request(mgmt, request))\n\t\treturn 0;\n\n\treturn request->id;\n}",
          "includes": [
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include \"lib/hci.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/mgmt.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include \"lib/hci.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nunsigned int mgmt_send_nowait(struct mgmt *mgmt, uint16_t opcode, uint16_t index,\n\t\t\t\tuint16_t length, const void *param,\n\t\t\t\tmgmt_request_func_t callback,\n\t\t\t\tvoid *user_data, mgmt_destroy_func_t destroy)\n{\n\tstruct mgmt_request *request;\n\n\tif (!mgmt)\n\t\treturn 0;\n\n\trequest = create_request(opcode, index, length, param,\n\t\t\t\t\tcallback, user_data, destroy);\n\tif (!request)\n\t\treturn 0;\n\n\tif (mgmt->next_request_id < 1)\n\t\tmgmt->next_request_id = 1;\n\n\trequest->id = mgmt->next_request_id++;\n\n\tif (!send_request(mgmt, request))\n\t\treturn 0;\n\n\treturn request->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_new",
          "args": [],
          "line": 173
        },
        "resolved": true,
        "details": {
          "function_name": "queue_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "56-66",
          "snippet": "struct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nstruct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "gap"
          ],
          "line": 169
        },
        "resolved": true,
        "details": {
          "function_name": "irk_entry_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
          "lines": "67-72",
          "snippet": "static void irk_entry_free(void *data)\n{\n\tstruct irk_entry *irk = data;\n\n\tfree(irk);\n}",
          "includes": [
            "#include \"src/shared/gap.h\"",
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void irk_entry_free(void *data)\n{\n\tstruct irk_entry *irk = data;\n\n\tfree(irk);\n}"
        }
      },
      {
        "call_info": {
          "callee": "mgmt_new_default",
          "args": [],
          "line": 167
        },
        "resolved": true,
        "details": {
          "function_name": "mgmt_new_default",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/mgmt.c",
          "lines": "426-459",
          "snippet": "struct mgmt *mgmt_new_default(void)\n{\n\tstruct mgmt *mgmt;\n\tunion {\n\t\tstruct sockaddr common;\n\t\tstruct sockaddr_hci hci;\n\t} addr;\n\tint fd;\n\n\tfd = socket(PF_BLUETOOTH, SOCK_RAW | SOCK_CLOEXEC | SOCK_NONBLOCK,\n\t\t\t\t\t\t\t\tBTPROTO_HCI);\n\tif (fd < 0)\n\t\treturn NULL;\n\n\tmemset(&addr, 0, sizeof(addr));\n\taddr.hci.hci_family = AF_BLUETOOTH;\n\taddr.hci.hci_dev = HCI_DEV_NONE;\n\taddr.hci.hci_channel = HCI_CHANNEL_CONTROL;\n\n\tif (bind(fd, &addr.common, sizeof(addr.hci)) < 0) {\n\t\tclose(fd);\n\t\treturn NULL;\n\t}\n\n\tmgmt = mgmt_new(fd);\n\tif (!mgmt) {\n\t\tclose(fd);\n\t\treturn NULL;\n\t}\n\n\tmgmt->close_on_unref = true;\n\n\treturn mgmt;\n}",
          "includes": [
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include \"lib/hci.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/mgmt.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include \"lib/hci.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstruct mgmt *mgmt_new_default(void)\n{\n\tstruct mgmt *mgmt;\n\tunion {\n\t\tstruct sockaddr common;\n\t\tstruct sockaddr_hci hci;\n\t} addr;\n\tint fd;\n\n\tfd = socket(PF_BLUETOOTH, SOCK_RAW | SOCK_CLOEXEC | SOCK_NONBLOCK,\n\t\t\t\t\t\t\t\tBTPROTO_HCI);\n\tif (fd < 0)\n\t\treturn NULL;\n\n\tmemset(&addr, 0, sizeof(addr));\n\taddr.hci.hci_family = AF_BLUETOOTH;\n\taddr.hci.hci_dev = HCI_DEV_NONE;\n\taddr.hci.hci_channel = HCI_CHANNEL_CONTROL;\n\n\tif (bind(fd, &addr.common, sizeof(addr.hci)) < 0) {\n\t\tclose(fd);\n\t\treturn NULL;\n\t}\n\n\tmgmt = mgmt_new(fd);\n\tif (!mgmt) {\n\t\tclose(fd);\n\t\treturn NULL;\n\t}\n\n\tmgmt->close_on_unref = true;\n\n\treturn mgmt;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_gap",
            "1"
          ],
          "line": 164
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstruct bt_gap *bt_gap_new_index(uint16_t index)\n{\n\tstruct bt_gap *gap;\n\n\tif (index == MGMT_INDEX_NONE)\n\t\treturn NULL;\n\n\tgap = new0(struct bt_gap, 1);\n\tgap->index = index;\n\n\tgap->mgmt = mgmt_new_default();\n\tif (!gap->mgmt) {\n\t\tfree(gap);\n\t\treturn NULL;\n\t}\n\n\tgap->irk_list = queue_new();\n\tgap->mgmt_ready = false;\n\n\tif (!mgmt_send(gap->mgmt, MGMT_OP_READ_VERSION,\n\t\t\t\t\tMGMT_INDEX_NONE, 0, NULL,\n\t\t\t\t\tread_version_complete, gap, NULL)) {\n\t\tmgmt_unref(gap->mgmt);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gap_ref(gap);\n}"
  },
  {
    "function_name": "bt_gap_new_default",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "152-155",
    "snippet": "struct bt_gap *bt_gap_new_default(void)\n{\n\treturn bt_gap_new_index(0x0000);\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gap_new_index",
          "args": [
            "0x0000"
          ],
          "line": 154
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gap_new_index",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
          "lines": "157-184",
          "snippet": "struct bt_gap *bt_gap_new_index(uint16_t index)\n{\n\tstruct bt_gap *gap;\n\n\tif (index == MGMT_INDEX_NONE)\n\t\treturn NULL;\n\n\tgap = new0(struct bt_gap, 1);\n\tgap->index = index;\n\n\tgap->mgmt = mgmt_new_default();\n\tif (!gap->mgmt) {\n\t\tfree(gap);\n\t\treturn NULL;\n\t}\n\n\tgap->irk_list = queue_new();\n\tgap->mgmt_ready = false;\n\n\tif (!mgmt_send(gap->mgmt, MGMT_OP_READ_VERSION,\n\t\t\t\t\tMGMT_INDEX_NONE, 0, NULL,\n\t\t\t\t\tread_version_complete, gap, NULL)) {\n\t\tmgmt_unref(gap->mgmt);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gap_ref(gap);\n}",
          "includes": [
            "#include \"src/shared/gap.h\"",
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstruct bt_gap *bt_gap_new_index(uint16_t index)\n{\n\tstruct bt_gap *gap;\n\n\tif (index == MGMT_INDEX_NONE)\n\t\treturn NULL;\n\n\tgap = new0(struct bt_gap, 1);\n\tgap->index = index;\n\n\tgap->mgmt = mgmt_new_default();\n\tif (!gap->mgmt) {\n\t\tfree(gap);\n\t\treturn NULL;\n\t}\n\n\tgap->irk_list = queue_new();\n\tgap->mgmt_ready = false;\n\n\tif (!mgmt_send(gap->mgmt, MGMT_OP_READ_VERSION,\n\t\t\t\t\tMGMT_INDEX_NONE, 0, NULL,\n\t\t\t\t\tread_version_complete, gap, NULL)) {\n\t\tmgmt_unref(gap->mgmt);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gap_ref(gap);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstruct bt_gap *bt_gap_new_default(void)\n{\n\treturn bt_gap_new_index(0x0000);\n}"
  },
  {
    "function_name": "read_version_complete",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "125-150",
    "snippet": "static void read_version_complete(uint8_t status, uint16_t length,\n\t\t\t\t\tconst void *param, void *user_data)\n{\n\tstruct bt_gap *gap = user_data;\n\tconst struct mgmt_rp_read_version *rp = param;\n\n\tif (status != MGMT_STATUS_SUCCESS) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n\n\tif (length < sizeof(*rp)) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n\n\tgap->mgmt_version = rp->version;\n\tgap->mgmt_revision = le16_to_cpu(rp->revision);\n\n\tif (!mgmt_send(gap->mgmt, MGMT_OP_READ_COMMANDS,\n\t\t\t\tMGMT_INDEX_NONE, 0, NULL,\n\t\t\t\tread_commands_complete, gap, NULL)) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "ready_status",
          "args": [
            "gap",
            "false"
          ],
          "line": 147
        },
        "resolved": true,
        "details": {
          "function_name": "ready_status",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
          "lines": "74-80",
          "snippet": "static void ready_status(struct bt_gap *gap, bool status)\n{\n\tgap->mgmt_ready = status;\n\n\tif (gap->ready_handler)\n\t\tgap->ready_handler(status, gap->ready_data);\n}",
          "includes": [
            "#include \"src/shared/gap.h\"",
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void ready_status(struct bt_gap *gap, bool status)\n{\n\tgap->mgmt_ready = status;\n\n\tif (gap->ready_handler)\n\t\tgap->ready_handler(status, gap->ready_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "mgmt_send",
          "args": [
            "gap->mgmt",
            "MGMT_OP_READ_COMMANDS",
            "MGMT_INDEX_NONE",
            "0",
            "NULL",
            "read_commands_complete",
            "gap",
            "NULL"
          ],
          "line": 144
        },
        "resolved": true,
        "details": {
          "function_name": "mgmt_send_nowait",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/mgmt.c",
          "lines": "605-629",
          "snippet": "unsigned int mgmt_send_nowait(struct mgmt *mgmt, uint16_t opcode, uint16_t index,\n\t\t\t\tuint16_t length, const void *param,\n\t\t\t\tmgmt_request_func_t callback,\n\t\t\t\tvoid *user_data, mgmt_destroy_func_t destroy)\n{\n\tstruct mgmt_request *request;\n\n\tif (!mgmt)\n\t\treturn 0;\n\n\trequest = create_request(opcode, index, length, param,\n\t\t\t\t\tcallback, user_data, destroy);\n\tif (!request)\n\t\treturn 0;\n\n\tif (mgmt->next_request_id < 1)\n\t\tmgmt->next_request_id = 1;\n\n\trequest->id = mgmt->next_request_id++;\n\n\tif (!send_request(mgmt, request))\n\t\treturn 0;\n\n\treturn request->id;\n}",
          "includes": [
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include \"lib/hci.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/mgmt.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include \"lib/hci.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nunsigned int mgmt_send_nowait(struct mgmt *mgmt, uint16_t opcode, uint16_t index,\n\t\t\t\tuint16_t length, const void *param,\n\t\t\t\tmgmt_request_func_t callback,\n\t\t\t\tvoid *user_data, mgmt_destroy_func_t destroy)\n{\n\tstruct mgmt_request *request;\n\n\tif (!mgmt)\n\t\treturn 0;\n\n\trequest = create_request(opcode, index, length, param,\n\t\t\t\t\tcallback, user_data, destroy);\n\tif (!request)\n\t\treturn 0;\n\n\tif (mgmt->next_request_id < 1)\n\t\tmgmt->next_request_id = 1;\n\n\trequest->id = mgmt->next_request_id++;\n\n\tif (!send_request(mgmt, request))\n\t\treturn 0;\n\n\treturn request->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "le16_to_cpu",
          "args": [
            "rp->revision"
          ],
          "line": 142
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void read_version_complete(uint8_t status, uint16_t length,\n\t\t\t\t\tconst void *param, void *user_data)\n{\n\tstruct bt_gap *gap = user_data;\n\tconst struct mgmt_rp_read_version *rp = param;\n\n\tif (status != MGMT_STATUS_SUCCESS) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n\n\tif (length < sizeof(*rp)) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n\n\tgap->mgmt_version = rp->version;\n\tgap->mgmt_revision = le16_to_cpu(rp->revision);\n\n\tif (!mgmt_send(gap->mgmt, MGMT_OP_READ_COMMANDS,\n\t\t\t\tMGMT_INDEX_NONE, 0, NULL,\n\t\t\t\tread_commands_complete, gap, NULL)) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n}"
  },
  {
    "function_name": "read_commands_complete",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "82-123",
    "snippet": "static void read_commands_complete(uint8_t status, uint16_t length,\n\t\t\t\t\tconst void *param, void *user_data)\n{\n\tstruct bt_gap *gap = user_data;\n\tconst struct mgmt_rp_read_commands *rp = param;\n\tuint16_t num_commands, num_events;\n\tconst uint16_t *opcode;\n\tsize_t expected_len;\n\tint i;\n\n\tif (status != MGMT_STATUS_SUCCESS) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n\n\tif (length < sizeof(*rp)) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n\n\tnum_commands = le16_to_cpu(rp->num_commands);\n\tnum_events = le16_to_cpu(rp->num_events);\n\n\texpected_len = sizeof(*rp) + num_commands * sizeof(uint16_t) +\n\t\t\t\t\t\tnum_events * sizeof(uint16_t);\n\n\tif (length < expected_len) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n\n\topcode = rp->opcodes;\n\n\tfor (i = 0; i < num_commands; i++) {\n\t\tuint16_t op = get_le16(opcode++);\n\n\t\tif (op == MGMT_OP_ADD_DEVICE)\n\t\t\tgap->flags |= FLAG_MGMT_CONN_CONTROL;\n\t}\n\n\tready_status(gap, true);\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define FLAG_MGMT_CONN_CONTROL\t(0 << 1)"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "ready_status",
          "args": [
            "gap",
            "true"
          ],
          "line": 122
        },
        "resolved": true,
        "details": {
          "function_name": "ready_status",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
          "lines": "74-80",
          "snippet": "static void ready_status(struct bt_gap *gap, bool status)\n{\n\tgap->mgmt_ready = status;\n\n\tif (gap->ready_handler)\n\t\tgap->ready_handler(status, gap->ready_data);\n}",
          "includes": [
            "#include \"src/shared/gap.h\"",
            "#include \"src/shared/mgmt.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/mgmt.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void ready_status(struct bt_gap *gap, bool status)\n{\n\tgap->mgmt_ready = status;\n\n\tif (gap->ready_handler)\n\t\tgap->ready_handler(status, gap->ready_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "opcode++"
          ],
          "line": 116
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "le16_to_cpu",
          "args": [
            "rp->num_events"
          ],
          "line": 103
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "le16_to_cpu",
          "args": [
            "rp->num_commands"
          ],
          "line": 102
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\n#define FLAG_MGMT_CONN_CONTROL\t(0 << 1)\n\nstatic void read_commands_complete(uint8_t status, uint16_t length,\n\t\t\t\t\tconst void *param, void *user_data)\n{\n\tstruct bt_gap *gap = user_data;\n\tconst struct mgmt_rp_read_commands *rp = param;\n\tuint16_t num_commands, num_events;\n\tconst uint16_t *opcode;\n\tsize_t expected_len;\n\tint i;\n\n\tif (status != MGMT_STATUS_SUCCESS) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n\n\tif (length < sizeof(*rp)) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n\n\tnum_commands = le16_to_cpu(rp->num_commands);\n\tnum_events = le16_to_cpu(rp->num_events);\n\n\texpected_len = sizeof(*rp) + num_commands * sizeof(uint16_t) +\n\t\t\t\t\t\tnum_events * sizeof(uint16_t);\n\n\tif (length < expected_len) {\n\t\tready_status(gap, false);\n\t\treturn;\n\t}\n\n\topcode = rp->opcodes;\n\n\tfor (i = 0; i < num_commands; i++) {\n\t\tuint16_t op = get_le16(opcode++);\n\n\t\tif (op == MGMT_OP_ADD_DEVICE)\n\t\t\tgap->flags |= FLAG_MGMT_CONN_CONTROL;\n\t}\n\n\tready_status(gap, true);\n}"
  },
  {
    "function_name": "ready_status",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "74-80",
    "snippet": "static void ready_status(struct bt_gap *gap, bool status)\n{\n\tgap->mgmt_ready = status;\n\n\tif (gap->ready_handler)\n\t\tgap->ready_handler(status, gap->ready_data);\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "gap->ready_handler",
          "args": [
            "status",
            "gap->ready_data"
          ],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void ready_status(struct bt_gap *gap, bool status)\n{\n\tgap->mgmt_ready = status;\n\n\tif (gap->ready_handler)\n\t\tgap->ready_handler(status, gap->ready_data);\n}"
  },
  {
    "function_name": "irk_entry_free",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
    "lines": "67-72",
    "snippet": "static void irk_entry_free(void *data)\n{\n\tstruct irk_entry *irk = data;\n\n\tfree(irk);\n}",
    "includes": [
      "#include \"src/shared/gap.h\"",
      "#include \"src/shared/mgmt.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"lib/mgmt.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "irk"
          ],
          "line": 71
        },
        "resolved": true,
        "details": {
          "function_name": "irk_entry_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gap.c",
          "lines": "67-72",
          "snippet": "static void irk_entry_free(void *data)\n{\n\tstruct irk_entry *irk = data;\n\n\tfree(irk);\n}",
          "note": "cyclic_reference_detected"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/gap.h\"\n#include \"src/shared/mgmt.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/mgmt.h\"\n#include \"lib/bluetooth.h\"\n#include <stdlib.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void irk_entry_free(void *data)\n{\n\tstruct irk_entry *irk = data;\n\n\tfree(irk);\n}"
  }
]