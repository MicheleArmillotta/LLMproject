[
  {
    "function_name": "bt_att_has_crypto",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1546-1552",
    "snippet": "bool bt_att_has_crypto(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\treturn att->crypto ? true : false;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_has_crypto(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\treturn att->crypto ? true : false;\n}"
  },
  {
    "function_name": "bt_att_set_remote_key",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1537-1544",
    "snippet": "bool bt_att_set_remote_key(struct bt_att *att, uint8_t sign_key[16],\n\t\t\t\tbt_att_counter_func_t func, void *user_data)\n{\n\tif (!att)\n\t\treturn false;\n\n\treturn sign_set_key(&att->remote_sign, sign_key, func, user_data);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "sign_set_key",
          "args": [
            "&att->remote_sign",
            "sign_key",
            "func",
            "user_data"
          ],
          "line": 1543
        },
        "resolved": true,
        "details": {
          "function_name": "sign_set_key",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1515-1526",
          "snippet": "static bool sign_set_key(struct sign_info **sign, uint8_t key[16],\n\t\t\t\tbt_att_counter_func_t func, void *user_data)\n{\n\tif (!(*sign))\n\t\t*sign = new0(struct sign_info, 1);\n\n\t(*sign)->counter = func;\n\t(*sign)->user_data = user_data;\n\tmemcpy((*sign)->key, key, 16);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool sign_set_key(struct sign_info **sign, uint8_t key[16],\n\t\t\t\tbt_att_counter_func_t func, void *user_data)\n{\n\tif (!(*sign))\n\t\t*sign = new0(struct sign_info, 1);\n\n\t(*sign)->counter = func;\n\t(*sign)->user_data = user_data;\n\tmemcpy((*sign)->key, key, 16);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_remote_key(struct bt_att *att, uint8_t sign_key[16],\n\t\t\t\tbt_att_counter_func_t func, void *user_data)\n{\n\tif (!att)\n\t\treturn false;\n\n\treturn sign_set_key(&att->remote_sign, sign_key, func, user_data);\n}"
  },
  {
    "function_name": "bt_att_set_local_key",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1528-1535",
    "snippet": "bool bt_att_set_local_key(struct bt_att *att, uint8_t sign_key[16],\n\t\t\t\tbt_att_counter_func_t func, void *user_data)\n{\n\tif (!att)\n\t\treturn false;\n\n\treturn sign_set_key(&att->local_sign, sign_key, func, user_data);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "sign_set_key",
          "args": [
            "&att->local_sign",
            "sign_key",
            "func",
            "user_data"
          ],
          "line": 1534
        },
        "resolved": true,
        "details": {
          "function_name": "sign_set_key",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1515-1526",
          "snippet": "static bool sign_set_key(struct sign_info **sign, uint8_t key[16],\n\t\t\t\tbt_att_counter_func_t func, void *user_data)\n{\n\tif (!(*sign))\n\t\t*sign = new0(struct sign_info, 1);\n\n\t(*sign)->counter = func;\n\t(*sign)->user_data = user_data;\n\tmemcpy((*sign)->key, key, 16);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool sign_set_key(struct sign_info **sign, uint8_t key[16],\n\t\t\t\tbt_att_counter_func_t func, void *user_data)\n{\n\tif (!(*sign))\n\t\t*sign = new0(struct sign_info, 1);\n\n\t(*sign)->counter = func;\n\t(*sign)->user_data = user_data;\n\tmemcpy((*sign)->key, key, 16);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_local_key(struct bt_att *att, uint8_t sign_key[16],\n\t\t\t\tbt_att_counter_func_t func, void *user_data)\n{\n\tif (!att)\n\t\treturn false;\n\n\treturn sign_set_key(&att->local_sign, sign_key, func, user_data);\n}"
  },
  {
    "function_name": "sign_set_key",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1515-1526",
    "snippet": "static bool sign_set_key(struct sign_info **sign, uint8_t key[16],\n\t\t\t\tbt_att_counter_func_t func, void *user_data)\n{\n\tif (!(*sign))\n\t\t*sign = new0(struct sign_info, 1);\n\n\t(*sign)->counter = func;\n\t(*sign)->user_data = user_data;\n\tmemcpy((*sign)->key, key, 16);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "(*sign)->key",
            "key",
            "16"
          ],
          "line": 1523
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structsign_info",
            "1"
          ],
          "line": 1519
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool sign_set_key(struct sign_info **sign, uint8_t key[16],\n\t\t\t\tbt_att_counter_func_t func, void *user_data)\n{\n\tif (!(*sign))\n\t\t*sign = new0(struct sign_info, 1);\n\n\t(*sign)->counter = func;\n\t(*sign)->user_data = user_data;\n\tmemcpy((*sign)->key, key, 16);\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_att_set_enc_key_size",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1507-1513",
    "snippet": "void bt_att_set_enc_key_size(struct bt_att *att, uint8_t enc_size)\n{\n\tif (!att)\n\t\treturn;\n\n\tatt->enc_size = enc_size;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nvoid bt_att_set_enc_key_size(struct bt_att *att, uint8_t enc_size)\n{\n\tif (!att)\n\t\treturn;\n\n\tatt->enc_size = enc_size;\n}"
  },
  {
    "function_name": "bt_att_set_security",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1484-1505",
    "snippet": "bool bt_att_set_security(struct bt_att *att, int level)\n{\n\tstruct bt_security sec;\n\n\tif (!att || level < BT_ATT_SECURITY_AUTO ||\n\t\t\t\t\t\tlevel > BT_ATT_SECURITY_HIGH)\n\t\treturn false;\n\n\tif (!att->io_on_l2cap) {\n\t\tatt->io_sec_level = level;\n\t\treturn true;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tsec.level = level;\n\n\tif (setsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec,\n\t\t\t\t\t\t\tsizeof(sec)) < 0)\n\t\treturn false;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "setsockopt",
          "args": [
            "att->fd",
            "SOL_BLUETOOTH",
            "BT_SECURITY",
            "&sec",
            "sizeof(sec)"
          ],
          "line": 1500
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&sec",
            "0",
            "sizeof(sec)"
          ],
          "line": 1497
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_security(struct bt_att *att, int level)\n{\n\tstruct bt_security sec;\n\n\tif (!att || level < BT_ATT_SECURITY_AUTO ||\n\t\t\t\t\t\tlevel > BT_ATT_SECURITY_HIGH)\n\t\treturn false;\n\n\tif (!att->io_on_l2cap) {\n\t\tatt->io_sec_level = level;\n\t\treturn true;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tsec.level = level;\n\n\tif (setsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec,\n\t\t\t\t\t\t\tsizeof(sec)) < 0)\n\t\treturn false;\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_att_get_security",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1458-1482",
    "snippet": "int bt_att_get_security(struct bt_att *att, uint8_t *enc_size)\n{\n\tstruct bt_security sec;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap) {\n\t\tif (enc_size)\n\t\t\t*enc_size = att->enc_size;\n\n\t\treturn att->io_sec_level;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tlen = sizeof(sec);\n\tif (getsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec, &len) < 0)\n\t\treturn -EIO;\n\n\tif (enc_size)\n\t\t*enc_size = att->enc_size;\n\n\treturn sec.level;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "getsockopt",
          "args": [
            "att->fd",
            "SOL_BLUETOOTH",
            "BT_SECURITY",
            "&sec",
            "&len"
          ],
          "line": 1475
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&sec",
            "0",
            "sizeof(sec)"
          ],
          "line": 1473
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nint bt_att_get_security(struct bt_att *att, uint8_t *enc_size)\n{\n\tstruct bt_security sec;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap) {\n\t\tif (enc_size)\n\t\t\t*enc_size = att->enc_size;\n\n\t\treturn att->io_sec_level;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tlen = sizeof(sec);\n\tif (getsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec, &len) < 0)\n\t\treturn -EIO;\n\n\tif (enc_size)\n\t\t*enc_size = att->enc_size;\n\n\treturn sec.level;\n}"
  },
  {
    "function_name": "bt_att_unregister_all",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1447-1456",
    "snippet": "bool bt_att_unregister_all(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\tqueue_remove_all(att->notify_list, NULL, NULL, destroy_att_notify);\n\tqueue_remove_all(att->disconn_list, NULL, NULL, destroy_att_disconn);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_remove_all",
          "args": [
            "att->disconn_list",
            "NULL",
            "NULL",
            "destroy_att_disconn"
          ],
          "line": 1453
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "318-362",
          "snippet": "unsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_unregister_all(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\tqueue_remove_all(att->notify_list, NULL, NULL, destroy_att_notify);\n\tqueue_remove_all(att->disconn_list, NULL, NULL, destroy_att_disconn);\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_att_unregister",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1431-1445",
    "snippet": "bool bt_att_unregister(struct bt_att *att, unsigned int id)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tnotify = queue_remove_if(att->notify_list, match_notify_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tdestroy_att_notify(notify);\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "destroy_att_notify",
          "args": [
            "notify"
          ],
          "line": 1443
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_att_notify",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "232-240",
          "snippet": "static void destroy_att_notify(void *data)\n{\n\tstruct att_notify *notify = data;\n\n\tif (notify->destroy)\n\t\tnotify->destroy(notify->user_data);\n\n\tfree(notify);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_notify(void *data)\n{\n\tstruct att_notify *notify = data;\n\n\tif (notify->destroy)\n\t\tnotify->destroy(notify->user_data);\n\n\tfree(notify);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_if",
          "args": [
            "att->notify_list",
            "match_notify_id",
            "UINT_TO_PTR(id)"
          ],
          "line": 1438
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_if",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "278-316",
          "snippet": "void *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 1439
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_unregister(struct bt_att *att, unsigned int id)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tnotify = queue_remove_if(att->notify_list, match_notify_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tdestroy_att_notify(notify);\n\treturn true;\n}"
  },
  {
    "function_name": "bt_att_register",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1402-1429",
    "snippet": "unsigned int bt_att_register(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tbt_att_notify_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !callback || !att->io)\n\t\treturn 0;\n\n\tnotify = new0(struct att_notify, 1);\n\tnotify->opcode = opcode;\n\tnotify->callback = callback;\n\tnotify->destroy = destroy;\n\tnotify->user_data = user_data;\n\n\tif (att->next_reg_id < 1)\n\t\tatt->next_reg_id = 1;\n\n\tnotify->id = att->next_reg_id++;\n\n\tif (!queue_push_tail(att->notify_list, notify)) {\n\t\tfree(notify);\n\t\treturn 0;\n\t}\n\n\treturn notify->id;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "notify"
          ],
          "line": 1424
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "att->notify_list",
            "notify"
          ],
          "line": 1423
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structatt_notify",
            "1"
          ],
          "line": 1412
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_register(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tbt_att_notify_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !callback || !att->io)\n\t\treturn 0;\n\n\tnotify = new0(struct att_notify, 1);\n\tnotify->opcode = opcode;\n\tnotify->callback = callback;\n\tnotify->destroy = destroy;\n\tnotify->user_data = user_data;\n\n\tif (att->next_reg_id < 1)\n\t\tatt->next_reg_id = 1;\n\n\tnotify->id = att->next_reg_id++;\n\n\tif (!queue_push_tail(att->notify_list, notify)) {\n\t\tfree(notify);\n\t\treturn 0;\n\t}\n\n\treturn notify->id;\n}"
  },
  {
    "function_name": "bt_att_send_error_rsp",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1381-1400",
    "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "att",
            "BT_ATT_OP_ERROR_RSP",
            "&pdu",
            "sizeof(pdu)",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 1398
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "handle",
            "&pdu.handle"
          ],
          "line": 1395
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&pdu",
            "0",
            "sizeof(pdu)"
          ],
          "line": 1392
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "att_ecode_from_error",
          "args": [
            "error"
          ],
          "line": 1390
        },
        "resolved": true,
        "details": {
          "function_name": "att_ecode_from_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1353-1379",
          "snippet": "static uint8_t att_ecode_from_error(int err)\n{\n\t/*\n\t * If the error fits in a single byte, treat it as an ATT protocol\n\t * error as is. Since \"0\" is not a valid ATT protocol error code, we map\n\t * that to UNLIKELY below.\n\t */\n\tif (err > 0 && err < UINT8_MAX)\n\t\treturn err;\n\n\t/*\n\t * Since we allow UNIX errnos, map them to appropriate ATT protocol\n\t * and \"Common Profile and Service\" error codes.\n\t */\n\tswitch (err) {\n\tcase -ENOENT:\n\t\treturn BT_ATT_ERROR_INVALID_HANDLE;\n\tcase -ENOMEM:\n\t\treturn BT_ATT_ERROR_INSUFFICIENT_RESOURCES;\n\tcase -EALREADY:\n\t\treturn BT_ERROR_ALREADY_IN_PROGRESS;\n\tcase -EOVERFLOW:\n\t\treturn BT_ERROR_OUT_OF_RANGE;\n\t}\n\n\treturn BT_ATT_ERROR_UNLIKELY;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic uint8_t att_ecode_from_error(int err)\n{\n\t/*\n\t * If the error fits in a single byte, treat it as an ATT protocol\n\t * error as is. Since \"0\" is not a valid ATT protocol error code, we map\n\t * that to UNLIKELY below.\n\t */\n\tif (err > 0 && err < UINT8_MAX)\n\t\treturn err;\n\n\t/*\n\t * Since we allow UNIX errnos, map them to appropriate ATT protocol\n\t * and \"Common Profile and Service\" error codes.\n\t */\n\tswitch (err) {\n\tcase -ENOENT:\n\t\treturn BT_ATT_ERROR_INVALID_HANDLE;\n\tcase -ENOMEM:\n\t\treturn BT_ATT_ERROR_INSUFFICIENT_RESOURCES;\n\tcase -EALREADY:\n\t\treturn BT_ERROR_ALREADY_IN_PROGRESS;\n\tcase -EOVERFLOW:\n\t\treturn BT_ERROR_OUT_OF_RANGE;\n\t}\n\n\treturn BT_ATT_ERROR_UNLIKELY;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
  },
  {
    "function_name": "att_ecode_from_error",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1353-1379",
    "snippet": "static uint8_t att_ecode_from_error(int err)\n{\n\t/*\n\t * If the error fits in a single byte, treat it as an ATT protocol\n\t * error as is. Since \"0\" is not a valid ATT protocol error code, we map\n\t * that to UNLIKELY below.\n\t */\n\tif (err > 0 && err < UINT8_MAX)\n\t\treturn err;\n\n\t/*\n\t * Since we allow UNIX errnos, map them to appropriate ATT protocol\n\t * and \"Common Profile and Service\" error codes.\n\t */\n\tswitch (err) {\n\tcase -ENOENT:\n\t\treturn BT_ATT_ERROR_INVALID_HANDLE;\n\tcase -ENOMEM:\n\t\treturn BT_ATT_ERROR_INSUFFICIENT_RESOURCES;\n\tcase -EALREADY:\n\t\treturn BT_ERROR_ALREADY_IN_PROGRESS;\n\tcase -EOVERFLOW:\n\t\treturn BT_ERROR_OUT_OF_RANGE;\n\t}\n\n\treturn BT_ATT_ERROR_UNLIKELY;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic uint8_t att_ecode_from_error(int err)\n{\n\t/*\n\t * If the error fits in a single byte, treat it as an ATT protocol\n\t * error as is. Since \"0\" is not a valid ATT protocol error code, we map\n\t * that to UNLIKELY below.\n\t */\n\tif (err > 0 && err < UINT8_MAX)\n\t\treturn err;\n\n\t/*\n\t * Since we allow UNIX errnos, map them to appropriate ATT protocol\n\t * and \"Common Profile and Service\" error codes.\n\t */\n\tswitch (err) {\n\tcase -ENOENT:\n\t\treturn BT_ATT_ERROR_INVALID_HANDLE;\n\tcase -ENOMEM:\n\t\treturn BT_ATT_ERROR_INSUFFICIENT_RESOURCES;\n\tcase -EALREADY:\n\t\treturn BT_ERROR_ALREADY_IN_PROGRESS;\n\tcase -EOVERFLOW:\n\t\treturn BT_ERROR_OUT_OF_RANGE;\n\t}\n\n\treturn BT_ATT_ERROR_UNLIKELY;\n}"
  },
  {
    "function_name": "bt_att_cancel_all",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1333-1351",
    "snippet": "bool bt_att_cancel_all(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\tqueue_remove_all(att->req_queue, NULL, NULL, destroy_att_send_op);\n\tqueue_remove_all(att->ind_queue, NULL, NULL, destroy_att_send_op);\n\tqueue_remove_all(att->write_queue, NULL, NULL, destroy_att_send_op);\n\n\tif (att->pending_req)\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "cancel_att_send_op",
          "args": [
            "att->pending_ind"
          ],
          "line": 1348
        },
        "resolved": true,
        "details": {
          "function_name": "cancel_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "214-222",
          "snippet": "static void cancel_att_send_op(struct att_send_op *op)\n{\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\top->user_data = NULL;\n\top->callback = NULL;\n\top->destroy = NULL;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void cancel_att_send_op(struct att_send_op *op)\n{\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\top->user_data = NULL;\n\top->callback = NULL;\n\top->destroy = NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_all",
          "args": [
            "att->write_queue",
            "NULL",
            "NULL",
            "destroy_att_send_op"
          ],
          "line": 1340
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "318-362",
          "snippet": "unsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_cancel_all(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\tqueue_remove_all(att->req_queue, NULL, NULL, destroy_att_send_op);\n\tqueue_remove_all(att->ind_queue, NULL, NULL, destroy_att_send_op);\n\tqueue_remove_all(att->write_queue, NULL, NULL, destroy_att_send_op);\n\n\tif (att->pending_req)\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_att_cancel",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1291-1331",
    "snippet": "bool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "wakeup_writer",
          "args": [
            "att"
          ],
          "line": 1328
        },
        "resolved": true,
        "details": {
          "function_name": "wakeup_writer",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "509-528",
          "snippet": "static void wakeup_writer(struct bt_att *att)\n{\n\tif (att->writer_active)\n\t\treturn;\n\n\t/* Set the write handler only if there is anything that can be sent\n\t * at all.\n\t */\n\tif (queue_isempty(att->write_queue)) {\n\t\tif ((att->pending_req || queue_isempty(att->req_queue)) &&\n\t\t\t(att->pending_ind || queue_isempty(att->ind_queue)))\n\t\t\treturn;\n\t}\n\n\tif (!io_set_write_handler(att->io, can_write_data, att,\n\t\t\t\t\t\t\twrite_watch_destroy))\n\t\treturn;\n\n\tatt->writer_active = true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void wakeup_writer(struct bt_att *att)\n{\n\tif (att->writer_active)\n\t\treturn;\n\n\t/* Set the write handler only if there is anything that can be sent\n\t * at all.\n\t */\n\tif (queue_isempty(att->write_queue)) {\n\t\tif ((att->pending_req || queue_isempty(att->req_queue)) &&\n\t\t\t(att->pending_ind || queue_isempty(att->ind_queue)))\n\t\t\treturn;\n\t}\n\n\tif (!io_set_write_handler(att->io, can_write_data, att,\n\t\t\t\t\t\t\twrite_watch_destroy))\n\t\treturn;\n\n\tatt->writer_active = true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "destroy_att_send_op",
          "args": [
            "op"
          ],
          "line": 1326
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "200-212",
          "snippet": "static void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_if",
          "args": [
            "att->write_queue",
            "match_op_id",
            "UINT_TO_PTR(id)"
          ],
          "line": 1318
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_if",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "278-316",
          "snippet": "void *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 1318
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 1314
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 1310
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "cancel_att_send_op",
          "args": [
            "att->pending_ind"
          ],
          "line": 1306
        },
        "resolved": true,
        "details": {
          "function_name": "cancel_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "214-222",
          "snippet": "static void cancel_att_send_op(struct att_send_op *op)\n{\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\top->user_data = NULL;\n\top->callback = NULL;\n\top->destroy = NULL;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void cancel_att_send_op(struct att_send_op *op)\n{\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\top->user_data = NULL;\n\top->callback = NULL;\n\top->destroy = NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_cancel(struct bt_att *att, unsigned int id)\n{\n\tstruct att_send_op *op;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tif (att->pending_req && att->pending_req->id == id) {\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\t\treturn true;\n\t}\n\n\tif (att->pending_ind && att->pending_ind->id == id) {\n\t\t/* Don't cancel the pending indication; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\t\treturn true;\n\t}\n\n\top = queue_remove_if(att->req_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->ind_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\top = queue_remove_if(att->write_queue, match_op_id, UINT_TO_PTR(id));\n\tif (op)\n\t\tgoto done;\n\n\tif (!op)\n\t\treturn false;\n\ndone:\n\tdestroy_att_send_op(op);\n\n\twakeup_writer(att);\n\n\treturn true;\n}"
  },
  {
    "function_name": "match_op_id",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1283-1289",
    "snippet": "static bool match_op_id(const void *a, const void *b)\n{\n\tconst struct att_send_op *op = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn op->id == id;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "PTR_TO_UINT",
          "args": [
            "b"
          ],
          "line": 1286
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool match_op_id(const void *a, const void *b)\n{\n\tconst struct att_send_op *op = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn op->id == id;\n}"
  },
  {
    "function_name": "bt_att_send",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1233-1281",
    "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "wakeup_writer",
          "args": [
            "att"
          ],
          "line": 1278
        },
        "resolved": true,
        "details": {
          "function_name": "wakeup_writer",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "509-528",
          "snippet": "static void wakeup_writer(struct bt_att *att)\n{\n\tif (att->writer_active)\n\t\treturn;\n\n\t/* Set the write handler only if there is anything that can be sent\n\t * at all.\n\t */\n\tif (queue_isempty(att->write_queue)) {\n\t\tif ((att->pending_req || queue_isempty(att->req_queue)) &&\n\t\t\t(att->pending_ind || queue_isempty(att->ind_queue)))\n\t\t\treturn;\n\t}\n\n\tif (!io_set_write_handler(att->io, can_write_data, att,\n\t\t\t\t\t\t\twrite_watch_destroy))\n\t\treturn;\n\n\tatt->writer_active = true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void wakeup_writer(struct bt_att *att)\n{\n\tif (att->writer_active)\n\t\treturn;\n\n\t/* Set the write handler only if there is anything that can be sent\n\t * at all.\n\t */\n\tif (queue_isempty(att->write_queue)) {\n\t\tif ((att->pending_req || queue_isempty(att->req_queue)) &&\n\t\t\t(att->pending_ind || queue_isempty(att->ind_queue)))\n\t\t\treturn;\n\t}\n\n\tif (!io_set_write_handler(att->io, can_write_data, att,\n\t\t\t\t\t\t\twrite_watch_destroy))\n\t\treturn;\n\n\tatt->writer_active = true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 1274
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "att->write_queue",
            "op"
          ],
          "line": 1268
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "create_att_send_op",
          "args": [
            "att",
            "opcode",
            "pdu",
            "length",
            "callback",
            "user_data",
            "destroy"
          ],
          "line": 1244
        },
        "resolved": true,
        "details": {
          "function_name": "create_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "319-363",
          "snippet": "static struct att_send_op *create_att_send_op(struct bt_att *att,\n\t\t\t\t\t\tuint8_t opcode,\n\t\t\t\t\t\tconst void *pdu,\n\t\t\t\t\t\tuint16_t length,\n\t\t\t\t\t\tbt_att_response_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tenum att_op_type type;\n\n\tif (length && !pdu)\n\t\treturn NULL;\n\n\ttype = get_op_type(opcode);\n\tif (type == ATT_OP_TYPE_UNKNOWN)\n\t\treturn NULL;\n\n\t/* If the opcode corresponds to an operation type that does not elicit a\n\t * response from the remote end, then no callback should have been\n\t * provided, since it will never be called.\n\t */\n\tif (callback && type != ATT_OP_TYPE_REQ && type != ATT_OP_TYPE_IND)\n\t\treturn NULL;\n\n\t/* Similarly, if the operation does elicit a response then a callback\n\t * must be provided.\n\t */\n\tif (!callback && (type == ATT_OP_TYPE_REQ || type == ATT_OP_TYPE_IND))\n\t\treturn NULL;\n\n\top = new0(struct att_send_op, 1);\n\top->type = type;\n\top->opcode = opcode;\n\top->callback = callback;\n\top->destroy = destroy;\n\top->user_data = user_data;\n\n\tif (!encode_pdu(att, op, pdu, length)) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn op;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic struct att_send_op *create_att_send_op(struct bt_att *att,\n\t\t\t\t\t\tuint8_t opcode,\n\t\t\t\t\t\tconst void *pdu,\n\t\t\t\t\t\tuint16_t length,\n\t\t\t\t\t\tbt_att_response_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tenum att_op_type type;\n\n\tif (length && !pdu)\n\t\treturn NULL;\n\n\ttype = get_op_type(opcode);\n\tif (type == ATT_OP_TYPE_UNKNOWN)\n\t\treturn NULL;\n\n\t/* If the opcode corresponds to an operation type that does not elicit a\n\t * response from the remote end, then no callback should have been\n\t * provided, since it will never be called.\n\t */\n\tif (callback && type != ATT_OP_TYPE_REQ && type != ATT_OP_TYPE_IND)\n\t\treturn NULL;\n\n\t/* Similarly, if the operation does elicit a response then a callback\n\t * must be provided.\n\t */\n\tif (!callback && (type == ATT_OP_TYPE_REQ || type == ATT_OP_TYPE_IND))\n\t\treturn NULL;\n\n\top = new0(struct att_send_op, 1);\n\top->type = type;\n\top->opcode = opcode;\n\top->callback = callback;\n\top->destroy = destroy;\n\top->user_data = user_data;\n\n\tif (!encode_pdu(att, op, pdu, length)) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn op;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
  },
  {
    "function_name": "bt_att_unregister_disconnect",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1206-1231",
    "snippet": "bool bt_att_unregister_disconnect(struct bt_att *att, unsigned int id)\n{\n\tstruct att_disconn *disconn;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\t/* Check if disconnect is running */\n\tif (!att->io) {\n\t\tdisconn = queue_find(att->disconn_list, match_disconn_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\t\tif (!disconn)\n\t\t\treturn false;\n\n\t\tdisconn->removed = true;\n\t\treturn true;\n\t}\n\n\tdisconn = queue_remove_if(att->disconn_list, match_disconn_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!disconn)\n\t\treturn false;\n\n\tdestroy_att_disconn(disconn);\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "destroy_att_disconn",
          "args": [
            "disconn"
          ],
          "line": 1229
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_att_disconn",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "258-266",
          "snippet": "static void destroy_att_disconn(void *data)\n{\n\tstruct att_disconn *disconn = data;\n\n\tif (disconn->destroy)\n\t\tdisconn->destroy(disconn->user_data);\n\n\tfree(disconn);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_disconn(void *data)\n{\n\tstruct att_disconn *disconn = data;\n\n\tif (disconn->destroy)\n\t\tdisconn->destroy(disconn->user_data);\n\n\tfree(disconn);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_if",
          "args": [
            "att->disconn_list",
            "match_disconn_id",
            "UINT_TO_PTR(id)"
          ],
          "line": 1224
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_if",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "278-316",
          "snippet": "void *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 1225
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "queue_find",
          "args": [
            "att->disconn_list",
            "match_disconn_id",
            "UINT_TO_PTR(id)"
          ],
          "line": 1215
        },
        "resolved": true,
        "details": {
          "function_name": "queue_find",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "231-247",
          "snippet": "void *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 1216
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_unregister_disconnect(struct bt_att *att, unsigned int id)\n{\n\tstruct att_disconn *disconn;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\t/* Check if disconnect is running */\n\tif (!att->io) {\n\t\tdisconn = queue_find(att->disconn_list, match_disconn_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\t\tif (!disconn)\n\t\t\treturn false;\n\n\t\tdisconn->removed = true;\n\t\treturn true;\n\t}\n\n\tdisconn = queue_remove_if(att->disconn_list, match_disconn_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!disconn)\n\t\treturn false;\n\n\tdestroy_att_disconn(disconn);\n\treturn true;\n}"
  },
  {
    "function_name": "bt_att_register_disconnect",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1178-1204",
    "snippet": "unsigned int bt_att_register_disconnect(struct bt_att *att,\n\t\t\t\t\tbt_att_disconnect_func_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_disconn *disconn;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\tdisconn = new0(struct att_disconn, 1);\n\tdisconn->callback = callback;\n\tdisconn->destroy = destroy;\n\tdisconn->user_data = user_data;\n\n\tif (att->next_reg_id < 1)\n\t\tatt->next_reg_id = 1;\n\n\tdisconn->id = att->next_reg_id++;\n\n\tif (!queue_push_tail(att->disconn_list, disconn)) {\n\t\tfree(disconn);\n\t\treturn 0;\n\t}\n\n\treturn disconn->id;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "disconn"
          ],
          "line": 1199
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "att->disconn_list",
            "disconn"
          ],
          "line": 1198
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structatt_disconn",
            "1"
          ],
          "line": 1188
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_register_disconnect(struct bt_att *att,\n\t\t\t\t\tbt_att_disconnect_func_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_disconn *disconn;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\tdisconn = new0(struct att_disconn, 1);\n\tdisconn->callback = callback;\n\tdisconn->destroy = destroy;\n\tdisconn->user_data = user_data;\n\n\tif (att->next_reg_id < 1)\n\t\tatt->next_reg_id = 1;\n\n\tdisconn->id = att->next_reg_id++;\n\n\tif (!queue_push_tail(att->disconn_list, disconn)) {\n\t\tfree(disconn);\n\t\treturn 0;\n\t}\n\n\treturn disconn->id;\n}"
  },
  {
    "function_name": "bt_att_set_timeout_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1161-1176",
    "snippet": "bool bt_att_set_timeout_cb(struct bt_att *att, bt_att_timeout_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tif (!att)\n\t\treturn false;\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tatt->timeout_callback = callback;\n\tatt->timeout_destroy = destroy;\n\tatt->timeout_data = user_data;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "att->timeout_destroy",
          "args": [
            "att->timeout_data"
          ],
          "line": 1169
        },
        "resolved": true,
        "details": {
          "function_name": "timeout_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/timeout-mainloop.c",
          "lines": "45-53",
          "snippet": "static void timeout_destroy(void *user_data)\n{\n\tstruct timeout_data *data = user_data;\n\n\tif (data->destroy)\n\t\tdata->destroy(data->user_data);\n\n\tfree(data);\n}",
          "includes": [
            "#include \"timeout.h\"",
            "#include \"util.h\"",
            "#include \"mainloop.h\"",
            "#include <stdlib.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"timeout.h\"\n#include \"util.h\"\n#include \"mainloop.h\"\n#include <stdlib.h>\n\nstatic void timeout_destroy(void *user_data)\n{\n\tstruct timeout_data *data = user_data;\n\n\tif (data->destroy)\n\t\tdata->destroy(data->user_data);\n\n\tfree(data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_timeout_cb(struct bt_att *att, bt_att_timeout_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tif (!att)\n\t\treturn false;\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tatt->timeout_callback = callback;\n\tatt->timeout_destroy = destroy;\n\tatt->timeout_data = user_data;\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_att_get_link_type",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1139-1159",
    "snippet": "uint8_t bt_att_get_link_type(struct bt_att *att)\n{\n\tstruct sockaddr_l2 src;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap)\n\t\treturn BT_ATT_LINK_LOCAL;\n\n\tlen = sizeof(src);\n\tmemset(&src, 0, len);\n\tif (getsockname(att->fd, (void *)&src, &len) < 0)\n\t\treturn -errno;\n\n\tif (src.l2_bdaddr_type == BDADDR_BREDR)\n\t\treturn BT_ATT_LINK_BREDR;\n\n\treturn BT_ATT_LINK_LE;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "getsockname",
          "args": [
            "att->fd",
            "(void *)&src",
            "&len"
          ],
          "line": 1152
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&src",
            "0",
            "len"
          ],
          "line": 1151
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint8_t bt_att_get_link_type(struct bt_att *att)\n{\n\tstruct sockaddr_l2 src;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap)\n\t\treturn BT_ATT_LINK_LOCAL;\n\n\tlen = sizeof(src);\n\tmemset(&src, 0, len);\n\tif (getsockname(att->fd, (void *)&src, &len) < 0)\n\t\treturn -errno;\n\n\tif (src.l2_bdaddr_type == BDADDR_BREDR)\n\t\treturn BT_ATT_LINK_BREDR;\n\n\treturn BT_ATT_LINK_LE;\n}"
  },
  {
    "function_name": "bt_att_set_mtu",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1117-1137",
    "snippet": "bool bt_att_set_mtu(struct bt_att *att, uint16_t mtu)\n{\n\tvoid *buf;\n\n\tif (!att)\n\t\treturn false;\n\n\tif (mtu < BT_ATT_DEFAULT_LE_MTU)\n\t\treturn false;\n\n\tbuf = malloc(mtu);\n\tif (!buf)\n\t\treturn false;\n\n\tfree(att->buf);\n\n\tatt->mtu = mtu;\n\tatt->buf = buf;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "att->buf"
          ],
          "line": 1131
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "mtu"
          ],
          "line": 1127
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_mtu(struct bt_att *att, uint16_t mtu)\n{\n\tvoid *buf;\n\n\tif (!att)\n\t\treturn false;\n\n\tif (mtu < BT_ATT_DEFAULT_LE_MTU)\n\t\treturn false;\n\n\tbuf = malloc(mtu);\n\tif (!buf)\n\t\treturn false;\n\n\tfree(att->buf);\n\n\tatt->mtu = mtu;\n\tatt->buf = buf;\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_att_get_mtu",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1109-1115",
    "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
  },
  {
    "function_name": "bt_att_set_debug",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1093-1107",
    "snippet": "bool bt_att_set_debug(struct bt_att *att, bt_att_debug_func_t callback,\n\t\t\t\tvoid *user_data, bt_att_destroy_func_t destroy)\n{\n\tif (!att)\n\t\treturn false;\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tatt->debug_callback = callback;\n\tatt->debug_destroy = destroy;\n\tatt->debug_data = user_data;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "att->debug_destroy",
          "args": [
            "att->debug_data"
          ],
          "line": 1100
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_debug(struct bt_att *att, bt_att_debug_func_t callback,\n\t\t\t\tvoid *user_data, bt_att_destroy_func_t destroy)\n{\n\tif (!att)\n\t\treturn false;\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tatt->debug_callback = callback;\n\tatt->debug_destroy = destroy;\n\tatt->debug_data = user_data;\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_att_get_fd",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1085-1091",
    "snippet": "int bt_att_get_fd(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn -1;\n\n\treturn att->fd;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nint bt_att_get_fd(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn -1;\n\n\treturn att->fd;\n}"
  },
  {
    "function_name": "bt_att_set_close_on_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1077-1083",
    "snippet": "bool bt_att_set_close_on_unref(struct bt_att *att, bool do_close)\n{\n\tif (!att || !att->io)\n\t\treturn false;\n\n\treturn io_set_close_on_destroy(att->io, do_close);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "io_set_close_on_destroy",
          "args": [
            "att->io",
            "do_close"
          ],
          "line": 1082
        },
        "resolved": true,
        "details": {
          "function_name": "io_set_close_on_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "145-156",
          "snippet": "bool io_set_close_on_destroy(struct io *io, bool do_close)\n{\n\tif (!io)\n\t\treturn false;\n\n\tif (do_close)\n\t\tg_io_channel_set_close_on_unref(io->channel, TRUE);\n\telse\n\t\tg_io_channel_set_close_on_unref(io->channel, FALSE);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_set_close_on_destroy(struct io *io, bool do_close)\n{\n\tif (!io)\n\t\treturn false;\n\n\tif (do_close)\n\t\tg_io_channel_set_close_on_unref(io->channel, TRUE);\n\telse\n\t\tg_io_channel_set_close_on_unref(io->channel, FALSE);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_close_on_unref(struct bt_att *att, bool do_close)\n{\n\tif (!att || !att->io)\n\t\treturn false;\n\n\treturn io_set_close_on_destroy(att->io, do_close);\n}"
  },
  {
    "function_name": "bt_att_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1063-1075",
    "snippet": "void bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_free",
          "args": [
            "att"
          ],
          "line": 1074
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_cancel_all",
          "args": [
            "att"
          ],
          "line": 1072
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_cancel_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1333-1351",
          "snippet": "bool bt_att_cancel_all(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\tqueue_remove_all(att->req_queue, NULL, NULL, destroy_att_send_op);\n\tqueue_remove_all(att->ind_queue, NULL, NULL, destroy_att_send_op);\n\tqueue_remove_all(att->write_queue, NULL, NULL, destroy_att_send_op);\n\n\tif (att->pending_req)\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_cancel_all(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\tqueue_remove_all(att->req_queue, NULL, NULL, destroy_att_send_op);\n\tqueue_remove_all(att->ind_queue, NULL, NULL, destroy_att_send_op);\n\tqueue_remove_all(att->write_queue, NULL, NULL, destroy_att_send_op);\n\n\tif (att->pending_req)\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\t/* Don't cancel the pending request; remove it's handlers */\n\t\tcancel_att_send_op(att->pending_ind);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_unregister_all",
          "args": [
            "att"
          ],
          "line": 1071
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unregister_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1447-1456",
          "snippet": "bool bt_att_unregister_all(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\tqueue_remove_all(att->notify_list, NULL, NULL, destroy_att_notify);\n\tqueue_remove_all(att->disconn_list, NULL, NULL, destroy_att_disconn);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_unregister_all(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\tqueue_remove_all(att->notify_list, NULL, NULL, destroy_att_notify);\n\tqueue_remove_all(att->disconn_list, NULL, NULL, destroy_att_disconn);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&att->ref_count",
            "1"
          ],
          "line": 1068
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nvoid bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}"
  },
  {
    "function_name": "bt_att_ref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "1053-1061",
    "snippet": "struct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&att->ref_count",
            "1"
          ],
          "line": 1058
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstruct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}"
  },
  {
    "function_name": "bt_att_new",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "999-1051",
    "snippet": "struct bt_att *bt_att_new(int fd, bool ext_signed)\n{\n\tstruct bt_att *att;\n\n\tif (fd < 0)\n\t\treturn NULL;\n\n\tatt = new0(struct bt_att, 1);\n\tatt->fd = fd;\n\n\tatt->io = io_new(fd);\n\tif (!att->io)\n\t\tgoto fail;\n\n\t/* crypto is optional, if not available leave it NULL */\n\tif (!ext_signed)\n\t\tatt->crypto = bt_crypto_new();\n\n\tatt->req_queue = queue_new();\n\tatt->ind_queue = queue_new();\n\tatt->write_queue = queue_new();\n\tatt->notify_list = queue_new();\n\tatt->disconn_list = queue_new();\n\n\tif (!io_set_read_handler(att->io, can_read_data, att, NULL))\n\t\tgoto fail;\n\n\tif (!io_set_disconnect_handler(att->io, disconnect_cb, att, NULL))\n\t\tgoto fail;\n\n\tatt->io_on_l2cap = is_io_l2cap_based(att->fd);\n\tif (!att->io_on_l2cap)\n\t\tatt->io_sec_level = BT_ATT_SECURITY_LOW;\n\n\tif (bt_att_get_link_type(att) == BT_ATT_LINK_BREDR)\n\t\tatt->mtu = get_l2cap_mtu(att->fd);\n\telse\n\t\tatt->mtu = BT_ATT_DEFAULT_LE_MTU;\n\n\tif (att->mtu < BT_ATT_DEFAULT_LE_MTU)\n\t\tgoto fail;\n\n\tatt->buf = malloc(att->mtu);\n\tif (!att->buf)\n\t\tgoto fail;\n\n\treturn bt_att_ref(att);\n\nfail:\n\tbt_att_free(att);\n\n\treturn NULL;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_free",
          "args": [
            "att"
          ],
          "line": 1048
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_ref",
          "args": [
            "att"
          ],
          "line": 1045
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1053-1061",
          "snippet": "struct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstruct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}"
        }
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "att->mtu"
          ],
          "line": 1041
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_l2cap_mtu",
          "args": [
            "att->fd"
          ],
          "line": 1034
        },
        "resolved": true,
        "details": {
          "function_name": "get_l2cap_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "987-997",
          "snippet": "static uint16_t get_l2cap_mtu(int fd)\n{\n\tsocklen_t len;\n\tstruct l2cap_options l2o;\n\n\tlen = sizeof(l2o);\n\tif (getsockopt(fd, SOL_L2CAP, L2CAP_OPTIONS, &l2o, &len) < 0)\n\t\treturn 0;\n\n\treturn l2o.omtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic uint16_t get_l2cap_mtu(int fd)\n{\n\tsocklen_t len;\n\tstruct l2cap_options l2o;\n\n\tlen = sizeof(l2o);\n\tif (getsockopt(fd, SOL_L2CAP, L2CAP_OPTIONS, &l2o, &len) < 0)\n\t\treturn 0;\n\n\treturn l2o.omtu;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_link_type",
          "args": [
            "att"
          ],
          "line": 1033
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_link_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1139-1159",
          "snippet": "uint8_t bt_att_get_link_type(struct bt_att *att)\n{\n\tstruct sockaddr_l2 src;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap)\n\t\treturn BT_ATT_LINK_LOCAL;\n\n\tlen = sizeof(src);\n\tmemset(&src, 0, len);\n\tif (getsockname(att->fd, (void *)&src, &len) < 0)\n\t\treturn -errno;\n\n\tif (src.l2_bdaddr_type == BDADDR_BREDR)\n\t\treturn BT_ATT_LINK_BREDR;\n\n\treturn BT_ATT_LINK_LE;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint8_t bt_att_get_link_type(struct bt_att *att)\n{\n\tstruct sockaddr_l2 src;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap)\n\t\treturn BT_ATT_LINK_LOCAL;\n\n\tlen = sizeof(src);\n\tmemset(&src, 0, len);\n\tif (getsockname(att->fd, (void *)&src, &len) < 0)\n\t\treturn -errno;\n\n\tif (src.l2_bdaddr_type == BDADDR_BREDR)\n\t\treturn BT_ATT_LINK_BREDR;\n\n\treturn BT_ATT_LINK_LE;\n}"
        }
      },
      {
        "call_info": {
          "callee": "is_io_l2cap_based",
          "args": [
            "att->fd"
          ],
          "line": 1029
        },
        "resolved": true,
        "details": {
          "function_name": "is_io_l2cap_based",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "931-954",
          "snippet": "static bool is_io_l2cap_based(int fd)\n{\n\tint domain;\n\tint proto;\n\tint err;\n\tsocklen_t len;\n\n\tdomain = 0;\n\tlen = sizeof(domain);\n\terr = getsockopt(fd, SOL_SOCKET, SO_DOMAIN, &domain, &len);\n\tif (err < 0)\n\t\treturn false;\n\n\tif (domain != AF_BLUETOOTH)\n\t\treturn false;\n\n\tproto = 0;\n\tlen = sizeof(proto);\n\terr = getsockopt(fd, SOL_SOCKET, SO_PROTOCOL, &proto, &len);\n\tif (err < 0)\n\t\treturn false;\n\n\treturn proto == BTPROTO_L2CAP;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool is_io_l2cap_based(int fd)\n{\n\tint domain;\n\tint proto;\n\tint err;\n\tsocklen_t len;\n\n\tdomain = 0;\n\tlen = sizeof(domain);\n\terr = getsockopt(fd, SOL_SOCKET, SO_DOMAIN, &domain, &len);\n\tif (err < 0)\n\t\treturn false;\n\n\tif (domain != AF_BLUETOOTH)\n\t\treturn false;\n\n\tproto = 0;\n\tlen = sizeof(proto);\n\terr = getsockopt(fd, SOL_SOCKET, SO_PROTOCOL, &proto, &len);\n\tif (err < 0)\n\t\treturn false;\n\n\treturn proto == BTPROTO_L2CAP;\n}"
        }
      },
      {
        "call_info": {
          "callee": "io_set_disconnect_handler",
          "args": [
            "att->io",
            "disconnect_cb",
            "att",
            "NULL"
          ],
          "line": 1026
        },
        "resolved": true,
        "details": {
          "function_name": "io_set_disconnect_handler",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "260-264",
          "snippet": "bool io_set_disconnect_handler(struct io *io, io_callback_func_t callback,\n\t\t\t\tvoid *user_data, io_destroy_func_t destroy)\n{\n\treturn io_set_handler(io, G_IO_HUP, callback, user_data, destroy);\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_set_disconnect_handler(struct io *io, io_callback_func_t callback,\n\t\t\t\tvoid *user_data, io_destroy_func_t destroy)\n{\n\treturn io_set_handler(io, G_IO_HUP, callback, user_data, destroy);\n}"
        }
      },
      {
        "call_info": {
          "callee": "io_set_read_handler",
          "args": [
            "att->io",
            "can_read_data",
            "att",
            "NULL"
          ],
          "line": 1023
        },
        "resolved": true,
        "details": {
          "function_name": "io_set_read_handler",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "248-252",
          "snippet": "bool io_set_read_handler(struct io *io, io_callback_func_t callback,\n\t\t\t\tvoid *user_data, io_destroy_func_t destroy)\n{\n\treturn io_set_handler(io, G_IO_IN, callback, user_data, destroy);\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_set_read_handler(struct io *io, io_callback_func_t callback,\n\t\t\t\tvoid *user_data, io_destroy_func_t destroy)\n{\n\treturn io_set_handler(io, G_IO_IN, callback, user_data, destroy);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_new",
          "args": [],
          "line": 1021
        },
        "resolved": true,
        "details": {
          "function_name": "queue_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "56-66",
          "snippet": "struct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nstruct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_crypto_new",
          "args": [],
          "line": 1015
        },
        "resolved": true,
        "details": {
          "function_name": "bt_crypto_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/crypto.c",
          "lines": "140-168",
          "snippet": "struct bt_crypto *bt_crypto_new(void)\n{\n\tstruct bt_crypto *crypto;\n\n\tcrypto = new0(struct bt_crypto, 1);\n\n\tcrypto->ecb_aes = ecb_aes_setup();\n\tif (crypto->ecb_aes < 0) {\n\t\tfree(crypto);\n\t\treturn NULL;\n\t}\n\n\tcrypto->urandom = urandom_setup();\n\tif (crypto->urandom < 0) {\n\t\tclose(crypto->ecb_aes);\n\t\tfree(crypto);\n\t\treturn NULL;\n\t}\n\n\tcrypto->cmac_aes = cmac_aes_setup();\n\tif (crypto->cmac_aes < 0) {\n\t\tclose(crypto->urandom);\n\t\tclose(crypto->ecb_aes);\n\t\tfree(crypto);\n\t\treturn NULL;\n\t}\n\n\treturn bt_crypto_ref(crypto);\n}",
          "includes": [
            "#include <linux/if_alg.h>",
            "#include <linux/types.h>",
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/util.h\"",
            "#include <sys/socket.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <linux/if_alg.h>\n#include <linux/types.h>\n#include \"src/shared/crypto.h\"\n#include \"src/shared/util.h\"\n#include <sys/socket.h>\n#include <string.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <config.h>\n\nstruct bt_crypto *bt_crypto_new(void)\n{\n\tstruct bt_crypto *crypto;\n\n\tcrypto = new0(struct bt_crypto, 1);\n\n\tcrypto->ecb_aes = ecb_aes_setup();\n\tif (crypto->ecb_aes < 0) {\n\t\tfree(crypto);\n\t\treturn NULL;\n\t}\n\n\tcrypto->urandom = urandom_setup();\n\tif (crypto->urandom < 0) {\n\t\tclose(crypto->ecb_aes);\n\t\tfree(crypto);\n\t\treturn NULL;\n\t}\n\n\tcrypto->cmac_aes = cmac_aes_setup();\n\tif (crypto->cmac_aes < 0) {\n\t\tclose(crypto->urandom);\n\t\tclose(crypto->ecb_aes);\n\t\tfree(crypto);\n\t\treturn NULL;\n\t}\n\n\treturn bt_crypto_ref(crypto);\n}"
        }
      },
      {
        "call_info": {
          "callee": "io_new",
          "args": [
            "fd"
          ],
          "line": 1009
        },
        "resolved": true,
        "details": {
          "function_name": "io_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "71-90",
          "snippet": "struct io *io_new(int fd)\n{\n\tstruct io *io;\n\n\tif (fd < 0)\n\t\treturn NULL;\n\n\tio = g_try_new0(struct io, 1);\n\tif (!io)\n\t\treturn NULL;\n\n\tio->channel = g_io_channel_unix_new(fd);\n\n\tg_io_channel_set_encoding(io->channel, NULL, NULL);\n\tg_io_channel_set_buffered(io->channel, FALSE);\n\n\tg_io_channel_set_close_on_unref(io->channel, FALSE);\n\n\treturn io_ref(io);\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nstruct io *io_new(int fd)\n{\n\tstruct io *io;\n\n\tif (fd < 0)\n\t\treturn NULL;\n\n\tio = g_try_new0(struct io, 1);\n\tif (!io)\n\t\treturn NULL;\n\n\tio->channel = g_io_channel_unix_new(fd);\n\n\tg_io_channel_set_encoding(io->channel, NULL, NULL);\n\tg_io_channel_set_buffered(io->channel, FALSE);\n\n\tg_io_channel_set_close_on_unref(io->channel, FALSE);\n\n\treturn io_ref(io);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_att",
            "1"
          ],
          "line": 1006
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstruct bt_att *bt_att_new(int fd, bool ext_signed)\n{\n\tstruct bt_att *att;\n\n\tif (fd < 0)\n\t\treturn NULL;\n\n\tatt = new0(struct bt_att, 1);\n\tatt->fd = fd;\n\n\tatt->io = io_new(fd);\n\tif (!att->io)\n\t\tgoto fail;\n\n\t/* crypto is optional, if not available leave it NULL */\n\tif (!ext_signed)\n\t\tatt->crypto = bt_crypto_new();\n\n\tatt->req_queue = queue_new();\n\tatt->ind_queue = queue_new();\n\tatt->write_queue = queue_new();\n\tatt->notify_list = queue_new();\n\tatt->disconn_list = queue_new();\n\n\tif (!io_set_read_handler(att->io, can_read_data, att, NULL))\n\t\tgoto fail;\n\n\tif (!io_set_disconnect_handler(att->io, disconnect_cb, att, NULL))\n\t\tgoto fail;\n\n\tatt->io_on_l2cap = is_io_l2cap_based(att->fd);\n\tif (!att->io_on_l2cap)\n\t\tatt->io_sec_level = BT_ATT_SECURITY_LOW;\n\n\tif (bt_att_get_link_type(att) == BT_ATT_LINK_BREDR)\n\t\tatt->mtu = get_l2cap_mtu(att->fd);\n\telse\n\t\tatt->mtu = BT_ATT_DEFAULT_LE_MTU;\n\n\tif (att->mtu < BT_ATT_DEFAULT_LE_MTU)\n\t\tgoto fail;\n\n\tatt->buf = malloc(att->mtu);\n\tif (!att->buf)\n\t\tgoto fail;\n\n\treturn bt_att_ref(att);\n\nfail:\n\tbt_att_free(att);\n\n\treturn NULL;\n}"
  },
  {
    "function_name": "get_l2cap_mtu",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "987-997",
    "snippet": "static uint16_t get_l2cap_mtu(int fd)\n{\n\tsocklen_t len;\n\tstruct l2cap_options l2o;\n\n\tlen = sizeof(l2o);\n\tif (getsockopt(fd, SOL_L2CAP, L2CAP_OPTIONS, &l2o, &len) < 0)\n\t\treturn 0;\n\n\treturn l2o.omtu;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "getsockopt",
          "args": [
            "fd",
            "SOL_L2CAP",
            "L2CAP_OPTIONS",
            "&l2o",
            "&len"
          ],
          "line": 993
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic uint16_t get_l2cap_mtu(int fd)\n{\n\tsocklen_t len;\n\tstruct l2cap_options l2o;\n\n\tlen = sizeof(l2o);\n\tif (getsockopt(fd, SOL_L2CAP, L2CAP_OPTIONS, &l2o, &len) < 0)\n\t\treturn 0;\n\n\treturn l2o.omtu;\n}"
  },
  {
    "function_name": "bt_att_free",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "956-985",
    "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "att"
          ],
          "line": 984
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "note": "cyclic_reference_detected"
        }
      },
      {
        "call_info": {
          "callee": "att->debug_destroy",
          "args": [
            "att->debug_data"
          ],
          "line": 977
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "att->timeout_destroy",
          "args": [
            "att->timeout_data"
          ],
          "line": 974
        },
        "resolved": true,
        "details": {
          "function_name": "timeout_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/timeout-mainloop.c",
          "lines": "45-53",
          "snippet": "static void timeout_destroy(void *user_data)\n{\n\tstruct timeout_data *data = user_data;\n\n\tif (data->destroy)\n\t\tdata->destroy(data->user_data);\n\n\tfree(data);\n}",
          "includes": [
            "#include \"timeout.h\"",
            "#include \"util.h\"",
            "#include \"mainloop.h\"",
            "#include <stdlib.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"timeout.h\"\n#include \"util.h\"\n#include \"mainloop.h\"\n#include <stdlib.h>\n\nstatic void timeout_destroy(void *user_data)\n{\n\tstruct timeout_data *data = user_data;\n\n\tif (data->destroy)\n\t\tdata->destroy(data->user_data);\n\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "att->disconn_list",
            "NULL"
          ],
          "line": 971
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_crypto_unref",
          "args": [
            "att->crypto"
          ],
          "line": 965
        },
        "resolved": true,
        "details": {
          "function_name": "bt_crypto_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/crypto.c",
          "lines": "180-193",
          "snippet": "void bt_crypto_unref(struct bt_crypto *crypto)\n{\n\tif (!crypto)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&crypto->ref_count, 1))\n\t\treturn;\n\n\tclose(crypto->urandom);\n\tclose(crypto->ecb_aes);\n\tclose(crypto->cmac_aes);\n\n\tfree(crypto);\n}",
          "includes": [
            "#include <linux/if_alg.h>",
            "#include <linux/types.h>",
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/util.h\"",
            "#include <sys/socket.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <linux/if_alg.h>\n#include <linux/types.h>\n#include \"src/shared/crypto.h\"\n#include \"src/shared/util.h\"\n#include <sys/socket.h>\n#include <string.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <config.h>\n\nvoid bt_crypto_unref(struct bt_crypto *crypto)\n{\n\tif (!crypto)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&crypto->ref_count, 1))\n\t\treturn;\n\n\tclose(crypto->urandom);\n\tclose(crypto->ecb_aes);\n\tclose(crypto->cmac_aes);\n\n\tfree(crypto);\n}"
        }
      },
      {
        "call_info": {
          "callee": "io_destroy",
          "args": [
            "att->io"
          ],
          "line": 964
        },
        "resolved": true,
        "details": {
          "function_name": "io_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "111-135",
          "snippet": "void io_destroy(struct io *io)\n{\n\tif (!io)\n\t\treturn;\n\n\tif (io->read_watch) {\n\t\tg_source_remove(io->read_watch->id);\n\t\tio->read_watch = NULL;\n\t}\n\n\tif (io->write_watch) {\n\t\tg_source_remove(io->write_watch->id);\n\t\tio->write_watch = NULL;\n\t}\n\n\tif (io->disconnect_watch) {\n\t\tg_source_remove(io->disconnect_watch->id);\n\t\tio->disconnect_watch = NULL;\n\t}\n\n\tg_io_channel_unref(io->channel);\n\tio->channel = NULL;\n\n\tio_unref(io);\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nvoid io_destroy(struct io *io)\n{\n\tif (!io)\n\t\treturn;\n\n\tif (io->read_watch) {\n\t\tg_source_remove(io->read_watch->id);\n\t\tio->read_watch = NULL;\n\t}\n\n\tif (io->write_watch) {\n\t\tg_source_remove(io->write_watch->id);\n\t\tio->write_watch = NULL;\n\t}\n\n\tif (io->disconnect_watch) {\n\t\tg_source_remove(io->disconnect_watch->id);\n\t\tio->disconnect_watch = NULL;\n\t}\n\n\tg_io_channel_unref(io->channel);\n\tio->channel = NULL;\n\n\tio_unref(io);\n}"
        }
      },
      {
        "call_info": {
          "callee": "destroy_att_send_op",
          "args": [
            "att->pending_ind"
          ],
          "line": 962
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "200-212",
          "snippet": "static void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
  },
  {
    "function_name": "is_io_l2cap_based",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "931-954",
    "snippet": "static bool is_io_l2cap_based(int fd)\n{\n\tint domain;\n\tint proto;\n\tint err;\n\tsocklen_t len;\n\n\tdomain = 0;\n\tlen = sizeof(domain);\n\terr = getsockopt(fd, SOL_SOCKET, SO_DOMAIN, &domain, &len);\n\tif (err < 0)\n\t\treturn false;\n\n\tif (domain != AF_BLUETOOTH)\n\t\treturn false;\n\n\tproto = 0;\n\tlen = sizeof(proto);\n\terr = getsockopt(fd, SOL_SOCKET, SO_PROTOCOL, &proto, &len);\n\tif (err < 0)\n\t\treturn false;\n\n\treturn proto == BTPROTO_L2CAP;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "getsockopt",
          "args": [
            "fd",
            "SOL_SOCKET",
            "SO_PROTOCOL",
            "&proto",
            "&len"
          ],
          "line": 949
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getsockopt",
          "args": [
            "fd",
            "SOL_SOCKET",
            "SO_DOMAIN",
            "&domain",
            "&len"
          ],
          "line": 940
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool is_io_l2cap_based(int fd)\n{\n\tint domain;\n\tint proto;\n\tint err;\n\tsocklen_t len;\n\n\tdomain = 0;\n\tlen = sizeof(domain);\n\terr = getsockopt(fd, SOL_SOCKET, SO_DOMAIN, &domain, &len);\n\tif (err < 0)\n\t\treturn false;\n\n\tif (domain != AF_BLUETOOTH)\n\t\treturn false;\n\n\tproto = 0;\n\tlen = sizeof(proto);\n\terr = getsockopt(fd, SOL_SOCKET, SO_PROTOCOL, &proto, &len);\n\tif (err < 0)\n\t\treturn false;\n\n\treturn proto == BTPROTO_L2CAP;\n}"
  },
  {
    "function_name": "can_read_data",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "859-929",
    "snippet": "static bool can_read_data(struct io *io, void *user_data)\n{\n\tstruct bt_att *att = user_data;\n\tuint8_t opcode;\n\tuint8_t *pdu;\n\tssize_t bytes_read;\n\n\tbytes_read = read(att->fd, att->buf, att->mtu);\n\tif (bytes_read < 0)\n\t\treturn false;\n\n\tutil_hexdump('>', att->buf, bytes_read,\n\t\t\t\t\tatt->debug_callback, att->debug_data);\n\n\tif (bytes_read < ATT_MIN_PDU_LEN)\n\t\treturn true;\n\n\tpdu = att->buf;\n\topcode = pdu[0];\n\n\tbt_att_ref(att);\n\n\t/* Act on the received PDU based on the opcode type */\n\tswitch (get_op_type(opcode)) {\n\tcase ATT_OP_TYPE_RSP:\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\"ATT response received: 0x%02x\", opcode);\n\t\thandle_rsp(att, opcode, pdu + 1, bytes_read - 1);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CONF:\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\"ATT confirmation received: 0x%02x\", opcode);\n\t\thandle_conf(att, pdu + 1, bytes_read - 1);\n\t\tbreak;\n\tcase ATT_OP_TYPE_REQ:\n\t\t/*\n\t\t * If a request is currently pending, then the sequential\n\t\t * protocol was violated. Disconnect the bearer, which will\n\t\t * promptly notify the upper layer via disconnect handlers.\n\t\t */\n\t\tif (att->in_req) {\n\t\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Received request while another is \"\n\t\t\t\t\t\"pending: 0x%02x\", opcode);\n\t\t\tio_shutdown(att->io);\n\t\t\tbt_att_unref(att);\n\n\t\t\treturn false;\n\t\t}\n\n\t\tatt->in_req = true;\n\t\t/* fall through */\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_IND:\n\t\t/* fall through */\n\tdefault:\n\t\t/* For all other opcodes notify the upper layer of the PDU and\n\t\t * let them act on it.\n\t\t */\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"ATT PDU received: 0x%02x\", opcode);\n\t\thandle_notify(att, opcode, pdu + 1, bytes_read - 1);\n\t\tbreak;\n\t}\n\n\tbt_att_unref(att);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define ATT_MIN_PDU_LEN\t\t\t1  /* At least 1 byte for the opcode. */"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_unref",
          "args": [
            "att"
          ],
          "line": 926
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1063-1075",
          "snippet": "void bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nvoid bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "handle_notify",
          "args": [
            "att",
            "opcode",
            "pdu + 1",
            "bytes_read - 1"
          ],
          "line": 922
        },
        "resolved": true,
        "details": {
          "function_name": "handle_notify",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "813-857",
          "snippet": "static void handle_notify(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tconst struct queue_entry *entry;\n\tbool found;\n\n\tif ((opcode & ATT_OP_SIGNED_MASK) && !att->crypto) {\n\t\tif (!handle_signed(att, opcode, pdu, pdu_len))\n\t\t\treturn;\n\t\tpdu_len -= BT_ATT_SIGNATURE_LEN;\n\t}\n\n\tbt_att_ref(att);\n\n\tfound = false;\n\tentry = queue_get_entries(att->notify_list);\n\n\twhile (entry) {\n\t\tstruct att_notify *notify = entry->data;\n\n\t\tentry = entry->next;\n\n\t\tif (!opcode_match(notify->opcode, opcode))\n\t\t\tcontinue;\n\n\t\tfound = true;\n\n\t\tif (notify->callback)\n\t\t\tnotify->callback(opcode, pdu, pdu_len,\n\t\t\t\t\t\t\tnotify->user_data);\n\n\t\t/* callback could remove all entries from notify list */\n\t\tif (queue_isempty(att->notify_list))\n\t\t\tbreak;\n\t}\n\n\t/*\n\t * If this was not a command and no handler was registered for it,\n\t * respond with \"Not Supported\"\n\t */\n\tif (!found && get_op_type(opcode) != ATT_OP_TYPE_CMD)\n\t\trespond_not_supported(att, opcode);\n\n\tbt_att_unref(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define BT_ATT_SIGNATURE_LEN\t\t12",
            "#define ATT_OP_SIGNED_MASK\t\t0x80"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define BT_ATT_SIGNATURE_LEN\t\t12\n#define ATT_OP_SIGNED_MASK\t\t0x80\n\nstatic void handle_notify(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tconst struct queue_entry *entry;\n\tbool found;\n\n\tif ((opcode & ATT_OP_SIGNED_MASK) && !att->crypto) {\n\t\tif (!handle_signed(att, opcode, pdu, pdu_len))\n\t\t\treturn;\n\t\tpdu_len -= BT_ATT_SIGNATURE_LEN;\n\t}\n\n\tbt_att_ref(att);\n\n\tfound = false;\n\tentry = queue_get_entries(att->notify_list);\n\n\twhile (entry) {\n\t\tstruct att_notify *notify = entry->data;\n\n\t\tentry = entry->next;\n\n\t\tif (!opcode_match(notify->opcode, opcode))\n\t\t\tcontinue;\n\n\t\tfound = true;\n\n\t\tif (notify->callback)\n\t\t\tnotify->callback(opcode, pdu, pdu_len,\n\t\t\t\t\t\t\tnotify->user_data);\n\n\t\t/* callback could remove all entries from notify list */\n\t\tif (queue_isempty(att->notify_list))\n\t\t\tbreak;\n\t}\n\n\t/*\n\t * If this was not a command and no handler was registered for it,\n\t * respond with \"Not Supported\"\n\t */\n\tif (!found && get_op_type(opcode) != ATT_OP_TYPE_CMD)\n\t\trespond_not_supported(att, opcode);\n\n\tbt_att_unref(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "att->debug_callback",
            "att->debug_data",
            "\"ATT PDU received: 0x%02x\"",
            "opcode"
          ],
          "line": 920
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "io_shutdown",
          "args": [
            "att->io"
          ],
          "line": 903
        },
        "resolved": true,
        "details": {
          "function_name": "io_shutdown",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "286-293",
          "snippet": "bool io_shutdown(struct io *io)\n{\n\tif (!io || !io->channel)\n\t\treturn false;\n\n\treturn g_io_channel_shutdown(io->channel, TRUE, NULL)\n\t\t\t\t\t\t\t== G_IO_STATUS_NORMAL;\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_shutdown(struct io *io)\n{\n\tif (!io || !io->channel)\n\t\treturn false;\n\n\treturn g_io_channel_shutdown(io->channel, TRUE, NULL)\n\t\t\t\t\t\t\t== G_IO_STATUS_NORMAL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "handle_conf",
          "args": [
            "att",
            "pdu + 1",
            "bytes_read - 1"
          ],
          "line": 891
        },
        "resolved": true,
        "details": {
          "function_name": "handle_conf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "722-744",
          "snippet": "static void handle_conf(struct bt_att *att, uint8_t *pdu, ssize_t pdu_len)\n{\n\tstruct att_send_op *op = att->pending_ind;\n\n\t/*\n\t * Disconnect the bearer if the confirmation is unexpected or the PDU is\n\t * invalid.\n\t */\n\tif (!op || pdu_len) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\"Received unexpected/invalid ATT confirmation\");\n\t\tio_shutdown(att->io);\n\t\treturn;\n\t}\n\n\tif (op->callback)\n\t\top->callback(BT_ATT_OP_HANDLE_VAL_CONF, NULL, 0, op->user_data);\n\n\tdestroy_att_send_op(op);\n\tatt->pending_ind = NULL;\n\n\twakeup_writer(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void handle_conf(struct bt_att *att, uint8_t *pdu, ssize_t pdu_len)\n{\n\tstruct att_send_op *op = att->pending_ind;\n\n\t/*\n\t * Disconnect the bearer if the confirmation is unexpected or the PDU is\n\t * invalid.\n\t */\n\tif (!op || pdu_len) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\"Received unexpected/invalid ATT confirmation\");\n\t\tio_shutdown(att->io);\n\t\treturn;\n\t}\n\n\tif (op->callback)\n\t\top->callback(BT_ATT_OP_HANDLE_VAL_CONF, NULL, 0, op->user_data);\n\n\tdestroy_att_send_op(op);\n\tatt->pending_ind = NULL;\n\n\twakeup_writer(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "handle_rsp",
          "args": [
            "att",
            "opcode",
            "pdu + 1",
            "bytes_read - 1"
          ],
          "line": 886
        },
        "resolved": true,
        "details": {
          "function_name": "handle_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "661-720",
          "snippet": "static void handle_rsp(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tstruct att_send_op *op = att->pending_req;\n\tuint8_t req_opcode;\n\tuint8_t rsp_opcode;\n\tuint8_t *rsp_pdu = NULL;\n\tuint16_t rsp_pdu_len = 0;\n\n\t/*\n\t * If no request is pending, then the response is unexpected. Disconnect\n\t * the bearer.\n\t */\n\tif (!op) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Received unexpected ATT response\");\n\t\tio_shutdown(att->io);\n\t\treturn;\n\t}\n\n\t/*\n\t * If the received response doesn't match the pending request, or if\n\t * the request is malformed, end the current request with failure.\n\t */\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\t/* Return if error response cause a retry */\n\t\tif (handle_error_rsp(att, pdu, pdu_len, &req_opcode)) {\n\t\t\twakeup_writer(att);\n\t\t\treturn;\n\t\t}\n\t} else if (!(req_opcode = get_req_opcode(opcode)))\n\t\tgoto fail;\n\n\tif (req_opcode != op->opcode)\n\t\tgoto fail;\n\n\trsp_opcode = opcode;\n\n\tif (pdu_len > 0) {\n\t\trsp_pdu = pdu;\n\t\trsp_pdu_len = pdu_len;\n\t}\n\n\tgoto done;\n\nfail:\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\"Failed to handle response PDU; opcode: 0x%02x\", opcode);\n\n\trsp_opcode = BT_ATT_OP_ERROR_RSP;\n\ndone:\n\tif (op->callback)\n\t\top->callback(rsp_opcode, rsp_pdu, rsp_pdu_len, op->user_data);\n\n\tdestroy_att_send_op(op);\n\tatt->pending_req = NULL;\n\n\twakeup_writer(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void handle_rsp(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tstruct att_send_op *op = att->pending_req;\n\tuint8_t req_opcode;\n\tuint8_t rsp_opcode;\n\tuint8_t *rsp_pdu = NULL;\n\tuint16_t rsp_pdu_len = 0;\n\n\t/*\n\t * If no request is pending, then the response is unexpected. Disconnect\n\t * the bearer.\n\t */\n\tif (!op) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Received unexpected ATT response\");\n\t\tio_shutdown(att->io);\n\t\treturn;\n\t}\n\n\t/*\n\t * If the received response doesn't match the pending request, or if\n\t * the request is malformed, end the current request with failure.\n\t */\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\t/* Return if error response cause a retry */\n\t\tif (handle_error_rsp(att, pdu, pdu_len, &req_opcode)) {\n\t\t\twakeup_writer(att);\n\t\t\treturn;\n\t\t}\n\t} else if (!(req_opcode = get_req_opcode(opcode)))\n\t\tgoto fail;\n\n\tif (req_opcode != op->opcode)\n\t\tgoto fail;\n\n\trsp_opcode = opcode;\n\n\tif (pdu_len > 0) {\n\t\trsp_pdu = pdu;\n\t\trsp_pdu_len = pdu_len;\n\t}\n\n\tgoto done;\n\nfail:\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\"Failed to handle response PDU; opcode: 0x%02x\", opcode);\n\n\trsp_opcode = BT_ATT_OP_ERROR_RSP;\n\ndone:\n\tif (op->callback)\n\t\top->callback(rsp_opcode, rsp_pdu, rsp_pdu_len, op->user_data);\n\n\tdestroy_att_send_op(op);\n\tatt->pending_req = NULL;\n\n\twakeup_writer(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_op_type",
          "args": [
            "opcode"
          ],
          "line": 882
        },
        "resolved": true,
        "details": {
          "function_name": "get_op_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "143-156",
          "snippet": "static enum att_op_type get_op_type(uint8_t opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_opcode_type_table[i].opcode; i++) {\n\t\tif (att_opcode_type_table[i].opcode == opcode)\n\t\t\treturn att_opcode_type_table[i].type;\n\t}\n\n\tif (opcode & ATT_OP_CMD_MASK)\n\t\treturn ATT_OP_TYPE_CMD;\n\n\treturn ATT_OP_TYPE_UNKNOWN;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATT_OP_CMD_MASK\t\t\t0x40"
          ],
          "globals_used": [
            "static const struct {\n\tuint8_t opcode;\n\tenum att_op_type type;\n} att_opcode_type_table[] = {\n\t{ BT_ATT_OP_ERROR_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_MTU_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_INFO_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BLOB_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_MULT_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_WRITE_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_CMD,\t\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_SIGNED_WRITE_CMD,\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_PREP_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_EXEC_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_HANDLE_VAL_NOT,\t\tATT_OP_TYPE_NOT },\n\t{ BT_ATT_OP_HANDLE_VAL_IND,\t\tATT_OP_TYPE_IND },\n\t{ BT_ATT_OP_HANDLE_VAL_CONF,\t\tATT_OP_TYPE_CONF },\n\t{ }\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define ATT_OP_CMD_MASK\t\t\t0x40\n\nstatic const struct {\n\tuint8_t opcode;\n\tenum att_op_type type;\n} att_opcode_type_table[] = {\n\t{ BT_ATT_OP_ERROR_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_MTU_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_INFO_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BLOB_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_MULT_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_WRITE_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_CMD,\t\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_SIGNED_WRITE_CMD,\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_PREP_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_EXEC_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_HANDLE_VAL_NOT,\t\tATT_OP_TYPE_NOT },\n\t{ BT_ATT_OP_HANDLE_VAL_IND,\t\tATT_OP_TYPE_IND },\n\t{ BT_ATT_OP_HANDLE_VAL_CONF,\t\tATT_OP_TYPE_CONF },\n\t{ }\n};\n\nstatic enum att_op_type get_op_type(uint8_t opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_opcode_type_table[i].opcode; i++) {\n\t\tif (att_opcode_type_table[i].opcode == opcode)\n\t\t\treturn att_opcode_type_table[i].type;\n\t}\n\n\tif (opcode & ATT_OP_CMD_MASK)\n\t\treturn ATT_OP_TYPE_CMD;\n\n\treturn ATT_OP_TYPE_UNKNOWN;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_ref",
          "args": [
            "att"
          ],
          "line": 879
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1053-1061",
          "snippet": "struct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstruct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_hexdump",
          "args": [
            "'>'",
            "att->buf",
            "bytes_read",
            "att->debug_callback",
            "att->debug_data"
          ],
          "line": 870
        },
        "resolved": true,
        "details": {
          "function_name": "util_hexdump",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "73-113",
          "snippet": "void util_hexdump(const char dir, const unsigned char *buf, size_t len,\n\t\t\t\tutil_debug_func_t function, void *user_data)\n{\n\tstatic const char hexdigits[] = \"0123456789abcdef\";\n\tchar str[68];\n\tsize_t i;\n\n\tif (!function || !len)\n\t\treturn;\n\n\tstr[0] = dir;\n\n\tfor (i = 0; i < len; i++) {\n\t\tstr[((i % 16) * 3) + 1] = ' ';\n\t\tstr[((i % 16) * 3) + 2] = hexdigits[buf[i] >> 4];\n\t\tstr[((i % 16) * 3) + 3] = hexdigits[buf[i] & 0xf];\n\t\tstr[(i % 16) + 51] = isprint(buf[i]) ? buf[i] : '.';\n\n\t\tif ((i + 1) % 16 == 0) {\n\t\t\tstr[49] = ' ';\n\t\t\tstr[50] = ' ';\n\t\t\tstr[67] = '\\0';\n\t\t\tfunction(str, user_data);\n\t\t\tstr[0] = ' ';\n\t\t}\n\t}\n\n\tif (i % 16 > 0) {\n\t\tsize_t j;\n\t\tfor (j = (i % 16); j < 16; j++) {\n\t\t\tstr[(j * 3) + 1] = ' ';\n\t\t\tstr[(j * 3) + 2] = ' ';\n\t\t\tstr[(j * 3) + 3] = ' ';\n\t\t\tstr[j + 51] = ' ';\n\t\t}\n\t\tstr[49] = ' ';\n\t\tstr[50] = ' ';\n\t\tstr[67] = '\\0';\n\t\tfunction(str, user_data);\n\t}\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_hexdump(const char dir, const unsigned char *buf, size_t len,\n\t\t\t\tutil_debug_func_t function, void *user_data)\n{\n\tstatic const char hexdigits[] = \"0123456789abcdef\";\n\tchar str[68];\n\tsize_t i;\n\n\tif (!function || !len)\n\t\treturn;\n\n\tstr[0] = dir;\n\n\tfor (i = 0; i < len; i++) {\n\t\tstr[((i % 16) * 3) + 1] = ' ';\n\t\tstr[((i % 16) * 3) + 2] = hexdigits[buf[i] >> 4];\n\t\tstr[((i % 16) * 3) + 3] = hexdigits[buf[i] & 0xf];\n\t\tstr[(i % 16) + 51] = isprint(buf[i]) ? buf[i] : '.';\n\n\t\tif ((i + 1) % 16 == 0) {\n\t\t\tstr[49] = ' ';\n\t\t\tstr[50] = ' ';\n\t\t\tstr[67] = '\\0';\n\t\t\tfunction(str, user_data);\n\t\t\tstr[0] = ' ';\n\t\t}\n\t}\n\n\tif (i % 16 > 0) {\n\t\tsize_t j;\n\t\tfor (j = (i % 16); j < 16; j++) {\n\t\t\tstr[(j * 3) + 1] = ' ';\n\t\t\tstr[(j * 3) + 2] = ' ';\n\t\t\tstr[(j * 3) + 3] = ' ';\n\t\t\tstr[j + 51] = ' ';\n\t\t}\n\t\tstr[49] = ' ';\n\t\tstr[50] = ' ';\n\t\tstr[67] = '\\0';\n\t\tfunction(str, user_data);\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "read",
          "args": [
            "att->fd",
            "att->buf",
            "att->mtu"
          ],
          "line": 866
        },
        "resolved": true,
        "details": {
          "function_name": "notify_client_ready",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1221-1250",
          "snippet": "static void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define ATT_MIN_PDU_LEN\t\t\t1  /* At least 1 byte for the opcode. */\n\nstatic bool can_read_data(struct io *io, void *user_data)\n{\n\tstruct bt_att *att = user_data;\n\tuint8_t opcode;\n\tuint8_t *pdu;\n\tssize_t bytes_read;\n\n\tbytes_read = read(att->fd, att->buf, att->mtu);\n\tif (bytes_read < 0)\n\t\treturn false;\n\n\tutil_hexdump('>', att->buf, bytes_read,\n\t\t\t\t\tatt->debug_callback, att->debug_data);\n\n\tif (bytes_read < ATT_MIN_PDU_LEN)\n\t\treturn true;\n\n\tpdu = att->buf;\n\topcode = pdu[0];\n\n\tbt_att_ref(att);\n\n\t/* Act on the received PDU based on the opcode type */\n\tswitch (get_op_type(opcode)) {\n\tcase ATT_OP_TYPE_RSP:\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\"ATT response received: 0x%02x\", opcode);\n\t\thandle_rsp(att, opcode, pdu + 1, bytes_read - 1);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CONF:\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\"ATT confirmation received: 0x%02x\", opcode);\n\t\thandle_conf(att, pdu + 1, bytes_read - 1);\n\t\tbreak;\n\tcase ATT_OP_TYPE_REQ:\n\t\t/*\n\t\t * If a request is currently pending, then the sequential\n\t\t * protocol was violated. Disconnect the bearer, which will\n\t\t * promptly notify the upper layer via disconnect handlers.\n\t\t */\n\t\tif (att->in_req) {\n\t\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Received request while another is \"\n\t\t\t\t\t\"pending: 0x%02x\", opcode);\n\t\t\tio_shutdown(att->io);\n\t\t\tbt_att_unref(att);\n\n\t\t\treturn false;\n\t\t}\n\n\t\tatt->in_req = true;\n\t\t/* fall through */\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_IND:\n\t\t/* fall through */\n\tdefault:\n\t\t/* For all other opcodes notify the upper layer of the PDU and\n\t\t * let them act on it.\n\t\t */\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"ATT PDU received: 0x%02x\", opcode);\n\t\thandle_notify(att, opcode, pdu + 1, bytes_read - 1);\n\t\tbreak;\n\t}\n\n\tbt_att_unref(att);\n\n\treturn true;\n}"
  },
  {
    "function_name": "handle_notify",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "813-857",
    "snippet": "static void handle_notify(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tconst struct queue_entry *entry;\n\tbool found;\n\n\tif ((opcode & ATT_OP_SIGNED_MASK) && !att->crypto) {\n\t\tif (!handle_signed(att, opcode, pdu, pdu_len))\n\t\t\treturn;\n\t\tpdu_len -= BT_ATT_SIGNATURE_LEN;\n\t}\n\n\tbt_att_ref(att);\n\n\tfound = false;\n\tentry = queue_get_entries(att->notify_list);\n\n\twhile (entry) {\n\t\tstruct att_notify *notify = entry->data;\n\n\t\tentry = entry->next;\n\n\t\tif (!opcode_match(notify->opcode, opcode))\n\t\t\tcontinue;\n\n\t\tfound = true;\n\n\t\tif (notify->callback)\n\t\t\tnotify->callback(opcode, pdu, pdu_len,\n\t\t\t\t\t\t\tnotify->user_data);\n\n\t\t/* callback could remove all entries from notify list */\n\t\tif (queue_isempty(att->notify_list))\n\t\t\tbreak;\n\t}\n\n\t/*\n\t * If this was not a command and no handler was registered for it,\n\t * respond with \"Not Supported\"\n\t */\n\tif (!found && get_op_type(opcode) != ATT_OP_TYPE_CMD)\n\t\trespond_not_supported(att, opcode);\n\n\tbt_att_unref(att);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define BT_ATT_SIGNATURE_LEN\t\t12",
      "#define ATT_OP_SIGNED_MASK\t\t0x80"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_unref",
          "args": [
            "att"
          ],
          "line": 856
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1063-1075",
          "snippet": "void bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nvoid bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "respond_not_supported",
          "args": [
            "att",
            "opcode"
          ],
          "line": 854
        },
        "resolved": true,
        "details": {
          "function_name": "respond_not_supported",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "764-774",
          "snippet": "static void respond_not_supported(struct bt_att *att, uint8_t opcode)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\n\tpdu.opcode = opcode;\n\tpdu.handle = 0x0000;\n\tpdu.ecode = BT_ATT_ERROR_REQUEST_NOT_SUPPORTED;\n\n\tbt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu), NULL, NULL,\n\t\t\t\t\t\t\t\t\tNULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void respond_not_supported(struct bt_att *att, uint8_t opcode)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\n\tpdu.opcode = opcode;\n\tpdu.handle = 0x0000;\n\tpdu.ecode = BT_ATT_ERROR_REQUEST_NOT_SUPPORTED;\n\n\tbt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu), NULL, NULL,\n\t\t\t\t\t\t\t\t\tNULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_op_type",
          "args": [
            "opcode"
          ],
          "line": 853
        },
        "resolved": true,
        "details": {
          "function_name": "get_op_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "143-156",
          "snippet": "static enum att_op_type get_op_type(uint8_t opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_opcode_type_table[i].opcode; i++) {\n\t\tif (att_opcode_type_table[i].opcode == opcode)\n\t\t\treturn att_opcode_type_table[i].type;\n\t}\n\n\tif (opcode & ATT_OP_CMD_MASK)\n\t\treturn ATT_OP_TYPE_CMD;\n\n\treturn ATT_OP_TYPE_UNKNOWN;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATT_OP_CMD_MASK\t\t\t0x40"
          ],
          "globals_used": [
            "static const struct {\n\tuint8_t opcode;\n\tenum att_op_type type;\n} att_opcode_type_table[] = {\n\t{ BT_ATT_OP_ERROR_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_MTU_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_INFO_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BLOB_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_MULT_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_WRITE_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_CMD,\t\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_SIGNED_WRITE_CMD,\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_PREP_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_EXEC_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_HANDLE_VAL_NOT,\t\tATT_OP_TYPE_NOT },\n\t{ BT_ATT_OP_HANDLE_VAL_IND,\t\tATT_OP_TYPE_IND },\n\t{ BT_ATT_OP_HANDLE_VAL_CONF,\t\tATT_OP_TYPE_CONF },\n\t{ }\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define ATT_OP_CMD_MASK\t\t\t0x40\n\nstatic const struct {\n\tuint8_t opcode;\n\tenum att_op_type type;\n} att_opcode_type_table[] = {\n\t{ BT_ATT_OP_ERROR_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_MTU_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_INFO_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BLOB_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_MULT_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_WRITE_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_CMD,\t\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_SIGNED_WRITE_CMD,\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_PREP_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_EXEC_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_HANDLE_VAL_NOT,\t\tATT_OP_TYPE_NOT },\n\t{ BT_ATT_OP_HANDLE_VAL_IND,\t\tATT_OP_TYPE_IND },\n\t{ BT_ATT_OP_HANDLE_VAL_CONF,\t\tATT_OP_TYPE_CONF },\n\t{ }\n};\n\nstatic enum att_op_type get_op_type(uint8_t opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_opcode_type_table[i].opcode; i++) {\n\t\tif (att_opcode_type_table[i].opcode == opcode)\n\t\t\treturn att_opcode_type_table[i].type;\n\t}\n\n\tif (opcode & ATT_OP_CMD_MASK)\n\t\treturn ATT_OP_TYPE_CMD;\n\n\treturn ATT_OP_TYPE_UNKNOWN;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_isempty",
          "args": [
            "att->notify_list"
          ],
          "line": 845
        },
        "resolved": true,
        "details": {
          "function_name": "queue_isempty",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "380-386",
          "snippet": "bool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "notify->callback",
          "args": [
            "opcode",
            "pdu",
            "pdu_len",
            "notify->user_data"
          ],
          "line": 841
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "opcode_match",
          "args": [
            "notify->opcode",
            "opcode"
          ],
          "line": 835
        },
        "resolved": true,
        "details": {
          "function_name": "opcode_match",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "753-762",
          "snippet": "static bool opcode_match(uint8_t opcode, uint8_t test_opcode)\n{\n\tenum att_op_type op_type = get_op_type(test_opcode);\n\n\tif (opcode == BT_ATT_ALL_REQUESTS && (op_type == ATT_OP_TYPE_REQ ||\n\t\t\t\t\t\top_type == ATT_OP_TYPE_CMD))\n\t\treturn true;\n\n\treturn opcode == test_opcode;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool opcode_match(uint8_t opcode, uint8_t test_opcode)\n{\n\tenum att_op_type op_type = get_op_type(test_opcode);\n\n\tif (opcode == BT_ATT_ALL_REQUESTS && (op_type == ATT_OP_TYPE_REQ ||\n\t\t\t\t\t\top_type == ATT_OP_TYPE_CMD))\n\t\treturn true;\n\n\treturn opcode == test_opcode;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_get_entries",
          "args": [
            "att->notify_list"
          ],
          "line": 828
        },
        "resolved": true,
        "details": {
          "function_name": "queue_get_entries",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "364-370",
          "snippet": "const struct queue_entry *queue_get_entries(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn NULL;\n\n\treturn queue->head;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nconst struct queue_entry *queue_get_entries(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn NULL;\n\n\treturn queue->head;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_ref",
          "args": [
            "att"
          ],
          "line": 825
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1053-1061",
          "snippet": "struct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstruct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}"
        }
      },
      {
        "call_info": {
          "callee": "handle_signed",
          "args": [
            "att",
            "opcode",
            "pdu",
            "pdu_len"
          ],
          "line": 820
        },
        "resolved": true,
        "details": {
          "function_name": "handle_signed",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "776-811",
          "snippet": "static bool handle_signed(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tuint8_t *signature;\n\tuint32_t sign_cnt;\n\tstruct sign_info *sign;\n\n\t/* Check if there is enough data for a signature */\n\tif (pdu_len < 2 + BT_ATT_SIGNATURE_LEN)\n\t\tgoto fail;\n\n\tsign = att->remote_sign;\n\tif (!sign)\n\t\tgoto fail;\n\n\tsignature = pdu + (pdu_len - BT_ATT_SIGNATURE_LEN);\n\tsign_cnt = get_le32(signature);\n\n\t/* Validate counter */\n\tif (!sign->counter(&sign_cnt, sign->user_data))\n\t\tgoto fail;\n\n\t/* Generate signature and verify it */\n\tif (!bt_crypto_sign_att(att->crypto, sign->key, pdu,\n\t\t\t\tpdu_len - BT_ATT_SIGNATURE_LEN, sign_cnt,\n\t\t\t\tsignature))\n\t\tgoto fail;\n\n\treturn true;\n\nfail:\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\"ATT failed to verify signature: 0x%02x\", opcode);\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define BT_ATT_SIGNATURE_LEN\t\t12"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define BT_ATT_SIGNATURE_LEN\t\t12\n\nstatic bool handle_signed(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tuint8_t *signature;\n\tuint32_t sign_cnt;\n\tstruct sign_info *sign;\n\n\t/* Check if there is enough data for a signature */\n\tif (pdu_len < 2 + BT_ATT_SIGNATURE_LEN)\n\t\tgoto fail;\n\n\tsign = att->remote_sign;\n\tif (!sign)\n\t\tgoto fail;\n\n\tsignature = pdu + (pdu_len - BT_ATT_SIGNATURE_LEN);\n\tsign_cnt = get_le32(signature);\n\n\t/* Validate counter */\n\tif (!sign->counter(&sign_cnt, sign->user_data))\n\t\tgoto fail;\n\n\t/* Generate signature and verify it */\n\tif (!bt_crypto_sign_att(att->crypto, sign->key, pdu,\n\t\t\t\tpdu_len - BT_ATT_SIGNATURE_LEN, sign_cnt,\n\t\t\t\tsignature))\n\t\tgoto fail;\n\n\treturn true;\n\nfail:\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\"ATT failed to verify signature: 0x%02x\", opcode);\n\n\treturn false;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define BT_ATT_SIGNATURE_LEN\t\t12\n#define ATT_OP_SIGNED_MASK\t\t0x80\n\nstatic void handle_notify(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tconst struct queue_entry *entry;\n\tbool found;\n\n\tif ((opcode & ATT_OP_SIGNED_MASK) && !att->crypto) {\n\t\tif (!handle_signed(att, opcode, pdu, pdu_len))\n\t\t\treturn;\n\t\tpdu_len -= BT_ATT_SIGNATURE_LEN;\n\t}\n\n\tbt_att_ref(att);\n\n\tfound = false;\n\tentry = queue_get_entries(att->notify_list);\n\n\twhile (entry) {\n\t\tstruct att_notify *notify = entry->data;\n\n\t\tentry = entry->next;\n\n\t\tif (!opcode_match(notify->opcode, opcode))\n\t\t\tcontinue;\n\n\t\tfound = true;\n\n\t\tif (notify->callback)\n\t\t\tnotify->callback(opcode, pdu, pdu_len,\n\t\t\t\t\t\t\tnotify->user_data);\n\n\t\t/* callback could remove all entries from notify list */\n\t\tif (queue_isempty(att->notify_list))\n\t\t\tbreak;\n\t}\n\n\t/*\n\t * If this was not a command and no handler was registered for it,\n\t * respond with \"Not Supported\"\n\t */\n\tif (!found && get_op_type(opcode) != ATT_OP_TYPE_CMD)\n\t\trespond_not_supported(att, opcode);\n\n\tbt_att_unref(att);\n}"
  },
  {
    "function_name": "handle_signed",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "776-811",
    "snippet": "static bool handle_signed(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tuint8_t *signature;\n\tuint32_t sign_cnt;\n\tstruct sign_info *sign;\n\n\t/* Check if there is enough data for a signature */\n\tif (pdu_len < 2 + BT_ATT_SIGNATURE_LEN)\n\t\tgoto fail;\n\n\tsign = att->remote_sign;\n\tif (!sign)\n\t\tgoto fail;\n\n\tsignature = pdu + (pdu_len - BT_ATT_SIGNATURE_LEN);\n\tsign_cnt = get_le32(signature);\n\n\t/* Validate counter */\n\tif (!sign->counter(&sign_cnt, sign->user_data))\n\t\tgoto fail;\n\n\t/* Generate signature and verify it */\n\tif (!bt_crypto_sign_att(att->crypto, sign->key, pdu,\n\t\t\t\tpdu_len - BT_ATT_SIGNATURE_LEN, sign_cnt,\n\t\t\t\tsignature))\n\t\tgoto fail;\n\n\treturn true;\n\nfail:\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\"ATT failed to verify signature: 0x%02x\", opcode);\n\n\treturn false;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define BT_ATT_SIGNATURE_LEN\t\t12"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "att->debug_callback",
            "att->debug_data",
            "\"ATT failed to verify signature: 0x%02x\"",
            "opcode"
          ],
          "line": 807
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_crypto_sign_att",
          "args": [
            "att->crypto",
            "sign->key",
            "pdu",
            "pdu_len - BT_ATT_SIGNATURE_LEN",
            "sign_cnt",
            "signature"
          ],
          "line": 799
        },
        "resolved": true,
        "details": {
          "function_name": "bt_crypto_sign_att",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/crypto.c",
          "lines": "266-325",
          "snippet": "bool bt_crypto_sign_att(struct bt_crypto *crypto, const uint8_t key[16],\n\t\t\t\tconst uint8_t *m, uint16_t m_len,\n\t\t\t\tuint32_t sign_cnt, uint8_t signature[12])\n{\n\tint fd;\n\tint len;\n\tuint8_t tmp[16], out[16];\n\tuint16_t msg_len = m_len + sizeof(uint32_t);\n\tuint8_t msg[msg_len];\n\tuint8_t msg_s[msg_len];\n\n\tif (!crypto)\n\t\treturn false;\n\n\tmemset(msg, 0, msg_len);\n\tmemcpy(msg, m, m_len);\n\n\t/* Add sign_counter to the message */\n\tput_le32(sign_cnt, msg + m_len);\n\n\t/* The most significant octet of key corresponds to key[0] */\n\tswap_buf(key, tmp, 16);\n\n\tfd = alg_new(crypto->cmac_aes, tmp, 16);\n\tif (fd < 0)\n\t\treturn false;\n\n\t/* Swap msg before signing */\n\tswap_buf(msg, msg_s, msg_len);\n\n\tlen = send(fd, msg_s, msg_len, 0);\n\tif (len < 0) {\n\t\tclose(fd);\n\t\treturn false;\n\t}\n\n\tlen = read(fd, out, 16);\n\tif (len < 0) {\n\t\tclose(fd);\n\t\treturn false;\n\t}\n\n\tclose(fd);\n\n\t/*\n\t * As to BT spec. 4.1 Vol[3], Part C, chapter 10.4.1 sign counter should\n\t * be placed in the signature\n\t */\n\tput_be32(sign_cnt, out + 8);\n\n\t/*\n\t * The most significant octet of hash corresponds to out[0]  - swap it.\n\t * Then truncate in most significant bit first order to a length of\n\t * 12 octets\n\t */\n\tswap_buf(out, tmp, 16);\n\tmemcpy(signature, tmp + 4, 12);\n\n\treturn true;\n}",
          "includes": [
            "#include <linux/if_alg.h>",
            "#include <linux/types.h>",
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/util.h\"",
            "#include <sys/socket.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <linux/if_alg.h>\n#include <linux/types.h>\n#include \"src/shared/crypto.h\"\n#include \"src/shared/util.h\"\n#include <sys/socket.h>\n#include <string.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <config.h>\n\nbool bt_crypto_sign_att(struct bt_crypto *crypto, const uint8_t key[16],\n\t\t\t\tconst uint8_t *m, uint16_t m_len,\n\t\t\t\tuint32_t sign_cnt, uint8_t signature[12])\n{\n\tint fd;\n\tint len;\n\tuint8_t tmp[16], out[16];\n\tuint16_t msg_len = m_len + sizeof(uint32_t);\n\tuint8_t msg[msg_len];\n\tuint8_t msg_s[msg_len];\n\n\tif (!crypto)\n\t\treturn false;\n\n\tmemset(msg, 0, msg_len);\n\tmemcpy(msg, m, m_len);\n\n\t/* Add sign_counter to the message */\n\tput_le32(sign_cnt, msg + m_len);\n\n\t/* The most significant octet of key corresponds to key[0] */\n\tswap_buf(key, tmp, 16);\n\n\tfd = alg_new(crypto->cmac_aes, tmp, 16);\n\tif (fd < 0)\n\t\treturn false;\n\n\t/* Swap msg before signing */\n\tswap_buf(msg, msg_s, msg_len);\n\n\tlen = send(fd, msg_s, msg_len, 0);\n\tif (len < 0) {\n\t\tclose(fd);\n\t\treturn false;\n\t}\n\n\tlen = read(fd, out, 16);\n\tif (len < 0) {\n\t\tclose(fd);\n\t\treturn false;\n\t}\n\n\tclose(fd);\n\n\t/*\n\t * As to BT spec. 4.1 Vol[3], Part C, chapter 10.4.1 sign counter should\n\t * be placed in the signature\n\t */\n\tput_be32(sign_cnt, out + 8);\n\n\t/*\n\t * The most significant octet of hash corresponds to out[0]  - swap it.\n\t * Then truncate in most significant bit first order to a length of\n\t * 12 octets\n\t */\n\tswap_buf(out, tmp, 16);\n\tmemcpy(signature, tmp + 4, 12);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "sign->counter",
          "args": [
            "&sign_cnt",
            "sign->user_data"
          ],
          "line": 795
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_le32",
          "args": [
            "signature"
          ],
          "line": 792
        },
        "resolved": true,
        "details": {
          "function_name": "get_le32",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "139-142",
          "snippet": "static inline uint32_t get_le32(const void *ptr)\n{\n\treturn le32_to_cpu(get_unaligned((const uint32_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint32_t get_le32(const void *ptr)\n{\n\treturn le32_to_cpu(get_unaligned((const uint32_t *) ptr));\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define BT_ATT_SIGNATURE_LEN\t\t12\n\nstatic bool handle_signed(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tuint8_t *signature;\n\tuint32_t sign_cnt;\n\tstruct sign_info *sign;\n\n\t/* Check if there is enough data for a signature */\n\tif (pdu_len < 2 + BT_ATT_SIGNATURE_LEN)\n\t\tgoto fail;\n\n\tsign = att->remote_sign;\n\tif (!sign)\n\t\tgoto fail;\n\n\tsignature = pdu + (pdu_len - BT_ATT_SIGNATURE_LEN);\n\tsign_cnt = get_le32(signature);\n\n\t/* Validate counter */\n\tif (!sign->counter(&sign_cnt, sign->user_data))\n\t\tgoto fail;\n\n\t/* Generate signature and verify it */\n\tif (!bt_crypto_sign_att(att->crypto, sign->key, pdu,\n\t\t\t\tpdu_len - BT_ATT_SIGNATURE_LEN, sign_cnt,\n\t\t\t\tsignature))\n\t\tgoto fail;\n\n\treturn true;\n\nfail:\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\"ATT failed to verify signature: 0x%02x\", opcode);\n\n\treturn false;\n}"
  },
  {
    "function_name": "respond_not_supported",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "764-774",
    "snippet": "static void respond_not_supported(struct bt_att *att, uint8_t opcode)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\n\tpdu.opcode = opcode;\n\tpdu.handle = 0x0000;\n\tpdu.ecode = BT_ATT_ERROR_REQUEST_NOT_SUPPORTED;\n\n\tbt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu), NULL, NULL,\n\t\t\t\t\t\t\t\t\tNULL);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "att",
            "BT_ATT_OP_ERROR_RSP",
            "&pdu",
            "sizeof(pdu)",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 772
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void respond_not_supported(struct bt_att *att, uint8_t opcode)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\n\tpdu.opcode = opcode;\n\tpdu.handle = 0x0000;\n\tpdu.ecode = BT_ATT_ERROR_REQUEST_NOT_SUPPORTED;\n\n\tbt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu), NULL, NULL,\n\t\t\t\t\t\t\t\t\tNULL);\n}"
  },
  {
    "function_name": "opcode_match",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "753-762",
    "snippet": "static bool opcode_match(uint8_t opcode, uint8_t test_opcode)\n{\n\tenum att_op_type op_type = get_op_type(test_opcode);\n\n\tif (opcode == BT_ATT_ALL_REQUESTS && (op_type == ATT_OP_TYPE_REQ ||\n\t\t\t\t\t\top_type == ATT_OP_TYPE_CMD))\n\t\treturn true;\n\n\treturn opcode == test_opcode;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "get_op_type",
          "args": [
            "test_opcode"
          ],
          "line": 755
        },
        "resolved": true,
        "details": {
          "function_name": "get_op_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "143-156",
          "snippet": "static enum att_op_type get_op_type(uint8_t opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_opcode_type_table[i].opcode; i++) {\n\t\tif (att_opcode_type_table[i].opcode == opcode)\n\t\t\treturn att_opcode_type_table[i].type;\n\t}\n\n\tif (opcode & ATT_OP_CMD_MASK)\n\t\treturn ATT_OP_TYPE_CMD;\n\n\treturn ATT_OP_TYPE_UNKNOWN;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATT_OP_CMD_MASK\t\t\t0x40"
          ],
          "globals_used": [
            "static const struct {\n\tuint8_t opcode;\n\tenum att_op_type type;\n} att_opcode_type_table[] = {\n\t{ BT_ATT_OP_ERROR_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_MTU_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_INFO_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BLOB_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_MULT_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_WRITE_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_CMD,\t\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_SIGNED_WRITE_CMD,\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_PREP_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_EXEC_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_HANDLE_VAL_NOT,\t\tATT_OP_TYPE_NOT },\n\t{ BT_ATT_OP_HANDLE_VAL_IND,\t\tATT_OP_TYPE_IND },\n\t{ BT_ATT_OP_HANDLE_VAL_CONF,\t\tATT_OP_TYPE_CONF },\n\t{ }\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define ATT_OP_CMD_MASK\t\t\t0x40\n\nstatic const struct {\n\tuint8_t opcode;\n\tenum att_op_type type;\n} att_opcode_type_table[] = {\n\t{ BT_ATT_OP_ERROR_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_MTU_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_INFO_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BLOB_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_MULT_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_WRITE_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_CMD,\t\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_SIGNED_WRITE_CMD,\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_PREP_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_EXEC_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_HANDLE_VAL_NOT,\t\tATT_OP_TYPE_NOT },\n\t{ BT_ATT_OP_HANDLE_VAL_IND,\t\tATT_OP_TYPE_IND },\n\t{ BT_ATT_OP_HANDLE_VAL_CONF,\t\tATT_OP_TYPE_CONF },\n\t{ }\n};\n\nstatic enum att_op_type get_op_type(uint8_t opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_opcode_type_table[i].opcode; i++) {\n\t\tif (att_opcode_type_table[i].opcode == opcode)\n\t\t\treturn att_opcode_type_table[i].type;\n\t}\n\n\tif (opcode & ATT_OP_CMD_MASK)\n\t\treturn ATT_OP_TYPE_CMD;\n\n\treturn ATT_OP_TYPE_UNKNOWN;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool opcode_match(uint8_t opcode, uint8_t test_opcode)\n{\n\tenum att_op_type op_type = get_op_type(test_opcode);\n\n\tif (opcode == BT_ATT_ALL_REQUESTS && (op_type == ATT_OP_TYPE_REQ ||\n\t\t\t\t\t\top_type == ATT_OP_TYPE_CMD))\n\t\treturn true;\n\n\treturn opcode == test_opcode;\n}"
  },
  {
    "function_name": "handle_conf",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "722-744",
    "snippet": "static void handle_conf(struct bt_att *att, uint8_t *pdu, ssize_t pdu_len)\n{\n\tstruct att_send_op *op = att->pending_ind;\n\n\t/*\n\t * Disconnect the bearer if the confirmation is unexpected or the PDU is\n\t * invalid.\n\t */\n\tif (!op || pdu_len) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\"Received unexpected/invalid ATT confirmation\");\n\t\tio_shutdown(att->io);\n\t\treturn;\n\t}\n\n\tif (op->callback)\n\t\top->callback(BT_ATT_OP_HANDLE_VAL_CONF, NULL, 0, op->user_data);\n\n\tdestroy_att_send_op(op);\n\tatt->pending_ind = NULL;\n\n\twakeup_writer(att);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "wakeup_writer",
          "args": [
            "att"
          ],
          "line": 743
        },
        "resolved": true,
        "details": {
          "function_name": "wakeup_writer",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "509-528",
          "snippet": "static void wakeup_writer(struct bt_att *att)\n{\n\tif (att->writer_active)\n\t\treturn;\n\n\t/* Set the write handler only if there is anything that can be sent\n\t * at all.\n\t */\n\tif (queue_isempty(att->write_queue)) {\n\t\tif ((att->pending_req || queue_isempty(att->req_queue)) &&\n\t\t\t(att->pending_ind || queue_isempty(att->ind_queue)))\n\t\t\treturn;\n\t}\n\n\tif (!io_set_write_handler(att->io, can_write_data, att,\n\t\t\t\t\t\t\twrite_watch_destroy))\n\t\treturn;\n\n\tatt->writer_active = true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void wakeup_writer(struct bt_att *att)\n{\n\tif (att->writer_active)\n\t\treturn;\n\n\t/* Set the write handler only if there is anything that can be sent\n\t * at all.\n\t */\n\tif (queue_isempty(att->write_queue)) {\n\t\tif ((att->pending_req || queue_isempty(att->req_queue)) &&\n\t\t\t(att->pending_ind || queue_isempty(att->ind_queue)))\n\t\t\treturn;\n\t}\n\n\tif (!io_set_write_handler(att->io, can_write_data, att,\n\t\t\t\t\t\t\twrite_watch_destroy))\n\t\treturn;\n\n\tatt->writer_active = true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "destroy_att_send_op",
          "args": [
            "op"
          ],
          "line": 740
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "200-212",
          "snippet": "static void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "BT_ATT_OP_HANDLE_VAL_CONF",
            "NULL",
            "0",
            "op->user_data"
          ],
          "line": 738
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "io_shutdown",
          "args": [
            "att->io"
          ],
          "line": 733
        },
        "resolved": true,
        "details": {
          "function_name": "io_shutdown",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "286-293",
          "snippet": "bool io_shutdown(struct io *io)\n{\n\tif (!io || !io->channel)\n\t\treturn false;\n\n\treturn g_io_channel_shutdown(io->channel, TRUE, NULL)\n\t\t\t\t\t\t\t== G_IO_STATUS_NORMAL;\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_shutdown(struct io *io)\n{\n\tif (!io || !io->channel)\n\t\treturn false;\n\n\treturn g_io_channel_shutdown(io->channel, TRUE, NULL)\n\t\t\t\t\t\t\t== G_IO_STATUS_NORMAL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "att->debug_callback",
            "att->debug_data",
            "\"Received unexpected/invalid ATT confirmation\""
          ],
          "line": 731
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void handle_conf(struct bt_att *att, uint8_t *pdu, ssize_t pdu_len)\n{\n\tstruct att_send_op *op = att->pending_ind;\n\n\t/*\n\t * Disconnect the bearer if the confirmation is unexpected or the PDU is\n\t * invalid.\n\t */\n\tif (!op || pdu_len) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\"Received unexpected/invalid ATT confirmation\");\n\t\tio_shutdown(att->io);\n\t\treturn;\n\t}\n\n\tif (op->callback)\n\t\top->callback(BT_ATT_OP_HANDLE_VAL_CONF, NULL, 0, op->user_data);\n\n\tdestroy_att_send_op(op);\n\tatt->pending_ind = NULL;\n\n\twakeup_writer(att);\n}"
  },
  {
    "function_name": "handle_rsp",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "661-720",
    "snippet": "static void handle_rsp(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tstruct att_send_op *op = att->pending_req;\n\tuint8_t req_opcode;\n\tuint8_t rsp_opcode;\n\tuint8_t *rsp_pdu = NULL;\n\tuint16_t rsp_pdu_len = 0;\n\n\t/*\n\t * If no request is pending, then the response is unexpected. Disconnect\n\t * the bearer.\n\t */\n\tif (!op) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Received unexpected ATT response\");\n\t\tio_shutdown(att->io);\n\t\treturn;\n\t}\n\n\t/*\n\t * If the received response doesn't match the pending request, or if\n\t * the request is malformed, end the current request with failure.\n\t */\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\t/* Return if error response cause a retry */\n\t\tif (handle_error_rsp(att, pdu, pdu_len, &req_opcode)) {\n\t\t\twakeup_writer(att);\n\t\t\treturn;\n\t\t}\n\t} else if (!(req_opcode = get_req_opcode(opcode)))\n\t\tgoto fail;\n\n\tif (req_opcode != op->opcode)\n\t\tgoto fail;\n\n\trsp_opcode = opcode;\n\n\tif (pdu_len > 0) {\n\t\trsp_pdu = pdu;\n\t\trsp_pdu_len = pdu_len;\n\t}\n\n\tgoto done;\n\nfail:\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\"Failed to handle response PDU; opcode: 0x%02x\", opcode);\n\n\trsp_opcode = BT_ATT_OP_ERROR_RSP;\n\ndone:\n\tif (op->callback)\n\t\top->callback(rsp_opcode, rsp_pdu, rsp_pdu_len, op->user_data);\n\n\tdestroy_att_send_op(op);\n\tatt->pending_req = NULL;\n\n\twakeup_writer(att);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "wakeup_writer",
          "args": [
            "att"
          ],
          "line": 719
        },
        "resolved": true,
        "details": {
          "function_name": "wakeup_writer",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "509-528",
          "snippet": "static void wakeup_writer(struct bt_att *att)\n{\n\tif (att->writer_active)\n\t\treturn;\n\n\t/* Set the write handler only if there is anything that can be sent\n\t * at all.\n\t */\n\tif (queue_isempty(att->write_queue)) {\n\t\tif ((att->pending_req || queue_isempty(att->req_queue)) &&\n\t\t\t(att->pending_ind || queue_isempty(att->ind_queue)))\n\t\t\treturn;\n\t}\n\n\tif (!io_set_write_handler(att->io, can_write_data, att,\n\t\t\t\t\t\t\twrite_watch_destroy))\n\t\treturn;\n\n\tatt->writer_active = true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void wakeup_writer(struct bt_att *att)\n{\n\tif (att->writer_active)\n\t\treturn;\n\n\t/* Set the write handler only if there is anything that can be sent\n\t * at all.\n\t */\n\tif (queue_isempty(att->write_queue)) {\n\t\tif ((att->pending_req || queue_isempty(att->req_queue)) &&\n\t\t\t(att->pending_ind || queue_isempty(att->ind_queue)))\n\t\t\treturn;\n\t}\n\n\tif (!io_set_write_handler(att->io, can_write_data, att,\n\t\t\t\t\t\t\twrite_watch_destroy))\n\t\treturn;\n\n\tatt->writer_active = true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "destroy_att_send_op",
          "args": [
            "op"
          ],
          "line": 716
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "200-212",
          "snippet": "static void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "rsp_opcode",
            "rsp_pdu",
            "rsp_pdu_len",
            "op->user_data"
          ],
          "line": 714
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "att->debug_callback",
            "att->debug_data",
            "\"Failed to handle response PDU; opcode: 0x%02x\"",
            "opcode"
          ],
          "line": 707
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_req_opcode",
          "args": [
            "opcode"
          ],
          "line": 691
        },
        "resolved": true,
        "details": {
          "function_name": "get_req_opcode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "176-186",
          "snippet": "static uint8_t get_req_opcode(uint8_t rsp_opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_req_rsp_mapping_table[i].rsp_opcode; i++) {\n\t\tif (att_req_rsp_mapping_table[i].rsp_opcode == rsp_opcode)\n\t\t\treturn att_req_rsp_mapping_table[i].req_opcode;\n\t}\n\n\treturn 0;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const struct {\n\tuint8_t req_opcode;\n\tuint8_t rsp_opcode;\n} att_req_rsp_mapping_table[] = {\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tBT_ATT_OP_MTU_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tBT_ATT_OP_FIND_INFO_RSP},\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tBT_ATT_OP_FIND_BY_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tBT_ATT_OP_READ_BY_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tBT_ATT_OP_READ_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tBT_ATT_OP_READ_BLOB_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tBT_ATT_OP_READ_MULT_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tBT_ATT_OP_READ_BY_GRP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tBT_ATT_OP_WRITE_RSP },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tBT_ATT_OP_PREP_WRITE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tBT_ATT_OP_EXEC_WRITE_RSP },\n\t{ }\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic const struct {\n\tuint8_t req_opcode;\n\tuint8_t rsp_opcode;\n} att_req_rsp_mapping_table[] = {\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tBT_ATT_OP_MTU_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tBT_ATT_OP_FIND_INFO_RSP},\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tBT_ATT_OP_FIND_BY_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tBT_ATT_OP_READ_BY_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tBT_ATT_OP_READ_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tBT_ATT_OP_READ_BLOB_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tBT_ATT_OP_READ_MULT_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tBT_ATT_OP_READ_BY_GRP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tBT_ATT_OP_WRITE_RSP },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tBT_ATT_OP_PREP_WRITE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tBT_ATT_OP_EXEC_WRITE_RSP },\n\t{ }\n};\n\nstatic uint8_t get_req_opcode(uint8_t rsp_opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_req_rsp_mapping_table[i].rsp_opcode; i++) {\n\t\tif (att_req_rsp_mapping_table[i].rsp_opcode == rsp_opcode)\n\t\t\treturn att_req_rsp_mapping_table[i].req_opcode;\n\t}\n\n\treturn 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "handle_error_rsp",
          "args": [
            "att",
            "pdu",
            "pdu_len",
            "&req_opcode"
          ],
          "line": 687
        },
        "resolved": true,
        "details": {
          "function_name": "handle_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "627-659",
          "snippet": "static bool handle_error_rsp(struct bt_att *att, uint8_t *pdu,\n\t\t\t\t\tssize_t pdu_len, uint8_t *opcode)\n{\n\tconst struct bt_att_pdu_error_rsp *rsp;\n\tstruct att_send_op *op = att->pending_req;\n\n\tif (pdu_len != sizeof(*rsp)) {\n\t\t*opcode = 0;\n\t\treturn false;\n\t}\n\n\trsp = (void *) pdu;\n\n\t*opcode = rsp->opcode;\n\n\t/* Attempt to change security */\n\tif (!change_security(att, rsp->ecode))\n\t\treturn false;\n\n\t/* Remove timeout_id if outstanding */\n\tif (op->timeout_id) {\n\t\ttimeout_remove(op->timeout_id);\n\t\top->timeout_id = 0;\n\t}\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\t\"Retrying operation %p\", op);\n\n\tatt->pending_req = NULL;\n\n\t/* Push operation back to request queue */\n\treturn queue_push_head(att->req_queue, op);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool handle_error_rsp(struct bt_att *att, uint8_t *pdu,\n\t\t\t\t\tssize_t pdu_len, uint8_t *opcode)\n{\n\tconst struct bt_att_pdu_error_rsp *rsp;\n\tstruct att_send_op *op = att->pending_req;\n\n\tif (pdu_len != sizeof(*rsp)) {\n\t\t*opcode = 0;\n\t\treturn false;\n\t}\n\n\trsp = (void *) pdu;\n\n\t*opcode = rsp->opcode;\n\n\t/* Attempt to change security */\n\tif (!change_security(att, rsp->ecode))\n\t\treturn false;\n\n\t/* Remove timeout_id if outstanding */\n\tif (op->timeout_id) {\n\t\ttimeout_remove(op->timeout_id);\n\t\top->timeout_id = 0;\n\t}\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\t\"Retrying operation %p\", op);\n\n\tatt->pending_req = NULL;\n\n\t/* Push operation back to request queue */\n\treturn queue_push_head(att->req_queue, op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "io_shutdown",
          "args": [
            "att->io"
          ],
          "line": 677
        },
        "resolved": true,
        "details": {
          "function_name": "io_shutdown",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "286-293",
          "snippet": "bool io_shutdown(struct io *io)\n{\n\tif (!io || !io->channel)\n\t\treturn false;\n\n\treturn g_io_channel_shutdown(io->channel, TRUE, NULL)\n\t\t\t\t\t\t\t== G_IO_STATUS_NORMAL;\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_shutdown(struct io *io)\n{\n\tif (!io || !io->channel)\n\t\treturn false;\n\n\treturn g_io_channel_shutdown(io->channel, TRUE, NULL)\n\t\t\t\t\t\t\t== G_IO_STATUS_NORMAL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void handle_rsp(struct bt_att *att, uint8_t opcode, uint8_t *pdu,\n\t\t\t\t\t\t\t\tssize_t pdu_len)\n{\n\tstruct att_send_op *op = att->pending_req;\n\tuint8_t req_opcode;\n\tuint8_t rsp_opcode;\n\tuint8_t *rsp_pdu = NULL;\n\tuint16_t rsp_pdu_len = 0;\n\n\t/*\n\t * If no request is pending, then the response is unexpected. Disconnect\n\t * the bearer.\n\t */\n\tif (!op) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Received unexpected ATT response\");\n\t\tio_shutdown(att->io);\n\t\treturn;\n\t}\n\n\t/*\n\t * If the received response doesn't match the pending request, or if\n\t * the request is malformed, end the current request with failure.\n\t */\n\tif (opcode == BT_ATT_OP_ERROR_RSP) {\n\t\t/* Return if error response cause a retry */\n\t\tif (handle_error_rsp(att, pdu, pdu_len, &req_opcode)) {\n\t\t\twakeup_writer(att);\n\t\t\treturn;\n\t\t}\n\t} else if (!(req_opcode = get_req_opcode(opcode)))\n\t\tgoto fail;\n\n\tif (req_opcode != op->opcode)\n\t\tgoto fail;\n\n\trsp_opcode = opcode;\n\n\tif (pdu_len > 0) {\n\t\trsp_pdu = pdu;\n\t\trsp_pdu_len = pdu_len;\n\t}\n\n\tgoto done;\n\nfail:\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\"Failed to handle response PDU; opcode: 0x%02x\", opcode);\n\n\trsp_opcode = BT_ATT_OP_ERROR_RSP;\n\ndone:\n\tif (op->callback)\n\t\top->callback(rsp_opcode, rsp_pdu, rsp_pdu_len, op->user_data);\n\n\tdestroy_att_send_op(op);\n\tatt->pending_req = NULL;\n\n\twakeup_writer(att);\n}"
  },
  {
    "function_name": "handle_error_rsp",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "627-659",
    "snippet": "static bool handle_error_rsp(struct bt_att *att, uint8_t *pdu,\n\t\t\t\t\tssize_t pdu_len, uint8_t *opcode)\n{\n\tconst struct bt_att_pdu_error_rsp *rsp;\n\tstruct att_send_op *op = att->pending_req;\n\n\tif (pdu_len != sizeof(*rsp)) {\n\t\t*opcode = 0;\n\t\treturn false;\n\t}\n\n\trsp = (void *) pdu;\n\n\t*opcode = rsp->opcode;\n\n\t/* Attempt to change security */\n\tif (!change_security(att, rsp->ecode))\n\t\treturn false;\n\n\t/* Remove timeout_id if outstanding */\n\tif (op->timeout_id) {\n\t\ttimeout_remove(op->timeout_id);\n\t\top->timeout_id = 0;\n\t}\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\t\"Retrying operation %p\", op);\n\n\tatt->pending_req = NULL;\n\n\t/* Push operation back to request queue */\n\treturn queue_push_head(att->req_queue, op);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_push_head",
          "args": [
            "att->req_queue",
            "op"
          ],
          "line": 658
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "110-129",
          "snippet": "bool queue_push_head(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tentry->next = queue->head;\n\n\tqueue->head = entry;\n\n\tif (!queue->tail)\n\t\tqueue->tail = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_head(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tentry->next = queue->head;\n\n\tqueue->head = entry;\n\n\tif (!queue->tail)\n\t\tqueue->tail = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "att->debug_callback",
            "att->debug_data",
            "\"Retrying operation %p\"",
            "op"
          ],
          "line": 652
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "timeout_remove",
          "args": [
            "op->timeout_id"
          ],
          "line": 648
        },
        "resolved": true,
        "details": {
          "function_name": "timeout_remove",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/timeout-mainloop.c",
          "lines": "76-82",
          "snippet": "void timeout_remove(unsigned int id)\n{\n\tif (!id)\n\t\treturn;\n\n\tmainloop_remove_timeout((int) id);\n}",
          "includes": [
            "#include \"timeout.h\"",
            "#include \"util.h\"",
            "#include \"mainloop.h\"",
            "#include <stdlib.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"timeout.h\"\n#include \"util.h\"\n#include \"mainloop.h\"\n#include <stdlib.h>\n\nvoid timeout_remove(unsigned int id)\n{\n\tif (!id)\n\t\treturn;\n\n\tmainloop_remove_timeout((int) id);\n}"
        }
      },
      {
        "call_info": {
          "callee": "change_security",
          "args": [
            "att",
            "rsp->ecode"
          ],
          "line": 643
        },
        "resolved": true,
        "details": {
          "function_name": "change_security",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "599-625",
          "snippet": "static bool change_security(struct bt_att *att, uint8_t ecode)\n{\n\tint security;\n\n\tif (att->io_sec_level != BT_ATT_SECURITY_AUTO)\n\t\treturn false;\n\n\tsecurity = bt_att_get_security(att, NULL);\n\n\tif (ecode == BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION &&\n\t\t\t\t\tsecurity < BT_ATT_SECURITY_MEDIUM) {\n\t\tsecurity = BT_ATT_SECURITY_MEDIUM;\n\t} else if (ecode == BT_ATT_ERROR_AUTHENTICATION) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\tsecurity = BT_ATT_SECURITY_MEDIUM;\n\t\telse if (security < BT_ATT_SECURITY_HIGH)\n\t\t\tsecurity = BT_ATT_SECURITY_HIGH;\n\t\telse if (security < BT_ATT_SECURITY_FIPS)\n\t\t\tsecurity = BT_ATT_SECURITY_FIPS;\n\t\telse\n\t\t\treturn false;\n\t} else {\n\t\treturn false;\n\t}\n\n\treturn bt_att_set_security(att, security);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool change_security(struct bt_att *att, uint8_t ecode)\n{\n\tint security;\n\n\tif (att->io_sec_level != BT_ATT_SECURITY_AUTO)\n\t\treturn false;\n\n\tsecurity = bt_att_get_security(att, NULL);\n\n\tif (ecode == BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION &&\n\t\t\t\t\tsecurity < BT_ATT_SECURITY_MEDIUM) {\n\t\tsecurity = BT_ATT_SECURITY_MEDIUM;\n\t} else if (ecode == BT_ATT_ERROR_AUTHENTICATION) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\tsecurity = BT_ATT_SECURITY_MEDIUM;\n\t\telse if (security < BT_ATT_SECURITY_HIGH)\n\t\t\tsecurity = BT_ATT_SECURITY_HIGH;\n\t\telse if (security < BT_ATT_SECURITY_FIPS)\n\t\t\tsecurity = BT_ATT_SECURITY_FIPS;\n\t\telse\n\t\t\treturn false;\n\t} else {\n\t\treturn false;\n\t}\n\n\treturn bt_att_set_security(att, security);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool handle_error_rsp(struct bt_att *att, uint8_t *pdu,\n\t\t\t\t\tssize_t pdu_len, uint8_t *opcode)\n{\n\tconst struct bt_att_pdu_error_rsp *rsp;\n\tstruct att_send_op *op = att->pending_req;\n\n\tif (pdu_len != sizeof(*rsp)) {\n\t\t*opcode = 0;\n\t\treturn false;\n\t}\n\n\trsp = (void *) pdu;\n\n\t*opcode = rsp->opcode;\n\n\t/* Attempt to change security */\n\tif (!change_security(att, rsp->ecode))\n\t\treturn false;\n\n\t/* Remove timeout_id if outstanding */\n\tif (op->timeout_id) {\n\t\ttimeout_remove(op->timeout_id);\n\t\top->timeout_id = 0;\n\t}\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\t\"Retrying operation %p\", op);\n\n\tatt->pending_req = NULL;\n\n\t/* Push operation back to request queue */\n\treturn queue_push_head(att->req_queue, op);\n}"
  },
  {
    "function_name": "change_security",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "599-625",
    "snippet": "static bool change_security(struct bt_att *att, uint8_t ecode)\n{\n\tint security;\n\n\tif (att->io_sec_level != BT_ATT_SECURITY_AUTO)\n\t\treturn false;\n\n\tsecurity = bt_att_get_security(att, NULL);\n\n\tif (ecode == BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION &&\n\t\t\t\t\tsecurity < BT_ATT_SECURITY_MEDIUM) {\n\t\tsecurity = BT_ATT_SECURITY_MEDIUM;\n\t} else if (ecode == BT_ATT_ERROR_AUTHENTICATION) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\tsecurity = BT_ATT_SECURITY_MEDIUM;\n\t\telse if (security < BT_ATT_SECURITY_HIGH)\n\t\t\tsecurity = BT_ATT_SECURITY_HIGH;\n\t\telse if (security < BT_ATT_SECURITY_FIPS)\n\t\t\tsecurity = BT_ATT_SECURITY_FIPS;\n\t\telse\n\t\t\treturn false;\n\t} else {\n\t\treturn false;\n\t}\n\n\treturn bt_att_set_security(att, security);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_set_security",
          "args": [
            "att",
            "security"
          ],
          "line": 624
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_set_security",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1484-1505",
          "snippet": "bool bt_att_set_security(struct bt_att *att, int level)\n{\n\tstruct bt_security sec;\n\n\tif (!att || level < BT_ATT_SECURITY_AUTO ||\n\t\t\t\t\t\tlevel > BT_ATT_SECURITY_HIGH)\n\t\treturn false;\n\n\tif (!att->io_on_l2cap) {\n\t\tatt->io_sec_level = level;\n\t\treturn true;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tsec.level = level;\n\n\tif (setsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec,\n\t\t\t\t\t\t\tsizeof(sec)) < 0)\n\t\treturn false;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_security(struct bt_att *att, int level)\n{\n\tstruct bt_security sec;\n\n\tif (!att || level < BT_ATT_SECURITY_AUTO ||\n\t\t\t\t\t\tlevel > BT_ATT_SECURITY_HIGH)\n\t\treturn false;\n\n\tif (!att->io_on_l2cap) {\n\t\tatt->io_sec_level = level;\n\t\treturn true;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tsec.level = level;\n\n\tif (setsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec,\n\t\t\t\t\t\t\tsizeof(sec)) < 0)\n\t\treturn false;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_security",
          "args": [
            "att",
            "NULL"
          ],
          "line": 606
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_security",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1458-1482",
          "snippet": "int bt_att_get_security(struct bt_att *att, uint8_t *enc_size)\n{\n\tstruct bt_security sec;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap) {\n\t\tif (enc_size)\n\t\t\t*enc_size = att->enc_size;\n\n\t\treturn att->io_sec_level;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tlen = sizeof(sec);\n\tif (getsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec, &len) < 0)\n\t\treturn -EIO;\n\n\tif (enc_size)\n\t\t*enc_size = att->enc_size;\n\n\treturn sec.level;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nint bt_att_get_security(struct bt_att *att, uint8_t *enc_size)\n{\n\tstruct bt_security sec;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap) {\n\t\tif (enc_size)\n\t\t\t*enc_size = att->enc_size;\n\n\t\treturn att->io_sec_level;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tlen = sizeof(sec);\n\tif (getsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec, &len) < 0)\n\t\treturn -EIO;\n\n\tif (enc_size)\n\t\t*enc_size = att->enc_size;\n\n\treturn sec.level;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool change_security(struct bt_att *att, uint8_t ecode)\n{\n\tint security;\n\n\tif (att->io_sec_level != BT_ATT_SECURITY_AUTO)\n\t\treturn false;\n\n\tsecurity = bt_att_get_security(att, NULL);\n\n\tif (ecode == BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION &&\n\t\t\t\t\tsecurity < BT_ATT_SECURITY_MEDIUM) {\n\t\tsecurity = BT_ATT_SECURITY_MEDIUM;\n\t} else if (ecode == BT_ATT_ERROR_AUTHENTICATION) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\tsecurity = BT_ATT_SECURITY_MEDIUM;\n\t\telse if (security < BT_ATT_SECURITY_HIGH)\n\t\t\tsecurity = BT_ATT_SECURITY_HIGH;\n\t\telse if (security < BT_ATT_SECURITY_FIPS)\n\t\t\tsecurity = BT_ATT_SECURITY_FIPS;\n\t\telse\n\t\t\treturn false;\n\t} else {\n\t\treturn false;\n\t}\n\n\treturn bt_att_set_security(att, security);\n}"
  },
  {
    "function_name": "disconnect_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "552-597",
    "snippet": "static bool disconnect_cb(struct io *io, void *user_data)\n{\n\tstruct bt_att *att = user_data;\n\tint err;\n\tsocklen_t len;\n\n\tlen = sizeof(err);\n\n\tif (getsockopt(att->fd, SOL_SOCKET, SO_ERROR, &err, &len) < 0) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Failed to obtain disconnect error: %s\",\n\t\t\t\t\tstrerror(errno));\n\t\terr = 0;\n\t}\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Physical link disconnected: %s\",\n\t\t\t\t\tstrerror(err));\n\n\tio_destroy(att->io);\n\tatt->io = NULL;\n\n\t/* Notify request callbacks */\n\tqueue_remove_all(att->req_queue, NULL, NULL, disc_att_send_op);\n\tqueue_remove_all(att->ind_queue, NULL, NULL, disc_att_send_op);\n\tqueue_remove_all(att->write_queue, NULL, NULL, disc_att_send_op);\n\n\tif (att->pending_req) {\n\t\tdisc_att_send_op(att->pending_req);\n\t\tatt->pending_req = NULL;\n\t}\n\n\tif (att->pending_ind) {\n\t\tdisc_att_send_op(att->pending_ind);\n\t\tatt->pending_ind = NULL;\n\t}\n\n\tbt_att_ref(att);\n\n\tqueue_foreach(att->disconn_list, disconn_handler, INT_TO_PTR(err));\n\n\tbt_att_unregister_all(att);\n\tbt_att_unref(att);\n\n\treturn false;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_unref",
          "args": [
            "att"
          ],
          "line": 594
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1063-1075",
          "snippet": "void bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nvoid bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_unregister_all",
          "args": [
            "att"
          ],
          "line": 593
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unregister_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1447-1456",
          "snippet": "bool bt_att_unregister_all(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\tqueue_remove_all(att->notify_list, NULL, NULL, destroy_att_notify);\n\tqueue_remove_all(att->disconn_list, NULL, NULL, destroy_att_disconn);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_unregister_all(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn false;\n\n\tqueue_remove_all(att->notify_list, NULL, NULL, destroy_att_notify);\n\tqueue_remove_all(att->disconn_list, NULL, NULL, destroy_att_disconn);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_foreach",
          "args": [
            "att->disconn_list",
            "disconn_handler",
            "INT_TO_PTR(err)"
          ],
          "line": 591
        },
        "resolved": true,
        "details": {
          "function_name": "queue_foreach",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "203-224",
          "snippet": "void queue_foreach(struct queue *queue, queue_foreach_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue || !function)\n\t\treturn;\n\n\tentry = queue->head;\n\tif (!entry)\n\t\treturn;\n\n\tqueue_ref(queue);\n\twhile (entry && queue->head && queue->ref_count > 1) {\n\t\tstruct queue_entry *next;\n\n\t\tnext = entry->next;\n\t\tfunction(entry->data, user_data);\n\t\tentry = next;\n\t}\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_foreach(struct queue *queue, queue_foreach_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue || !function)\n\t\treturn;\n\n\tentry = queue->head;\n\tif (!entry)\n\t\treturn;\n\n\tqueue_ref(queue);\n\twhile (entry && queue->head && queue->ref_count > 1) {\n\t\tstruct queue_entry *next;\n\n\t\tnext = entry->next;\n\t\tfunction(entry->data, user_data);\n\t\tentry = next;\n\t}\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "INT_TO_PTR",
          "args": [
            "err"
          ],
          "line": 591
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_ref",
          "args": [
            "att"
          ],
          "line": 589
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1053-1061",
          "snippet": "struct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstruct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}"
        }
      },
      {
        "call_info": {
          "callee": "disc_att_send_op",
          "args": [
            "att->pending_ind"
          ],
          "line": 585
        },
        "resolved": true,
        "details": {
          "function_name": "disc_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "542-550",
          "snippet": "static void disc_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->callback)\n\t\top->callback(BT_ATT_OP_ERROR_RSP, NULL, 0, op->user_data);\n\n\tdestroy_att_send_op(op);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void disc_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->callback)\n\t\top->callback(BT_ATT_OP_ERROR_RSP, NULL, 0, op->user_data);\n\n\tdestroy_att_send_op(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_all",
          "args": [
            "att->write_queue",
            "NULL",
            "NULL",
            "disc_att_send_op"
          ],
          "line": 577
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "318-362",
          "snippet": "unsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}"
        }
      },
      {
        "call_info": {
          "callee": "io_destroy",
          "args": [
            "att->io"
          ],
          "line": 571
        },
        "resolved": true,
        "details": {
          "function_name": "io_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "111-135",
          "snippet": "void io_destroy(struct io *io)\n{\n\tif (!io)\n\t\treturn;\n\n\tif (io->read_watch) {\n\t\tg_source_remove(io->read_watch->id);\n\t\tio->read_watch = NULL;\n\t}\n\n\tif (io->write_watch) {\n\t\tg_source_remove(io->write_watch->id);\n\t\tio->write_watch = NULL;\n\t}\n\n\tif (io->disconnect_watch) {\n\t\tg_source_remove(io->disconnect_watch->id);\n\t\tio->disconnect_watch = NULL;\n\t}\n\n\tg_io_channel_unref(io->channel);\n\tio->channel = NULL;\n\n\tio_unref(io);\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nvoid io_destroy(struct io *io)\n{\n\tif (!io)\n\t\treturn;\n\n\tif (io->read_watch) {\n\t\tg_source_remove(io->read_watch->id);\n\t\tio->read_watch = NULL;\n\t}\n\n\tif (io->write_watch) {\n\t\tg_source_remove(io->write_watch->id);\n\t\tio->write_watch = NULL;\n\t}\n\n\tif (io->disconnect_watch) {\n\t\tg_source_remove(io->disconnect_watch->id);\n\t\tio->disconnect_watch = NULL;\n\t}\n\n\tg_io_channel_unref(io->channel);\n\tio->channel = NULL;\n\n\tio_unref(io);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "att->debug_callback",
            "att->debug_data",
            "\"Physical link disconnected: %s\"",
            "strerror(err)"
          ],
          "line": 567
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "strerror",
          "args": [
            "err"
          ],
          "line": 569
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strerror",
          "args": [
            "errno"
          ],
          "line": 563
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getsockopt",
          "args": [
            "att->fd",
            "SOL_SOCKET",
            "SO_ERROR",
            "&err",
            "&len"
          ],
          "line": 560
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool disconnect_cb(struct io *io, void *user_data)\n{\n\tstruct bt_att *att = user_data;\n\tint err;\n\tsocklen_t len;\n\n\tlen = sizeof(err);\n\n\tif (getsockopt(att->fd, SOL_SOCKET, SO_ERROR, &err, &len) < 0) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Failed to obtain disconnect error: %s\",\n\t\t\t\t\tstrerror(errno));\n\t\terr = 0;\n\t}\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Physical link disconnected: %s\",\n\t\t\t\t\tstrerror(err));\n\n\tio_destroy(att->io);\n\tatt->io = NULL;\n\n\t/* Notify request callbacks */\n\tqueue_remove_all(att->req_queue, NULL, NULL, disc_att_send_op);\n\tqueue_remove_all(att->ind_queue, NULL, NULL, disc_att_send_op);\n\tqueue_remove_all(att->write_queue, NULL, NULL, disc_att_send_op);\n\n\tif (att->pending_req) {\n\t\tdisc_att_send_op(att->pending_req);\n\t\tatt->pending_req = NULL;\n\t}\n\n\tif (att->pending_ind) {\n\t\tdisc_att_send_op(att->pending_ind);\n\t\tatt->pending_ind = NULL;\n\t}\n\n\tbt_att_ref(att);\n\n\tqueue_foreach(att->disconn_list, disconn_handler, INT_TO_PTR(err));\n\n\tbt_att_unregister_all(att);\n\tbt_att_unref(att);\n\n\treturn false;\n}"
  },
  {
    "function_name": "disc_att_send_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "542-550",
    "snippet": "static void disc_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->callback)\n\t\top->callback(BT_ATT_OP_ERROR_RSP, NULL, 0, op->user_data);\n\n\tdestroy_att_send_op(op);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "destroy_att_send_op",
          "args": [
            "op"
          ],
          "line": 549
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "200-212",
          "snippet": "static void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "BT_ATT_OP_ERROR_RSP",
            "NULL",
            "0",
            "op->user_data"
          ],
          "line": 547
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void disc_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->callback)\n\t\top->callback(BT_ATT_OP_ERROR_RSP, NULL, 0, op->user_data);\n\n\tdestroy_att_send_op(op);\n}"
  },
  {
    "function_name": "disconn_handler",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "530-540",
    "snippet": "static void disconn_handler(void *data, void *user_data)\n{\n\tstruct att_disconn *disconn = data;\n\tint err = PTR_TO_INT(user_data);\n\n\tif (disconn->removed)\n\t\treturn;\n\n\tif (disconn->callback)\n\t\tdisconn->callback(err, disconn->user_data);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "disconn->callback",
          "args": [
            "err",
            "disconn->user_data"
          ],
          "line": 539
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "PTR_TO_INT",
          "args": [
            "user_data"
          ],
          "line": 533
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void disconn_handler(void *data, void *user_data)\n{\n\tstruct att_disconn *disconn = data;\n\tint err = PTR_TO_INT(user_data);\n\n\tif (disconn->removed)\n\t\treturn;\n\n\tif (disconn->callback)\n\t\tdisconn->callback(err, disconn->user_data);\n}"
  },
  {
    "function_name": "wakeup_writer",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "509-528",
    "snippet": "static void wakeup_writer(struct bt_att *att)\n{\n\tif (att->writer_active)\n\t\treturn;\n\n\t/* Set the write handler only if there is anything that can be sent\n\t * at all.\n\t */\n\tif (queue_isempty(att->write_queue)) {\n\t\tif ((att->pending_req || queue_isempty(att->req_queue)) &&\n\t\t\t(att->pending_ind || queue_isempty(att->ind_queue)))\n\t\t\treturn;\n\t}\n\n\tif (!io_set_write_handler(att->io, can_write_data, att,\n\t\t\t\t\t\t\twrite_watch_destroy))\n\t\treturn;\n\n\tatt->writer_active = true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "io_set_write_handler",
          "args": [
            "att->io",
            "can_write_data",
            "att",
            "write_watch_destroy"
          ],
          "line": 523
        },
        "resolved": true,
        "details": {
          "function_name": "io_set_write_handler",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "254-258",
          "snippet": "bool io_set_write_handler(struct io *io, io_callback_func_t callback,\n\t\t\t\tvoid *user_data, io_destroy_func_t destroy)\n{\n\treturn io_set_handler(io, G_IO_OUT, callback, user_data, destroy);\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_set_write_handler(struct io *io, io_callback_func_t callback,\n\t\t\t\tvoid *user_data, io_destroy_func_t destroy)\n{\n\treturn io_set_handler(io, G_IO_OUT, callback, user_data, destroy);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_isempty",
          "args": [
            "att->ind_queue"
          ],
          "line": 519
        },
        "resolved": true,
        "details": {
          "function_name": "queue_isempty",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "380-386",
          "snippet": "bool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void wakeup_writer(struct bt_att *att)\n{\n\tif (att->writer_active)\n\t\treturn;\n\n\t/* Set the write handler only if there is anything that can be sent\n\t * at all.\n\t */\n\tif (queue_isempty(att->write_queue)) {\n\t\tif ((att->pending_req || queue_isempty(att->req_queue)) &&\n\t\t\t(att->pending_ind || queue_isempty(att->ind_queue)))\n\t\t\treturn;\n\t}\n\n\tif (!io_set_write_handler(att->io, can_write_data, att,\n\t\t\t\t\t\t\twrite_watch_destroy))\n\t\treturn;\n\n\tatt->writer_active = true;\n}"
  },
  {
    "function_name": "can_write_data",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "443-507",
    "snippet": "static bool can_write_data(struct io *io, void *user_data)\n{\n\tstruct bt_att *att = user_data;\n\tstruct att_send_op *op;\n\tstruct timeout_data *timeout;\n\tssize_t ret;\n\tstruct iovec iov;\n\n\top = pick_next_send_op(att);\n\tif (!op)\n\t\treturn false;\n\n\tiov.iov_base = op->pdu;\n\tiov.iov_len = op->len;\n\n\tret = io_send(io, &iov, 1);\n\tif (ret < 0) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"write failed: %s\", strerror(-ret));\n\t\tif (op->callback)\n\t\t\top->callback(BT_ATT_OP_ERROR_RSP, NULL, 0,\n\t\t\t\t\t\t\top->user_data);\n\n\t\tdestroy_att_send_op(op);\n\t\treturn true;\n\t}\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"ATT op 0x%02x\", op->opcode);\n\n\tutil_hexdump('<', op->pdu, ret, att->debug_callback, att->debug_data);\n\n\t/* Based on the operation type, set either the pending request or the\n\t * pending indication. If it came from the write queue, then there is\n\t * no need to keep it around.\n\t */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tatt->pending_req = op;\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tatt->pending_ind = op;\n\t\tbreak;\n\tcase ATT_OP_TYPE_RSP:\n\t\t/* Set in_req to false to indicate that no request is pending */\n\t\tatt->in_req = false;\n\t\t/* fall through */\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_CONF:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tdefault:\n\t\tdestroy_att_send_op(op);\n\t\treturn true;\n\t}\n\n\ttimeout = new0(struct timeout_data, 1);\n\ttimeout->att = att;\n\ttimeout->id = op->id;\n\top->timeout_id = timeout_add(ATT_TIMEOUT_INTERVAL, timeout_cb,\n\t\t\t\t\t\t\t\ttimeout, free);\n\n\t/* Return true as there may be more operations ready to write. */\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define ATT_TIMEOUT_INTERVAL\t\t30000  /* 30000 ms */"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "timeout_add",
          "args": [
            "ATT_TIMEOUT_INTERVAL",
            "timeout_cb",
            "timeout",
            "free"
          ],
          "line": 502
        },
        "resolved": true,
        "details": {
          "function_name": "timeout_add",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/timeout-mainloop.c",
          "lines": "55-74",
          "snippet": "unsigned int timeout_add(unsigned int timeout, timeout_func_t func,\n\t\t\tvoid *user_data, timeout_destroy_func_t destroy)\n{\n\tstruct timeout_data *data;\n\n\tdata = new0(struct timeout_data, 1);\n\tdata->func = func;\n\tdata->user_data = user_data;\n\tdata->timeout = timeout;\n\tdata->destroy = destroy;\n\n\tdata->id = mainloop_add_timeout(timeout, timeout_callback, data,\n\t\t\t\t\t\t\ttimeout_destroy);\n\tif (data->id < 0) {\n\t\tfree(data);\n\t\treturn 0;\n\t}\n\n\treturn (unsigned int) data->id;\n}",
          "includes": [
            "#include \"timeout.h\"",
            "#include \"util.h\"",
            "#include \"mainloop.h\"",
            "#include <stdlib.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"timeout.h\"\n#include \"util.h\"\n#include \"mainloop.h\"\n#include <stdlib.h>\n\nunsigned int timeout_add(unsigned int timeout, timeout_func_t func,\n\t\t\tvoid *user_data, timeout_destroy_func_t destroy)\n{\n\tstruct timeout_data *data;\n\n\tdata = new0(struct timeout_data, 1);\n\tdata->func = func;\n\tdata->user_data = user_data;\n\tdata->timeout = timeout;\n\tdata->destroy = destroy;\n\n\tdata->id = mainloop_add_timeout(timeout, timeout_callback, data,\n\t\t\t\t\t\t\ttimeout_destroy);\n\tif (data->id < 0) {\n\t\tfree(data);\n\t\treturn 0;\n\t}\n\n\treturn (unsigned int) data->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structtimeout_data",
            "1"
          ],
          "line": 499
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "destroy_att_send_op",
          "args": [
            "op"
          ],
          "line": 495
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "200-212",
          "snippet": "static void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_hexdump",
          "args": [
            "'<'",
            "op->pdu",
            "ret",
            "att->debug_callback",
            "att->debug_data"
          ],
          "line": 473
        },
        "resolved": true,
        "details": {
          "function_name": "util_hexdump",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "73-113",
          "snippet": "void util_hexdump(const char dir, const unsigned char *buf, size_t len,\n\t\t\t\tutil_debug_func_t function, void *user_data)\n{\n\tstatic const char hexdigits[] = \"0123456789abcdef\";\n\tchar str[68];\n\tsize_t i;\n\n\tif (!function || !len)\n\t\treturn;\n\n\tstr[0] = dir;\n\n\tfor (i = 0; i < len; i++) {\n\t\tstr[((i % 16) * 3) + 1] = ' ';\n\t\tstr[((i % 16) * 3) + 2] = hexdigits[buf[i] >> 4];\n\t\tstr[((i % 16) * 3) + 3] = hexdigits[buf[i] & 0xf];\n\t\tstr[(i % 16) + 51] = isprint(buf[i]) ? buf[i] : '.';\n\n\t\tif ((i + 1) % 16 == 0) {\n\t\t\tstr[49] = ' ';\n\t\t\tstr[50] = ' ';\n\t\t\tstr[67] = '\\0';\n\t\t\tfunction(str, user_data);\n\t\t\tstr[0] = ' ';\n\t\t}\n\t}\n\n\tif (i % 16 > 0) {\n\t\tsize_t j;\n\t\tfor (j = (i % 16); j < 16; j++) {\n\t\t\tstr[(j * 3) + 1] = ' ';\n\t\t\tstr[(j * 3) + 2] = ' ';\n\t\t\tstr[(j * 3) + 3] = ' ';\n\t\t\tstr[j + 51] = ' ';\n\t\t}\n\t\tstr[49] = ' ';\n\t\tstr[50] = ' ';\n\t\tstr[67] = '\\0';\n\t\tfunction(str, user_data);\n\t}\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_hexdump(const char dir, const unsigned char *buf, size_t len,\n\t\t\t\tutil_debug_func_t function, void *user_data)\n{\n\tstatic const char hexdigits[] = \"0123456789abcdef\";\n\tchar str[68];\n\tsize_t i;\n\n\tif (!function || !len)\n\t\treturn;\n\n\tstr[0] = dir;\n\n\tfor (i = 0; i < len; i++) {\n\t\tstr[((i % 16) * 3) + 1] = ' ';\n\t\tstr[((i % 16) * 3) + 2] = hexdigits[buf[i] >> 4];\n\t\tstr[((i % 16) * 3) + 3] = hexdigits[buf[i] & 0xf];\n\t\tstr[(i % 16) + 51] = isprint(buf[i]) ? buf[i] : '.';\n\n\t\tif ((i + 1) % 16 == 0) {\n\t\t\tstr[49] = ' ';\n\t\t\tstr[50] = ' ';\n\t\t\tstr[67] = '\\0';\n\t\t\tfunction(str, user_data);\n\t\t\tstr[0] = ' ';\n\t\t}\n\t}\n\n\tif (i % 16 > 0) {\n\t\tsize_t j;\n\t\tfor (j = (i % 16); j < 16; j++) {\n\t\t\tstr[(j * 3) + 1] = ' ';\n\t\t\tstr[(j * 3) + 2] = ' ';\n\t\t\tstr[(j * 3) + 3] = ' ';\n\t\t\tstr[j + 51] = ' ';\n\t\t}\n\t\tstr[49] = ' ';\n\t\tstr[50] = ' ';\n\t\tstr[67] = '\\0';\n\t\tfunction(str, user_data);\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "att->debug_callback",
            "att->debug_data",
            "\"ATT op 0x%02x\"",
            "op->opcode"
          ],
          "line": 470
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->callback",
          "args": [
            "BT_ATT_OP_ERROR_RSP",
            "NULL",
            "0",
            "op->user_data"
          ],
          "line": 463
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strerror",
          "args": [
            "-ret"
          ],
          "line": 461
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "io_send",
          "args": [
            "io",
            "&iov",
            "1"
          ],
          "line": 458
        },
        "resolved": true,
        "details": {
          "function_name": "io_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "266-284",
          "snippet": "ssize_t io_send(struct io *io, const struct iovec *iov, int iovcnt)\n{\n\tint fd;\n\tssize_t ret;\n\n\tif (!io || !io->channel)\n\t\treturn -ENOTCONN;\n\n\tfd = io_get_fd(io);\n\n\tdo {\n\t\tret = writev(fd, iov, iovcnt);\n\t} while (ret < 0 && errno == EINTR);\n\n\tif (ret < 0)\n\t\treturn -errno;\n\n\treturn ret;\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nssize_t io_send(struct io *io, const struct iovec *iov, int iovcnt)\n{\n\tint fd;\n\tssize_t ret;\n\n\tif (!io || !io->channel)\n\t\treturn -ENOTCONN;\n\n\tfd = io_get_fd(io);\n\n\tdo {\n\t\tret = writev(fd, iov, iovcnt);\n\t} while (ret < 0 && errno == EINTR);\n\n\tif (ret < 0)\n\t\treturn -errno;\n\n\treturn ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pick_next_send_op",
          "args": [
            "att"
          ],
          "line": 451
        },
        "resolved": true,
        "details": {
          "function_name": "pick_next_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "365-393",
          "snippet": "static struct att_send_op *pick_next_send_op(struct bt_att *att)\n{\n\tstruct att_send_op *op;\n\n\t/* See if any operations are already in the write queue */\n\top = queue_pop_head(att->write_queue);\n\tif (op)\n\t\treturn op;\n\n\t/* If there is no pending request, pick an operation from the\n\t * request queue.\n\t */\n\tif (!att->pending_req) {\n\t\top = queue_pop_head(att->req_queue);\n\t\tif (op)\n\t\t\treturn op;\n\t}\n\n\t/* There is either a request pending or no requests queued. If there is\n\t * no pending indication, pick an operation from the indication queue.\n\t */\n\tif (!att->pending_ind) {\n\t\top = queue_pop_head(att->ind_queue);\n\t\tif (op)\n\t\t\treturn op;\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic struct att_send_op *pick_next_send_op(struct bt_att *att)\n{\n\tstruct att_send_op *op;\n\n\t/* See if any operations are already in the write queue */\n\top = queue_pop_head(att->write_queue);\n\tif (op)\n\t\treturn op;\n\n\t/* If there is no pending request, pick an operation from the\n\t * request queue.\n\t */\n\tif (!att->pending_req) {\n\t\top = queue_pop_head(att->req_queue);\n\t\tif (op)\n\t\t\treturn op;\n\t}\n\n\t/* There is either a request pending or no requests queued. If there is\n\t * no pending indication, pick an operation from the indication queue.\n\t */\n\tif (!att->pending_ind) {\n\t\top = queue_pop_head(att->ind_queue);\n\t\tif (op)\n\t\t\treturn op;\n\t}\n\n\treturn NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define ATT_TIMEOUT_INTERVAL\t\t30000  /* 30000 ms */\n\nstatic bool can_write_data(struct io *io, void *user_data)\n{\n\tstruct bt_att *att = user_data;\n\tstruct att_send_op *op;\n\tstruct timeout_data *timeout;\n\tssize_t ret;\n\tstruct iovec iov;\n\n\top = pick_next_send_op(att);\n\tif (!op)\n\t\treturn false;\n\n\tiov.iov_base = op->pdu;\n\tiov.iov_len = op->len;\n\n\tret = io_send(io, &iov, 1);\n\tif (ret < 0) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"write failed: %s\", strerror(-ret));\n\t\tif (op->callback)\n\t\t\top->callback(BT_ATT_OP_ERROR_RSP, NULL, 0,\n\t\t\t\t\t\t\top->user_data);\n\n\t\tdestroy_att_send_op(op);\n\t\treturn true;\n\t}\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"ATT op 0x%02x\", op->opcode);\n\n\tutil_hexdump('<', op->pdu, ret, att->debug_callback, att->debug_data);\n\n\t/* Based on the operation type, set either the pending request or the\n\t * pending indication. If it came from the write queue, then there is\n\t * no need to keep it around.\n\t */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tatt->pending_req = op;\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tatt->pending_ind = op;\n\t\tbreak;\n\tcase ATT_OP_TYPE_RSP:\n\t\t/* Set in_req to false to indicate that no request is pending */\n\t\tatt->in_req = false;\n\t\t/* fall through */\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_CONF:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tdefault:\n\t\tdestroy_att_send_op(op);\n\t\treturn true;\n\t}\n\n\ttimeout = new0(struct timeout_data, 1);\n\ttimeout->att = att;\n\ttimeout->id = op->id;\n\top->timeout_id = timeout_add(ATT_TIMEOUT_INTERVAL, timeout_cb,\n\t\t\t\t\t\t\t\ttimeout, free);\n\n\t/* Return true as there may be more operations ready to write. */\n\treturn true;\n}"
  },
  {
    "function_name": "write_watch_destroy",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "436-441",
    "snippet": "static void write_watch_destroy(void *user_data)\n{\n\tstruct bt_att *att = user_data;\n\n\tatt->writer_active = false;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void write_watch_destroy(void *user_data)\n{\n\tstruct bt_att *att = user_data;\n\n\tatt->writer_active = false;\n}"
  },
  {
    "function_name": "timeout_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "400-434",
    "snippet": "static bool timeout_cb(void *user_data)\n{\n\tstruct timeout_data *timeout = user_data;\n\tstruct bt_att *att = timeout->att;\n\tstruct att_send_op *op = NULL;\n\n\tif (att->pending_req && att->pending_req->id == timeout->id) {\n\t\top = att->pending_req;\n\t\tatt->pending_req = NULL;\n\t} else if (att->pending_ind && att->pending_ind->id == timeout->id) {\n\t\top = att->pending_ind;\n\t\tatt->pending_ind = NULL;\n\t}\n\n\tif (!op)\n\t\treturn false;\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\"Operation timed out: 0x%02x\", op->opcode);\n\n\tif (att->timeout_callback)\n\t\tatt->timeout_callback(op->id, op->opcode, att->timeout_data);\n\n\top->timeout_id = 0;\n\tdestroy_att_send_op(op);\n\n\t/*\n\t * Directly terminate the connection as required by the ATT protocol.\n\t * This should trigger an io disconnect event which will clean up the\n\t * io and notify the upper layer.\n\t */\n\tio_shutdown(att->io);\n\n\treturn false;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "io_shutdown",
          "args": [
            "att->io"
          ],
          "line": 431
        },
        "resolved": true,
        "details": {
          "function_name": "io_shutdown",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "286-293",
          "snippet": "bool io_shutdown(struct io *io)\n{\n\tif (!io || !io->channel)\n\t\treturn false;\n\n\treturn g_io_channel_shutdown(io->channel, TRUE, NULL)\n\t\t\t\t\t\t\t== G_IO_STATUS_NORMAL;\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_shutdown(struct io *io)\n{\n\tif (!io || !io->channel)\n\t\treturn false;\n\n\treturn g_io_channel_shutdown(io->channel, TRUE, NULL)\n\t\t\t\t\t\t\t== G_IO_STATUS_NORMAL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "destroy_att_send_op",
          "args": [
            "op"
          ],
          "line": 424
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_att_send_op",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "200-212",
          "snippet": "static void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "att->timeout_callback",
          "args": [
            "op->id",
            "op->opcode",
            "att->timeout_data"
          ],
          "line": 421
        },
        "resolved": true,
        "details": {
          "function_name": "timeout_callback",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/mainloop.c",
          "lines": "288-303",
          "snippet": "static void timeout_callback(int fd, uint32_t events, void *user_data)\n{\n\tstruct timeout_data *data = user_data;\n\tuint64_t expired;\n\tssize_t result;\n\n\tif (events & (EPOLLERR | EPOLLHUP))\n\t\treturn;\n\n\tresult = read(data->fd, &expired, sizeof(expired));\n\tif (result != sizeof(expired))\n\t\treturn;\n\n\tif (data->callback)\n\t\tdata->callback(data->fd, data->user_data);\n}",
          "includes": [
            "#include \"mainloop.h\"",
            "#include <sys/epoll.h>",
            "#include <sys/timerfd.h>",
            "#include <sys/signalfd.h>",
            "#include <signal.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <unistd.h>",
            "#include <errno.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"mainloop.h\"\n#include <sys/epoll.h>\n#include <sys/timerfd.h>\n#include <sys/signalfd.h>\n#include <signal.h>\n#include <string.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <errno.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void timeout_callback(int fd, uint32_t events, void *user_data)\n{\n\tstruct timeout_data *data = user_data;\n\tuint64_t expired;\n\tssize_t result;\n\n\tif (events & (EPOLLERR | EPOLLHUP))\n\t\treturn;\n\n\tresult = read(data->fd, &expired, sizeof(expired));\n\tif (result != sizeof(expired))\n\t\treturn;\n\n\tif (data->callback)\n\t\tdata->callback(data->fd, data->user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "att->debug_callback",
            "att->debug_data",
            "\"Operation timed out: 0x%02x\"",
            "op->opcode"
          ],
          "line": 417
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool timeout_cb(void *user_data)\n{\n\tstruct timeout_data *timeout = user_data;\n\tstruct bt_att *att = timeout->att;\n\tstruct att_send_op *op = NULL;\n\n\tif (att->pending_req && att->pending_req->id == timeout->id) {\n\t\top = att->pending_req;\n\t\tatt->pending_req = NULL;\n\t} else if (att->pending_ind && att->pending_ind->id == timeout->id) {\n\t\top = att->pending_ind;\n\t\tatt->pending_ind = NULL;\n\t}\n\n\tif (!op)\n\t\treturn false;\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\"Operation timed out: 0x%02x\", op->opcode);\n\n\tif (att->timeout_callback)\n\t\tatt->timeout_callback(op->id, op->opcode, att->timeout_data);\n\n\top->timeout_id = 0;\n\tdestroy_att_send_op(op);\n\n\t/*\n\t * Directly terminate the connection as required by the ATT protocol.\n\t * This should trigger an io disconnect event which will clean up the\n\t * io and notify the upper layer.\n\t */\n\tio_shutdown(att->io);\n\n\treturn false;\n}"
  },
  {
    "function_name": "pick_next_send_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "365-393",
    "snippet": "static struct att_send_op *pick_next_send_op(struct bt_att *att)\n{\n\tstruct att_send_op *op;\n\n\t/* See if any operations are already in the write queue */\n\top = queue_pop_head(att->write_queue);\n\tif (op)\n\t\treturn op;\n\n\t/* If there is no pending request, pick an operation from the\n\t * request queue.\n\t */\n\tif (!att->pending_req) {\n\t\top = queue_pop_head(att->req_queue);\n\t\tif (op)\n\t\t\treturn op;\n\t}\n\n\t/* There is either a request pending or no requests queued. If there is\n\t * no pending indication, pick an operation from the indication queue.\n\t */\n\tif (!att->pending_ind) {\n\t\top = queue_pop_head(att->ind_queue);\n\t\tif (op)\n\t\t\treturn op;\n\t}\n\n\treturn NULL;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "att->ind_queue"
          ],
          "line": 387
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic struct att_send_op *pick_next_send_op(struct bt_att *att)\n{\n\tstruct att_send_op *op;\n\n\t/* See if any operations are already in the write queue */\n\top = queue_pop_head(att->write_queue);\n\tif (op)\n\t\treturn op;\n\n\t/* If there is no pending request, pick an operation from the\n\t * request queue.\n\t */\n\tif (!att->pending_req) {\n\t\top = queue_pop_head(att->req_queue);\n\t\tif (op)\n\t\t\treturn op;\n\t}\n\n\t/* There is either a request pending or no requests queued. If there is\n\t * no pending indication, pick an operation from the indication queue.\n\t */\n\tif (!att->pending_ind) {\n\t\top = queue_pop_head(att->ind_queue);\n\t\tif (op)\n\t\t\treturn op;\n\t}\n\n\treturn NULL;\n}"
  },
  {
    "function_name": "create_att_send_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "319-363",
    "snippet": "static struct att_send_op *create_att_send_op(struct bt_att *att,\n\t\t\t\t\t\tuint8_t opcode,\n\t\t\t\t\t\tconst void *pdu,\n\t\t\t\t\t\tuint16_t length,\n\t\t\t\t\t\tbt_att_response_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tenum att_op_type type;\n\n\tif (length && !pdu)\n\t\treturn NULL;\n\n\ttype = get_op_type(opcode);\n\tif (type == ATT_OP_TYPE_UNKNOWN)\n\t\treturn NULL;\n\n\t/* If the opcode corresponds to an operation type that does not elicit a\n\t * response from the remote end, then no callback should have been\n\t * provided, since it will never be called.\n\t */\n\tif (callback && type != ATT_OP_TYPE_REQ && type != ATT_OP_TYPE_IND)\n\t\treturn NULL;\n\n\t/* Similarly, if the operation does elicit a response then a callback\n\t * must be provided.\n\t */\n\tif (!callback && (type == ATT_OP_TYPE_REQ || type == ATT_OP_TYPE_IND))\n\t\treturn NULL;\n\n\top = new0(struct att_send_op, 1);\n\top->type = type;\n\top->opcode = opcode;\n\top->callback = callback;\n\top->destroy = destroy;\n\top->user_data = user_data;\n\n\tif (!encode_pdu(att, op, pdu, length)) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn op;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 358
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "encode_pdu",
          "args": [
            "att",
            "op",
            "pdu",
            "length"
          ],
          "line": 357
        },
        "resolved": true,
        "details": {
          "function_name": "encode_pdu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "276-317",
          "snippet": "static bool encode_pdu(struct bt_att *att, struct att_send_op *op,\n\t\t\t\t\tconst void *pdu, uint16_t length)\n{\n\tuint16_t pdu_len = 1;\n\tstruct sign_info *sign = att->local_sign;\n\tuint32_t sign_cnt;\n\n\tif (sign && (op->opcode & ATT_OP_SIGNED_MASK))\n\t\tpdu_len += BT_ATT_SIGNATURE_LEN;\n\n\tif (length && pdu)\n\t\tpdu_len += length;\n\n\tif (pdu_len > att->mtu)\n\t\treturn false;\n\n\top->len = pdu_len;\n\top->pdu = malloc(op->len);\n\tif (!op->pdu)\n\t\treturn false;\n\n\t((uint8_t *) op->pdu)[0] = op->opcode;\n\tif (pdu_len > 1)\n\t\tmemcpy(op->pdu + 1, pdu, length);\n\n\tif (!sign || !(op->opcode & ATT_OP_SIGNED_MASK) || !att->crypto)\n\t\treturn true;\n\n\tif (!sign->counter(&sign_cnt, sign->user_data))\n\t\tgoto fail;\n\n\tif ((bt_crypto_sign_att(att->crypto, sign->key, op->pdu, 1 + length,\n\t\t\t\tsign_cnt, &((uint8_t *) op->pdu)[1 + length])))\n\t\treturn true;\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"ATT unable to generate signature\");\n\nfail:\n\tfree(op->pdu);\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define BT_ATT_SIGNATURE_LEN\t\t12",
            "#define ATT_OP_SIGNED_MASK\t\t0x80"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define BT_ATT_SIGNATURE_LEN\t\t12\n#define ATT_OP_SIGNED_MASK\t\t0x80\n\nstatic bool encode_pdu(struct bt_att *att, struct att_send_op *op,\n\t\t\t\t\tconst void *pdu, uint16_t length)\n{\n\tuint16_t pdu_len = 1;\n\tstruct sign_info *sign = att->local_sign;\n\tuint32_t sign_cnt;\n\n\tif (sign && (op->opcode & ATT_OP_SIGNED_MASK))\n\t\tpdu_len += BT_ATT_SIGNATURE_LEN;\n\n\tif (length && pdu)\n\t\tpdu_len += length;\n\n\tif (pdu_len > att->mtu)\n\t\treturn false;\n\n\top->len = pdu_len;\n\top->pdu = malloc(op->len);\n\tif (!op->pdu)\n\t\treturn false;\n\n\t((uint8_t *) op->pdu)[0] = op->opcode;\n\tif (pdu_len > 1)\n\t\tmemcpy(op->pdu + 1, pdu, length);\n\n\tif (!sign || !(op->opcode & ATT_OP_SIGNED_MASK) || !att->crypto)\n\t\treturn true;\n\n\tif (!sign->counter(&sign_cnt, sign->user_data))\n\t\tgoto fail;\n\n\tif ((bt_crypto_sign_att(att->crypto, sign->key, op->pdu, 1 + length,\n\t\t\t\tsign_cnt, &((uint8_t *) op->pdu)[1 + length])))\n\t\treturn true;\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"ATT unable to generate signature\");\n\nfail:\n\tfree(op->pdu);\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structatt_send_op",
            "1"
          ],
          "line": 350
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_op_type",
          "args": [
            "opcode"
          ],
          "line": 333
        },
        "resolved": true,
        "details": {
          "function_name": "get_op_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "143-156",
          "snippet": "static enum att_op_type get_op_type(uint8_t opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_opcode_type_table[i].opcode; i++) {\n\t\tif (att_opcode_type_table[i].opcode == opcode)\n\t\t\treturn att_opcode_type_table[i].type;\n\t}\n\n\tif (opcode & ATT_OP_CMD_MASK)\n\t\treturn ATT_OP_TYPE_CMD;\n\n\treturn ATT_OP_TYPE_UNKNOWN;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATT_OP_CMD_MASK\t\t\t0x40"
          ],
          "globals_used": [
            "static const struct {\n\tuint8_t opcode;\n\tenum att_op_type type;\n} att_opcode_type_table[] = {\n\t{ BT_ATT_OP_ERROR_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_MTU_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_INFO_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BLOB_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_MULT_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_WRITE_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_CMD,\t\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_SIGNED_WRITE_CMD,\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_PREP_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_EXEC_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_HANDLE_VAL_NOT,\t\tATT_OP_TYPE_NOT },\n\t{ BT_ATT_OP_HANDLE_VAL_IND,\t\tATT_OP_TYPE_IND },\n\t{ BT_ATT_OP_HANDLE_VAL_CONF,\t\tATT_OP_TYPE_CONF },\n\t{ }\n};"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define ATT_OP_CMD_MASK\t\t\t0x40\n\nstatic const struct {\n\tuint8_t opcode;\n\tenum att_op_type type;\n} att_opcode_type_table[] = {\n\t{ BT_ATT_OP_ERROR_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_MTU_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_INFO_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BLOB_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_MULT_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_WRITE_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_CMD,\t\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_SIGNED_WRITE_CMD,\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_PREP_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_EXEC_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_HANDLE_VAL_NOT,\t\tATT_OP_TYPE_NOT },\n\t{ BT_ATT_OP_HANDLE_VAL_IND,\t\tATT_OP_TYPE_IND },\n\t{ BT_ATT_OP_HANDLE_VAL_CONF,\t\tATT_OP_TYPE_CONF },\n\t{ }\n};\n\nstatic enum att_op_type get_op_type(uint8_t opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_opcode_type_table[i].opcode; i++) {\n\t\tif (att_opcode_type_table[i].opcode == opcode)\n\t\t\treturn att_opcode_type_table[i].type;\n\t}\n\n\tif (opcode & ATT_OP_CMD_MASK)\n\t\treturn ATT_OP_TYPE_CMD;\n\n\treturn ATT_OP_TYPE_UNKNOWN;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic struct att_send_op *create_att_send_op(struct bt_att *att,\n\t\t\t\t\t\tuint8_t opcode,\n\t\t\t\t\t\tconst void *pdu,\n\t\t\t\t\t\tuint16_t length,\n\t\t\t\t\t\tbt_att_response_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tenum att_op_type type;\n\n\tif (length && !pdu)\n\t\treturn NULL;\n\n\ttype = get_op_type(opcode);\n\tif (type == ATT_OP_TYPE_UNKNOWN)\n\t\treturn NULL;\n\n\t/* If the opcode corresponds to an operation type that does not elicit a\n\t * response from the remote end, then no callback should have been\n\t * provided, since it will never be called.\n\t */\n\tif (callback && type != ATT_OP_TYPE_REQ && type != ATT_OP_TYPE_IND)\n\t\treturn NULL;\n\n\t/* Similarly, if the operation does elicit a response then a callback\n\t * must be provided.\n\t */\n\tif (!callback && (type == ATT_OP_TYPE_REQ || type == ATT_OP_TYPE_IND))\n\t\treturn NULL;\n\n\top = new0(struct att_send_op, 1);\n\top->type = type;\n\top->opcode = opcode;\n\top->callback = callback;\n\top->destroy = destroy;\n\top->user_data = user_data;\n\n\tif (!encode_pdu(att, op, pdu, length)) {\n\t\tfree(op);\n\t\treturn NULL;\n\t}\n\n\treturn op;\n}"
  },
  {
    "function_name": "encode_pdu",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "276-317",
    "snippet": "static bool encode_pdu(struct bt_att *att, struct att_send_op *op,\n\t\t\t\t\tconst void *pdu, uint16_t length)\n{\n\tuint16_t pdu_len = 1;\n\tstruct sign_info *sign = att->local_sign;\n\tuint32_t sign_cnt;\n\n\tif (sign && (op->opcode & ATT_OP_SIGNED_MASK))\n\t\tpdu_len += BT_ATT_SIGNATURE_LEN;\n\n\tif (length && pdu)\n\t\tpdu_len += length;\n\n\tif (pdu_len > att->mtu)\n\t\treturn false;\n\n\top->len = pdu_len;\n\top->pdu = malloc(op->len);\n\tif (!op->pdu)\n\t\treturn false;\n\n\t((uint8_t *) op->pdu)[0] = op->opcode;\n\tif (pdu_len > 1)\n\t\tmemcpy(op->pdu + 1, pdu, length);\n\n\tif (!sign || !(op->opcode & ATT_OP_SIGNED_MASK) || !att->crypto)\n\t\treturn true;\n\n\tif (!sign->counter(&sign_cnt, sign->user_data))\n\t\tgoto fail;\n\n\tif ((bt_crypto_sign_att(att->crypto, sign->key, op->pdu, 1 + length,\n\t\t\t\tsign_cnt, &((uint8_t *) op->pdu)[1 + length])))\n\t\treturn true;\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"ATT unable to generate signature\");\n\nfail:\n\tfree(op->pdu);\n\treturn false;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define BT_ATT_SIGNATURE_LEN\t\t12",
      "#define ATT_OP_SIGNED_MASK\t\t0x80"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op->pdu"
          ],
          "line": 315
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "att->debug_callback",
            "att->debug_data",
            "\"ATT unable to generate signature\""
          ],
          "line": 311
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_crypto_sign_att",
          "args": [
            "att->crypto",
            "sign->key",
            "op->pdu",
            "1 + length",
            "sign_cnt",
            "&((uint8_t *) op->pdu)[1 + length]"
          ],
          "line": 307
        },
        "resolved": true,
        "details": {
          "function_name": "bt_crypto_sign_att",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/crypto.c",
          "lines": "266-325",
          "snippet": "bool bt_crypto_sign_att(struct bt_crypto *crypto, const uint8_t key[16],\n\t\t\t\tconst uint8_t *m, uint16_t m_len,\n\t\t\t\tuint32_t sign_cnt, uint8_t signature[12])\n{\n\tint fd;\n\tint len;\n\tuint8_t tmp[16], out[16];\n\tuint16_t msg_len = m_len + sizeof(uint32_t);\n\tuint8_t msg[msg_len];\n\tuint8_t msg_s[msg_len];\n\n\tif (!crypto)\n\t\treturn false;\n\n\tmemset(msg, 0, msg_len);\n\tmemcpy(msg, m, m_len);\n\n\t/* Add sign_counter to the message */\n\tput_le32(sign_cnt, msg + m_len);\n\n\t/* The most significant octet of key corresponds to key[0] */\n\tswap_buf(key, tmp, 16);\n\n\tfd = alg_new(crypto->cmac_aes, tmp, 16);\n\tif (fd < 0)\n\t\treturn false;\n\n\t/* Swap msg before signing */\n\tswap_buf(msg, msg_s, msg_len);\n\n\tlen = send(fd, msg_s, msg_len, 0);\n\tif (len < 0) {\n\t\tclose(fd);\n\t\treturn false;\n\t}\n\n\tlen = read(fd, out, 16);\n\tif (len < 0) {\n\t\tclose(fd);\n\t\treturn false;\n\t}\n\n\tclose(fd);\n\n\t/*\n\t * As to BT spec. 4.1 Vol[3], Part C, chapter 10.4.1 sign counter should\n\t * be placed in the signature\n\t */\n\tput_be32(sign_cnt, out + 8);\n\n\t/*\n\t * The most significant octet of hash corresponds to out[0]  - swap it.\n\t * Then truncate in most significant bit first order to a length of\n\t * 12 octets\n\t */\n\tswap_buf(out, tmp, 16);\n\tmemcpy(signature, tmp + 4, 12);\n\n\treturn true;\n}",
          "includes": [
            "#include <linux/if_alg.h>",
            "#include <linux/types.h>",
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/util.h\"",
            "#include <sys/socket.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <linux/if_alg.h>\n#include <linux/types.h>\n#include \"src/shared/crypto.h\"\n#include \"src/shared/util.h\"\n#include <sys/socket.h>\n#include <string.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <config.h>\n\nbool bt_crypto_sign_att(struct bt_crypto *crypto, const uint8_t key[16],\n\t\t\t\tconst uint8_t *m, uint16_t m_len,\n\t\t\t\tuint32_t sign_cnt, uint8_t signature[12])\n{\n\tint fd;\n\tint len;\n\tuint8_t tmp[16], out[16];\n\tuint16_t msg_len = m_len + sizeof(uint32_t);\n\tuint8_t msg[msg_len];\n\tuint8_t msg_s[msg_len];\n\n\tif (!crypto)\n\t\treturn false;\n\n\tmemset(msg, 0, msg_len);\n\tmemcpy(msg, m, m_len);\n\n\t/* Add sign_counter to the message */\n\tput_le32(sign_cnt, msg + m_len);\n\n\t/* The most significant octet of key corresponds to key[0] */\n\tswap_buf(key, tmp, 16);\n\n\tfd = alg_new(crypto->cmac_aes, tmp, 16);\n\tif (fd < 0)\n\t\treturn false;\n\n\t/* Swap msg before signing */\n\tswap_buf(msg, msg_s, msg_len);\n\n\tlen = send(fd, msg_s, msg_len, 0);\n\tif (len < 0) {\n\t\tclose(fd);\n\t\treturn false;\n\t}\n\n\tlen = read(fd, out, 16);\n\tif (len < 0) {\n\t\tclose(fd);\n\t\treturn false;\n\t}\n\n\tclose(fd);\n\n\t/*\n\t * As to BT spec. 4.1 Vol[3], Part C, chapter 10.4.1 sign counter should\n\t * be placed in the signature\n\t */\n\tput_be32(sign_cnt, out + 8);\n\n\t/*\n\t * The most significant octet of hash corresponds to out[0]  - swap it.\n\t * Then truncate in most significant bit first order to a length of\n\t * 12 octets\n\t */\n\tswap_buf(out, tmp, 16);\n\tmemcpy(signature, tmp + 4, 12);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "sign->counter",
          "args": [
            "&sign_cnt",
            "sign->user_data"
          ],
          "line": 304
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "op->pdu + 1",
            "pdu",
            "length"
          ],
          "line": 299
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "op->len"
          ],
          "line": 293
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define BT_ATT_SIGNATURE_LEN\t\t12\n#define ATT_OP_SIGNED_MASK\t\t0x80\n\nstatic bool encode_pdu(struct bt_att *att, struct att_send_op *op,\n\t\t\t\t\tconst void *pdu, uint16_t length)\n{\n\tuint16_t pdu_len = 1;\n\tstruct sign_info *sign = att->local_sign;\n\tuint32_t sign_cnt;\n\n\tif (sign && (op->opcode & ATT_OP_SIGNED_MASK))\n\t\tpdu_len += BT_ATT_SIGNATURE_LEN;\n\n\tif (length && pdu)\n\t\tpdu_len += length;\n\n\tif (pdu_len > att->mtu)\n\t\treturn false;\n\n\top->len = pdu_len;\n\top->pdu = malloc(op->len);\n\tif (!op->pdu)\n\t\treturn false;\n\n\t((uint8_t *) op->pdu)[0] = op->opcode;\n\tif (pdu_len > 1)\n\t\tmemcpy(op->pdu + 1, pdu, length);\n\n\tif (!sign || !(op->opcode & ATT_OP_SIGNED_MASK) || !att->crypto)\n\t\treturn true;\n\n\tif (!sign->counter(&sign_cnt, sign->user_data))\n\t\tgoto fail;\n\n\tif ((bt_crypto_sign_att(att->crypto, sign->key, op->pdu, 1 + length,\n\t\t\t\tsign_cnt, &((uint8_t *) op->pdu)[1 + length])))\n\t\treturn true;\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"ATT unable to generate signature\");\n\nfail:\n\tfree(op->pdu);\n\treturn false;\n}"
  },
  {
    "function_name": "match_disconn_id",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "268-274",
    "snippet": "static bool match_disconn_id(const void *a, const void *b)\n{\n\tconst struct att_disconn *disconn = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn disconn->id == id;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "PTR_TO_UINT",
          "args": [
            "b"
          ],
          "line": 271
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool match_disconn_id(const void *a, const void *b)\n{\n\tconst struct att_disconn *disconn = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn disconn->id == id;\n}"
  },
  {
    "function_name": "destroy_att_disconn",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "258-266",
    "snippet": "static void destroy_att_disconn(void *data)\n{\n\tstruct att_disconn *disconn = data;\n\n\tif (disconn->destroy)\n\t\tdisconn->destroy(disconn->user_data);\n\n\tfree(disconn);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "disconn"
          ],
          "line": 265
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "disconn->destroy",
          "args": [
            "disconn->user_data"
          ],
          "line": 263
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_disconn(void *data)\n{\n\tstruct att_disconn *disconn = data;\n\n\tif (disconn->destroy)\n\t\tdisconn->destroy(disconn->user_data);\n\n\tfree(disconn);\n}"
  },
  {
    "function_name": "match_notify_id",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "242-248",
    "snippet": "static bool match_notify_id(const void *a, const void *b)\n{\n\tconst struct att_notify *notify = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn notify->id == id;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "PTR_TO_UINT",
          "args": [
            "b"
          ],
          "line": 245
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool match_notify_id(const void *a, const void *b)\n{\n\tconst struct att_notify *notify = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn notify->id == id;\n}"
  },
  {
    "function_name": "destroy_att_notify",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "232-240",
    "snippet": "static void destroy_att_notify(void *data)\n{\n\tstruct att_notify *notify = data;\n\n\tif (notify->destroy)\n\t\tnotify->destroy(notify->user_data);\n\n\tfree(notify);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "notify"
          ],
          "line": 239
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "notify->destroy",
          "args": [
            "notify->user_data"
          ],
          "line": 237
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_notify(void *data)\n{\n\tstruct att_notify *notify = data;\n\n\tif (notify->destroy)\n\t\tnotify->destroy(notify->user_data);\n\n\tfree(notify);\n}"
  },
  {
    "function_name": "cancel_att_send_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "214-222",
    "snippet": "static void cancel_att_send_op(struct att_send_op *op)\n{\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\top->user_data = NULL;\n\top->callback = NULL;\n\top->destroy = NULL;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "op->destroy",
          "args": [
            "op->user_data"
          ],
          "line": 217
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void cancel_att_send_op(struct att_send_op *op)\n{\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\top->user_data = NULL;\n\top->callback = NULL;\n\top->destroy = NULL;\n}"
  },
  {
    "function_name": "destroy_att_send_op",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "200-212",
    "snippet": "static void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 211
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "956-985",
          "snippet": "static void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void bt_att_free(struct bt_att *att)\n{\n\tif (att->pending_req)\n\t\tdestroy_att_send_op(att->pending_req);\n\n\tif (att->pending_ind)\n\t\tdestroy_att_send_op(att->pending_ind);\n\n\tio_destroy(att->io);\n\tbt_crypto_unref(att->crypto);\n\n\tqueue_destroy(att->req_queue, NULL);\n\tqueue_destroy(att->ind_queue, NULL);\n\tqueue_destroy(att->write_queue, NULL);\n\tqueue_destroy(att->notify_list, NULL);\n\tqueue_destroy(att->disconn_list, NULL);\n\n\tif (att->timeout_destroy)\n\t\tatt->timeout_destroy(att->timeout_data);\n\n\tif (att->debug_destroy)\n\t\tatt->debug_destroy(att->debug_data);\n\n\tfree(att->local_sign);\n\tfree(att->remote_sign);\n\n\tfree(att->buf);\n\n\tfree(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "op->destroy",
          "args": [
            "op->user_data"
          ],
          "line": 208
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "timeout_remove",
          "args": [
            "op->timeout_id"
          ],
          "line": 205
        },
        "resolved": true,
        "details": {
          "function_name": "timeout_remove",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/timeout-mainloop.c",
          "lines": "76-82",
          "snippet": "void timeout_remove(unsigned int id)\n{\n\tif (!id)\n\t\treturn;\n\n\tmainloop_remove_timeout((int) id);\n}",
          "includes": [
            "#include \"timeout.h\"",
            "#include \"util.h\"",
            "#include \"mainloop.h\"",
            "#include <stdlib.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"timeout.h\"\n#include \"util.h\"\n#include \"mainloop.h\"\n#include <stdlib.h>\n\nvoid timeout_remove(unsigned int id)\n{\n\tif (!id)\n\t\treturn;\n\n\tmainloop_remove_timeout((int) id);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic void destroy_att_send_op(void *data)\n{\n\tstruct att_send_op *op = data;\n\n\tif (op->timeout_id)\n\t\ttimeout_remove(op->timeout_id);\n\n\tif (op->destroy)\n\t\top->destroy(op->user_data);\n\n\tfree(op->pdu);\n\tfree(op);\n}"
  },
  {
    "function_name": "get_req_opcode",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "176-186",
    "snippet": "static uint8_t get_req_opcode(uint8_t rsp_opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_req_rsp_mapping_table[i].rsp_opcode; i++) {\n\t\tif (att_req_rsp_mapping_table[i].rsp_opcode == rsp_opcode)\n\t\t\treturn att_req_rsp_mapping_table[i].req_opcode;\n\t}\n\n\treturn 0;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static const struct {\n\tuint8_t req_opcode;\n\tuint8_t rsp_opcode;\n} att_req_rsp_mapping_table[] = {\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tBT_ATT_OP_MTU_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tBT_ATT_OP_FIND_INFO_RSP},\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tBT_ATT_OP_FIND_BY_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tBT_ATT_OP_READ_BY_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tBT_ATT_OP_READ_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tBT_ATT_OP_READ_BLOB_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tBT_ATT_OP_READ_MULT_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tBT_ATT_OP_READ_BY_GRP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tBT_ATT_OP_WRITE_RSP },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tBT_ATT_OP_PREP_WRITE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tBT_ATT_OP_EXEC_WRITE_RSP },\n\t{ }\n};"
    ],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic const struct {\n\tuint8_t req_opcode;\n\tuint8_t rsp_opcode;\n} att_req_rsp_mapping_table[] = {\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tBT_ATT_OP_MTU_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tBT_ATT_OP_FIND_INFO_RSP},\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tBT_ATT_OP_FIND_BY_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tBT_ATT_OP_READ_BY_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tBT_ATT_OP_READ_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tBT_ATT_OP_READ_BLOB_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tBT_ATT_OP_READ_MULT_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tBT_ATT_OP_READ_BY_GRP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tBT_ATT_OP_WRITE_RSP },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tBT_ATT_OP_PREP_WRITE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tBT_ATT_OP_EXEC_WRITE_RSP },\n\t{ }\n};\n\nstatic uint8_t get_req_opcode(uint8_t rsp_opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_req_rsp_mapping_table[i].rsp_opcode; i++) {\n\t\tif (att_req_rsp_mapping_table[i].rsp_opcode == rsp_opcode)\n\t\t\treturn att_req_rsp_mapping_table[i].req_opcode;\n\t}\n\n\treturn 0;\n}"
  },
  {
    "function_name": "get_op_type",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
    "lines": "143-156",
    "snippet": "static enum att_op_type get_op_type(uint8_t opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_opcode_type_table[i].opcode; i++) {\n\t\tif (att_opcode_type_table[i].opcode == opcode)\n\t\t\treturn att_opcode_type_table[i].type;\n\t}\n\n\tif (opcode & ATT_OP_CMD_MASK)\n\t\treturn ATT_OP_TYPE_CMD;\n\n\treturn ATT_OP_TYPE_UNKNOWN;\n}",
    "includes": [
      "#include \"src/shared/crypto.h\"",
      "#include \"src/shared/att.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/l2cap.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/timeout.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/io.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <stdlib.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define ATT_OP_CMD_MASK\t\t\t0x40"
    ],
    "globals_used": [
      "static const struct {\n\tuint8_t opcode;\n\tenum att_op_type type;\n} att_opcode_type_table[] = {\n\t{ BT_ATT_OP_ERROR_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_MTU_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_INFO_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BLOB_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_MULT_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_WRITE_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_CMD,\t\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_SIGNED_WRITE_CMD,\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_PREP_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_EXEC_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_HANDLE_VAL_NOT,\t\tATT_OP_TYPE_NOT },\n\t{ BT_ATT_OP_HANDLE_VAL_IND,\t\tATT_OP_TYPE_IND },\n\t{ BT_ATT_OP_HANDLE_VAL_CONF,\t\tATT_OP_TYPE_CONF },\n\t{ }\n};"
    ],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\n#define ATT_OP_CMD_MASK\t\t\t0x40\n\nstatic const struct {\n\tuint8_t opcode;\n\tenum att_op_type type;\n} att_opcode_type_table[] = {\n\t{ BT_ATT_OP_ERROR_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_MTU_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_MTU_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_INFO_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_INFO_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_FIND_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_FIND_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_TYPE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_TYPE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BLOB_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BLOB_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_MULT_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_MULT_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_REQ,\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_REQ,\t\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_WRITE_RSP,\t\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_WRITE_CMD,\t\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_SIGNED_WRITE_CMD,\t\tATT_OP_TYPE_CMD },\n\t{ BT_ATT_OP_PREP_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_PREP_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_EXEC_WRITE_REQ,\t\tATT_OP_TYPE_REQ },\n\t{ BT_ATT_OP_EXEC_WRITE_RSP,\t\tATT_OP_TYPE_RSP },\n\t{ BT_ATT_OP_HANDLE_VAL_NOT,\t\tATT_OP_TYPE_NOT },\n\t{ BT_ATT_OP_HANDLE_VAL_IND,\t\tATT_OP_TYPE_IND },\n\t{ BT_ATT_OP_HANDLE_VAL_CONF,\t\tATT_OP_TYPE_CONF },\n\t{ }\n};\n\nstatic enum att_op_type get_op_type(uint8_t opcode)\n{\n\tint i;\n\n\tfor (i = 0; att_opcode_type_table[i].opcode; i++) {\n\t\tif (att_opcode_type_table[i].opcode == opcode)\n\t\t\treturn att_opcode_type_table[i].type;\n\t}\n\n\tif (opcode & ATT_OP_CMD_MASK)\n\t\treturn ATT_OP_TYPE_CMD;\n\n\treturn ATT_OP_TYPE_UNKNOWN;\n}"
  }
]