[
  {
    "function_name": "bt_uhid_send",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "221-238",
    "snippet": "int bt_uhid_send(struct bt_uhid *uhid, const struct uhid_event *ev)\n{\n\tssize_t len;\n\tstruct iovec iov;\n\n\tif (!uhid->io)\n\t\treturn -ENOTCONN;\n\n\tiov.iov_base = (void *) ev;\n\tiov.iov_len = sizeof(*ev);\n\n\tlen = io_send(uhid->io, &iov, 1);\n\tif (len < 0)\n\t\treturn -errno;\n\n\t/* uHID kernel driver does not handle partial writes */\n\treturn len != sizeof(*ev) ? -EIO : 0;\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "io_send",
          "args": [
            "uhid->io",
            "&iov",
            "1"
          ],
          "line": 232
        },
        "resolved": true,
        "details": {
          "function_name": "io_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "266-284",
          "snippet": "ssize_t io_send(struct io *io, const struct iovec *iov, int iovcnt)\n{\n\tint fd;\n\tssize_t ret;\n\n\tif (!io || !io->channel)\n\t\treturn -ENOTCONN;\n\n\tfd = io_get_fd(io);\n\n\tdo {\n\t\tret = writev(fd, iov, iovcnt);\n\t} while (ret < 0 && errno == EINTR);\n\n\tif (ret < 0)\n\t\treturn -errno;\n\n\treturn ret;\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nssize_t io_send(struct io *io, const struct iovec *iov, int iovcnt)\n{\n\tint fd;\n\tssize_t ret;\n\n\tif (!io || !io->channel)\n\t\treturn -ENOTCONN;\n\n\tfd = io_get_fd(io);\n\n\tdo {\n\t\tret = writev(fd, iov, iovcnt);\n\t} while (ret < 0 && errno == EINTR);\n\n\tif (ret < 0)\n\t\treturn -errno;\n\n\treturn ret;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nint bt_uhid_send(struct bt_uhid *uhid, const struct uhid_event *ev)\n{\n\tssize_t len;\n\tstruct iovec iov;\n\n\tif (!uhid->io)\n\t\treturn -ENOTCONN;\n\n\tiov.iov_base = (void *) ev;\n\tiov.iov_len = sizeof(*ev);\n\n\tlen = io_send(uhid->io, &iov, 1);\n\tif (len < 0)\n\t\treturn -errno;\n\n\t/* uHID kernel driver does not handle partial writes */\n\treturn len != sizeof(*ev) ? -EIO : 0;\n}"
  },
  {
    "function_name": "bt_uhid_unregister",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "205-219",
    "snippet": "bool bt_uhid_unregister(struct bt_uhid *uhid, unsigned int id)\n{\n\tstruct uhid_notify *notify;\n\n\tif (!uhid || !id)\n\t\treturn false;\n\n\tnotify = queue_remove_if(uhid->notify_list, match_notify_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tfree(notify);\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "notify"
          ],
          "line": 217
        },
        "resolved": true,
        "details": {
          "function_name": "uhid_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
          "lines": "55-64",
          "snippet": "static void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}",
          "includes": [
            "#include \"src/shared/uhid.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/io.h\"",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_if",
          "args": [
            "uhid->notify_list",
            "match_notify_id",
            "UINT_TO_PTR(id)"
          ],
          "line": 212
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_if",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "278-316",
          "snippet": "void *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_remove_if(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry, *prev = NULL;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tentry = queue->head;\n\n\twhile (entry) {\n\t\tif (function(entry->data, user_data)) {\n\t\t\tvoid *data;\n\n\t\t\tif (prev)\n\t\t\t\tprev->next = entry->next;\n\t\t\telse\n\t\t\t\tqueue->head = entry->next;\n\n\t\t\tif (!entry->next)\n\t\t\t\tqueue->tail = prev;\n\n\t\t\tdata = entry->data;\n\n\t\t\tfree(entry);\n\t\t\tqueue->entries--;\n\n\t\t\treturn data;\n\t\t} else {\n\t\t\tprev = entry;\n\t\t\tentry = entry->next;\n\t\t}\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 213
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nbool bt_uhid_unregister(struct bt_uhid *uhid, unsigned int id)\n{\n\tstruct uhid_notify *notify;\n\n\tif (!uhid || !id)\n\t\treturn false;\n\n\tnotify = queue_remove_if(uhid->notify_list, match_notify_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tfree(notify);\n\treturn true;\n}"
  },
  {
    "function_name": "match_notify_id",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "197-203",
    "snippet": "static bool match_notify_id(const void *a, const void *b)\n{\n\tconst struct uhid_notify *notify = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn notify->id == id;\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "PTR_TO_UINT",
          "args": [
            "b"
          ],
          "line": 200
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic bool match_notify_id(const void *a, const void *b)\n{\n\tconst struct uhid_notify *notify = a;\n\tunsigned int id = PTR_TO_UINT(b);\n\n\treturn notify->id == id;\n}"
  },
  {
    "function_name": "bt_uhid_register",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "175-195",
    "snippet": "unsigned int bt_uhid_register(struct bt_uhid *uhid, uint32_t event,\n\t\t\t\tbt_uhid_callback_t func, void *user_data)\n{\n\tstruct uhid_notify *notify;\n\n\tif (!uhid)\n\t\treturn 0;\n\n\tnotify = new0(struct uhid_notify, 1);\n\tnotify->id = uhid->notify_id++;\n\tnotify->event = event;\n\tnotify->func = func;\n\tnotify->user_data = user_data;\n\n\tif (!queue_push_tail(uhid->notify_list, notify)) {\n\t\tfree(notify);\n\t\treturn 0;\n\t}\n\n\treturn notify->id;\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "notify"
          ],
          "line": 190
        },
        "resolved": true,
        "details": {
          "function_name": "uhid_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
          "lines": "55-64",
          "snippet": "static void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}",
          "includes": [
            "#include \"src/shared/uhid.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/io.h\"",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "uhid->notify_list",
            "notify"
          ],
          "line": 189
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structuhid_notify",
            "1"
          ],
          "line": 183
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nunsigned int bt_uhid_register(struct bt_uhid *uhid, uint32_t event,\n\t\t\t\tbt_uhid_callback_t func, void *user_data)\n{\n\tstruct uhid_notify *notify;\n\n\tif (!uhid)\n\t\treturn 0;\n\n\tnotify = new0(struct uhid_notify, 1);\n\tnotify->id = uhid->notify_id++;\n\tnotify->event = event;\n\tnotify->func = func;\n\tnotify->user_data = user_data;\n\n\tif (!queue_push_tail(uhid->notify_list, notify)) {\n\t\tfree(notify);\n\t\treturn 0;\n\t}\n\n\treturn notify->id;\n}"
  },
  {
    "function_name": "bt_uhid_set_close_on_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "165-173",
    "snippet": "bool bt_uhid_set_close_on_unref(struct bt_uhid *uhid, bool do_close)\n{\n\tif (!uhid || !uhid->io)\n\t\treturn false;\n\n\tio_set_close_on_destroy(uhid->io, do_close);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "io_set_close_on_destroy",
          "args": [
            "uhid->io",
            "do_close"
          ],
          "line": 170
        },
        "resolved": true,
        "details": {
          "function_name": "io_set_close_on_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "145-156",
          "snippet": "bool io_set_close_on_destroy(struct io *io, bool do_close)\n{\n\tif (!io)\n\t\treturn false;\n\n\tif (do_close)\n\t\tg_io_channel_set_close_on_unref(io->channel, TRUE);\n\telse\n\t\tg_io_channel_set_close_on_unref(io->channel, FALSE);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_set_close_on_destroy(struct io *io, bool do_close)\n{\n\tif (!io)\n\t\treturn false;\n\n\tif (do_close)\n\t\tg_io_channel_set_close_on_unref(io->channel, TRUE);\n\telse\n\t\tg_io_channel_set_close_on_unref(io->channel, FALSE);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nbool bt_uhid_set_close_on_unref(struct bt_uhid *uhid, bool do_close)\n{\n\tif (!uhid || !uhid->io)\n\t\treturn false;\n\n\tio_set_close_on_destroy(uhid->io, do_close);\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_uhid_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "154-163",
    "snippet": "void bt_uhid_unref(struct bt_uhid *uhid)\n{\n\tif (!uhid)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&uhid->ref_count, 1))\n\t\treturn;\n\n\tuhid_free(uhid);\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "uhid_free",
          "args": [
            "uhid"
          ],
          "line": 162
        },
        "resolved": true,
        "details": {
          "function_name": "uhid_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
          "lines": "55-64",
          "snippet": "static void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}",
          "includes": [
            "#include \"src/shared/uhid.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/io.h\"",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}"
        }
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&uhid->ref_count",
            "1"
          ],
          "line": 159
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid bt_uhid_unref(struct bt_uhid *uhid)\n{\n\tif (!uhid)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&uhid->ref_count, 1))\n\t\treturn;\n\n\tuhid_free(uhid);\n}"
  },
  {
    "function_name": "bt_uhid_ref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "144-152",
    "snippet": "struct bt_uhid *bt_uhid_ref(struct bt_uhid *uhid)\n{\n\tif (!uhid)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&uhid->ref_count, 1);\n\n\treturn uhid;\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&uhid->ref_count",
            "1"
          ],
          "line": 149
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstruct bt_uhid *bt_uhid_ref(struct bt_uhid *uhid)\n{\n\tif (!uhid)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&uhid->ref_count, 1);\n\n\treturn uhid;\n}"
  },
  {
    "function_name": "bt_uhid_new",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "123-142",
    "snippet": "struct bt_uhid *bt_uhid_new(int fd)\n{\n\tstruct bt_uhid *uhid;\n\n\tuhid = new0(struct bt_uhid, 1);\n\tuhid->io = io_new(fd);\n\tif (!uhid->io)\n\t\tgoto failed;\n\n\tuhid->notify_list = queue_new();\n\n\tif (!io_set_read_handler(uhid->io, uhid_read_handler, uhid, NULL))\n\t\tgoto failed;\n\n\treturn bt_uhid_ref(uhid);\n\nfailed:\n\tuhid_free(uhid);\n\treturn NULL;\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "uhid_free",
          "args": [
            "uhid"
          ],
          "line": 140
        },
        "resolved": true,
        "details": {
          "function_name": "uhid_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
          "lines": "55-64",
          "snippet": "static void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}",
          "includes": [
            "#include \"src/shared/uhid.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/io.h\"",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uhid_ref",
          "args": [
            "uhid"
          ],
          "line": 137
        },
        "resolved": true,
        "details": {
          "function_name": "bt_uhid_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
          "lines": "144-152",
          "snippet": "struct bt_uhid *bt_uhid_ref(struct bt_uhid *uhid)\n{\n\tif (!uhid)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&uhid->ref_count, 1);\n\n\treturn uhid;\n}",
          "includes": [
            "#include \"src/shared/uhid.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/io.h\"",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstruct bt_uhid *bt_uhid_ref(struct bt_uhid *uhid)\n{\n\tif (!uhid)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&uhid->ref_count, 1);\n\n\treturn uhid;\n}"
        }
      },
      {
        "call_info": {
          "callee": "io_set_read_handler",
          "args": [
            "uhid->io",
            "uhid_read_handler",
            "uhid",
            "NULL"
          ],
          "line": 134
        },
        "resolved": true,
        "details": {
          "function_name": "io_set_read_handler",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "248-252",
          "snippet": "bool io_set_read_handler(struct io *io, io_callback_func_t callback,\n\t\t\t\tvoid *user_data, io_destroy_func_t destroy)\n{\n\treturn io_set_handler(io, G_IO_IN, callback, user_data, destroy);\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_set_read_handler(struct io *io, io_callback_func_t callback,\n\t\t\t\tvoid *user_data, io_destroy_func_t destroy)\n{\n\treturn io_set_handler(io, G_IO_IN, callback, user_data, destroy);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_new",
          "args": [],
          "line": 132
        },
        "resolved": true,
        "details": {
          "function_name": "queue_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "56-66",
          "snippet": "struct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nstruct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "io_new",
          "args": [
            "fd"
          ],
          "line": 128
        },
        "resolved": true,
        "details": {
          "function_name": "io_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "71-90",
          "snippet": "struct io *io_new(int fd)\n{\n\tstruct io *io;\n\n\tif (fd < 0)\n\t\treturn NULL;\n\n\tio = g_try_new0(struct io, 1);\n\tif (!io)\n\t\treturn NULL;\n\n\tio->channel = g_io_channel_unix_new(fd);\n\n\tg_io_channel_set_encoding(io->channel, NULL, NULL);\n\tg_io_channel_set_buffered(io->channel, FALSE);\n\n\tg_io_channel_set_close_on_unref(io->channel, FALSE);\n\n\treturn io_ref(io);\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nstruct io *io_new(int fd)\n{\n\tstruct io *io;\n\n\tif (fd < 0)\n\t\treturn NULL;\n\n\tio = g_try_new0(struct io, 1);\n\tif (!io)\n\t\treturn NULL;\n\n\tio->channel = g_io_channel_unix_new(fd);\n\n\tg_io_channel_set_encoding(io->channel, NULL, NULL);\n\tg_io_channel_set_buffered(io->channel, FALSE);\n\n\tg_io_channel_set_close_on_unref(io->channel, FALSE);\n\n\treturn io_ref(io);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_uhid",
            "1"
          ],
          "line": 127
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstruct bt_uhid *bt_uhid_new(int fd)\n{\n\tstruct bt_uhid *uhid;\n\n\tuhid = new0(struct bt_uhid, 1);\n\tuhid->io = io_new(fd);\n\tif (!uhid->io)\n\t\tgoto failed;\n\n\tuhid->notify_list = queue_new();\n\n\tif (!io_set_read_handler(uhid->io, uhid_read_handler, uhid, NULL))\n\t\tgoto failed;\n\n\treturn bt_uhid_ref(uhid);\n\nfailed:\n\tuhid_free(uhid);\n\treturn NULL;\n}"
  },
  {
    "function_name": "bt_uhid_new_default",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "103-121",
    "snippet": "struct bt_uhid *bt_uhid_new_default(void)\n{\n\tstruct bt_uhid *uhid;\n\tint fd;\n\n\tfd = open(UHID_DEVICE_FILE, O_RDWR | O_CLOEXEC);\n\tif (fd < 0)\n\t\treturn NULL;\n\n\tuhid = bt_uhid_new(fd);\n\tif (!uhid) {\n\t\tclose(fd);\n\t\treturn NULL;\n\t}\n\n\tio_set_close_on_destroy(uhid->io, true);\n\n\treturn uhid;\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define UHID_DEVICE_FILE \"/dev/uhid\""
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "io_set_close_on_destroy",
          "args": [
            "uhid->io",
            "true"
          ],
          "line": 118
        },
        "resolved": true,
        "details": {
          "function_name": "io_set_close_on_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "145-156",
          "snippet": "bool io_set_close_on_destroy(struct io *io, bool do_close)\n{\n\tif (!io)\n\t\treturn false;\n\n\tif (do_close)\n\t\tg_io_channel_set_close_on_unref(io->channel, TRUE);\n\telse\n\t\tg_io_channel_set_close_on_unref(io->channel, FALSE);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nbool io_set_close_on_destroy(struct io *io, bool do_close)\n{\n\tif (!io)\n\t\treturn false;\n\n\tif (do_close)\n\t\tg_io_channel_set_close_on_unref(io->channel, TRUE);\n\telse\n\t\tg_io_channel_set_close_on_unref(io->channel, FALSE);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "close",
          "args": [
            "fd"
          ],
          "line": 114
        },
        "resolved": true,
        "details": {
          "function_name": "hfp_context_close_container",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/hfp.c",
          "lines": "334-347",
          "snippet": "bool hfp_context_close_container(struct hfp_context *context)\n{\n\tskip_whitespace(context);\n\n\t/* The list shall be followed by a right parenthesis (\")\" V250 5.7.3.1*/\n\tif (context->data[context->offset] != ')')\n\t\treturn false;\n\n\tcontext->offset++;\n\n\tnext_field(context);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/hfp.h\"",
            "#include \"src/shared/io.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/ringbuf.h\"",
            "#include \"src/shared/util.h\"",
            "#include <ctype.h>",
            "#include <stdarg.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/hfp.h\"\n#include \"src/shared/io.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/ringbuf.h\"\n#include \"src/shared/util.h\"\n#include <ctype.h>\n#include <stdarg.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nbool hfp_context_close_container(struct hfp_context *context)\n{\n\tskip_whitespace(context);\n\n\t/* The list shall be followed by a right parenthesis (\")\" V250 5.7.3.1*/\n\tif (context->data[context->offset] != ')')\n\t\treturn false;\n\n\tcontext->offset++;\n\n\tnext_field(context);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uhid_new",
          "args": [
            "fd"
          ],
          "line": 112
        },
        "resolved": true,
        "details": {
          "function_name": "bt_uhid_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
          "lines": "123-142",
          "snippet": "struct bt_uhid *bt_uhid_new(int fd)\n{\n\tstruct bt_uhid *uhid;\n\n\tuhid = new0(struct bt_uhid, 1);\n\tuhid->io = io_new(fd);\n\tif (!uhid->io)\n\t\tgoto failed;\n\n\tuhid->notify_list = queue_new();\n\n\tif (!io_set_read_handler(uhid->io, uhid_read_handler, uhid, NULL))\n\t\tgoto failed;\n\n\treturn bt_uhid_ref(uhid);\n\nfailed:\n\tuhid_free(uhid);\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/uhid.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/io.h\"",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstruct bt_uhid *bt_uhid_new(int fd)\n{\n\tstruct bt_uhid *uhid;\n\n\tuhid = new0(struct bt_uhid, 1);\n\tuhid->io = io_new(fd);\n\tif (!uhid->io)\n\t\tgoto failed;\n\n\tuhid->notify_list = queue_new();\n\n\tif (!io_set_read_handler(uhid->io, uhid_read_handler, uhid, NULL))\n\t\tgoto failed;\n\n\treturn bt_uhid_ref(uhid);\n\nfailed:\n\tuhid_free(uhid);\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "open",
          "args": [
            "UHID_DEVICE_FILE",
            "O_RDWR | O_CLOEXEC"
          ],
          "line": 108
        },
        "resolved": true,
        "details": {
          "function_name": "btsnoop_open",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btsnoop.c",
          "lines": "85-139",
          "snippet": "struct btsnoop *btsnoop_open(const char *path, unsigned long flags)\n{\n\tstruct btsnoop *btsnoop;\n\tstruct btsnoop_hdr hdr;\n\tssize_t len;\n\n\tbtsnoop = calloc(1, sizeof(*btsnoop));\n\tif (!btsnoop)\n\t\treturn NULL;\n\n\tbtsnoop->fd = open(path, O_RDONLY | O_CLOEXEC);\n\tif (btsnoop->fd < 0) {\n\t\tfree(btsnoop);\n\t\treturn NULL;\n\t}\n\n\tbtsnoop->flags = flags;\n\n\tlen = read(btsnoop->fd, &hdr, BTSNOOP_HDR_SIZE);\n\tif (len < 0 || len != BTSNOOP_HDR_SIZE)\n\t\tgoto failed;\n\n\tif (!memcmp(hdr.id, btsnoop_id, sizeof(btsnoop_id))) {\n\t\t/* Check for BTSnoop version 1 format */\n\t\tif (be32toh(hdr.version) != btsnoop_version)\n\t\t\tgoto failed;\n\n\t\tbtsnoop->format = be32toh(hdr.type);\n\t\tbtsnoop->index = 0xffff;\n\t} else {\n\t\tif (!(btsnoop->flags & BTSNOOP_FLAG_PKLG_SUPPORT))\n\t\t\tgoto failed;\n\n\t\t/* Check for Apple Packet Logger format */\n\t\tif (hdr.id[0] != 0x00 ||\n\t\t\t\t(hdr.id[1] != 0x00 && hdr.id[1] != 0x01))\n\t\t\tgoto failed;\n\n\t\tbtsnoop->format = BTSNOOP_FORMAT_MONITOR;\n\t\tbtsnoop->index = 0xffff;\n\t\tbtsnoop->pklg_format = true;\n\t\tbtsnoop->pklg_v2 = (hdr.id[1] == 0x01);\n\n\t\t/* Apple Packet Logger format has no header */\n\t\tlseek(btsnoop->fd, 0, SEEK_SET);\n\t}\n\n\treturn btsnoop_ref(btsnoop);\n\nfailed:\n\tclose(btsnoop->fd);\n\tfree(btsnoop);\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/btsnoop.h\"",
            "#include <sys/stat.h>",
            "#include <arpa/inet.h>",
            "#include <limits.h>",
            "#include <stdio.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <endian.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define BTSNOOP_HDR_SIZE (sizeof(struct btsnoop_hdr))"
          ],
          "globals_used": [
            "static const uint8_t btsnoop_id[] = { 0x62, 0x74, 0x73, 0x6e,\n\t\t\t\t      0x6f, 0x6f, 0x70, 0x00 };",
            "static const uint32_t btsnoop_version = 1;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/btsnoop.h\"\n#include <sys/stat.h>\n#include <arpa/inet.h>\n#include <limits.h>\n#include <stdio.h>\n#include <string.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <endian.h>\n#include <config.h>\n\n#define BTSNOOP_HDR_SIZE (sizeof(struct btsnoop_hdr))\n\nstatic const uint8_t btsnoop_id[] = { 0x62, 0x74, 0x73, 0x6e,\n\t\t\t\t      0x6f, 0x6f, 0x70, 0x00 };\nstatic const uint32_t btsnoop_version = 1;\n\nstruct btsnoop *btsnoop_open(const char *path, unsigned long flags)\n{\n\tstruct btsnoop *btsnoop;\n\tstruct btsnoop_hdr hdr;\n\tssize_t len;\n\n\tbtsnoop = calloc(1, sizeof(*btsnoop));\n\tif (!btsnoop)\n\t\treturn NULL;\n\n\tbtsnoop->fd = open(path, O_RDONLY | O_CLOEXEC);\n\tif (btsnoop->fd < 0) {\n\t\tfree(btsnoop);\n\t\treturn NULL;\n\t}\n\n\tbtsnoop->flags = flags;\n\n\tlen = read(btsnoop->fd, &hdr, BTSNOOP_HDR_SIZE);\n\tif (len < 0 || len != BTSNOOP_HDR_SIZE)\n\t\tgoto failed;\n\n\tif (!memcmp(hdr.id, btsnoop_id, sizeof(btsnoop_id))) {\n\t\t/* Check for BTSnoop version 1 format */\n\t\tif (be32toh(hdr.version) != btsnoop_version)\n\t\t\tgoto failed;\n\n\t\tbtsnoop->format = be32toh(hdr.type);\n\t\tbtsnoop->index = 0xffff;\n\t} else {\n\t\tif (!(btsnoop->flags & BTSNOOP_FLAG_PKLG_SUPPORT))\n\t\t\tgoto failed;\n\n\t\t/* Check for Apple Packet Logger format */\n\t\tif (hdr.id[0] != 0x00 ||\n\t\t\t\t(hdr.id[1] != 0x00 && hdr.id[1] != 0x01))\n\t\t\tgoto failed;\n\n\t\tbtsnoop->format = BTSNOOP_FORMAT_MONITOR;\n\t\tbtsnoop->index = 0xffff;\n\t\tbtsnoop->pklg_format = true;\n\t\tbtsnoop->pklg_v2 = (hdr.id[1] == 0x01);\n\n\t\t/* Apple Packet Logger format has no header */\n\t\tlseek(btsnoop->fd, 0, SEEK_SET);\n\t}\n\n\treturn btsnoop_ref(btsnoop);\n\nfailed:\n\tclose(btsnoop->fd);\n\tfree(btsnoop);\n\n\treturn NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\n#define UHID_DEVICE_FILE \"/dev/uhid\"\n\nstruct bt_uhid *bt_uhid_new_default(void)\n{\n\tstruct bt_uhid *uhid;\n\tint fd;\n\n\tfd = open(UHID_DEVICE_FILE, O_RDWR | O_CLOEXEC);\n\tif (fd < 0)\n\t\treturn NULL;\n\n\tuhid = bt_uhid_new(fd);\n\tif (!uhid) {\n\t\tclose(fd);\n\t\treturn NULL;\n\t}\n\n\tio_set_close_on_destroy(uhid->io, true);\n\n\treturn uhid;\n}"
  },
  {
    "function_name": "uhid_read_handler",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "78-101",
    "snippet": "static bool uhid_read_handler(struct io *io, void *user_data)\n{\n\tstruct bt_uhid *uhid = user_data;\n\tint fd;\n\tssize_t len;\n\tstruct uhid_event ev;\n\n\tfd = io_get_fd(io);\n\tif (fd < 0)\n\t\treturn false;\n\n\tmemset(&ev, 0, sizeof(ev));\n\n\tlen = read(fd, &ev, sizeof(ev));\n\tif (len < 0)\n\t\treturn false;\n\n\tif ((size_t) len < sizeof(ev.type))\n\t\treturn false;\n\n\tqueue_foreach(uhid->notify_list, notify_handler, &ev);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_foreach",
          "args": [
            "uhid->notify_list",
            "notify_handler",
            "&ev"
          ],
          "line": 98
        },
        "resolved": true,
        "details": {
          "function_name": "queue_foreach",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "203-224",
          "snippet": "void queue_foreach(struct queue *queue, queue_foreach_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue || !function)\n\t\treturn;\n\n\tentry = queue->head;\n\tif (!entry)\n\t\treturn;\n\n\tqueue_ref(queue);\n\twhile (entry && queue->head && queue->ref_count > 1) {\n\t\tstruct queue_entry *next;\n\n\t\tnext = entry->next;\n\t\tfunction(entry->data, user_data);\n\t\tentry = next;\n\t}\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_foreach(struct queue *queue, queue_foreach_func_t function,\n\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue || !function)\n\t\treturn;\n\n\tentry = queue->head;\n\tif (!entry)\n\t\treturn;\n\n\tqueue_ref(queue);\n\twhile (entry && queue->head && queue->ref_count > 1) {\n\t\tstruct queue_entry *next;\n\n\t\tnext = entry->next;\n\t\tfunction(entry->data, user_data);\n\t\tentry = next;\n\t}\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "read",
          "args": [
            "fd",
            "&ev",
            "sizeof(ev)"
          ],
          "line": 91
        },
        "resolved": true,
        "details": {
          "function_name": "notify_client_ready",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1221-1250",
          "snippet": "static void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&ev",
            "0",
            "sizeof(ev)"
          ],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "io_get_fd",
          "args": [
            "io"
          ],
          "line": 85
        },
        "resolved": true,
        "details": {
          "function_name": "io_get_fd",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "137-143",
          "snippet": "int io_get_fd(struct io *io)\n{\n\tif (!io)\n\t\treturn -ENOTCONN;\n\n\treturn g_io_channel_unix_get_fd(io->channel);\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nint io_get_fd(struct io *io)\n{\n\tif (!io)\n\t\treturn -ENOTCONN;\n\n\treturn g_io_channel_unix_get_fd(io->channel);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic bool uhid_read_handler(struct io *io, void *user_data)\n{\n\tstruct bt_uhid *uhid = user_data;\n\tint fd;\n\tssize_t len;\n\tstruct uhid_event ev;\n\n\tfd = io_get_fd(io);\n\tif (fd < 0)\n\t\treturn false;\n\n\tmemset(&ev, 0, sizeof(ev));\n\n\tlen = read(fd, &ev, sizeof(ev));\n\tif (len < 0)\n\t\treturn false;\n\n\tif ((size_t) len < sizeof(ev.type))\n\t\treturn false;\n\n\tqueue_foreach(uhid->notify_list, notify_handler, &ev);\n\n\treturn true;\n}"
  },
  {
    "function_name": "notify_handler",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "66-76",
    "snippet": "static void notify_handler(void *data, void *user_data)\n{\n\tstruct uhid_notify *notify = data;\n\tstruct uhid_event *ev = user_data;\n\n\tif (notify->event != ev->type)\n\t\treturn;\n\n\tif (notify->func)\n\t\tnotify->func(ev, notify->user_data);\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "notify->func",
          "args": [
            "ev",
            "notify->user_data"
          ],
          "line": 75
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void notify_handler(void *data, void *user_data)\n{\n\tstruct uhid_notify *notify = data;\n\tstruct uhid_event *ev = user_data;\n\n\tif (notify->event != ev->type)\n\t\treturn;\n\n\tif (notify->func)\n\t\tnotify->func(ev, notify->user_data);\n}"
  },
  {
    "function_name": "uhid_free",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
    "lines": "55-64",
    "snippet": "static void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}",
    "includes": [
      "#include \"src/shared/uhid.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/io.h\"",
      "#include <fcntl.h>",
      "#include <errno.h>",
      "#include <string.h>",
      "#include <unistd.h>",
      "#include <stdio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "uhid"
          ],
          "line": 63
        },
        "resolved": true,
        "details": {
          "function_name": "uhid_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/uhid.c",
          "lines": "55-64",
          "snippet": "static void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}",
          "note": "cyclic_reference_detected"
        }
      },
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "uhid->notify_list",
            "free"
          ],
          "line": 61
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "io_destroy",
          "args": [
            "uhid->io"
          ],
          "line": 58
        },
        "resolved": true,
        "details": {
          "function_name": "io_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/io-glib.c",
          "lines": "111-135",
          "snippet": "void io_destroy(struct io *io)\n{\n\tif (!io)\n\t\treturn;\n\n\tif (io->read_watch) {\n\t\tg_source_remove(io->read_watch->id);\n\t\tio->read_watch = NULL;\n\t}\n\n\tif (io->write_watch) {\n\t\tg_source_remove(io->write_watch->id);\n\t\tio->write_watch = NULL;\n\t}\n\n\tif (io->disconnect_watch) {\n\t\tg_source_remove(io->disconnect_watch->id);\n\t\tio->disconnect_watch = NULL;\n\t}\n\n\tg_io_channel_unref(io->channel);\n\tio->channel = NULL;\n\n\tio_unref(io);\n}",
          "includes": [
            "#include \"src/shared/io.h\"",
            "#include <glib.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/io.h\"\n#include <glib.h>\n#include <errno.h>\n#include <config.h>\n\nvoid io_destroy(struct io *io)\n{\n\tif (!io)\n\t\treturn;\n\n\tif (io->read_watch) {\n\t\tg_source_remove(io->read_watch->id);\n\t\tio->read_watch = NULL;\n\t}\n\n\tif (io->write_watch) {\n\t\tg_source_remove(io->write_watch->id);\n\t\tio->write_watch = NULL;\n\t}\n\n\tif (io->disconnect_watch) {\n\t\tg_source_remove(io->disconnect_watch->id);\n\t\tio->disconnect_watch = NULL;\n\t}\n\n\tg_io_channel_unref(io->channel);\n\tio->channel = NULL;\n\n\tio_unref(io);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/uhid.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/io.h\"\n#include <fcntl.h>\n#include <errno.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nstatic void uhid_free(struct bt_uhid *uhid)\n{\n\tif (uhid->io)\n\t\tio_destroy(uhid->io);\n\n\tif (uhid->notify_list)\n\t\tqueue_destroy(uhid->notify_list, free);\n\n\tfree(uhid);\n}"
  }
]