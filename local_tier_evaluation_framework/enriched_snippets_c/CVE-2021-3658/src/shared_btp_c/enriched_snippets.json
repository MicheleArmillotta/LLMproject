[
  {
    "function_name": "btp_unregister_service",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "383-387",
    "snippet": "void btp_unregister_service(struct btp *btp, uint8_t service)\n{\n\tl_queue_foreach_remove(btp->handlers, handler_remove_by_service,\n\t\t\t\t\t\t\tL_UINT_TO_PTR(service));\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_queue_foreach_remove",
          "args": [
            "btp->handlers",
            "handler_remove_by_service",
            "L_UINT_TO_PTR(service)"
          ],
          "line": 385
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "L_UINT_TO_PTR",
          "args": [
            "service"
          ],
          "line": 386
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nvoid btp_unregister_service(struct btp *btp, uint8_t service)\n{\n\tl_queue_foreach_remove(btp->handlers, handler_remove_by_service,\n\t\t\t\t\t\t\tL_UINT_TO_PTR(service));\n}"
  },
  {
    "function_name": "handler_remove_by_service",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "368-381",
    "snippet": "static bool handler_remove_by_service(void *a, void *b)\n{\n\tstruct btp_handler *handler = a;\n\tuint8_t service = L_PTR_TO_UINT(b);\n\n\tif (handler->service != service)\n\t\treturn false;\n\n\tif (handler->destroy)\n\t\thandler->destroy(handler->user_data);\n\n\tl_free(handler);\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_free",
          "args": [
            "handler"
          ],
          "line": 379
        },
        "resolved": true,
        "details": {
          "function_name": "channel_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/attrib-server.c",
          "lines": "110-121",
          "snippet": "static void channel_free(struct gatt_channel *channel)\n{\n\n\tif (channel->cleanup_id)\n\t\tg_source_remove(channel->cleanup_id);\n\n\tif (channel->device)\n\t\tbtd_device_unref(channel->device);\n\n\tg_attrib_unref(channel->attrib);\n\tg_free(channel);\n}",
          "includes": [
            "#include \"attrib-server.h\"",
            "#include \"storage.h\"",
            "#include \"textfile.h\"",
            "#include \"attrib/att-database.h\"",
            "#include \"attrib/gatt.h\"",
            "#include \"attrib/att.h\"",
            "#include \"attrib/gattrib.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"device.h\"",
            "#include \"adapter.h\"",
            "#include \"backtrace.h\"",
            "#include \"log.h\"",
            "#include \"btio/btio.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/sdp_lib.h\"",
            "#include \"lib/sdp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <sys/stat.h>",
            "#include <glib.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdbool.h>",
            "#include <stdint.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"attrib-server.h\"\n#include \"storage.h\"\n#include \"textfile.h\"\n#include \"attrib/att-database.h\"\n#include \"attrib/gatt.h\"\n#include \"attrib/att.h\"\n#include \"attrib/gattrib.h\"\n#include \"src/shared/util.h\"\n#include \"device.h\"\n#include \"adapter.h\"\n#include \"backtrace.h\"\n#include \"log.h\"\n#include \"btio/btio.h\"\n#include \"lib/uuid.h\"\n#include \"lib/sdp_lib.h\"\n#include \"lib/sdp.h\"\n#include \"lib/bluetooth.h\"\n#include <sys/stat.h>\n#include <glib.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdbool.h>\n#include <stdint.h>\n#include <errno.h>\n#include <config.h>\n\nstatic void channel_free(struct gatt_channel *channel)\n{\n\n\tif (channel->cleanup_id)\n\t\tg_source_remove(channel->cleanup_id);\n\n\tif (channel->device)\n\t\tbtd_device_unref(channel->device);\n\n\tg_attrib_unref(channel->attrib);\n\tg_free(channel);\n}"
        }
      },
      {
        "call_info": {
          "callee": "handler->destroy",
          "args": [
            "handler->user_data"
          ],
          "line": 377
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "L_PTR_TO_UINT",
          "args": [
            "b"
          ],
          "line": 371
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic bool handler_remove_by_service(void *a, void *b)\n{\n\tstruct btp_handler *handler = a;\n\tuint8_t service = L_PTR_TO_UINT(b);\n\n\tif (handler->service != service)\n\t\treturn false;\n\n\tif (handler->destroy)\n\t\thandler->destroy(handler->user_data);\n\n\tl_free(handler);\n\treturn true;\n}"
  },
  {
    "function_name": "btp_unregister",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "351-366",
    "snippet": "bool btp_unregister(struct btp *btp, unsigned int id)\n{\n\tstruct btp_handler *handler;\n\n\thandler = l_queue_remove_if(btp->handlers, handler_match_by_id,\n\t\t\t\t\t\t\tL_UINT_TO_PTR(id));\n\tif (!handler)\n\t\treturn false;\n\n\tif (handler->destroy)\n\t\thandler->destroy(handler->user_data);\n\n\tl_free(handler);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_free",
          "args": [
            "handler"
          ],
          "line": 363
        },
        "resolved": true,
        "details": {
          "function_name": "channel_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/attrib-server.c",
          "lines": "110-121",
          "snippet": "static void channel_free(struct gatt_channel *channel)\n{\n\n\tif (channel->cleanup_id)\n\t\tg_source_remove(channel->cleanup_id);\n\n\tif (channel->device)\n\t\tbtd_device_unref(channel->device);\n\n\tg_attrib_unref(channel->attrib);\n\tg_free(channel);\n}",
          "includes": [
            "#include \"attrib-server.h\"",
            "#include \"storage.h\"",
            "#include \"textfile.h\"",
            "#include \"attrib/att-database.h\"",
            "#include \"attrib/gatt.h\"",
            "#include \"attrib/att.h\"",
            "#include \"attrib/gattrib.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"device.h\"",
            "#include \"adapter.h\"",
            "#include \"backtrace.h\"",
            "#include \"log.h\"",
            "#include \"btio/btio.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/sdp_lib.h\"",
            "#include \"lib/sdp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <sys/stat.h>",
            "#include <glib.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdbool.h>",
            "#include <stdint.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"attrib-server.h\"\n#include \"storage.h\"\n#include \"textfile.h\"\n#include \"attrib/att-database.h\"\n#include \"attrib/gatt.h\"\n#include \"attrib/att.h\"\n#include \"attrib/gattrib.h\"\n#include \"src/shared/util.h\"\n#include \"device.h\"\n#include \"adapter.h\"\n#include \"backtrace.h\"\n#include \"log.h\"\n#include \"btio/btio.h\"\n#include \"lib/uuid.h\"\n#include \"lib/sdp_lib.h\"\n#include \"lib/sdp.h\"\n#include \"lib/bluetooth.h\"\n#include <sys/stat.h>\n#include <glib.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdbool.h>\n#include <stdint.h>\n#include <errno.h>\n#include <config.h>\n\nstatic void channel_free(struct gatt_channel *channel)\n{\n\n\tif (channel->cleanup_id)\n\t\tg_source_remove(channel->cleanup_id);\n\n\tif (channel->device)\n\t\tbtd_device_unref(channel->device);\n\n\tg_attrib_unref(channel->attrib);\n\tg_free(channel);\n}"
        }
      },
      {
        "call_info": {
          "callee": "handler->destroy",
          "args": [
            "handler->user_data"
          ],
          "line": 361
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_queue_remove_if",
          "args": [
            "btp->handlers",
            "handler_match_by_id",
            "L_UINT_TO_PTR(id)"
          ],
          "line": 355
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "L_UINT_TO_PTR",
          "args": [
            "id"
          ],
          "line": 356
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nbool btp_unregister(struct btp *btp, unsigned int id)\n{\n\tstruct btp_handler *handler;\n\n\thandler = l_queue_remove_if(btp->handlers, handler_match_by_id,\n\t\t\t\t\t\t\tL_UINT_TO_PTR(id));\n\tif (!handler)\n\t\treturn false;\n\n\tif (handler->destroy)\n\t\thandler->destroy(handler->user_data);\n\n\tl_free(handler);\n\n\treturn true;\n}"
  },
  {
    "function_name": "handler_match_by_id",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "343-349",
    "snippet": "static bool handler_match_by_id(const void *a, const void *b)\n{\n\tconst struct btp_handler *handler = a;\n\tunsigned int id = L_PTR_TO_UINT(b);\n\n\treturn handler->id == id;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "L_PTR_TO_UINT",
          "args": [
            "b"
          ],
          "line": 346
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic bool handler_match_by_id(const void *a, const void *b)\n{\n\tconst struct btp_handler *handler = a;\n\tunsigned int id = L_PTR_TO_UINT(b);\n\n\treturn handler->id == id;\n}"
  },
  {
    "function_name": "btp_register",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "323-341",
    "snippet": "unsigned int btp_register(struct btp *btp, uint8_t service, uint8_t opcode,\n\t\t\t\tbtp_cmd_func_t callback, void *user_data,\n\t\t\t\tbtp_destroy_func_t destroy)\n{\n\tstruct btp_handler *handler;\n\n\thandler = l_new(struct btp_handler, 1);\n\n\thandler->id = btp->next_handler++;\n\thandler->service = service;\n\thandler->opcode = opcode;\n\thandler->callback = callback;\n\thandler->user_data = user_data;\n\thandler->destroy = destroy;\n\n\tl_queue_push_tail(btp->handlers, handler);\n\n\treturn handler->id;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_queue_push_tail",
          "args": [
            "btp->handlers",
            "handler"
          ],
          "line": 338
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_new",
          "args": [
            "structbtp_handler",
            "1"
          ],
          "line": 329
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nunsigned int btp_register(struct btp *btp, uint8_t service, uint8_t opcode,\n\t\t\t\tbtp_cmd_func_t callback, void *user_data,\n\t\t\t\tbtp_destroy_func_t destroy)\n{\n\tstruct btp_handler *handler;\n\n\thandler = l_new(struct btp_handler, 1);\n\n\thandler->id = btp->next_handler++;\n\thandler->service = service;\n\thandler->opcode = opcode;\n\thandler->callback = callback;\n\thandler->user_data = user_data;\n\thandler->destroy = destroy;\n\n\tl_queue_push_tail(btp->handlers, handler);\n\n\treturn handler->id;\n}"
  },
  {
    "function_name": "btp_send",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "290-321",
    "snippet": "bool btp_send(struct btp *btp, uint8_t service, uint8_t opcode, uint8_t index,\n\t\t\t\t\tuint16_t length, const void *param)\n{\n\tstruct btp_hdr *hdr;\n\tstruct pending_message *msg;\n\tsize_t len;\n\n\tif (!btp)\n\t\treturn false;\n\n\tlen = sizeof(*hdr) + length;\n\thdr = l_malloc(len);\n\tif (!hdr)\n\t\treturn false;\n\n\thdr->service = service;\n\thdr->opcode = opcode;\n\thdr->index = index;\n\thdr->data_len = L_CPU_TO_LE16(length);\n\tif (length)\n\t\tmemcpy(hdr->data, param, length);\n\n\tmsg = l_new(struct pending_message, 1);\n\tmsg->len = len;\n\tmsg->data = hdr;\n\tmsg->wakeup_read = opcode < 0x80;\n\n\tl_queue_push_tail(btp->pending, msg);\n\twakeup_writer(btp);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "wakeup_writer",
          "args": [
            "btp"
          ],
          "line": 318
        },
        "resolved": true,
        "details": {
          "function_name": "wakeup_writer",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
          "lines": "268-278",
          "snippet": "static void wakeup_writer(struct btp *btp)\n{\n\tif (l_queue_isempty(btp->pending))\n\t\treturn;\n\n\tif (btp->writer_active)\n\t\treturn;\n\n\tbtp->writer_active = l_io_set_write_handler(btp->io, can_write_data,\n\t\t\t\t\t\tbtp, write_watch_destroy);\n}",
          "includes": [
            "#include \"src/shared/btp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <ell/ell.h>",
            "#include <unistd.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdbool.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void wakeup_writer(struct btp *btp)\n{\n\tif (l_queue_isempty(btp->pending))\n\t\treturn;\n\n\tif (btp->writer_active)\n\t\treturn;\n\n\tbtp->writer_active = l_io_set_write_handler(btp->io, can_write_data,\n\t\t\t\t\t\tbtp, write_watch_destroy);\n}"
        }
      },
      {
        "call_info": {
          "callee": "l_queue_push_tail",
          "args": [
            "btp->pending",
            "msg"
          ],
          "line": 317
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_new",
          "args": [
            "structpending_message",
            "1"
          ],
          "line": 312
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "hdr->data",
            "param",
            "length"
          ],
          "line": 310
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "L_CPU_TO_LE16",
          "args": [
            "length"
          ],
          "line": 308
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_malloc",
          "args": [
            "len"
          ],
          "line": 301
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nbool btp_send(struct btp *btp, uint8_t service, uint8_t opcode, uint8_t index,\n\t\t\t\t\tuint16_t length, const void *param)\n{\n\tstruct btp_hdr *hdr;\n\tstruct pending_message *msg;\n\tsize_t len;\n\n\tif (!btp)\n\t\treturn false;\n\n\tlen = sizeof(*hdr) + length;\n\thdr = l_malloc(len);\n\tif (!hdr)\n\t\treturn false;\n\n\thdr->service = service;\n\thdr->opcode = opcode;\n\thdr->index = index;\n\thdr->data_len = L_CPU_TO_LE16(length);\n\tif (length)\n\t\tmemcpy(hdr->data, param, length);\n\n\tmsg = l_new(struct pending_message, 1);\n\tmsg->len = len;\n\tmsg->data = hdr;\n\tmsg->wakeup_read = opcode < 0x80;\n\n\tl_queue_push_tail(btp->pending, msg);\n\twakeup_writer(btp);\n\n\treturn true;\n}"
  },
  {
    "function_name": "btp_send_error",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "280-288",
    "snippet": "bool btp_send_error(struct btp *btp, uint8_t service, uint8_t index,\n\t\t\t\t\t\t\t\tuint8_t status)\n{\n\tstruct btp_error rsp;\n\n\trsp.status = status;\n\n\treturn btp_send(btp, service, BTP_OP_ERROR, index, sizeof(rsp), &rsp);\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "btp_send",
          "args": [
            "btp",
            "service",
            "BTP_OP_ERROR",
            "index",
            "sizeof(rsp)",
            "&rsp"
          ],
          "line": 287
        },
        "resolved": true,
        "details": {
          "function_name": "btp_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
          "lines": "290-321",
          "snippet": "bool btp_send(struct btp *btp, uint8_t service, uint8_t opcode, uint8_t index,\n\t\t\t\t\tuint16_t length, const void *param)\n{\n\tstruct btp_hdr *hdr;\n\tstruct pending_message *msg;\n\tsize_t len;\n\n\tif (!btp)\n\t\treturn false;\n\n\tlen = sizeof(*hdr) + length;\n\thdr = l_malloc(len);\n\tif (!hdr)\n\t\treturn false;\n\n\thdr->service = service;\n\thdr->opcode = opcode;\n\thdr->index = index;\n\thdr->data_len = L_CPU_TO_LE16(length);\n\tif (length)\n\t\tmemcpy(hdr->data, param, length);\n\n\tmsg = l_new(struct pending_message, 1);\n\tmsg->len = len;\n\tmsg->data = hdr;\n\tmsg->wakeup_read = opcode < 0x80;\n\n\tl_queue_push_tail(btp->pending, msg);\n\twakeup_writer(btp);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/btp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <ell/ell.h>",
            "#include <unistd.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdbool.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nbool btp_send(struct btp *btp, uint8_t service, uint8_t opcode, uint8_t index,\n\t\t\t\t\tuint16_t length, const void *param)\n{\n\tstruct btp_hdr *hdr;\n\tstruct pending_message *msg;\n\tsize_t len;\n\n\tif (!btp)\n\t\treturn false;\n\n\tlen = sizeof(*hdr) + length;\n\thdr = l_malloc(len);\n\tif (!hdr)\n\t\treturn false;\n\n\thdr->service = service;\n\thdr->opcode = opcode;\n\thdr->index = index;\n\thdr->data_len = L_CPU_TO_LE16(length);\n\tif (length)\n\t\tmemcpy(hdr->data, param, length);\n\n\tmsg = l_new(struct pending_message, 1);\n\tmsg->len = len;\n\tmsg->data = hdr;\n\tmsg->wakeup_read = opcode < 0x80;\n\n\tl_queue_push_tail(btp->pending, msg);\n\twakeup_writer(btp);\n\n\treturn true;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nbool btp_send_error(struct btp *btp, uint8_t service, uint8_t index,\n\t\t\t\t\t\t\t\tuint8_t status)\n{\n\tstruct btp_error rsp;\n\n\trsp.status = status;\n\n\treturn btp_send(btp, service, BTP_OP_ERROR, index, sizeof(rsp), &rsp);\n}"
  },
  {
    "function_name": "wakeup_writer",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "268-278",
    "snippet": "static void wakeup_writer(struct btp *btp)\n{\n\tif (l_queue_isempty(btp->pending))\n\t\treturn;\n\n\tif (btp->writer_active)\n\t\treturn;\n\n\tbtp->writer_active = l_io_set_write_handler(btp->io, can_write_data,\n\t\t\t\t\t\tbtp, write_watch_destroy);\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_io_set_write_handler",
          "args": [
            "btp->io",
            "can_write_data",
            "btp",
            "write_watch_destroy"
          ],
          "line": 276
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_queue_isempty",
          "args": [
            "btp->pending"
          ],
          "line": 270
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void wakeup_writer(struct btp *btp)\n{\n\tif (l_queue_isempty(btp->pending))\n\t\treturn;\n\n\tif (btp->writer_active)\n\t\treturn;\n\n\tbtp->writer_active = l_io_set_write_handler(btp->io, can_write_data,\n\t\t\t\t\t\tbtp, write_watch_destroy);\n}"
  },
  {
    "function_name": "write_watch_destroy",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "261-266",
    "snippet": "static void write_watch_destroy(void *user_data)\n{\n\tstruct btp *btp = user_data;\n\n\tbtp->writer_active = false;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void write_watch_destroy(void *user_data)\n{\n\tstruct btp *btp = user_data;\n\n\tbtp->writer_active = false;\n}"
  },
  {
    "function_name": "can_write_data",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "238-259",
    "snippet": "static bool can_write_data(struct l_io *io, void *user_data)\n{\n\tstruct btp *btp = user_data;\n\tstruct pending_message *msg;\n\n\tmsg = l_queue_pop_head(btp->pending);\n\tif (!msg)\n\t\treturn false;\n\n\tif (msg->wakeup_read)\n\t\twakeup_reader(btp);\n\n\tif (write(l_io_get_fd(btp->io), msg->data, msg->len) < 0) {\n\t\tl_error(\"Failed to send BTP message\");\n\t\tdestroy_message(msg);\n\t\treturn false;\n\t}\n\n\tdestroy_message(msg);\n\n\treturn !l_queue_isempty(btp->pending);\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_queue_isempty",
          "args": [
            "btp->pending"
          ],
          "line": 258
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "destroy_message",
          "args": [
            "msg"
          ],
          "line": 256
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_message",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
          "lines": "202-206",
          "snippet": "static void destroy_message(struct pending_message *msg)\n{\n\tl_free(msg->data);\n\tl_free(msg);\n}",
          "includes": [
            "#include \"src/shared/btp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <ell/ell.h>",
            "#include <unistd.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdbool.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void destroy_message(struct pending_message *msg)\n{\n\tl_free(msg->data);\n\tl_free(msg);\n}"
        }
      },
      {
        "call_info": {
          "callee": "l_error",
          "args": [
            "\"Failed to send BTP message\""
          ],
          "line": 251
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "write",
          "args": [
            "l_io_get_fd(btp->io)",
            "msg->data",
            "msg->len"
          ],
          "line": 250
        },
        "resolved": true,
        "details": {
          "function_name": "notify_data_write_ccc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1324-1355",
          "snippet": "static bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic bool notify_data_write_ccc(struct notify_data *notify_data, bool enable,\n\t\t\t\t\t\tbt_att_response_func_t callback)\n{\n\tuint8_t pdu[4];\n\tunsigned int att_id;\n\n\tassert(notify_data->chrc->ccc_handle);\n\tmemset(pdu, 0, sizeof(pdu));\n\tput_le16(notify_data->chrc->ccc_handle, pdu);\n\n\tif (enable) {\n\t\t/* Try to enable notifications and/or indications based on\n\t\t * whatever the characteristic supports.\n\t\t */\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_NOTIFY)\n\t\t\tpdu[2] = 0x01;\n\n\t\tif (notify_data->chrc->properties & BT_GATT_CHRC_PROP_INDICATE)\n\t\t\tpdu[2] |= 0x02;\n\n\t\tif (!pdu[2])\n\t\t\treturn false;\n\t}\n\n\tatt_id = bt_att_send(notify_data->client->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\tpdu, sizeof(pdu), callback,\n\t\t\t\t\t\tnotify_data_ref(notify_data),\n\t\t\t\t\t\tnotify_data_unref);\n\tnotify_data->chrc->ccc_write_id = notify_data->att_id = att_id;\n\n\treturn !!att_id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "l_io_get_fd",
          "args": [
            "btp->io"
          ],
          "line": 250
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "wakeup_reader",
          "args": [
            "btp"
          ],
          "line": 248
        },
        "resolved": true,
        "details": {
          "function_name": "wakeup_reader",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
          "lines": "167-174",
          "snippet": "static void wakeup_reader(struct btp *btp)\n{\n\tif (btp->reader_active)\n\t\treturn;\n\n\tbtp->reader_active = l_io_set_read_handler(btp->io, can_read_data, btp,\n\t\t\t\t\t\t\tread_watch_destroy);\n}",
          "includes": [
            "#include \"src/shared/btp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <ell/ell.h>",
            "#include <unistd.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdbool.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void wakeup_reader(struct btp *btp)\n{\n\tif (btp->reader_active)\n\t\treturn;\n\n\tbtp->reader_active = l_io_set_read_handler(btp->io, can_read_data, btp,\n\t\t\t\t\t\t\tread_watch_destroy);\n}"
        }
      },
      {
        "call_info": {
          "callee": "l_queue_pop_head",
          "args": [
            "btp->pending"
          ],
          "line": 243
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic bool can_write_data(struct l_io *io, void *user_data)\n{\n\tstruct btp *btp = user_data;\n\tstruct pending_message *msg;\n\n\tmsg = l_queue_pop_head(btp->pending);\n\tif (!msg)\n\t\treturn false;\n\n\tif (msg->wakeup_read)\n\t\twakeup_reader(btp);\n\n\tif (write(l_io_get_fd(btp->io), msg->data, msg->len) < 0) {\n\t\tl_error(\"Failed to send BTP message\");\n\t\tdestroy_message(msg);\n\t\treturn false;\n\t}\n\n\tdestroy_message(msg);\n\n\treturn !l_queue_isempty(btp->pending);\n}"
  },
  {
    "function_name": "btp_set_disconnect_handler",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "219-236",
    "snippet": "bool btp_set_disconnect_handler(struct btp *btp, btp_disconnect_func_t callback,\n\t\t\t\tvoid *user_data, btp_destroy_func_t destroy)\n{\n\tif (callback) {\n\t\tif (!l_io_set_disconnect_handler(btp->io, disconnect_handler,\n\t\t\t\t\tbtp, disconnect_handler_destroy))\n\t\t\treturn false;\n\t} else {\n\t\tif (!l_io_set_disconnect_handler(btp->io, NULL, NULL, NULL))\n\t\t\treturn false;\n\t}\n\n\tbtp->disconnect_cb = callback;\n\tbtp->disconnect_cb_data = user_data;\n\tbtp->disconnect_cb_data_destroy = destroy;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_io_set_disconnect_handler",
          "args": [
            "btp->io",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 227
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_io_set_disconnect_handler",
          "args": [
            "btp->io",
            "disconnect_handler",
            "btp",
            "disconnect_handler_destroy"
          ],
          "line": 223
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nbool btp_set_disconnect_handler(struct btp *btp, btp_disconnect_func_t callback,\n\t\t\t\tvoid *user_data, btp_destroy_func_t destroy)\n{\n\tif (callback) {\n\t\tif (!l_io_set_disconnect_handler(btp->io, disconnect_handler,\n\t\t\t\t\tbtp, disconnect_handler_destroy))\n\t\t\treturn false;\n\t} else {\n\t\tif (!l_io_set_disconnect_handler(btp->io, NULL, NULL, NULL))\n\t\t\treturn false;\n\t}\n\n\tbtp->disconnect_cb = callback;\n\tbtp->disconnect_cb_data = user_data;\n\tbtp->disconnect_cb_data_destroy = destroy;\n\n\treturn true;\n}"
  },
  {
    "function_name": "btp_cleanup",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "208-217",
    "snippet": "void btp_cleanup(struct btp *btp)\n{\n\tif (!btp)\n\t\treturn;\n\n\tl_io_destroy(btp->io);\n\tl_queue_destroy(btp->pending, (l_queue_destroy_func_t)destroy_message);\n\tl_queue_destroy(btp->handlers, (l_queue_destroy_func_t)l_free);\n\tl_free(btp);\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_free",
          "args": [
            "btp"
          ],
          "line": 216
        },
        "resolved": true,
        "details": {
          "function_name": "channel_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/attrib-server.c",
          "lines": "110-121",
          "snippet": "static void channel_free(struct gatt_channel *channel)\n{\n\n\tif (channel->cleanup_id)\n\t\tg_source_remove(channel->cleanup_id);\n\n\tif (channel->device)\n\t\tbtd_device_unref(channel->device);\n\n\tg_attrib_unref(channel->attrib);\n\tg_free(channel);\n}",
          "includes": [
            "#include \"attrib-server.h\"",
            "#include \"storage.h\"",
            "#include \"textfile.h\"",
            "#include \"attrib/att-database.h\"",
            "#include \"attrib/gatt.h\"",
            "#include \"attrib/att.h\"",
            "#include \"attrib/gattrib.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"device.h\"",
            "#include \"adapter.h\"",
            "#include \"backtrace.h\"",
            "#include \"log.h\"",
            "#include \"btio/btio.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/sdp_lib.h\"",
            "#include \"lib/sdp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <sys/stat.h>",
            "#include <glib.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdbool.h>",
            "#include <stdint.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"attrib-server.h\"\n#include \"storage.h\"\n#include \"textfile.h\"\n#include \"attrib/att-database.h\"\n#include \"attrib/gatt.h\"\n#include \"attrib/att.h\"\n#include \"attrib/gattrib.h\"\n#include \"src/shared/util.h\"\n#include \"device.h\"\n#include \"adapter.h\"\n#include \"backtrace.h\"\n#include \"log.h\"\n#include \"btio/btio.h\"\n#include \"lib/uuid.h\"\n#include \"lib/sdp_lib.h\"\n#include \"lib/sdp.h\"\n#include \"lib/bluetooth.h\"\n#include <sys/stat.h>\n#include <glib.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdbool.h>\n#include <stdint.h>\n#include <errno.h>\n#include <config.h>\n\nstatic void channel_free(struct gatt_channel *channel)\n{\n\n\tif (channel->cleanup_id)\n\t\tg_source_remove(channel->cleanup_id);\n\n\tif (channel->device)\n\t\tbtd_device_unref(channel->device);\n\n\tg_attrib_unref(channel->attrib);\n\tg_free(channel);\n}"
        }
      },
      {
        "call_info": {
          "callee": "l_queue_destroy",
          "args": [
            "btp->handlers",
            "(l_queue_destroy_func_t)l_free"
          ],
          "line": 215
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_queue_destroy",
          "args": [
            "btp->pending",
            "(l_queue_destroy_func_t)destroy_message"
          ],
          "line": 214
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_io_destroy",
          "args": [
            "btp->io"
          ],
          "line": 213
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nvoid btp_cleanup(struct btp *btp)\n{\n\tif (!btp)\n\t\treturn;\n\n\tl_io_destroy(btp->io);\n\tl_queue_destroy(btp->pending, (l_queue_destroy_func_t)destroy_message);\n\tl_queue_destroy(btp->handlers, (l_queue_destroy_func_t)l_free);\n\tl_free(btp);\n}"
  },
  {
    "function_name": "destroy_message",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "202-206",
    "snippet": "static void destroy_message(struct pending_message *msg)\n{\n\tl_free(msg->data);\n\tl_free(msg);\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_free",
          "args": [
            "msg"
          ],
          "line": 205
        },
        "resolved": true,
        "details": {
          "function_name": "channel_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/attrib-server.c",
          "lines": "110-121",
          "snippet": "static void channel_free(struct gatt_channel *channel)\n{\n\n\tif (channel->cleanup_id)\n\t\tg_source_remove(channel->cleanup_id);\n\n\tif (channel->device)\n\t\tbtd_device_unref(channel->device);\n\n\tg_attrib_unref(channel->attrib);\n\tg_free(channel);\n}",
          "includes": [
            "#include \"attrib-server.h\"",
            "#include \"storage.h\"",
            "#include \"textfile.h\"",
            "#include \"attrib/att-database.h\"",
            "#include \"attrib/gatt.h\"",
            "#include \"attrib/att.h\"",
            "#include \"attrib/gattrib.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"device.h\"",
            "#include \"adapter.h\"",
            "#include \"backtrace.h\"",
            "#include \"log.h\"",
            "#include \"btio/btio.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/sdp_lib.h\"",
            "#include \"lib/sdp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <sys/stat.h>",
            "#include <glib.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdbool.h>",
            "#include <stdint.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"attrib-server.h\"\n#include \"storage.h\"\n#include \"textfile.h\"\n#include \"attrib/att-database.h\"\n#include \"attrib/gatt.h\"\n#include \"attrib/att.h\"\n#include \"attrib/gattrib.h\"\n#include \"src/shared/util.h\"\n#include \"device.h\"\n#include \"adapter.h\"\n#include \"backtrace.h\"\n#include \"log.h\"\n#include \"btio/btio.h\"\n#include \"lib/uuid.h\"\n#include \"lib/sdp_lib.h\"\n#include \"lib/sdp.h\"\n#include \"lib/bluetooth.h\"\n#include <sys/stat.h>\n#include <glib.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdbool.h>\n#include <stdint.h>\n#include <errno.h>\n#include <config.h>\n\nstatic void channel_free(struct gatt_channel *channel)\n{\n\n\tif (channel->cleanup_id)\n\t\tg_source_remove(channel->cleanup_id);\n\n\tif (channel->device)\n\t\tbtd_device_unref(channel->device);\n\n\tg_attrib_unref(channel->attrib);\n\tg_free(channel);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void destroy_message(struct pending_message *msg)\n{\n\tl_free(msg->data);\n\tl_free(msg);\n}"
  },
  {
    "function_name": "btp_new",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "176-194",
    "snippet": "struct btp *btp_new(const char *path)\n{\n\tstruct btp *btp;\n\tstruct l_io *io;\n\n\tio = btp_connect(path);\n\tif (!io)\n\t\treturn NULL;\n\n\tbtp = l_new(struct btp, 1);\n\tbtp->pending = l_queue_new();\n\tbtp->handlers = l_queue_new();\n\tbtp->io = io;\n\tbtp->next_handler = 1;\n\n\twakeup_reader(btp);\n\n\treturn btp;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "wakeup_reader",
          "args": [
            "btp"
          ],
          "line": 191
        },
        "resolved": true,
        "details": {
          "function_name": "wakeup_reader",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
          "lines": "167-174",
          "snippet": "static void wakeup_reader(struct btp *btp)\n{\n\tif (btp->reader_active)\n\t\treturn;\n\n\tbtp->reader_active = l_io_set_read_handler(btp->io, can_read_data, btp,\n\t\t\t\t\t\t\tread_watch_destroy);\n}",
          "includes": [
            "#include \"src/shared/btp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <ell/ell.h>",
            "#include <unistd.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdbool.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void wakeup_reader(struct btp *btp)\n{\n\tif (btp->reader_active)\n\t\treturn;\n\n\tbtp->reader_active = l_io_set_read_handler(btp->io, can_read_data, btp,\n\t\t\t\t\t\t\tread_watch_destroy);\n}"
        }
      },
      {
        "call_info": {
          "callee": "l_queue_new",
          "args": [],
          "line": 187
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_queue_new",
          "args": [],
          "line": 186
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_new",
          "args": [
            "structbtp",
            "1"
          ],
          "line": 185
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "btp_connect",
          "args": [
            "path"
          ],
          "line": 181
        },
        "resolved": true,
        "details": {
          "function_name": "btp_connect",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
          "lines": "64-91",
          "snippet": "static struct l_io *btp_connect(const char *path)\n{\n\tstruct sockaddr_un addr;\n\tstruct l_io *io;\n\tint sk;\n\n\tsk = socket(AF_UNIX, SOCK_STREAM | SOCK_NONBLOCK, 0);\n\tif (sk < 0)\n\t\treturn NULL;\n\n\tmemset(&addr, 0, sizeof(addr));\n\taddr.sun_family = AF_UNIX;\n\tstrncpy(addr.sun_path, path, sizeof(addr.sun_path) - 1);\n\n\tif (connect(sk, (struct sockaddr *) &addr, sizeof(addr)) < 0) {\n\t\tclose(sk);\n\t\treturn NULL;\n\t}\n\n\tio = l_io_new(sk);\n\tif (!io) {\n\t\tclose(sk);\n\t\treturn NULL;\n\t}\n\n\tl_io_set_close_on_destroy(io, true);\n\treturn io;\n}",
          "includes": [
            "#include \"src/shared/btp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <ell/ell.h>",
            "#include <unistd.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdbool.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic struct l_io *btp_connect(const char *path)\n{\n\tstruct sockaddr_un addr;\n\tstruct l_io *io;\n\tint sk;\n\n\tsk = socket(AF_UNIX, SOCK_STREAM | SOCK_NONBLOCK, 0);\n\tif (sk < 0)\n\t\treturn NULL;\n\n\tmemset(&addr, 0, sizeof(addr));\n\taddr.sun_family = AF_UNIX;\n\tstrncpy(addr.sun_path, path, sizeof(addr.sun_path) - 1);\n\n\tif (connect(sk, (struct sockaddr *) &addr, sizeof(addr)) < 0) {\n\t\tclose(sk);\n\t\treturn NULL;\n\t}\n\n\tio = l_io_new(sk);\n\tif (!io) {\n\t\tclose(sk);\n\t\treturn NULL;\n\t}\n\n\tl_io_set_close_on_destroy(io, true);\n\treturn io;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstruct btp *btp_new(const char *path)\n{\n\tstruct btp *btp;\n\tstruct l_io *io;\n\n\tio = btp_connect(path);\n\tif (!io)\n\t\treturn NULL;\n\n\tbtp = l_new(struct btp, 1);\n\tbtp->pending = l_queue_new();\n\tbtp->handlers = l_queue_new();\n\tbtp->io = io;\n\tbtp->next_handler = 1;\n\n\twakeup_reader(btp);\n\n\treturn btp;\n}"
  },
  {
    "function_name": "wakeup_reader",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "167-174",
    "snippet": "static void wakeup_reader(struct btp *btp)\n{\n\tif (btp->reader_active)\n\t\treturn;\n\n\tbtp->reader_active = l_io_set_read_handler(btp->io, can_read_data, btp,\n\t\t\t\t\t\t\tread_watch_destroy);\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_io_set_read_handler",
          "args": [
            "btp->io",
            "can_read_data",
            "btp",
            "read_watch_destroy"
          ],
          "line": 172
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void wakeup_reader(struct btp *btp)\n{\n\tif (btp->reader_active)\n\t\treturn;\n\n\tbtp->reader_active = l_io_set_read_handler(btp->io, can_read_data, btp,\n\t\t\t\t\t\t\tread_watch_destroy);\n}"
  },
  {
    "function_name": "read_watch_destroy",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "160-165",
    "snippet": "static void read_watch_destroy(void *user_data)\n{\n\tstruct btp *btp = user_data;\n\n\tbtp->reader_active = false;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void read_watch_destroy(void *user_data)\n{\n\tstruct btp *btp = user_data;\n\n\tbtp->reader_active = false;\n}"
  },
  {
    "function_name": "can_read_data",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "122-158",
    "snippet": "static bool can_read_data(struct l_io *io, void *user_data)\n{\n\tstruct handler_match_data match;\n\tstruct btp *btp = user_data;\n\tstruct btp_handler *handler;\n\tstruct btp_hdr *hdr;\n\tssize_t bytes_read;\n\tuint16_t data_len;\n\n\tbytes_read = read(l_io_get_fd(btp->io), btp->buf, sizeof(btp->buf));\n\tif (bytes_read < 0)\n\t\treturn false;\n\n\tif ((size_t) bytes_read < sizeof(*hdr))\n\t\treturn false;\n\n\thdr = (void *)btp->buf;\n\n\tdata_len = L_LE16_TO_CPU(hdr->data_len);\n\n\tif ((size_t) bytes_read < sizeof(*hdr) + data_len)\n\t\treturn false;\n\n\tmatch.service = hdr->service;\n\tmatch.opcode = hdr->opcode;\n\n\thandler = l_queue_find(btp->handlers, handler_match, &match);\n\tif (handler) {\n\t\thandler->callback(hdr->index, hdr->data, data_len,\n\t\t\t\t\t\t\thandler->user_data);\n\t\treturn false;\n\t}\n\n\t/* keep reader active if we sent error reply */\n\tbtp_send_error(btp, match.service, hdr->index, BTP_ERROR_UNKNOWN_CMD);\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "btp_send_error",
          "args": [
            "btp",
            "match.service",
            "hdr->index",
            "BTP_ERROR_UNKNOWN_CMD"
          ],
          "line": 156
        },
        "resolved": true,
        "details": {
          "function_name": "btp_send_error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
          "lines": "280-288",
          "snippet": "bool btp_send_error(struct btp *btp, uint8_t service, uint8_t index,\n\t\t\t\t\t\t\t\tuint8_t status)\n{\n\tstruct btp_error rsp;\n\n\trsp.status = status;\n\n\treturn btp_send(btp, service, BTP_OP_ERROR, index, sizeof(rsp), &rsp);\n}",
          "includes": [
            "#include \"src/shared/btp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <ell/ell.h>",
            "#include <unistd.h>",
            "#include <sys/un.h>",
            "#include <sys/socket.h>",
            "#include <stdbool.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nbool btp_send_error(struct btp *btp, uint8_t service, uint8_t index,\n\t\t\t\t\t\t\t\tuint8_t status)\n{\n\tstruct btp_error rsp;\n\n\trsp.status = status;\n\n\treturn btp_send(btp, service, BTP_OP_ERROR, index, sizeof(rsp), &rsp);\n}"
        }
      },
      {
        "call_info": {
          "callee": "handler->callback",
          "args": [
            "hdr->index",
            "hdr->data",
            "data_len",
            "handler->user_data"
          ],
          "line": 150
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "l_queue_find",
          "args": [
            "btp->handlers",
            "handler_match",
            "&match"
          ],
          "line": 148
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "L_LE16_TO_CPU",
          "args": [
            "hdr->data_len"
          ],
          "line": 140
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "read",
          "args": [
            "l_io_get_fd(btp->io)",
            "btp->buf",
            "sizeof(btp->buf)"
          ],
          "line": 131
        },
        "resolved": true,
        "details": {
          "function_name": "notify_client_ready",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-client.c",
          "lines": "1221-1250",
          "snippet": "static void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}",
          "includes": [
            "#include <sys/uio.h>",
            "#include <limits.h>",
            "#include <assert.h>",
            "#include \"src/shared/gatt-client.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/uio.h>\n#include <limits.h>\n#include <assert.h>\n#include \"src/shared/gatt-client.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <config.h>\n\nstatic void notify_client_ready(struct bt_gatt_client *client, bool success,\n\t\t\t\t\t\t\tuint8_t att_ecode)\n{\n\tconst struct queue_entry *entry;\n\n\tif (client->ready)\n\t\treturn;\n\n\tbt_gatt_client_ref(client);\n\tclient->ready = success;\n\n\tfor (entry = queue_get_entries(client->ready_cbs); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct ready_cb *ready = entry->data;\n\n\t\tready->callback(success, att_ecode, ready->data);\n\t}\n\n\tqueue_remove_all(client->ready_cbs, NULL, NULL, ready_destroy);\n\n\t/* Notify clones */\n\tfor (entry = queue_get_entries(client->clones); entry;\n\t\t\t\t\t\t\tentry = entry->next) {\n\t\tstruct bt_gatt_client *clone = entry->data;\n\n\t\tnotify_client_ready(clone, success, att_ecode);\n\t}\n\n\tbt_gatt_client_unref(client);\n}"
        }
      },
      {
        "call_info": {
          "callee": "l_io_get_fd",
          "args": [
            "btp->io"
          ],
          "line": 131
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic bool can_read_data(struct l_io *io, void *user_data)\n{\n\tstruct handler_match_data match;\n\tstruct btp *btp = user_data;\n\tstruct btp_handler *handler;\n\tstruct btp_hdr *hdr;\n\tssize_t bytes_read;\n\tuint16_t data_len;\n\n\tbytes_read = read(l_io_get_fd(btp->io), btp->buf, sizeof(btp->buf));\n\tif (bytes_read < 0)\n\t\treturn false;\n\n\tif ((size_t) bytes_read < sizeof(*hdr))\n\t\treturn false;\n\n\thdr = (void *)btp->buf;\n\n\tdata_len = L_LE16_TO_CPU(hdr->data_len);\n\n\tif ((size_t) bytes_read < sizeof(*hdr) + data_len)\n\t\treturn false;\n\n\tmatch.service = hdr->service;\n\tmatch.opcode = hdr->opcode;\n\n\thandler = l_queue_find(btp->handlers, handler_match, &match);\n\tif (handler) {\n\t\thandler->callback(hdr->index, hdr->data, data_len,\n\t\t\t\t\t\t\thandler->user_data);\n\t\treturn false;\n\t}\n\n\t/* keep reader active if we sent error reply */\n\tbtp_send_error(btp, match.service, hdr->index, BTP_ERROR_UNKNOWN_CMD);\n\treturn true;\n}"
  },
  {
    "function_name": "handler_match",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "113-120",
    "snippet": "static bool handler_match(const void *a, const void *b)\n{\n\tconst struct btp_handler *handler = a;\n\tconst struct handler_match_data *match = b;\n\n\treturn (handler->service == match->service) &&\n\t\t\t\t\t(handler->opcode == match->opcode);\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic bool handler_match(const void *a, const void *b)\n{\n\tconst struct btp_handler *handler = a;\n\tconst struct handler_match_data *match = b;\n\n\treturn (handler->service == match->service) &&\n\t\t\t\t\t(handler->opcode == match->opcode);\n}"
  },
  {
    "function_name": "disconnect_handler_destroy",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "100-106",
    "snippet": "static void disconnect_handler_destroy(void *user_data)\n{\n\tstruct btp *btp = user_data;\n\n\tif (btp->disconnect_cb_data_destroy)\n\t\tbtp->disconnect_cb_data_destroy(btp->disconnect_cb_data);\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "btp->disconnect_cb_data_destroy",
          "args": [
            "btp->disconnect_cb_data"
          ],
          "line": 105
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void disconnect_handler_destroy(void *user_data)\n{\n\tstruct btp *btp = user_data;\n\n\tif (btp->disconnect_cb_data_destroy)\n\t\tbtp->disconnect_cb_data_destroy(btp->disconnect_cb_data);\n}"
  },
  {
    "function_name": "disconnect_handler",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "93-98",
    "snippet": "static void disconnect_handler(struct l_io *io, void *user_data)\n{\n\tstruct btp *btp = user_data;\n\n\tbtp->disconnect_cb(btp, btp->disconnect_cb_data);\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "btp->disconnect_cb",
          "args": [
            "btp",
            "btp->disconnect_cb_data"
          ],
          "line": 97
        },
        "resolved": true,
        "details": {
          "function_name": "disconnect_cb",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "552-597",
          "snippet": "static bool disconnect_cb(struct io *io, void *user_data)\n{\n\tstruct bt_att *att = user_data;\n\tint err;\n\tsocklen_t len;\n\n\tlen = sizeof(err);\n\n\tif (getsockopt(att->fd, SOL_SOCKET, SO_ERROR, &err, &len) < 0) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Failed to obtain disconnect error: %s\",\n\t\t\t\t\tstrerror(errno));\n\t\terr = 0;\n\t}\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Physical link disconnected: %s\",\n\t\t\t\t\tstrerror(err));\n\n\tio_destroy(att->io);\n\tatt->io = NULL;\n\n\t/* Notify request callbacks */\n\tqueue_remove_all(att->req_queue, NULL, NULL, disc_att_send_op);\n\tqueue_remove_all(att->ind_queue, NULL, NULL, disc_att_send_op);\n\tqueue_remove_all(att->write_queue, NULL, NULL, disc_att_send_op);\n\n\tif (att->pending_req) {\n\t\tdisc_att_send_op(att->pending_req);\n\t\tatt->pending_req = NULL;\n\t}\n\n\tif (att->pending_ind) {\n\t\tdisc_att_send_op(att->pending_ind);\n\t\tatt->pending_ind = NULL;\n\t}\n\n\tbt_att_ref(att);\n\n\tqueue_foreach(att->disconn_list, disconn_handler, INT_TO_PTR(err));\n\n\tbt_att_unregister_all(att);\n\tbt_att_unref(att);\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstatic bool disconnect_cb(struct io *io, void *user_data)\n{\n\tstruct bt_att *att = user_data;\n\tint err;\n\tsocklen_t len;\n\n\tlen = sizeof(err);\n\n\tif (getsockopt(att->fd, SOL_SOCKET, SO_ERROR, &err, &len) < 0) {\n\t\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Failed to obtain disconnect error: %s\",\n\t\t\t\t\tstrerror(errno));\n\t\terr = 0;\n\t}\n\n\tutil_debug(att->debug_callback, att->debug_data,\n\t\t\t\t\t\"Physical link disconnected: %s\",\n\t\t\t\t\tstrerror(err));\n\n\tio_destroy(att->io);\n\tatt->io = NULL;\n\n\t/* Notify request callbacks */\n\tqueue_remove_all(att->req_queue, NULL, NULL, disc_att_send_op);\n\tqueue_remove_all(att->ind_queue, NULL, NULL, disc_att_send_op);\n\tqueue_remove_all(att->write_queue, NULL, NULL, disc_att_send_op);\n\n\tif (att->pending_req) {\n\t\tdisc_att_send_op(att->pending_req);\n\t\tatt->pending_req = NULL;\n\t}\n\n\tif (att->pending_ind) {\n\t\tdisc_att_send_op(att->pending_ind);\n\t\tatt->pending_ind = NULL;\n\t}\n\n\tbt_att_ref(att);\n\n\tqueue_foreach(att->disconn_list, disconn_handler, INT_TO_PTR(err));\n\n\tbt_att_unregister_all(att);\n\tbt_att_unref(att);\n\n\treturn false;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic void disconnect_handler(struct l_io *io, void *user_data)\n{\n\tstruct btp *btp = user_data;\n\n\tbtp->disconnect_cb(btp, btp->disconnect_cb_data);\n}"
  },
  {
    "function_name": "btp_connect",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/btp.c",
    "lines": "64-91",
    "snippet": "static struct l_io *btp_connect(const char *path)\n{\n\tstruct sockaddr_un addr;\n\tstruct l_io *io;\n\tint sk;\n\n\tsk = socket(AF_UNIX, SOCK_STREAM | SOCK_NONBLOCK, 0);\n\tif (sk < 0)\n\t\treturn NULL;\n\n\tmemset(&addr, 0, sizeof(addr));\n\taddr.sun_family = AF_UNIX;\n\tstrncpy(addr.sun_path, path, sizeof(addr.sun_path) - 1);\n\n\tif (connect(sk, (struct sockaddr *) &addr, sizeof(addr)) < 0) {\n\t\tclose(sk);\n\t\treturn NULL;\n\t}\n\n\tio = l_io_new(sk);\n\tif (!io) {\n\t\tclose(sk);\n\t\treturn NULL;\n\t}\n\n\tl_io_set_close_on_destroy(io, true);\n\treturn io;\n}",
    "includes": [
      "#include \"src/shared/btp.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include <ell/ell.h>",
      "#include <unistd.h>",
      "#include <sys/un.h>",
      "#include <sys/socket.h>",
      "#include <stdbool.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "l_io_set_close_on_destroy",
          "args": [
            "io",
            "true"
          ],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "close",
          "args": [
            "sk"
          ],
          "line": 85
        },
        "resolved": true,
        "details": {
          "function_name": "hfp_context_close_container",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/hfp.c",
          "lines": "334-347",
          "snippet": "bool hfp_context_close_container(struct hfp_context *context)\n{\n\tskip_whitespace(context);\n\n\t/* The list shall be followed by a right parenthesis (\")\" V250 5.7.3.1*/\n\tif (context->data[context->offset] != ')')\n\t\treturn false;\n\n\tcontext->offset++;\n\n\tnext_field(context);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/hfp.h\"",
            "#include \"src/shared/io.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/ringbuf.h\"",
            "#include \"src/shared/util.h\"",
            "#include <ctype.h>",
            "#include <stdarg.h>",
            "#include <string.h>",
            "#include <unistd.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/hfp.h\"\n#include \"src/shared/io.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/ringbuf.h\"\n#include \"src/shared/util.h\"\n#include <ctype.h>\n#include <stdarg.h>\n#include <string.h>\n#include <unistd.h>\n#include <stdio.h>\n#include <config.h>\n\nbool hfp_context_close_container(struct hfp_context *context)\n{\n\tskip_whitespace(context);\n\n\t/* The list shall be followed by a right parenthesis (\")\" V250 5.7.3.1*/\n\tif (context->data[context->offset] != ')')\n\t\treturn false;\n\n\tcontext->offset++;\n\n\tnext_field(context);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "l_io_new",
          "args": [
            "sk"
          ],
          "line": 83
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "connect",
          "args": [
            "sk",
            "(struct sockaddr *) &addr",
            "sizeof(addr)"
          ],
          "line": 78
        },
        "resolved": true,
        "details": {
          "function_name": "connect_event",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/attrib-server.c",
          "lines": "1251-1285",
          "snippet": "static void connect_event(GIOChannel *io, GError *gerr, void *user_data)\n{\n\tstruct btd_adapter *adapter;\n\tstruct btd_device *device;\n\tuint8_t dst_type;\n\tbdaddr_t src, dst;\n\n\tDBG(\"\");\n\n\tif (gerr) {\n\t\terror(\"%s\", gerr->message);\n\t\treturn;\n\t}\n\n\tbt_io_get(io, &gerr,\n\t\t\tBT_IO_OPT_SOURCE_BDADDR, &src,\n\t\t\tBT_IO_OPT_DEST_BDADDR, &dst,\n\t\t\tBT_IO_OPT_DEST_TYPE, &dst_type,\n\t\t\tBT_IO_OPT_INVALID);\n\tif (gerr) {\n\t\terror(\"bt_io_get: %s\", gerr->message);\n\t\tg_error_free(gerr);\n\t\treturn;\n\t}\n\n\tadapter = adapter_find(&src);\n\tif (!adapter)\n\t\treturn;\n\n\tdevice = btd_adapter_get_device(adapter, &dst, dst_type);\n\tif (!device)\n\t\treturn;\n\n\tdevice_attach_att(device, io);\n}",
          "includes": [
            "#include \"attrib-server.h\"",
            "#include \"storage.h\"",
            "#include \"textfile.h\"",
            "#include \"attrib/att-database.h\"",
            "#include \"attrib/gatt.h\"",
            "#include \"attrib/att.h\"",
            "#include \"attrib/gattrib.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"device.h\"",
            "#include \"adapter.h\"",
            "#include \"backtrace.h\"",
            "#include \"log.h\"",
            "#include \"btio/btio.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/sdp_lib.h\"",
            "#include \"lib/sdp.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <sys/stat.h>",
            "#include <glib.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdbool.h>",
            "#include <stdint.h>",
            "#include <errno.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"attrib-server.h\"\n#include \"storage.h\"\n#include \"textfile.h\"\n#include \"attrib/att-database.h\"\n#include \"attrib/gatt.h\"\n#include \"attrib/att.h\"\n#include \"attrib/gattrib.h\"\n#include \"src/shared/util.h\"\n#include \"device.h\"\n#include \"adapter.h\"\n#include \"backtrace.h\"\n#include \"log.h\"\n#include \"btio/btio.h\"\n#include \"lib/uuid.h\"\n#include \"lib/sdp_lib.h\"\n#include \"lib/sdp.h\"\n#include \"lib/bluetooth.h\"\n#include <sys/stat.h>\n#include <glib.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdbool.h>\n#include <stdint.h>\n#include <errno.h>\n#include <config.h>\n\nstatic void connect_event(GIOChannel *io, GError *gerr, void *user_data)\n{\n\tstruct btd_adapter *adapter;\n\tstruct btd_device *device;\n\tuint8_t dst_type;\n\tbdaddr_t src, dst;\n\n\tDBG(\"\");\n\n\tif (gerr) {\n\t\terror(\"%s\", gerr->message);\n\t\treturn;\n\t}\n\n\tbt_io_get(io, &gerr,\n\t\t\tBT_IO_OPT_SOURCE_BDADDR, &src,\n\t\t\tBT_IO_OPT_DEST_BDADDR, &dst,\n\t\t\tBT_IO_OPT_DEST_TYPE, &dst_type,\n\t\t\tBT_IO_OPT_INVALID);\n\tif (gerr) {\n\t\terror(\"bt_io_get: %s\", gerr->message);\n\t\tg_error_free(gerr);\n\t\treturn;\n\t}\n\n\tadapter = adapter_find(&src);\n\tif (!adapter)\n\t\treturn;\n\n\tdevice = btd_adapter_get_device(adapter, &dst, dst_type);\n\tif (!device)\n\t\treturn;\n\n\tdevice_attach_att(device, io);\n}"
        }
      },
      {
        "call_info": {
          "callee": "strncpy",
          "args": [
            "addr.sun_path",
            "path",
            "sizeof(addr.sun_path) - 1"
          ],
          "line": 76
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&addr",
            "0",
            "sizeof(addr)"
          ],
          "line": 74
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "socket",
          "args": [
            "AF_UNIX",
            "SOCK_STREAM | SOCK_NONBLOCK",
            "0"
          ],
          "line": 70
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/btp.h\"\n#include \"lib/bluetooth.h\"\n#include <ell/ell.h>\n#include <unistd.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n#include <stdbool.h>\n\nstatic struct l_io *btp_connect(const char *path)\n{\n\tstruct sockaddr_un addr;\n\tstruct l_io *io;\n\tint sk;\n\n\tsk = socket(AF_UNIX, SOCK_STREAM | SOCK_NONBLOCK, 0);\n\tif (sk < 0)\n\t\treturn NULL;\n\n\tmemset(&addr, 0, sizeof(addr));\n\taddr.sun_family = AF_UNIX;\n\tstrncpy(addr.sun_path, path, sizeof(addr.sun_path) - 1);\n\n\tif (connect(sk, (struct sockaddr *) &addr, sizeof(addr)) < 0) {\n\t\tclose(sk);\n\t\treturn NULL;\n\t}\n\n\tio = l_io_new(sk);\n\tif (!io) {\n\t\tclose(sk);\n\t\treturn NULL;\n\t}\n\n\tl_io_set_close_on_destroy(io, true);\n\treturn io;\n}"
  }
]