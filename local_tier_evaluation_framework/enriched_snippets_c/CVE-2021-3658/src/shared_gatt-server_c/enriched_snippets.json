[
  {
    "function_name": "bt_gatt_server_send_indication",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1681-1719",
    "snippet": "bool bt_gatt_server_send_indication(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length,\n\t\t\t\t\tbt_gatt_server_conf_func_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_server_destroy_func_t destroy)\n{\n\tuint16_t pdu_len;\n\tuint8_t *pdu;\n\tstruct ind_data *data;\n\tbool result;\n\n\tif (!server || (length && !value))\n\t\treturn false;\n\n\tpdu_len = MIN(bt_att_get_mtu(server->att) - 1, length + 2);\n\tpdu = malloc(pdu_len);\n\tif (!pdu)\n\t\treturn false;\n\n\tdata = new0(struct ind_data, 1);\n\n\tdata->callback = callback;\n\tdata->destroy = destroy;\n\tdata->user_data = user_data;\n\n\tput_le16(handle, pdu);\n\tmemcpy(pdu + 2, value, pdu_len - 2);\n\n\tresult = !!bt_att_send(server->att, BT_ATT_OP_HANDLE_VAL_IND, pdu,\n\t\t\t\t\t\t\tpdu_len, conf_cb,\n\t\t\t\t\t\t\tdata, destroy_ind_data);\n\tif (!result)\n\t\tdestroy_ind_data(data);\n\n\tfree(pdu);\n\n\treturn result;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "pdu"
          ],
          "line": 1716
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "destroy_ind_data",
          "args": [
            "data"
          ],
          "line": 1714
        },
        "resolved": true,
        "details": {
          "function_name": "destroy_ind_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "1662-1670",
          "snippet": "static void destroy_ind_data(void *user_data)\n{\n\tstruct ind_data *data = user_data;\n\n\tif (data->destroy)\n\t\tdata->destroy(data->user_data);\n\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void destroy_ind_data(void *user_data)\n{\n\tstruct ind_data *data = user_data;\n\n\tif (data->destroy)\n\t\tdata->destroy(data->user_data);\n\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "BT_ATT_OP_HANDLE_VAL_IND",
            "pdu",
            "pdu_len",
            "conf_cb",
            "data",
            "destroy_ind_data"
          ],
          "line": 1710
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "pdu + 2",
            "value",
            "pdu_len - 2"
          ],
          "line": 1708
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "handle",
            "pdu"
          ],
          "line": 1707
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structind_data",
            "1"
          ],
          "line": 1701
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "pdu_len"
          ],
          "line": 1697
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "bt_att_get_mtu(server->att) - 1",
            "length + 2"
          ],
          "line": 1696
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "server->att"
          ],
          "line": 1696
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nbool bt_gatt_server_send_indication(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length,\n\t\t\t\t\tbt_gatt_server_conf_func_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_server_destroy_func_t destroy)\n{\n\tuint16_t pdu_len;\n\tuint8_t *pdu;\n\tstruct ind_data *data;\n\tbool result;\n\n\tif (!server || (length && !value))\n\t\treturn false;\n\n\tpdu_len = MIN(bt_att_get_mtu(server->att) - 1, length + 2);\n\tpdu = malloc(pdu_len);\n\tif (!pdu)\n\t\treturn false;\n\n\tdata = new0(struct ind_data, 1);\n\n\tdata->callback = callback;\n\tdata->destroy = destroy;\n\tdata->user_data = user_data;\n\n\tput_le16(handle, pdu);\n\tmemcpy(pdu + 2, value, pdu_len - 2);\n\n\tresult = !!bt_att_send(server->att, BT_ATT_OP_HANDLE_VAL_IND, pdu,\n\t\t\t\t\t\t\tpdu_len, conf_cb,\n\t\t\t\t\t\t\tdata, destroy_ind_data);\n\tif (!result)\n\t\tdestroy_ind_data(data);\n\n\tfree(pdu);\n\n\treturn result;\n}"
  },
  {
    "function_name": "conf_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1672-1679",
    "snippet": "static void conf_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct ind_data *data = user_data;\n\n\tif (data->callback)\n\t\tdata->callback(data->user_data);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "data->callback",
          "args": [
            "data->user_data"
          ],
          "line": 1678
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void conf_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct ind_data *data = user_data;\n\n\tif (data->callback)\n\t\tdata->callback(data->user_data);\n}"
  },
  {
    "function_name": "destroy_ind_data",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1662-1670",
    "snippet": "static void destroy_ind_data(void *user_data)\n{\n\tstruct ind_data *data = user_data;\n\n\tif (data->destroy)\n\t\tdata->destroy(data->user_data);\n\n\tfree(data);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "data"
          ],
          "line": 1669
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "data->destroy",
          "args": [
            "data->user_data"
          ],
          "line": 1667
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void destroy_ind_data(void *user_data)\n{\n\tstruct ind_data *data = user_data;\n\n\tif (data->destroy)\n\t\tdata->destroy(data->user_data);\n\n\tfree(data);\n}"
  },
  {
    "function_name": "bt_gatt_server_send_notification",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1630-1654",
    "snippet": "bool bt_gatt_server_send_notification(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length)\n{\n\tuint16_t pdu_len;\n\tuint8_t *pdu;\n\tbool result;\n\n\tif (!server || (length && !value))\n\t\treturn false;\n\n\tpdu_len = MIN(bt_att_get_mtu(server->att) - 1, length + 2);\n\tpdu = malloc(pdu_len);\n\tif (!pdu)\n\t\treturn false;\n\n\tput_le16(handle, pdu);\n\tmemcpy(pdu + 2, value, pdu_len - 2);\n\n\tresult = !!bt_att_send(server->att, BT_ATT_OP_HANDLE_VAL_NOT, pdu,\n\t\t\t\t\t\tpdu_len, NULL, NULL, NULL);\n\tfree(pdu);\n\n\treturn result;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "pdu"
          ],
          "line": 1651
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "BT_ATT_OP_HANDLE_VAL_NOT",
            "pdu",
            "pdu_len",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 1649
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "pdu + 2",
            "value",
            "pdu_len - 2"
          ],
          "line": 1647
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "handle",
            "pdu"
          ],
          "line": 1646
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "pdu_len"
          ],
          "line": 1642
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "bt_att_get_mtu(server->att) - 1",
            "length + 2"
          ],
          "line": 1641
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "server->att"
          ],
          "line": 1641
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nbool bt_gatt_server_send_notification(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, const uint8_t *value,\n\t\t\t\t\tuint16_t length)\n{\n\tuint16_t pdu_len;\n\tuint8_t *pdu;\n\tbool result;\n\n\tif (!server || (length && !value))\n\t\treturn false;\n\n\tpdu_len = MIN(bt_att_get_mtu(server->att) - 1, length + 2);\n\tpdu = malloc(pdu_len);\n\tif (!pdu)\n\t\treturn false;\n\n\tput_le16(handle, pdu);\n\tmemcpy(pdu + 2, value, pdu_len - 2);\n\n\tresult = !!bt_att_send(server->att, BT_ATT_OP_HANDLE_VAL_NOT, pdu,\n\t\t\t\t\t\tpdu_len, NULL, NULL, NULL);\n\tfree(pdu);\n\n\treturn result;\n}"
  },
  {
    "function_name": "bt_gatt_server_set_debug",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1612-1628",
    "snippet": "bool bt_gatt_server_set_debug(struct bt_gatt_server *server,\n\t\t\t\t\tbt_gatt_server_debug_func_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_server_destroy_func_t destroy)\n{\n\tif (!server)\n\t\treturn false;\n\n\tif (server->debug_destroy)\n\t\tserver->debug_destroy(server->debug_data);\n\n\tserver->debug_callback = callback;\n\tserver->debug_destroy = destroy;\n\tserver->debug_data = user_data;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "server->debug_destroy",
          "args": [
            "server->debug_data"
          ],
          "line": 1621
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nbool bt_gatt_server_set_debug(struct bt_gatt_server *server,\n\t\t\t\t\tbt_gatt_server_debug_func_t callback,\n\t\t\t\t\tvoid *user_data,\n\t\t\t\t\tbt_gatt_server_destroy_func_t destroy)\n{\n\tif (!server)\n\t\treturn false;\n\n\tif (server->debug_destroy)\n\t\tserver->debug_destroy(server->debug_data);\n\n\tserver->debug_callback = callback;\n\tserver->debug_destroy = destroy;\n\tserver->debug_data = user_data;\n\n\treturn true;\n}"
  },
  {
    "function_name": "bt_gatt_server_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1601-1610",
    "snippet": "void bt_gatt_server_unref(struct bt_gatt_server *server)\n{\n\tif (!server)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&server->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_server_free(server);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_server_free",
          "args": [
            "server"
          ],
          "line": 1609
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_server_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "119-148",
          "snippet": "static void bt_gatt_server_free(struct bt_gatt_server *server)\n{\n\tif (server->debug_destroy)\n\t\tserver->debug_destroy(server->debug_data);\n\n\tbt_att_unregister(server->att, server->mtu_id);\n\tbt_att_unregister(server->att, server->read_by_grp_type_id);\n\tbt_att_unregister(server->att, server->read_by_type_id);\n\tbt_att_unregister(server->att, server->find_info_id);\n\tbt_att_unregister(server->att, server->find_by_type_value_id);\n\tbt_att_unregister(server->att, server->write_id);\n\tbt_att_unregister(server->att, server->write_cmd_id);\n\tbt_att_unregister(server->att, server->read_id);\n\tbt_att_unregister(server->att, server->read_blob_id);\n\tbt_att_unregister(server->att, server->read_multiple_id);\n\tbt_att_unregister(server->att, server->prep_write_id);\n\tbt_att_unregister(server->att, server->exec_write_id);\n\n\tif (server->pending_read_op)\n\t\tserver->pending_read_op->server = NULL;\n\n\tif (server->pending_write_op)\n\t\tserver->pending_write_op->server = NULL;\n\n\tqueue_destroy(server->prep_queue, prep_write_data_destroy);\n\n\tgatt_db_unref(server->db);\n\tbt_att_unref(server->att);\n\tfree(server);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void bt_gatt_server_free(struct bt_gatt_server *server)\n{\n\tif (server->debug_destroy)\n\t\tserver->debug_destroy(server->debug_data);\n\n\tbt_att_unregister(server->att, server->mtu_id);\n\tbt_att_unregister(server->att, server->read_by_grp_type_id);\n\tbt_att_unregister(server->att, server->read_by_type_id);\n\tbt_att_unregister(server->att, server->find_info_id);\n\tbt_att_unregister(server->att, server->find_by_type_value_id);\n\tbt_att_unregister(server->att, server->write_id);\n\tbt_att_unregister(server->att, server->write_cmd_id);\n\tbt_att_unregister(server->att, server->read_id);\n\tbt_att_unregister(server->att, server->read_blob_id);\n\tbt_att_unregister(server->att, server->read_multiple_id);\n\tbt_att_unregister(server->att, server->prep_write_id);\n\tbt_att_unregister(server->att, server->exec_write_id);\n\n\tif (server->pending_read_op)\n\t\tserver->pending_read_op->server = NULL;\n\n\tif (server->pending_write_op)\n\t\tserver->pending_write_op->server = NULL;\n\n\tqueue_destroy(server->prep_queue, prep_write_data_destroy);\n\n\tgatt_db_unref(server->db);\n\tbt_att_unref(server->att);\n\tfree(server);\n}"
        }
      },
      {
        "call_info": {
          "callee": "__sync_sub_and_fetch",
          "args": [
            "&server->ref_count",
            "1"
          ],
          "line": 1606
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nvoid bt_gatt_server_unref(struct bt_gatt_server *server)\n{\n\tif (!server)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&server->ref_count, 1))\n\t\treturn;\n\n\tbt_gatt_server_free(server);\n}"
  },
  {
    "function_name": "bt_gatt_server_ref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1591-1599",
    "snippet": "struct bt_gatt_server *bt_gatt_server_ref(struct bt_gatt_server *server)\n{\n\tif (!server)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&server->ref_count, 1);\n\n\treturn server;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "__sync_fetch_and_add",
          "args": [
            "&server->ref_count",
            "1"
          ],
          "line": 1596
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstruct bt_gatt_server *bt_gatt_server_ref(struct bt_gatt_server *server)\n{\n\tif (!server)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&server->ref_count, 1);\n\n\treturn server;\n}"
  },
  {
    "function_name": "bt_gatt_server_get_mtu",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1583-1589",
    "snippet": "uint16_t bt_gatt_server_get_mtu(struct bt_gatt_server *server)\n{\n\tif (!server || !server->att)\n\t\treturn 0;\n\n\treturn bt_att_get_mtu(server->att);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "server->att"
          ],
          "line": 1588
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nuint16_t bt_gatt_server_get_mtu(struct bt_gatt_server *server)\n{\n\tif (!server || !server->att)\n\t\treturn 0;\n\n\treturn bt_att_get_mtu(server->att);\n}"
  },
  {
    "function_name": "bt_gatt_server_new",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1558-1581",
    "snippet": "struct bt_gatt_server *bt_gatt_server_new(struct gatt_db *db,\n\t\t\t\t\tstruct bt_att *att, uint16_t mtu,\n\t\t\t\t\tuint8_t min_enc_size)\n{\n\tstruct bt_gatt_server *server;\n\n\tif (!att || !db)\n\t\treturn NULL;\n\n\tserver = new0(struct bt_gatt_server, 1);\n\tserver->db = gatt_db_ref(db);\n\tserver->att = bt_att_ref(att);\n\tserver->mtu = MAX(mtu, BT_ATT_DEFAULT_LE_MTU);\n\tserver->max_prep_queue_len = DEFAULT_MAX_PREP_QUEUE_LEN;\n\tserver->prep_queue = queue_new();\n\tserver->min_enc_size = min_enc_size;\n\n\tif (!gatt_server_register_att_handlers(server)) {\n\t\tbt_gatt_server_free(server);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_server_ref(server);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define DEFAULT_MAX_PREP_QUEUE_LEN 30"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_gatt_server_ref",
          "args": [
            "server"
          ],
          "line": 1580
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_server_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "1591-1599",
          "snippet": "struct bt_gatt_server *bt_gatt_server_ref(struct bt_gatt_server *server)\n{\n\tif (!server)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&server->ref_count, 1);\n\n\treturn server;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstruct bt_gatt_server *bt_gatt_server_ref(struct bt_gatt_server *server)\n{\n\tif (!server)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&server->ref_count, 1);\n\n\treturn server;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_gatt_server_free",
          "args": [
            "server"
          ],
          "line": 1576
        },
        "resolved": true,
        "details": {
          "function_name": "bt_gatt_server_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "119-148",
          "snippet": "static void bt_gatt_server_free(struct bt_gatt_server *server)\n{\n\tif (server->debug_destroy)\n\t\tserver->debug_destroy(server->debug_data);\n\n\tbt_att_unregister(server->att, server->mtu_id);\n\tbt_att_unregister(server->att, server->read_by_grp_type_id);\n\tbt_att_unregister(server->att, server->read_by_type_id);\n\tbt_att_unregister(server->att, server->find_info_id);\n\tbt_att_unregister(server->att, server->find_by_type_value_id);\n\tbt_att_unregister(server->att, server->write_id);\n\tbt_att_unregister(server->att, server->write_cmd_id);\n\tbt_att_unregister(server->att, server->read_id);\n\tbt_att_unregister(server->att, server->read_blob_id);\n\tbt_att_unregister(server->att, server->read_multiple_id);\n\tbt_att_unregister(server->att, server->prep_write_id);\n\tbt_att_unregister(server->att, server->exec_write_id);\n\n\tif (server->pending_read_op)\n\t\tserver->pending_read_op->server = NULL;\n\n\tif (server->pending_write_op)\n\t\tserver->pending_write_op->server = NULL;\n\n\tqueue_destroy(server->prep_queue, prep_write_data_destroy);\n\n\tgatt_db_unref(server->db);\n\tbt_att_unref(server->att);\n\tfree(server);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void bt_gatt_server_free(struct bt_gatt_server *server)\n{\n\tif (server->debug_destroy)\n\t\tserver->debug_destroy(server->debug_data);\n\n\tbt_att_unregister(server->att, server->mtu_id);\n\tbt_att_unregister(server->att, server->read_by_grp_type_id);\n\tbt_att_unregister(server->att, server->read_by_type_id);\n\tbt_att_unregister(server->att, server->find_info_id);\n\tbt_att_unregister(server->att, server->find_by_type_value_id);\n\tbt_att_unregister(server->att, server->write_id);\n\tbt_att_unregister(server->att, server->write_cmd_id);\n\tbt_att_unregister(server->att, server->read_id);\n\tbt_att_unregister(server->att, server->read_blob_id);\n\tbt_att_unregister(server->att, server->read_multiple_id);\n\tbt_att_unregister(server->att, server->prep_write_id);\n\tbt_att_unregister(server->att, server->exec_write_id);\n\n\tif (server->pending_read_op)\n\t\tserver->pending_read_op->server = NULL;\n\n\tif (server->pending_write_op)\n\t\tserver->pending_write_op->server = NULL;\n\n\tqueue_destroy(server->prep_queue, prep_write_data_destroy);\n\n\tgatt_db_unref(server->db);\n\tbt_att_unref(server->att);\n\tfree(server);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_server_register_att_handlers",
          "args": [
            "server"
          ],
          "line": 1575
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_server_register_att_handlers",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "1461-1556",
          "snippet": "static bool gatt_server_register_att_handlers(struct bt_gatt_server *server)\n{\n\t/* Exchange MTU */\n\tserver->mtu_id = bt_att_register(server->att, BT_ATT_OP_MTU_REQ,\n\t\t\t\t\t\t\t\texchange_mtu_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->mtu_id)\n\t\treturn false;\n\n\t/* Read By Group Type */\n\tserver->read_by_grp_type_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_by_grp_type_id)\n\t\treturn false;\n\n\t/* Read By Type */\n\tserver->read_by_type_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tread_by_type_cb,\n\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_by_type_id)\n\t\treturn false;\n\n\t/* Find Information */\n\tserver->find_info_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_FIND_INFO_REQ,\n\t\t\t\t\t\t\tfind_info_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->find_info_id)\n\t\treturn false;\n\n\t/* Find By Type Value */\n\tserver->find_by_type_value_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tserver, NULL);\n\n\tif (!server->find_by_type_value_id)\n\t\treturn false;\n\n\t/* Write Request */\n\tserver->write_id = bt_att_register(server->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\t\t\twrite_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->write_id)\n\t\treturn false;\n\n\t/* Write Command */\n\tserver->write_cmd_id = bt_att_register(server->att, BT_ATT_OP_WRITE_CMD,\n\t\t\t\t\t\t\t\twrite_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->write_cmd_id)\n\t\treturn false;\n\n\t/* Read Request */\n\tserver->read_id = bt_att_register(server->att, BT_ATT_OP_READ_REQ,\n\t\t\t\t\t\t\t\tread_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_id)\n\t\treturn false;\n\n\t/* Read Blob Request */\n\tserver->read_blob_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_READ_BLOB_REQ,\n\t\t\t\t\t\t\tread_blob_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_blob_id)\n\t\treturn false;\n\n\t/* Read Multiple Request */\n\tserver->read_multiple_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\t\t\tread_multiple_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\n\tif (!server->read_multiple_id)\n\t\treturn false;\n\n\t/* Prepare Write Request */\n\tserver->prep_write_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\tprep_write_cb, server, NULL);\n\tif (!server->prep_write_id)\n\t\treturn false;\n\n\t/* Execute Write Request */\n\tserver->exec_write_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\texec_write_cb, server, NULL);\n\tif (!server->exec_write_id)\n\t\treturn NULL;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool gatt_server_register_att_handlers(struct bt_gatt_server *server)\n{\n\t/* Exchange MTU */\n\tserver->mtu_id = bt_att_register(server->att, BT_ATT_OP_MTU_REQ,\n\t\t\t\t\t\t\t\texchange_mtu_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->mtu_id)\n\t\treturn false;\n\n\t/* Read By Group Type */\n\tserver->read_by_grp_type_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_by_grp_type_id)\n\t\treturn false;\n\n\t/* Read By Type */\n\tserver->read_by_type_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tread_by_type_cb,\n\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_by_type_id)\n\t\treturn false;\n\n\t/* Find Information */\n\tserver->find_info_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_FIND_INFO_REQ,\n\t\t\t\t\t\t\tfind_info_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->find_info_id)\n\t\treturn false;\n\n\t/* Find By Type Value */\n\tserver->find_by_type_value_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tserver, NULL);\n\n\tif (!server->find_by_type_value_id)\n\t\treturn false;\n\n\t/* Write Request */\n\tserver->write_id = bt_att_register(server->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\t\t\twrite_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->write_id)\n\t\treturn false;\n\n\t/* Write Command */\n\tserver->write_cmd_id = bt_att_register(server->att, BT_ATT_OP_WRITE_CMD,\n\t\t\t\t\t\t\t\twrite_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->write_cmd_id)\n\t\treturn false;\n\n\t/* Read Request */\n\tserver->read_id = bt_att_register(server->att, BT_ATT_OP_READ_REQ,\n\t\t\t\t\t\t\t\tread_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_id)\n\t\treturn false;\n\n\t/* Read Blob Request */\n\tserver->read_blob_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_READ_BLOB_REQ,\n\t\t\t\t\t\t\tread_blob_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_blob_id)\n\t\treturn false;\n\n\t/* Read Multiple Request */\n\tserver->read_multiple_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\t\t\tread_multiple_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\n\tif (!server->read_multiple_id)\n\t\treturn false;\n\n\t/* Prepare Write Request */\n\tserver->prep_write_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\tprep_write_cb, server, NULL);\n\tif (!server->prep_write_id)\n\t\treturn false;\n\n\t/* Execute Write Request */\n\tserver->exec_write_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\texec_write_cb, server, NULL);\n\tif (!server->exec_write_id)\n\t\treturn NULL;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_new",
          "args": [],
          "line": 1572
        },
        "resolved": true,
        "details": {
          "function_name": "queue_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "56-66",
          "snippet": "struct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nstruct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "MAX",
          "args": [
            "mtu",
            "BT_ATT_DEFAULT_LE_MTU"
          ],
          "line": 1570
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_att_ref",
          "args": [
            "att"
          ],
          "line": 1569
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1053-1061",
          "snippet": "struct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nstruct bt_att *bt_att_ref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&att->ref_count, 1);\n\n\treturn att;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_ref",
          "args": [
            "db"
          ],
          "line": 1568
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_ref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "210-218",
          "snippet": "struct gatt_db *gatt_db_ref(struct gatt_db *db)\n{\n\tif (!db)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&db->ref_count, 1);\n\n\treturn db;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db *gatt_db_ref(struct gatt_db *db)\n{\n\tif (!db)\n\t\treturn NULL;\n\n\t__sync_fetch_and_add(&db->ref_count, 1);\n\n\treturn db;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structbt_gatt_server",
            "1"
          ],
          "line": 1567
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\n#define DEFAULT_MAX_PREP_QUEUE_LEN 30\n\nstruct bt_gatt_server *bt_gatt_server_new(struct gatt_db *db,\n\t\t\t\t\tstruct bt_att *att, uint16_t mtu,\n\t\t\t\t\tuint8_t min_enc_size)\n{\n\tstruct bt_gatt_server *server;\n\n\tif (!att || !db)\n\t\treturn NULL;\n\n\tserver = new0(struct bt_gatt_server, 1);\n\tserver->db = gatt_db_ref(db);\n\tserver->att = bt_att_ref(att);\n\tserver->mtu = MAX(mtu, BT_ATT_DEFAULT_LE_MTU);\n\tserver->max_prep_queue_len = DEFAULT_MAX_PREP_QUEUE_LEN;\n\tserver->prep_queue = queue_new();\n\tserver->min_enc_size = min_enc_size;\n\n\tif (!gatt_server_register_att_handlers(server)) {\n\t\tbt_gatt_server_free(server);\n\t\treturn NULL;\n\t}\n\n\treturn bt_gatt_server_ref(server);\n}"
  },
  {
    "function_name": "gatt_server_register_att_handlers",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1461-1556",
    "snippet": "static bool gatt_server_register_att_handlers(struct bt_gatt_server *server)\n{\n\t/* Exchange MTU */\n\tserver->mtu_id = bt_att_register(server->att, BT_ATT_OP_MTU_REQ,\n\t\t\t\t\t\t\t\texchange_mtu_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->mtu_id)\n\t\treturn false;\n\n\t/* Read By Group Type */\n\tserver->read_by_grp_type_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_by_grp_type_id)\n\t\treturn false;\n\n\t/* Read By Type */\n\tserver->read_by_type_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tread_by_type_cb,\n\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_by_type_id)\n\t\treturn false;\n\n\t/* Find Information */\n\tserver->find_info_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_FIND_INFO_REQ,\n\t\t\t\t\t\t\tfind_info_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->find_info_id)\n\t\treturn false;\n\n\t/* Find By Type Value */\n\tserver->find_by_type_value_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tserver, NULL);\n\n\tif (!server->find_by_type_value_id)\n\t\treturn false;\n\n\t/* Write Request */\n\tserver->write_id = bt_att_register(server->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\t\t\twrite_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->write_id)\n\t\treturn false;\n\n\t/* Write Command */\n\tserver->write_cmd_id = bt_att_register(server->att, BT_ATT_OP_WRITE_CMD,\n\t\t\t\t\t\t\t\twrite_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->write_cmd_id)\n\t\treturn false;\n\n\t/* Read Request */\n\tserver->read_id = bt_att_register(server->att, BT_ATT_OP_READ_REQ,\n\t\t\t\t\t\t\t\tread_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_id)\n\t\treturn false;\n\n\t/* Read Blob Request */\n\tserver->read_blob_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_READ_BLOB_REQ,\n\t\t\t\t\t\t\tread_blob_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_blob_id)\n\t\treturn false;\n\n\t/* Read Multiple Request */\n\tserver->read_multiple_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\t\t\tread_multiple_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\n\tif (!server->read_multiple_id)\n\t\treturn false;\n\n\t/* Prepare Write Request */\n\tserver->prep_write_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\tprep_write_cb, server, NULL);\n\tif (!server->prep_write_id)\n\t\treturn false;\n\n\t/* Execute Write Request */\n\tserver->exec_write_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\texec_write_cb, server, NULL);\n\tif (!server->exec_write_id)\n\t\treturn NULL;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_register",
          "args": [
            "server->att",
            "BT_ATT_OP_EXEC_WRITE_REQ",
            "exec_write_cb",
            "server",
            "NULL"
          ],
          "line": 1549
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_register",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1402-1429",
          "snippet": "unsigned int bt_att_register(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tbt_att_notify_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !callback || !att->io)\n\t\treturn 0;\n\n\tnotify = new0(struct att_notify, 1);\n\tnotify->opcode = opcode;\n\tnotify->callback = callback;\n\tnotify->destroy = destroy;\n\tnotify->user_data = user_data;\n\n\tif (att->next_reg_id < 1)\n\t\tatt->next_reg_id = 1;\n\n\tnotify->id = att->next_reg_id++;\n\n\tif (!queue_push_tail(att->notify_list, notify)) {\n\t\tfree(notify);\n\t\treturn 0;\n\t}\n\n\treturn notify->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_register(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tbt_att_notify_func_t callback,\n\t\t\t\t\t\tvoid *user_data,\n\t\t\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !callback || !att->io)\n\t\treturn 0;\n\n\tnotify = new0(struct att_notify, 1);\n\tnotify->opcode = opcode;\n\tnotify->callback = callback;\n\tnotify->destroy = destroy;\n\tnotify->user_data = user_data;\n\n\tif (att->next_reg_id < 1)\n\t\tatt->next_reg_id = 1;\n\n\tnotify->id = att->next_reg_id++;\n\n\tif (!queue_push_tail(att->notify_list, notify)) {\n\t\tfree(notify);\n\t\treturn 0;\n\t}\n\n\treturn notify->id;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool gatt_server_register_att_handlers(struct bt_gatt_server *server)\n{\n\t/* Exchange MTU */\n\tserver->mtu_id = bt_att_register(server->att, BT_ATT_OP_MTU_REQ,\n\t\t\t\t\t\t\t\texchange_mtu_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->mtu_id)\n\t\treturn false;\n\n\t/* Read By Group Type */\n\tserver->read_by_grp_type_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tread_by_grp_type_cb,\n\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_by_grp_type_id)\n\t\treturn false;\n\n\t/* Read By Type */\n\tserver->read_by_type_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\tread_by_type_cb,\n\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_by_type_id)\n\t\treturn false;\n\n\t/* Find Information */\n\tserver->find_info_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_FIND_INFO_REQ,\n\t\t\t\t\t\t\tfind_info_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->find_info_id)\n\t\treturn false;\n\n\t/* Find By Type Value */\n\tserver->find_by_type_value_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_FIND_BY_TYPE_REQ,\n\t\t\t\t\t\tfind_by_type_val_cb,\n\t\t\t\t\t\tserver, NULL);\n\n\tif (!server->find_by_type_value_id)\n\t\treturn false;\n\n\t/* Write Request */\n\tserver->write_id = bt_att_register(server->att, BT_ATT_OP_WRITE_REQ,\n\t\t\t\t\t\t\t\twrite_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->write_id)\n\t\treturn false;\n\n\t/* Write Command */\n\tserver->write_cmd_id = bt_att_register(server->att, BT_ATT_OP_WRITE_CMD,\n\t\t\t\t\t\t\t\twrite_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->write_cmd_id)\n\t\treturn false;\n\n\t/* Read Request */\n\tserver->read_id = bt_att_register(server->att, BT_ATT_OP_READ_REQ,\n\t\t\t\t\t\t\t\tread_cb,\n\t\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_id)\n\t\treturn false;\n\n\t/* Read Blob Request */\n\tserver->read_blob_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_READ_BLOB_REQ,\n\t\t\t\t\t\t\tread_blob_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\tif (!server->read_blob_id)\n\t\treturn false;\n\n\t/* Read Multiple Request */\n\tserver->read_multiple_id = bt_att_register(server->att,\n\t\t\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\t\t\tread_multiple_cb,\n\t\t\t\t\t\t\tserver, NULL);\n\n\tif (!server->read_multiple_id)\n\t\treturn false;\n\n\t/* Prepare Write Request */\n\tserver->prep_write_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\tprep_write_cb, server, NULL);\n\tif (!server->prep_write_id)\n\t\treturn false;\n\n\t/* Execute Write Request */\n\tserver->exec_write_id = bt_att_register(server->att,\n\t\t\t\t\t\tBT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\texec_write_cb, server, NULL);\n\tif (!server->exec_write_id)\n\t\treturn NULL;\n\n\treturn true;\n}"
  },
  {
    "function_name": "exchange_mtu_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1431-1459",
    "snippet": "static void exchange_mtu_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t client_rx_mtu;\n\tuint16_t final_mtu;\n\tuint8_t rsp_pdu[2];\n\n\tif (length != 2) {\n\t\tbt_att_send_error_rsp(server->att, opcode, 0,\n\t\t\t\t\t\tBT_ATT_ERROR_INVALID_PDU);\n\t\treturn;\n\t}\n\n\tclient_rx_mtu = get_le16(pdu);\n\tfinal_mtu = MAX(MIN(client_rx_mtu, server->mtu), BT_ATT_DEFAULT_LE_MTU);\n\n\t/* Respond with the server MTU */\n\tput_le16(server->mtu, rsp_pdu);\n\tbt_att_send(server->att, BT_ATT_OP_MTU_RSP, rsp_pdu, 2, NULL, NULL,\n\t\t\t\t\t\t\t\t\tNULL);\n\n\t/* Set MTU to be the minimum */\n\tserver->mtu = final_mtu;\n\tbt_att_set_mtu(server->att, final_mtu);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"MTU exchange complete, with MTU: %u\", final_mtu);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "server->debug_callback",
            "server->debug_data",
            "\"MTU exchange complete, with MTU: %u\"",
            "final_mtu"
          ],
          "line": 1457
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_set_mtu",
          "args": [
            "server->att",
            "final_mtu"
          ],
          "line": 1455
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_set_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1117-1137",
          "snippet": "bool bt_att_set_mtu(struct bt_att *att, uint16_t mtu)\n{\n\tvoid *buf;\n\n\tif (!att)\n\t\treturn false;\n\n\tif (mtu < BT_ATT_DEFAULT_LE_MTU)\n\t\treturn false;\n\n\tbuf = malloc(mtu);\n\tif (!buf)\n\t\treturn false;\n\n\tfree(att->buf);\n\n\tatt->mtu = mtu;\n\tatt->buf = buf;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_set_mtu(struct bt_att *att, uint16_t mtu)\n{\n\tvoid *buf;\n\n\tif (!att)\n\t\treturn false;\n\n\tif (mtu < BT_ATT_DEFAULT_LE_MTU)\n\t\treturn false;\n\n\tbuf = malloc(mtu);\n\tif (!buf)\n\t\treturn false;\n\n\tfree(att->buf);\n\n\tatt->mtu = mtu;\n\tatt->buf = buf;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "BT_ATT_OP_MTU_RSP",
            "rsp_pdu",
            "2",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 1450
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "server->mtu",
            "rsp_pdu"
          ],
          "line": 1449
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "MAX",
          "args": [
            "MIN(client_rx_mtu, server->mtu)",
            "BT_ATT_DEFAULT_LE_MTU"
          ],
          "line": 1446
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "client_rx_mtu",
            "server->mtu"
          ],
          "line": 1446
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu"
          ],
          "line": 1445
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "0",
            "BT_ATT_ERROR_INVALID_PDU"
          ],
          "line": 1440
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void exchange_mtu_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t client_rx_mtu;\n\tuint16_t final_mtu;\n\tuint8_t rsp_pdu[2];\n\n\tif (length != 2) {\n\t\tbt_att_send_error_rsp(server->att, opcode, 0,\n\t\t\t\t\t\tBT_ATT_ERROR_INVALID_PDU);\n\t\treturn;\n\t}\n\n\tclient_rx_mtu = get_le16(pdu);\n\tfinal_mtu = MAX(MIN(client_rx_mtu, server->mtu), BT_ATT_DEFAULT_LE_MTU);\n\n\t/* Respond with the server MTU */\n\tput_le16(server->mtu, rsp_pdu);\n\tbt_att_send(server->att, BT_ATT_OP_MTU_RSP, rsp_pdu, 2, NULL, NULL,\n\t\t\t\t\t\t\t\t\tNULL);\n\n\t/* Set MTU to be the minimum */\n\tserver->mtu = final_mtu;\n\tbt_att_set_mtu(server->att, final_mtu);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"MTU exchange complete, with MTU: %u\", final_mtu);\n}"
  },
  {
    "function_name": "exec_write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1372-1429",
    "snippet": "static void exec_write_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint8_t flags;\n\tuint8_t ecode;\n\tbool write;\n\tuint16_t ehandle = 0;\n\n\tif (length != 1) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tflags = ((uint8_t *) pdu)[0];\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\"Exec Write Req - flags: 0x%02x\", flags);\n\n\tif (flags == 0x00)\n\t\twrite = false;\n\telse if (flags == 0x01)\n\t\twrite = true;\n\telse {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tif (!write) {\n\t\tqueue_remove_all(server->prep_queue, NULL, NULL,\n\t\t\t\t\t\tprep_write_data_destroy);\n\t\tbt_att_send(server->att, BT_ATT_OP_EXEC_WRITE_RSP, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\t\treturn;\n\t}\n\n\t/* If there is more than one prep request, we are in reliable session */\n\tif (queue_length(server->prep_queue) > 1) {\n\t\tstruct prep_write_data *prep_data;\n\n\t\tprep_data = queue_find(server->prep_queue,\n\t\t\t\t\tfind_no_reliable_characteristic, NULL);\n\t\tif (prep_data) {\n\t\t\tecode = BT_ATT_ERROR_REQUEST_NOT_SUPPORTED;\n\t\t\tehandle = prep_data->handle;\n\t\t\tgoto error;\n\t\t}\n\t}\n\n\texec_next_prep_write(server, 0, 0);\n\n\treturn;\n\nerror:\n\tqueue_remove_all(server->prep_queue, NULL, NULL,\n\t\t\t\t\t\tprep_write_data_destroy);\n\tbt_att_send_error_rsp(server->att, opcode, ehandle, ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "ehandle",
            "ecode"
          ],
          "line": 1428
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_all",
          "args": [
            "server->prep_queue",
            "NULL",
            "NULL",
            "prep_write_data_destroy"
          ],
          "line": 1426
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "318-362",
          "snippet": "unsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}"
        }
      },
      {
        "call_info": {
          "callee": "exec_next_prep_write",
          "args": [
            "server",
            "0",
            "0"
          ],
          "line": 1421
        },
        "resolved": true,
        "details": {
          "function_name": "exec_next_prep_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "1320-1362",
          "snippet": "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err)\n{\n\tstruct prep_write_data *next = NULL;\n\tstruct gatt_db_attribute *attr;\n\tbool status;\n\n\tif (err)\n\t\tgoto error;\n\n\tnext = queue_pop_head(server->prep_queue);\n\tif (!next) {\n\t\tbt_att_send(server->att, BT_ATT_OP_EXEC_WRITE_RSP, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\t\treturn;\n\t}\n\n\tattr = gatt_db_get_attribute(server->db, next->handle);\n\tif (!attr) {\n\t\terr = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\tstatus = gatt_db_attribute_write(attr, next->offset,\n\t\t\t\t\t\tnext->value, next->length,\n\t\t\t\t\t\tBT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\tserver->att,\n\t\t\t\t\t\texec_write_complete_cb, server);\n\n\tprep_write_data_destroy(next);\n\n\tif (status)\n\t\treturn;\n\n\terr = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tqueue_remove_all(server->prep_queue, NULL, NULL,\n\t\t\t\t\t\tprep_write_data_destroy);\n\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t\tehandle, err);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);\n\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err)\n{\n\tstruct prep_write_data *next = NULL;\n\tstruct gatt_db_attribute *attr;\n\tbool status;\n\n\tif (err)\n\t\tgoto error;\n\n\tnext = queue_pop_head(server->prep_queue);\n\tif (!next) {\n\t\tbt_att_send(server->att, BT_ATT_OP_EXEC_WRITE_RSP, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\t\treturn;\n\t}\n\n\tattr = gatt_db_get_attribute(server->db, next->handle);\n\tif (!attr) {\n\t\terr = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\tstatus = gatt_db_attribute_write(attr, next->offset,\n\t\t\t\t\t\tnext->value, next->length,\n\t\t\t\t\t\tBT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\tserver->att,\n\t\t\t\t\t\texec_write_complete_cb, server);\n\n\tprep_write_data_destroy(next);\n\n\tif (status)\n\t\treturn;\n\n\terr = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tqueue_remove_all(server->prep_queue, NULL, NULL,\n\t\t\t\t\t\tprep_write_data_destroy);\n\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t\tehandle, err);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_find",
          "args": [
            "server->prep_queue",
            "find_no_reliable_characteristic",
            "NULL"
          ],
          "line": 1412
        },
        "resolved": true,
        "details": {
          "function_name": "queue_find",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "231-247",
          "snippet": "void *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_find(struct queue *queue, queue_match_func_t function,\n\t\t\t\t\t\t\tconst void *match_data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn NULL;\n\n\tif (!function)\n\t\tfunction = direct_match;\n\n\tfor (entry = queue->head; entry; entry = entry->next)\n\t\tif (function(entry->data, match_data))\n\t\t\treturn entry->data;\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_length",
          "args": [
            "server->prep_queue"
          ],
          "line": 1409
        },
        "resolved": true,
        "details": {
          "function_name": "queue_length",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "372-378",
          "snippet": "unsigned int queue_length(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn 0;\n\n\treturn queue->entries;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_length(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn 0;\n\n\treturn queue->entries;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "BT_ATT_OP_EXEC_WRITE_RSP",
            "NULL",
            "0",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 1403
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "server->debug_callback",
            "server->debug_data",
            "\"Exec Write Req - flags: 0x%02x\"",
            "flags"
          ],
          "line": 1388
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void exec_write_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint8_t flags;\n\tuint8_t ecode;\n\tbool write;\n\tuint16_t ehandle = 0;\n\n\tif (length != 1) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tflags = ((uint8_t *) pdu)[0];\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\"Exec Write Req - flags: 0x%02x\", flags);\n\n\tif (flags == 0x00)\n\t\twrite = false;\n\telse if (flags == 0x01)\n\t\twrite = true;\n\telse {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tif (!write) {\n\t\tqueue_remove_all(server->prep_queue, NULL, NULL,\n\t\t\t\t\t\tprep_write_data_destroy);\n\t\tbt_att_send(server->att, BT_ATT_OP_EXEC_WRITE_RSP, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\t\treturn;\n\t}\n\n\t/* If there is more than one prep request, we are in reliable session */\n\tif (queue_length(server->prep_queue) > 1) {\n\t\tstruct prep_write_data *prep_data;\n\n\t\tprep_data = queue_find(server->prep_queue,\n\t\t\t\t\tfind_no_reliable_characteristic, NULL);\n\t\tif (prep_data) {\n\t\t\tecode = BT_ATT_ERROR_REQUEST_NOT_SUPPORTED;\n\t\t\tehandle = prep_data->handle;\n\t\t\tgoto error;\n\t\t}\n\t}\n\n\texec_next_prep_write(server, 0, 0);\n\n\treturn;\n\nerror:\n\tqueue_remove_all(server->prep_queue, NULL, NULL,\n\t\t\t\t\t\tprep_write_data_destroy);\n\tbt_att_send_error_rsp(server->att, opcode, ehandle, ecode);\n}"
  },
  {
    "function_name": "find_no_reliable_characteristic",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1364-1370",
    "snippet": "static bool find_no_reliable_characteristic(const void *data,\n\t\t\t\t\t\tconst void *match_data)\n{\n\tconst struct prep_write_data *prep_data = data;\n\n\treturn !prep_data->reliable_supported;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool find_no_reliable_characteristic(const void *data,\n\t\t\t\t\t\tconst void *match_data)\n{\n\tconst struct prep_write_data *prep_data = data;\n\n\treturn !prep_data->reliable_supported;\n}"
  },
  {
    "function_name": "exec_next_prep_write",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1320-1362",
    "snippet": "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err)\n{\n\tstruct prep_write_data *next = NULL;\n\tstruct gatt_db_attribute *attr;\n\tbool status;\n\n\tif (err)\n\t\tgoto error;\n\n\tnext = queue_pop_head(server->prep_queue);\n\tif (!next) {\n\t\tbt_att_send(server->att, BT_ATT_OP_EXEC_WRITE_RSP, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\t\treturn;\n\t}\n\n\tattr = gatt_db_get_attribute(server->db, next->handle);\n\tif (!attr) {\n\t\terr = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\tstatus = gatt_db_attribute_write(attr, next->offset,\n\t\t\t\t\t\tnext->value, next->length,\n\t\t\t\t\t\tBT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\tserver->att,\n\t\t\t\t\t\texec_write_complete_cb, server);\n\n\tprep_write_data_destroy(next);\n\n\tif (status)\n\t\treturn;\n\n\terr = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tqueue_remove_all(server->prep_queue, NULL, NULL,\n\t\t\t\t\t\tprep_write_data_destroy);\n\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t\tehandle, err);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "BT_ATT_OP_EXEC_WRITE_REQ",
            "ehandle",
            "err"
          ],
          "line": 1360
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_remove_all",
          "args": [
            "server->prep_queue",
            "NULL",
            "NULL",
            "prep_write_data_destroy"
          ],
          "line": 1357
        },
        "resolved": true,
        "details": {
          "function_name": "queue_remove_all",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "318-362",
          "snippet": "unsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_remove_all(struct queue *queue, queue_match_func_t function,\n\t\t\t\tvoid *user_data, queue_destroy_func_t destroy)\n{\n\tstruct queue_entry *entry;\n\tunsigned int count = 0;\n\n\tif (!queue)\n\t\treturn 0;\n\n\tentry = queue->head;\n\n\tif (function) {\n\t\twhile (entry) {\n\t\t\tvoid *data;\n\t\t\tunsigned int entries = queue->entries;\n\n\t\t\tdata = queue_remove_if(queue, function, user_data);\n\t\t\tif (entries == queue->entries)\n\t\t\t\tbreak;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(data);\n\n\t\t\tcount++;\n\t\t}\n\t} else {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t\tqueue->entries = 0;\n\n\t\twhile (entry) {\n\t\t\tstruct queue_entry *tmp = entry;\n\n\t\t\tentry = entry->next;\n\n\t\t\tif (destroy)\n\t\t\t\tdestroy(tmp->data);\n\n\t\t\tfree(tmp);\n\t\t\tcount++;\n\t\t}\n\t}\n\n\treturn count;\n}"
        }
      },
      {
        "call_info": {
          "callee": "prep_write_data_destroy",
          "args": [
            "next"
          ],
          "line": 1349
        },
        "resolved": true,
        "details": {
          "function_name": "prep_write_data_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "79-85",
          "snippet": "static void prep_write_data_destroy(void *user_data)\n{\n\tstruct prep_write_data *data = user_data;\n\n\tfree(data->value);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void prep_write_data_destroy(void *user_data)\n{\n\tstruct prep_write_data *data = user_data;\n\n\tfree(data->value);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_write",
          "args": [
            "attr",
            "next->offset",
            "next->value",
            "next->length",
            "BT_ATT_OP_EXEC_WRITE_REQ",
            "server->att",
            "exec_write_complete_cb",
            "server"
          ],
          "line": 1343
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1805-1860",
          "snippet": "bool gatt_db_attribute_write(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\t\tgatt_db_attribute_write_t func,\n\t\t\t\t\tvoid *user_data)\n{\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->write_func) {\n\t\tstruct pending_write *p;\n\n\t\tp = new0(struct pending_write, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->write_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, write_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_writes, p);\n\n\t\tattrib->write_func(attrib, p->id, offset, value, len, opcode,\n\t\t\t\t\t\t\tatt, attrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Nothing to write just skip */\n\tif (len == 0)\n\t\tgoto done;\n\n\t/* For values stored in db allocate on demand */\n\tif (!attrib->value || offset >= attrib->value_len ||\n\t\t\t\tlen > (unsigned) (attrib->value_len - offset)) {\n\t\tvoid *buf;\n\n\t\tbuf = realloc(attrib->value, len + offset);\n\t\tif (!buf)\n\t\t\treturn false;\n\n\t\tattrib->value = buf;\n\n\t\t/* Init data in the first allocation */\n\t\tif (!attrib->value_len)\n\t\t\tmemset(attrib->value, 0, offset);\n\n\t\tattrib->value_len = len + offset;\n\t}\n\n\tmemcpy(&attrib->value[offset], value, len);\n\ndone:\n\tfunc(attrib, 0, user_data);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATTRIBUTE_TIMEOUT 5000"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\n#define ATTRIBUTE_TIMEOUT 5000\n\nbool gatt_db_attribute_write(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\t\tgatt_db_attribute_write_t func,\n\t\t\t\t\tvoid *user_data)\n{\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->write_func) {\n\t\tstruct pending_write *p;\n\n\t\tp = new0(struct pending_write, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->write_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, write_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_writes, p);\n\n\t\tattrib->write_func(attrib, p->id, offset, value, len, opcode,\n\t\t\t\t\t\t\tatt, attrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Nothing to write just skip */\n\tif (len == 0)\n\t\tgoto done;\n\n\t/* For values stored in db allocate on demand */\n\tif (!attrib->value || offset >= attrib->value_len ||\n\t\t\t\tlen > (unsigned) (attrib->value_len - offset)) {\n\t\tvoid *buf;\n\n\t\tbuf = realloc(attrib->value, len + offset);\n\t\tif (!buf)\n\t\t\treturn false;\n\n\t\tattrib->value = buf;\n\n\t\t/* Init data in the first allocation */\n\t\tif (!attrib->value_len)\n\t\t\tmemset(attrib->value, 0, offset);\n\n\t\tattrib->value_len = len + offset;\n\t}\n\n\tmemcpy(&attrib->value[offset], value, len);\n\ndone:\n\tfunc(attrib, 0, user_data);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_get_attribute",
          "args": [
            "server->db",
            "next->handle"
          ],
          "line": 1337
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_get_attribute",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1423-1445",
          "snippet": "struct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "BT_ATT_OP_EXEC_WRITE_RSP",
            "NULL",
            "0",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 1332
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "server->prep_queue"
          ],
          "line": 1330
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);\n\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err)\n{\n\tstruct prep_write_data *next = NULL;\n\tstruct gatt_db_attribute *attr;\n\tbool status;\n\n\tif (err)\n\t\tgoto error;\n\n\tnext = queue_pop_head(server->prep_queue);\n\tif (!next) {\n\t\tbt_att_send(server->att, BT_ATT_OP_EXEC_WRITE_RSP, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\t\treturn;\n\t}\n\n\tattr = gatt_db_get_attribute(server->db, next->handle);\n\tif (!attr) {\n\t\terr = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\tstatus = gatt_db_attribute_write(attr, next->offset,\n\t\t\t\t\t\tnext->value, next->length,\n\t\t\t\t\t\tBT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\tserver->att,\n\t\t\t\t\t\texec_write_complete_cb, server);\n\n\tprep_write_data_destroy(next);\n\n\tif (status)\n\t\treturn;\n\n\terr = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tqueue_remove_all(server->prep_queue, NULL, NULL,\n\t\t\t\t\t\tprep_write_data_destroy);\n\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t\tehandle, err);\n}"
  },
  {
    "function_name": "exec_write_complete_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1311-1318",
    "snippet": "static void exec_write_complete_cb(struct gatt_db_attribute *attr, int err,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t handle = gatt_db_attribute_get_handle(attr);\n\n\texec_next_prep_write(server, handle, err);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "exec_next_prep_write",
          "args": [
            "server",
            "handle",
            "err"
          ],
          "line": 1317
        },
        "resolved": true,
        "details": {
          "function_name": "exec_next_prep_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "1320-1362",
          "snippet": "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err)\n{\n\tstruct prep_write_data *next = NULL;\n\tstruct gatt_db_attribute *attr;\n\tbool status;\n\n\tif (err)\n\t\tgoto error;\n\n\tnext = queue_pop_head(server->prep_queue);\n\tif (!next) {\n\t\tbt_att_send(server->att, BT_ATT_OP_EXEC_WRITE_RSP, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\t\treturn;\n\t}\n\n\tattr = gatt_db_get_attribute(server->db, next->handle);\n\tif (!attr) {\n\t\terr = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\tstatus = gatt_db_attribute_write(attr, next->offset,\n\t\t\t\t\t\tnext->value, next->length,\n\t\t\t\t\t\tBT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\tserver->att,\n\t\t\t\t\t\texec_write_complete_cb, server);\n\n\tprep_write_data_destroy(next);\n\n\tif (status)\n\t\treturn;\n\n\terr = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tqueue_remove_all(server->prep_queue, NULL, NULL,\n\t\t\t\t\t\tprep_write_data_destroy);\n\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t\tehandle, err);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);\n\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err)\n{\n\tstruct prep_write_data *next = NULL;\n\tstruct gatt_db_attribute *attr;\n\tbool status;\n\n\tif (err)\n\t\tgoto error;\n\n\tnext = queue_pop_head(server->prep_queue);\n\tif (!next) {\n\t\tbt_att_send(server->att, BT_ATT_OP_EXEC_WRITE_RSP, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\t\treturn;\n\t}\n\n\tattr = gatt_db_get_attribute(server->db, next->handle);\n\tif (!attr) {\n\t\terr = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\tstatus = gatt_db_attribute_write(attr, next->offset,\n\t\t\t\t\t\tnext->value, next->length,\n\t\t\t\t\t\tBT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\tserver->att,\n\t\t\t\t\t\texec_write_complete_cb, server);\n\n\tprep_write_data_destroy(next);\n\n\tif (status)\n\t\treturn;\n\n\terr = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tqueue_remove_all(server->prep_queue, NULL, NULL,\n\t\t\t\t\t\tprep_write_data_destroy);\n\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_EXEC_WRITE_REQ,\n\t\t\t\t\t\t\t\tehandle, err);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 1315
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);\n\nstatic void exec_write_complete_cb(struct gatt_db_attribute *attr, int err,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t handle = gatt_db_attribute_get_handle(attr);\n\n\texec_next_prep_write(server, handle, err);\n}"
  },
  {
    "function_name": "prep_write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1250-1306",
    "snippet": "static void prep_write_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t handle = 0;\n\tuint16_t offset;\n\tstruct gatt_db_attribute *attr;\n\tstruct prep_write_complete_data *pwcd;\n\tuint8_t ecode, status;\n\n\tif (length < 4) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tif (queue_length(server->prep_queue) >= server->max_prep_queue_len) {\n\t\tecode = BT_ATT_ERROR_PREPARE_QUEUE_FULL;\n\t\tgoto error;\n\t}\n\n\thandle = get_le16(pdu);\n\toffset = get_le16(pdu + 2);\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\"Prep Write Req - handle: 0x%04x\", handle);\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_WRITE |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tpwcd = new0(struct prep_write_complete_data, 1);\n\tpwcd->pdu = malloc(length);\n\tmemcpy(pwcd->pdu, pdu, length);\n\tpwcd->length = length;\n\tpwcd->server = server;\n\n\tstatus = gatt_db_attribute_write(attr, offset, NULL, 0,\n\t\t\t\t\t\tBT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\tserver->att,\n\t\t\t\t\t\tprep_write_complete_cb, pwcd);\n\n\tif (status)\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tbt_att_send_error_rsp(server->att, opcode, handle, ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "handle",
            "ecode"
          ],
          "line": 1305
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_write",
          "args": [
            "attr",
            "offset",
            "NULL",
            "0",
            "BT_ATT_OP_PREP_WRITE_REQ",
            "server->att",
            "prep_write_complete_cb",
            "pwcd"
          ],
          "line": 1294
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1805-1860",
          "snippet": "bool gatt_db_attribute_write(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\t\tgatt_db_attribute_write_t func,\n\t\t\t\t\tvoid *user_data)\n{\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->write_func) {\n\t\tstruct pending_write *p;\n\n\t\tp = new0(struct pending_write, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->write_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, write_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_writes, p);\n\n\t\tattrib->write_func(attrib, p->id, offset, value, len, opcode,\n\t\t\t\t\t\t\tatt, attrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Nothing to write just skip */\n\tif (len == 0)\n\t\tgoto done;\n\n\t/* For values stored in db allocate on demand */\n\tif (!attrib->value || offset >= attrib->value_len ||\n\t\t\t\tlen > (unsigned) (attrib->value_len - offset)) {\n\t\tvoid *buf;\n\n\t\tbuf = realloc(attrib->value, len + offset);\n\t\tif (!buf)\n\t\t\treturn false;\n\n\t\tattrib->value = buf;\n\n\t\t/* Init data in the first allocation */\n\t\tif (!attrib->value_len)\n\t\t\tmemset(attrib->value, 0, offset);\n\n\t\tattrib->value_len = len + offset;\n\t}\n\n\tmemcpy(&attrib->value[offset], value, len);\n\ndone:\n\tfunc(attrib, 0, user_data);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATTRIBUTE_TIMEOUT 5000"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\n#define ATTRIBUTE_TIMEOUT 5000\n\nbool gatt_db_attribute_write(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\t\tgatt_db_attribute_write_t func,\n\t\t\t\t\tvoid *user_data)\n{\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->write_func) {\n\t\tstruct pending_write *p;\n\n\t\tp = new0(struct pending_write, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->write_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, write_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_writes, p);\n\n\t\tattrib->write_func(attrib, p->id, offset, value, len, opcode,\n\t\t\t\t\t\t\tatt, attrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Nothing to write just skip */\n\tif (len == 0)\n\t\tgoto done;\n\n\t/* For values stored in db allocate on demand */\n\tif (!attrib->value || offset >= attrib->value_len ||\n\t\t\t\tlen > (unsigned) (attrib->value_len - offset)) {\n\t\tvoid *buf;\n\n\t\tbuf = realloc(attrib->value, len + offset);\n\t\tif (!buf)\n\t\t\treturn false;\n\n\t\tattrib->value = buf;\n\n\t\t/* Init data in the first allocation */\n\t\tif (!attrib->value_len)\n\t\t\tmemset(attrib->value, 0, offset);\n\n\t\tattrib->value_len = len + offset;\n\t}\n\n\tmemcpy(&attrib->value[offset], value, len);\n\ndone:\n\tfunc(attrib, 0, user_data);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "pwcd->pdu",
            "pdu",
            "length"
          ],
          "line": 1290
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "length"
          ],
          "line": 1289
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structprep_write_complete_data",
            "1"
          ],
          "line": 1288
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "check_permissions",
          "args": [
            "server",
            "attr",
            "BT_ATT_PERM_WRITE |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_ENCRYPT"
          ],
          "line": 1282
        },
        "resolved": true,
        "details": {
          "function_name": "check_permissions",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "392-440",
          "snippet": "static uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "server->debug_callback",
            "server->debug_data",
            "\"Prep Write Req - handle: 0x%04x\"",
            "handle"
          ],
          "line": 1279
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_get_attribute",
          "args": [
            "server->db",
            "handle"
          ],
          "line": 1273
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_get_attribute",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1423-1445",
          "snippet": "struct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + 2"
          ],
          "line": 1271
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_length",
          "args": [
            "server->prep_queue"
          ],
          "line": 1265
        },
        "resolved": true,
        "details": {
          "function_name": "queue_length",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "372-378",
          "snippet": "unsigned int queue_length(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn 0;\n\n\treturn queue->entries;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nunsigned int queue_length(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn 0;\n\n\treturn queue->entries;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void prep_write_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t handle = 0;\n\tuint16_t offset;\n\tstruct gatt_db_attribute *attr;\n\tstruct prep_write_complete_data *pwcd;\n\tuint8_t ecode, status;\n\n\tif (length < 4) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tif (queue_length(server->prep_queue) >= server->max_prep_queue_len) {\n\t\tecode = BT_ATT_ERROR_PREPARE_QUEUE_FULL;\n\t\tgoto error;\n\t}\n\n\thandle = get_le16(pdu);\n\toffset = get_le16(pdu + 2);\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\"Prep Write Req - handle: 0x%04x\", handle);\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_WRITE |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tpwcd = new0(struct prep_write_complete_data, 1);\n\tpwcd->pdu = malloc(length);\n\tmemcpy(pwcd->pdu, pdu, length);\n\tpwcd->length = length;\n\tpwcd->server = server;\n\n\tstatus = gatt_db_attribute_write(attr, offset, NULL, 0,\n\t\t\t\t\t\tBT_ATT_OP_PREP_WRITE_REQ,\n\t\t\t\t\t\tserver->att,\n\t\t\t\t\t\tprep_write_complete_cb, pwcd);\n\n\tif (status)\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tbt_att_send_error_rsp(server->att, opcode, handle, ecode);\n}"
  },
  {
    "function_name": "prep_write_complete_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1217-1248",
    "snippet": "static void prep_write_complete_cb(struct gatt_db_attribute *attr, int err,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct prep_write_complete_data *pwcd = user_data;\n\tuint16_t handle = 0;\n\tuint16_t offset;\n\n\thandle = get_le16(pwcd->pdu);\n\n\tif (err) {\n\t\tbt_att_send_error_rsp(pwcd->server->att,\n\t\t\t\t\tBT_ATT_OP_PREP_WRITE_REQ, handle, err);\n\t\tfree(pwcd->pdu);\n\t\tfree(pwcd);\n\n\t\treturn;\n\t}\n\n\toffset = get_le16(pwcd->pdu + 2);\n\n\tif (!store_prep_data(pwcd->server, handle, offset, pwcd->length - 4,\n\t\t\t\t\t\t&((uint8_t *) pwcd->pdu)[4]))\n\t\tbt_att_send_error_rsp(pwcd->server->att,\n\t\t\t\t\tBT_ATT_OP_PREP_WRITE_RSP, handle,\n\t\t\t\t\tBT_ATT_ERROR_INSUFFICIENT_RESOURCES);\n\n\tbt_att_send(pwcd->server->att, BT_ATT_OP_PREP_WRITE_RSP, pwcd->pdu,\n\t\t\t\t\t\tpwcd->length, NULL, NULL, NULL);\n\n\tfree(pwcd->pdu);\n\tfree(pwcd);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "pwcd"
          ],
          "line": 1247
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "pwcd->server->att",
            "BT_ATT_OP_PREP_WRITE_RSP",
            "pwcd->pdu",
            "pwcd->length",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 1243
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "pwcd->server->att",
            "BT_ATT_OP_PREP_WRITE_RSP",
            "handle",
            "BT_ATT_ERROR_INSUFFICIENT_RESOURCES"
          ],
          "line": 1239
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "store_prep_data",
          "args": [
            "pwcd->server",
            "handle",
            "offset",
            "pwcd->length - 4",
            "&((uint8_t *) pwcd->pdu)[4]"
          ],
          "line": 1237
        },
        "resolved": true,
        "details": {
          "function_name": "store_prep_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "1193-1209",
          "snippet": "static bool store_prep_data(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, uint16_t offset,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tstruct prep_write_data *prep_data = NULL;\n\n\t/*\n\t * Now lets check if prep write is a continuation of long write\n\t * If so do aggregation of data\n\t */\n\tprep_data = queue_peek_tail(server->prep_queue);\n\tif (prep_data && (prep_data->handle == handle) &&\n\t\t\t(offset == (prep_data->length + prep_data->offset)))\n\t\treturn append_prep_data(prep_data, handle, length, value);\n\n\treturn prep_data_new(server, handle, offset, length, value);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool store_prep_data(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, uint16_t offset,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tstruct prep_write_data *prep_data = NULL;\n\n\t/*\n\t * Now lets check if prep write is a continuation of long write\n\t * If so do aggregation of data\n\t */\n\tprep_data = queue_peek_tail(server->prep_queue);\n\tif (prep_data && (prep_data->handle == handle) &&\n\t\t\t(offset == (prep_data->length + prep_data->offset)))\n\t\treturn append_prep_data(prep_data, handle, length, value);\n\n\treturn prep_data_new(server, handle, offset, length, value);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pwcd->pdu + 2"
          ],
          "line": 1235
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);\n\nstatic void prep_write_complete_cb(struct gatt_db_attribute *attr, int err,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct prep_write_complete_data *pwcd = user_data;\n\tuint16_t handle = 0;\n\tuint16_t offset;\n\n\thandle = get_le16(pwcd->pdu);\n\n\tif (err) {\n\t\tbt_att_send_error_rsp(pwcd->server->att,\n\t\t\t\t\tBT_ATT_OP_PREP_WRITE_REQ, handle, err);\n\t\tfree(pwcd->pdu);\n\t\tfree(pwcd);\n\n\t\treturn;\n\t}\n\n\toffset = get_le16(pwcd->pdu + 2);\n\n\tif (!store_prep_data(pwcd->server, handle, offset, pwcd->length - 4,\n\t\t\t\t\t\t&((uint8_t *) pwcd->pdu)[4]))\n\t\tbt_att_send_error_rsp(pwcd->server->att,\n\t\t\t\t\tBT_ATT_OP_PREP_WRITE_RSP, handle,\n\t\t\t\t\tBT_ATT_ERROR_INSUFFICIENT_RESOURCES);\n\n\tbt_att_send(pwcd->server->att, BT_ATT_OP_PREP_WRITE_RSP, pwcd->pdu,\n\t\t\t\t\t\tpwcd->length, NULL, NULL, NULL);\n\n\tfree(pwcd->pdu);\n\tfree(pwcd);\n}"
  },
  {
    "function_name": "store_prep_data",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1193-1209",
    "snippet": "static bool store_prep_data(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, uint16_t offset,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tstruct prep_write_data *prep_data = NULL;\n\n\t/*\n\t * Now lets check if prep write is a continuation of long write\n\t * If so do aggregation of data\n\t */\n\tprep_data = queue_peek_tail(server->prep_queue);\n\tif (prep_data && (prep_data->handle == handle) &&\n\t\t\t(offset == (prep_data->length + prep_data->offset)))\n\t\treturn append_prep_data(prep_data, handle, length, value);\n\n\treturn prep_data_new(server, handle, offset, length, value);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "prep_data_new",
          "args": [
            "server",
            "handle",
            "offset",
            "length",
            "value"
          ],
          "line": 1208
        },
        "resolved": true,
        "details": {
          "function_name": "prep_data_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "1164-1191",
          "snippet": "static bool prep_data_new(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, uint16_t offset,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tstruct prep_write_data *prep_data;\n\n\tprep_data = new0(struct prep_write_data, 1);\n\n\tif (!append_prep_data(prep_data, handle, length, value)) {\n\t\tprep_write_data_destroy(prep_data);\n\t\treturn false;\n\t}\n\n\tprep_data->server = server;\n\tprep_data->handle = handle;\n\tprep_data->offset = offset;\n\n\t/*\n\t * Handle is the value handle. We need characteristic declaration\n\t * handle which in BlueZ is handle_value -1\n\t */\n\tprep_data->reliable_supported = is_reliable_write_supported(server,\n\t\t\t\t\t\t\t\thandle - 1);\n\n\tqueue_push_tail(server->prep_queue, prep_data);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool prep_data_new(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, uint16_t offset,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tstruct prep_write_data *prep_data;\n\n\tprep_data = new0(struct prep_write_data, 1);\n\n\tif (!append_prep_data(prep_data, handle, length, value)) {\n\t\tprep_write_data_destroy(prep_data);\n\t\treturn false;\n\t}\n\n\tprep_data->server = server;\n\tprep_data->handle = handle;\n\tprep_data->offset = offset;\n\n\t/*\n\t * Handle is the value handle. We need characteristic declaration\n\t * handle which in BlueZ is handle_value -1\n\t */\n\tprep_data->reliable_supported = is_reliable_write_supported(server,\n\t\t\t\t\t\t\t\thandle - 1);\n\n\tqueue_push_tail(server->prep_queue, prep_data);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "append_prep_data",
          "args": [
            "prep_data",
            "handle",
            "length",
            "value"
          ],
          "line": 1206
        },
        "resolved": true,
        "details": {
          "function_name": "append_prep_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "1124-1145",
          "snippet": "static bool append_prep_data(struct prep_write_data *prep_data, uint16_t handle,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tuint8_t *val;\n\tuint16_t len;\n\n\tif (!length)\n\t\treturn true;\n\n\tlen = prep_data->length + length;\n\n\tval = realloc(prep_data->value, len);\n\tif (!val)\n\t\treturn false;\n\n\tmemcpy(val + prep_data->length, value, length);\n\n\tprep_data->value = val;\n\tprep_data->length = len;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool append_prep_data(struct prep_write_data *prep_data, uint16_t handle,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tuint8_t *val;\n\tuint16_t len;\n\n\tif (!length)\n\t\treturn true;\n\n\tlen = prep_data->length + length;\n\n\tval = realloc(prep_data->value, len);\n\tif (!val)\n\t\treturn false;\n\n\tmemcpy(val + prep_data->length, value, length);\n\n\tprep_data->value = val;\n\tprep_data->length = len;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_peek_tail",
          "args": [
            "server->prep_queue"
          ],
          "line": 1203
        },
        "resolved": true,
        "details": {
          "function_name": "queue_peek_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "195-201",
          "snippet": "void *queue_peek_tail(struct queue *queue)\n{\n\tif (!queue || !queue->tail)\n\t\treturn NULL;\n\n\treturn queue->tail->data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_peek_tail(struct queue *queue)\n{\n\tif (!queue || !queue->tail)\n\t\treturn NULL;\n\n\treturn queue->tail->data;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool store_prep_data(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, uint16_t offset,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tstruct prep_write_data *prep_data = NULL;\n\n\t/*\n\t * Now lets check if prep write is a continuation of long write\n\t * If so do aggregation of data\n\t */\n\tprep_data = queue_peek_tail(server->prep_queue);\n\tif (prep_data && (prep_data->handle == handle) &&\n\t\t\t(offset == (prep_data->length + prep_data->offset)))\n\t\treturn append_prep_data(prep_data, handle, length, value);\n\n\treturn prep_data_new(server, handle, offset, length, value);\n}"
  },
  {
    "function_name": "prep_data_new",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1164-1191",
    "snippet": "static bool prep_data_new(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, uint16_t offset,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tstruct prep_write_data *prep_data;\n\n\tprep_data = new0(struct prep_write_data, 1);\n\n\tif (!append_prep_data(prep_data, handle, length, value)) {\n\t\tprep_write_data_destroy(prep_data);\n\t\treturn false;\n\t}\n\n\tprep_data->server = server;\n\tprep_data->handle = handle;\n\tprep_data->offset = offset;\n\n\t/*\n\t * Handle is the value handle. We need characteristic declaration\n\t * handle which in BlueZ is handle_value -1\n\t */\n\tprep_data->reliable_supported = is_reliable_write_supported(server,\n\t\t\t\t\t\t\t\thandle - 1);\n\n\tqueue_push_tail(server->prep_queue, prep_data);\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_push_tail",
          "args": [
            "server->prep_queue",
            "prep_data"
          ],
          "line": 1188
        },
        "resolved": true,
        "details": {
          "function_name": "queue_push_tail",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "88-108",
          "snippet": "bool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_push_tail(struct queue *queue, void *data)\n{\n\tstruct queue_entry *entry;\n\n\tif (!queue)\n\t\treturn false;\n\n\tentry = queue_entry_new(data);\n\n\tif (queue->tail)\n\t\tqueue->tail->next = entry;\n\n\tqueue->tail = entry;\n\n\tif (!queue->head)\n\t\tqueue->head = entry;\n\n\tqueue->entries++;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "is_reliable_write_supported",
          "args": [
            "server",
            "handle - 1"
          ],
          "line": 1185
        },
        "resolved": true,
        "details": {
          "function_name": "is_reliable_write_supported",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "1147-1162",
          "snippet": "static bool is_reliable_write_supported(const struct bt_gatt_server  *server,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attr;\n\tuint16_t ext_prop;\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr)\n\t\treturn false;\n\n\tif (!gatt_db_attribute_get_char_data(attr, NULL, NULL, NULL, &ext_prop,\n\t\t\t\t\t\t\t\t\tNULL))\n\t\treturn false;\n\n\treturn (ext_prop & BT_GATT_CHRC_EXT_PROP_RELIABLE_WRITE);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool is_reliable_write_supported(const struct bt_gatt_server  *server,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attr;\n\tuint16_t ext_prop;\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr)\n\t\treturn false;\n\n\tif (!gatt_db_attribute_get_char_data(attr, NULL, NULL, NULL, &ext_prop,\n\t\t\t\t\t\t\t\t\tNULL))\n\t\treturn false;\n\n\treturn (ext_prop & BT_GATT_CHRC_EXT_PROP_RELIABLE_WRITE);\n}"
        }
      },
      {
        "call_info": {
          "callee": "prep_write_data_destroy",
          "args": [
            "prep_data"
          ],
          "line": 1173
        },
        "resolved": true,
        "details": {
          "function_name": "prep_write_data_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "79-85",
          "snippet": "static void prep_write_data_destroy(void *user_data)\n{\n\tstruct prep_write_data *data = user_data;\n\n\tfree(data->value);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void prep_write_data_destroy(void *user_data)\n{\n\tstruct prep_write_data *data = user_data;\n\n\tfree(data->value);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "append_prep_data",
          "args": [
            "prep_data",
            "handle",
            "length",
            "value"
          ],
          "line": 1172
        },
        "resolved": true,
        "details": {
          "function_name": "append_prep_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "1124-1145",
          "snippet": "static bool append_prep_data(struct prep_write_data *prep_data, uint16_t handle,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tuint8_t *val;\n\tuint16_t len;\n\n\tif (!length)\n\t\treturn true;\n\n\tlen = prep_data->length + length;\n\n\tval = realloc(prep_data->value, len);\n\tif (!val)\n\t\treturn false;\n\n\tmemcpy(val + prep_data->length, value, length);\n\n\tprep_data->value = val;\n\tprep_data->length = len;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool append_prep_data(struct prep_write_data *prep_data, uint16_t handle,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tuint8_t *val;\n\tuint16_t len;\n\n\tif (!length)\n\t\treturn true;\n\n\tlen = prep_data->length + length;\n\n\tval = realloc(prep_data->value, len);\n\tif (!val)\n\t\treturn false;\n\n\tmemcpy(val + prep_data->length, value, length);\n\n\tprep_data->value = val;\n\tprep_data->length = len;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structprep_write_data",
            "1"
          ],
          "line": 1170
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool prep_data_new(struct bt_gatt_server *server,\n\t\t\t\t\tuint16_t handle, uint16_t offset,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tstruct prep_write_data *prep_data;\n\n\tprep_data = new0(struct prep_write_data, 1);\n\n\tif (!append_prep_data(prep_data, handle, length, value)) {\n\t\tprep_write_data_destroy(prep_data);\n\t\treturn false;\n\t}\n\n\tprep_data->server = server;\n\tprep_data->handle = handle;\n\tprep_data->offset = offset;\n\n\t/*\n\t * Handle is the value handle. We need characteristic declaration\n\t * handle which in BlueZ is handle_value -1\n\t */\n\tprep_data->reliable_supported = is_reliable_write_supported(server,\n\t\t\t\t\t\t\t\thandle - 1);\n\n\tqueue_push_tail(server->prep_queue, prep_data);\n\n\treturn true;\n}"
  },
  {
    "function_name": "is_reliable_write_supported",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1147-1162",
    "snippet": "static bool is_reliable_write_supported(const struct bt_gatt_server  *server,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attr;\n\tuint16_t ext_prop;\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr)\n\t\treturn false;\n\n\tif (!gatt_db_attribute_get_char_data(attr, NULL, NULL, NULL, &ext_prop,\n\t\t\t\t\t\t\t\t\tNULL))\n\t\treturn false;\n\n\treturn (ext_prop & BT_GATT_CHRC_EXT_PROP_RELIABLE_WRITE);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_char_data",
          "args": [
            "attr",
            "NULL",
            "NULL",
            "NULL",
            "&ext_prop",
            "NULL"
          ],
          "line": 1157
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_char_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1625-1664",
          "snippet": "bool gatt_db_attribute_get_char_data(const struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\tuint16_t *handle,\n\t\t\t\t\t\t\tuint16_t *value_handle,\n\t\t\t\t\t\t\tuint8_t *properties,\n\t\t\t\t\t\t\tuint16_t *ext_prop,\n\t\t\t\t\t\t\tbt_uuid_t *uuid)\n{\n\tif (!attrib)\n\t\treturn false;\n\n\tif (bt_uuid_cmp(&characteristic_uuid, &attrib->uuid))\n\t\treturn false;\n\n\t/*\n\t * Characteristic declaration value:\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (!attrib->value || (attrib->value_len != 5 &&\n\t\t\t\t\t\tattrib->value_len != 19))\n\t\treturn false;\n\n\tif (handle)\n\t\t*handle = attrib->handle;\n\n\tif (properties)\n\t\t*properties = attrib->value[0];\n\n\tif (ext_prop)\n\t\t*ext_prop = get_char_extended_prop(attrib);\n\n\tif (value_handle)\n\t\t*value_handle = get_le16(attrib->value + 1);\n\n\tif (!uuid)\n\t\treturn true;\n\n\treturn le_to_uuid(attrib->value + 3, attrib->value_len - 3, uuid);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const bt_uuid_t characteristic_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_CHARAC_UUID };"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstatic const bt_uuid_t characteristic_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_CHARAC_UUID };\n\nbool gatt_db_attribute_get_char_data(const struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\tuint16_t *handle,\n\t\t\t\t\t\t\tuint16_t *value_handle,\n\t\t\t\t\t\t\tuint8_t *properties,\n\t\t\t\t\t\t\tuint16_t *ext_prop,\n\t\t\t\t\t\t\tbt_uuid_t *uuid)\n{\n\tif (!attrib)\n\t\treturn false;\n\n\tif (bt_uuid_cmp(&characteristic_uuid, &attrib->uuid))\n\t\treturn false;\n\n\t/*\n\t * Characteristic declaration value:\n\t * 1 octet: Characteristic properties\n\t * 2 octets: Characteristic value handle\n\t * 2 or 16 octets: characteristic UUID\n\t */\n\tif (!attrib->value || (attrib->value_len != 5 &&\n\t\t\t\t\t\tattrib->value_len != 19))\n\t\treturn false;\n\n\tif (handle)\n\t\t*handle = attrib->handle;\n\n\tif (properties)\n\t\t*properties = attrib->value[0];\n\n\tif (ext_prop)\n\t\t*ext_prop = get_char_extended_prop(attrib);\n\n\tif (value_handle)\n\t\t*value_handle = get_le16(attrib->value + 1);\n\n\tif (!uuid)\n\t\treturn true;\n\n\treturn le_to_uuid(attrib->value + 3, attrib->value_len - 3, uuid);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_get_attribute",
          "args": [
            "server->db",
            "handle"
          ],
          "line": 1153
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_get_attribute",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1423-1445",
          "snippet": "struct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool is_reliable_write_supported(const struct bt_gatt_server  *server,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attr;\n\tuint16_t ext_prop;\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr)\n\t\treturn false;\n\n\tif (!gatt_db_attribute_get_char_data(attr, NULL, NULL, NULL, &ext_prop,\n\t\t\t\t\t\t\t\t\tNULL))\n\t\treturn false;\n\n\treturn (ext_prop & BT_GATT_CHRC_EXT_PROP_RELIABLE_WRITE);\n}"
  },
  {
    "function_name": "append_prep_data",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1124-1145",
    "snippet": "static bool append_prep_data(struct prep_write_data *prep_data, uint16_t handle,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tuint8_t *val;\n\tuint16_t len;\n\n\tif (!length)\n\t\treturn true;\n\n\tlen = prep_data->length + length;\n\n\tval = realloc(prep_data->value, len);\n\tif (!val)\n\t\treturn false;\n\n\tmemcpy(val + prep_data->length, value, length);\n\n\tprep_data->value = val;\n\tprep_data->length = len;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "val + prep_data->length",
            "value",
            "length"
          ],
          "line": 1139
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "realloc",
          "args": [
            "prep_data->value",
            "len"
          ],
          "line": 1135
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool append_prep_data(struct prep_write_data *prep_data, uint16_t handle,\n\t\t\t\t\tuint16_t length, uint8_t *value)\n{\n\tuint8_t *val;\n\tuint16_t len;\n\n\tif (!length)\n\t\treturn true;\n\n\tlen = prep_data->length + length;\n\n\tval = realloc(prep_data->value, len);\n\tif (!val)\n\t\treturn false;\n\n\tmemcpy(val + prep_data->length, value, length);\n\n\tprep_data->value = val;\n\tprep_data->length = len;\n\n\treturn true;\n}"
  },
  {
    "function_name": "read_multiple_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1070-1122",
    "snippet": "static void read_multiple_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tstruct gatt_db_attribute *attr;\n\tstruct read_multiple_resp_data *data = NULL;\n\tuint8_t ecode = BT_ATT_ERROR_UNLIKELY;\n\tsize_t i = 0;\n\n\tif (length < 4) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tdata = new0(struct read_multiple_resp_data, 1);\n\tdata->handles = NULL;\n\tdata->rsp_data = NULL;\n\tdata->server = server;\n\tdata->num_handles = length / 2;\n\tdata->cur_handle = 0;\n\tdata->mtu = bt_att_get_mtu(server->att);\n\tdata->length = 0;\n\tdata->rsp_data = malloc(data->mtu - 1);\n\n\tif (!data->rsp_data)\n\t\tgoto error;\n\n\tdata->handles = new0(uint16_t, data->num_handles);\n\n\tfor (i = 0; i < data->num_handles; i++)\n\t\tdata->handles[i] = get_le16(pdu + i * 2);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"Read Multiple Req - %zu handles, 1st: 0x%04x\",\n\t\t\tdata->num_handles, data->handles[0]);\n\n\tattr = gatt_db_get_attribute(server->db, data->handles[0]);\n\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tif (gatt_db_attribute_read(attr, 0, opcode, server->att,\n\t\t\t\t\tread_multiple_complete_cb, data))\n\t\treturn;\n\nerror:\n\tif (data)\n\t\tread_multiple_resp_data_free(data);\n\n\tbt_att_send_error_rsp(server->att, opcode, 0, ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "0",
            "ecode"
          ],
          "line": 1121
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "read_multiple_resp_data_free",
          "args": [
            "data"
          ],
          "line": 1119
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_read",
          "args": [
            "attr",
            "0",
            "opcode",
            "server->att",
            "read_multiple_complete_cb",
            "data"
          ],
          "line": 1113
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_read",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1724-1763",
          "snippet": "bool gatt_db_attribute_read(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\tgatt_db_attribute_read_t func, void *user_data)\n{\n\tuint8_t *value;\n\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->read_func) {\n\t\tstruct pending_read *p;\n\n\t\tp = new0(struct pending_read, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->read_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, read_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_reads, p);\n\n\t\tattrib->read_func(attrib, p->id, offset, opcode, att,\n\t\t\t\t\t\t\tattrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Check boundary if value is stored in the db */\n\tif (offset > attrib->value_len) {\n\t\tfunc(attrib, BT_ATT_ERROR_INVALID_OFFSET, NULL, 0, user_data);\n\t\treturn true;\n\t}\n\n\t/* Guard against invalid access if offset equals to value length */\n\tvalue = offset == attrib->value_len ? NULL : &attrib->value[offset];\n\n\tfunc(attrib, 0, value, attrib->value_len - offset, user_data);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATTRIBUTE_TIMEOUT 5000"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\n#define ATTRIBUTE_TIMEOUT 5000\n\nbool gatt_db_attribute_read(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\tgatt_db_attribute_read_t func, void *user_data)\n{\n\tuint8_t *value;\n\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->read_func) {\n\t\tstruct pending_read *p;\n\n\t\tp = new0(struct pending_read, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->read_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, read_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_reads, p);\n\n\t\tattrib->read_func(attrib, p->id, offset, opcode, att,\n\t\t\t\t\t\t\tattrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Check boundary if value is stored in the db */\n\tif (offset > attrib->value_len) {\n\t\tfunc(attrib, BT_ATT_ERROR_INVALID_OFFSET, NULL, 0, user_data);\n\t\treturn true;\n\t}\n\n\t/* Guard against invalid access if offset equals to value length */\n\tvalue = offset == attrib->value_len ? NULL : &attrib->value[offset];\n\n\tfunc(attrib, 0, value, attrib->value_len - offset, user_data);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_get_attribute",
          "args": [
            "server->db",
            "data->handles[0]"
          ],
          "line": 1106
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_get_attribute",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1423-1445",
          "snippet": "struct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "server->debug_callback",
            "server->debug_data",
            "\"Read Multiple Req - %zu handles, 1st: 0x%04x\"",
            "data->num_handles",
            "data->handles[0]"
          ],
          "line": 1102
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + i * 2"
          ],
          "line": 1100
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "uint16_t",
            "data->num_handles"
          ],
          "line": 1097
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "data->mtu - 1"
          ],
          "line": 1092
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "server->att"
          ],
          "line": 1090
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structread_multiple_resp_data",
            "1"
          ],
          "line": 1084
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tstruct gatt_db_attribute *attr;\n\tstruct read_multiple_resp_data *data = NULL;\n\tuint8_t ecode = BT_ATT_ERROR_UNLIKELY;\n\tsize_t i = 0;\n\n\tif (length < 4) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tdata = new0(struct read_multiple_resp_data, 1);\n\tdata->handles = NULL;\n\tdata->rsp_data = NULL;\n\tdata->server = server;\n\tdata->num_handles = length / 2;\n\tdata->cur_handle = 0;\n\tdata->mtu = bt_att_get_mtu(server->att);\n\tdata->length = 0;\n\tdata->rsp_data = malloc(data->mtu - 1);\n\n\tif (!data->rsp_data)\n\t\tgoto error;\n\n\tdata->handles = new0(uint16_t, data->num_handles);\n\n\tfor (i = 0; i < data->num_handles; i++)\n\t\tdata->handles[i] = get_le16(pdu + i * 2);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"Read Multiple Req - %zu handles, 1st: 0x%04x\",\n\t\t\tdata->num_handles, data->handles[0]);\n\n\tattr = gatt_db_get_attribute(server->db, data->handles[0]);\n\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tif (gatt_db_attribute_read(attr, 0, opcode, server->att,\n\t\t\t\t\tread_multiple_complete_cb, data))\n\t\treturn;\n\nerror:\n\tif (data)\n\t\tread_multiple_resp_data_free(data);\n\n\tbt_att_send_error_rsp(server->att, opcode, 0, ecode);\n}"
  },
  {
    "function_name": "read_multiple_complete_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "1001-1068",
    "snippet": "static void read_multiple_complete_cb(struct gatt_db_attribute *attr, int err,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct read_multiple_resp_data *data = user_data;\n\tstruct gatt_db_attribute *next_attr;\n\tuint16_t handle = gatt_db_attribute_get_handle(attr);\n\tuint8_t ecode;\n\n\tif (err != 0) {\n\t\tbt_att_send_error_rsp(data->server->att,\n\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ, handle, err);\n\t\tread_multiple_resp_data_free(data);\n\t\treturn;\n\t}\n\n\tecode = check_permissions(data->server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode) {\n\t\tbt_att_send_error_rsp(data->server->att,\n\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ, handle, ecode);\n\t\tread_multiple_resp_data_free(data);\n\t\treturn;\n\t}\n\n\tlen = MIN(len, data->mtu - data->length - 1);\n\n\tmemcpy(data->rsp_data + data->length, value, len);\n\tdata->length += len;\n\n\tdata->cur_handle++;\n\n\tif ((data->length >= data->mtu - 1) ||\n\t\t\t\t(data->cur_handle == data->num_handles)) {\n\t\tbt_att_send(data->server->att, BT_ATT_OP_READ_MULT_RSP,\n\t\t\t\tdata->rsp_data, data->length, NULL, NULL, NULL);\n\t\tread_multiple_resp_data_free(data);\n\t\treturn;\n\t}\n\n\tutil_debug(data->server->debug_callback, data->server->debug_data,\n\t\t\t\t\"Read Multiple Req - #%zu of %zu: 0x%04x\",\n\t\t\t\tdata->cur_handle + 1, data->num_handles,\n\t\t\t\tdata->handles[data->cur_handle]);\n\n\tnext_attr = gatt_db_get_attribute(data->server->db,\n\t\t\t\t\tdata->handles[data->cur_handle]);\n\n\tif (!next_attr) {\n\t\tbt_att_send_error_rsp(data->server->att,\n\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\tdata->handles[data->cur_handle],\n\t\t\t\t\tBT_ATT_ERROR_INVALID_HANDLE);\n\t\tread_multiple_resp_data_free(data);\n\t\treturn;\n\t}\n\n\tif (!gatt_db_attribute_read(next_attr, 0, BT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\tdata->server->att,\n\t\t\t\t\tread_multiple_complete_cb, data)) {\n\t\tbt_att_send_error_rsp(data->server->att,\n\t\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\t\tdata->handles[data->cur_handle],\n\t\t\t\t\t\tBT_ATT_ERROR_UNLIKELY);\n\t\tread_multiple_resp_data_free(data);\n\t}\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "read_multiple_resp_data_free",
          "args": [
            "data"
          ],
          "line": 1066
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "data->server->att",
            "BT_ATT_OP_READ_MULT_REQ",
            "data->handles[data->cur_handle]",
            "BT_ATT_ERROR_UNLIKELY"
          ],
          "line": 1062
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_read",
          "args": [
            "next_attr",
            "0",
            "BT_ATT_OP_READ_MULT_REQ",
            "data->server->att",
            "read_multiple_complete_cb",
            "data"
          ],
          "line": 1059
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_read",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1724-1763",
          "snippet": "bool gatt_db_attribute_read(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\tgatt_db_attribute_read_t func, void *user_data)\n{\n\tuint8_t *value;\n\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->read_func) {\n\t\tstruct pending_read *p;\n\n\t\tp = new0(struct pending_read, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->read_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, read_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_reads, p);\n\n\t\tattrib->read_func(attrib, p->id, offset, opcode, att,\n\t\t\t\t\t\t\tattrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Check boundary if value is stored in the db */\n\tif (offset > attrib->value_len) {\n\t\tfunc(attrib, BT_ATT_ERROR_INVALID_OFFSET, NULL, 0, user_data);\n\t\treturn true;\n\t}\n\n\t/* Guard against invalid access if offset equals to value length */\n\tvalue = offset == attrib->value_len ? NULL : &attrib->value[offset];\n\n\tfunc(attrib, 0, value, attrib->value_len - offset, user_data);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATTRIBUTE_TIMEOUT 5000"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\n#define ATTRIBUTE_TIMEOUT 5000\n\nbool gatt_db_attribute_read(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\tgatt_db_attribute_read_t func, void *user_data)\n{\n\tuint8_t *value;\n\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->read_func) {\n\t\tstruct pending_read *p;\n\n\t\tp = new0(struct pending_read, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->read_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, read_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_reads, p);\n\n\t\tattrib->read_func(attrib, p->id, offset, opcode, att,\n\t\t\t\t\t\t\tattrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Check boundary if value is stored in the db */\n\tif (offset > attrib->value_len) {\n\t\tfunc(attrib, BT_ATT_ERROR_INVALID_OFFSET, NULL, 0, user_data);\n\t\treturn true;\n\t}\n\n\t/* Guard against invalid access if offset equals to value length */\n\tvalue = offset == attrib->value_len ? NULL : &attrib->value[offset];\n\n\tfunc(attrib, 0, value, attrib->value_len - offset, user_data);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_get_attribute",
          "args": [
            "data->server->db",
            "data->handles[data->cur_handle]"
          ],
          "line": 1047
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_get_attribute",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1423-1445",
          "snippet": "struct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "data->server->debug_callback",
            "data->server->debug_data",
            "\"Read Multiple Req - #%zu of %zu: 0x%04x\"",
            "data->cur_handle + 1",
            "data->num_handles",
            "data->handles[data->cur_handle]"
          ],
          "line": 1042
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "data->server->att",
            "BT_ATT_OP_READ_MULT_RSP",
            "data->rsp_data",
            "data->length",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 1036
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "data->rsp_data + data->length",
            "value",
            "len"
          ],
          "line": 1029
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "len",
            "data->mtu - data->length - 1"
          ],
          "line": 1027
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "check_permissions",
          "args": [
            "data->server",
            "attr",
            "BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT"
          ],
          "line": 1017
        },
        "resolved": true,
        "details": {
          "function_name": "check_permissions",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "392-440",
          "snippet": "static uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 1007
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);\n\nstatic void read_multiple_complete_cb(struct gatt_db_attribute *attr, int err,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct read_multiple_resp_data *data = user_data;\n\tstruct gatt_db_attribute *next_attr;\n\tuint16_t handle = gatt_db_attribute_get_handle(attr);\n\tuint8_t ecode;\n\n\tif (err != 0) {\n\t\tbt_att_send_error_rsp(data->server->att,\n\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ, handle, err);\n\t\tread_multiple_resp_data_free(data);\n\t\treturn;\n\t}\n\n\tecode = check_permissions(data->server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode) {\n\t\tbt_att_send_error_rsp(data->server->att,\n\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ, handle, ecode);\n\t\tread_multiple_resp_data_free(data);\n\t\treturn;\n\t}\n\n\tlen = MIN(len, data->mtu - data->length - 1);\n\n\tmemcpy(data->rsp_data + data->length, value, len);\n\tdata->length += len;\n\n\tdata->cur_handle++;\n\n\tif ((data->length >= data->mtu - 1) ||\n\t\t\t\t(data->cur_handle == data->num_handles)) {\n\t\tbt_att_send(data->server->att, BT_ATT_OP_READ_MULT_RSP,\n\t\t\t\tdata->rsp_data, data->length, NULL, NULL, NULL);\n\t\tread_multiple_resp_data_free(data);\n\t\treturn;\n\t}\n\n\tutil_debug(data->server->debug_callback, data->server->debug_data,\n\t\t\t\t\"Read Multiple Req - #%zu of %zu: 0x%04x\",\n\t\t\t\tdata->cur_handle + 1, data->num_handles,\n\t\t\t\tdata->handles[data->cur_handle]);\n\n\tnext_attr = gatt_db_get_attribute(data->server->db,\n\t\t\t\t\tdata->handles[data->cur_handle]);\n\n\tif (!next_attr) {\n\t\tbt_att_send_error_rsp(data->server->att,\n\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\tdata->handles[data->cur_handle],\n\t\t\t\t\tBT_ATT_ERROR_INVALID_HANDLE);\n\t\tread_multiple_resp_data_free(data);\n\t\treturn;\n\t}\n\n\tif (!gatt_db_attribute_read(next_attr, 0, BT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\tdata->server->att,\n\t\t\t\t\tread_multiple_complete_cb, data)) {\n\t\tbt_att_send_error_rsp(data->server->att,\n\t\t\t\t\t\tBT_ATT_OP_READ_MULT_REQ,\n\t\t\t\t\t\tdata->handles[data->cur_handle],\n\t\t\t\t\t\tBT_ATT_ERROR_UNLIKELY);\n\t\tread_multiple_resp_data_free(data);\n\t}\n}"
  },
  {
    "function_name": "read_multiple_resp_data_free",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "994-999",
    "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "data"
          ],
          "line": 998
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "note": "cyclic_reference_detected"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
  },
  {
    "function_name": "read_blob_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "966-982",
    "snippet": "static void read_blob_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t handle, offset;\n\n\tif (length != 4) {\n\t\tbt_att_send_error_rsp(server->att, opcode, 0,\n\t\t\t\t\t\tBT_ATT_ERROR_INVALID_PDU);\n\t\treturn;\n\t}\n\n\thandle = get_le16(pdu);\n\toffset = get_le16(pdu + 2);\n\n\thandle_read_req(server, opcode, handle, offset);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "handle_read_req",
          "args": [
            "server",
            "opcode",
            "handle",
            "offset"
          ],
          "line": 981
        },
        "resolved": true,
        "details": {
          "function_name": "handle_read_req",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "901-947",
          "snippet": "static void handle_read_req(struct bt_gatt_server *server, uint8_t opcode,\n\t\t\t\t\t\t\t\tuint16_t handle,\n\t\t\t\t\t\t\t\tuint16_t offset)\n{\n\tstruct gatt_db_attribute *attr;\n\tuint8_t ecode;\n\tstruct async_read_op *op = NULL;\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"Read %sReq - handle: 0x%04x\",\n\t\t\topcode == BT_ATT_OP_READ_BLOB_REQ ? \"Blob \" : \"\",\n\t\t\thandle);\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (server->pending_read_op) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\top = new0(struct async_read_op, 1);\n\top->opcode = opcode;\n\top->server = server;\n\tserver->pending_read_op = op;\n\n\tif (gatt_db_attribute_read(attr, offset, opcode, server->att,\n\t\t\t\t\t\t\tread_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tif (op)\n\t\tasync_read_op_destroy(op);\n\n\tbt_att_send_error_rsp(server->att, opcode, handle, ecode);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_read_by_type(struct async_read_op *op);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void handle_read_req(struct bt_gatt_server *server, uint8_t opcode,\n\t\t\t\t\t\t\t\tuint16_t handle,\n\t\t\t\t\t\t\t\tuint16_t offset)\n{\n\tstruct gatt_db_attribute *attr;\n\tuint8_t ecode;\n\tstruct async_read_op *op = NULL;\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"Read %sReq - handle: 0x%04x\",\n\t\t\topcode == BT_ATT_OP_READ_BLOB_REQ ? \"Blob \" : \"\",\n\t\t\thandle);\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (server->pending_read_op) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\top = new0(struct async_read_op, 1);\n\top->opcode = opcode;\n\top->server = server;\n\tserver->pending_read_op = op;\n\n\tif (gatt_db_attribute_read(attr, offset, opcode, server->att,\n\t\t\t\t\t\t\tread_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tif (op)\n\t\tasync_read_op_destroy(op);\n\n\tbt_att_send_error_rsp(server->att, opcode, handle, ecode);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + 2"
          ],
          "line": 979
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "0",
            "BT_ATT_ERROR_INVALID_PDU"
          ],
          "line": 973
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_blob_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t handle, offset;\n\n\tif (length != 4) {\n\t\tbt_att_send_error_rsp(server->att, opcode, 0,\n\t\t\t\t\t\tBT_ATT_ERROR_INVALID_PDU);\n\t\treturn;\n\t}\n\n\thandle = get_le16(pdu);\n\toffset = get_le16(pdu + 2);\n\n\thandle_read_req(server, opcode, handle, offset);\n}"
  },
  {
    "function_name": "read_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "949-964",
    "snippet": "static void read_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t handle;\n\n\tif (length != 2) {\n\t\tbt_att_send_error_rsp(server->att, opcode, 0,\n\t\t\t\t\t\tBT_ATT_ERROR_INVALID_PDU);\n\t\treturn;\n\t}\n\n\thandle = get_le16(pdu);\n\n\thandle_read_req(server, opcode, handle, 0);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "handle_read_req",
          "args": [
            "server",
            "opcode",
            "handle",
            "0"
          ],
          "line": 963
        },
        "resolved": true,
        "details": {
          "function_name": "handle_read_req",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "901-947",
          "snippet": "static void handle_read_req(struct bt_gatt_server *server, uint8_t opcode,\n\t\t\t\t\t\t\t\tuint16_t handle,\n\t\t\t\t\t\t\t\tuint16_t offset)\n{\n\tstruct gatt_db_attribute *attr;\n\tuint8_t ecode;\n\tstruct async_read_op *op = NULL;\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"Read %sReq - handle: 0x%04x\",\n\t\t\topcode == BT_ATT_OP_READ_BLOB_REQ ? \"Blob \" : \"\",\n\t\t\thandle);\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (server->pending_read_op) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\top = new0(struct async_read_op, 1);\n\top->opcode = opcode;\n\top->server = server;\n\tserver->pending_read_op = op;\n\n\tif (gatt_db_attribute_read(attr, offset, opcode, server->att,\n\t\t\t\t\t\t\tread_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tif (op)\n\t\tasync_read_op_destroy(op);\n\n\tbt_att_send_error_rsp(server->att, opcode, handle, ecode);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_read_by_type(struct async_read_op *op);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void handle_read_req(struct bt_gatt_server *server, uint8_t opcode,\n\t\t\t\t\t\t\t\tuint16_t handle,\n\t\t\t\t\t\t\t\tuint16_t offset)\n{\n\tstruct gatt_db_attribute *attr;\n\tuint8_t ecode;\n\tstruct async_read_op *op = NULL;\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"Read %sReq - handle: 0x%04x\",\n\t\t\topcode == BT_ATT_OP_READ_BLOB_REQ ? \"Blob \" : \"\",\n\t\t\thandle);\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (server->pending_read_op) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\top = new0(struct async_read_op, 1);\n\top->opcode = opcode;\n\top->server = server;\n\tserver->pending_read_op = op;\n\n\tif (gatt_db_attribute_read(attr, offset, opcode, server->att,\n\t\t\t\t\t\t\tread_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tif (op)\n\t\tasync_read_op_destroy(op);\n\n\tbt_att_send_error_rsp(server->att, opcode, handle, ecode);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu"
          ],
          "line": 961
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "0",
            "BT_ATT_ERROR_INVALID_PDU"
          ],
          "line": 956
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t handle;\n\n\tif (length != 2) {\n\t\tbt_att_send_error_rsp(server->att, opcode, 0,\n\t\t\t\t\t\tBT_ATT_ERROR_INVALID_PDU);\n\t\treturn;\n\t}\n\n\thandle = get_le16(pdu);\n\n\thandle_read_req(server, opcode, handle, 0);\n}"
  },
  {
    "function_name": "handle_read_req",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "901-947",
    "snippet": "static void handle_read_req(struct bt_gatt_server *server, uint8_t opcode,\n\t\t\t\t\t\t\t\tuint16_t handle,\n\t\t\t\t\t\t\t\tuint16_t offset)\n{\n\tstruct gatt_db_attribute *attr;\n\tuint8_t ecode;\n\tstruct async_read_op *op = NULL;\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"Read %sReq - handle: 0x%04x\",\n\t\t\topcode == BT_ATT_OP_READ_BLOB_REQ ? \"Blob \" : \"\",\n\t\t\thandle);\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (server->pending_read_op) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\top = new0(struct async_read_op, 1);\n\top->opcode = opcode;\n\top->server = server;\n\tserver->pending_read_op = op;\n\n\tif (gatt_db_attribute_read(attr, offset, opcode, server->att,\n\t\t\t\t\t\t\tread_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tif (op)\n\t\tasync_read_op_destroy(op);\n\n\tbt_att_send_error_rsp(server->att, opcode, handle, ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_read_by_type(struct async_read_op *op);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "handle",
            "ecode"
          ],
          "line": 946
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "async_read_op_destroy",
          "args": [
            "op"
          ],
          "line": 944
        },
        "resolved": true,
        "details": {
          "function_name": "async_read_op_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "319-327",
          "snippet": "static void async_read_op_destroy(struct async_read_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_read_op = NULL;\n\n\tqueue_destroy(op->db_data, NULL);\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_read_by_type(struct async_read_op *op);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void async_read_op_destroy(struct async_read_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_read_op = NULL;\n\n\tqueue_destroy(op->db_data, NULL);\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_read",
          "args": [
            "attr",
            "offset",
            "opcode",
            "server->att",
            "read_complete_cb",
            "op"
          ],
          "line": 936
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_read",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1724-1763",
          "snippet": "bool gatt_db_attribute_read(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\tgatt_db_attribute_read_t func, void *user_data)\n{\n\tuint8_t *value;\n\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->read_func) {\n\t\tstruct pending_read *p;\n\n\t\tp = new0(struct pending_read, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->read_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, read_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_reads, p);\n\n\t\tattrib->read_func(attrib, p->id, offset, opcode, att,\n\t\t\t\t\t\t\tattrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Check boundary if value is stored in the db */\n\tif (offset > attrib->value_len) {\n\t\tfunc(attrib, BT_ATT_ERROR_INVALID_OFFSET, NULL, 0, user_data);\n\t\treturn true;\n\t}\n\n\t/* Guard against invalid access if offset equals to value length */\n\tvalue = offset == attrib->value_len ? NULL : &attrib->value[offset];\n\n\tfunc(attrib, 0, value, attrib->value_len - offset, user_data);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATTRIBUTE_TIMEOUT 5000"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\n#define ATTRIBUTE_TIMEOUT 5000\n\nbool gatt_db_attribute_read(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\tgatt_db_attribute_read_t func, void *user_data)\n{\n\tuint8_t *value;\n\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->read_func) {\n\t\tstruct pending_read *p;\n\n\t\tp = new0(struct pending_read, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->read_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, read_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_reads, p);\n\n\t\tattrib->read_func(attrib, p->id, offset, opcode, att,\n\t\t\t\t\t\t\tattrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Check boundary if value is stored in the db */\n\tif (offset > attrib->value_len) {\n\t\tfunc(attrib, BT_ATT_ERROR_INVALID_OFFSET, NULL, 0, user_data);\n\t\treturn true;\n\t}\n\n\t/* Guard against invalid access if offset equals to value length */\n\tvalue = offset == attrib->value_len ? NULL : &attrib->value[offset];\n\n\tfunc(attrib, 0, value, attrib->value_len - offset, user_data);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structasync_read_op",
            "1"
          ],
          "line": 931
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "check_permissions",
          "args": [
            "server",
            "attr",
            "BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT"
          ],
          "line": 920
        },
        "resolved": true,
        "details": {
          "function_name": "check_permissions",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "392-440",
          "snippet": "static uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "server->debug_callback",
            "server->debug_data",
            "\"Read %sReq - handle: 0x%04x\"",
            "opcode == BT_ATT_OP_READ_BLOB_REQ ? \"Blob \" : \"\"",
            "handle"
          ],
          "line": 915
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_get_attribute",
          "args": [
            "server->db",
            "handle"
          ],
          "line": 909
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_get_attribute",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1423-1445",
          "snippet": "struct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void handle_read_req(struct bt_gatt_server *server, uint8_t opcode,\n\t\t\t\t\t\t\t\tuint16_t handle,\n\t\t\t\t\t\t\t\tuint16_t offset)\n{\n\tstruct gatt_db_attribute *attr;\n\tuint8_t ecode;\n\tstruct async_read_op *op = NULL;\n\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"Read %sReq - handle: 0x%04x\",\n\t\t\topcode == BT_ATT_OP_READ_BLOB_REQ ? \"Blob \" : \"\",\n\t\t\thandle);\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (server->pending_read_op) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\top = new0(struct async_read_op, 1);\n\top->opcode = opcode;\n\top->server = server;\n\tserver->pending_read_op = op;\n\n\tif (gatt_db_attribute_read(attr, offset, opcode, server->att,\n\t\t\t\t\t\t\tread_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tif (op)\n\t\tasync_read_op_destroy(op);\n\n\tbt_att_send_error_rsp(server->att, opcode, handle, ecode);\n}"
  },
  {
    "function_name": "read_complete_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "869-899",
    "snippet": "static void read_complete_cb(struct gatt_db_attribute *attr, int err,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct async_read_op *op = user_data;\n\tstruct bt_gatt_server *server = op->server;\n\tuint8_t rsp_opcode;\n\tuint16_t mtu;\n\tuint16_t handle;\n\n\tif (!server) {\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tmtu = bt_att_get_mtu(server->att);\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\tif (err) {\n\t\tbt_att_send_error_rsp(server->att, op->opcode, handle, err);\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\trsp_opcode = get_read_rsp_opcode(op->opcode);\n\n\tbt_att_send(server->att, rsp_opcode, len ? value : NULL,\n\t\t\t\t\t\tMIN((unsigned) mtu - 1, len),\n\t\t\t\t\t\tNULL, NULL, NULL);\n\tasync_read_op_destroy(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_read_by_type(struct async_read_op *op);",
      "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "async_read_op_destroy",
          "args": [
            "op"
          ],
          "line": 898
        },
        "resolved": true,
        "details": {
          "function_name": "async_read_op_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "319-327",
          "snippet": "static void async_read_op_destroy(struct async_read_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_read_op = NULL;\n\n\tqueue_destroy(op->db_data, NULL);\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_read_by_type(struct async_read_op *op);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void async_read_op_destroy(struct async_read_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_read_op = NULL;\n\n\tqueue_destroy(op->db_data, NULL);\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "rsp_opcode",
            "len ? value : NULL",
            "MIN((unsigned) mtu - 1, len)",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 895
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "(unsigned) mtu - 1",
            "len"
          ],
          "line": 896
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_read_rsp_opcode",
          "args": [
            "op->opcode"
          ],
          "line": 893
        },
        "resolved": true,
        "details": {
          "function_name": "get_read_rsp_opcode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "846-867",
          "snippet": "static uint8_t get_read_rsp_opcode(uint8_t opcode)\n{\n\n\tswitch (opcode) {\n\tcase BT_ATT_OP_READ_REQ:\n\t\treturn BT_ATT_OP_READ_RSP;\n\tcase BT_ATT_OP_READ_BLOB_REQ:\n\t\treturn BT_ATT_OP_READ_BLOB_RSP;\n\tdefault:\n\t\t/*\n\t\t * Should never happen\n\t\t *\n\t\t * TODO: It would be nice to have a debug-mode assert macro\n\t\t * for development builds. This way bugs could be easily catched\n\t\t * during development and there would be self documenting code\n\t\t * that wouldn't be crash release builds.\n\t\t */\n\t\treturn 0;\n\t}\n\n\treturn 0;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic uint8_t get_read_rsp_opcode(uint8_t opcode)\n{\n\n\tswitch (opcode) {\n\tcase BT_ATT_OP_READ_REQ:\n\t\treturn BT_ATT_OP_READ_RSP;\n\tcase BT_ATT_OP_READ_BLOB_REQ:\n\t\treturn BT_ATT_OP_READ_BLOB_RSP;\n\tdefault:\n\t\t/*\n\t\t * Should never happen\n\t\t *\n\t\t * TODO: It would be nice to have a debug-mode assert macro\n\t\t * for development builds. This way bugs could be easily catched\n\t\t * during development and there would be self documenting code\n\t\t * that wouldn't be crash release builds.\n\t\t */\n\t\treturn 0;\n\t}\n\n\treturn 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "op->opcode",
            "handle",
            "err"
          ],
          "line": 888
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 885
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "server->att"
          ],
          "line": 884
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);\n\nstatic void read_complete_cb(struct gatt_db_attribute *attr, int err,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct async_read_op *op = user_data;\n\tstruct bt_gatt_server *server = op->server;\n\tuint8_t rsp_opcode;\n\tuint16_t mtu;\n\tuint16_t handle;\n\n\tif (!server) {\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tmtu = bt_att_get_mtu(server->att);\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\tif (err) {\n\t\tbt_att_send_error_rsp(server->att, op->opcode, handle, err);\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\trsp_opcode = get_read_rsp_opcode(op->opcode);\n\n\tbt_att_send(server->att, rsp_opcode, len ? value : NULL,\n\t\t\t\t\t\tMIN((unsigned) mtu - 1, len),\n\t\t\t\t\t\tNULL, NULL, NULL);\n\tasync_read_op_destroy(op);\n}"
  },
  {
    "function_name": "get_read_rsp_opcode",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "846-867",
    "snippet": "static uint8_t get_read_rsp_opcode(uint8_t opcode)\n{\n\n\tswitch (opcode) {\n\tcase BT_ATT_OP_READ_REQ:\n\t\treturn BT_ATT_OP_READ_RSP;\n\tcase BT_ATT_OP_READ_BLOB_REQ:\n\t\treturn BT_ATT_OP_READ_BLOB_RSP;\n\tdefault:\n\t\t/*\n\t\t * Should never happen\n\t\t *\n\t\t * TODO: It would be nice to have a debug-mode assert macro\n\t\t * for development builds. This way bugs could be easily catched\n\t\t * during development and there would be self documenting code\n\t\t * that wouldn't be crash release builds.\n\t\t */\n\t\treturn 0;\n\t}\n\n\treturn 0;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic uint8_t get_read_rsp_opcode(uint8_t opcode)\n{\n\n\tswitch (opcode) {\n\tcase BT_ATT_OP_READ_REQ:\n\t\treturn BT_ATT_OP_READ_RSP;\n\tcase BT_ATT_OP_READ_BLOB_REQ:\n\t\treturn BT_ATT_OP_READ_BLOB_RSP;\n\tdefault:\n\t\t/*\n\t\t * Should never happen\n\t\t *\n\t\t * TODO: It would be nice to have a debug-mode assert macro\n\t\t * for development builds. This way bugs could be easily catched\n\t\t * during development and there would be self documenting code\n\t\t * that wouldn't be crash release builds.\n\t\t */\n\t\treturn 0;\n\t}\n\n\treturn 0;\n}"
  },
  {
    "function_name": "write_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "788-844",
    "snippet": "static void write_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t handle = 0;\n\tstruct async_write_op *op = NULL;\n\tuint8_t ecode;\n\n\tif (length < 2) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\thandle = get_le16(pdu);\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\"Write %s - handle: 0x%04x\",\n\t\t\t\t(opcode == BT_ATT_OP_WRITE_REQ) ? \"Req\" : \"Cmd\",\n\t\t\t\thandle);\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_WRITE |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (server->pending_write_op) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\top = new0(struct async_write_op, 1);\n\top->server = server;\n\top->opcode = opcode;\n\tserver->pending_write_op = op;\n\n\tif (gatt_db_attribute_write(attr, 0, pdu + 2, length - 2, opcode,\n\t\t\t\t\t\t\tserver->att,\n\t\t\t\t\t\t\twrite_complete_cb, op))\n\t\treturn;\n\n\tasync_write_op_destroy(op);\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tif (opcode == BT_ATT_OP_WRITE_CMD)\n\t\treturn;\n\n\tbt_att_send_error_rsp(server->att, opcode, handle, ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_read_by_type(struct async_read_op *op);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "handle",
            "ecode"
          ],
          "line": 843
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "async_write_op_destroy",
          "args": [
            "op"
          ],
          "line": 835
        },
        "resolved": true,
        "details": {
          "function_name": "async_write_op_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "757-763",
          "snippet": "static void async_write_op_destroy(struct async_write_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_write_op = NULL;\n\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_read_by_type(struct async_read_op *op);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void async_write_op_destroy(struct async_write_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_write_op = NULL;\n\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_write",
          "args": [
            "attr",
            "0",
            "pdu + 2",
            "length - 2",
            "opcode",
            "server->att",
            "write_complete_cb",
            "op"
          ],
          "line": 830
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1805-1860",
          "snippet": "bool gatt_db_attribute_write(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\t\tgatt_db_attribute_write_t func,\n\t\t\t\t\tvoid *user_data)\n{\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->write_func) {\n\t\tstruct pending_write *p;\n\n\t\tp = new0(struct pending_write, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->write_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, write_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_writes, p);\n\n\t\tattrib->write_func(attrib, p->id, offset, value, len, opcode,\n\t\t\t\t\t\t\tatt, attrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Nothing to write just skip */\n\tif (len == 0)\n\t\tgoto done;\n\n\t/* For values stored in db allocate on demand */\n\tif (!attrib->value || offset >= attrib->value_len ||\n\t\t\t\tlen > (unsigned) (attrib->value_len - offset)) {\n\t\tvoid *buf;\n\n\t\tbuf = realloc(attrib->value, len + offset);\n\t\tif (!buf)\n\t\t\treturn false;\n\n\t\tattrib->value = buf;\n\n\t\t/* Init data in the first allocation */\n\t\tif (!attrib->value_len)\n\t\t\tmemset(attrib->value, 0, offset);\n\n\t\tattrib->value_len = len + offset;\n\t}\n\n\tmemcpy(&attrib->value[offset], value, len);\n\ndone:\n\tfunc(attrib, 0, user_data);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATTRIBUTE_TIMEOUT 5000"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\n#define ATTRIBUTE_TIMEOUT 5000\n\nbool gatt_db_attribute_write(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\t\tconst uint8_t *value, size_t len,\n\t\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\t\tgatt_db_attribute_write_t func,\n\t\t\t\t\tvoid *user_data)\n{\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->write_func) {\n\t\tstruct pending_write *p;\n\n\t\tp = new0(struct pending_write, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->write_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, write_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_writes, p);\n\n\t\tattrib->write_func(attrib, p->id, offset, value, len, opcode,\n\t\t\t\t\t\t\tatt, attrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Nothing to write just skip */\n\tif (len == 0)\n\t\tgoto done;\n\n\t/* For values stored in db allocate on demand */\n\tif (!attrib->value || offset >= attrib->value_len ||\n\t\t\t\tlen > (unsigned) (attrib->value_len - offset)) {\n\t\tvoid *buf;\n\n\t\tbuf = realloc(attrib->value, len + offset);\n\t\tif (!buf)\n\t\t\treturn false;\n\n\t\tattrib->value = buf;\n\n\t\t/* Init data in the first allocation */\n\t\tif (!attrib->value_len)\n\t\t\tmemset(attrib->value, 0, offset);\n\n\t\tattrib->value_len = len + offset;\n\t}\n\n\tmemcpy(&attrib->value[offset], value, len);\n\ndone:\n\tfunc(attrib, 0, user_data);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structasync_write_op",
            "1"
          ],
          "line": 825
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "check_permissions",
          "args": [
            "server",
            "attr",
            "BT_ATT_PERM_WRITE |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_ENCRYPT"
          ],
          "line": 814
        },
        "resolved": true,
        "details": {
          "function_name": "check_permissions",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "392-440",
          "snippet": "static uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "server->debug_callback",
            "server->debug_data",
            "\"Write %s - handle: 0x%04x\"",
            "(opcode == BT_ATT_OP_WRITE_REQ) ? \"Req\" : \"Cmd\"",
            "handle"
          ],
          "line": 809
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_get_attribute",
          "args": [
            "server->db",
            "handle"
          ],
          "line": 803
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_get_attribute",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1423-1445",
          "snippet": "struct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstruct gatt_db_attribute *gatt_db_get_attribute(struct gatt_db *db,\n\t\t\t\t\t\t\tuint16_t handle)\n{\n\tstruct gatt_db_attribute *attrib;\n\tstruct gatt_db_service *service;\n\tint i;\n\n\tattrib = gatt_db_get_service(db, handle);\n\tif (!attrib)\n\t\treturn NULL;\n\n\tservice = attrib->service;\n\n\tfor (i = 0; i < service->num_handles; i++) {\n\t\tif (!service->attributes[i])\n\t\t\tcontinue;\n\n\t\tif (service->attributes[i]->handle == handle)\n\t\t\treturn service->attributes[i];\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu"
          ],
          "line": 802
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void write_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tstruct gatt_db_attribute *attr;\n\tuint16_t handle = 0;\n\tstruct async_write_op *op = NULL;\n\tuint8_t ecode;\n\n\tif (length < 2) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\thandle = get_le16(pdu);\n\tattr = gatt_db_get_attribute(server->db, handle);\n\tif (!attr) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\"Write %s - handle: 0x%04x\",\n\t\t\t\t(opcode == BT_ATT_OP_WRITE_REQ) ? \"Req\" : \"Cmd\",\n\t\t\t\thandle);\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_WRITE |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_WRITE_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (server->pending_write_op) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\top = new0(struct async_write_op, 1);\n\top->server = server;\n\top->opcode = opcode;\n\tserver->pending_write_op = op;\n\n\tif (gatt_db_attribute_write(attr, 0, pdu + 2, length - 2, opcode,\n\t\t\t\t\t\t\tserver->att,\n\t\t\t\t\t\t\twrite_complete_cb, op))\n\t\treturn;\n\n\tasync_write_op_destroy(op);\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tif (opcode == BT_ATT_OP_WRITE_CMD)\n\t\treturn;\n\n\tbt_att_send_error_rsp(server->att, opcode, handle, ecode);\n}"
  },
  {
    "function_name": "write_complete_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "765-786",
    "snippet": "static void write_complete_cb(struct gatt_db_attribute *attr, int err,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct async_write_op *op = user_data;\n\tstruct bt_gatt_server *server = op->server;\n\tuint16_t handle;\n\n\tif (!server || op->opcode == BT_ATT_OP_WRITE_CMD) {\n\t\tasync_write_op_destroy(op);\n\t\treturn;\n\t}\n\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\tif (err)\n\t\tbt_att_send_error_rsp(server->att, op->opcode, handle, err);\n\telse\n\t\tbt_att_send(server->att, BT_ATT_OP_WRITE_RSP, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\tasync_write_op_destroy(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_read_by_type(struct async_read_op *op);",
      "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "async_write_op_destroy",
          "args": [
            "op"
          ],
          "line": 785
        },
        "resolved": true,
        "details": {
          "function_name": "async_write_op_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "757-763",
          "snippet": "static void async_write_op_destroy(struct async_write_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_write_op = NULL;\n\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_read_by_type(struct async_read_op *op);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void async_write_op_destroy(struct async_write_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_write_op = NULL;\n\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "BT_ATT_OP_WRITE_RSP",
            "NULL",
            "0",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 782
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "op->opcode",
            "handle",
            "err"
          ],
          "line": 780
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 777
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);\n\nstatic void write_complete_cb(struct gatt_db_attribute *attr, int err,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct async_write_op *op = user_data;\n\tstruct bt_gatt_server *server = op->server;\n\tuint16_t handle;\n\n\tif (!server || op->opcode == BT_ATT_OP_WRITE_CMD) {\n\t\tasync_write_op_destroy(op);\n\t\treturn;\n\t}\n\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\tif (err)\n\t\tbt_att_send_error_rsp(server->att, op->opcode, handle, err);\n\telse\n\t\tbt_att_send(server->att, BT_ATT_OP_WRITE_RSP, NULL, 0,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\tasync_write_op_destroy(op);\n}"
  },
  {
    "function_name": "async_write_op_destroy",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "757-763",
    "snippet": "static void async_write_op_destroy(struct async_write_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_write_op = NULL;\n\n\tfree(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_read_by_type(struct async_read_op *op);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 762
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void async_write_op_destroy(struct async_write_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_write_op = NULL;\n\n\tfree(op);\n}"
  },
  {
    "function_name": "find_by_type_val_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "702-755",
    "snippet": "static void find_by_type_val_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t start, end, uuid16;\n\tstruct find_by_type_val_data data;\n\tuint16_t mtu = bt_att_get_mtu(server->att);\n\tuint8_t rsp_pdu[mtu];\n\tuint16_t ehandle = 0;\n\tbt_uuid_t uuid;\n\n\tif (length < 6) {\n\t\tdata.ecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tdata.pdu = rsp_pdu;\n\tdata.len = 0;\n\tdata.mtu = mtu;\n\tdata.ecode = 0;\n\n\tstart = get_le16(pdu);\n\tend = get_le16(pdu + 2);\n\tuuid16 = get_le16(pdu + 4);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"Find By Type Value - start: 0x%04x end: 0x%04x uuid: 0x%04x\",\n\t\t\tstart, end, uuid16);\n\tehandle = start;\n\tif (start > end) {\n\t\tdata.ecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tbt_uuid16_create(&uuid, uuid16);\n\tgatt_db_find_by_type_value(server->db, start, end, &uuid, pdu + 6,\n\t\t\t\t\t\t\tlength - 6,\n\t\t\t\t\t\t\tfind_by_type_val_att_cb,\n\t\t\t\t\t\t\t&data);\n\n\tif (!data.len)\n\t\tdata.ecode = BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND;\n\n\tif (data.ecode)\n\t\tgoto error;\n\n\tbt_att_send(server->att, BT_ATT_OP_FIND_BY_TYPE_RSP, data.pdu,\n\t\t\t\t\t\tdata.len, NULL, NULL, NULL);\n\n\treturn;\n\nerror:\n\tbt_att_send_error_rsp(server->att, opcode, ehandle, data.ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "ehandle",
            "data.ecode"
          ],
          "line": 754
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "BT_ATT_OP_FIND_BY_TYPE_RSP",
            "data.pdu",
            "data.len",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 748
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_find_by_type_value",
          "args": [
            "server->db",
            "start",
            "end",
            "&uuid",
            "pdu + 6",
            "length - 6",
            "find_by_type_val_att_cb",
            "&data"
          ],
          "line": 737
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_find_by_type_value",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1135-1157",
          "snippet": "unsigned int gatt_db_find_by_type_value(struct gatt_db *db,\n\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\tuint16_t end_handle,\n\t\t\t\t\t\tconst bt_uuid_t *type,\n\t\t\t\t\t\tconst void *value,\n\t\t\t\t\t\tsize_t value_len,\n\t\t\t\t\t\tgatt_db_attribute_cb_t func,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct find_by_type_value_data data;\n\n\tdata.uuid = *type;\n\tdata.start_handle = start_handle;\n\tdata.end_handle = end_handle;\n\tdata.func = func;\n\tdata.user_data = user_data;\n\tdata.value = value;\n\tdata.value_len = value_len;\n\n\tqueue_foreach(db->services, find_by_type, &data);\n\n\treturn data.num_of_res;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nunsigned int gatt_db_find_by_type_value(struct gatt_db *db,\n\t\t\t\t\t\tuint16_t start_handle,\n\t\t\t\t\t\tuint16_t end_handle,\n\t\t\t\t\t\tconst bt_uuid_t *type,\n\t\t\t\t\t\tconst void *value,\n\t\t\t\t\t\tsize_t value_len,\n\t\t\t\t\t\tgatt_db_attribute_cb_t func,\n\t\t\t\t\t\tvoid *user_data)\n{\n\tstruct find_by_type_value_data data;\n\n\tdata.uuid = *type;\n\tdata.start_handle = start_handle;\n\tdata.end_handle = end_handle;\n\tdata.func = func;\n\tdata.user_data = user_data;\n\tdata.value = value;\n\tdata.value_len = value_len;\n\n\tqueue_foreach(db->services, find_by_type, &data);\n\n\treturn data.num_of_res;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid16_create",
          "args": [
            "&uuid",
            "uuid16"
          ],
          "line": 736
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "server->debug_callback",
            "server->debug_data",
            "\"Find By Type Value - start: 0x%04x end: 0x%04x uuid: 0x%04x\"",
            "start",
            "end",
            "uuid16"
          ],
          "line": 727
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + 4"
          ],
          "line": 725
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "server->att"
          ],
          "line": 708
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void find_by_type_val_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t start, end, uuid16;\n\tstruct find_by_type_val_data data;\n\tuint16_t mtu = bt_att_get_mtu(server->att);\n\tuint8_t rsp_pdu[mtu];\n\tuint16_t ehandle = 0;\n\tbt_uuid_t uuid;\n\n\tif (length < 6) {\n\t\tdata.ecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tdata.pdu = rsp_pdu;\n\tdata.len = 0;\n\tdata.mtu = mtu;\n\tdata.ecode = 0;\n\n\tstart = get_le16(pdu);\n\tend = get_le16(pdu + 2);\n\tuuid16 = get_le16(pdu + 4);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\"Find By Type Value - start: 0x%04x end: 0x%04x uuid: 0x%04x\",\n\t\t\tstart, end, uuid16);\n\tehandle = start;\n\tif (start > end) {\n\t\tdata.ecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tbt_uuid16_create(&uuid, uuid16);\n\tgatt_db_find_by_type_value(server->db, start, end, &uuid, pdu + 6,\n\t\t\t\t\t\t\tlength - 6,\n\t\t\t\t\t\t\tfind_by_type_val_att_cb,\n\t\t\t\t\t\t\t&data);\n\n\tif (!data.len)\n\t\tdata.ecode = BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND;\n\n\tif (data.ecode)\n\t\tgoto error;\n\n\tbt_att_send(server->att, BT_ATT_OP_FIND_BY_TYPE_RSP, data.pdu,\n\t\t\t\t\t\tdata.len, NULL, NULL, NULL);\n\n\treturn;\n\nerror:\n\tbt_att_send_error_rsp(server->att, opcode, ehandle, data.ecode);\n}"
  },
  {
    "function_name": "find_by_type_val_att_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "672-700",
    "snippet": "static void find_by_type_val_att_cb(struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tuint16_t handle, end_handle;\n\tstruct find_by_type_val_data *data = user_data;\n\n\tif (data->ecode)\n\t\treturn;\n\n\tif (data->len + 4 > data->mtu - 1)\n\t\treturn;\n\n\t/*\n\t * This OP is only valid for Primary Service per the spec\n\t * page 562, so this should work.\n\t */\n\tgatt_db_attribute_get_service_data(attrib, &handle, &end_handle, NULL,\n\t\t\t\t\t\t\t\t\tNULL);\n\n\tif (!handle || !end_handle) {\n\t\tdata->ecode = BT_ATT_ERROR_UNLIKELY;\n\t\treturn;\n\t}\n\n\tput_le16(handle, data->pdu + data->len);\n\tput_le16(end_handle, data->pdu + data->len + 2);\n\n\tdata->len += 4;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "end_handle",
            "data->pdu + data->len + 2"
          ],
          "line": 697
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_service_data",
          "args": [
            "attrib",
            "&handle",
            "&end_handle",
            "NULL",
            "NULL"
          ],
          "line": 688
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_service_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1538-1566",
          "snippet": "bool gatt_db_attribute_get_service_data(const struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\tuint16_t *start_handle,\n\t\t\t\t\t\t\tuint16_t *end_handle,\n\t\t\t\t\t\t\tbool *primary,\n\t\t\t\t\t\t\tbt_uuid_t *uuid)\n{\n\tstruct gatt_db_service *service;\n\tstruct gatt_db_attribute *decl;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\tdecl = service->attributes[0];\n\n\tgatt_db_service_get_handles(service, start_handle, end_handle);\n\n\tif (primary)\n\t\t*primary = bt_uuid_cmp(&decl->uuid, &secondary_service_uuid);\n\n\tif (!uuid)\n\t\treturn true;\n\n\t/*\n\t * The service declaration attribute value is the 16 or 128 bit service\n\t * UUID.\n\t */\n\treturn le_to_uuid(decl->value, decl->value_len, uuid);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static const bt_uuid_t secondary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_SND_SVC_UUID };"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nstatic const bt_uuid_t secondary_service_uuid = { .type = BT_UUID16,\n\t\t\t\t\t.value.u16 = GATT_SND_SVC_UUID };\n\nbool gatt_db_attribute_get_service_data(const struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\tuint16_t *start_handle,\n\t\t\t\t\t\t\tuint16_t *end_handle,\n\t\t\t\t\t\t\tbool *primary,\n\t\t\t\t\t\t\tbt_uuid_t *uuid)\n{\n\tstruct gatt_db_service *service;\n\tstruct gatt_db_attribute *decl;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\tdecl = service->attributes[0];\n\n\tgatt_db_service_get_handles(service, start_handle, end_handle);\n\n\tif (primary)\n\t\t*primary = bt_uuid_cmp(&decl->uuid, &secondary_service_uuid);\n\n\tif (!uuid)\n\t\treturn true;\n\n\t/*\n\t * The service declaration attribute value is the 16 or 128 bit service\n\t * UUID.\n\t */\n\treturn le_to_uuid(decl->value, decl->value_len, uuid);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void find_by_type_val_att_cb(struct gatt_db_attribute *attrib,\n\t\t\t\t\t\t\t\tvoid *user_data)\n{\n\tuint16_t handle, end_handle;\n\tstruct find_by_type_val_data *data = user_data;\n\n\tif (data->ecode)\n\t\treturn;\n\n\tif (data->len + 4 > data->mtu - 1)\n\t\treturn;\n\n\t/*\n\t * This OP is only valid for Primary Service per the spec\n\t * page 562, so this should work.\n\t */\n\tgatt_db_attribute_get_service_data(attrib, &handle, &end_handle, NULL,\n\t\t\t\t\t\t\t\t\tNULL);\n\n\tif (!handle || !end_handle) {\n\t\tdata->ecode = BT_ATT_ERROR_UNLIKELY;\n\t\treturn;\n\t}\n\n\tput_le16(handle, data->pdu + data->len);\n\tput_le16(end_handle, data->pdu + data->len + 2);\n\n\tdata->len += 4;\n}"
  },
  {
    "function_name": "find_info_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "603-663",
    "snippet": "static void find_info_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t start, end;\n\tuint16_t mtu = bt_att_get_mtu(server->att);\n\tuint8_t rsp_pdu[mtu];\n\tuint16_t rsp_len;\n\tuint8_t ecode = 0;\n\tuint16_t ehandle = 0;\n\tstruct queue *q = NULL;\n\n\tif (length != 4) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tq = queue_new();\n\n\tstart = get_le16(pdu);\n\tend = get_le16(pdu + 2);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\t\"Find Info - start: 0x%04x end: 0x%04x\",\n\t\t\t\t\tstart, end);\n\n\tif (!start || !end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tehandle = start;\n\n\tif (start > end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tgatt_db_find_information(server->db, start, end, q);\n\n\tif (queue_isempty(q)) {\n\t\tecode = BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND;\n\t\tgoto error;\n\t}\n\n\tif (!encode_find_info_rsp(server->db, q, mtu, rsp_pdu, &rsp_len)) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\tbt_att_send(server->att, BT_ATT_OP_FIND_INFO_RSP, rsp_pdu, rsp_len,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\tqueue_destroy(q, NULL);\n\n\treturn;\n\nerror:\n\tbt_att_send_error_rsp(server->att, opcode, ehandle, ecode);\n\tqueue_destroy(q, NULL);\n\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "q",
            "NULL"
          ],
          "line": 661
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "ehandle",
            "ecode"
          ],
          "line": 660
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "BT_ATT_OP_FIND_INFO_RSP",
            "rsp_pdu",
            "rsp_len",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 653
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "encode_find_info_rsp",
          "args": [
            "server->db",
            "q",
            "mtu",
            "rsp_pdu",
            "&rsp_len"
          ],
          "line": 648
        },
        "resolved": true,
        "details": {
          "function_name": "encode_find_info_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "549-601",
          "snippet": "static bool encode_find_info_rsp(struct gatt_db *db, struct queue *q,\n\t\t\t\t\t\tuint16_t mtu,\n\t\t\t\t\t\tuint8_t *pdu, uint16_t *len)\n{\n\tuint16_t handle;\n\tstruct gatt_db_attribute *attr;\n\tconst bt_uuid_t *type;\n\tint uuid_len, cur_uuid_len;\n\tint iter = 0;\n\n\t*len = 0;\n\n\twhile (queue_peek_head(q)) {\n\t\tattr = queue_pop_head(q);\n\t\thandle = gatt_db_attribute_get_handle(attr);\n\t\ttype = gatt_db_attribute_get_type(attr);\n\t\tif (!handle || !type)\n\t\t\treturn false;\n\n\t\tcur_uuid_len = bt_uuid_len(type);\n\n\t\tif (iter == 0) {\n\t\t\tswitch (cur_uuid_len) {\n\t\t\tcase 2:\n\t\t\t\tuuid_len = 2;\n\t\t\t\tpdu[0] = 0x01;\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\tcase 16:\n\t\t\t\tuuid_len = 16;\n\t\t\t\tpdu[0] = 0x02;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\titer++;\n\t\t} else if (cur_uuid_len != uuid_len)\n\t\t\tbreak;\n\n\t\tif (iter + uuid_len + 2 > mtu - 1)\n\t\t\tbreak;\n\n\t\tput_le16(handle, pdu + iter);\n\t\tbt_uuid_to_le(type, pdu + iter + 2);\n\n\t\titer += uuid_len + 2;\n\t}\n\n\t*len = iter;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool encode_find_info_rsp(struct gatt_db *db, struct queue *q,\n\t\t\t\t\t\tuint16_t mtu,\n\t\t\t\t\t\tuint8_t *pdu, uint16_t *len)\n{\n\tuint16_t handle;\n\tstruct gatt_db_attribute *attr;\n\tconst bt_uuid_t *type;\n\tint uuid_len, cur_uuid_len;\n\tint iter = 0;\n\n\t*len = 0;\n\n\twhile (queue_peek_head(q)) {\n\t\tattr = queue_pop_head(q);\n\t\thandle = gatt_db_attribute_get_handle(attr);\n\t\ttype = gatt_db_attribute_get_type(attr);\n\t\tif (!handle || !type)\n\t\t\treturn false;\n\n\t\tcur_uuid_len = bt_uuid_len(type);\n\n\t\tif (iter == 0) {\n\t\t\tswitch (cur_uuid_len) {\n\t\t\tcase 2:\n\t\t\t\tuuid_len = 2;\n\t\t\t\tpdu[0] = 0x01;\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\tcase 16:\n\t\t\t\tuuid_len = 16;\n\t\t\t\tpdu[0] = 0x02;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\titer++;\n\t\t} else if (cur_uuid_len != uuid_len)\n\t\t\tbreak;\n\n\t\tif (iter + uuid_len + 2 > mtu - 1)\n\t\t\tbreak;\n\n\t\tput_le16(handle, pdu + iter);\n\t\tbt_uuid_to_le(type, pdu + iter + 2);\n\n\t\titer += uuid_len + 2;\n\t}\n\n\t*len = iter;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_isempty",
          "args": [
            "q"
          ],
          "line": 643
        },
        "resolved": true,
        "details": {
          "function_name": "queue_isempty",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "380-386",
          "snippet": "bool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_find_information",
          "args": [
            "server->db",
            "start",
            "end",
            "q"
          ],
          "line": 641
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_find_information",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1245-1256",
          "snippet": "void gatt_db_find_information(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle,\n\t\t\t\t\t\t\tstruct queue *queue)\n{\n\tstruct find_information_data data;\n\n\tdata.start_handle = start_handle;\n\tdata.end_handle = end_handle;\n\tdata.queue = queue;\n\n\tqueue_foreach(db->services, find_information, &data);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nvoid gatt_db_find_information(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle,\n\t\t\t\t\t\t\tstruct queue *queue)\n{\n\tstruct find_information_data data;\n\n\tdata.start_handle = start_handle;\n\tdata.end_handle = end_handle;\n\tdata.queue = queue;\n\n\tqueue_foreach(db->services, find_information, &data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "server->debug_callback",
            "server->debug_data",
            "\"Find Info - start: 0x%04x end: 0x%04x\"",
            "start",
            "end"
          ],
          "line": 625
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + 2"
          ],
          "line": 623
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_new",
          "args": [],
          "line": 620
        },
        "resolved": true,
        "details": {
          "function_name": "queue_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "56-66",
          "snippet": "struct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nstruct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "server->att"
          ],
          "line": 608
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void find_info_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t start, end;\n\tuint16_t mtu = bt_att_get_mtu(server->att);\n\tuint8_t rsp_pdu[mtu];\n\tuint16_t rsp_len;\n\tuint8_t ecode = 0;\n\tuint16_t ehandle = 0;\n\tstruct queue *q = NULL;\n\n\tif (length != 4) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tq = queue_new();\n\n\tstart = get_le16(pdu);\n\tend = get_le16(pdu + 2);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\t\"Find Info - start: 0x%04x end: 0x%04x\",\n\t\t\t\t\tstart, end);\n\n\tif (!start || !end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tehandle = start;\n\n\tif (start > end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tgatt_db_find_information(server->db, start, end, q);\n\n\tif (queue_isempty(q)) {\n\t\tecode = BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND;\n\t\tgoto error;\n\t}\n\n\tif (!encode_find_info_rsp(server->db, q, mtu, rsp_pdu, &rsp_len)) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\tbt_att_send(server->att, BT_ATT_OP_FIND_INFO_RSP, rsp_pdu, rsp_len,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\tqueue_destroy(q, NULL);\n\n\treturn;\n\nerror:\n\tbt_att_send_error_rsp(server->att, opcode, ehandle, ecode);\n\tqueue_destroy(q, NULL);\n\n}"
  },
  {
    "function_name": "encode_find_info_rsp",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "549-601",
    "snippet": "static bool encode_find_info_rsp(struct gatt_db *db, struct queue *q,\n\t\t\t\t\t\tuint16_t mtu,\n\t\t\t\t\t\tuint8_t *pdu, uint16_t *len)\n{\n\tuint16_t handle;\n\tstruct gatt_db_attribute *attr;\n\tconst bt_uuid_t *type;\n\tint uuid_len, cur_uuid_len;\n\tint iter = 0;\n\n\t*len = 0;\n\n\twhile (queue_peek_head(q)) {\n\t\tattr = queue_pop_head(q);\n\t\thandle = gatt_db_attribute_get_handle(attr);\n\t\ttype = gatt_db_attribute_get_type(attr);\n\t\tif (!handle || !type)\n\t\t\treturn false;\n\n\t\tcur_uuid_len = bt_uuid_len(type);\n\n\t\tif (iter == 0) {\n\t\t\tswitch (cur_uuid_len) {\n\t\t\tcase 2:\n\t\t\t\tuuid_len = 2;\n\t\t\t\tpdu[0] = 0x01;\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\tcase 16:\n\t\t\t\tuuid_len = 16;\n\t\t\t\tpdu[0] = 0x02;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\titer++;\n\t\t} else if (cur_uuid_len != uuid_len)\n\t\t\tbreak;\n\n\t\tif (iter + uuid_len + 2 > mtu - 1)\n\t\t\tbreak;\n\n\t\tput_le16(handle, pdu + iter);\n\t\tbt_uuid_to_le(type, pdu + iter + 2);\n\n\t\titer += uuid_len + 2;\n\t}\n\n\t*len = iter;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_uuid_to_le",
          "args": [
            "type",
            "pdu + iter + 2"
          ],
          "line": 593
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "handle",
            "pdu + iter"
          ],
          "line": 592
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_len",
          "args": [
            "type"
          ],
          "line": 568
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_type",
          "args": [
            "attr"
          ],
          "line": 564
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1473-1480",
          "snippet": "const bt_uuid_t *gatt_db_attribute_get_type(\n\t\t\t\t\tconst struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn &attrib->uuid;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nconst bt_uuid_t *gatt_db_attribute_get_type(\n\t\t\t\t\tconst struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn NULL;\n\n\treturn &attrib->uuid;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 563
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "q"
          ],
          "line": 562
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_peek_head",
          "args": [
            "q"
          ],
          "line": 561
        },
        "resolved": true,
        "details": {
          "function_name": "queue_peek_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "187-193",
          "snippet": "void *queue_peek_head(struct queue *queue)\n{\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\treturn queue->head->data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_peek_head(struct queue *queue)\n{\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\treturn queue->head->data;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool encode_find_info_rsp(struct gatt_db *db, struct queue *q,\n\t\t\t\t\t\tuint16_t mtu,\n\t\t\t\t\t\tuint8_t *pdu, uint16_t *len)\n{\n\tuint16_t handle;\n\tstruct gatt_db_attribute *attr;\n\tconst bt_uuid_t *type;\n\tint uuid_len, cur_uuid_len;\n\tint iter = 0;\n\n\t*len = 0;\n\n\twhile (queue_peek_head(q)) {\n\t\tattr = queue_pop_head(q);\n\t\thandle = gatt_db_attribute_get_handle(attr);\n\t\ttype = gatt_db_attribute_get_type(attr);\n\t\tif (!handle || !type)\n\t\t\treturn false;\n\n\t\tcur_uuid_len = bt_uuid_len(type);\n\n\t\tif (iter == 0) {\n\t\t\tswitch (cur_uuid_len) {\n\t\t\tcase 2:\n\t\t\t\tuuid_len = 2;\n\t\t\t\tpdu[0] = 0x01;\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\tcase 16:\n\t\t\t\tuuid_len = 16;\n\t\t\t\tpdu[0] = 0x02;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\titer++;\n\t\t} else if (cur_uuid_len != uuid_len)\n\t\t\tbreak;\n\n\t\tif (iter + uuid_len + 2 > mtu - 1)\n\t\t\tbreak;\n\n\t\tput_le16(handle, pdu + iter);\n\t\tbt_uuid_to_le(type, pdu + iter + 2);\n\n\t\titer += uuid_len + 2;\n\t}\n\n\t*len = iter;\n\n\treturn true;\n}"
  },
  {
    "function_name": "read_by_type_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "477-547",
    "snippet": "static void read_by_type_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t start, end;\n\tbt_uuid_t type;\n\tuint16_t ehandle = 0;\n\tuint8_t ecode;\n\tstruct queue *q = NULL;\n\tstruct async_read_op *op;\n\n\tif (length != 6 && length != 20) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tq = queue_new();\n\n\tstart = get_le16(pdu);\n\tend = get_le16(pdu + 2);\n\tget_uuid_le(pdu + 4, length - 4, &type);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\"Read By Type - start: 0x%04x end: 0x%04x\",\n\t\t\t\tstart, end);\n\n\tif (!start || !end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tehandle = start;\n\n\tif (start > end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tgatt_db_read_by_type(server->db, start, end, type, q);\n\n\tif (queue_isempty(q)) {\n\t\tecode = BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND;\n\t\tgoto error;\n\t}\n\n\tif (server->pending_read_op) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\top = new0(struct async_read_op, 1);\n\top->pdu = malloc(bt_att_get_mtu(server->att));\n\tif (!op->pdu) {\n\t\tfree(op);\n\t\tecode = BT_ATT_ERROR_INSUFFICIENT_RESOURCES;\n\t\tgoto error;\n\t}\n\n\top->opcode = opcode;\n\top->server = server;\n\top->db_data = q;\n\tserver->pending_read_op = op;\n\n\tprocess_read_by_type(op);\n\n\treturn;\n\nerror:\n\tbt_att_send_error_rsp(server->att, opcode, ehandle, ecode);\n\tqueue_destroy(q, NULL);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_read_by_type(struct async_read_op *op);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "q",
            "NULL"
          ],
          "line": 546
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "ehandle",
            "ecode"
          ],
          "line": 545
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_read_by_type",
          "args": [
            "op"
          ],
          "line": 540
        },
        "resolved": true,
        "details": {
          "function_name": "process_read_by_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "442-475",
          "snippet": "static void process_read_by_type(struct async_read_op *op)\n{\n\tstruct bt_gatt_server *server = op->server;\n\tuint8_t ecode;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_pop_head(op->db_data);\n\n\tif (op->done || !attr) {\n\t\tbt_att_send(server->att, BT_ATT_OP_READ_BY_TYPE_RSP, op->pdu,\n\t\t\t\t\t\t\t\top->pdu_len,\n\t\t\t\t\t\t\t\tNULL, NULL,\n\t\t\t\t\t\t\t\tNULL);\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (gatt_db_attribute_read(attr, 0, op->opcode, server->att,\n\t\t\t\t\tread_by_type_read_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\tgatt_db_attribute_get_handle(attr), ecode);\n\tasync_read_op_destroy(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_read_by_type(struct async_read_op *op);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void process_read_by_type(struct async_read_op *op)\n{\n\tstruct bt_gatt_server *server = op->server;\n\tuint8_t ecode;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_pop_head(op->db_data);\n\n\tif (op->done || !attr) {\n\t\tbt_att_send(server->att, BT_ATT_OP_READ_BY_TYPE_RSP, op->pdu,\n\t\t\t\t\t\t\t\top->pdu_len,\n\t\t\t\t\t\t\t\tNULL, NULL,\n\t\t\t\t\t\t\t\tNULL);\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (gatt_db_attribute_read(attr, 0, op->opcode, server->att,\n\t\t\t\t\tread_by_type_read_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\tgatt_db_attribute_get_handle(attr), ecode);\n\tasync_read_op_destroy(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 530
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "bt_att_get_mtu(server->att)"
          ],
          "line": 528
        },
        "resolved": true,
        "details": {
          "function_name": "btd_malloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "41-55",
          "snippet": "void *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid *btd_malloc(size_t size)\n{\n\tif (__builtin_expect(!!size, 1)) {\n\t\tvoid *ptr;\n\n\t\tptr = malloc(size);\n\t\tif (ptr)\n\t\t\treturn ptr;\n\n\t\tfprintf(stderr, \"failed to allocate %zu bytes\\n\", size);\n\t\tabort();\n\t}\n\n\treturn NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "server->att"
          ],
          "line": 528
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      },
      {
        "call_info": {
          "callee": "new0",
          "args": [
            "structasync_read_op",
            "1"
          ],
          "line": 527
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "queue_isempty",
          "args": [
            "q"
          ],
          "line": 517
        },
        "resolved": true,
        "details": {
          "function_name": "queue_isempty",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "380-386",
          "snippet": "bool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_read_by_type",
          "args": [
            "server->db",
            "start",
            "end",
            "type",
            "q"
          ],
          "line": 515
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_read_by_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1194-1206",
          "snippet": "void gatt_db_read_by_type(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\tuint16_t end_handle,\n\t\t\t\t\t\tconst bt_uuid_t type,\n\t\t\t\t\t\tstruct queue *queue)\n{\n\tstruct read_by_type_data data;\n\tdata.uuid = type;\n\tdata.start_handle = start_handle;\n\tdata.end_handle = end_handle;\n\tdata.queue = queue;\n\n\tqueue_foreach(db->services, read_by_type, &data);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nvoid gatt_db_read_by_type(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\tuint16_t end_handle,\n\t\t\t\t\t\tconst bt_uuid_t type,\n\t\t\t\t\t\tstruct queue *queue)\n{\n\tstruct read_by_type_data data;\n\tdata.uuid = type;\n\tdata.start_handle = start_handle;\n\tdata.end_handle = end_handle;\n\tdata.queue = queue;\n\n\tqueue_foreach(db->services, read_by_type, &data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "server->debug_callback",
            "server->debug_data",
            "\"Read By Type - start: 0x%04x end: 0x%04x\"",
            "start",
            "end"
          ],
          "line": 499
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_uuid_le",
          "args": [
            "pdu + 4",
            "length - 4",
            "&type"
          ],
          "line": 497
        },
        "resolved": true,
        "details": {
          "function_name": "get_uuid_le",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "150-167",
          "snippet": "static bool get_uuid_le(const uint8_t *uuid, size_t len, bt_uuid_t *out_uuid)\n{\n\tuint128_t u128;\n\n\tswitch (len) {\n\tcase 2:\n\t\tbt_uuid16_create(out_uuid, get_le16(uuid));\n\t\treturn true;\n\tcase 16:\n\t\tbswap_128(uuid, &u128.data);\n\t\tbt_uuid128_create(out_uuid, u128);\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool get_uuid_le(const uint8_t *uuid, size_t len, bt_uuid_t *out_uuid)\n{\n\tuint128_t u128;\n\n\tswitch (len) {\n\tcase 2:\n\t\tbt_uuid16_create(out_uuid, get_le16(uuid));\n\t\treturn true;\n\tcase 16:\n\t\tbswap_128(uuid, &u128.data);\n\t\tbt_uuid128_create(out_uuid, u128);\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + 2"
          ],
          "line": 496
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_new",
          "args": [],
          "line": 493
        },
        "resolved": true,
        "details": {
          "function_name": "queue_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "56-66",
          "snippet": "struct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nstruct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void read_by_type_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t start, end;\n\tbt_uuid_t type;\n\tuint16_t ehandle = 0;\n\tuint8_t ecode;\n\tstruct queue *q = NULL;\n\tstruct async_read_op *op;\n\n\tif (length != 6 && length != 20) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tq = queue_new();\n\n\tstart = get_le16(pdu);\n\tend = get_le16(pdu + 2);\n\tget_uuid_le(pdu + 4, length - 4, &type);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\"Read By Type - start: 0x%04x end: 0x%04x\",\n\t\t\t\tstart, end);\n\n\tif (!start || !end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tehandle = start;\n\n\tif (start > end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tgatt_db_read_by_type(server->db, start, end, type, q);\n\n\tif (queue_isempty(q)) {\n\t\tecode = BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND;\n\t\tgoto error;\n\t}\n\n\tif (server->pending_read_op) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\top = new0(struct async_read_op, 1);\n\top->pdu = malloc(bt_att_get_mtu(server->att));\n\tif (!op->pdu) {\n\t\tfree(op);\n\t\tecode = BT_ATT_ERROR_INSUFFICIENT_RESOURCES;\n\t\tgoto error;\n\t}\n\n\top->opcode = opcode;\n\top->server = server;\n\top->db_data = q;\n\tserver->pending_read_op = op;\n\n\tprocess_read_by_type(op);\n\n\treturn;\n\nerror:\n\tbt_att_send_error_rsp(server->att, opcode, ehandle, ecode);\n\tqueue_destroy(q, NULL);\n}"
  },
  {
    "function_name": "process_read_by_type",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "442-475",
    "snippet": "static void process_read_by_type(struct async_read_op *op)\n{\n\tstruct bt_gatt_server *server = op->server;\n\tuint8_t ecode;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_pop_head(op->db_data);\n\n\tif (op->done || !attr) {\n\t\tbt_att_send(server->att, BT_ATT_OP_READ_BY_TYPE_RSP, op->pdu,\n\t\t\t\t\t\t\t\top->pdu_len,\n\t\t\t\t\t\t\t\tNULL, NULL,\n\t\t\t\t\t\t\t\tNULL);\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (gatt_db_attribute_read(attr, 0, op->opcode, server->att,\n\t\t\t\t\tread_by_type_read_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\tgatt_db_attribute_get_handle(attr), ecode);\n\tasync_read_op_destroy(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_read_by_type(struct async_read_op *op);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "async_read_op_destroy",
          "args": [
            "op"
          ],
          "line": 474
        },
        "resolved": true,
        "details": {
          "function_name": "async_read_op_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "319-327",
          "snippet": "static void async_read_op_destroy(struct async_read_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_read_op = NULL;\n\n\tqueue_destroy(op->db_data, NULL);\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_read_by_type(struct async_read_op *op);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void async_read_op_destroy(struct async_read_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_read_op = NULL;\n\n\tqueue_destroy(op->db_data, NULL);\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "BT_ATT_OP_READ_BY_TYPE_REQ",
            "gatt_db_attribute_get_handle(attr)",
            "ecode"
          ],
          "line": 472
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 473
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_read",
          "args": [
            "attr",
            "0",
            "op->opcode",
            "server->att",
            "read_by_type_read_complete_cb",
            "op"
          ],
          "line": 465
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_read",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1724-1763",
          "snippet": "bool gatt_db_attribute_read(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\tgatt_db_attribute_read_t func, void *user_data)\n{\n\tuint8_t *value;\n\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->read_func) {\n\t\tstruct pending_read *p;\n\n\t\tp = new0(struct pending_read, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->read_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, read_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_reads, p);\n\n\t\tattrib->read_func(attrib, p->id, offset, opcode, att,\n\t\t\t\t\t\t\tattrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Check boundary if value is stored in the db */\n\tif (offset > attrib->value_len) {\n\t\tfunc(attrib, BT_ATT_ERROR_INVALID_OFFSET, NULL, 0, user_data);\n\t\treturn true;\n\t}\n\n\t/* Guard against invalid access if offset equals to value length */\n\tvalue = offset == attrib->value_len ? NULL : &attrib->value[offset];\n\n\tfunc(attrib, 0, value, attrib->value_len - offset, user_data);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATTRIBUTE_TIMEOUT 5000"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\n#define ATTRIBUTE_TIMEOUT 5000\n\nbool gatt_db_attribute_read(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\tgatt_db_attribute_read_t func, void *user_data)\n{\n\tuint8_t *value;\n\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->read_func) {\n\t\tstruct pending_read *p;\n\n\t\tp = new0(struct pending_read, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->read_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, read_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_reads, p);\n\n\t\tattrib->read_func(attrib, p->id, offset, opcode, att,\n\t\t\t\t\t\t\tattrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Check boundary if value is stored in the db */\n\tif (offset > attrib->value_len) {\n\t\tfunc(attrib, BT_ATT_ERROR_INVALID_OFFSET, NULL, 0, user_data);\n\t\treturn true;\n\t}\n\n\t/* Guard against invalid access if offset equals to value length */\n\tvalue = offset == attrib->value_len ? NULL : &attrib->value[offset];\n\n\tfunc(attrib, 0, value, attrib->value_len - offset, user_data);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "check_permissions",
          "args": [
            "server",
            "attr",
            "BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT"
          ],
          "line": 459
        },
        "resolved": true,
        "details": {
          "function_name": "check_permissions",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "392-440",
          "snippet": "static uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "BT_ATT_OP_READ_BY_TYPE_RSP",
            "op->pdu",
            "op->pdu_len",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 451
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "op->db_data"
          ],
          "line": 448
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void process_read_by_type(struct async_read_op *op)\n{\n\tstruct bt_gatt_server *server = op->server;\n\tuint8_t ecode;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_pop_head(op->db_data);\n\n\tif (op->done || !attr) {\n\t\tbt_att_send(server->att, BT_ATT_OP_READ_BY_TYPE_RSP, op->pdu,\n\t\t\t\t\t\t\t\top->pdu_len,\n\t\t\t\t\t\t\t\tNULL, NULL,\n\t\t\t\t\t\t\t\tNULL);\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (gatt_db_attribute_read(attr, 0, op->opcode, server->att,\n\t\t\t\t\tread_by_type_read_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\tgatt_db_attribute_get_handle(attr), ecode);\n\tasync_read_op_destroy(op);\n}"
  },
  {
    "function_name": "check_permissions",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "392-440",
    "snippet": "static uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "check_min_key_size",
          "args": [
            "server->min_enc_size",
            "enc_size"
          ],
          "line": 435
        },
        "resolved": true,
        "details": {
          "function_name": "check_min_key_size",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "384-390",
          "snippet": "static bool check_min_key_size(uint8_t min_size, uint8_t size)\n{\n\tif (!min_size || !size)\n\t\treturn true;\n\n\treturn min_size <= size;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool check_min_key_size(uint8_t min_size, uint8_t size)\n{\n\tif (!min_size || !size)\n\t\treturn true;\n\n\treturn min_size <= size;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_security",
          "args": [
            "server->att",
            "&enc_size"
          ],
          "line": 411
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_security",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1458-1482",
          "snippet": "int bt_att_get_security(struct bt_att *att, uint8_t *enc_size)\n{\n\tstruct bt_security sec;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap) {\n\t\tif (enc_size)\n\t\t\t*enc_size = att->enc_size;\n\n\t\treturn att->io_sec_level;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tlen = sizeof(sec);\n\tif (getsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec, &len) < 0)\n\t\treturn -EIO;\n\n\tif (enc_size)\n\t\t*enc_size = att->enc_size;\n\n\treturn sec.level;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nint bt_att_get_security(struct bt_att *att, uint8_t *enc_size)\n{\n\tstruct bt_security sec;\n\tsocklen_t len;\n\n\tif (!att)\n\t\treturn -EINVAL;\n\n\tif (!att->io_on_l2cap) {\n\t\tif (enc_size)\n\t\t\t*enc_size = att->enc_size;\n\n\t\treturn att->io_sec_level;\n\t}\n\n\tmemset(&sec, 0, sizeof(sec));\n\tlen = sizeof(sec);\n\tif (getsockopt(att->fd, SOL_BLUETOOTH, BT_SECURITY, &sec, &len) < 0)\n\t\treturn -EIO;\n\n\tif (enc_size)\n\t\t*enc_size = att->enc_size;\n\n\treturn sec.level;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_permissions",
          "args": [
            "attr"
          ],
          "line": 399
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_permissions",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1702-1709",
          "snippet": "uint32_t\ngatt_db_attribute_get_permissions(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->permissions;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint32_t\ngatt_db_attribute_get_permissions(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->permissions;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic uint8_t check_permissions(struct bt_gatt_server *server,\n\t\t\t\tstruct gatt_db_attribute *attr, uint32_t mask)\n{\n\tuint8_t enc_size;\n\tuint32_t perm;\n\tint security;\n\n\tperm = gatt_db_attribute_get_permissions(attr);\n\n\tif (perm && mask & BT_ATT_PERM_READ && !(perm & BT_ATT_PERM_READ))\n\t\treturn BT_ATT_ERROR_READ_NOT_PERMITTED;\n\n\tif (perm && mask & BT_ATT_PERM_WRITE && !(perm & BT_ATT_PERM_WRITE))\n\t\treturn BT_ATT_ERROR_WRITE_NOT_PERMITTED;\n\n\tperm &= mask;\n\tif (!perm)\n\t\treturn 0;\n\n\tsecurity = bt_att_get_security(server->att, &enc_size);\n\tif (security < 0)\n\t\treturn BT_ATT_ERROR_UNLIKELY;\n\n\tif (perm & BT_ATT_PERM_SECURE) {\n\t\tif (security < BT_ATT_SECURITY_FIPS)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_AUTHEN) {\n\t\tif (security < BT_ATT_SECURITY_HIGH)\n\t\t\treturn BT_ATT_ERROR_AUTHENTICATION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\tif (perm & BT_ATT_PERM_ENCRYPT) {\n\t\tif (security < BT_ATT_SECURITY_MEDIUM)\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION;\n\n\t\tif (!check_min_key_size(server->min_enc_size, enc_size))\n\t\t\treturn BT_ATT_ERROR_INSUFFICIENT_ENCRYPTION_KEY_SIZE;\n\t}\n\n\treturn 0;\n}"
  },
  {
    "function_name": "check_min_key_size",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "384-390",
    "snippet": "static bool check_min_key_size(uint8_t min_size, uint8_t size)\n{\n\tif (!min_size || !size)\n\t\treturn true;\n\n\treturn min_size <= size;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool check_min_key_size(uint8_t min_size, uint8_t size)\n{\n\tif (!min_size || !size)\n\t\treturn true;\n\n\treturn min_size <= size;\n}"
  },
  {
    "function_name": "read_by_type_read_complete_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "331-382",
    "snippet": "static void read_by_type_read_complete_cb(struct gatt_db_attribute *attr,\n\t\t\t\t\t\tint err, const uint8_t *value,\n\t\t\t\t\t\tsize_t len, void *user_data)\n{\n\tstruct async_read_op *op = user_data;\n\tstruct bt_gatt_server *server = op->server;\n\tuint16_t mtu;\n\tuint16_t handle;\n\n\tif (!server) {\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tmtu = bt_att_get_mtu(server->att);\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\t/* Terminate the operation if there was an error */\n\tif (err) {\n\t\tbt_att_send_error_rsp(server->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\t\t\thandle, err);\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tif (op->pdu_len == 0) {\n\t\top->value_len = MIN(MIN((unsigned) mtu - 4, 253), len);\n\t\top->pdu[0] = op->value_len + 2;\n\t\top->pdu_len++;\n\t} else if (len != op->value_len) {\n\t\top->done = true;\n\t\tgoto done;\n\t}\n\n\t/* Stop if this would surpass the MTU */\n\tif (op->pdu_len + op->value_len + 2 > (unsigned) mtu - 1) {\n\t\top->done = true;\n\t\tgoto done;\n\t}\n\n\t/* Encode the current value */\n\tput_le16(handle, op->pdu + op->pdu_len);\n\tmemcpy(op->pdu + op->pdu_len + 2, value, op->value_len);\n\n\top->pdu_len += op->value_len + 2;\n\n\tif (op->pdu_len == (unsigned) mtu - 1)\n\t\top->done = true;\n\ndone:\n\tprocess_read_by_type(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_read_by_type(struct async_read_op *op);",
      "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "process_read_by_type",
          "args": [
            "op"
          ],
          "line": 381
        },
        "resolved": true,
        "details": {
          "function_name": "process_read_by_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "442-475",
          "snippet": "static void process_read_by_type(struct async_read_op *op)\n{\n\tstruct bt_gatt_server *server = op->server;\n\tuint8_t ecode;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_pop_head(op->db_data);\n\n\tif (op->done || !attr) {\n\t\tbt_att_send(server->att, BT_ATT_OP_READ_BY_TYPE_RSP, op->pdu,\n\t\t\t\t\t\t\t\top->pdu_len,\n\t\t\t\t\t\t\t\tNULL, NULL,\n\t\t\t\t\t\t\t\tNULL);\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (gatt_db_attribute_read(attr, 0, op->opcode, server->att,\n\t\t\t\t\tread_by_type_read_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\tgatt_db_attribute_get_handle(attr), ecode);\n\tasync_read_op_destroy(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_read_by_type(struct async_read_op *op);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void process_read_by_type(struct async_read_op *op)\n{\n\tstruct bt_gatt_server *server = op->server;\n\tuint8_t ecode;\n\tstruct gatt_db_attribute *attr;\n\n\tattr = queue_pop_head(op->db_data);\n\n\tif (op->done || !attr) {\n\t\tbt_att_send(server->att, BT_ATT_OP_READ_BY_TYPE_RSP, op->pdu,\n\t\t\t\t\t\t\t\top->pdu_len,\n\t\t\t\t\t\t\t\tNULL, NULL,\n\t\t\t\t\t\t\t\tNULL);\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tecode = check_permissions(server, attr, BT_ATT_PERM_READ |\n\t\t\t\t\t\tBT_ATT_PERM_READ_AUTHEN |\n\t\t\t\t\t\tBT_ATT_PERM_READ_ENCRYPT);\n\tif (ecode)\n\t\tgoto error;\n\n\tif (gatt_db_attribute_read(attr, 0, op->opcode, server->att,\n\t\t\t\t\tread_by_type_read_complete_cb, op))\n\t\treturn;\n\n\tecode = BT_ATT_ERROR_UNLIKELY;\n\nerror:\n\tbt_att_send_error_rsp(server->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\tgatt_db_attribute_get_handle(attr), ecode);\n\tasync_read_op_destroy(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "op->pdu + op->pdu_len + 2",
            "value",
            "op->value_len"
          ],
          "line": 373
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "handle",
            "op->pdu + op->pdu_len"
          ],
          "line": 372
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "MIN((unsigned) mtu - 4, 253)",
            "len"
          ],
          "line": 357
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "(unsigned) mtu - 4",
            "253"
          ],
          "line": 357
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "async_read_op_destroy",
          "args": [
            "op"
          ],
          "line": 352
        },
        "resolved": true,
        "details": {
          "function_name": "async_read_op_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "319-327",
          "snippet": "static void async_read_op_destroy(struct async_read_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_read_op = NULL;\n\n\tqueue_destroy(op->db_data, NULL);\n\tfree(op->pdu);\n\tfree(op);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void process_read_by_type(struct async_read_op *op);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void async_read_op_destroy(struct async_read_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_read_op = NULL;\n\n\tqueue_destroy(op->db_data, NULL);\n\tfree(op->pdu);\n\tfree(op);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "BT_ATT_OP_READ_BY_TYPE_REQ",
            "handle",
            "err"
          ],
          "line": 350
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_handle",
          "args": [
            "attr"
          ],
          "line": 346
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_handle",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1482-1488",
          "snippet": "uint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nuint16_t gatt_db_attribute_get_handle(const struct gatt_db_attribute *attrib)\n{\n\tif (!attrib)\n\t\treturn 0;\n\n\treturn attrib->handle;\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "server->att"
          ],
          "line": 345
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);\n\nstatic void read_by_type_read_complete_cb(struct gatt_db_attribute *attr,\n\t\t\t\t\t\tint err, const uint8_t *value,\n\t\t\t\t\t\tsize_t len, void *user_data)\n{\n\tstruct async_read_op *op = user_data;\n\tstruct bt_gatt_server *server = op->server;\n\tuint16_t mtu;\n\tuint16_t handle;\n\n\tif (!server) {\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tmtu = bt_att_get_mtu(server->att);\n\thandle = gatt_db_attribute_get_handle(attr);\n\n\t/* Terminate the operation if there was an error */\n\tif (err) {\n\t\tbt_att_send_error_rsp(server->att, BT_ATT_OP_READ_BY_TYPE_REQ,\n\t\t\t\t\t\t\t\thandle, err);\n\t\tasync_read_op_destroy(op);\n\t\treturn;\n\t}\n\n\tif (op->pdu_len == 0) {\n\t\top->value_len = MIN(MIN((unsigned) mtu - 4, 253), len);\n\t\top->pdu[0] = op->value_len + 2;\n\t\top->pdu_len++;\n\t} else if (len != op->value_len) {\n\t\top->done = true;\n\t\tgoto done;\n\t}\n\n\t/* Stop if this would surpass the MTU */\n\tif (op->pdu_len + op->value_len + 2 > (unsigned) mtu - 1) {\n\t\top->done = true;\n\t\tgoto done;\n\t}\n\n\t/* Encode the current value */\n\tput_le16(handle, op->pdu + op->pdu_len);\n\tmemcpy(op->pdu + op->pdu_len + 2, value, op->value_len);\n\n\top->pdu_len += op->value_len + 2;\n\n\tif (op->pdu_len == (unsigned) mtu - 1)\n\t\top->done = true;\n\ndone:\n\tprocess_read_by_type(op);\n}"
  },
  {
    "function_name": "async_read_op_destroy",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "319-327",
    "snippet": "static void async_read_op_destroy(struct async_read_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_read_op = NULL;\n\n\tqueue_destroy(op->db_data, NULL);\n\tfree(op->pdu);\n\tfree(op);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void process_read_by_type(struct async_read_op *op);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "op"
          ],
          "line": 326
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "op->db_data",
            "NULL"
          ],
          "line": 324
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void process_read_by_type(struct async_read_op *op);\n\nstatic void async_read_op_destroy(struct async_read_op *op)\n{\n\tif (op->server)\n\t\top->server->pending_read_op = NULL;\n\n\tqueue_destroy(op->db_data, NULL);\n\tfree(op->pdu);\n\tfree(op);\n}"
  },
  {
    "function_name": "read_by_grp_type_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "239-317",
    "snippet": "static void read_by_grp_type_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t start, end;\n\tbt_uuid_t type;\n\tbt_uuid_t prim, snd;\n\tuint16_t mtu = bt_att_get_mtu(server->att);\n\tuint8_t rsp_pdu[mtu];\n\tuint16_t rsp_len;\n\tuint8_t ecode = 0;\n\tuint16_t ehandle = 0;\n\tstruct queue *q = NULL;\n\n\tif (length != 6 && length != 20) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tq = queue_new();\n\n\tstart = get_le16(pdu);\n\tend = get_le16(pdu + 2);\n\tget_uuid_le(pdu + 4, length - 4, &type);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\"Read By Grp Type - start: 0x%04x end: 0x%04x\",\n\t\t\t\tstart, end);\n\n\tif (!start || !end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tehandle = start;\n\n\tif (start > end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\t/*\n\t * GATT defines that only the <<Primary Service>> and\n\t * <<Secondary Service>> group types can be used for the\n\t * \"Read By Group Type\" request (Core v4.1, Vol 3, sec 2.5.3). Return an\n\t * error if any other group type is given.\n\t */\n\tbt_uuid16_create(&prim, GATT_PRIM_SVC_UUID);\n\tbt_uuid16_create(&snd, GATT_SND_SVC_UUID);\n\tif (bt_uuid_cmp(&type, &prim) && bt_uuid_cmp(&type, &snd)) {\n\t\tecode = BT_ATT_ERROR_UNSUPPORTED_GROUP_TYPE;\n\t\tgoto error;\n\t}\n\n\tgatt_db_read_by_group_type(server->db, start, end, type, q);\n\n\tif (queue_isempty(q)) {\n\t\tecode = BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND;\n\t\tgoto error;\n\t}\n\n\tif (!encode_read_by_grp_type_rsp(server->db, q, server->att, mtu,\n\t\t\t\t\t\t\trsp_pdu, &rsp_len)) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\tqueue_destroy(q, NULL);\n\n\tbt_att_send(server->att, BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\n\t\t\t\t\t\t\trsp_pdu, rsp_len,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\treturn;\n\nerror:\n\tqueue_destroy(q, NULL);\n\tbt_att_send_error_rsp(server->att, opcode, ehandle, ecode);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_att_send_error_rsp",
          "args": [
            "server->att",
            "opcode",
            "ehandle",
            "ecode"
          ],
          "line": 316
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send_error_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1381-1400",
          "snippet": "unsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send_error_rsp(struct bt_att *att, uint8_t opcode,\n\t\t\t\t\t\tuint16_t handle, int error)\n{\n\tstruct bt_att_pdu_error_rsp pdu;\n\tuint8_t ecode;\n\n\tif (!att || !opcode)\n\t\treturn 0;\n\n\tecode = att_ecode_from_error(error);\n\n\tmemset(&pdu, 0, sizeof(pdu));\n\n\tpdu.opcode = opcode;\n\tput_le16(handle, &pdu.handle);\n\tpdu.ecode = ecode;\n\n\treturn bt_att_send(att, BT_ATT_OP_ERROR_RSP, &pdu, sizeof(pdu),\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "q",
            "NULL"
          ],
          "line": 315
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_send",
          "args": [
            "server->att",
            "BT_ATT_OP_READ_BY_GRP_TYPE_RSP",
            "rsp_pdu",
            "rsp_len",
            "NULL",
            "NULL",
            "NULL"
          ],
          "line": 308
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_send",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1233-1281",
          "snippet": "unsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nunsigned int bt_att_send(struct bt_att *att, uint8_t opcode,\n\t\t\t\tconst void *pdu, uint16_t length,\n\t\t\t\tbt_att_response_func_t callback, void *user_data,\n\t\t\t\tbt_att_destroy_func_t destroy)\n{\n\tstruct att_send_op *op;\n\tbool result;\n\n\tif (!att || !att->io)\n\t\treturn 0;\n\n\top = create_att_send_op(att, opcode, pdu, length, callback, user_data,\n\t\t\t\t\t\t\t\tdestroy);\n\tif (!op)\n\t\treturn 0;\n\n\tif (att->next_send_id < 1)\n\t\tatt->next_send_id = 1;\n\n\top->id = att->next_send_id++;\n\n\t/* Add the op to the correct queue based on its type */\n\tswitch (op->type) {\n\tcase ATT_OP_TYPE_REQ:\n\t\tresult = queue_push_tail(att->req_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_IND:\n\t\tresult = queue_push_tail(att->ind_queue, op);\n\t\tbreak;\n\tcase ATT_OP_TYPE_CMD:\n\tcase ATT_OP_TYPE_NOT:\n\tcase ATT_OP_TYPE_UNKNOWN:\n\tcase ATT_OP_TYPE_RSP:\n\tcase ATT_OP_TYPE_CONF:\n\tdefault:\n\t\tresult = queue_push_tail(att->write_queue, op);\n\t\tbreak;\n\t}\n\n\tif (!result) {\n\t\tfree(op->pdu);\n\t\tfree(op);\n\t\treturn 0;\n\t}\n\n\twakeup_writer(att);\n\n\treturn op->id;\n}"
        }
      },
      {
        "call_info": {
          "callee": "encode_read_by_grp_type_rsp",
          "args": [
            "server->db",
            "q",
            "server->att",
            "mtu",
            "rsp_pdu",
            "&rsp_len"
          ],
          "line": 300
        },
        "resolved": true,
        "details": {
          "function_name": "encode_read_by_grp_type_rsp",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "179-237",
          "snippet": "static bool encode_read_by_grp_type_rsp(struct gatt_db *db, struct queue *q,\n\t\t\t\t\t\tstruct bt_att *att,\n\t\t\t\t\t\tuint16_t mtu, uint8_t *pdu,\n\t\t\t\t\t\tuint16_t *len)\n{\n\tint iter = 0;\n\tuint16_t start_handle, end_handle;\n\tstruct iovec value;\n\tuint8_t data_val_len;\n\n\t*len = 0;\n\n\twhile (queue_peek_head(q)) {\n\t\tstruct gatt_db_attribute *attrib = queue_pop_head(q);\n\n\t\tvalue.iov_base = NULL;\n\t\tvalue.iov_len = 0;\n\n\t\t/*\n\t\t * This should never be deferred to the read callback for\n\t\t * primary/secondary service declarations.\n\t\t */\n\t\tif (!gatt_db_attribute_read(attrib, 0,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tatt, attribute_read_cb,\n\t\t\t\t\t\t&value) || !value.iov_len)\n\t\t\treturn false;\n\n\t\t/*\n\t\t * Use the first attribute to determine the length of each\n\t\t * attribute data unit. Stop the list when a different attribute\n\t\t * value is seen.\n\t\t */\n\t\tif (iter == 0) {\n\t\t\tdata_val_len = MIN(MIN((unsigned)mtu - 6, 251),\n\t\t\t\t\t\t\t\tvalue.iov_len);\n\t\t\tpdu[0] = data_val_len + 4;\n\t\t\titer++;\n\t\t} else if (value.iov_len != data_val_len)\n\t\t\tbreak;\n\n\t\t/* Stop if this unit would surpass the MTU */\n\t\tif (iter + data_val_len + 4 > mtu - 1)\n\t\t\tbreak;\n\n\t\tgatt_db_attribute_get_service_handles(attrib, &start_handle,\n\t\t\t\t\t\t\t\t&end_handle);\n\n\t\tput_le16(start_handle, pdu + iter);\n\t\tput_le16(end_handle, pdu + iter + 2);\n\t\tmemcpy(pdu + iter + 4, value.iov_base, data_val_len);\n\n\t\titer += data_val_len + 4;\n\t}\n\n\t*len = iter;\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool encode_read_by_grp_type_rsp(struct gatt_db *db, struct queue *q,\n\t\t\t\t\t\tstruct bt_att *att,\n\t\t\t\t\t\tuint16_t mtu, uint8_t *pdu,\n\t\t\t\t\t\tuint16_t *len)\n{\n\tint iter = 0;\n\tuint16_t start_handle, end_handle;\n\tstruct iovec value;\n\tuint8_t data_val_len;\n\n\t*len = 0;\n\n\twhile (queue_peek_head(q)) {\n\t\tstruct gatt_db_attribute *attrib = queue_pop_head(q);\n\n\t\tvalue.iov_base = NULL;\n\t\tvalue.iov_len = 0;\n\n\t\t/*\n\t\t * This should never be deferred to the read callback for\n\t\t * primary/secondary service declarations.\n\t\t */\n\t\tif (!gatt_db_attribute_read(attrib, 0,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tatt, attribute_read_cb,\n\t\t\t\t\t\t&value) || !value.iov_len)\n\t\t\treturn false;\n\n\t\t/*\n\t\t * Use the first attribute to determine the length of each\n\t\t * attribute data unit. Stop the list when a different attribute\n\t\t * value is seen.\n\t\t */\n\t\tif (iter == 0) {\n\t\t\tdata_val_len = MIN(MIN((unsigned)mtu - 6, 251),\n\t\t\t\t\t\t\t\tvalue.iov_len);\n\t\t\tpdu[0] = data_val_len + 4;\n\t\t\titer++;\n\t\t} else if (value.iov_len != data_val_len)\n\t\t\tbreak;\n\n\t\t/* Stop if this unit would surpass the MTU */\n\t\tif (iter + data_val_len + 4 > mtu - 1)\n\t\t\tbreak;\n\n\t\tgatt_db_attribute_get_service_handles(attrib, &start_handle,\n\t\t\t\t\t\t\t\t&end_handle);\n\n\t\tput_le16(start_handle, pdu + iter);\n\t\tput_le16(end_handle, pdu + iter + 2);\n\t\tmemcpy(pdu + iter + 4, value.iov_base, data_val_len);\n\n\t\titer += data_val_len + 4;\n\t}\n\n\t*len = iter;\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_isempty",
          "args": [
            "q"
          ],
          "line": 295
        },
        "resolved": true,
        "details": {
          "function_name": "queue_isempty",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "380-386",
          "snippet": "bool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nbool queue_isempty(struct queue *queue)\n{\n\tif (!queue)\n\t\treturn true;\n\n\treturn queue->entries == 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_read_by_group_type",
          "args": [
            "server->db",
            "start",
            "end",
            "type",
            "q"
          ],
          "line": 293
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_read_by_group_type",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1021-1062",
          "snippet": "void gatt_db_read_by_group_type(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle,\n\t\t\t\t\t\t\tconst bt_uuid_t type,\n\t\t\t\t\t\t\tstruct queue *queue)\n{\n\tconst struct queue_entry *services_entry;\n\tstruct gatt_db_service *service;\n\tuint16_t grp_start, grp_end, uuid_size;\n\n\tuuid_size = 0;\n\n\tservices_entry = queue_get_entries(db->services);\n\n\twhile (services_entry) {\n\t\tservice = services_entry->data;\n\n\t\tif (!service->active)\n\t\t\tgoto next_service;\n\n\t\tif (bt_uuid_cmp(&type, &service->attributes[0]->uuid))\n\t\t\tgoto next_service;\n\n\t\tgrp_start = service->attributes[0]->handle;\n\t\tgrp_end = grp_start + service->num_handles - 1;\n\n\t\tif (grp_end < start_handle || grp_start > end_handle)\n\t\t\tgoto next_service;\n\n\t\tif (grp_start < start_handle || grp_start > end_handle)\n\t\t\tgoto next_service;\n\n\t\tif (!uuid_size)\n\t\t\tuuid_size = service->attributes[0]->value_len;\n\t\telse if (uuid_size != service->attributes[0]->value_len)\n\t\t\treturn;\n\n\t\tqueue_push_tail(queue, service->attributes[0]);\n\nnext_service:\n\t\tservices_entry = services_entry->next;\n\t}\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nvoid gatt_db_read_by_group_type(struct gatt_db *db, uint16_t start_handle,\n\t\t\t\t\t\t\tuint16_t end_handle,\n\t\t\t\t\t\t\tconst bt_uuid_t type,\n\t\t\t\t\t\t\tstruct queue *queue)\n{\n\tconst struct queue_entry *services_entry;\n\tstruct gatt_db_service *service;\n\tuint16_t grp_start, grp_end, uuid_size;\n\n\tuuid_size = 0;\n\n\tservices_entry = queue_get_entries(db->services);\n\n\twhile (services_entry) {\n\t\tservice = services_entry->data;\n\n\t\tif (!service->active)\n\t\t\tgoto next_service;\n\n\t\tif (bt_uuid_cmp(&type, &service->attributes[0]->uuid))\n\t\t\tgoto next_service;\n\n\t\tgrp_start = service->attributes[0]->handle;\n\t\tgrp_end = grp_start + service->num_handles - 1;\n\n\t\tif (grp_end < start_handle || grp_start > end_handle)\n\t\t\tgoto next_service;\n\n\t\tif (grp_start < start_handle || grp_start > end_handle)\n\t\t\tgoto next_service;\n\n\t\tif (!uuid_size)\n\t\t\tuuid_size = service->attributes[0]->value_len;\n\t\telse if (uuid_size != service->attributes[0]->value_len)\n\t\t\treturn;\n\n\t\tqueue_push_tail(queue, service->attributes[0]);\n\nnext_service:\n\t\tservices_entry = services_entry->next;\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_uuid_cmp",
          "args": [
            "&type",
            "&snd"
          ],
          "line": 288
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid_cmp",
          "args": [
            "&type",
            "&prim"
          ],
          "line": 288
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid16_create",
          "args": [
            "&snd",
            "GATT_SND_SVC_UUID"
          ],
          "line": 287
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid16_create",
          "args": [
            "&prim",
            "GATT_PRIM_SVC_UUID"
          ],
          "line": 286
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "util_debug",
          "args": [
            "server->debug_callback",
            "server->debug_data",
            "\"Read By Grp Type - start: 0x%04x end: 0x%04x\"",
            "start",
            "end"
          ],
          "line": 264
        },
        "resolved": true,
        "details": {
          "function_name": "util_debug",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.c",
          "lines": "57-71",
          "snippet": "void util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include <string.h>",
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <stdbool.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include <stdio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include <string.h>\n#include <limits.h>\n#include <dirent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <stdbool.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include <stdio.h>\n#include <config.h>\n\nvoid util_debug(util_debug_func_t function, void *user_data,\n\t\t\t\t\t\tconst char *format, ...)\n{\n\tchar str[78];\n\tva_list ap;\n\n\tif (!function || !format)\n\t\treturn;\n\n\tva_start(ap, format);\n\tvsnprintf(str, sizeof(str), format, ap);\n\tva_end(ap);\n\n\tfunction(str, user_data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_uuid_le",
          "args": [
            "pdu + 4",
            "length - 4",
            "&type"
          ],
          "line": 262
        },
        "resolved": true,
        "details": {
          "function_name": "get_uuid_le",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "150-167",
          "snippet": "static bool get_uuid_le(const uint8_t *uuid, size_t len, bt_uuid_t *out_uuid)\n{\n\tuint128_t u128;\n\n\tswitch (len) {\n\tcase 2:\n\t\tbt_uuid16_create(out_uuid, get_le16(uuid));\n\t\treturn true;\n\tcase 16:\n\t\tbswap_128(uuid, &u128.data);\n\t\tbt_uuid128_create(out_uuid, u128);\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n\n\treturn false;\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool get_uuid_le(const uint8_t *uuid, size_t len, bt_uuid_t *out_uuid)\n{\n\tuint128_t u128;\n\n\tswitch (len) {\n\tcase 2:\n\t\tbt_uuid16_create(out_uuid, get_le16(uuid));\n\t\treturn true;\n\tcase 16:\n\t\tbswap_128(uuid, &u128.data);\n\t\tbt_uuid128_create(out_uuid, u128);\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n\n\treturn false;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "pdu + 2"
          ],
          "line": 261
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_new",
          "args": [],
          "line": 258
        },
        "resolved": true,
        "details": {
          "function_name": "queue_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "56-66",
          "snippet": "struct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nstruct queue *queue_new(void)\n{\n\tstruct queue *queue;\n\n\tqueue = new0(struct queue, 1);\n\tqueue->head = NULL;\n\tqueue->tail = NULL;\n\tqueue->entries = 0;\n\n\treturn queue_ref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_get_mtu",
          "args": [
            "server->att"
          ],
          "line": 246
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_get_mtu",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1109-1115",
          "snippet": "uint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nuint16_t bt_att_get_mtu(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn 0;\n\n\treturn att->mtu;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_by_grp_type_cb(uint8_t opcode, const void *pdu,\n\t\t\t\t\tuint16_t length, void *user_data)\n{\n\tstruct bt_gatt_server *server = user_data;\n\tuint16_t start, end;\n\tbt_uuid_t type;\n\tbt_uuid_t prim, snd;\n\tuint16_t mtu = bt_att_get_mtu(server->att);\n\tuint8_t rsp_pdu[mtu];\n\tuint16_t rsp_len;\n\tuint8_t ecode = 0;\n\tuint16_t ehandle = 0;\n\tstruct queue *q = NULL;\n\n\tif (length != 6 && length != 20) {\n\t\tecode = BT_ATT_ERROR_INVALID_PDU;\n\t\tgoto error;\n\t}\n\n\tq = queue_new();\n\n\tstart = get_le16(pdu);\n\tend = get_le16(pdu + 2);\n\tget_uuid_le(pdu + 4, length - 4, &type);\n\n\tutil_debug(server->debug_callback, server->debug_data,\n\t\t\t\t\"Read By Grp Type - start: 0x%04x end: 0x%04x\",\n\t\t\t\tstart, end);\n\n\tif (!start || !end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\tehandle = start;\n\n\tif (start > end) {\n\t\tecode = BT_ATT_ERROR_INVALID_HANDLE;\n\t\tgoto error;\n\t}\n\n\t/*\n\t * GATT defines that only the <<Primary Service>> and\n\t * <<Secondary Service>> group types can be used for the\n\t * \"Read By Group Type\" request (Core v4.1, Vol 3, sec 2.5.3). Return an\n\t * error if any other group type is given.\n\t */\n\tbt_uuid16_create(&prim, GATT_PRIM_SVC_UUID);\n\tbt_uuid16_create(&snd, GATT_SND_SVC_UUID);\n\tif (bt_uuid_cmp(&type, &prim) && bt_uuid_cmp(&type, &snd)) {\n\t\tecode = BT_ATT_ERROR_UNSUPPORTED_GROUP_TYPE;\n\t\tgoto error;\n\t}\n\n\tgatt_db_read_by_group_type(server->db, start, end, type, q);\n\n\tif (queue_isempty(q)) {\n\t\tecode = BT_ATT_ERROR_ATTRIBUTE_NOT_FOUND;\n\t\tgoto error;\n\t}\n\n\tif (!encode_read_by_grp_type_rsp(server->db, q, server->att, mtu,\n\t\t\t\t\t\t\trsp_pdu, &rsp_len)) {\n\t\tecode = BT_ATT_ERROR_UNLIKELY;\n\t\tgoto error;\n\t}\n\n\tqueue_destroy(q, NULL);\n\n\tbt_att_send(server->att, BT_ATT_OP_READ_BY_GRP_TYPE_RSP,\n\t\t\t\t\t\t\trsp_pdu, rsp_len,\n\t\t\t\t\t\t\tNULL, NULL, NULL);\n\n\treturn;\n\nerror:\n\tqueue_destroy(q, NULL);\n\tbt_att_send_error_rsp(server->att, opcode, ehandle, ecode);\n}"
  },
  {
    "function_name": "encode_read_by_grp_type_rsp",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "179-237",
    "snippet": "static bool encode_read_by_grp_type_rsp(struct gatt_db *db, struct queue *q,\n\t\t\t\t\t\tstruct bt_att *att,\n\t\t\t\t\t\tuint16_t mtu, uint8_t *pdu,\n\t\t\t\t\t\tuint16_t *len)\n{\n\tint iter = 0;\n\tuint16_t start_handle, end_handle;\n\tstruct iovec value;\n\tuint8_t data_val_len;\n\n\t*len = 0;\n\n\twhile (queue_peek_head(q)) {\n\t\tstruct gatt_db_attribute *attrib = queue_pop_head(q);\n\n\t\tvalue.iov_base = NULL;\n\t\tvalue.iov_len = 0;\n\n\t\t/*\n\t\t * This should never be deferred to the read callback for\n\t\t * primary/secondary service declarations.\n\t\t */\n\t\tif (!gatt_db_attribute_read(attrib, 0,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tatt, attribute_read_cb,\n\t\t\t\t\t\t&value) || !value.iov_len)\n\t\t\treturn false;\n\n\t\t/*\n\t\t * Use the first attribute to determine the length of each\n\t\t * attribute data unit. Stop the list when a different attribute\n\t\t * value is seen.\n\t\t */\n\t\tif (iter == 0) {\n\t\t\tdata_val_len = MIN(MIN((unsigned)mtu - 6, 251),\n\t\t\t\t\t\t\t\tvalue.iov_len);\n\t\t\tpdu[0] = data_val_len + 4;\n\t\t\titer++;\n\t\t} else if (value.iov_len != data_val_len)\n\t\t\tbreak;\n\n\t\t/* Stop if this unit would surpass the MTU */\n\t\tif (iter + data_val_len + 4 > mtu - 1)\n\t\t\tbreak;\n\n\t\tgatt_db_attribute_get_service_handles(attrib, &start_handle,\n\t\t\t\t\t\t\t\t&end_handle);\n\n\t\tput_le16(start_handle, pdu + iter);\n\t\tput_le16(end_handle, pdu + iter + 2);\n\t\tmemcpy(pdu + iter + 4, value.iov_base, data_val_len);\n\n\t\titer += data_val_len + 4;\n\t}\n\n\t*len = iter;\n\n\treturn true;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "pdu + iter + 4",
            "value.iov_base",
            "data_val_len"
          ],
          "line": 229
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "put_le16",
          "args": [
            "end_handle",
            "pdu + iter + 2"
          ],
          "line": 228
        },
        "resolved": true,
        "details": {
          "function_name": "put_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "159-162",
          "snippet": "static inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline void put_le16(uint16_t val, void *dst)\n{\n\tput_unaligned(cpu_to_le16(val), (uint16_t *) dst);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_get_service_handles",
          "args": [
            "attrib",
            "&start_handle",
            "&end_handle"
          ],
          "line": 224
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_get_service_handles",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1521-1536",
          "snippet": "bool gatt_db_attribute_get_service_handles(\n\t\t\t\t\tconst struct gatt_db_attribute *attrib,\n\t\t\t\t\tuint16_t *start_handle,\n\t\t\t\t\tuint16_t *end_handle)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tgatt_db_service_get_handles(service, start_handle, end_handle);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nbool gatt_db_attribute_get_service_handles(\n\t\t\t\t\tconst struct gatt_db_attribute *attrib,\n\t\t\t\t\tuint16_t *start_handle,\n\t\t\t\t\tuint16_t *end_handle)\n{\n\tstruct gatt_db_service *service;\n\n\tif (!attrib)\n\t\treturn false;\n\n\tservice = attrib->service;\n\n\tgatt_db_service_get_handles(service, start_handle, end_handle);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "MIN((unsigned)mtu - 6, 251)",
            "value.iov_len"
          ],
          "line": 213
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MIN",
          "args": [
            "(unsigned)mtu - 6",
            "251"
          ],
          "line": 213
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "gatt_db_attribute_read",
          "args": [
            "attrib",
            "0",
            "BT_ATT_OP_READ_BY_GRP_TYPE_REQ",
            "att",
            "attribute_read_cb",
            "&value"
          ],
          "line": 201
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_attribute_read",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "1724-1763",
          "snippet": "bool gatt_db_attribute_read(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\tgatt_db_attribute_read_t func, void *user_data)\n{\n\tuint8_t *value;\n\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->read_func) {\n\t\tstruct pending_read *p;\n\n\t\tp = new0(struct pending_read, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->read_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, read_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_reads, p);\n\n\t\tattrib->read_func(attrib, p->id, offset, opcode, att,\n\t\t\t\t\t\t\tattrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Check boundary if value is stored in the db */\n\tif (offset > attrib->value_len) {\n\t\tfunc(attrib, BT_ATT_ERROR_INVALID_OFFSET, NULL, 0, user_data);\n\t\treturn true;\n\t}\n\n\t/* Guard against invalid access if offset equals to value length */\n\tvalue = offset == attrib->value_len ? NULL : &attrib->value[offset];\n\n\tfunc(attrib, 0, value, attrib->value_len - offset, user_data);\n\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ATTRIBUTE_TIMEOUT 5000"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\n#define ATTRIBUTE_TIMEOUT 5000\n\nbool gatt_db_attribute_read(struct gatt_db_attribute *attrib, uint16_t offset,\n\t\t\t\tuint8_t opcode, struct bt_att *att,\n\t\t\t\tgatt_db_attribute_read_t func, void *user_data)\n{\n\tuint8_t *value;\n\n\tif (!attrib || !func)\n\t\treturn false;\n\n\tif (attrib->read_func) {\n\t\tstruct pending_read *p;\n\n\t\tp = new0(struct pending_read, 1);\n\t\tp->attrib = attrib;\n\t\tp->id = ++attrib->read_id;\n\t\tp->timeout_id = timeout_add(ATTRIBUTE_TIMEOUT, read_timeout,\n\t\t\t\t\t\t\t\tp, NULL);\n\t\tp->func = func;\n\t\tp->user_data = user_data;\n\n\t\tqueue_push_tail(attrib->pending_reads, p);\n\n\t\tattrib->read_func(attrib, p->id, offset, opcode, att,\n\t\t\t\t\t\t\tattrib->user_data);\n\t\treturn true;\n\t}\n\n\t/* Check boundary if value is stored in the db */\n\tif (offset > attrib->value_len) {\n\t\tfunc(attrib, BT_ATT_ERROR_INVALID_OFFSET, NULL, 0, user_data);\n\t\treturn true;\n\t}\n\n\t/* Guard against invalid access if offset equals to value length */\n\tvalue = offset == attrib->value_len ? NULL : &attrib->value[offset];\n\n\tfunc(attrib, 0, value, attrib->value_len - offset, user_data);\n\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_pop_head",
          "args": [
            "q"
          ],
          "line": 192
        },
        "resolved": true,
        "details": {
          "function_name": "queue_pop_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "163-185",
          "snippet": "void *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_pop_head(struct queue *queue)\n{\n\tstruct queue_entry *entry;\n\tvoid *data;\n\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\tentry = queue->head;\n\n\tif (!queue->head->next) {\n\t\tqueue->head = NULL;\n\t\tqueue->tail = NULL;\n\t} else\n\t\tqueue->head = queue->head->next;\n\n\tdata = entry->data;\n\n\tfree(entry);\n\tqueue->entries--;\n\n\treturn data;\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_peek_head",
          "args": [
            "q"
          ],
          "line": 191
        },
        "resolved": true,
        "details": {
          "function_name": "queue_peek_head",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "187-193",
          "snippet": "void *queue_peek_head(struct queue *queue)\n{\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\treturn queue->head->data;\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid *queue_peek_head(struct queue *queue)\n{\n\tif (!queue || !queue->head)\n\t\treturn NULL;\n\n\treturn queue->head->data;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool encode_read_by_grp_type_rsp(struct gatt_db *db, struct queue *q,\n\t\t\t\t\t\tstruct bt_att *att,\n\t\t\t\t\t\tuint16_t mtu, uint8_t *pdu,\n\t\t\t\t\t\tuint16_t *len)\n{\n\tint iter = 0;\n\tuint16_t start_handle, end_handle;\n\tstruct iovec value;\n\tuint8_t data_val_len;\n\n\t*len = 0;\n\n\twhile (queue_peek_head(q)) {\n\t\tstruct gatt_db_attribute *attrib = queue_pop_head(q);\n\n\t\tvalue.iov_base = NULL;\n\t\tvalue.iov_len = 0;\n\n\t\t/*\n\t\t * This should never be deferred to the read callback for\n\t\t * primary/secondary service declarations.\n\t\t */\n\t\tif (!gatt_db_attribute_read(attrib, 0,\n\t\t\t\t\t\tBT_ATT_OP_READ_BY_GRP_TYPE_REQ,\n\t\t\t\t\t\tatt, attribute_read_cb,\n\t\t\t\t\t\t&value) || !value.iov_len)\n\t\t\treturn false;\n\n\t\t/*\n\t\t * Use the first attribute to determine the length of each\n\t\t * attribute data unit. Stop the list when a different attribute\n\t\t * value is seen.\n\t\t */\n\t\tif (iter == 0) {\n\t\t\tdata_val_len = MIN(MIN((unsigned)mtu - 6, 251),\n\t\t\t\t\t\t\t\tvalue.iov_len);\n\t\t\tpdu[0] = data_val_len + 4;\n\t\t\titer++;\n\t\t} else if (value.iov_len != data_val_len)\n\t\t\tbreak;\n\n\t\t/* Stop if this unit would surpass the MTU */\n\t\tif (iter + data_val_len + 4 > mtu - 1)\n\t\t\tbreak;\n\n\t\tgatt_db_attribute_get_service_handles(attrib, &start_handle,\n\t\t\t\t\t\t\t\t&end_handle);\n\n\t\tput_le16(start_handle, pdu + iter);\n\t\tput_le16(end_handle, pdu + iter + 2);\n\t\tmemcpy(pdu + iter + 4, value.iov_base, data_val_len);\n\n\t\titer += data_val_len + 4;\n\t}\n\n\t*len = iter;\n\n\treturn true;\n}"
  },
  {
    "function_name": "attribute_read_cb",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "169-177",
    "snippet": "static void attribute_read_cb(struct gatt_db_attribute *attrib, int err,\n\t\t\t\t\tconst uint8_t *value, size_t length,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct iovec *iov = user_data;\n\n\tiov->iov_base = (void *) value;\n\tiov->iov_len = length;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);"
    ],
    "called_functions": [],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void exec_next_prep_write(struct bt_gatt_server *server,\n\t\t\t\t\t\tuint16_t ehandle, int err);\n\nstatic void attribute_read_cb(struct gatt_db_attribute *attrib, int err,\n\t\t\t\t\tconst uint8_t *value, size_t length,\n\t\t\t\t\tvoid *user_data)\n{\n\tstruct iovec *iov = user_data;\n\n\tiov->iov_base = (void *) value;\n\tiov->iov_len = length;\n}"
  },
  {
    "function_name": "get_uuid_le",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "150-167",
    "snippet": "static bool get_uuid_le(const uint8_t *uuid, size_t len, bt_uuid_t *out_uuid)\n{\n\tuint128_t u128;\n\n\tswitch (len) {\n\tcase 2:\n\t\tbt_uuid16_create(out_uuid, get_le16(uuid));\n\t\treturn true;\n\tcase 16:\n\t\tbswap_128(uuid, &u128.data);\n\t\tbt_uuid128_create(out_uuid, u128);\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n\n\treturn false;\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "bt_uuid128_create",
          "args": [
            "out_uuid",
            "u128"
          ],
          "line": 160
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bswap_128",
          "args": [
            "uuid",
            "&u128.data"
          ],
          "line": 159
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bt_uuid16_create",
          "args": [
            "out_uuid",
            "get_le16(uuid)"
          ],
          "line": 156
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_le16",
          "args": [
            "uuid"
          ],
          "line": 156
        },
        "resolved": true,
        "details": {
          "function_name": "get_le16",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/util.h",
          "lines": "129-132",
          "snippet": "static inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}",
          "includes": [
            "#include <string.h>",
            "#include <byteswap.h>",
            "#include <alloca.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include <byteswap.h>\n#include <alloca.h>\n#include <stdlib.h>\n#include <stdint.h>\n\nstatic inline uint16_t get_le16(const void *ptr)\n{\n\treturn le16_to_cpu(get_unaligned((const uint16_t *) ptr));\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic bool get_uuid_le(const uint8_t *uuid, size_t len, bt_uuid_t *out_uuid)\n{\n\tuint128_t u128;\n\n\tswitch (len) {\n\tcase 2:\n\t\tbt_uuid16_create(out_uuid, get_le16(uuid));\n\t\treturn true;\n\tcase 16:\n\t\tbswap_128(uuid, &u128.data);\n\t\tbt_uuid128_create(out_uuid, u128);\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n\n\treturn false;\n}"
  },
  {
    "function_name": "bt_gatt_server_free",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "119-148",
    "snippet": "static void bt_gatt_server_free(struct bt_gatt_server *server)\n{\n\tif (server->debug_destroy)\n\t\tserver->debug_destroy(server->debug_data);\n\n\tbt_att_unregister(server->att, server->mtu_id);\n\tbt_att_unregister(server->att, server->read_by_grp_type_id);\n\tbt_att_unregister(server->att, server->read_by_type_id);\n\tbt_att_unregister(server->att, server->find_info_id);\n\tbt_att_unregister(server->att, server->find_by_type_value_id);\n\tbt_att_unregister(server->att, server->write_id);\n\tbt_att_unregister(server->att, server->write_cmd_id);\n\tbt_att_unregister(server->att, server->read_id);\n\tbt_att_unregister(server->att, server->read_blob_id);\n\tbt_att_unregister(server->att, server->read_multiple_id);\n\tbt_att_unregister(server->att, server->prep_write_id);\n\tbt_att_unregister(server->att, server->exec_write_id);\n\n\tif (server->pending_read_op)\n\t\tserver->pending_read_op->server = NULL;\n\n\tif (server->pending_write_op)\n\t\tserver->pending_write_op->server = NULL;\n\n\tqueue_destroy(server->prep_queue, prep_write_data_destroy);\n\n\tgatt_db_unref(server->db);\n\tbt_att_unref(server->att);\n\tfree(server);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "server"
          ],
          "line": 147
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_unref",
          "args": [
            "server->att"
          ],
          "line": 146
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1063-1075",
          "snippet": "void bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nvoid bt_att_unref(struct bt_att *att)\n{\n\tif (!att)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&att->ref_count, 1))\n\t\treturn;\n\n\tbt_att_unregister_all(att);\n\tbt_att_cancel_all(att);\n\n\tbt_att_free(att);\n}"
        }
      },
      {
        "call_info": {
          "callee": "gatt_db_unref",
          "args": [
            "server->db"
          ],
          "line": 145
        },
        "resolved": true,
        "details": {
          "function_name": "gatt_db_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-db.c",
          "lines": "316-325",
          "snippet": "void gatt_db_unref(struct gatt_db *db)\n{\n\tif (!db)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&db->ref_count, 1))\n\t\treturn;\n\n\tgatt_db_destroy(db);\n}",
          "includes": [
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include <errno.h>",
            "#include <stdbool.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/gatt-db.h\"\n#include \"src/shared/att.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include <errno.h>\n#include <stdbool.h>\n#include <config.h>\n\nvoid gatt_db_unref(struct gatt_db *db)\n{\n\tif (!db)\n\t\treturn;\n\n\tif (__sync_sub_and_fetch(&db->ref_count, 1))\n\t\treturn;\n\n\tgatt_db_destroy(db);\n}"
        }
      },
      {
        "call_info": {
          "callee": "queue_destroy",
          "args": [
            "server->prep_queue",
            "prep_write_data_destroy"
          ],
          "line": 143
        },
        "resolved": true,
        "details": {
          "function_name": "queue_destroy",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/queue.c",
          "lines": "68-76",
          "snippet": "void queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}",
          "includes": [
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/util.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/queue.h\"\n#include \"src/shared/util.h\"\n#include <config.h>\n\nvoid queue_destroy(struct queue *queue, queue_destroy_func_t destroy)\n{\n\tif (!queue)\n\t\treturn;\n\n\tqueue_remove_all(queue, NULL, NULL, destroy);\n\n\tqueue_unref(queue);\n}"
        }
      },
      {
        "call_info": {
          "callee": "bt_att_unregister",
          "args": [
            "server->att",
            "server->exec_write_id"
          ],
          "line": 135
        },
        "resolved": true,
        "details": {
          "function_name": "bt_att_unregister",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/att.c",
          "lines": "1431-1445",
          "snippet": "bool bt_att_unregister(struct bt_att *att, unsigned int id)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tnotify = queue_remove_if(att->notify_list, match_notify_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tdestroy_att_notify(notify);\n\treturn true;\n}",
          "includes": [
            "#include \"src/shared/crypto.h\"",
            "#include \"src/shared/att.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/l2cap.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/timeout.h\"",
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"src/shared/io.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/crypto.h\"\n#include \"src/shared/att.h\"\n#include \"lib/uuid.h\"\n#include \"lib/l2cap.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/timeout.h\"\n#include \"src/shared/util.h\"\n#include \"src/shared/queue.h\"\n#include \"src/shared/io.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <config.h>\n\nbool bt_att_unregister(struct bt_att *att, unsigned int id)\n{\n\tstruct att_notify *notify;\n\n\tif (!att || !id)\n\t\treturn false;\n\n\tnotify = queue_remove_if(att->notify_list, match_notify_id,\n\t\t\t\t\t\t\tUINT_TO_PTR(id));\n\tif (!notify)\n\t\treturn false;\n\n\tdestroy_att_notify(notify);\n\treturn true;\n}"
        }
      },
      {
        "call_info": {
          "callee": "server->debug_destroy",
          "args": [
            "server->debug_data"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void bt_gatt_server_free(struct bt_gatt_server *server)\n{\n\tif (server->debug_destroy)\n\t\tserver->debug_destroy(server->debug_data);\n\n\tbt_att_unregister(server->att, server->mtu_id);\n\tbt_att_unregister(server->att, server->read_by_grp_type_id);\n\tbt_att_unregister(server->att, server->read_by_type_id);\n\tbt_att_unregister(server->att, server->find_info_id);\n\tbt_att_unregister(server->att, server->find_by_type_value_id);\n\tbt_att_unregister(server->att, server->write_id);\n\tbt_att_unregister(server->att, server->write_cmd_id);\n\tbt_att_unregister(server->att, server->read_id);\n\tbt_att_unregister(server->att, server->read_blob_id);\n\tbt_att_unregister(server->att, server->read_multiple_id);\n\tbt_att_unregister(server->att, server->prep_write_id);\n\tbt_att_unregister(server->att, server->exec_write_id);\n\n\tif (server->pending_read_op)\n\t\tserver->pending_read_op->server = NULL;\n\n\tif (server->pending_write_op)\n\t\tserver->pending_write_op->server = NULL;\n\n\tqueue_destroy(server->prep_queue, prep_write_data_destroy);\n\n\tgatt_db_unref(server->db);\n\tbt_att_unref(server->att);\n\tfree(server);\n}"
  },
  {
    "function_name": "prep_write_data_destroy",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
    "lines": "79-85",
    "snippet": "static void prep_write_data_destroy(void *user_data)\n{\n\tstruct prep_write_data *data = user_data;\n\n\tfree(data->value);\n\tfree(data);\n}",
    "includes": [
      "#include \"src/shared/util.h\"",
      "#include \"src/shared/gatt-helpers.h\"",
      "#include \"src/shared/gatt-server.h\"",
      "#include \"src/shared/gatt-db.h\"",
      "#include \"src/shared/queue.h\"",
      "#include \"lib/uuid.h\"",
      "#include \"lib/bluetooth.h\"",
      "#include \"src/shared/att.h\"",
      "#include <errno.h>",
      "#include <sys/uio.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "data"
          ],
          "line": 84
        },
        "resolved": true,
        "details": {
          "function_name": "read_multiple_resp_data_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c_ICV/CVE-2021-3658/repo/src/shared/gatt-server.c",
          "lines": "994-999",
          "snippet": "static void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}",
          "includes": [
            "#include \"src/shared/util.h\"",
            "#include \"src/shared/gatt-helpers.h\"",
            "#include \"src/shared/gatt-server.h\"",
            "#include \"src/shared/gatt-db.h\"",
            "#include \"src/shared/queue.h\"",
            "#include \"lib/uuid.h\"",
            "#include \"lib/bluetooth.h\"",
            "#include \"src/shared/att.h\"",
            "#include <errno.h>",
            "#include <sys/uio.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void read_multiple_resp_data_free(struct read_multiple_resp_data *data)\n{\n\tfree(data->handles);\n\tfree(data->rsp_data);\n\tfree(data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"src/shared/util.h\"\n#include \"src/shared/gatt-helpers.h\"\n#include \"src/shared/gatt-server.h\"\n#include \"src/shared/gatt-db.h\"\n#include \"src/shared/queue.h\"\n#include \"lib/uuid.h\"\n#include \"lib/bluetooth.h\"\n#include \"src/shared/att.h\"\n#include <errno.h>\n#include <sys/uio.h>\n#include <config.h>\n\nstatic void prep_write_data_destroy(void *user_data)\n{\n\tstruct prep_write_data *data = user_data;\n\n\tfree(data->value);\n\tfree(data);\n}"
  }
]