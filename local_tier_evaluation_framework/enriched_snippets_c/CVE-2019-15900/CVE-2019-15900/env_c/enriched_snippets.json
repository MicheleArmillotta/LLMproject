[
  {
    "function_name": "prepenv",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
    "lines": "218-236",
    "snippet": "char **\nprepenv(struct rule *rule, struct passwd *original, struct passwd *target)\n{\n        static const char *safeset[] = {\n                \"DISPLAY\", \"TERM\", NULL\n        };\n\n\tstruct env *env;\n\n\tenv = createenv(rule, original, target);\n\n\t/* if we started with blank, fill some defaults then apply rules */\n\tif (!(rule->options & KEEPENV))\n\t\tfillenv(env, safeset);\n\tif (rule->envlist)\n\t\tfillenv(env, rule->envlist);\n\n\treturn flattenenv(env);\n}",
    "includes": [
      "#include \"doas.h\"",
      "#include \"tree.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <err.h>",
      "#include <pwd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <sys/tree.h>",
      "#include <sys/types.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "flattenenv",
          "args": [
            "env"
          ],
          "line": 235
        },
        "resolved": true,
        "details": {
          "function_name": "flattenenv",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
          "lines": "146-164",
          "snippet": "static char **\nflattenenv(struct env *env)\n{\n\tchar **envp;\n\tstruct envnode *node;\n\tu_int i;\n\n\tenvp = reallocarray(NULL, env->count + 1, sizeof(char *));\n\tif (!envp)\n\t\terr(1, NULL);\n\ti = 0;\n\tRB_FOREACH(node, envtree, &env->root) {\n\t\tif (asprintf(&envp[i], \"%s=%s\", node->key, node->value) == -1)\n\t\t\terr(1, NULL);\n\t\ti++;\n\t}\n\tenvp[i] = NULL;\n\treturn envp;\n}",
          "includes": [
            "#include \"doas.h\"",
            "#include \"tree.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <err.h>",
            "#include <pwd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <sys/tree.h>",
            "#include <sys/types.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic char **\nflattenenv(struct env *env)\n{\n\tchar **envp;\n\tstruct envnode *node;\n\tu_int i;\n\n\tenvp = reallocarray(NULL, env->count + 1, sizeof(char *));\n\tif (!envp)\n\t\terr(1, NULL);\n\ti = 0;\n\tRB_FOREACH(node, envtree, &env->root) {\n\t\tif (asprintf(&envp[i], \"%s=%s\", node->key, node->value) == -1)\n\t\t\terr(1, NULL);\n\t\ti++;\n\t}\n\tenvp[i] = NULL;\n\treturn envp;\n}"
        }
      },
      {
        "call_info": {
          "callee": "fillenv",
          "args": [
            "env",
            "rule->envlist"
          ],
          "line": 233
        },
        "resolved": true,
        "details": {
          "function_name": "fillenv",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
          "lines": "166-216",
          "snippet": "static void\nfillenv(struct env *env, const char **envlist)\n{\n\tstruct envnode *node, key;\n\tconst char *e, *eq;\n\tconst char *val;\n\tchar name[1024];\n\tu_int i;\n\tsize_t len;\n\n\tfor (i = 0; envlist[i]; i++) {\n\t\te = envlist[i];\n\n\t\t/* parse out env name */\n\t\tif ((eq = strchr(e, '=')) == NULL)\n\t\t\tlen = strlen(e);\n\t\telse\n\t\t\tlen = eq - e;\n\t\tif (len > sizeof(name) - 1)\n\t\t\tcontinue;\n\t\tmemcpy(name, e, len);\n\t\tname[len] = '\\0';\n\n\t\t/* delete previous copies */\n\t\tkey.key = name;\n\t\tif (*name == '-')\n\t\t\tkey.key = name + 1;\n\t\tif ((node = RB_FIND(envtree, &env->root, &key))) {\n\t\t\tRB_REMOVE(envtree, &env->root, node);\n\t\t\tfreenode(node);\n\t\t\tenv->count--;\n\t\t}\n\t\tif (*name == '-')\n\t\t\tcontinue;\n\n\t\t/* assign value or inherit from environ */\n\t\tif (eq) {\n\t\t\tval = eq + 1;\n\t\t\tif (*val == '$')\n\t\t\t\tval = getenv(val + 1);\n\t\t} else {\n\t\t\tval = getenv(name);\n\t\t}\n\t\t/* at last, we have something to insert */\n\t\tif (val) {\n\t\t\tnode = createnode(name, val);\n\t\t\tRB_INSERT(envtree, &env->root, node);\n\t\t\tenv->count++;\n\t\t}\n\t}\n}",
          "includes": [
            "#include \"doas.h\"",
            "#include \"tree.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <err.h>",
            "#include <pwd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <sys/tree.h>",
            "#include <sys/types.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic void\nfillenv(struct env *env, const char **envlist)\n{\n\tstruct envnode *node, key;\n\tconst char *e, *eq;\n\tconst char *val;\n\tchar name[1024];\n\tu_int i;\n\tsize_t len;\n\n\tfor (i = 0; envlist[i]; i++) {\n\t\te = envlist[i];\n\n\t\t/* parse out env name */\n\t\tif ((eq = strchr(e, '=')) == NULL)\n\t\t\tlen = strlen(e);\n\t\telse\n\t\t\tlen = eq - e;\n\t\tif (len > sizeof(name) - 1)\n\t\t\tcontinue;\n\t\tmemcpy(name, e, len);\n\t\tname[len] = '\\0';\n\n\t\t/* delete previous copies */\n\t\tkey.key = name;\n\t\tif (*name == '-')\n\t\t\tkey.key = name + 1;\n\t\tif ((node = RB_FIND(envtree, &env->root, &key))) {\n\t\t\tRB_REMOVE(envtree, &env->root, node);\n\t\t\tfreenode(node);\n\t\t\tenv->count--;\n\t\t}\n\t\tif (*name == '-')\n\t\t\tcontinue;\n\n\t\t/* assign value or inherit from environ */\n\t\tif (eq) {\n\t\t\tval = eq + 1;\n\t\t\tif (*val == '$')\n\t\t\t\tval = getenv(val + 1);\n\t\t} else {\n\t\t\tval = getenv(name);\n\t\t}\n\t\t/* at last, we have something to insert */\n\t\tif (val) {\n\t\t\tnode = createnode(name, val);\n\t\t\tRB_INSERT(envtree, &env->root, node);\n\t\t\tenv->count++;\n\t\t}\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "createenv",
          "args": [
            "rule",
            "original",
            "target"
          ],
          "line": 227
        },
        "resolved": true,
        "details": {
          "function_name": "createenv",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
          "lines": "92-144",
          "snippet": "static struct env *\ncreateenv(struct rule *rule, struct passwd *original, struct passwd *target)\n{\n\tstruct env *env;\n\tu_int i;\n\n\tenv = malloc(sizeof(*env));\n\tif (!env)\n\t\terr(1, NULL);\n\tRB_INIT(&env->root);\n\tenv->count = 0;\n\n        addnode(env, \"DOAS_USER\", original->pw_name);\n\taddnode(env, \"HOME\", target->pw_dir);\n\taddnode(env, \"LOGNAME\", target->pw_name);\n\taddnode(env, \"PATH\", GLOBAL_PATH); \n\taddnode(env, \"SHELL\", target->pw_shell);\n\taddnode(env, \"USER\", target->pw_name);\n\n\tif (rule->options & KEEPENV) {\n                #ifndef linux\n\t\textern const char **environ;\n                #endif\n\n\t\tfor (i = 0; environ[i] != NULL; i++) {\n\t\t\tstruct envnode *node;\n\t\t\tconst char *e, *eq;\n\t\t\tsize_t len;\n\t\t\tchar name[1024];\n\n\t\t\te = environ[i];\n\n\t\t\t/* ignore invalid or overlong names */\n\t\t\tif ((eq = strchr(e, '=')) == NULL || eq == e)\n\t\t\t\tcontinue;\n\t\t\tlen = eq - e;\n\t\t\tif (len > sizeof(name) - 1)\n\t\t\t\tcontinue;\n\t\t\tmemcpy(name, e, len);\n\t\t\tname[len] = '\\0';\n\n\t\t\tnode = createnode(name, eq + 1);\n\t\t\tif (RB_INSERT(envtree, &env->root, node)) {\n\t\t\t\t/* ignore any later duplicates */\n\t\t\t\tfreenode(node);\n\t\t\t} else {\n\t\t\t\tenv->count++;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn env;\n}",
          "includes": [
            "#include \"doas.h\"",
            "#include \"tree.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <err.h>",
            "#include <pwd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <sys/tree.h>",
            "#include <sys/types.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic struct env *\ncreateenv(struct rule *rule, struct passwd *original, struct passwd *target)\n{\n\tstruct env *env;\n\tu_int i;\n\n\tenv = malloc(sizeof(*env));\n\tif (!env)\n\t\terr(1, NULL);\n\tRB_INIT(&env->root);\n\tenv->count = 0;\n\n        addnode(env, \"DOAS_USER\", original->pw_name);\n\taddnode(env, \"HOME\", target->pw_dir);\n\taddnode(env, \"LOGNAME\", target->pw_name);\n\taddnode(env, \"PATH\", GLOBAL_PATH); \n\taddnode(env, \"SHELL\", target->pw_shell);\n\taddnode(env, \"USER\", target->pw_name);\n\n\tif (rule->options & KEEPENV) {\n                #ifndef linux\n\t\textern const char **environ;\n                #endif\n\n\t\tfor (i = 0; environ[i] != NULL; i++) {\n\t\t\tstruct envnode *node;\n\t\t\tconst char *e, *eq;\n\t\t\tsize_t len;\n\t\t\tchar name[1024];\n\n\t\t\te = environ[i];\n\n\t\t\t/* ignore invalid or overlong names */\n\t\t\tif ((eq = strchr(e, '=')) == NULL || eq == e)\n\t\t\t\tcontinue;\n\t\t\tlen = eq - e;\n\t\t\tif (len > sizeof(name) - 1)\n\t\t\t\tcontinue;\n\t\t\tmemcpy(name, e, len);\n\t\t\tname[len] = '\\0';\n\n\t\t\tnode = createnode(name, eq + 1);\n\t\t\tif (RB_INSERT(envtree, &env->root, node)) {\n\t\t\t\t/* ignore any later duplicates */\n\t\t\t\tfreenode(node);\n\t\t\t} else {\n\t\t\t\tenv->count++;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn env;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nchar **\nprepenv(struct rule *rule, struct passwd *original, struct passwd *target)\n{\n        static const char *safeset[] = {\n                \"DISPLAY\", \"TERM\", NULL\n        };\n\n\tstruct env *env;\n\n\tenv = createenv(rule, original, target);\n\n\t/* if we started with blank, fill some defaults then apply rules */\n\tif (!(rule->options & KEEPENV))\n\t\tfillenv(env, safeset);\n\tif (rule->envlist)\n\t\tfillenv(env, rule->envlist);\n\n\treturn flattenenv(env);\n}"
  },
  {
    "function_name": "fillenv",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
    "lines": "166-216",
    "snippet": "static void\nfillenv(struct env *env, const char **envlist)\n{\n\tstruct envnode *node, key;\n\tconst char *e, *eq;\n\tconst char *val;\n\tchar name[1024];\n\tu_int i;\n\tsize_t len;\n\n\tfor (i = 0; envlist[i]; i++) {\n\t\te = envlist[i];\n\n\t\t/* parse out env name */\n\t\tif ((eq = strchr(e, '=')) == NULL)\n\t\t\tlen = strlen(e);\n\t\telse\n\t\t\tlen = eq - e;\n\t\tif (len > sizeof(name) - 1)\n\t\t\tcontinue;\n\t\tmemcpy(name, e, len);\n\t\tname[len] = '\\0';\n\n\t\t/* delete previous copies */\n\t\tkey.key = name;\n\t\tif (*name == '-')\n\t\t\tkey.key = name + 1;\n\t\tif ((node = RB_FIND(envtree, &env->root, &key))) {\n\t\t\tRB_REMOVE(envtree, &env->root, node);\n\t\t\tfreenode(node);\n\t\t\tenv->count--;\n\t\t}\n\t\tif (*name == '-')\n\t\t\tcontinue;\n\n\t\t/* assign value or inherit from environ */\n\t\tif (eq) {\n\t\t\tval = eq + 1;\n\t\t\tif (*val == '$')\n\t\t\t\tval = getenv(val + 1);\n\t\t} else {\n\t\t\tval = getenv(name);\n\t\t}\n\t\t/* at last, we have something to insert */\n\t\tif (val) {\n\t\t\tnode = createnode(name, val);\n\t\t\tRB_INSERT(envtree, &env->root, node);\n\t\t\tenv->count++;\n\t\t}\n\t}\n}",
    "includes": [
      "#include \"doas.h\"",
      "#include \"tree.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <err.h>",
      "#include <pwd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <sys/tree.h>",
      "#include <sys/types.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "RB_INSERT",
          "args": [
            "envtree",
            "&env->root",
            "node"
          ],
          "line": 212
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "createnode",
          "args": [
            "name",
            "val"
          ],
          "line": 211
        },
        "resolved": true,
        "details": {
          "function_name": "createnode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
          "lines": "58-71",
          "snippet": "static struct envnode *\ncreatenode(const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = malloc(sizeof(*node));\n\tif (!node)\n\t\terr(1, NULL);\n\tnode->key = strdup(key);\n\tnode->value = strdup(value);\n\tif (!node->key || !node->value)\n\t\terr(1, NULL);\n\treturn node;\n}",
          "includes": [
            "#include \"doas.h\"",
            "#include \"tree.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <err.h>",
            "#include <pwd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <sys/tree.h>",
            "#include <sys/types.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic struct envnode *\ncreatenode(const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = malloc(sizeof(*node));\n\tif (!node)\n\t\terr(1, NULL);\n\tnode->key = strdup(key);\n\tnode->value = strdup(value);\n\tif (!node->key || !node->value)\n\t\terr(1, NULL);\n\treturn node;\n}"
        }
      },
      {
        "call_info": {
          "callee": "getenv",
          "args": [
            "name"
          ],
          "line": 207
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getenv",
          "args": [
            "val + 1"
          ],
          "line": 205
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freenode",
          "args": [
            "node"
          ],
          "line": 195
        },
        "resolved": true,
        "details": {
          "function_name": "freenode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
          "lines": "73-79",
          "snippet": "static void\nfreenode(struct envnode *node)\n{\n\tfree((char *)node->key);\n\tfree((char *)node->value);\n\tfree(node);\n}",
          "includes": [
            "#include \"doas.h\"",
            "#include \"tree.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <err.h>",
            "#include <pwd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <sys/tree.h>",
            "#include <sys/types.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic void\nfreenode(struct envnode *node)\n{\n\tfree((char *)node->key);\n\tfree((char *)node->value);\n\tfree(node);\n}"
        }
      },
      {
        "call_info": {
          "callee": "RB_REMOVE",
          "args": [
            "envtree",
            "&env->root",
            "node"
          ],
          "line": 194
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "RB_FIND",
          "args": [
            "envtree",
            "&env->root",
            "&key"
          ],
          "line": 193
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "name",
            "e",
            "len"
          ],
          "line": 186
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "e"
          ],
          "line": 181
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strchr",
          "args": [
            "e",
            "'='"
          ],
          "line": 180
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic void\nfillenv(struct env *env, const char **envlist)\n{\n\tstruct envnode *node, key;\n\tconst char *e, *eq;\n\tconst char *val;\n\tchar name[1024];\n\tu_int i;\n\tsize_t len;\n\n\tfor (i = 0; envlist[i]; i++) {\n\t\te = envlist[i];\n\n\t\t/* parse out env name */\n\t\tif ((eq = strchr(e, '=')) == NULL)\n\t\t\tlen = strlen(e);\n\t\telse\n\t\t\tlen = eq - e;\n\t\tif (len > sizeof(name) - 1)\n\t\t\tcontinue;\n\t\tmemcpy(name, e, len);\n\t\tname[len] = '\\0';\n\n\t\t/* delete previous copies */\n\t\tkey.key = name;\n\t\tif (*name == '-')\n\t\t\tkey.key = name + 1;\n\t\tif ((node = RB_FIND(envtree, &env->root, &key))) {\n\t\t\tRB_REMOVE(envtree, &env->root, node);\n\t\t\tfreenode(node);\n\t\t\tenv->count--;\n\t\t}\n\t\tif (*name == '-')\n\t\t\tcontinue;\n\n\t\t/* assign value or inherit from environ */\n\t\tif (eq) {\n\t\t\tval = eq + 1;\n\t\t\tif (*val == '$')\n\t\t\t\tval = getenv(val + 1);\n\t\t} else {\n\t\t\tval = getenv(name);\n\t\t}\n\t\t/* at last, we have something to insert */\n\t\tif (val) {\n\t\t\tnode = createnode(name, val);\n\t\t\tRB_INSERT(envtree, &env->root, node);\n\t\t\tenv->count++;\n\t\t}\n\t}\n}"
  },
  {
    "function_name": "flattenenv",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
    "lines": "146-164",
    "snippet": "static char **\nflattenenv(struct env *env)\n{\n\tchar **envp;\n\tstruct envnode *node;\n\tu_int i;\n\n\tenvp = reallocarray(NULL, env->count + 1, sizeof(char *));\n\tif (!envp)\n\t\terr(1, NULL);\n\ti = 0;\n\tRB_FOREACH(node, envtree, &env->root) {\n\t\tif (asprintf(&envp[i], \"%s=%s\", node->key, node->value) == -1)\n\t\t\terr(1, NULL);\n\t\ti++;\n\t}\n\tenvp[i] = NULL;\n\treturn envp;\n}",
    "includes": [
      "#include \"doas.h\"",
      "#include \"tree.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <err.h>",
      "#include <pwd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <sys/tree.h>",
      "#include <sys/types.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "err",
          "args": [
            "1",
            "NULL"
          ],
          "line": 159
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "asprintf",
          "args": [
            "&envp[i]",
            "\"%s=%s\"",
            "node->key",
            "node->value"
          ],
          "line": 158
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "RB_FOREACH",
          "args": [
            "node",
            "envtree",
            "&env->root"
          ],
          "line": 157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "err",
          "args": [
            "1",
            "NULL"
          ],
          "line": 155
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "reallocarray",
          "args": [
            "NULL",
            "env->count + 1",
            "sizeof(char *)"
          ],
          "line": 153
        },
        "resolved": true,
        "details": {
          "function_name": "reallocarray",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/reallocarray.c",
          "lines": "29-38",
          "snippet": "void *\nreallocarray(void *optr, size_t nmemb, size_t size)\n{\n\tif ((nmemb >= MUL_NO_OVERFLOW || size >= MUL_NO_OVERFLOW) &&\n\t    nmemb > 0 && SIZE_MAX / nmemb < size) {\n\t\terrno = ENOMEM;\n\t\treturn NULL;\n\t}\n\treturn realloc(optr, size * nmemb);\n}",
          "includes": [
            "#include <stdlib.h>",
            "#include <stdint.h>",
            "#include <errno.h>",
            "#include <sys/types.h>"
          ],
          "macros_used": [
            "#define MUL_NO_OVERFLOW\t((size_t)1 << (sizeof(size_t) * 4))"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <stdlib.h>\n#include <stdint.h>\n#include <errno.h>\n#include <sys/types.h>\n\n#define MUL_NO_OVERFLOW\t((size_t)1 << (sizeof(size_t) * 4))\n\nvoid *\nreallocarray(void *optr, size_t nmemb, size_t size)\n{\n\tif ((nmemb >= MUL_NO_OVERFLOW || size >= MUL_NO_OVERFLOW) &&\n\t    nmemb > 0 && SIZE_MAX / nmemb < size) {\n\t\terrno = ENOMEM;\n\t\treturn NULL;\n\t}\n\treturn realloc(optr, size * nmemb);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic char **\nflattenenv(struct env *env)\n{\n\tchar **envp;\n\tstruct envnode *node;\n\tu_int i;\n\n\tenvp = reallocarray(NULL, env->count + 1, sizeof(char *));\n\tif (!envp)\n\t\terr(1, NULL);\n\ti = 0;\n\tRB_FOREACH(node, envtree, &env->root) {\n\t\tif (asprintf(&envp[i], \"%s=%s\", node->key, node->value) == -1)\n\t\t\terr(1, NULL);\n\t\ti++;\n\t}\n\tenvp[i] = NULL;\n\treturn envp;\n}"
  },
  {
    "function_name": "createenv",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
    "lines": "92-144",
    "snippet": "static struct env *\ncreateenv(struct rule *rule, struct passwd *original, struct passwd *target)\n{\n\tstruct env *env;\n\tu_int i;\n\n\tenv = malloc(sizeof(*env));\n\tif (!env)\n\t\terr(1, NULL);\n\tRB_INIT(&env->root);\n\tenv->count = 0;\n\n        addnode(env, \"DOAS_USER\", original->pw_name);\n\taddnode(env, \"HOME\", target->pw_dir);\n\taddnode(env, \"LOGNAME\", target->pw_name);\n\taddnode(env, \"PATH\", GLOBAL_PATH); \n\taddnode(env, \"SHELL\", target->pw_shell);\n\taddnode(env, \"USER\", target->pw_name);\n\n\tif (rule->options & KEEPENV) {\n                #ifndef linux\n\t\textern const char **environ;\n                #endif\n\n\t\tfor (i = 0; environ[i] != NULL; i++) {\n\t\t\tstruct envnode *node;\n\t\t\tconst char *e, *eq;\n\t\t\tsize_t len;\n\t\t\tchar name[1024];\n\n\t\t\te = environ[i];\n\n\t\t\t/* ignore invalid or overlong names */\n\t\t\tif ((eq = strchr(e, '=')) == NULL || eq == e)\n\t\t\t\tcontinue;\n\t\t\tlen = eq - e;\n\t\t\tif (len > sizeof(name) - 1)\n\t\t\t\tcontinue;\n\t\t\tmemcpy(name, e, len);\n\t\t\tname[len] = '\\0';\n\n\t\t\tnode = createnode(name, eq + 1);\n\t\t\tif (RB_INSERT(envtree, &env->root, node)) {\n\t\t\t\t/* ignore any later duplicates */\n\t\t\t\tfreenode(node);\n\t\t\t} else {\n\t\t\t\tenv->count++;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn env;\n}",
    "includes": [
      "#include \"doas.h\"",
      "#include \"tree.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <err.h>",
      "#include <pwd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <sys/tree.h>",
      "#include <sys/types.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "freenode",
          "args": [
            "node"
          ],
          "line": 136
        },
        "resolved": true,
        "details": {
          "function_name": "freenode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
          "lines": "73-79",
          "snippet": "static void\nfreenode(struct envnode *node)\n{\n\tfree((char *)node->key);\n\tfree((char *)node->value);\n\tfree(node);\n}",
          "includes": [
            "#include \"doas.h\"",
            "#include \"tree.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <err.h>",
            "#include <pwd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <sys/tree.h>",
            "#include <sys/types.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic void\nfreenode(struct envnode *node)\n{\n\tfree((char *)node->key);\n\tfree((char *)node->value);\n\tfree(node);\n}"
        }
      },
      {
        "call_info": {
          "callee": "RB_INSERT",
          "args": [
            "envtree",
            "&env->root",
            "node"
          ],
          "line": 134
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "createnode",
          "args": [
            "name",
            "eq + 1"
          ],
          "line": 133
        },
        "resolved": true,
        "details": {
          "function_name": "createnode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
          "lines": "58-71",
          "snippet": "static struct envnode *\ncreatenode(const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = malloc(sizeof(*node));\n\tif (!node)\n\t\terr(1, NULL);\n\tnode->key = strdup(key);\n\tnode->value = strdup(value);\n\tif (!node->key || !node->value)\n\t\terr(1, NULL);\n\treturn node;\n}",
          "includes": [
            "#include \"doas.h\"",
            "#include \"tree.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <err.h>",
            "#include <pwd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <sys/tree.h>",
            "#include <sys/types.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic struct envnode *\ncreatenode(const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = malloc(sizeof(*node));\n\tif (!node)\n\t\terr(1, NULL);\n\tnode->key = strdup(key);\n\tnode->value = strdup(value);\n\tif (!node->key || !node->value)\n\t\terr(1, NULL);\n\treturn node;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "name",
            "e",
            "len"
          ],
          "line": 130
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strchr",
          "args": [
            "e",
            "'='"
          ],
          "line": 125
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "addnode",
          "args": [
            "env",
            "\"USER\"",
            "target->pw_name"
          ],
          "line": 109
        },
        "resolved": true,
        "details": {
          "function_name": "addnode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
          "lines": "81-89",
          "snippet": "static void\naddnode(struct env *env, const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = createnode(key, value);\n\tRB_INSERT(envtree, &env->root, node);\n\tenv->count++;\n}",
          "includes": [
            "#include \"doas.h\"",
            "#include \"tree.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <err.h>",
            "#include <pwd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <sys/tree.h>",
            "#include <sys/types.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic void\naddnode(struct env *env, const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = createnode(key, value);\n\tRB_INSERT(envtree, &env->root, node);\n\tenv->count++;\n}"
        }
      },
      {
        "call_info": {
          "callee": "RB_INIT",
          "args": [
            "&env->root"
          ],
          "line": 101
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "err",
          "args": [
            "1",
            "NULL"
          ],
          "line": 100
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "sizeof(*env)"
          ],
          "line": 98
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic struct env *\ncreateenv(struct rule *rule, struct passwd *original, struct passwd *target)\n{\n\tstruct env *env;\n\tu_int i;\n\n\tenv = malloc(sizeof(*env));\n\tif (!env)\n\t\terr(1, NULL);\n\tRB_INIT(&env->root);\n\tenv->count = 0;\n\n        addnode(env, \"DOAS_USER\", original->pw_name);\n\taddnode(env, \"HOME\", target->pw_dir);\n\taddnode(env, \"LOGNAME\", target->pw_name);\n\taddnode(env, \"PATH\", GLOBAL_PATH); \n\taddnode(env, \"SHELL\", target->pw_shell);\n\taddnode(env, \"USER\", target->pw_name);\n\n\tif (rule->options & KEEPENV) {\n                #ifndef linux\n\t\textern const char **environ;\n                #endif\n\n\t\tfor (i = 0; environ[i] != NULL; i++) {\n\t\t\tstruct envnode *node;\n\t\t\tconst char *e, *eq;\n\t\t\tsize_t len;\n\t\t\tchar name[1024];\n\n\t\t\te = environ[i];\n\n\t\t\t/* ignore invalid or overlong names */\n\t\t\tif ((eq = strchr(e, '=')) == NULL || eq == e)\n\t\t\t\tcontinue;\n\t\t\tlen = eq - e;\n\t\t\tif (len > sizeof(name) - 1)\n\t\t\t\tcontinue;\n\t\t\tmemcpy(name, e, len);\n\t\t\tname[len] = '\\0';\n\n\t\t\tnode = createnode(name, eq + 1);\n\t\t\tif (RB_INSERT(envtree, &env->root, node)) {\n\t\t\t\t/* ignore any later duplicates */\n\t\t\t\tfreenode(node);\n\t\t\t} else {\n\t\t\t\tenv->count++;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn env;\n}"
  },
  {
    "function_name": "addnode",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
    "lines": "81-89",
    "snippet": "static void\naddnode(struct env *env, const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = createnode(key, value);\n\tRB_INSERT(envtree, &env->root, node);\n\tenv->count++;\n}",
    "includes": [
      "#include \"doas.h\"",
      "#include \"tree.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <err.h>",
      "#include <pwd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <sys/tree.h>",
      "#include <sys/types.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "RB_INSERT",
          "args": [
            "envtree",
            "&env->root",
            "node"
          ],
          "line": 87
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "createnode",
          "args": [
            "key",
            "value"
          ],
          "line": 86
        },
        "resolved": true,
        "details": {
          "function_name": "createnode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
          "lines": "58-71",
          "snippet": "static struct envnode *\ncreatenode(const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = malloc(sizeof(*node));\n\tif (!node)\n\t\terr(1, NULL);\n\tnode->key = strdup(key);\n\tnode->value = strdup(value);\n\tif (!node->key || !node->value)\n\t\terr(1, NULL);\n\treturn node;\n}",
          "includes": [
            "#include \"doas.h\"",
            "#include \"tree.h\"",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <err.h>",
            "#include <pwd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <sys/tree.h>",
            "#include <sys/types.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic struct envnode *\ncreatenode(const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = malloc(sizeof(*node));\n\tif (!node)\n\t\terr(1, NULL);\n\tnode->key = strdup(key);\n\tnode->value = strdup(value);\n\tif (!node->key || !node->value)\n\t\terr(1, NULL);\n\treturn node;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic void\naddnode(struct env *env, const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = createnode(key, value);\n\tRB_INSERT(envtree, &env->root, node);\n\tenv->count++;\n}"
  },
  {
    "function_name": "freenode",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
    "lines": "73-79",
    "snippet": "static void\nfreenode(struct envnode *node)\n{\n\tfree((char *)node->key);\n\tfree((char *)node->value);\n\tfree(node);\n}",
    "includes": [
      "#include \"doas.h\"",
      "#include \"tree.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <err.h>",
      "#include <pwd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <sys/tree.h>",
      "#include <sys/types.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "node"
          ],
          "line": 78
        },
        "resolved": true,
        "details": {
          "function_name": "freenode",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
          "lines": "73-79",
          "snippet": "static void\nfreenode(struct envnode *node)\n{\n\tfree((char *)node->key);\n\tfree((char *)node->value);\n\tfree(node);\n}",
          "note": "cyclic_reference_detected"
        }
      }
    ],
    "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic void\nfreenode(struct envnode *node)\n{\n\tfree((char *)node->key);\n\tfree((char *)node->value);\n\tfree(node);\n}"
  },
  {
    "function_name": "createnode",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
    "lines": "58-71",
    "snippet": "static struct envnode *\ncreatenode(const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = malloc(sizeof(*node));\n\tif (!node)\n\t\terr(1, NULL);\n\tnode->key = strdup(key);\n\tnode->value = strdup(value);\n\tif (!node->key || !node->value)\n\t\terr(1, NULL);\n\treturn node;\n}",
    "includes": [
      "#include \"doas.h\"",
      "#include \"tree.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <err.h>",
      "#include <pwd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <sys/tree.h>",
      "#include <sys/types.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "err",
          "args": [
            "1",
            "NULL"
          ],
          "line": 69
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "value"
          ],
          "line": 67
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "key"
          ],
          "line": 66
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "err",
          "args": [
            "1",
            "NULL"
          ],
          "line": 65
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "malloc",
          "args": [
            "sizeof(*node)"
          ],
          "line": 63
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nstatic struct envnode *\ncreatenode(const char *key, const char *value)\n{\n\tstruct envnode *node;\n\n\tnode = malloc(sizeof(*node));\n\tif (!node)\n\t\terr(1, NULL);\n\tnode->key = strdup(key);\n\tnode->value = strdup(value);\n\tif (!node->key || !node->value)\n\t\terr(1, NULL);\n\treturn node;\n}"
  },
  {
    "function_name": "envcmp",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-15900/repo/env.c",
    "lines": "48-52",
    "snippet": "int\nenvcmp(struct envnode *a, struct envnode *b)\n{\n\treturn strcmp(a->key, b->key);\n}",
    "includes": [
      "#include \"doas.h\"",
      "#include \"tree.h\"",
      "#include <errno.h>",
      "#include <unistd.h>",
      "#include <err.h>",
      "#include <pwd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <sys/tree.h>",
      "#include <sys/types.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "a->key",
            "b->key"
          ],
          "line": 51
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"doas.h\"\n#include \"tree.h\"\n#include <errno.h>\n#include <unistd.h>\n#include <err.h>\n#include <pwd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <sys/tree.h>\n#include <sys/types.h>\n\nint\nenvcmp(struct envnode *a, struct envnode *b)\n{\n\treturn strcmp(a->key, b->key);\n}"
  }
]