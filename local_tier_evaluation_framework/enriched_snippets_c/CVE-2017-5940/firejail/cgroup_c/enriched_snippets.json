[
  {
    "function_name": "set_cgroup",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-5940/repo/src/firejail/cgroup.c",
    "lines": "72-119",
    "snippet": "void set_cgroup(const char *path) {\n\tEUID_ASSERT();\n\t\n\tinvalid_filename(path);\n\t\n\t// path starts with /sys/fs/cgroup\n\tif (strncmp(path, \"/sys/fs/cgroup\", 14) != 0)\n\t\tgoto errout;\n\t\n\t// path ends in tasks\n\tchar *ptr = strstr(path, \"tasks\");\n\tif (!ptr)\n\t\tgoto errout;\n\tif (*(ptr + 5) != '\\0')\n\t\tgoto errout;\n\t\n\t// no .. traversal\n\tptr = strstr(path, \"..\");\n\tif (ptr)\n\t\tgoto errout;\n\t\n\t// tasks file exists\n\tstruct stat s;\n\tif (stat(path, &s) == -1)\n\t\tgoto errout;\n\t\n\t// task file belongs to the user running the sandbox\n\tif (s.st_uid != getuid() && s.st_gid != getgid())\n\t\tgoto errout2;\n\t\t\n\t// add the task to cgroup\n\t/* coverity[toctou] */\n\tFILE *fp = fopen(path,\t\"a\");\n\tif (!fp)\n\t\tgoto errout;\n\tpid_t pid = getpid();\n\tint rv = fprintf(fp, \"%d\\n\", pid);\n\t(void) rv;\n\tfclose(fp);\n\treturn;\n\nerrout:\t\t\n\tfprintf(stderr, \"Error: invalid cgroup\\n\");\n\texit(1);\nerrout2:\t\t\n\tfprintf(stderr, \"Error: you don't have permissions to use this control group\\n\");\n\texit(1);\n}",
    "includes": [
      "#include <sys/stat.h>",
      "#include \"firejail.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "exit",
          "args": [
            "1"
          ],
          "line": 118
        },
        "resolved": true,
        "details": {
          "function_name": "myexit",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-5940/repo/src/firejail/main.c",
          "lines": "137-149",
          "snippet": "static void myexit(int rv) {\n\tlogmsg(\"exiting...\");\n\tif (!arg_command && !arg_quiet)\n\t\tprintf(\"\\nParent is shutting down, bye...\\n\");\n\n\n\t// delete sandbox files in shared memory\n\tEUID_ROOT();\n\tclear_run_files(sandbox_pid);\n\tappimage_clear();\n\tflush_stdin();\n\texit(rv); \n}",
          "includes": [
            "#include <sys/times.h>",
            "#include <sys/utsname.h>",
            "#include <net/if.h>",
            "#include <time.h>",
            "#include <signal.h>",
            "#include <sys/prctl.h>",
            "#include <sys/file.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include <pwd.h>",
            "#include <dirent.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/wait.h>",
            "#include <sys/mount.h>",
            "#include <sched.h>",
            "#include <sys/utsname.h>",
            "#include \"../include/pid.h\"",
            "#include \"firejail.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "int arg_command = 0;",
            "int arg_quiet = 0;",
            "pid_t sandbox_pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/times.h>\n#include <sys/utsname.h>\n#include <net/if.h>\n#include <time.h>\n#include <signal.h>\n#include <sys/prctl.h>\n#include <sys/file.h>\n#include <limits.h>\n#include <errno.h>\n#include <pwd.h>\n#include <dirent.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/wait.h>\n#include <sys/mount.h>\n#include <sched.h>\n#include <sys/utsname.h>\n#include \"../include/pid.h\"\n#include \"firejail.h\"\n\nint arg_command = 0;\nint arg_quiet = 0;\npid_t sandbox_pid;\n\nstatic void myexit(int rv) {\n\tlogmsg(\"exiting...\");\n\tif (!arg_command && !arg_quiet)\n\t\tprintf(\"\\nParent is shutting down, bye...\\n\");\n\n\n\t// delete sandbox files in shared memory\n\tEUID_ROOT();\n\tclear_run_files(sandbox_pid);\n\tappimage_clear();\n\tflush_stdin();\n\texit(rv); \n}"
        }
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "stderr",
            "\"Error: you don't have permissions to use this control group\\n\""
          ],
          "line": 117
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "stderr",
            "\"Error: invalid cgroup\\n\""
          ],
          "line": 114
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fclose",
          "args": [
            "fp"
          ],
          "line": 110
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "fp",
            "\"%d\\n\"",
            "pid"
          ],
          "line": 108
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getpid",
          "args": [],
          "line": 107
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fopen",
          "args": [
            "path",
            "\"a\""
          ],
          "line": 104
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getgid",
          "args": [],
          "line": 99
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getuid",
          "args": [],
          "line": 99
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stat",
          "args": [
            "path",
            "&s"
          ],
          "line": 95
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strstr",
          "args": [
            "path",
            "\"..\""
          ],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strstr",
          "args": [
            "path",
            "\"tasks\""
          ],
          "line": 82
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strncmp",
          "args": [
            "path",
            "\"/sys/fs/cgroup\"",
            "14"
          ],
          "line": 78
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "invalid_filename",
          "args": [
            "path"
          ],
          "line": 75
        },
        "resolved": true,
        "details": {
          "function_name": "invalid_filename",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-5940/repo/src/firejail/util.c",
          "lines": "668-689",
          "snippet": "void invalid_filename(const char *fname) {\n\tEUID_ASSERT();\n\tassert(fname);\n\tconst char *ptr = fname;\n\n\tif (arg_debug_check_filename)\n\t\tprintf(\"Checking filename %s\\n\", fname);\n\n\tif (strncmp(ptr, \"${HOME}\", 7) == 0)\n\t\tptr = fname + 7;\n\telse if (strncmp(ptr, \"${PATH}\", 7) == 0)\n\t\tptr = fname + 7;\n\telse if (strcmp(fname, \"${DOWNLOADS}\") == 0)\n\t\treturn;\n\n\tint len = strlen(ptr);\n\t// file globbing ('*') is allowed\n\tif (strcspn(ptr, \"\\\\&!?\\\"'<>%^(){}[];,\") != (size_t)len) {\n\t\tfprintf(stderr, \"Error: \\\"%s\\\" is an invalid filename\\n\", ptr);\n\t\texit(1);\n\t}\n}",
          "includes": [
            "#include <sys/wait.h>",
            "#include <termios.h>",
            "#include <sys/ioctl.h>",
            "#include <grp.h>",
            "#include <dirent.h>",
            "#include <errno.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <ftw.h>",
            "#include \"firejail.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/wait.h>\n#include <termios.h>\n#include <sys/ioctl.h>\n#include <grp.h>\n#include <dirent.h>\n#include <errno.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <ftw.h>\n#include \"firejail.h\"\n\nvoid invalid_filename(const char *fname) {\n\tEUID_ASSERT();\n\tassert(fname);\n\tconst char *ptr = fname;\n\n\tif (arg_debug_check_filename)\n\t\tprintf(\"Checking filename %s\\n\", fname);\n\n\tif (strncmp(ptr, \"${HOME}\", 7) == 0)\n\t\tptr = fname + 7;\n\telse if (strncmp(ptr, \"${PATH}\", 7) == 0)\n\t\tptr = fname + 7;\n\telse if (strcmp(fname, \"${DOWNLOADS}\") == 0)\n\t\treturn;\n\n\tint len = strlen(ptr);\n\t// file globbing ('*') is allowed\n\tif (strcspn(ptr, \"\\\\&!?\\\"'<>%^(){}[];,\") != (size_t)len) {\n\t\tfprintf(stderr, \"Error: \\\"%s\\\" is an invalid filename\\n\", ptr);\n\t\texit(1);\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "EUID_ASSERT",
          "args": [],
          "line": 73
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/stat.h>\n#include \"firejail.h\"\n\nvoid set_cgroup(const char *path) {\n\tEUID_ASSERT();\n\t\n\tinvalid_filename(path);\n\t\n\t// path starts with /sys/fs/cgroup\n\tif (strncmp(path, \"/sys/fs/cgroup\", 14) != 0)\n\t\tgoto errout;\n\t\n\t// path ends in tasks\n\tchar *ptr = strstr(path, \"tasks\");\n\tif (!ptr)\n\t\tgoto errout;\n\tif (*(ptr + 5) != '\\0')\n\t\tgoto errout;\n\t\n\t// no .. traversal\n\tptr = strstr(path, \"..\");\n\tif (ptr)\n\t\tgoto errout;\n\t\n\t// tasks file exists\n\tstruct stat s;\n\tif (stat(path, &s) == -1)\n\t\tgoto errout;\n\t\n\t// task file belongs to the user running the sandbox\n\tif (s.st_uid != getuid() && s.st_gid != getgid())\n\t\tgoto errout2;\n\t\t\n\t// add the task to cgroup\n\t/* coverity[toctou] */\n\tFILE *fp = fopen(path,\t\"a\");\n\tif (!fp)\n\t\tgoto errout;\n\tpid_t pid = getpid();\n\tint rv = fprintf(fp, \"%d\\n\", pid);\n\t(void) rv;\n\tfclose(fp);\n\treturn;\n\nerrout:\t\t\n\tfprintf(stderr, \"Error: invalid cgroup\\n\");\n\texit(1);\nerrout2:\t\t\n\tfprintf(stderr, \"Error: you don't have permissions to use this control group\\n\");\n\texit(1);\n}"
  },
  {
    "function_name": "load_cgroup",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-5940/repo/src/firejail/cgroup.c",
    "lines": "47-69",
    "snippet": "void load_cgroup(const char *fname) {\n\tif (!fname)\n\t\treturn;\n\n\tFILE *fp = fopen(fname, \"r\");\n\tif (fp) {\n\t\tchar buf[MAXBUF];\n\t\tif (fgets(buf, MAXBUF, fp)) {\n\t\t\tcfg.cgroup = strdup(buf);\n\t\t\tif (!cfg.cgroup)\n\t\t\t\terrExit(\"strdup\");\n\t\t}\n\t\telse\n\t\t\tgoto errout;\n\t\t\n\t\tfclose(fp);\n\t\treturn;\n\t}\nerrout:\n\tfprintf(stderr, \"Warning: cannot load control group\\n\");\n\tif (fp)\n\t\tfclose(fp);\n}",
    "includes": [
      "#include <sys/stat.h>",
      "#include \"firejail.h\""
    ],
    "macros_used": [
      "#define MAXBUF 4096"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "fclose",
          "args": [
            "fp"
          ],
          "line": 68
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "stderr",
            "\"Warning: cannot load control group\\n\""
          ],
          "line": 66
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fclose",
          "args": [
            "fp"
          ],
          "line": 62
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "errExit",
          "args": [
            "\"strdup\""
          ],
          "line": 57
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "buf"
          ],
          "line": 55
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fgets",
          "args": [
            "buf",
            "MAXBUF",
            "fp"
          ],
          "line": 54
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fopen",
          "args": [
            "fname",
            "\"r\""
          ],
          "line": 51
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/stat.h>\n#include \"firejail.h\"\n\n#define MAXBUF 4096\n\nvoid load_cgroup(const char *fname) {\n\tif (!fname)\n\t\treturn;\n\n\tFILE *fp = fopen(fname, \"r\");\n\tif (fp) {\n\t\tchar buf[MAXBUF];\n\t\tif (fgets(buf, MAXBUF, fp)) {\n\t\t\tcfg.cgroup = strdup(buf);\n\t\t\tif (!cfg.cgroup)\n\t\t\t\terrExit(\"strdup\");\n\t\t}\n\t\telse\n\t\t\tgoto errout;\n\t\t\n\t\tfclose(fp);\n\t\treturn;\n\t}\nerrout:\n\tfprintf(stderr, \"Warning: cannot load control group\\n\");\n\tif (fp)\n\t\tfclose(fp);\n}"
  },
  {
    "function_name": "save_cgroup",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-5940/repo/src/firejail/cgroup.c",
    "lines": "25-45",
    "snippet": "void save_cgroup(void) {\n\tif (cfg.cgroup == NULL)\n\t\treturn;\n\t\n\tFILE *fp = fopen(RUN_CGROUP_CFG, \"w\");\n\tif (fp) {\n\t\tfprintf(fp, \"%s\", cfg.cgroup);\n\t\tfflush(0);\n\t\tSET_PERMS_STREAM(fp, 0, 0, 0644);\n\t\tif (fclose(fp))\n\t\t\tgoto errout;\n\t}\n\telse\n\t\tgoto errout;\n\t\n\treturn;\n\nerrout:\n\tfprintf(stderr, \"Error: cannot save cgroup\\n\");\n\texit(1);\n}",
    "includes": [
      "#include <sys/stat.h>",
      "#include \"firejail.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "exit",
          "args": [
            "1"
          ],
          "line": 44
        },
        "resolved": true,
        "details": {
          "function_name": "myexit",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-5940/repo/src/firejail/main.c",
          "lines": "137-149",
          "snippet": "static void myexit(int rv) {\n\tlogmsg(\"exiting...\");\n\tif (!arg_command && !arg_quiet)\n\t\tprintf(\"\\nParent is shutting down, bye...\\n\");\n\n\n\t// delete sandbox files in shared memory\n\tEUID_ROOT();\n\tclear_run_files(sandbox_pid);\n\tappimage_clear();\n\tflush_stdin();\n\texit(rv); \n}",
          "includes": [
            "#include <sys/times.h>",
            "#include <sys/utsname.h>",
            "#include <net/if.h>",
            "#include <time.h>",
            "#include <signal.h>",
            "#include <sys/prctl.h>",
            "#include <sys/file.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include <pwd.h>",
            "#include <dirent.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/wait.h>",
            "#include <sys/mount.h>",
            "#include <sched.h>",
            "#include <sys/utsname.h>",
            "#include \"../include/pid.h\"",
            "#include \"firejail.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "int arg_command = 0;",
            "int arg_quiet = 0;",
            "pid_t sandbox_pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/times.h>\n#include <sys/utsname.h>\n#include <net/if.h>\n#include <time.h>\n#include <signal.h>\n#include <sys/prctl.h>\n#include <sys/file.h>\n#include <limits.h>\n#include <errno.h>\n#include <pwd.h>\n#include <dirent.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/wait.h>\n#include <sys/mount.h>\n#include <sched.h>\n#include <sys/utsname.h>\n#include \"../include/pid.h\"\n#include \"firejail.h\"\n\nint arg_command = 0;\nint arg_quiet = 0;\npid_t sandbox_pid;\n\nstatic void myexit(int rv) {\n\tlogmsg(\"exiting...\");\n\tif (!arg_command && !arg_quiet)\n\t\tprintf(\"\\nParent is shutting down, bye...\\n\");\n\n\n\t// delete sandbox files in shared memory\n\tEUID_ROOT();\n\tclear_run_files(sandbox_pid);\n\tappimage_clear();\n\tflush_stdin();\n\texit(rv); \n}"
        }
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "stderr",
            "\"Error: cannot save cgroup\\n\""
          ],
          "line": 43
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fclose",
          "args": [
            "fp"
          ],
          "line": 34
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "SET_PERMS_STREAM",
          "args": [
            "fp",
            "0",
            "0",
            "0644"
          ],
          "line": 33
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fflush",
          "args": [
            "0"
          ],
          "line": 32
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "fp",
            "\"%s\"",
            "cfg.cgroup"
          ],
          "line": 31
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fopen",
          "args": [
            "RUN_CGROUP_CFG",
            "\"w\""
          ],
          "line": 29
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/stat.h>\n#include \"firejail.h\"\n\nvoid save_cgroup(void) {\n\tif (cfg.cgroup == NULL)\n\t\treturn;\n\t\n\tFILE *fp = fopen(RUN_CGROUP_CFG, \"w\");\n\tif (fp) {\n\t\tfprintf(fp, \"%s\", cfg.cgroup);\n\t\tfflush(0);\n\t\tSET_PERMS_STREAM(fp, 0, 0, 0644);\n\t\tif (fclose(fp))\n\t\t\tgoto errout;\n\t}\n\telse\n\t\tgoto errout;\n\t\n\treturn;\n\nerrout:\n\tfprintf(stderr, \"Error: cannot save cgroup\\n\");\n\texit(1);\n}"
  }
]