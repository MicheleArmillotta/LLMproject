[
  {
    "function_name": "run_symlink",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-5940/repo/src/firejail/run_symlink.c",
    "lines": "25-113",
    "snippet": "void run_symlink(int argc, char **argv) {\n\tEUID_ASSERT();\n\t\n\tchar *program = strrchr(argv[0], '/');\n\tif (program)\n\t\tprogram += 1;\n\telse\n\t\tprogram = argv[0];\n\tif (strcmp(program, \"firejail\") == 0)\n\t\treturn;\n\n\t// find the real program\n\t// probably the first entry returend by \"which -a\" is a symlink - use the second entry!\n\tchar *p = getenv(\"PATH\");\n\tif (!p) {\n\t\tfprintf(stderr, \"Error: PATH environment variable not set\\n\");\n\t\texit(1);\n\t}\n\t\n\tchar *path = strdup(p);\n\tif (!path)\n\t\terrExit(\"strdup\");\n\n\tchar *selfpath = realpath(\"/proc/self/exe\", NULL);\n\tif (!selfpath)\n\t\terrExit(\"realpath\");\n\n\t// look in path for our program\n\tchar *tok = strtok(path, \":\");\n\tint found = 0;\n\twhile (tok) {\n\t\tchar *name;\n\t\tif (asprintf(&name, \"%s/%s\", tok, program) == -1)\n\t\t\terrExit(\"asprintf\");\n\n\t\tstruct stat s;\n\t\tif (stat(name, &s) == 0) {\n\t\t\tchar* rp = realpath(name, NULL);\n\t\t\tif (!rp)\n\t\t\t\terrExit(\"realpath\");\n\n\t\t\tif (strcmp(selfpath, rp) != 0) {\n\t\t\t\tprogram = strdup(name);\n\t\t\t\tfound = 1;\n\t\t\t\tfree(rp);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tfree(rp);\n\t\t}\n\n\t\tfree(name);\n\t\ttok = strtok(NULL, \":\");\n\t}\n\tif (!found) {\n\t\tfprintf(stderr, \"Error: cannot find the program in the path\\n\");\n\t\texit(1);\n\t}\n\n\tfree(selfpath);\n\n\n\t// start the argv[0] program in a new sandbox\n\tchar *firejail;\n\tif (asprintf(&firejail, \"%s/bin/firejail\", PREFIX) == -1)\n\t\terrExit(\"asprintf\");\n\n\tprintf(\"Redirecting symlink to %s\\n\", program);\n\n\t// drop privileges\n\tif (setgid(getgid()) < 0)\n\t\terrExit(\"setgid/getgid\");\n\tif (setuid(getuid()) < 0)\n\t\terrExit(\"setuid/getuid\");\n\n\t// run command\n\tchar *a[3 + argc];\n\ta[0] = firejail;\n\ta[1] = program;\n\tint i;\n\tfor (i = 0; i < (argc - 1); i++) {\n\t\ta[i + 2] = argv[i + 1];\n\t}\n\ta[i + 2] = NULL;\n\texecvp(a[0], a); \n\n\tperror(\"execvp\");\n\texit(1);\n}",
    "includes": [
      "#include <unistd.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include \"firejail.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "exit",
          "args": [
            "1"
          ],
          "line": 112
        },
        "resolved": true,
        "details": {
          "function_name": "myexit",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-5940/repo/src/firejail/main.c",
          "lines": "137-149",
          "snippet": "static void myexit(int rv) {\n\tlogmsg(\"exiting...\");\n\tif (!arg_command && !arg_quiet)\n\t\tprintf(\"\\nParent is shutting down, bye...\\n\");\n\n\n\t// delete sandbox files in shared memory\n\tEUID_ROOT();\n\tclear_run_files(sandbox_pid);\n\tappimage_clear();\n\tflush_stdin();\n\texit(rv); \n}",
          "includes": [
            "#include <sys/times.h>",
            "#include <sys/utsname.h>",
            "#include <net/if.h>",
            "#include <time.h>",
            "#include <signal.h>",
            "#include <sys/prctl.h>",
            "#include <sys/file.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include <pwd.h>",
            "#include <dirent.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/wait.h>",
            "#include <sys/mount.h>",
            "#include <sched.h>",
            "#include <sys/utsname.h>",
            "#include \"../include/pid.h\"",
            "#include \"firejail.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "int arg_command = 0;",
            "int arg_quiet = 0;",
            "pid_t sandbox_pid;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <sys/times.h>\n#include <sys/utsname.h>\n#include <net/if.h>\n#include <time.h>\n#include <signal.h>\n#include <sys/prctl.h>\n#include <sys/file.h>\n#include <limits.h>\n#include <errno.h>\n#include <pwd.h>\n#include <dirent.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/wait.h>\n#include <sys/mount.h>\n#include <sched.h>\n#include <sys/utsname.h>\n#include \"../include/pid.h\"\n#include \"firejail.h\"\n\nint arg_command = 0;\nint arg_quiet = 0;\npid_t sandbox_pid;\n\nstatic void myexit(int rv) {\n\tlogmsg(\"exiting...\");\n\tif (!arg_command && !arg_quiet)\n\t\tprintf(\"\\nParent is shutting down, bye...\\n\");\n\n\n\t// delete sandbox files in shared memory\n\tEUID_ROOT();\n\tclear_run_files(sandbox_pid);\n\tappimage_clear();\n\tflush_stdin();\n\texit(rv); \n}"
        }
      },
      {
        "call_info": {
          "callee": "perror",
          "args": [
            "\"execvp\""
          ],
          "line": 111
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "execvp",
          "args": [
            "a[0]",
            "a"
          ],
          "line": 109
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "errExit",
          "args": [
            "\"setuid/getuid\""
          ],
          "line": 98
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setuid",
          "args": [
            "getuid()"
          ],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getuid",
          "args": [],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "errExit",
          "args": [
            "\"setgid/getgid\""
          ],
          "line": 96
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setgid",
          "args": [
            "getgid()"
          ],
          "line": 95
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getgid",
          "args": [],
          "line": 95
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "printf",
          "args": [
            "\"Redirecting symlink to %s\\n\"",
            "program"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "errExit",
          "args": [
            "\"asprintf\""
          ],
          "line": 90
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "asprintf",
          "args": [
            "&firejail",
            "\"%s/bin/firejail\"",
            "PREFIX"
          ],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "selfpath"
          ],
          "line": 84
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "stderr",
            "\"Error: cannot find the program in the path\\n\""
          ],
          "line": 80
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strtok",
          "args": [
            "NULL",
            "\":\""
          ],
          "line": 77
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "name"
          ],
          "line": 76
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "rp"
          ],
          "line": 73
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "rp"
          ],
          "line": 69
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "name"
          ],
          "line": 67
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "selfpath",
            "rp"
          ],
          "line": 66
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "errExit",
          "args": [
            "\"realpath\""
          ],
          "line": 64
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "realpath",
          "args": [
            "name",
            "NULL"
          ],
          "line": 62
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "stat",
          "args": [
            "name",
            "&s"
          ],
          "line": 61
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "errExit",
          "args": [
            "\"asprintf\""
          ],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "asprintf",
          "args": [
            "&name",
            "\"%s/%s\"",
            "tok",
            "program"
          ],
          "line": 57
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strtok",
          "args": [
            "path",
            "\":\""
          ],
          "line": 53
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "errExit",
          "args": [
            "\"realpath\""
          ],
          "line": 50
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "realpath",
          "args": [
            "\"/proc/self/exe\"",
            "NULL"
          ],
          "line": 48
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "errExit",
          "args": [
            "\"strdup\""
          ],
          "line": 46
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "p"
          ],
          "line": 44
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "stderr",
            "\"Error: PATH environment variable not set\\n\""
          ],
          "line": 40
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getenv",
          "args": [
            "\"PATH\""
          ],
          "line": 38
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "program",
            "\"firejail\""
          ],
          "line": 33
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strrchr",
          "args": [
            "argv[0]",
            "'/'"
          ],
          "line": 28
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "EUID_ASSERT",
          "args": [],
          "line": 26
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include \"firejail.h\"\n\nvoid run_symlink(int argc, char **argv) {\n\tEUID_ASSERT();\n\t\n\tchar *program = strrchr(argv[0], '/');\n\tif (program)\n\t\tprogram += 1;\n\telse\n\t\tprogram = argv[0];\n\tif (strcmp(program, \"firejail\") == 0)\n\t\treturn;\n\n\t// find the real program\n\t// probably the first entry returend by \"which -a\" is a symlink - use the second entry!\n\tchar *p = getenv(\"PATH\");\n\tif (!p) {\n\t\tfprintf(stderr, \"Error: PATH environment variable not set\\n\");\n\t\texit(1);\n\t}\n\t\n\tchar *path = strdup(p);\n\tif (!path)\n\t\terrExit(\"strdup\");\n\n\tchar *selfpath = realpath(\"/proc/self/exe\", NULL);\n\tif (!selfpath)\n\t\terrExit(\"realpath\");\n\n\t// look in path for our program\n\tchar *tok = strtok(path, \":\");\n\tint found = 0;\n\twhile (tok) {\n\t\tchar *name;\n\t\tif (asprintf(&name, \"%s/%s\", tok, program) == -1)\n\t\t\terrExit(\"asprintf\");\n\n\t\tstruct stat s;\n\t\tif (stat(name, &s) == 0) {\n\t\t\tchar* rp = realpath(name, NULL);\n\t\t\tif (!rp)\n\t\t\t\terrExit(\"realpath\");\n\n\t\t\tif (strcmp(selfpath, rp) != 0) {\n\t\t\t\tprogram = strdup(name);\n\t\t\t\tfound = 1;\n\t\t\t\tfree(rp);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tfree(rp);\n\t\t}\n\n\t\tfree(name);\n\t\ttok = strtok(NULL, \":\");\n\t}\n\tif (!found) {\n\t\tfprintf(stderr, \"Error: cannot find the program in the path\\n\");\n\t\texit(1);\n\t}\n\n\tfree(selfpath);\n\n\n\t// start the argv[0] program in a new sandbox\n\tchar *firejail;\n\tif (asprintf(&firejail, \"%s/bin/firejail\", PREFIX) == -1)\n\t\terrExit(\"asprintf\");\n\n\tprintf(\"Redirecting symlink to %s\\n\", program);\n\n\t// drop privileges\n\tif (setgid(getgid()) < 0)\n\t\terrExit(\"setgid/getgid\");\n\tif (setuid(getuid()) < 0)\n\t\terrExit(\"setuid/getuid\");\n\n\t// run command\n\tchar *a[3 + argc];\n\ta[0] = firejail;\n\ta[1] = program;\n\tint i;\n\tfor (i = 0; i < (argc - 1); i++) {\n\t\ta[i + 2] = argv[i + 1];\n\t}\n\ta[i + 2] = NULL;\n\texecvp(a[0], a); \n\n\tperror(\"execvp\");\n\texit(1);\n}"
  }
]