[
  {
    "function_name": "rodata_test",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-18397/repo/mm/rodata_test.c",
    "lines": "19-57",
    "snippet": "void rodata_test(void)\n{\n\tunsigned long start, end;\n\tint zero = 0;\n\n\t/* test 1: read the value */\n\t/* If this test fails, some previous testrun has clobbered the state */\n\tif (!rodata_test_data) {\n\t\tpr_err(\"test 1 fails (start data)\\n\");\n\t\treturn;\n\t}\n\n\t/* test 2: write to the variable; this should fault */\n\tif (!probe_kernel_write((void *)&rodata_test_data,\n\t\t\t\t(void *)&zero, sizeof(zero))) {\n\t\tpr_err(\"test data was not read only\\n\");\n\t\treturn;\n\t}\n\n\t/* test 3: check the value hasn't changed */\n\tif (rodata_test_data == zero) {\n\t\tpr_err(\"test data was changed\\n\");\n\t\treturn;\n\t}\n\n\t/* test 4: check if the rodata section is PAGE_SIZE aligned */\n\tstart = (unsigned long)__start_rodata;\n\tend = (unsigned long)__end_rodata;\n\tif (start & (PAGE_SIZE - 1)) {\n\t\tpr_err(\"start of .rodata is not page size aligned\\n\");\n\t\treturn;\n\t}\n\tif (end & (PAGE_SIZE - 1)) {\n\t\tpr_err(\"end of .rodata is not page size aligned\\n\");\n\t\treturn;\n\t}\n\n\tpr_info(\"all tests were successful\\n\");\n}",
    "includes": [
      "#include <asm/sections.h>",
      "#include <linux/uaccess.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static const int rodata_test_data = 0xC3;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "pr_info",
          "args": [
            "\"all tests were successful\\n\""
          ],
          "line": 56
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pr_err",
          "args": [
            "\"end of .rodata is not page size aligned\\n\""
          ],
          "line": 52
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pr_err",
          "args": [
            "\"start of .rodata is not page size aligned\\n\""
          ],
          "line": 48
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pr_err",
          "args": [
            "\"test data was changed\\n\""
          ],
          "line": 40
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pr_err",
          "args": [
            "\"test data was not read only\\n\""
          ],
          "line": 34
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "probe_kernel_write",
          "args": [
            "(void *)&rodata_test_data",
            "(void *)&zero",
            "sizeof(zero)"
          ],
          "line": 32
        },
        "resolved": true,
        "details": {
          "function_name": "__probe_kernel_write",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-18397/repo/mm/maccess.c",
          "lines": "56-70",
          "snippet": "long __probe_kernel_write(void *dst, const void *src, size_t size)\n{\n\tlong ret;\n\tmm_segment_t old_fs = get_fs();\n\n\tset_fs(KERNEL_DS);\n\tpagefault_disable();\n\tcurrent->kernel_uaccess_faults_ok++;\n\tret = __copy_to_user_inatomic((__force void __user *)dst, src, size);\n\tcurrent->kernel_uaccess_faults_ok--;\n\tpagefault_enable();\n\tset_fs(old_fs);\n\n\treturn ret ? -EFAULT : 0;\n}",
          "includes": [
            "#include <linux/uaccess.h>",
            "#include <linux/mm.h>",
            "#include <linux/export.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "long __weak probe_kernel_write(void *dst, const void *src, size_t size)\n    __attribute__((alias(\"__probe_kernel_write\")));"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <linux/uaccess.h>\n#include <linux/mm.h>\n#include <linux/export.h>\n\nlong __weak probe_kernel_write(void *dst, const void *src, size_t size)\n    __attribute__((alias(\"__probe_kernel_write\")));\n\nlong __probe_kernel_write(void *dst, const void *src, size_t size)\n{\n\tlong ret;\n\tmm_segment_t old_fs = get_fs();\n\n\tset_fs(KERNEL_DS);\n\tpagefault_disable();\n\tcurrent->kernel_uaccess_faults_ok++;\n\tret = __copy_to_user_inatomic((__force void __user *)dst, src, size);\n\tcurrent->kernel_uaccess_faults_ok--;\n\tpagefault_enable();\n\tset_fs(old_fs);\n\n\treturn ret ? -EFAULT : 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pr_err",
          "args": [
            "\"test 1 fails (start data)\\n\""
          ],
          "line": 27
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <asm/sections.h>\n#include <linux/uaccess.h>\n\nstatic const int rodata_test_data = 0xC3;\n\nvoid rodata_test(void)\n{\n\tunsigned long start, end;\n\tint zero = 0;\n\n\t/* test 1: read the value */\n\t/* If this test fails, some previous testrun has clobbered the state */\n\tif (!rodata_test_data) {\n\t\tpr_err(\"test 1 fails (start data)\\n\");\n\t\treturn;\n\t}\n\n\t/* test 2: write to the variable; this should fault */\n\tif (!probe_kernel_write((void *)&rodata_test_data,\n\t\t\t\t(void *)&zero, sizeof(zero))) {\n\t\tpr_err(\"test data was not read only\\n\");\n\t\treturn;\n\t}\n\n\t/* test 3: check the value hasn't changed */\n\tif (rodata_test_data == zero) {\n\t\tpr_err(\"test data was changed\\n\");\n\t\treturn;\n\t}\n\n\t/* test 4: check if the rodata section is PAGE_SIZE aligned */\n\tstart = (unsigned long)__start_rodata;\n\tend = (unsigned long)__end_rodata;\n\tif (start & (PAGE_SIZE - 1)) {\n\t\tpr_err(\"start of .rodata is not page size aligned\\n\");\n\t\treturn;\n\t}\n\tif (end & (PAGE_SIZE - 1)) {\n\t\tpr_err(\"end of .rodata is not page size aligned\\n\");\n\t\treturn;\n\t}\n\n\tpr_info(\"all tests were successful\\n\");\n}"
  }
]