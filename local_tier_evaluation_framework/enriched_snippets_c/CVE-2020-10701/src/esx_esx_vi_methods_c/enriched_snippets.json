[
  {
    "function_name": "esxVI_RetrieveServiceContent",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/esx/esx_vi_methods.c",
    "lines": "213-243",
    "snippet": "int\nesxVI_RetrieveServiceContent(esxVI_Context *ctx,\n                             esxVI_ServiceContent **serviceContent)\n{\n    int result = -1;\n    const char *request = ESX_VI__SOAP__REQUEST_HEADER\n                            \"<RetrieveServiceContent xmlns=\\\"urn:vim25\\\">\"\n                              \"<_this xmlns=\\\"urn:vim25\\\" \"\n                                     \"xsi:type=\\\"ManagedObjectReference\\\" \"\n                                     \"type=\\\"ServiceInstance\\\">\"\n                                \"ServiceInstance\"\n                              \"</_this>\"\n                            \"</RetrieveServiceContent>\"\n                          ESX_VI__SOAP__REQUEST_FOOTER;\n    esxVI_Response *response = NULL;\n\n    ESX_VI_CHECK_ARG_LIST(serviceContent);\n\n    if (esxVI_Context_Execute(ctx, \"RetrieveServiceContent\", request,\n                              &response, esxVI_Occurrence_RequiredItem) < 0 ||\n        esxVI_ServiceContent_Deserialize(response->node, serviceContent) < 0) {\n        goto cleanup;\n    }\n\n    result = 0;\n\n cleanup:\n    esxVI_Response_Free(&response);\n\n    return result;\n}",
    "includes": [
      "#include \"esx_vi_methods.generated.c\"",
      "#include \"esx_vi_methods.generated.macro\"",
      "#include \"esx_util.h\"",
      "#include \"esx_vi_methods.h\"",
      "#include \"viruuid.h\"",
      "#include \"viralloc.h\"",
      "#include \"virbuffer.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "esxVI_Response_Free",
          "args": [
            "&response"
          ],
          "line": 240
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "esxVI_ServiceContent_Deserialize",
          "args": [
            "response->node",
            "serviceContent"
          ],
          "line": 233
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "esxVI_Context_Execute",
          "args": [
            "ctx",
            "\"RetrieveServiceContent\"",
            "request",
            "&response",
            "esxVI_Occurrence_RequiredItem"
          ],
          "line": 231
        },
        "resolved": true,
        "details": {
          "function_name": "esxVI_Context_Execute",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/esx/esx_vi.c",
          "lines": "1245-1420",
          "snippet": "int\nesxVI_Context_Execute(esxVI_Context *ctx, const char *methodName,\n                      const char *request, esxVI_Response **response,\n                      esxVI_Occurrence occurrence)\n{\n    int result = -1;\n    virBuffer buffer = VIR_BUFFER_INITIALIZER;\n    esxVI_Fault *fault = NULL;\n    char *xpathExpression = NULL;\n    xmlXPathContextPtr xpathContext = NULL;\n    xmlNodePtr responseNode = NULL;\n\n    if (!request || !response || *response) {\n        virReportError(VIR_ERR_INTERNAL_ERROR, \"%s\", _(\"Invalid argument\"));\n        return -1;\n    }\n\n    if (esxVI_Response_Alloc(response) < 0)\n        return -1;\n\n    virMutexLock(&ctx->curl->lock);\n\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_URL, ctx->url);\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_RANGE, NULL);\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_WRITEDATA, &buffer);\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_UPLOAD, 0);\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_POSTFIELDS, request);\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_POSTFIELDSIZE, strlen(request));\n\n    (*response)->responseCode = esxVI_CURL_Perform(ctx->curl, ctx->url);\n\n    virMutexUnlock(&ctx->curl->lock);\n\n    if ((*response)->responseCode < 0)\n        goto cleanup;\n\n    (*response)->content = virBufferContentAndReset(&buffer);\n\n    if ((*response)->responseCode == 500 || (*response)->responseCode == 200) {\n        (*response)->document = virXMLParseStringCtxt((*response)->content,\n                                                      _(\"(esx execute response)\"),\n                                                      &xpathContext);\n\n        if (!(*response)->document)\n            goto cleanup;\n\n        xmlXPathRegisterNs(xpathContext, BAD_CAST \"soapenv\",\n                           BAD_CAST \"http://schemas.xmlsoap.org/soap/envelope/\");\n        xmlXPathRegisterNs(xpathContext, BAD_CAST \"vim\", BAD_CAST \"urn:vim25\");\n\n        if ((*response)->responseCode == 500) {\n            (*response)->node =\n              virXPathNode(\"/soapenv:Envelope/soapenv:Body/soapenv:Fault\",\n                           xpathContext);\n\n            if (!(*response)->node) {\n                virReportError(VIR_ERR_INTERNAL_ERROR,\n                               _(\"HTTP response code %d for call to '%s'. \"\n                                 \"Fault is unknown, XPath evaluation failed\"),\n                               (*response)->responseCode, methodName);\n                goto cleanup;\n            }\n\n            if (esxVI_Fault_Deserialize((*response)->node, &fault) < 0) {\n                virReportError(VIR_ERR_INTERNAL_ERROR,\n                               _(\"HTTP response code %d for call to '%s'. \"\n                                 \"Fault is unknown, deserialization failed\"),\n                               (*response)->responseCode, methodName);\n                goto cleanup;\n            }\n\n            virReportError(VIR_ERR_INTERNAL_ERROR,\n                           _(\"HTTP response code %d for call to '%s'. \"\n                             \"Fault: %s - %s\"), (*response)->responseCode,\n                           methodName, fault->faultcode, fault->faultstring);\n\n            /* FIXME: Dump raw response until detail part gets deserialized */\n            VIR_DEBUG(\"HTTP response code %d for call to '%s' [[[[%s]]]]\",\n                      (*response)->responseCode, methodName,\n                      (*response)->content);\n\n            goto cleanup;\n        } else {\n            xpathExpression = g_strdup_printf(\"/soapenv:Envelope/soapenv:Body/vim:%sResponse\",\n                                              methodName);\n\n            responseNode = virXPathNode(xpathExpression, xpathContext);\n\n            if (!responseNode) {\n                virReportError(VIR_ERR_INTERNAL_ERROR,\n                               _(\"XPath evaluation of response for call to '%s' \"\n                                 \"failed\"), methodName);\n                goto cleanup;\n            }\n\n            xpathContext->node = responseNode;\n            (*response)->node = virXPathNode(\"./vim:returnval\", xpathContext);\n\n            switch (occurrence) {\n              case esxVI_Occurrence_RequiredItem:\n                if (!(*response)->node) {\n                    virReportError(VIR_ERR_INTERNAL_ERROR,\n                                   _(\"Call to '%s' returned an empty result, \"\n                                     \"expecting a non-empty result\"), methodName);\n                    goto cleanup;\n                } else if ((*response)->node->next) {\n                    virReportError(VIR_ERR_INTERNAL_ERROR,\n                                   _(\"Call to '%s' returned a list, expecting \"\n                                     \"exactly one item\"), methodName);\n                    goto cleanup;\n                }\n\n                break;\n\n              case esxVI_Occurrence_RequiredList:\n                if (!(*response)->node) {\n                    virReportError(VIR_ERR_INTERNAL_ERROR,\n                                   _(\"Call to '%s' returned an empty result, \"\n                                     \"expecting a non-empty result\"), methodName);\n                    goto cleanup;\n                }\n\n                break;\n\n              case esxVI_Occurrence_OptionalItem:\n                if ((*response)->node &&\n                    (*response)->node->next) {\n                    virReportError(VIR_ERR_INTERNAL_ERROR,\n                                   _(\"Call to '%s' returned a list, expecting \"\n                                     \"exactly one item\"), methodName);\n                    goto cleanup;\n                }\n\n                break;\n\n              case esxVI_Occurrence_OptionalList:\n                /* Any amount of items is valid */\n                break;\n\n              case esxVI_Occurrence_None:\n                if ((*response)->node) {\n                    virReportError(VIR_ERR_INTERNAL_ERROR,\n                                   _(\"Call to '%s' returned something, expecting \"\n                                     \"an empty result\"), methodName);\n                    goto cleanup;\n                }\n\n                break;\n\n              case esxVI_Occurrence_Undefined:\n              default:\n                virReportEnumRangeError(esxVI_Occurrence, occurrence);\n                goto cleanup;\n            }\n        }\n    } else {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"HTTP response code %d for call to '%s'\"),\n                       (*response)->responseCode, methodName);\n        goto cleanup;\n    }\n\n    result = 0;\n\n cleanup:\n    if (result < 0) {\n        virBufferFreeAndReset(&buffer);\n        esxVI_Response_Free(response);\n        esxVI_Fault_Free(&fault);\n    }\n\n    VIR_FREE(xpathExpression);\n    xmlXPathFreeContext(xpathContext);\n\n    return result;\n}",
          "includes": [
            "#include \"esx_vi.generated.c\"",
            "#include \"virutil.h\"",
            "#include \"virstring.h\"",
            "#include \"esx_util.h\"",
            "#include \"esx_vi_methods.h\"",
            "#include \"esx_vi.h\"",
            "#include \"virxml.h\"",
            "#include \"vmx.h\"",
            "#include \"viruuid.h\"",
            "#include \"virlog.h\"",
            "#include \"viralloc.h\"",
            "#include \"virbuffer.h\"",
            "#include <libxml/xpathInternals.h>",
            "#include <libxml/parser.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"esx_vi.generated.c\"\n#include \"virutil.h\"\n#include \"virstring.h\"\n#include \"esx_util.h\"\n#include \"esx_vi_methods.h\"\n#include \"esx_vi.h\"\n#include \"virxml.h\"\n#include \"vmx.h\"\n#include \"viruuid.h\"\n#include \"virlog.h\"\n#include \"viralloc.h\"\n#include \"virbuffer.h\"\n#include <libxml/xpathInternals.h>\n#include <libxml/parser.h>\n#include <config.h>\n\nint\nesxVI_Context_Execute(esxVI_Context *ctx, const char *methodName,\n                      const char *request, esxVI_Response **response,\n                      esxVI_Occurrence occurrence)\n{\n    int result = -1;\n    virBuffer buffer = VIR_BUFFER_INITIALIZER;\n    esxVI_Fault *fault = NULL;\n    char *xpathExpression = NULL;\n    xmlXPathContextPtr xpathContext = NULL;\n    xmlNodePtr responseNode = NULL;\n\n    if (!request || !response || *response) {\n        virReportError(VIR_ERR_INTERNAL_ERROR, \"%s\", _(\"Invalid argument\"));\n        return -1;\n    }\n\n    if (esxVI_Response_Alloc(response) < 0)\n        return -1;\n\n    virMutexLock(&ctx->curl->lock);\n\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_URL, ctx->url);\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_RANGE, NULL);\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_WRITEDATA, &buffer);\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_UPLOAD, 0);\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_POSTFIELDS, request);\n    curl_easy_setopt(ctx->curl->handle, CURLOPT_POSTFIELDSIZE, strlen(request));\n\n    (*response)->responseCode = esxVI_CURL_Perform(ctx->curl, ctx->url);\n\n    virMutexUnlock(&ctx->curl->lock);\n\n    if ((*response)->responseCode < 0)\n        goto cleanup;\n\n    (*response)->content = virBufferContentAndReset(&buffer);\n\n    if ((*response)->responseCode == 500 || (*response)->responseCode == 200) {\n        (*response)->document = virXMLParseStringCtxt((*response)->content,\n                                                      _(\"(esx execute response)\"),\n                                                      &xpathContext);\n\n        if (!(*response)->document)\n            goto cleanup;\n\n        xmlXPathRegisterNs(xpathContext, BAD_CAST \"soapenv\",\n                           BAD_CAST \"http://schemas.xmlsoap.org/soap/envelope/\");\n        xmlXPathRegisterNs(xpathContext, BAD_CAST \"vim\", BAD_CAST \"urn:vim25\");\n\n        if ((*response)->responseCode == 500) {\n            (*response)->node =\n              virXPathNode(\"/soapenv:Envelope/soapenv:Body/soapenv:Fault\",\n                           xpathContext);\n\n            if (!(*response)->node) {\n                virReportError(VIR_ERR_INTERNAL_ERROR,\n                               _(\"HTTP response code %d for call to '%s'. \"\n                                 \"Fault is unknown, XPath evaluation failed\"),\n                               (*response)->responseCode, methodName);\n                goto cleanup;\n            }\n\n            if (esxVI_Fault_Deserialize((*response)->node, &fault) < 0) {\n                virReportError(VIR_ERR_INTERNAL_ERROR,\n                               _(\"HTTP response code %d for call to '%s'. \"\n                                 \"Fault is unknown, deserialization failed\"),\n                               (*response)->responseCode, methodName);\n                goto cleanup;\n            }\n\n            virReportError(VIR_ERR_INTERNAL_ERROR,\n                           _(\"HTTP response code %d for call to '%s'. \"\n                             \"Fault: %s - %s\"), (*response)->responseCode,\n                           methodName, fault->faultcode, fault->faultstring);\n\n            /* FIXME: Dump raw response until detail part gets deserialized */\n            VIR_DEBUG(\"HTTP response code %d for call to '%s' [[[[%s]]]]\",\n                      (*response)->responseCode, methodName,\n                      (*response)->content);\n\n            goto cleanup;\n        } else {\n            xpathExpression = g_strdup_printf(\"/soapenv:Envelope/soapenv:Body/vim:%sResponse\",\n                                              methodName);\n\n            responseNode = virXPathNode(xpathExpression, xpathContext);\n\n            if (!responseNode) {\n                virReportError(VIR_ERR_INTERNAL_ERROR,\n                               _(\"XPath evaluation of response for call to '%s' \"\n                                 \"failed\"), methodName);\n                goto cleanup;\n            }\n\n            xpathContext->node = responseNode;\n            (*response)->node = virXPathNode(\"./vim:returnval\", xpathContext);\n\n            switch (occurrence) {\n              case esxVI_Occurrence_RequiredItem:\n                if (!(*response)->node) {\n                    virReportError(VIR_ERR_INTERNAL_ERROR,\n                                   _(\"Call to '%s' returned an empty result, \"\n                                     \"expecting a non-empty result\"), methodName);\n                    goto cleanup;\n                } else if ((*response)->node->next) {\n                    virReportError(VIR_ERR_INTERNAL_ERROR,\n                                   _(\"Call to '%s' returned a list, expecting \"\n                                     \"exactly one item\"), methodName);\n                    goto cleanup;\n                }\n\n                break;\n\n              case esxVI_Occurrence_RequiredList:\n                if (!(*response)->node) {\n                    virReportError(VIR_ERR_INTERNAL_ERROR,\n                                   _(\"Call to '%s' returned an empty result, \"\n                                     \"expecting a non-empty result\"), methodName);\n                    goto cleanup;\n                }\n\n                break;\n\n              case esxVI_Occurrence_OptionalItem:\n                if ((*response)->node &&\n                    (*response)->node->next) {\n                    virReportError(VIR_ERR_INTERNAL_ERROR,\n                                   _(\"Call to '%s' returned a list, expecting \"\n                                     \"exactly one item\"), methodName);\n                    goto cleanup;\n                }\n\n                break;\n\n              case esxVI_Occurrence_OptionalList:\n                /* Any amount of items is valid */\n                break;\n\n              case esxVI_Occurrence_None:\n                if ((*response)->node) {\n                    virReportError(VIR_ERR_INTERNAL_ERROR,\n                                   _(\"Call to '%s' returned something, expecting \"\n                                     \"an empty result\"), methodName);\n                    goto cleanup;\n                }\n\n                break;\n\n              case esxVI_Occurrence_Undefined:\n              default:\n                virReportEnumRangeError(esxVI_Occurrence, occurrence);\n                goto cleanup;\n            }\n        }\n    } else {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"HTTP response code %d for call to '%s'\"),\n                       (*response)->responseCode, methodName);\n        goto cleanup;\n    }\n\n    result = 0;\n\n cleanup:\n    if (result < 0) {\n        virBufferFreeAndReset(&buffer);\n        esxVI_Response_Free(response);\n        esxVI_Fault_Free(&fault);\n    }\n\n    VIR_FREE(xpathExpression);\n    xmlXPathFreeContext(xpathContext);\n\n    return result;\n}"
        }
      },
      {
        "call_info": {
          "callee": "ESX_VI_CHECK_ARG_LIST",
          "args": [
            "serviceContent"
          ],
          "line": 229
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"esx_vi_methods.generated.c\"\n#include \"esx_vi_methods.generated.macro\"\n#include \"esx_util.h\"\n#include \"esx_vi_methods.h\"\n#include \"viruuid.h\"\n#include \"viralloc.h\"\n#include \"virbuffer.h\"\n#include <config.h>\n\nint\nesxVI_RetrieveServiceContent(esxVI_Context *ctx,\n                             esxVI_ServiceContent **serviceContent)\n{\n    int result = -1;\n    const char *request = ESX_VI__SOAP__REQUEST_HEADER\n                            \"<RetrieveServiceContent xmlns=\\\"urn:vim25\\\">\"\n                              \"<_this xmlns=\\\"urn:vim25\\\" \"\n                                     \"xsi:type=\\\"ManagedObjectReference\\\" \"\n                                     \"type=\\\"ServiceInstance\\\">\"\n                                \"ServiceInstance\"\n                              \"</_this>\"\n                            \"</RetrieveServiceContent>\"\n                          ESX_VI__SOAP__REQUEST_FOOTER;\n    esxVI_Response *response = NULL;\n\n    ESX_VI_CHECK_ARG_LIST(serviceContent);\n\n    if (esxVI_Context_Execute(ctx, \"RetrieveServiceContent\", request,\n                              &response, esxVI_Occurrence_RequiredItem) < 0 ||\n        esxVI_ServiceContent_Deserialize(response->node, serviceContent) < 0) {\n        goto cleanup;\n    }\n\n    result = 0;\n\n cleanup:\n    esxVI_Response_Free(&response);\n\n    return result;\n}"
  }
]