[
  {
    "function_name": "virAuditEncode",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viraudit.c",
    "lines": "138-147",
    "snippet": "char *virAuditEncode(const char *key, const char *value)\n{\n#if WITH_AUDIT\n    return audit_encode_nv_string(key, value, 0);\n#else\n    char *str;\n    str = g_strdup_printf(\"%s=%s\", key, value);\n    return str;\n#endif\n}",
    "includes": [
      "#include \"virfile.h\"",
      "#include \"viraudit.h\"",
      "#include \"virlog.h\"",
      "#include \"virerror.h\"",
      "# include <libaudit.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "g_strdup_printf",
          "args": [
            "\"%s=%s\"",
            "key",
            "value"
          ],
          "line": 144
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "audit_encode_nv_string",
          "args": [
            "key",
            "value",
            "0"
          ],
          "line": 141
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virfile.h\"\n#include \"viraudit.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n# include <libaudit.h>\n#include <config.h>\n\nchar *virAuditEncode(const char *key, const char *value)\n{\n#if WITH_AUDIT\n    return audit_encode_nv_string(key, value, 0);\n#else\n    char *str;\n    str = g_strdup_printf(\"%s=%s\", key, value);\n    return str;\n#endif\n}"
  },
  {
    "function_name": "virAuditClose",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viraudit.c",
    "lines": "131-136",
    "snippet": "void virAuditClose(void)\n{\n#if WITH_AUDIT\n    VIR_FORCE_CLOSE(auditfd);\n#endif\n}",
    "includes": [
      "#include \"virfile.h\"",
      "#include \"viraudit.h\"",
      "#include \"virlog.h\"",
      "#include \"virerror.h\"",
      "# include <libaudit.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "VIR_FORCE_CLOSE",
          "args": [
            "auditfd"
          ],
          "line": 134
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virfile.h\"\n#include \"viraudit.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n# include <libaudit.h>\n#include <config.h>\n\nvoid virAuditClose(void)\n{\n#if WITH_AUDIT\n    VIR_FORCE_CLOSE(auditfd);\n#endif\n}"
  },
  {
    "function_name": "virAuditSend",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viraudit.c",
    "lines": "75-129",
    "snippet": "void virAuditSend(virLogSourcePtr source,\n                  const char *filename,\n                  size_t linenr,\n                  const char *funcname,\n                  const char *clienttty G_GNUC_UNUSED,\n                  const char *clientaddr G_GNUC_UNUSED,\n                  virAuditRecordType type G_GNUC_UNUSED, bool success,\n                  const char *fmt, ...)\n{\n    g_autofree char *str = NULL;\n    va_list args;\n\n    /* Duplicate later checks, to short circuit & avoid printf overhead\n     * when nothing is enabled */\n#if WITH_AUDIT\n    if (!auditlog && auditfd < 0)\n        return;\n#else\n    if (!auditlog)\n        return;\n#endif\n\n    va_start(args, fmt);\n    str = g_strdup_vprintf(fmt, args);\n    va_end(args);\n\n    if (auditlog && str) {\n        if (success)\n            virLogMessage(source, VIR_LOG_INFO,\n                          filename, linenr, funcname,\n                          NULL, \"success=yes %s\", str);\n        else\n            virLogMessage(source, VIR_LOG_WARN,\n                          filename, linenr, funcname,\n                          NULL, \"success=no %s\", str);\n    }\n\n#if WITH_AUDIT\n    if (str && auditfd >= 0) {\n        static const int record_types[] = {\n            [VIR_AUDIT_RECORD_MACHINE_CONTROL] = AUDIT_VIRT_CONTROL,\n            [VIR_AUDIT_RECORD_MACHINE_ID] = AUDIT_VIRT_MACHINE_ID,\n            [VIR_AUDIT_RECORD_RESOURCE] = AUDIT_VIRT_RESOURCE,\n        };\n\n        if (type >= G_N_ELEMENTS(record_types) || record_types[type] == 0)\n            VIR_WARN(\"Unknown audit record type %d\", type);\n        else if (audit_log_user_message(auditfd, record_types[type], str, NULL,\n                                        clientaddr, clienttty, success) < 0) {\n            VIR_WARN(\"Failed to send audit message %s: %s\",\n                     NULLSTR(str), g_strerror(errno));\n        }\n    }\n#endif\n}",
    "includes": [
      "#include \"virfile.h\"",
      "#include \"viraudit.h\"",
      "#include \"virlog.h\"",
      "#include \"virerror.h\"",
      "# include <libaudit.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static bool auditlog;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "VIR_WARN",
          "args": [
            "\"Failed to send audit message %s: %s\"",
            "NULLSTR(str)",
            "g_strerror(errno)"
          ],
          "line": 124
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "g_strerror",
          "args": [
            "errno"
          ],
          "line": 125
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "NULLSTR",
          "args": [
            "str"
          ],
          "line": 125
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "audit_log_user_message",
          "args": [
            "auditfd",
            "record_types[type]",
            "str",
            "NULL",
            "clientaddr",
            "clienttty",
            "success"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VIR_WARN",
          "args": [
            "\"Unknown audit record type %d\"",
            "type"
          ],
          "line": 121
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "G_N_ELEMENTS",
          "args": [
            "record_types"
          ],
          "line": 120
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virLogMessage",
          "args": [
            "source",
            "VIR_LOG_WARN",
            "filename",
            "linenr",
            "funcname",
            "NULL",
            "\"success=no %s\"",
            "str"
          ],
          "line": 107
        },
        "resolved": true,
        "details": {
          "function_name": "virLogMessage",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virlog.c",
          "lines": "502-517",
          "snippet": "void\nvirLogMessage(virLogSourcePtr source,\n              virLogPriority priority,\n              const char *filename,\n              int linenr,\n              const char *funcname,\n              virLogMetadataPtr metadata,\n              const char *fmt, ...)\n{\n    va_list ap;\n    va_start(ap, fmt);\n    virLogVMessage(source, priority,\n                   filename, linenr, funcname,\n                   metadata, fmt, ap);\n    va_end(ap);\n}",
          "includes": [
            "# include <sys/uio.h>",
            "#include \"virsocket.h\"",
            "#include \"configmake.h\"",
            "#include \"virstring.h\"",
            "#include \"virtime.h\"",
            "#include \"virfile.h\"",
            "#include \"virthread.h\"",
            "#include \"virbuffer.h\"",
            "#include \"virutil.h\"",
            "#include \"viralloc.h\"",
            "#include \"virlog.h\"",
            "#include \"virerror.h\"",
            "# include <syslog.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/time.h>",
            "#include <time.h>",
            "#include <stdarg.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "# include <sys/uio.h>\n#include \"virsocket.h\"\n#include \"configmake.h\"\n#include \"virstring.h\"\n#include \"virtime.h\"\n#include \"virfile.h\"\n#include \"virthread.h\"\n#include \"virbuffer.h\"\n#include \"virutil.h\"\n#include \"viralloc.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n# include <syslog.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/time.h>\n#include <time.h>\n#include <stdarg.h>\n#include <config.h>\n\nvoid\nvirLogMessage(virLogSourcePtr source,\n              virLogPriority priority,\n              const char *filename,\n              int linenr,\n              const char *funcname,\n              virLogMetadataPtr metadata,\n              const char *fmt, ...)\n{\n    va_list ap;\n    va_start(ap, fmt);\n    virLogVMessage(source, priority,\n                   filename, linenr, funcname,\n                   metadata, fmt, ap);\n    va_end(ap);\n}"
        }
      },
      {
        "call_info": {
          "callee": "va_end",
          "args": [
            "args"
          ],
          "line": 99
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "g_strdup_vprintf",
          "args": [
            "fmt",
            "args"
          ],
          "line": 98
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_vprintf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "205-213",
          "snippet": "char *\nvir_g_strdup_vprintf(const char *msg, va_list args)\n{\n    char *ret;\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_vprintf(const char *msg, va_list args)\n{\n    char *ret;\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "va_start",
          "args": [
            "args",
            "fmt"
          ],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virfile.h\"\n#include \"viraudit.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n# include <libaudit.h>\n#include <config.h>\n\nstatic bool auditlog;\n\nvoid virAuditSend(virLogSourcePtr source,\n                  const char *filename,\n                  size_t linenr,\n                  const char *funcname,\n                  const char *clienttty G_GNUC_UNUSED,\n                  const char *clientaddr G_GNUC_UNUSED,\n                  virAuditRecordType type G_GNUC_UNUSED, bool success,\n                  const char *fmt, ...)\n{\n    g_autofree char *str = NULL;\n    va_list args;\n\n    /* Duplicate later checks, to short circuit & avoid printf overhead\n     * when nothing is enabled */\n#if WITH_AUDIT\n    if (!auditlog && auditfd < 0)\n        return;\n#else\n    if (!auditlog)\n        return;\n#endif\n\n    va_start(args, fmt);\n    str = g_strdup_vprintf(fmt, args);\n    va_end(args);\n\n    if (auditlog && str) {\n        if (success)\n            virLogMessage(source, VIR_LOG_INFO,\n                          filename, linenr, funcname,\n                          NULL, \"success=yes %s\", str);\n        else\n            virLogMessage(source, VIR_LOG_WARN,\n                          filename, linenr, funcname,\n                          NULL, \"success=no %s\", str);\n    }\n\n#if WITH_AUDIT\n    if (str && auditfd >= 0) {\n        static const int record_types[] = {\n            [VIR_AUDIT_RECORD_MACHINE_CONTROL] = AUDIT_VIRT_CONTROL,\n            [VIR_AUDIT_RECORD_MACHINE_ID] = AUDIT_VIRT_MACHINE_ID,\n            [VIR_AUDIT_RECORD_RESOURCE] = AUDIT_VIRT_RESOURCE,\n        };\n\n        if (type >= G_N_ELEMENTS(record_types) || record_types[type] == 0)\n            VIR_WARN(\"Unknown audit record type %d\", type);\n        else if (audit_log_user_message(auditfd, record_types[type], str, NULL,\n                                        clientaddr, clienttty, success) < 0) {\n            VIR_WARN(\"Failed to send audit message %s: %s\",\n                     NULLSTR(str), g_strerror(errno));\n        }\n    }\n#endif\n}"
  },
  {
    "function_name": "virAuditLog",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viraudit.c",
    "lines": "69-72",
    "snippet": "void virAuditLog(bool logging)\n{\n    auditlog = logging;\n}",
    "includes": [
      "#include \"virfile.h\"",
      "#include \"viraudit.h\"",
      "#include \"virlog.h\"",
      "#include \"virerror.h\"",
      "# include <libaudit.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static bool auditlog;"
    ],
    "called_functions": [],
    "contextual_snippet": "#include \"virfile.h\"\n#include \"viraudit.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n# include <libaudit.h>\n#include <config.h>\n\nstatic bool auditlog;\n\nvoid virAuditLog(bool logging)\n{\n    auditlog = logging;\n}"
  },
  {
    "function_name": "virAuditOpen",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viraudit.c",
    "lines": "42-66",
    "snippet": "int virAuditOpen(unsigned int audit_level G_GNUC_UNUSED)\n{\n#if WITH_AUDIT\n    if ((auditfd = audit_open()) < 0) {\n        /* You get these error codes only when the kernel does not\n         * have audit compiled in or it's disabled (e.g. by the kernel\n         * cmdline) */\n        if (errno == EINVAL || errno == EPROTONOSUPPORT ||\n            errno == EAFNOSUPPORT) {\n            if (audit_level < 2)\n                VIR_INFO(\"Audit is not supported by the kernel\");\n            else\n                virReportError(VIR_FROM_THIS, \"%s\", _(\"Audit is not supported by the kernel\"));\n        } else {\n            virReportSystemError(errno, \"%s\", _(\"Unable to initialize audit layer\"));\n        }\n\n        return -1;\n    }\n\n    return 0;\n#else\n    return -1;\n#endif\n}",
    "includes": [
      "#include \"virfile.h\"",
      "#include \"viraudit.h\"",
      "#include \"virlog.h\"",
      "#include \"virerror.h\"",
      "# include <libaudit.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define VIR_FROM_THIS VIR_FROM_AUDIT"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virReportSystemError",
          "args": [
            "errno",
            "\"%s\"",
            "_(\"Unable to initialize audit layer\")"
          ],
          "line": 56
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"Unable to initialize audit layer\""
          ],
          "line": 56
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_FROM_THIS",
            "\"%s\"",
            "_(\"Audit is not supported by the kernel\")"
          ],
          "line": 54
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VIR_INFO",
          "args": [
            "\"Audit is not supported by the kernel\""
          ],
          "line": 52
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "audit_open",
          "args": [],
          "line": 45
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virfile.h\"\n#include \"viraudit.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n# include <libaudit.h>\n#include <config.h>\n\n#define VIR_FROM_THIS VIR_FROM_AUDIT\n\nint virAuditOpen(unsigned int audit_level G_GNUC_UNUSED)\n{\n#if WITH_AUDIT\n    if ((auditfd = audit_open()) < 0) {\n        /* You get these error codes only when the kernel does not\n         * have audit compiled in or it's disabled (e.g. by the kernel\n         * cmdline) */\n        if (errno == EINVAL || errno == EPROTONOSUPPORT ||\n            errno == EAFNOSUPPORT) {\n            if (audit_level < 2)\n                VIR_INFO(\"Audit is not supported by the kernel\");\n            else\n                virReportError(VIR_FROM_THIS, \"%s\", _(\"Audit is not supported by the kernel\"));\n        } else {\n            virReportSystemError(errno, \"%s\", _(\"Unable to initialize audit layer\"));\n        }\n\n        return -1;\n    }\n\n    return 0;\n#else\n    return -1;\n#endif\n}"
  }
]