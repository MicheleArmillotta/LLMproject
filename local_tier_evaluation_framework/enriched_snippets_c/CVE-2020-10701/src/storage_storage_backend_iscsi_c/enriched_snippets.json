[
  {
    "function_name": "virStorageBackendISCSIRegister",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "415-419",
    "snippet": "int\nvirStorageBackendISCSIRegister(void)\n{\n    return virStorageBackendRegister(&virStorageBackendISCSI);\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "virStorageBackend virStorageBackendISCSI = {\n    .type = VIR_STORAGE_POOL_ISCSI,\n\n    .checkPool = virStorageBackendISCSICheckPool,\n    .startPool = virStorageBackendISCSIStartPool,\n    .refreshPool = virStorageBackendISCSIRefreshPool,\n    .stopPool = virStorageBackendISCSIStopPool,\n    .findPoolSources = virStorageBackendISCSIFindPoolSources,\n    .uploadVol = virStorageBackendVolUploadLocal,\n    .downloadVol = virStorageBackendVolDownloadLocal,\n    .wipeVol = virStorageBackendVolWipeLocal,\n};"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "virStorageBackendRegister",
          "args": [
            "&virStorageBackendISCSI"
          ],
          "line": 418
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendRegister",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend.c",
          "lines": "153-169",
          "snippet": "int\nvirStorageBackendRegister(virStorageBackendPtr backend)\n{\n    VIR_DEBUG(\"Registering storage backend '%s'\",\n              virStoragePoolTypeToString(backend->type));\n\n    if (virStorageBackendsCount >= VIR_STORAGE_BACKENDS_MAX) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Too many drivers, cannot register storage backend '%s'\"),\n                       virStoragePoolTypeToString(backend->type));\n        return -1;\n    }\n\n    virStorageBackends[virStorageBackendsCount] = backend;\n    virStorageBackendsCount++;\n    return 0;\n}",
          "includes": [
            "# include \"storage_backend_vstorage.h\"",
            "# include \"storage_backend_zfs.h\"",
            "# include \"storage_backend_gluster.h\"",
            "# include \"storage_backend_sheepdog.h\"",
            "# include \"storage_backend_rbd.h\"",
            "# include \"storage_backend_fs.h\"",
            "# include \"storage_backend_disk.h\"",
            "# include \"storage_backend_mpath.h\"",
            "# include \"storage_backend_scsi.h\"",
            "# include \"storage_backend_iscsi_direct.h\"",
            "# include \"storage_backend_iscsi.h\"",
            "# include \"storage_backend_logical.h\"",
            "#include \"configmake.h\"",
            "#include \"virfile.h\"",
            "#include \"virmodule.h\"",
            "#include \"virlog.h\"",
            "#include \"storage_backend.h\"",
            "#include \"virstoragefile.h\"",
            "#include \"internal.h\"",
            "#include \"viralloc.h\"",
            "#include \"virerror.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define VIR_STORAGE_BACKENDS_MAX 20"
          ],
          "globals_used": [
            "static virStorageBackendPtr virStorageBackends[VIR_STORAGE_BACKENDS_MAX];",
            "static size_t virStorageBackendsCount;"
          ],
          "called_functions": [],
          "contextual_snippet": "# include \"storage_backend_vstorage.h\"\n# include \"storage_backend_zfs.h\"\n# include \"storage_backend_gluster.h\"\n# include \"storage_backend_sheepdog.h\"\n# include \"storage_backend_rbd.h\"\n# include \"storage_backend_fs.h\"\n# include \"storage_backend_disk.h\"\n# include \"storage_backend_mpath.h\"\n# include \"storage_backend_scsi.h\"\n# include \"storage_backend_iscsi_direct.h\"\n# include \"storage_backend_iscsi.h\"\n# include \"storage_backend_logical.h\"\n#include \"configmake.h\"\n#include \"virfile.h\"\n#include \"virmodule.h\"\n#include \"virlog.h\"\n#include \"storage_backend.h\"\n#include \"virstoragefile.h\"\n#include \"internal.h\"\n#include \"viralloc.h\"\n#include \"virerror.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <config.h>\n\n#define VIR_STORAGE_BACKENDS_MAX 20\n\nstatic virStorageBackendPtr virStorageBackends[VIR_STORAGE_BACKENDS_MAX];\nstatic size_t virStorageBackendsCount;\n\nint\nvirStorageBackendRegister(virStorageBackendPtr backend)\n{\n    VIR_DEBUG(\"Registering storage backend '%s'\",\n              virStoragePoolTypeToString(backend->type));\n\n    if (virStorageBackendsCount >= VIR_STORAGE_BACKENDS_MAX) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Too many drivers, cannot register storage backend '%s'\"),\n                       virStoragePoolTypeToString(backend->type));\n        return -1;\n    }\n\n    virStorageBackends[virStorageBackendsCount] = backend;\n    virStorageBackendsCount++;\n    return 0;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nvirStorageBackend virStorageBackendISCSI = {\n    .type = VIR_STORAGE_POOL_ISCSI,\n\n    .checkPool = virStorageBackendISCSICheckPool,\n    .startPool = virStorageBackendISCSIStartPool,\n    .refreshPool = virStorageBackendISCSIRefreshPool,\n    .stopPool = virStorageBackendISCSIStopPool,\n    .findPoolSources = virStorageBackendISCSIFindPoolSources,\n    .uploadVol = virStorageBackendVolUploadLocal,\n    .downloadVol = virStorageBackendVolDownloadLocal,\n    .wipeVol = virStorageBackendVolWipeLocal,\n};\n\nint\nvirStorageBackendISCSIRegister(void)\n{\n    return virStorageBackendRegister(&virStorageBackendISCSI);\n}"
  },
  {
    "function_name": "virStorageBackendISCSIStopPool",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "380-399",
    "snippet": "static int\nvirStorageBackendISCSIStopPool(virStoragePoolObjPtr pool)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    g_autofree char *portal = NULL;\n    g_autofree char *session = NULL;\n\n    if ((session = virStorageBackendISCSISession(pool, true)) == NULL)\n        return 0;\n\n    if ((portal = virStorageBackendISCSIPortal(&def->source)) == NULL)\n        return -1;\n\n    if (virISCSIConnectionLogout(portal,\n                                 def->source.initiator.iqn,\n                                 def->source.devices[0].path) < 0)\n        return -1;\n\n    return 0;\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virISCSIConnectionLogout",
          "args": [
            "portal",
            "def->source.initiator.iqn",
            "def->source.devices[0].path"
          ],
          "line": 393
        },
        "resolved": true,
        "details": {
          "function_name": "virISCSIConnectionLogout",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viriscsi.c",
          "lines": "335-342",
          "snippet": "int\nvirISCSIConnectionLogout(const char *portal,\n                         const char *initiatoriqn,\n                         const char *target)\n{\n    const char *extraargv[] = { \"--logout\", NULL };\n    return virISCSIConnection(portal, initiatoriqn, target, extraargv);\n}",
          "includes": [
            "#include \"virstring.h\"",
            "#include \"virrandom.h\"",
            "#include \"virlog.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"viriscsi.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virstring.h\"\n#include \"virrandom.h\"\n#include \"virlog.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"viriscsi.h\"\n#include <config.h>\n\nint\nvirISCSIConnectionLogout(const char *portal,\n                         const char *initiatoriqn,\n                         const char *target)\n{\n    const char *extraargv[] = { \"--logout\", NULL };\n    return virISCSIConnection(portal, initiatoriqn, target, extraargv);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStorageBackendISCSIPortal",
          "args": [
            "&def->source"
          ],
          "line": 390
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendISCSIPortal",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
          "lines": "51-76",
          "snippet": "static char *\nvirStorageBackendISCSIPortal(virStoragePoolSourcePtr source)\n{\n    char *portal = NULL;\n\n    if (source->nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return NULL;\n    }\n\n    if (source->hosts[0].port == 0)\n        source->hosts[0].port = ISCSI_DEFAULT_TARGET_PORT;\n\n    if (strchr(source->hosts[0].name, ':')) {\n        portal = g_strdup_printf(\"[%s]:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    } else {\n        portal = g_strdup_printf(\"%s:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    }\n\n    return portal;\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"storage_util.h\"",
            "#include \"virsecret.h\"",
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virobject.h\"",
            "#include \"virlog.h\"",
            "#include \"viriscsi.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"storage_backend_iscsi.h\"",
            "#include \"driver.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ISCSI_DEFAULT_TARGET_PORT 3260"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\n#define ISCSI_DEFAULT_TARGET_PORT 3260\n\nstatic char *\nvirStorageBackendISCSIPortal(virStoragePoolSourcePtr source)\n{\n    char *portal = NULL;\n\n    if (source->nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return NULL;\n    }\n\n    if (source->hosts[0].port == 0)\n        source->hosts[0].port = ISCSI_DEFAULT_TARGET_PORT;\n\n    if (strchr(source->hosts[0].name, ':')) {\n        portal = g_strdup_printf(\"[%s]:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    } else {\n        portal = g_strdup_printf(\"%s:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    }\n\n    return portal;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStorageBackendISCSISession",
          "args": [
            "pool",
            "true"
          ],
          "line": 387
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendISCSISession",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
          "lines": "79-85",
          "snippet": "static char *\nvirStorageBackendISCSISession(virStoragePoolObjPtr pool,\n                              bool probe)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    return virISCSIGetSession(def->source.devices[0].path, probe);\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"storage_util.h\"",
            "#include \"virsecret.h\"",
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virobject.h\"",
            "#include \"virlog.h\"",
            "#include \"viriscsi.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"storage_backend_iscsi.h\"",
            "#include \"driver.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic char *\nvirStorageBackendISCSISession(virStoragePoolObjPtr pool,\n                              bool probe)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    return virISCSIGetSession(def->source.devices[0].path, probe);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStoragePoolObjGetDef",
          "args": [
            "pool"
          ],
          "line": 383
        },
        "resolved": true,
        "details": {
          "function_name": "virStoragePoolObjGetDef",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/conf/virstorageobj.c",
          "lines": "246-250",
          "snippet": "virStoragePoolDefPtr\nvirStoragePoolObjGetDef(virStoragePoolObjPtr obj)\n{\n    return obj->def;\n}",
          "includes": [
            "#include \"virvhba.h\"",
            "#include \"virstring.h\"",
            "#include \"virscsihost.h\"",
            "#include \"virlog.h\"",
            "#include \"virhash.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"viralloc.h\"",
            "#include \"virstorageobj.h\"",
            "#include \"node_device_util.h\"",
            "#include \"node_device_conf.h\"",
            "#include \"datatypes.h\"",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virvhba.h\"\n#include \"virstring.h\"\n#include \"virscsihost.h\"\n#include \"virlog.h\"\n#include \"virhash.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"viralloc.h\"\n#include \"virstorageobj.h\"\n#include \"node_device_util.h\"\n#include \"node_device_conf.h\"\n#include \"datatypes.h\"\n#include <dirent.h>\n#include <config.h>\n\nvirStoragePoolDefPtr\nvirStoragePoolObjGetDef(virStoragePoolObjPtr obj)\n{\n    return obj->def;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic int\nvirStorageBackendISCSIStopPool(virStoragePoolObjPtr pool)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    g_autofree char *portal = NULL;\n    g_autofree char *session = NULL;\n\n    if ((session = virStorageBackendISCSISession(pool, true)) == NULL)\n        return 0;\n\n    if ((portal = virStorageBackendISCSIPortal(&def->source)) == NULL)\n        return -1;\n\n    if (virISCSIConnectionLogout(portal,\n                                 def->source.initiator.iqn,\n                                 def->source.devices[0].path) < 0)\n        return -1;\n\n    return 0;\n}"
  },
  {
    "function_name": "virStorageBackendISCSIRefreshPool",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "361-377",
    "snippet": "static int\nvirStorageBackendISCSIRefreshPool(virStoragePoolObjPtr pool)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    g_autofree char *session = NULL;\n\n    def->allocation = def->capacity = def->available = 0;\n\n    if ((session = virStorageBackendISCSISession(pool, false)) == NULL)\n        return -1;\n    if (virISCSIRescanLUNs(session) < 0)\n        return -1;\n    if (virStorageBackendISCSIFindLUs(pool, session) < 0)\n        return -1;\n\n    return 0;\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virStorageBackendISCSIFindLUs",
          "args": [
            "pool",
            "session"
          ],
          "line": 373
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendISCSIFindLUs",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
          "lines": "129-146",
          "snippet": "static int\nvirStorageBackendISCSIFindLUs(virStoragePoolObjPtr pool,\n                              const char *session)\n{\n    uint32_t host;\n    g_autofree char *sysfs_path = NULL;\n\n    sysfs_path = g_strdup_printf(\"/sys/class/iscsi_session/session%s/device\",\n                                 session);\n\n    if (virStorageBackendISCSIGetHostNumber(sysfs_path, &host) < 0)\n        return -1;\n\n    if (virStorageBackendSCSIFindLUs(pool, host) < 0)\n        return -1;\n\n    return 0;\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"storage_util.h\"",
            "#include \"virsecret.h\"",
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virobject.h\"",
            "#include \"virlog.h\"",
            "#include \"viriscsi.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"storage_backend_iscsi.h\"",
            "#include \"driver.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic int\nvirStorageBackendISCSIFindLUs(virStoragePoolObjPtr pool,\n                              const char *session)\n{\n    uint32_t host;\n    g_autofree char *sysfs_path = NULL;\n\n    sysfs_path = g_strdup_printf(\"/sys/class/iscsi_session/session%s/device\",\n                                 session);\n\n    if (virStorageBackendISCSIGetHostNumber(sysfs_path, &host) < 0)\n        return -1;\n\n    if (virStorageBackendSCSIFindLUs(pool, host) < 0)\n        return -1;\n\n    return 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virISCSIRescanLUNs",
          "args": [
            "session"
          ],
          "line": 371
        },
        "resolved": true,
        "details": {
          "function_name": "virISCSIRescanLUNs",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viriscsi.c",
          "lines": "345-354",
          "snippet": "int\nvirISCSIRescanLUNs(const char *session)\n{\n    g_autoptr(virCommand) cmd = virCommandNewArgList(ISCSIADM,\n                                                       \"--mode\", \"session\",\n                                                       \"-r\", session,\n                                                       \"-R\",\n                                                       NULL);\n    return virCommandRun(cmd, NULL);\n}",
          "includes": [
            "#include \"virstring.h\"",
            "#include \"virrandom.h\"",
            "#include \"virlog.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"viriscsi.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virstring.h\"\n#include \"virrandom.h\"\n#include \"virlog.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"viriscsi.h\"\n#include <config.h>\n\nint\nvirISCSIRescanLUNs(const char *session)\n{\n    g_autoptr(virCommand) cmd = virCommandNewArgList(ISCSIADM,\n                                                       \"--mode\", \"session\",\n                                                       \"-r\", session,\n                                                       \"-R\",\n                                                       NULL);\n    return virCommandRun(cmd, NULL);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStorageBackendISCSISession",
          "args": [
            "pool",
            "false"
          ],
          "line": 369
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendISCSISession",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
          "lines": "79-85",
          "snippet": "static char *\nvirStorageBackendISCSISession(virStoragePoolObjPtr pool,\n                              bool probe)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    return virISCSIGetSession(def->source.devices[0].path, probe);\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"storage_util.h\"",
            "#include \"virsecret.h\"",
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virobject.h\"",
            "#include \"virlog.h\"",
            "#include \"viriscsi.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"storage_backend_iscsi.h\"",
            "#include \"driver.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic char *\nvirStorageBackendISCSISession(virStoragePoolObjPtr pool,\n                              bool probe)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    return virISCSIGetSession(def->source.devices[0].path, probe);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStoragePoolObjGetDef",
          "args": [
            "pool"
          ],
          "line": 364
        },
        "resolved": true,
        "details": {
          "function_name": "virStoragePoolObjGetDef",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/conf/virstorageobj.c",
          "lines": "246-250",
          "snippet": "virStoragePoolDefPtr\nvirStoragePoolObjGetDef(virStoragePoolObjPtr obj)\n{\n    return obj->def;\n}",
          "includes": [
            "#include \"virvhba.h\"",
            "#include \"virstring.h\"",
            "#include \"virscsihost.h\"",
            "#include \"virlog.h\"",
            "#include \"virhash.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"viralloc.h\"",
            "#include \"virstorageobj.h\"",
            "#include \"node_device_util.h\"",
            "#include \"node_device_conf.h\"",
            "#include \"datatypes.h\"",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virvhba.h\"\n#include \"virstring.h\"\n#include \"virscsihost.h\"\n#include \"virlog.h\"\n#include \"virhash.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"viralloc.h\"\n#include \"virstorageobj.h\"\n#include \"node_device_util.h\"\n#include \"node_device_conf.h\"\n#include \"datatypes.h\"\n#include <dirent.h>\n#include <config.h>\n\nvirStoragePoolDefPtr\nvirStoragePoolObjGetDef(virStoragePoolObjPtr obj)\n{\n    return obj->def;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic int\nvirStorageBackendISCSIRefreshPool(virStoragePoolObjPtr pool)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    g_autofree char *session = NULL;\n\n    def->allocation = def->capacity = def->available = 0;\n\n    if ((session = virStorageBackendISCSISession(pool, false)) == NULL)\n        return -1;\n    if (virISCSIRescanLUNs(session) < 0)\n        return -1;\n    if (virStorageBackendISCSIFindLUs(pool, session) < 0)\n        return -1;\n\n    return 0;\n}"
  },
  {
    "function_name": "virStorageBackendISCSIStartPool",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "315-359",
    "snippet": "static int\nvirStorageBackendISCSIStartPool(virStoragePoolObjPtr pool)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    g_autofree char *portal = NULL;\n    g_autofree char *session = NULL;\n\n    if (def->source.nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return -1;\n    }\n\n    if (def->source.hosts[0].name == NULL) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       \"%s\", _(\"missing source host\"));\n        return -1;\n    }\n\n    if (def->source.ndevice != 1 ||\n        def->source.devices[0].path == NULL) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       \"%s\", _(\"missing source device\"));\n        return -1;\n    }\n\n    if ((session = virStorageBackendISCSISession(pool, true)) == NULL) {\n        if ((portal = virStorageBackendISCSIPortal(&def->source)) == NULL)\n            return -1;\n\n        /* Create a static node record for the IQN target. Must be done\n         * in order for login to the target */\n        if (virISCSINodeNew(portal, def->source.devices[0].path) < 0)\n            return -1;\n\n        if (virStorageBackendISCSISetAuth(portal, &def->source) < 0)\n            return -1;\n\n        if (virISCSIConnectionLogin(portal,\n                                    def->source.initiator.iqn,\n                                    def->source.devices[0].path) < 0)\n            return -1;\n    }\n    return 0;\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virISCSIConnectionLogin",
          "args": [
            "portal",
            "def->source.initiator.iqn",
            "def->source.devices[0].path"
          ],
          "line": 353
        },
        "resolved": true,
        "details": {
          "function_name": "virISCSIConnectionLogin",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viriscsi.c",
          "lines": "325-332",
          "snippet": "int\nvirISCSIConnectionLogin(const char *portal,\n                        const char *initiatoriqn,\n                        const char *target)\n{\n    const char *extraargv[] = { \"--login\", NULL };\n    return virISCSIConnection(portal, initiatoriqn, target, extraargv);\n}",
          "includes": [
            "#include \"virstring.h\"",
            "#include \"virrandom.h\"",
            "#include \"virlog.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"viriscsi.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virstring.h\"\n#include \"virrandom.h\"\n#include \"virlog.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"viriscsi.h\"\n#include <config.h>\n\nint\nvirISCSIConnectionLogin(const char *portal,\n                        const char *initiatoriqn,\n                        const char *target)\n{\n    const char *extraargv[] = { \"--login\", NULL };\n    return virISCSIConnection(portal, initiatoriqn, target, extraargv);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStorageBackendISCSISetAuth",
          "args": [
            "portal",
            "&def->source"
          ],
          "line": 350
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendISCSISetAuth",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
          "lines": "258-313",
          "snippet": "static int\nvirStorageBackendISCSISetAuth(const char *portal,\n                              virStoragePoolSourcePtr source)\n{\n    unsigned char *secret_value = NULL;\n    size_t secret_size;\n    virStorageAuthDefPtr authdef = source->auth;\n    int ret = -1;\n    virConnectPtr conn = NULL;\n\n    if (!authdef || authdef->authType == VIR_STORAGE_AUTH_TYPE_NONE)\n        return 0;\n\n    VIR_DEBUG(\"username='%s' authType=%d seclookupdef.type=%d\",\n              authdef->username, authdef->authType, authdef->seclookupdef.type);\n    if (authdef->authType != VIR_STORAGE_AUTH_TYPE_CHAP) {\n        virReportError(VIR_ERR_XML_ERROR, \"%s\",\n                       _(\"iscsi pool only supports 'chap' auth type\"));\n        return -1;\n    }\n\n    conn = virGetConnectSecret();\n    if (!conn)\n        return -1;\n\n    if (virSecretGetSecretString(conn, &authdef->seclookupdef,\n                                 VIR_SECRET_USAGE_TYPE_ISCSI,\n                                 &secret_value, &secret_size) < 0)\n        goto cleanup;\n\n    if (VIR_REALLOC_N(secret_value, secret_size + 1) < 0)\n        goto cleanup;\n\n    secret_value[secret_size] = '\\0';\n\n    if (virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.authmethod\",\n                           \"CHAP\") < 0 ||\n        virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.username\",\n                           authdef->username) < 0 ||\n        virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.password\",\n                           (const char *)secret_value) < 0)\n        goto cleanup;\n\n    ret = 0;\n\n cleanup:\n    VIR_DISPOSE_N(secret_value, secret_size);\n    virObjectUnref(conn);\n    return ret;\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"storage_util.h\"",
            "#include \"virsecret.h\"",
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virobject.h\"",
            "#include \"virlog.h\"",
            "#include \"viriscsi.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"storage_backend_iscsi.h\"",
            "#include \"driver.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic int\nvirStorageBackendISCSISetAuth(const char *portal,\n                              virStoragePoolSourcePtr source)\n{\n    unsigned char *secret_value = NULL;\n    size_t secret_size;\n    virStorageAuthDefPtr authdef = source->auth;\n    int ret = -1;\n    virConnectPtr conn = NULL;\n\n    if (!authdef || authdef->authType == VIR_STORAGE_AUTH_TYPE_NONE)\n        return 0;\n\n    VIR_DEBUG(\"username='%s' authType=%d seclookupdef.type=%d\",\n              authdef->username, authdef->authType, authdef->seclookupdef.type);\n    if (authdef->authType != VIR_STORAGE_AUTH_TYPE_CHAP) {\n        virReportError(VIR_ERR_XML_ERROR, \"%s\",\n                       _(\"iscsi pool only supports 'chap' auth type\"));\n        return -1;\n    }\n\n    conn = virGetConnectSecret();\n    if (!conn)\n        return -1;\n\n    if (virSecretGetSecretString(conn, &authdef->seclookupdef,\n                                 VIR_SECRET_USAGE_TYPE_ISCSI,\n                                 &secret_value, &secret_size) < 0)\n        goto cleanup;\n\n    if (VIR_REALLOC_N(secret_value, secret_size + 1) < 0)\n        goto cleanup;\n\n    secret_value[secret_size] = '\\0';\n\n    if (virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.authmethod\",\n                           \"CHAP\") < 0 ||\n        virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.username\",\n                           authdef->username) < 0 ||\n        virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.password\",\n                           (const char *)secret_value) < 0)\n        goto cleanup;\n\n    ret = 0;\n\n cleanup:\n    VIR_DISPOSE_N(secret_value, secret_size);\n    virObjectUnref(conn);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virISCSINodeNew",
          "args": [
            "portal",
            "def->source.devices[0].path"
          ],
          "line": 347
        },
        "resolved": true,
        "details": {
          "function_name": "virISCSINodeNew",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viriscsi.c",
          "lines": "513-542",
          "snippet": "int\nvirISCSINodeNew(const char *portal,\n                const char *target)\n{\n    g_autoptr(virCommand) cmd = NULL;\n    int status;\n\n    cmd = virCommandNewArgList(ISCSIADM,\n                               \"--mode\", \"node\",\n                               \"--portal\", portal,\n                               \"--targetname\", target,\n                               \"--op\", \"new\",\n                               NULL);\n\n    if (virCommandRun(cmd, &status) < 0) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Failed new node mode for target '%s'\"),\n                       target);\n        return -1;\n    }\n\n    if (status != 0) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"%s failed new mode for target '%s' with status '%d'\"),\n                       ISCSIADM, target, status);\n        return -1;\n    }\n\n    return 0;\n}",
          "includes": [
            "#include \"virstring.h\"",
            "#include \"virrandom.h\"",
            "#include \"virlog.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"viriscsi.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virstring.h\"\n#include \"virrandom.h\"\n#include \"virlog.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"viriscsi.h\"\n#include <config.h>\n\nint\nvirISCSINodeNew(const char *portal,\n                const char *target)\n{\n    g_autoptr(virCommand) cmd = NULL;\n    int status;\n\n    cmd = virCommandNewArgList(ISCSIADM,\n                               \"--mode\", \"node\",\n                               \"--portal\", portal,\n                               \"--targetname\", target,\n                               \"--op\", \"new\",\n                               NULL);\n\n    if (virCommandRun(cmd, &status) < 0) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Failed new node mode for target '%s'\"),\n                       target);\n        return -1;\n    }\n\n    if (status != 0) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"%s failed new mode for target '%s' with status '%d'\"),\n                       ISCSIADM, target, status);\n        return -1;\n    }\n\n    return 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStorageBackendISCSIPortal",
          "args": [
            "&def->source"
          ],
          "line": 342
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendISCSIPortal",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
          "lines": "51-76",
          "snippet": "static char *\nvirStorageBackendISCSIPortal(virStoragePoolSourcePtr source)\n{\n    char *portal = NULL;\n\n    if (source->nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return NULL;\n    }\n\n    if (source->hosts[0].port == 0)\n        source->hosts[0].port = ISCSI_DEFAULT_TARGET_PORT;\n\n    if (strchr(source->hosts[0].name, ':')) {\n        portal = g_strdup_printf(\"[%s]:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    } else {\n        portal = g_strdup_printf(\"%s:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    }\n\n    return portal;\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"storage_util.h\"",
            "#include \"virsecret.h\"",
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virobject.h\"",
            "#include \"virlog.h\"",
            "#include \"viriscsi.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"storage_backend_iscsi.h\"",
            "#include \"driver.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ISCSI_DEFAULT_TARGET_PORT 3260"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\n#define ISCSI_DEFAULT_TARGET_PORT 3260\n\nstatic char *\nvirStorageBackendISCSIPortal(virStoragePoolSourcePtr source)\n{\n    char *portal = NULL;\n\n    if (source->nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return NULL;\n    }\n\n    if (source->hosts[0].port == 0)\n        source->hosts[0].port = ISCSI_DEFAULT_TARGET_PORT;\n\n    if (strchr(source->hosts[0].name, ':')) {\n        portal = g_strdup_printf(\"[%s]:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    } else {\n        portal = g_strdup_printf(\"%s:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    }\n\n    return portal;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStorageBackendISCSISession",
          "args": [
            "pool",
            "true"
          ],
          "line": 341
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendISCSISession",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
          "lines": "79-85",
          "snippet": "static char *\nvirStorageBackendISCSISession(virStoragePoolObjPtr pool,\n                              bool probe)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    return virISCSIGetSession(def->source.devices[0].path, probe);\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"storage_util.h\"",
            "#include \"virsecret.h\"",
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virobject.h\"",
            "#include \"virlog.h\"",
            "#include \"viriscsi.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"storage_backend_iscsi.h\"",
            "#include \"driver.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic char *\nvirStorageBackendISCSISession(virStoragePoolObjPtr pool,\n                              bool probe)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    return virISCSIGetSession(def->source.devices[0].path, probe);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_INTERNAL_ERROR",
            "\"%s\"",
            "_(\"missing source device\")"
          ],
          "line": 336
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"missing source device\""
          ],
          "line": 337
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_INTERNAL_ERROR",
            "\"%s\"",
            "_(\"missing source host\")"
          ],
          "line": 329
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_CONFIG_UNSUPPORTED",
            "\"%s\"",
            "_(\"Expected exactly 1 host for the storage pool\")"
          ],
          "line": 323
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virStoragePoolObjGetDef",
          "args": [
            "pool"
          ],
          "line": 318
        },
        "resolved": true,
        "details": {
          "function_name": "virStoragePoolObjGetDef",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/conf/virstorageobj.c",
          "lines": "246-250",
          "snippet": "virStoragePoolDefPtr\nvirStoragePoolObjGetDef(virStoragePoolObjPtr obj)\n{\n    return obj->def;\n}",
          "includes": [
            "#include \"virvhba.h\"",
            "#include \"virstring.h\"",
            "#include \"virscsihost.h\"",
            "#include \"virlog.h\"",
            "#include \"virhash.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"viralloc.h\"",
            "#include \"virstorageobj.h\"",
            "#include \"node_device_util.h\"",
            "#include \"node_device_conf.h\"",
            "#include \"datatypes.h\"",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virvhba.h\"\n#include \"virstring.h\"\n#include \"virscsihost.h\"\n#include \"virlog.h\"\n#include \"virhash.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"viralloc.h\"\n#include \"virstorageobj.h\"\n#include \"node_device_util.h\"\n#include \"node_device_conf.h\"\n#include \"datatypes.h\"\n#include <dirent.h>\n#include <config.h>\n\nvirStoragePoolDefPtr\nvirStoragePoolObjGetDef(virStoragePoolObjPtr obj)\n{\n    return obj->def;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic int\nvirStorageBackendISCSIStartPool(virStoragePoolObjPtr pool)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    g_autofree char *portal = NULL;\n    g_autofree char *session = NULL;\n\n    if (def->source.nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return -1;\n    }\n\n    if (def->source.hosts[0].name == NULL) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       \"%s\", _(\"missing source host\"));\n        return -1;\n    }\n\n    if (def->source.ndevice != 1 ||\n        def->source.devices[0].path == NULL) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       \"%s\", _(\"missing source device\"));\n        return -1;\n    }\n\n    if ((session = virStorageBackendISCSISession(pool, true)) == NULL) {\n        if ((portal = virStorageBackendISCSIPortal(&def->source)) == NULL)\n            return -1;\n\n        /* Create a static node record for the IQN target. Must be done\n         * in order for login to the target */\n        if (virISCSINodeNew(portal, def->source.devices[0].path) < 0)\n            return -1;\n\n        if (virStorageBackendISCSISetAuth(portal, &def->source) < 0)\n            return -1;\n\n        if (virISCSIConnectionLogin(portal,\n                                    def->source.initiator.iqn,\n                                    def->source.devices[0].path) < 0)\n            return -1;\n    }\n    return 0;\n}"
  },
  {
    "function_name": "virStorageBackendISCSISetAuth",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "258-313",
    "snippet": "static int\nvirStorageBackendISCSISetAuth(const char *portal,\n                              virStoragePoolSourcePtr source)\n{\n    unsigned char *secret_value = NULL;\n    size_t secret_size;\n    virStorageAuthDefPtr authdef = source->auth;\n    int ret = -1;\n    virConnectPtr conn = NULL;\n\n    if (!authdef || authdef->authType == VIR_STORAGE_AUTH_TYPE_NONE)\n        return 0;\n\n    VIR_DEBUG(\"username='%s' authType=%d seclookupdef.type=%d\",\n              authdef->username, authdef->authType, authdef->seclookupdef.type);\n    if (authdef->authType != VIR_STORAGE_AUTH_TYPE_CHAP) {\n        virReportError(VIR_ERR_XML_ERROR, \"%s\",\n                       _(\"iscsi pool only supports 'chap' auth type\"));\n        return -1;\n    }\n\n    conn = virGetConnectSecret();\n    if (!conn)\n        return -1;\n\n    if (virSecretGetSecretString(conn, &authdef->seclookupdef,\n                                 VIR_SECRET_USAGE_TYPE_ISCSI,\n                                 &secret_value, &secret_size) < 0)\n        goto cleanup;\n\n    if (VIR_REALLOC_N(secret_value, secret_size + 1) < 0)\n        goto cleanup;\n\n    secret_value[secret_size] = '\\0';\n\n    if (virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.authmethod\",\n                           \"CHAP\") < 0 ||\n        virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.username\",\n                           authdef->username) < 0 ||\n        virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.password\",\n                           (const char *)secret_value) < 0)\n        goto cleanup;\n\n    ret = 0;\n\n cleanup:\n    VIR_DISPOSE_N(secret_value, secret_size);\n    virObjectUnref(conn);\n    return ret;\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virObjectUnref",
          "args": [
            "conn"
          ],
          "line": 311
        },
        "resolved": true,
        "details": {
          "function_name": "virObjectUnref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virobject.c",
          "lines": "338-365",
          "snippet": "bool\nvirObjectUnref(void *anyobj)\n{\n    virObjectPtr obj = anyobj;\n\n    if (VIR_OBJECT_NOTVALID(obj))\n        return false;\n\n    bool lastRef = !!g_atomic_int_dec_and_test(&obj->u.s.refs);\n    PROBE(OBJECT_UNREF, \"obj=%p\", obj);\n    if (lastRef) {\n        PROBE(OBJECT_DISPOSE, \"obj=%p\", obj);\n        virClassPtr klass = obj->klass;\n        while (klass) {\n            if (klass->dispose)\n                klass->dispose(obj);\n            klass = klass->parent;\n        }\n\n        /* Clear & poison object */\n        memset(obj, 0, obj->klass->objectSize);\n        obj->u.s.magic = 0xDEADBEEF;\n        obj->klass = (void*)0xDEADBEEF;\n        VIR_FREE(obj);\n    }\n\n    return !lastRef;\n}",
          "includes": [
            "#include \"virstring.h\"",
            "#include \"virprobe.h\"",
            "#include \"virlog.h\"",
            "#include \"virerror.h\"",
            "#include \"viralloc.h\"",
            "#include \"virthread.h\"",
            "#include \"virobject.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static void virObjectLockableDispose(void *anyobj);",
            "static void virObjectRWLockableDispose(void *anyobj);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"virstring.h\"\n#include \"virprobe.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n#include \"viralloc.h\"\n#include \"virthread.h\"\n#include \"virobject.h\"\n#include <config.h>\n\nstatic void virObjectLockableDispose(void *anyobj);\nstatic void virObjectRWLockableDispose(void *anyobj);\n\nbool\nvirObjectUnref(void *anyobj)\n{\n    virObjectPtr obj = anyobj;\n\n    if (VIR_OBJECT_NOTVALID(obj))\n        return false;\n\n    bool lastRef = !!g_atomic_int_dec_and_test(&obj->u.s.refs);\n    PROBE(OBJECT_UNREF, \"obj=%p\", obj);\n    if (lastRef) {\n        PROBE(OBJECT_DISPOSE, \"obj=%p\", obj);\n        virClassPtr klass = obj->klass;\n        while (klass) {\n            if (klass->dispose)\n                klass->dispose(obj);\n            klass = klass->parent;\n        }\n\n        /* Clear & poison object */\n        memset(obj, 0, obj->klass->objectSize);\n        obj->u.s.magic = 0xDEADBEEF;\n        obj->klass = (void*)0xDEADBEEF;\n        VIR_FREE(obj);\n    }\n\n    return !lastRef;\n}"
        }
      },
      {
        "call_info": {
          "callee": "VIR_DISPOSE_N",
          "args": [
            "secret_value",
            "secret_size"
          ],
          "line": 310
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virISCSINodeUpdate",
          "args": [
            "portal",
            "source->devices[0].path",
            "\"node.session.auth.password\"",
            "(const char *)secret_value"
          ],
          "line": 301
        },
        "resolved": true,
        "details": {
          "function_name": "virISCSINodeUpdate",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viriscsi.c",
          "lines": "545-572",
          "snippet": "int\nvirISCSINodeUpdate(const char *portal,\n                   const char *target,\n                   const char *name,\n                   const char *value)\n{\n    g_autoptr(virCommand) cmd = NULL;\n    int status;\n\n    cmd = virCommandNewArgList(ISCSIADM,\n                               \"--mode\", \"node\",\n                               \"--portal\", portal,\n                               \"--target\", target,\n                               \"--op\", \"update\",\n                               \"--name\", name,\n                               \"--value\", value,\n                               NULL);\n\n    /* Ignore non-zero status.  */\n    if (virCommandRun(cmd, &status) < 0) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Failed to update '%s' of node mode for target '%s'\"),\n                       name, target);\n        return -1;\n    }\n\n    return 0;\n}",
          "includes": [
            "#include \"virstring.h\"",
            "#include \"virrandom.h\"",
            "#include \"virlog.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"viriscsi.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virstring.h\"\n#include \"virrandom.h\"\n#include \"virlog.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"viriscsi.h\"\n#include <config.h>\n\nint\nvirISCSINodeUpdate(const char *portal,\n                   const char *target,\n                   const char *name,\n                   const char *value)\n{\n    g_autoptr(virCommand) cmd = NULL;\n    int status;\n\n    cmd = virCommandNewArgList(ISCSIADM,\n                               \"--mode\", \"node\",\n                               \"--portal\", portal,\n                               \"--target\", target,\n                               \"--op\", \"update\",\n                               \"--name\", name,\n                               \"--value\", value,\n                               NULL);\n\n    /* Ignore non-zero status.  */\n    if (virCommandRun(cmd, &status) < 0) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Failed to update '%s' of node mode for target '%s'\"),\n                       name, target);\n        return -1;\n    }\n\n    return 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "VIR_REALLOC_N",
          "args": [
            "secret_value",
            "secret_size + 1"
          ],
          "line": 288
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virSecretGetSecretString",
          "args": [
            "conn",
            "&authdef->seclookupdef",
            "VIR_SECRET_USAGE_TYPE_ISCSI",
            "&secret_value",
            "&secret_size"
          ],
          "line": 283
        },
        "resolved": true,
        "details": {
          "function_name": "virSecretGetSecretString",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virsecret.c",
          "lines": "143-195",
          "snippet": "int\nvirSecretGetSecretString(virConnectPtr conn,\n                         virSecretLookupTypeDefPtr seclookupdef,\n                         virSecretUsageType secretUsageType,\n                         uint8_t **secret,\n                         size_t *secret_size)\n{\n    virSecretPtr sec = NULL;\n    int ret = -1;\n\n    switch (seclookupdef->type) {\n    case VIR_SECRET_LOOKUP_TYPE_UUID:\n        sec = conn->secretDriver->secretLookupByUUID(conn, seclookupdef->u.uuid);\n        break;\n\n    case VIR_SECRET_LOOKUP_TYPE_USAGE:\n        sec = conn->secretDriver->secretLookupByUsage(conn, secretUsageType,\n                                                      seclookupdef->u.usage);\n        break;\n    }\n\n    if (!sec)\n        goto cleanup;\n\n    /* NB: NONE is a byproduct of the qemuxml2argvtest test mocking\n     * for UUID lookups. Normal secret XML processing would fail if\n     * the usage type was NONE and since we have no way to set the\n     * expected usage in that environment, let's just accept NONE */\n    if (sec->usageType != VIR_SECRET_USAGE_TYPE_NONE &&\n        sec->usageType != secretUsageType) {\n        char uuidstr[VIR_UUID_STRING_BUFLEN];\n\n        virUUIDFormat(seclookupdef->u.uuid, uuidstr);\n        virReportError(VIR_ERR_INVALID_ARG,\n                       _(\"secret with uuid %s is of type '%s' not \"\n                         \"expected '%s' type\"),\n                       uuidstr, virSecretUsageTypeToString(sec->usageType),\n                       virSecretUsageTypeToString(secretUsageType));\n        goto cleanup;\n    }\n\n    *secret = conn->secretDriver->secretGetValue(sec, secret_size, 0,\n                                                 VIR_SECRET_GET_VALUE_INTERNAL_CALL);\n\n    if (!*secret)\n        goto cleanup;\n\n    ret = 0;\n\n cleanup:\n    virObjectUnref(sec);\n    return ret;\n}",
          "includes": [
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virsecret.h\"",
            "#include \"virlog.h\"",
            "#include \"virerror.h\"",
            "#include \"viralloc.h\"",
            "#include \"datatypes.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virsecret.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n#include \"viralloc.h\"\n#include \"datatypes.h\"\n#include <config.h>\n\nint\nvirSecretGetSecretString(virConnectPtr conn,\n                         virSecretLookupTypeDefPtr seclookupdef,\n                         virSecretUsageType secretUsageType,\n                         uint8_t **secret,\n                         size_t *secret_size)\n{\n    virSecretPtr sec = NULL;\n    int ret = -1;\n\n    switch (seclookupdef->type) {\n    case VIR_SECRET_LOOKUP_TYPE_UUID:\n        sec = conn->secretDriver->secretLookupByUUID(conn, seclookupdef->u.uuid);\n        break;\n\n    case VIR_SECRET_LOOKUP_TYPE_USAGE:\n        sec = conn->secretDriver->secretLookupByUsage(conn, secretUsageType,\n                                                      seclookupdef->u.usage);\n        break;\n    }\n\n    if (!sec)\n        goto cleanup;\n\n    /* NB: NONE is a byproduct of the qemuxml2argvtest test mocking\n     * for UUID lookups. Normal secret XML processing would fail if\n     * the usage type was NONE and since we have no way to set the\n     * expected usage in that environment, let's just accept NONE */\n    if (sec->usageType != VIR_SECRET_USAGE_TYPE_NONE &&\n        sec->usageType != secretUsageType) {\n        char uuidstr[VIR_UUID_STRING_BUFLEN];\n\n        virUUIDFormat(seclookupdef->u.uuid, uuidstr);\n        virReportError(VIR_ERR_INVALID_ARG,\n                       _(\"secret with uuid %s is of type '%s' not \"\n                         \"expected '%s' type\"),\n                       uuidstr, virSecretUsageTypeToString(sec->usageType),\n                       virSecretUsageTypeToString(secretUsageType));\n        goto cleanup;\n    }\n\n    *secret = conn->secretDriver->secretGetValue(sec, secret_size, 0,\n                                                 VIR_SECRET_GET_VALUE_INTERNAL_CALL);\n\n    if (!*secret)\n        goto cleanup;\n\n    ret = 0;\n\n cleanup:\n    virObjectUnref(sec);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virGetConnectSecret",
          "args": [],
          "line": 279
        },
        "resolved": true,
        "details": {
          "function_name": "virGetConnectSecret",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/driver.c",
          "lines": "184-187",
          "snippet": "virConnectPtr virGetConnectSecret(void)\n{\n    return virGetConnectGeneric(&connectSecret, \"secret\");\n}",
          "includes": [
            "#include \"configmake.h\"",
            "#include \"virutil.h\"",
            "#include \"virthread.h\"",
            "#include \"virstring.h\"",
            "#include \"virmodule.h\"",
            "#include \"virlog.h\"",
            "#include \"virfile.h\"",
            "#include \"viralloc.h\"",
            "#include \"driver.h\"",
            "#include <unistd.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "virThreadLocal connectSecret;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"configmake.h\"\n#include \"virutil.h\"\n#include \"virthread.h\"\n#include \"virstring.h\"\n#include \"virmodule.h\"\n#include \"virlog.h\"\n#include \"virfile.h\"\n#include \"viralloc.h\"\n#include \"driver.h\"\n#include <unistd.h>\n#include <config.h>\n\nvirThreadLocal connectSecret;\n\nvirConnectPtr virGetConnectSecret(void)\n{\n    return virGetConnectGeneric(&connectSecret, \"secret\");\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_XML_ERROR",
            "\"%s\"",
            "_(\"iscsi pool only supports 'chap' auth type\")"
          ],
          "line": 274
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"iscsi pool only supports 'chap' auth type\""
          ],
          "line": 275
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "VIR_DEBUG",
          "args": [
            "\"username='%s' authType=%d seclookupdef.type=%d\"",
            "authdef->username",
            "authdef->authType",
            "authdef->seclookupdef.type"
          ],
          "line": 271
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic int\nvirStorageBackendISCSISetAuth(const char *portal,\n                              virStoragePoolSourcePtr source)\n{\n    unsigned char *secret_value = NULL;\n    size_t secret_size;\n    virStorageAuthDefPtr authdef = source->auth;\n    int ret = -1;\n    virConnectPtr conn = NULL;\n\n    if (!authdef || authdef->authType == VIR_STORAGE_AUTH_TYPE_NONE)\n        return 0;\n\n    VIR_DEBUG(\"username='%s' authType=%d seclookupdef.type=%d\",\n              authdef->username, authdef->authType, authdef->seclookupdef.type);\n    if (authdef->authType != VIR_STORAGE_AUTH_TYPE_CHAP) {\n        virReportError(VIR_ERR_XML_ERROR, \"%s\",\n                       _(\"iscsi pool only supports 'chap' auth type\"));\n        return -1;\n    }\n\n    conn = virGetConnectSecret();\n    if (!conn)\n        return -1;\n\n    if (virSecretGetSecretString(conn, &authdef->seclookupdef,\n                                 VIR_SECRET_USAGE_TYPE_ISCSI,\n                                 &secret_value, &secret_size) < 0)\n        goto cleanup;\n\n    if (VIR_REALLOC_N(secret_value, secret_size + 1) < 0)\n        goto cleanup;\n\n    secret_value[secret_size] = '\\0';\n\n    if (virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.authmethod\",\n                           \"CHAP\") < 0 ||\n        virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.username\",\n                           authdef->username) < 0 ||\n        virISCSINodeUpdate(portal,\n                           source->devices[0].path,\n                           \"node.session.auth.password\",\n                           (const char *)secret_value) < 0)\n        goto cleanup;\n\n    ret = 0;\n\n cleanup:\n    VIR_DISPOSE_N(secret_value, secret_size);\n    virObjectUnref(conn);\n    return ret;\n}"
  },
  {
    "function_name": "virStorageBackendISCSICheckPool",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "224-255",
    "snippet": "static int\nvirStorageBackendISCSICheckPool(virStoragePoolObjPtr pool,\n                                bool *isActive)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    g_autofree char *session = NULL;\n\n    *isActive = false;\n\n    if (def->source.nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return -1;\n    }\n\n    if (def->source.hosts[0].name == NULL) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       \"%s\", _(\"missing source host\"));\n        return -1;\n    }\n\n    if (def->source.ndevice != 1 ||\n        def->source.devices[0].path == NULL) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       \"%s\", _(\"missing source device\"));\n        return -1;\n    }\n\n    if ((session = virStorageBackendISCSISession(pool, true)))\n        *isActive = true;\n    return 0;\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virStorageBackendISCSISession",
          "args": [
            "pool",
            "true"
          ],
          "line": 252
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendISCSISession",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
          "lines": "79-85",
          "snippet": "static char *\nvirStorageBackendISCSISession(virStoragePoolObjPtr pool,\n                              bool probe)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    return virISCSIGetSession(def->source.devices[0].path, probe);\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"storage_util.h\"",
            "#include \"virsecret.h\"",
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virobject.h\"",
            "#include \"virlog.h\"",
            "#include \"viriscsi.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"storage_backend_iscsi.h\"",
            "#include \"driver.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic char *\nvirStorageBackendISCSISession(virStoragePoolObjPtr pool,\n                              bool probe)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    return virISCSIGetSession(def->source.devices[0].path, probe);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_INTERNAL_ERROR",
            "\"%s\"",
            "_(\"missing source device\")"
          ],
          "line": 247
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"missing source device\""
          ],
          "line": 248
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_INTERNAL_ERROR",
            "\"%s\"",
            "_(\"missing source host\")"
          ],
          "line": 240
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_CONFIG_UNSUPPORTED",
            "\"%s\"",
            "_(\"Expected exactly 1 host for the storage pool\")"
          ],
          "line": 234
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virStoragePoolObjGetDef",
          "args": [
            "pool"
          ],
          "line": 228
        },
        "resolved": true,
        "details": {
          "function_name": "virStoragePoolObjGetDef",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/conf/virstorageobj.c",
          "lines": "246-250",
          "snippet": "virStoragePoolDefPtr\nvirStoragePoolObjGetDef(virStoragePoolObjPtr obj)\n{\n    return obj->def;\n}",
          "includes": [
            "#include \"virvhba.h\"",
            "#include \"virstring.h\"",
            "#include \"virscsihost.h\"",
            "#include \"virlog.h\"",
            "#include \"virhash.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"viralloc.h\"",
            "#include \"virstorageobj.h\"",
            "#include \"node_device_util.h\"",
            "#include \"node_device_conf.h\"",
            "#include \"datatypes.h\"",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virvhba.h\"\n#include \"virstring.h\"\n#include \"virscsihost.h\"\n#include \"virlog.h\"\n#include \"virhash.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"viralloc.h\"\n#include \"virstorageobj.h\"\n#include \"node_device_util.h\"\n#include \"node_device_conf.h\"\n#include \"datatypes.h\"\n#include <dirent.h>\n#include <config.h>\n\nvirStoragePoolDefPtr\nvirStoragePoolObjGetDef(virStoragePoolObjPtr obj)\n{\n    return obj->def;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic int\nvirStorageBackendISCSICheckPool(virStoragePoolObjPtr pool,\n                                bool *isActive)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    g_autofree char *session = NULL;\n\n    *isActive = false;\n\n    if (def->source.nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return -1;\n    }\n\n    if (def->source.hosts[0].name == NULL) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       \"%s\", _(\"missing source host\"));\n        return -1;\n    }\n\n    if (def->source.ndevice != 1 ||\n        def->source.devices[0].path == NULL) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       \"%s\", _(\"missing source device\"));\n        return -1;\n    }\n\n    if ((session = virStorageBackendISCSISession(pool, true)))\n        *isActive = true;\n    return 0;\n}"
  },
  {
    "function_name": "virStorageBackendISCSIFindPoolSources",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "149-222",
    "snippet": "static char *\nvirStorageBackendISCSIFindPoolSources(const char *srcSpec,\n                                      unsigned int flags)\n{\n    size_t ntargets = 0;\n    char **targets = NULL;\n    char *ret = NULL;\n    size_t i;\n    virStoragePoolSourceList list = {\n        .type = VIR_STORAGE_POOL_ISCSI,\n        .nsources = 0,\n        .sources = NULL\n    };\n    g_autofree char *portal = NULL;\n    g_autoptr(virStoragePoolSource) source = NULL;\n\n    virCheckFlags(0, NULL);\n\n    if (!srcSpec) {\n        virReportError(VIR_ERR_INVALID_ARG, \"%s\",\n                       _(\"hostname must be specified for iscsi sources\"));\n        return NULL;\n    }\n\n    if (!(source = virStoragePoolDefParseSourceString(srcSpec,\n                                                      list.type)))\n        return NULL;\n\n    if (source->nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        goto cleanup;\n    }\n\n    if (!(portal = virStorageBackendISCSIPortal(source)))\n        goto cleanup;\n\n    if (virISCSIScanTargets(portal,\n                            source->initiator.iqn,\n                            false,\n                            &ntargets, &targets) < 0)\n        goto cleanup;\n\n    if (VIR_ALLOC_N(list.sources, ntargets) < 0)\n        goto cleanup;\n\n    for (i = 0; i < ntargets; i++) {\n        if (VIR_ALLOC_N(list.sources[i].devices, 1) < 0 ||\n            VIR_ALLOC_N(list.sources[i].hosts, 1) < 0)\n            goto cleanup;\n        list.sources[i].nhost = 1;\n        list.sources[i].hosts[0] = source->hosts[0];\n        list.sources[i].initiator = source->initiator;\n        list.sources[i].ndevice = 1;\n        list.sources[i].devices[0].path = targets[i];\n        list.nsources++;\n    }\n\n    if (!(ret = virStoragePoolSourceListFormat(&list)))\n        goto cleanup;\n\n cleanup:\n    if (list.sources) {\n        for (i = 0; i < ntargets; i++) {\n            VIR_FREE(list.sources[i].hosts);\n            VIR_FREE(list.sources[i].devices);\n        }\n        VIR_FREE(list.sources);\n    }\n    for (i = 0; i < ntargets; i++)\n        VIR_FREE(targets[i]);\n    VIR_FREE(targets);\n    return ret;\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "VIR_FREE",
          "args": [
            "targets"
          ],
          "line": 220
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VIR_FREE",
          "args": [
            "targets[i]"
          ],
          "line": 219
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VIR_FREE",
          "args": [
            "list.sources"
          ],
          "line": 216
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VIR_FREE",
          "args": [
            "list.sources[i].devices"
          ],
          "line": 214
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VIR_FREE",
          "args": [
            "list.sources[i].hosts"
          ],
          "line": 213
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virStoragePoolSourceListFormat",
          "args": [
            "&list"
          ],
          "line": 207
        },
        "resolved": true,
        "details": {
          "function_name": "virStoragePoolSourceListFormat",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/conf/storage_conf.c",
          "lines": "1744-1777",
          "snippet": "char *\nvirStoragePoolSourceListFormat(virStoragePoolSourceListPtr def)\n{\n    virStoragePoolOptionsPtr options;\n    virBuffer buf = VIR_BUFFER_INITIALIZER;\n    const char *type;\n    size_t i;\n\n    options = virStoragePoolOptionsForPoolType(def->type);\n    if (options == NULL)\n        return NULL;\n\n    type = virStoragePoolTypeToString(def->type);\n    if (!type) {\n        virReportError(VIR_ERR_INTERNAL_ERROR, \"%s\",\n                       _(\"unexpected pool type\"));\n        goto cleanup;\n    }\n\n    virBufferAddLit(&buf, \"<sources>\\n\");\n    virBufferAdjustIndent(&buf, 2);\n\n    for (i = 0; i < def->nsources; i++)\n        virStoragePoolSourceFormat(&buf, options, &def->sources[i]);\n\n    virBufferAdjustIndent(&buf, -2);\n    virBufferAddLit(&buf, \"</sources>\\n\");\n\n    return virBufferContentAndReset(&buf);\n\n cleanup:\n    virBufferFreeAndReset(&buf);\n    return NULL;\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"virvhba.h\"",
            "#include \"virlog.h\"",
            "#include \"virstring.h\"",
            "#include \"virscsihost.h\"",
            "#include \"virfile.h\"",
            "#include \"viralloc.h\"",
            "#include \"virbuffer.h\"",
            "#include \"viruuid.h\"",
            "#include \"virxml.h\"",
            "#include \"virstoragefile.h\"",
            "#include \"storage_conf.h\"",
            "#include \"storage_adapter_conf.h\"",
            "#include \"node_device_conf.h\"",
            "#include \"datatypes.h\"",
            "#include \"virerror.h\"",
            "#include <fcntl.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"virvhba.h\"\n#include \"virlog.h\"\n#include \"virstring.h\"\n#include \"virscsihost.h\"\n#include \"virfile.h\"\n#include \"viralloc.h\"\n#include \"virbuffer.h\"\n#include \"viruuid.h\"\n#include \"virxml.h\"\n#include \"virstoragefile.h\"\n#include \"storage_conf.h\"\n#include \"storage_adapter_conf.h\"\n#include \"node_device_conf.h\"\n#include \"datatypes.h\"\n#include \"virerror.h\"\n#include <fcntl.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <config.h>\n\nchar *\nvirStoragePoolSourceListFormat(virStoragePoolSourceListPtr def)\n{\n    virStoragePoolOptionsPtr options;\n    virBuffer buf = VIR_BUFFER_INITIALIZER;\n    const char *type;\n    size_t i;\n\n    options = virStoragePoolOptionsForPoolType(def->type);\n    if (options == NULL)\n        return NULL;\n\n    type = virStoragePoolTypeToString(def->type);\n    if (!type) {\n        virReportError(VIR_ERR_INTERNAL_ERROR, \"%s\",\n                       _(\"unexpected pool type\"));\n        goto cleanup;\n    }\n\n    virBufferAddLit(&buf, \"<sources>\\n\");\n    virBufferAdjustIndent(&buf, 2);\n\n    for (i = 0; i < def->nsources; i++)\n        virStoragePoolSourceFormat(&buf, options, &def->sources[i]);\n\n    virBufferAdjustIndent(&buf, -2);\n    virBufferAddLit(&buf, \"</sources>\\n\");\n\n    return virBufferContentAndReset(&buf);\n\n cleanup:\n    virBufferFreeAndReset(&buf);\n    return NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "VIR_ALLOC_N",
          "args": [
            "list.sources[i].hosts",
            "1"
          ],
          "line": 197
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VIR_ALLOC_N",
          "args": [
            "list.sources[i].devices",
            "1"
          ],
          "line": 196
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VIR_ALLOC_N",
          "args": [
            "list.sources",
            "ntargets"
          ],
          "line": 192
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virISCSIScanTargets",
          "args": [
            "portal",
            "source->initiator.iqn",
            "false",
            "&ntargets",
            "&targets"
          ],
          "line": 186
        },
        "resolved": true,
        "details": {
          "function_name": "virISCSIScanTargets",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viriscsi.c",
          "lines": "462-494",
          "snippet": "int\nvirISCSIScanTargets(const char *portal,\n                    const char *initiatoriqn,\n                    bool persist,\n                    size_t *ntargets,\n                    char ***targets)\n{\n    g_autofree char *ifacename = NULL;\n\n    if (ntargets)\n        *ntargets = 0;\n    if (targets)\n        *targets = NULL;\n\n    if (initiatoriqn) {\n        switch ((virStorageBackendIQNFound(initiatoriqn, &ifacename))) {\n        case IQN_FOUND:\n            break;\n\n        case IQN_MISSING:\n            virReportError(VIR_ERR_OPERATION_FAILED,\n                           _(\"no iSCSI interface defined for IQN %s\"),\n                           initiatoriqn);\n            G_GNUC_FALLTHROUGH;\n        case IQN_ERROR:\n        default:\n            return -1;\n        }\n    }\n\n    return virISCSIScanTargetsInternal(portal, ifacename,\n                                       persist, ntargets, targets);\n}",
          "includes": [
            "#include \"virstring.h\"",
            "#include \"virrandom.h\"",
            "#include \"virlog.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"viriscsi.h\"",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define IQN_ERROR -1",
            "#define IQN_MISSING 0",
            "#define IQN_FOUND 1"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virstring.h\"\n#include \"virrandom.h\"\n#include \"virlog.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"viriscsi.h\"\n#include <config.h>\n\n#define IQN_ERROR -1\n#define IQN_MISSING 0\n#define IQN_FOUND 1\n\nint\nvirISCSIScanTargets(const char *portal,\n                    const char *initiatoriqn,\n                    bool persist,\n                    size_t *ntargets,\n                    char ***targets)\n{\n    g_autofree char *ifacename = NULL;\n\n    if (ntargets)\n        *ntargets = 0;\n    if (targets)\n        *targets = NULL;\n\n    if (initiatoriqn) {\n        switch ((virStorageBackendIQNFound(initiatoriqn, &ifacename))) {\n        case IQN_FOUND:\n            break;\n\n        case IQN_MISSING:\n            virReportError(VIR_ERR_OPERATION_FAILED,\n                           _(\"no iSCSI interface defined for IQN %s\"),\n                           initiatoriqn);\n            G_GNUC_FALLTHROUGH;\n        case IQN_ERROR:\n        default:\n            return -1;\n        }\n    }\n\n    return virISCSIScanTargetsInternal(portal, ifacename,\n                                       persist, ntargets, targets);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStorageBackendISCSIPortal",
          "args": [
            "source"
          ],
          "line": 183
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendISCSIPortal",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
          "lines": "51-76",
          "snippet": "static char *\nvirStorageBackendISCSIPortal(virStoragePoolSourcePtr source)\n{\n    char *portal = NULL;\n\n    if (source->nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return NULL;\n    }\n\n    if (source->hosts[0].port == 0)\n        source->hosts[0].port = ISCSI_DEFAULT_TARGET_PORT;\n\n    if (strchr(source->hosts[0].name, ':')) {\n        portal = g_strdup_printf(\"[%s]:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    } else {\n        portal = g_strdup_printf(\"%s:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    }\n\n    return portal;\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"storage_util.h\"",
            "#include \"virsecret.h\"",
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virobject.h\"",
            "#include \"virlog.h\"",
            "#include \"viriscsi.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"storage_backend_iscsi.h\"",
            "#include \"driver.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [
            "#define ISCSI_DEFAULT_TARGET_PORT 3260"
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\n#define ISCSI_DEFAULT_TARGET_PORT 3260\n\nstatic char *\nvirStorageBackendISCSIPortal(virStoragePoolSourcePtr source)\n{\n    char *portal = NULL;\n\n    if (source->nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return NULL;\n    }\n\n    if (source->hosts[0].port == 0)\n        source->hosts[0].port = ISCSI_DEFAULT_TARGET_PORT;\n\n    if (strchr(source->hosts[0].name, ':')) {\n        portal = g_strdup_printf(\"[%s]:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    } else {\n        portal = g_strdup_printf(\"%s:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    }\n\n    return portal;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_CONFIG_UNSUPPORTED",
            "\"%s\"",
            "_(\"Expected exactly 1 host for the storage pool\")"
          ],
          "line": 178
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"Expected exactly 1 host for the storage pool\""
          ],
          "line": 179
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStoragePoolDefParseSourceString",
          "args": [
            "srcSpec",
            "list.type"
          ],
          "line": 173
        },
        "resolved": true,
        "details": {
          "function_name": "virStoragePoolDefParseSourceString",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/conf/storage_conf.c",
          "lines": "692-720",
          "snippet": "virStoragePoolSourcePtr\nvirStoragePoolDefParseSourceString(const char *srcSpec,\n                                   int pool_type)\n{\n    g_autoptr(xmlDoc) doc = NULL;\n    xmlNodePtr node = NULL;\n    g_autoptr(xmlXPathContext) xpath_ctxt = NULL;\n    g_autoptr(virStoragePoolSource) def = NULL;\n\n    if (!(doc = virXMLParseStringCtxt(srcSpec,\n                                      _(\"(storage_source_specification)\"),\n                                      &xpath_ctxt)))\n        return NULL;\n\n    if (VIR_ALLOC(def) < 0)\n        return NULL;\n\n    if (!(node = virXPathNode(\"/source\", xpath_ctxt))) {\n        virReportError(VIR_ERR_XML_ERROR, \"%s\",\n                       _(\"root element was not source\"));\n        return NULL;\n    }\n\n    if (virStoragePoolDefParseSource(xpath_ctxt, def, pool_type,\n                                     node) < 0)\n        return NULL;\n\n    return g_steal_pointer(&def);\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"virvhba.h\"",
            "#include \"virlog.h\"",
            "#include \"virstring.h\"",
            "#include \"virscsihost.h\"",
            "#include \"virfile.h\"",
            "#include \"viralloc.h\"",
            "#include \"virbuffer.h\"",
            "#include \"viruuid.h\"",
            "#include \"virxml.h\"",
            "#include \"virstoragefile.h\"",
            "#include \"storage_conf.h\"",
            "#include \"storage_adapter_conf.h\"",
            "#include \"node_device_conf.h\"",
            "#include \"datatypes.h\"",
            "#include \"virerror.h\"",
            "#include <fcntl.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"virvhba.h\"\n#include \"virlog.h\"\n#include \"virstring.h\"\n#include \"virscsihost.h\"\n#include \"virfile.h\"\n#include \"viralloc.h\"\n#include \"virbuffer.h\"\n#include \"viruuid.h\"\n#include \"virxml.h\"\n#include \"virstoragefile.h\"\n#include \"storage_conf.h\"\n#include \"storage_adapter_conf.h\"\n#include \"node_device_conf.h\"\n#include \"datatypes.h\"\n#include \"virerror.h\"\n#include <fcntl.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <config.h>\n\nvirStoragePoolSourcePtr\nvirStoragePoolDefParseSourceString(const char *srcSpec,\n                                   int pool_type)\n{\n    g_autoptr(xmlDoc) doc = NULL;\n    xmlNodePtr node = NULL;\n    g_autoptr(xmlXPathContext) xpath_ctxt = NULL;\n    g_autoptr(virStoragePoolSource) def = NULL;\n\n    if (!(doc = virXMLParseStringCtxt(srcSpec,\n                                      _(\"(storage_source_specification)\"),\n                                      &xpath_ctxt)))\n        return NULL;\n\n    if (VIR_ALLOC(def) < 0)\n        return NULL;\n\n    if (!(node = virXPathNode(\"/source\", xpath_ctxt))) {\n        virReportError(VIR_ERR_XML_ERROR, \"%s\",\n                       _(\"root element was not source\"));\n        return NULL;\n    }\n\n    if (virStoragePoolDefParseSource(xpath_ctxt, def, pool_type,\n                                     node) < 0)\n        return NULL;\n\n    return g_steal_pointer(&def);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_INVALID_ARG",
            "\"%s\"",
            "_(\"hostname must be specified for iscsi sources\")"
          ],
          "line": 168
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virCheckFlags",
          "args": [
            "0",
            "NULL"
          ],
          "line": 165
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic char *\nvirStorageBackendISCSIFindPoolSources(const char *srcSpec,\n                                      unsigned int flags)\n{\n    size_t ntargets = 0;\n    char **targets = NULL;\n    char *ret = NULL;\n    size_t i;\n    virStoragePoolSourceList list = {\n        .type = VIR_STORAGE_POOL_ISCSI,\n        .nsources = 0,\n        .sources = NULL\n    };\n    g_autofree char *portal = NULL;\n    g_autoptr(virStoragePoolSource) source = NULL;\n\n    virCheckFlags(0, NULL);\n\n    if (!srcSpec) {\n        virReportError(VIR_ERR_INVALID_ARG, \"%s\",\n                       _(\"hostname must be specified for iscsi sources\"));\n        return NULL;\n    }\n\n    if (!(source = virStoragePoolDefParseSourceString(srcSpec,\n                                                      list.type)))\n        return NULL;\n\n    if (source->nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        goto cleanup;\n    }\n\n    if (!(portal = virStorageBackendISCSIPortal(source)))\n        goto cleanup;\n\n    if (virISCSIScanTargets(portal,\n                            source->initiator.iqn,\n                            false,\n                            &ntargets, &targets) < 0)\n        goto cleanup;\n\n    if (VIR_ALLOC_N(list.sources, ntargets) < 0)\n        goto cleanup;\n\n    for (i = 0; i < ntargets; i++) {\n        if (VIR_ALLOC_N(list.sources[i].devices, 1) < 0 ||\n            VIR_ALLOC_N(list.sources[i].hosts, 1) < 0)\n            goto cleanup;\n        list.sources[i].nhost = 1;\n        list.sources[i].hosts[0] = source->hosts[0];\n        list.sources[i].initiator = source->initiator;\n        list.sources[i].ndevice = 1;\n        list.sources[i].devices[0].path = targets[i];\n        list.nsources++;\n    }\n\n    if (!(ret = virStoragePoolSourceListFormat(&list)))\n        goto cleanup;\n\n cleanup:\n    if (list.sources) {\n        for (i = 0; i < ntargets; i++) {\n            VIR_FREE(list.sources[i].hosts);\n            VIR_FREE(list.sources[i].devices);\n        }\n        VIR_FREE(list.sources);\n    }\n    for (i = 0; i < ntargets; i++)\n        VIR_FREE(targets[i]);\n    VIR_FREE(targets);\n    return ret;\n}"
  },
  {
    "function_name": "virStorageBackendISCSIFindLUs",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "129-146",
    "snippet": "static int\nvirStorageBackendISCSIFindLUs(virStoragePoolObjPtr pool,\n                              const char *session)\n{\n    uint32_t host;\n    g_autofree char *sysfs_path = NULL;\n\n    sysfs_path = g_strdup_printf(\"/sys/class/iscsi_session/session%s/device\",\n                                 session);\n\n    if (virStorageBackendISCSIGetHostNumber(sysfs_path, &host) < 0)\n        return -1;\n\n    if (virStorageBackendSCSIFindLUs(pool, host) < 0)\n        return -1;\n\n    return 0;\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virStorageBackendSCSIFindLUs",
          "args": [
            "pool",
            "host"
          ],
          "line": 142
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendSCSIFindLUs",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_util.c",
          "lines": "3953-4002",
          "snippet": "int\nvirStorageBackendSCSIFindLUs(virStoragePoolObjPtr pool,\n                              uint32_t scanhost)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    int retval = 0;\n    uint32_t bus, target, lun;\n    const char *device_path = \"/sys/bus/scsi/devices\";\n    DIR *devicedir = NULL;\n    struct dirent *lun_dirent = NULL;\n    char devicepattern[64];\n    int found = 0;\n\n    VIR_DEBUG(\"Discovering LUs on host %u\", scanhost);\n\n    virWaitForDevices();\n\n    if (virDirOpen(&devicedir, device_path) < 0)\n        return -1;\n\n    g_snprintf(devicepattern, sizeof(devicepattern), \"%u:%%u:%%u:%%u\\n\", scanhost);\n\n    while ((retval = virDirRead(devicedir, &lun_dirent, device_path)) > 0) {\n        int rc;\n\n        if (sscanf(lun_dirent->d_name, devicepattern,\n                   &bus, &target, &lun) != 3) {\n            continue;\n        }\n\n        VIR_DEBUG(\"Found possible LU '%s'\", lun_dirent->d_name);\n\n        rc = processLU(pool, scanhost, bus, target, lun);\n        if (rc == -1) {\n            retval = -1;\n            break;\n        }\n        if (rc == 0)\n            found++;\n    }\n\n    VIR_DIR_CLOSE(devicedir);\n\n    if (retval < 0)\n        return -1;\n\n    VIR_DEBUG(\"Found %d LUs for pool %s\", found, def->name);\n\n    return found;\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"virfdstream.h\"",
            "#include \"virxml.h\"",
            "#include \"virstring.h\"",
            "#include \"virqemu.h\"",
            "#include \"virjson.h\"",
            "#include \"virfile.h\"",
            "#include \"virlog.h\"",
            "#include \"storage_util.h\"",
            "#include \"virstoragefile.h\"",
            "#include \"viruuid.h\"",
            "#include \"vircrypto.h\"",
            "#include \"virsecret.h\"",
            "#include \"secret_conf.h\"",
            "#include \"internal.h\"",
            "#include \"viralloc.h\"",
            "#include \"virerror.h\"",
            "#include \"datatypes.h\"",
            "# include <xfs/xfs.h>",
            "# include <linux/btrfs.h>",
            "# include <selinux/selinux.h>",
            "# include <blkid.h>",
            "# include <linux/fs.h>",
            "# include <sys/ioctl.h>",
            "#include <dirent.h>",
            "#include <sys/param.h>",
            "#include <sys/statvfs.h>",
            "#include <sys/stat.h>",
            "#include <fcntl.h>",
            "#include <unistd.h>",
            "#include <sys/types.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"virfdstream.h\"\n#include \"virxml.h\"\n#include \"virstring.h\"\n#include \"virqemu.h\"\n#include \"virjson.h\"\n#include \"virfile.h\"\n#include \"virlog.h\"\n#include \"storage_util.h\"\n#include \"virstoragefile.h\"\n#include \"viruuid.h\"\n#include \"vircrypto.h\"\n#include \"virsecret.h\"\n#include \"secret_conf.h\"\n#include \"internal.h\"\n#include \"viralloc.h\"\n#include \"virerror.h\"\n#include \"datatypes.h\"\n# include <xfs/xfs.h>\n# include <linux/btrfs.h>\n# include <selinux/selinux.h>\n# include <blkid.h>\n# include <linux/fs.h>\n# include <sys/ioctl.h>\n#include <dirent.h>\n#include <sys/param.h>\n#include <sys/statvfs.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <unistd.h>\n#include <sys/types.h>\n#include <config.h>\n\nint\nvirStorageBackendSCSIFindLUs(virStoragePoolObjPtr pool,\n                              uint32_t scanhost)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    int retval = 0;\n    uint32_t bus, target, lun;\n    const char *device_path = \"/sys/bus/scsi/devices\";\n    DIR *devicedir = NULL;\n    struct dirent *lun_dirent = NULL;\n    char devicepattern[64];\n    int found = 0;\n\n    VIR_DEBUG(\"Discovering LUs on host %u\", scanhost);\n\n    virWaitForDevices();\n\n    if (virDirOpen(&devicedir, device_path) < 0)\n        return -1;\n\n    g_snprintf(devicepattern, sizeof(devicepattern), \"%u:%%u:%%u:%%u\\n\", scanhost);\n\n    while ((retval = virDirRead(devicedir, &lun_dirent, device_path)) > 0) {\n        int rc;\n\n        if (sscanf(lun_dirent->d_name, devicepattern,\n                   &bus, &target, &lun) != 3) {\n            continue;\n        }\n\n        VIR_DEBUG(\"Found possible LU '%s'\", lun_dirent->d_name);\n\n        rc = processLU(pool, scanhost, bus, target, lun);\n        if (rc == -1) {\n            retval = -1;\n            break;\n        }\n        if (rc == 0)\n            found++;\n    }\n\n    VIR_DIR_CLOSE(devicedir);\n\n    if (retval < 0)\n        return -1;\n\n    VIR_DEBUG(\"Found %d LUs for pool %s\", found, def->name);\n\n    return found;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStorageBackendISCSIGetHostNumber",
          "args": [
            "sysfs_path",
            "&host"
          ],
          "line": 139
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageBackendISCSIGetHostNumber",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
          "lines": "88-127",
          "snippet": "static int\nvirStorageBackendISCSIGetHostNumber(const char *sysfs_path,\n                                    uint32_t *host)\n{\n    int ret = -1;\n    DIR *sysdir = NULL;\n    struct dirent *dirent = NULL;\n    int direrr;\n\n    VIR_DEBUG(\"Finding host number from '%s'\", sysfs_path);\n\n    virWaitForDevices();\n\n    if (virDirOpen(&sysdir, sysfs_path) < 0)\n        goto cleanup;\n\n    while ((direrr = virDirRead(sysdir, &dirent, sysfs_path)) > 0) {\n        if (STRPREFIX(dirent->d_name, \"target\")) {\n            if (sscanf(dirent->d_name, \"target%u:\", host) == 1) {\n                ret = 0;\n                goto cleanup;\n            } else {\n                virReportError(VIR_ERR_INTERNAL_ERROR,\n                               _(\"Failed to parse target '%s'\"), dirent->d_name);\n                goto cleanup;\n            }\n        }\n    }\n\n    if (direrr == 0) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Failed to get host number for iSCSI session \"\n                         \"with path '%s'\"), sysfs_path);\n        goto cleanup;\n    }\n\n cleanup:\n    VIR_DIR_CLOSE(sysdir);\n    return ret;\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"storage_util.h\"",
            "#include \"virsecret.h\"",
            "#include \"viruuid.h\"",
            "#include \"virstring.h\"",
            "#include \"virobject.h\"",
            "#include \"virlog.h\"",
            "#include \"viriscsi.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"storage_backend_iscsi.h\"",
            "#include \"driver.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <unistd.h>",
            "#include <fcntl.h>",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic int\nvirStorageBackendISCSIGetHostNumber(const char *sysfs_path,\n                                    uint32_t *host)\n{\n    int ret = -1;\n    DIR *sysdir = NULL;\n    struct dirent *dirent = NULL;\n    int direrr;\n\n    VIR_DEBUG(\"Finding host number from '%s'\", sysfs_path);\n\n    virWaitForDevices();\n\n    if (virDirOpen(&sysdir, sysfs_path) < 0)\n        goto cleanup;\n\n    while ((direrr = virDirRead(sysdir, &dirent, sysfs_path)) > 0) {\n        if (STRPREFIX(dirent->d_name, \"target\")) {\n            if (sscanf(dirent->d_name, \"target%u:\", host) == 1) {\n                ret = 0;\n                goto cleanup;\n            } else {\n                virReportError(VIR_ERR_INTERNAL_ERROR,\n                               _(\"Failed to parse target '%s'\"), dirent->d_name);\n                goto cleanup;\n            }\n        }\n    }\n\n    if (direrr == 0) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Failed to get host number for iSCSI session \"\n                         \"with path '%s'\"), sysfs_path);\n        goto cleanup;\n    }\n\n cleanup:\n    VIR_DIR_CLOSE(sysdir);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "g_strdup_printf",
          "args": [
            "\"/sys/class/iscsi_session/session%s/device\"",
            "session"
          ],
          "line": 136
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic int\nvirStorageBackendISCSIFindLUs(virStoragePoolObjPtr pool,\n                              const char *session)\n{\n    uint32_t host;\n    g_autofree char *sysfs_path = NULL;\n\n    sysfs_path = g_strdup_printf(\"/sys/class/iscsi_session/session%s/device\",\n                                 session);\n\n    if (virStorageBackendISCSIGetHostNumber(sysfs_path, &host) < 0)\n        return -1;\n\n    if (virStorageBackendSCSIFindLUs(pool, host) < 0)\n        return -1;\n\n    return 0;\n}"
  },
  {
    "function_name": "virStorageBackendISCSIGetHostNumber",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "88-127",
    "snippet": "static int\nvirStorageBackendISCSIGetHostNumber(const char *sysfs_path,\n                                    uint32_t *host)\n{\n    int ret = -1;\n    DIR *sysdir = NULL;\n    struct dirent *dirent = NULL;\n    int direrr;\n\n    VIR_DEBUG(\"Finding host number from '%s'\", sysfs_path);\n\n    virWaitForDevices();\n\n    if (virDirOpen(&sysdir, sysfs_path) < 0)\n        goto cleanup;\n\n    while ((direrr = virDirRead(sysdir, &dirent, sysfs_path)) > 0) {\n        if (STRPREFIX(dirent->d_name, \"target\")) {\n            if (sscanf(dirent->d_name, \"target%u:\", host) == 1) {\n                ret = 0;\n                goto cleanup;\n            } else {\n                virReportError(VIR_ERR_INTERNAL_ERROR,\n                               _(\"Failed to parse target '%s'\"), dirent->d_name);\n                goto cleanup;\n            }\n        }\n    }\n\n    if (direrr == 0) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Failed to get host number for iSCSI session \"\n                         \"with path '%s'\"), sysfs_path);\n        goto cleanup;\n    }\n\n cleanup:\n    VIR_DIR_CLOSE(sysdir);\n    return ret;\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "VIR_DIR_CLOSE",
          "args": [
            "sysdir"
          ],
          "line": 125
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_INTERNAL_ERROR",
            "_(\"Failed to get host number for iSCSI session \"\n                         \"with path '%s'\")",
            "sysfs_path"
          ],
          "line": 118
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"Failed to get host number for iSCSI session \"\n                         \"with path '%s'\""
          ],
          "line": 119
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_INTERNAL_ERROR",
            "_(\"Failed to parse target '%s'\")",
            "dirent->d_name"
          ],
          "line": 110
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sscanf",
          "args": [
            "dirent->d_name",
            "\"target%u:\"",
            "host"
          ],
          "line": 106
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "STRPREFIX",
          "args": [
            "dirent->d_name",
            "\"target\""
          ],
          "line": 105
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virDirRead",
          "args": [
            "sysdir",
            "&dirent",
            "sysfs_path"
          ],
          "line": 104
        },
        "resolved": true,
        "details": {
          "function_name": "virDirRead",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virfile.c",
          "lines": "2940-2954",
          "snippet": "int virDirRead(DIR *dirp, struct dirent **ent, const char *name)\n{\n    do {\n        errno = 0;\n        *ent = readdir(dirp); /* exempt from syntax-check */\n        if (!*ent && errno) {\n            if (name)\n                virReportSystemError(errno, _(\"Unable to read directory '%s'\"),\n                                     name);\n            return -1;\n        }\n    } while (*ent && (STREQ((*ent)->d_name, \".\") ||\n                      STREQ((*ent)->d_name, \"..\")));\n    return !!*ent;\n}",
          "includes": [
            "#include \"virsocket.h\"",
            "#include \"virutil.h\"",
            "#include \"virstring.h\"",
            "#include \"virprocess.h\"",
            "#include \"virlog.h\"",
            "#include \"virkmod.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"configmake.h\"",
            "# include <sys/xattr.h>",
            "# include <linux/cdrom.h>",
            "# include <sys/ioctl.h>",
            "#  include <linux/loop.h>",
            "# include <sys/statfs.h>",
            "#  include <linux/magic.h>",
            "#include <sys/file.h>",
            "# include <sys/acl.h>",
            "# include <sys/syscall.h>",
            "# include <sys/mman.h>",
            "# include <mntent.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "# include <sys/mount.h>",
            "#include <sys/stat.h>",
            "# include <libutil.h>",
            "# include <util.h>",
            "# include <pty.h>",
            "# include <termios.h>",
            "#include <fcntl.h>",
            "#include \"internal.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virsocket.h\"\n#include \"virutil.h\"\n#include \"virstring.h\"\n#include \"virprocess.h\"\n#include \"virlog.h\"\n#include \"virkmod.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"configmake.h\"\n# include <sys/xattr.h>\n# include <linux/cdrom.h>\n# include <sys/ioctl.h>\n#  include <linux/loop.h>\n# include <sys/statfs.h>\n#  include <linux/magic.h>\n#include <sys/file.h>\n# include <sys/acl.h>\n# include <sys/syscall.h>\n# include <sys/mman.h>\n# include <mntent.h>\n#include <dirent.h>\n#include <unistd.h>\n# include <sys/mount.h>\n#include <sys/stat.h>\n# include <libutil.h>\n# include <util.h>\n# include <pty.h>\n# include <termios.h>\n#include <fcntl.h>\n#include \"internal.h\"\n#include <config.h>\n\nint virDirRead(DIR *dirp, struct dirent **ent, const char *name)\n{\n    do {\n        errno = 0;\n        *ent = readdir(dirp); /* exempt from syntax-check */\n        if (!*ent && errno) {\n            if (name)\n                virReportSystemError(errno, _(\"Unable to read directory '%s'\"),\n                                     name);\n            return -1;\n        }\n    } while (*ent && (STREQ((*ent)->d_name, \".\") ||\n                      STREQ((*ent)->d_name, \"..\")));\n    return !!*ent;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virDirOpen",
          "args": [
            "&sysdir",
            "sysfs_path"
          ],
          "line": 101
        },
        "resolved": true,
        "details": {
          "function_name": "virDirOpenQuiet",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virfile.c",
          "lines": "2914-2918",
          "snippet": "int\nvirDirOpenQuiet(DIR **dirp, const char *name)\n{\n    return virDirOpenInternal(dirp, name, false, true);\n}",
          "includes": [
            "#include \"virsocket.h\"",
            "#include \"virutil.h\"",
            "#include \"virstring.h\"",
            "#include \"virprocess.h\"",
            "#include \"virlog.h\"",
            "#include \"virkmod.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"configmake.h\"",
            "# include <sys/xattr.h>",
            "# include <linux/cdrom.h>",
            "# include <sys/ioctl.h>",
            "#  include <linux/loop.h>",
            "# include <sys/statfs.h>",
            "#  include <linux/magic.h>",
            "#include <sys/file.h>",
            "# include <sys/acl.h>",
            "# include <sys/syscall.h>",
            "# include <sys/mman.h>",
            "# include <mntent.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "# include <sys/mount.h>",
            "#include <sys/stat.h>",
            "# include <libutil.h>",
            "# include <util.h>",
            "# include <pty.h>",
            "# include <termios.h>",
            "#include <fcntl.h>",
            "#include \"internal.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virsocket.h\"\n#include \"virutil.h\"\n#include \"virstring.h\"\n#include \"virprocess.h\"\n#include \"virlog.h\"\n#include \"virkmod.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"configmake.h\"\n# include <sys/xattr.h>\n# include <linux/cdrom.h>\n# include <sys/ioctl.h>\n#  include <linux/loop.h>\n# include <sys/statfs.h>\n#  include <linux/magic.h>\n#include <sys/file.h>\n# include <sys/acl.h>\n# include <sys/syscall.h>\n# include <sys/mman.h>\n# include <mntent.h>\n#include <dirent.h>\n#include <unistd.h>\n# include <sys/mount.h>\n#include <sys/stat.h>\n# include <libutil.h>\n# include <util.h>\n# include <pty.h>\n# include <termios.h>\n#include <fcntl.h>\n#include \"internal.h\"\n#include <config.h>\n\nint\nvirDirOpenQuiet(DIR **dirp, const char *name)\n{\n    return virDirOpenInternal(dirp, name, false, true);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virWaitForDevices",
          "args": [],
          "line": 99
        },
        "resolved": true,
        "details": {
          "function_name": "virWaitForDevices",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virutil.c",
          "lines": "1324-1341",
          "snippet": "void virWaitForDevices(void)\n{\n    g_autoptr(virCommand) cmd = NULL;\n    g_autofree char *udev = NULL;\n    int exitstatus;\n\n    if (!(udev = virFindFileInPath(UDEVADM)))\n        return;\n\n    if (!(cmd = virCommandNewArgList(udev, \"settle\", NULL)))\n        return;\n\n    /*\n     * NOTE: we ignore errors here; this is just to make sure that any device\n     * nodes that are being created finish before we try to scan them.\n     */\n    ignore_value(virCommandRun(cmd, &exitstatus));\n}",
          "includes": [
            "#include \"virsocket.h\"",
            "#include \"virutil.h\"",
            "#include \"virstring.h\"",
            "#include \"virprocess.h\"",
            "#include \"vircommand.h\"",
            "#include \"virfile.h\"",
            "#include \"viralloc.h\"",
            "#include \"virbuffer.h\"",
            "#include \"virlog.h\"",
            "#include \"virerror.h\"",
            "# include <sys/prctl.h>",
            "# include <cap-ng.h>",
            "# include <grp.h>",
            "# include <pwd.h>",
            "# include <libdevmapper.h>",
            "#include <sys/types.h>",
            "# include <sys/sysmacros.h>",
            "# include <conio.h>",
            "#include <sys/stat.h>",
            "#include <fcntl.h>",
            "#include <unistd.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virsocket.h\"\n#include \"virutil.h\"\n#include \"virstring.h\"\n#include \"virprocess.h\"\n#include \"vircommand.h\"\n#include \"virfile.h\"\n#include \"viralloc.h\"\n#include \"virbuffer.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n# include <sys/prctl.h>\n# include <cap-ng.h>\n# include <grp.h>\n# include <pwd.h>\n# include <libdevmapper.h>\n#include <sys/types.h>\n# include <sys/sysmacros.h>\n# include <conio.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <unistd.h>\n#include <config.h>\n\nvoid virWaitForDevices(void)\n{\n    g_autoptr(virCommand) cmd = NULL;\n    g_autofree char *udev = NULL;\n    int exitstatus;\n\n    if (!(udev = virFindFileInPath(UDEVADM)))\n        return;\n\n    if (!(cmd = virCommandNewArgList(udev, \"settle\", NULL)))\n        return;\n\n    /*\n     * NOTE: we ignore errors here; this is just to make sure that any device\n     * nodes that are being created finish before we try to scan them.\n     */\n    ignore_value(virCommandRun(cmd, &exitstatus));\n}"
        }
      },
      {
        "call_info": {
          "callee": "VIR_DEBUG",
          "args": [
            "\"Finding host number from '%s'\"",
            "sysfs_path"
          ],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic int\nvirStorageBackendISCSIGetHostNumber(const char *sysfs_path,\n                                    uint32_t *host)\n{\n    int ret = -1;\n    DIR *sysdir = NULL;\n    struct dirent *dirent = NULL;\n    int direrr;\n\n    VIR_DEBUG(\"Finding host number from '%s'\", sysfs_path);\n\n    virWaitForDevices();\n\n    if (virDirOpen(&sysdir, sysfs_path) < 0)\n        goto cleanup;\n\n    while ((direrr = virDirRead(sysdir, &dirent, sysfs_path)) > 0) {\n        if (STRPREFIX(dirent->d_name, \"target\")) {\n            if (sscanf(dirent->d_name, \"target%u:\", host) == 1) {\n                ret = 0;\n                goto cleanup;\n            } else {\n                virReportError(VIR_ERR_INTERNAL_ERROR,\n                               _(\"Failed to parse target '%s'\"), dirent->d_name);\n                goto cleanup;\n            }\n        }\n    }\n\n    if (direrr == 0) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Failed to get host number for iSCSI session \"\n                         \"with path '%s'\"), sysfs_path);\n        goto cleanup;\n    }\n\n cleanup:\n    VIR_DIR_CLOSE(sysdir);\n    return ret;\n}"
  },
  {
    "function_name": "virStorageBackendISCSISession",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "79-85",
    "snippet": "static char *\nvirStorageBackendISCSISession(virStoragePoolObjPtr pool,\n                              bool probe)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    return virISCSIGetSession(def->source.devices[0].path, probe);\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virISCSIGetSession",
          "args": [
            "def->source.devices[0].path",
            "probe"
          ],
          "line": 84
        },
        "resolved": true,
        "details": {
          "function_name": "virISCSIGetSession",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/viriscsi.c",
          "lines": "69-111",
          "snippet": "char *\nvirISCSIGetSession(const char *devpath,\n                   bool probe)\n{\n    /*\n     * # iscsiadm --mode session\n     * tcp: [1] 192.168.122.170:3260,1 demo-tgt-b\n     * tcp: [2] 192.168.122.170:3260,1 demo-tgt-a\n     *\n     * Pull out 2nd and 4th fields\n     */\n    const char *regexes[] = {\n        \"^tcp:\\\\s+\\\\[(\\\\S+)\\\\]\\\\s+\\\\S+\\\\s+(\\\\S+).*$\"\n    };\n    int vars[] = {\n        2,\n    };\n    struct virISCSISessionData cbdata = {\n        .session = NULL,\n        .devpath = devpath,\n    };\n    int exitstatus = 0;\n    g_autofree char *error = NULL;\n\n    g_autoptr(virCommand) cmd = virCommandNewArgList(ISCSIADM, \"--mode\",\n                                                       \"session\", NULL);\n    virCommandSetErrorBuffer(cmd, &error);\n\n    if (virCommandRunRegex(cmd,\n                           1,\n                           regexes,\n                           vars,\n                           virISCSIExtractSession,\n                           &cbdata, NULL, &exitstatus) < 0)\n        return NULL;\n\n    if (cbdata.session == NULL && !probe)\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"cannot find iscsiadm session: %s\"),\n                       NULLSTR(error));\n\n    return cbdata.session;\n}",
          "includes": [
            "#include \"virstring.h\"",
            "#include \"virrandom.h\"",
            "#include \"virlog.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"viriscsi.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virstring.h\"\n#include \"virrandom.h\"\n#include \"virlog.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"viriscsi.h\"\n#include <config.h>\n\nchar *\nvirISCSIGetSession(const char *devpath,\n                   bool probe)\n{\n    /*\n     * # iscsiadm --mode session\n     * tcp: [1] 192.168.122.170:3260,1 demo-tgt-b\n     * tcp: [2] 192.168.122.170:3260,1 demo-tgt-a\n     *\n     * Pull out 2nd and 4th fields\n     */\n    const char *regexes[] = {\n        \"^tcp:\\\\s+\\\\[(\\\\S+)\\\\]\\\\s+\\\\S+\\\\s+(\\\\S+).*$\"\n    };\n    int vars[] = {\n        2,\n    };\n    struct virISCSISessionData cbdata = {\n        .session = NULL,\n        .devpath = devpath,\n    };\n    int exitstatus = 0;\n    g_autofree char *error = NULL;\n\n    g_autoptr(virCommand) cmd = virCommandNewArgList(ISCSIADM, \"--mode\",\n                                                       \"session\", NULL);\n    virCommandSetErrorBuffer(cmd, &error);\n\n    if (virCommandRunRegex(cmd,\n                           1,\n                           regexes,\n                           vars,\n                           virISCSIExtractSession,\n                           &cbdata, NULL, &exitstatus) < 0)\n        return NULL;\n\n    if (cbdata.session == NULL && !probe)\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"cannot find iscsiadm session: %s\"),\n                       NULLSTR(error));\n\n    return cbdata.session;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virStoragePoolObjGetDef",
          "args": [
            "pool"
          ],
          "line": 83
        },
        "resolved": true,
        "details": {
          "function_name": "virStoragePoolObjGetDef",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/conf/virstorageobj.c",
          "lines": "246-250",
          "snippet": "virStoragePoolDefPtr\nvirStoragePoolObjGetDef(virStoragePoolObjPtr obj)\n{\n    return obj->def;\n}",
          "includes": [
            "#include \"virvhba.h\"",
            "#include \"virstring.h\"",
            "#include \"virscsihost.h\"",
            "#include \"virlog.h\"",
            "#include \"virhash.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"viralloc.h\"",
            "#include \"virstorageobj.h\"",
            "#include \"node_device_util.h\"",
            "#include \"node_device_conf.h\"",
            "#include \"datatypes.h\"",
            "#include <dirent.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virvhba.h\"\n#include \"virstring.h\"\n#include \"virscsihost.h\"\n#include \"virlog.h\"\n#include \"virhash.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"viralloc.h\"\n#include \"virstorageobj.h\"\n#include \"node_device_util.h\"\n#include \"node_device_conf.h\"\n#include \"datatypes.h\"\n#include <dirent.h>\n#include <config.h>\n\nvirStoragePoolDefPtr\nvirStoragePoolObjGetDef(virStoragePoolObjPtr obj)\n{\n    return obj->def;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\nstatic char *\nvirStorageBackendISCSISession(virStoragePoolObjPtr pool,\n                              bool probe)\n{\n    virStoragePoolDefPtr def = virStoragePoolObjGetDef(pool);\n    return virISCSIGetSession(def->source.devices[0].path, probe);\n}"
  },
  {
    "function_name": "virStorageBackendISCSIPortal",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/storage/storage_backend_iscsi.c",
    "lines": "51-76",
    "snippet": "static char *\nvirStorageBackendISCSIPortal(virStoragePoolSourcePtr source)\n{\n    char *portal = NULL;\n\n    if (source->nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return NULL;\n    }\n\n    if (source->hosts[0].port == 0)\n        source->hosts[0].port = ISCSI_DEFAULT_TARGET_PORT;\n\n    if (strchr(source->hosts[0].name, ':')) {\n        portal = g_strdup_printf(\"[%s]:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    } else {\n        portal = g_strdup_printf(\"%s:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    }\n\n    return portal;\n}",
    "includes": [
      "#include \"virutil.h\"",
      "#include \"storage_util.h\"",
      "#include \"virsecret.h\"",
      "#include \"viruuid.h\"",
      "#include \"virstring.h\"",
      "#include \"virobject.h\"",
      "#include \"virlog.h\"",
      "#include \"viriscsi.h\"",
      "#include \"virfile.h\"",
      "#include \"virerror.h\"",
      "#include \"vircommand.h\"",
      "#include \"viralloc.h\"",
      "#include \"storage_backend_iscsi.h\"",
      "#include \"driver.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <unistd.h>",
      "#include <fcntl.h>",
      "#include <dirent.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define ISCSI_DEFAULT_TARGET_PORT 3260"
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "g_strdup_printf",
          "args": [
            "\"%s:%d,1\"",
            "source->hosts[0].name",
            "source->hosts[0].port"
          ],
          "line": 70
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "strchr",
          "args": [
            "source->hosts[0].name",
            "':'"
          ],
          "line": 65
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_CONFIG_UNSUPPORTED",
            "\"%s\"",
            "_(\"Expected exactly 1 host for the storage pool\")"
          ],
          "line": 57
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virutil.h\"\n#include \"storage_util.h\"\n#include \"virsecret.h\"\n#include \"viruuid.h\"\n#include \"virstring.h\"\n#include \"virobject.h\"\n#include \"virlog.h\"\n#include \"viriscsi.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"storage_backend_iscsi.h\"\n#include \"driver.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <dirent.h>\n#include <config.h>\n\n#define ISCSI_DEFAULT_TARGET_PORT 3260\n\nstatic char *\nvirStorageBackendISCSIPortal(virStoragePoolSourcePtr source)\n{\n    char *portal = NULL;\n\n    if (source->nhost != 1) {\n        virReportError(VIR_ERR_CONFIG_UNSUPPORTED, \"%s\",\n                       _(\"Expected exactly 1 host for the storage pool\"));\n        return NULL;\n    }\n\n    if (source->hosts[0].port == 0)\n        source->hosts[0].port = ISCSI_DEFAULT_TARGET_PORT;\n\n    if (strchr(source->hosts[0].name, ':')) {\n        portal = g_strdup_printf(\"[%s]:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    } else {\n        portal = g_strdup_printf(\"%s:%d,1\",\n                                 source->hosts[0].name,\n                                 source->hosts[0].port);\n    }\n\n    return portal;\n}"
  }
]