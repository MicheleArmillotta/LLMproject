[
  {
    "function_name": "virStorageFileBackendForType",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virstoragefilebackend.c",
    "lines": "108-147",
    "snippet": "int\nvirStorageFileBackendForType(int type,\n                             int protocol,\n                             bool required,\n                             virStorageFileBackendPtr *backend)\n{\n    size_t i;\n\n    *backend = NULL;\n\n    if (virStorageFileBackendInitialize() < 0)\n        return -1;\n\n    for (i = 0; i < virStorageFileBackendsCount; i++) {\n        if (virStorageFileBackends[i]->type == type) {\n            if (type == VIR_STORAGE_TYPE_NETWORK &&\n                virStorageFileBackends[i]->protocol != protocol)\n                continue;\n\n            *backend = virStorageFileBackends[i];\n            return 0;\n        }\n    }\n\n    if (!required)\n        return 0;\n\n    if (type == VIR_STORAGE_TYPE_NETWORK) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"missing storage backend for network files \"\n                         \"using %s protocol\"),\n                       virStorageNetProtocolTypeToString(protocol));\n    } else {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"missing storage backend for '%s' storage\"),\n                       virStorageTypeToString(type));\n    }\n\n    return -1;\n}",
    "includes": [
      "#include \"configmake.h\"",
      "#include \"virfile.h\"",
      "#include \"virmodule.h\"",
      "#include \"virlog.h\"",
      "#include \"virstoragefilebackend.h\"",
      "#include \"internal.h\"",
      "#include \"viralloc.h\"",
      "#include \"virerror.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [
      "static virStorageFileBackendPtr virStorageFileBackends[VIR_STORAGE_BACKENDS_MAX];",
      "static size_t virStorageFileBackendsCount;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_INTERNAL_ERROR",
            "_(\"missing storage backend for '%s' storage\")",
            "virStorageTypeToString(type)"
          ],
          "line": 141
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virStorageTypeToString",
          "args": [
            "type"
          ],
          "line": 143
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"missing storage backend for '%s' storage\""
          ],
          "line": 142
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_INTERNAL_ERROR",
            "_(\"missing storage backend for network files \"\n                         \"using %s protocol\")",
            "virStorageNetProtocolTypeToString(protocol)"
          ],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virStorageNetProtocolTypeToString",
          "args": [
            "protocol"
          ],
          "line": 139
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virStorageFileBackendInitialize",
          "args": [],
          "line": 118
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"configmake.h\"\n#include \"virfile.h\"\n#include \"virmodule.h\"\n#include \"virlog.h\"\n#include \"virstoragefilebackend.h\"\n#include \"internal.h\"\n#include \"viralloc.h\"\n#include \"virerror.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <config.h>\n\nstatic virStorageFileBackendPtr virStorageFileBackends[VIR_STORAGE_BACKENDS_MAX];\nstatic size_t virStorageFileBackendsCount;\n\nint\nvirStorageFileBackendForType(int type,\n                             int protocol,\n                             bool required,\n                             virStorageFileBackendPtr *backend)\n{\n    size_t i;\n\n    *backend = NULL;\n\n    if (virStorageFileBackendInitialize() < 0)\n        return -1;\n\n    for (i = 0; i < virStorageFileBackendsCount; i++) {\n        if (virStorageFileBackends[i]->type == type) {\n            if (type == VIR_STORAGE_TYPE_NETWORK &&\n                virStorageFileBackends[i]->protocol != protocol)\n                continue;\n\n            *backend = virStorageFileBackends[i];\n            return 0;\n        }\n    }\n\n    if (!required)\n        return 0;\n\n    if (type == VIR_STORAGE_TYPE_NETWORK) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"missing storage backend for network files \"\n                         \"using %s protocol\"),\n                       virStorageNetProtocolTypeToString(protocol));\n    } else {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"missing storage backend for '%s' storage\"),\n                       virStorageTypeToString(type));\n    }\n\n    return -1;\n}"
  },
  {
    "function_name": "virStorageFileBackendRegister",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virstoragefilebackend.c",
    "lines": "88-106",
    "snippet": "int\nvirStorageFileBackendRegister(virStorageFileBackendPtr backend)\n{\n    VIR_DEBUG(\"Registering storage file backend '%s' protocol '%s'\",\n              virStorageTypeToString(backend->type),\n              virStorageNetProtocolTypeToString(backend->protocol));\n\n    if (virStorageFileBackendsCount >= VIR_STORAGE_BACKENDS_MAX) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Too many drivers, cannot register storage file \"\n                         \"backend '%s'\"),\n                       virStorageTypeToString(backend->type));\n        return -1;\n    }\n\n    virStorageFileBackends[virStorageFileBackendsCount] = backend;\n    virStorageFileBackendsCount++;\n    return 0;\n}",
    "includes": [
      "#include \"configmake.h\"",
      "#include \"virfile.h\"",
      "#include \"virmodule.h\"",
      "#include \"virlog.h\"",
      "#include \"virstoragefilebackend.h\"",
      "#include \"internal.h\"",
      "#include \"viralloc.h\"",
      "#include \"virerror.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <config.h>"
    ],
    "macros_used": [
      "#define VIR_STORAGE_BACKENDS_MAX 20"
    ],
    "globals_used": [
      "static virStorageFileBackendPtr virStorageFileBackends[VIR_STORAGE_BACKENDS_MAX];",
      "static size_t virStorageFileBackendsCount;"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_INTERNAL_ERROR",
            "_(\"Too many drivers, cannot register storage file \"\n                         \"backend '%s'\")",
            "virStorageTypeToString(backend->type)"
          ],
          "line": 96
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virStorageTypeToString",
          "args": [
            "backend->type"
          ],
          "line": 99
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"Too many drivers, cannot register storage file \"\n                         \"backend '%s'\""
          ],
          "line": 97
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "VIR_DEBUG",
          "args": [
            "\"Registering storage file backend '%s' protocol '%s'\"",
            "virStorageTypeToString(backend->type)",
            "virStorageNetProtocolTypeToString(backend->protocol)"
          ],
          "line": 91
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virStorageNetProtocolTypeToString",
          "args": [
            "backend->protocol"
          ],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virStorageTypeToString",
          "args": [
            "backend->type"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"configmake.h\"\n#include \"virfile.h\"\n#include \"virmodule.h\"\n#include \"virlog.h\"\n#include \"virstoragefilebackend.h\"\n#include \"internal.h\"\n#include \"viralloc.h\"\n#include \"virerror.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <config.h>\n\n#define VIR_STORAGE_BACKENDS_MAX 20\n\nstatic virStorageFileBackendPtr virStorageFileBackends[VIR_STORAGE_BACKENDS_MAX];\nstatic size_t virStorageFileBackendsCount;\n\nint\nvirStorageFileBackendRegister(virStorageFileBackendPtr backend)\n{\n    VIR_DEBUG(\"Registering storage file backend '%s' protocol '%s'\",\n              virStorageTypeToString(backend->type),\n              virStorageNetProtocolTypeToString(backend->protocol));\n\n    if (virStorageFileBackendsCount >= VIR_STORAGE_BACKENDS_MAX) {\n        virReportError(VIR_ERR_INTERNAL_ERROR,\n                       _(\"Too many drivers, cannot register storage file \"\n                         \"backend '%s'\"),\n                       virStorageTypeToString(backend->type));\n        return -1;\n    }\n\n    virStorageFileBackends[virStorageFileBackendsCount] = backend;\n    virStorageFileBackendsCount++;\n    return 0;\n}"
  },
  {
    "function_name": "virStorageFileBackendOnceInit",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virstoragefilebackend.c",
    "lines": "73-84",
    "snippet": "static int virStorageFileBackendOnceInit(void)\n{\n#if WITH_STORAGE_DIR || WITH_STORAGE_FS\n    if (virStorageFileLoadBackendModule(\"fs\", \"virStorageFileFsRegister\", false) < 0)\n        return -1;\n#endif /* WITH_STORAGE_DIR || WITH_STORAGE_FS */\n#if WITH_STORAGE_GLUSTER\n    if (virStorageFileLoadBackendModule(\"gluster\", \"virStorageFileGlusterRegister\", false) < 0)\n        return -1;\n#endif /* WITH_STORAGE_GLUSTER */\n    return 0;\n}",
    "includes": [
      "#include \"configmake.h\"",
      "#include \"virfile.h\"",
      "#include \"virmodule.h\"",
      "#include \"virlog.h\"",
      "#include \"virstoragefilebackend.h\"",
      "#include \"internal.h\"",
      "#include \"viralloc.h\"",
      "#include \"virerror.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virStorageFileLoadBackendModule",
          "args": [
            "\"gluster\"",
            "\"virStorageFileGlusterRegister\"",
            "false"
          ],
          "line": 80
        },
        "resolved": true,
        "details": {
          "function_name": "virStorageFileLoadBackendModule",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virstoragefilebackend.c",
          "lines": "49-70",
          "snippet": "static int\nvirStorageFileLoadBackendModule(const char *name,\n                                const char *regfunc,\n                                bool forceload)\n{\n    char *modfile = NULL;\n    int ret;\n\n    if (!(modfile = virFileFindResourceFull(name,\n                                            \"libvirt_storage_file_\",\n                                            \".so\",\n                                            abs_top_builddir \"/src/.libs\",\n                                            STORAGE_FILE_MODULE_DIR,\n                                            \"LIBVIRT_STORAGE_FILE_DIR\")))\n        return -1;\n\n    ret = virModuleLoad(modfile, regfunc, forceload);\n\n    VIR_FREE(modfile);\n\n    return ret;\n}",
          "includes": [
            "#include \"configmake.h\"",
            "#include \"virfile.h\"",
            "#include \"virmodule.h\"",
            "#include \"virlog.h\"",
            "#include \"virstoragefilebackend.h\"",
            "#include \"internal.h\"",
            "#include \"viralloc.h\"",
            "#include \"virerror.h\"",
            "#include \"datatypes.h\"",
            "#include <sys/stat.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"configmake.h\"\n#include \"virfile.h\"\n#include \"virmodule.h\"\n#include \"virlog.h\"\n#include \"virstoragefilebackend.h\"\n#include \"internal.h\"\n#include \"viralloc.h\"\n#include \"virerror.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <config.h>\n\nstatic int\nvirStorageFileLoadBackendModule(const char *name,\n                                const char *regfunc,\n                                bool forceload)\n{\n    char *modfile = NULL;\n    int ret;\n\n    if (!(modfile = virFileFindResourceFull(name,\n                                            \"libvirt_storage_file_\",\n                                            \".so\",\n                                            abs_top_builddir \"/src/.libs\",\n                                            STORAGE_FILE_MODULE_DIR,\n                                            \"LIBVIRT_STORAGE_FILE_DIR\")))\n        return -1;\n\n    ret = virModuleLoad(modfile, regfunc, forceload);\n\n    VIR_FREE(modfile);\n\n    return ret;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"configmake.h\"\n#include \"virfile.h\"\n#include \"virmodule.h\"\n#include \"virlog.h\"\n#include \"virstoragefilebackend.h\"\n#include \"internal.h\"\n#include \"viralloc.h\"\n#include \"virerror.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <config.h>\n\nstatic int virStorageFileBackendOnceInit(void)\n{\n#if WITH_STORAGE_DIR || WITH_STORAGE_FS\n    if (virStorageFileLoadBackendModule(\"fs\", \"virStorageFileFsRegister\", false) < 0)\n        return -1;\n#endif /* WITH_STORAGE_DIR || WITH_STORAGE_FS */\n#if WITH_STORAGE_GLUSTER\n    if (virStorageFileLoadBackendModule(\"gluster\", \"virStorageFileGlusterRegister\", false) < 0)\n        return -1;\n#endif /* WITH_STORAGE_GLUSTER */\n    return 0;\n}"
  },
  {
    "function_name": "virStorageFileLoadBackendModule",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virstoragefilebackend.c",
    "lines": "49-70",
    "snippet": "static int\nvirStorageFileLoadBackendModule(const char *name,\n                                const char *regfunc,\n                                bool forceload)\n{\n    char *modfile = NULL;\n    int ret;\n\n    if (!(modfile = virFileFindResourceFull(name,\n                                            \"libvirt_storage_file_\",\n                                            \".so\",\n                                            abs_top_builddir \"/src/.libs\",\n                                            STORAGE_FILE_MODULE_DIR,\n                                            \"LIBVIRT_STORAGE_FILE_DIR\")))\n        return -1;\n\n    ret = virModuleLoad(modfile, regfunc, forceload);\n\n    VIR_FREE(modfile);\n\n    return ret;\n}",
    "includes": [
      "#include \"configmake.h\"",
      "#include \"virfile.h\"",
      "#include \"virmodule.h\"",
      "#include \"virlog.h\"",
      "#include \"virstoragefilebackend.h\"",
      "#include \"internal.h\"",
      "#include \"viralloc.h\"",
      "#include \"virerror.h\"",
      "#include \"datatypes.h\"",
      "#include <sys/stat.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "VIR_FREE",
          "args": [
            "modfile"
          ],
          "line": 67
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virModuleLoad",
          "args": [
            "modfile",
            "regfunc",
            "forceload"
          ],
          "line": 65
        },
        "resolved": true,
        "details": {
          "function_name": "virModuleLoad",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virmodule.c",
          "lines": "145-162",
          "snippet": "int\nvirModuleLoad(const char *path,\n              const char *regfunc G_GNUC_UNUSED,\n              bool required)\n{\n    VIR_DEBUG(\"dlopen not available on this platform\");\n    if (required) {\n        virReportSystemError(ENOSYS,\n                             _(\"Failed to find module '%s'\"), path);\n        return -1;\n    } else {\n        /* Since we have no dlopen(), but definition we have no\n         * loadable modules on disk, so we can reasonably\n         * return '1' instead of an error.\n         */\n        return 1;\n    }\n}",
          "includes": [
            "# include <dlfcn.h>",
            "#include \"virutil.h\"",
            "#include \"virlog.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"virmodule.h\"",
            "#include \"internal.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "# include <dlfcn.h>\n#include \"virutil.h\"\n#include \"virlog.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"virmodule.h\"\n#include \"internal.h\"\n#include <config.h>\n\nint\nvirModuleLoad(const char *path,\n              const char *regfunc G_GNUC_UNUSED,\n              bool required)\n{\n    VIR_DEBUG(\"dlopen not available on this platform\");\n    if (required) {\n        virReportSystemError(ENOSYS,\n                             _(\"Failed to find module '%s'\"), path);\n        return -1;\n    } else {\n        /* Since we have no dlopen(), but definition we have no\n         * loadable modules on disk, so we can reasonably\n         * return '1' instead of an error.\n         */\n        return 1;\n    }\n}"
        }
      },
      {
        "call_info": {
          "callee": "virFileFindResourceFull",
          "args": [
            "name",
            "\"libvirt_storage_file_\"",
            "\".so\"",
            "abs_top_builddir \"/src/.libs\"",
            "STORAGE_FILE_MODULE_DIR",
            "\"LIBVIRT_STORAGE_FILE_DIR\""
          ],
          "line": 57
        },
        "resolved": true,
        "details": {
          "function_name": "virFileFindResourceFull",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virfile.c",
          "lines": "1741-1769",
          "snippet": "char *\nvirFileFindResourceFull(const char *filename,\n                        const char *prefix,\n                        const char *suffix,\n                        const char *builddir,\n                        const char *installdir,\n                        const char *envname)\n{\n    char *ret = NULL;\n    const char *envval = envname ? getenv(envname) : NULL;\n    const char *path;\n\n    if (!prefix)\n        prefix = \"\";\n    if (!suffix)\n        suffix = \"\";\n\n    if (envval)\n        path = envval;\n    else if (useDirOverride)\n        path = builddir;\n    else\n        path = installdir;\n\n    ret = g_strdup_printf(\"%s/%s%s%s\", path, prefix, filename, suffix);\n\n    VIR_DEBUG(\"Resolved '%s' to '%s'\", filename, ret);\n    return ret;\n}",
          "includes": [
            "#include \"virsocket.h\"",
            "#include \"virutil.h\"",
            "#include \"virstring.h\"",
            "#include \"virprocess.h\"",
            "#include \"virlog.h\"",
            "#include \"virkmod.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"configmake.h\"",
            "# include <sys/xattr.h>",
            "# include <linux/cdrom.h>",
            "# include <sys/ioctl.h>",
            "#  include <linux/loop.h>",
            "# include <sys/statfs.h>",
            "#  include <linux/magic.h>",
            "#include <sys/file.h>",
            "# include <sys/acl.h>",
            "# include <sys/syscall.h>",
            "# include <sys/mman.h>",
            "# include <mntent.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "# include <sys/mount.h>",
            "#include <sys/stat.h>",
            "# include <libutil.h>",
            "# include <util.h>",
            "# include <pty.h>",
            "# include <termios.h>",
            "#include <fcntl.h>",
            "#include \"internal.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static bool useDirOverride;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"virsocket.h\"\n#include \"virutil.h\"\n#include \"virstring.h\"\n#include \"virprocess.h\"\n#include \"virlog.h\"\n#include \"virkmod.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"configmake.h\"\n# include <sys/xattr.h>\n# include <linux/cdrom.h>\n# include <sys/ioctl.h>\n#  include <linux/loop.h>\n# include <sys/statfs.h>\n#  include <linux/magic.h>\n#include <sys/file.h>\n# include <sys/acl.h>\n# include <sys/syscall.h>\n# include <sys/mman.h>\n# include <mntent.h>\n#include <dirent.h>\n#include <unistd.h>\n# include <sys/mount.h>\n#include <sys/stat.h>\n# include <libutil.h>\n# include <util.h>\n# include <pty.h>\n# include <termios.h>\n#include <fcntl.h>\n#include \"internal.h\"\n#include <config.h>\n\nstatic bool useDirOverride;\n\nchar *\nvirFileFindResourceFull(const char *filename,\n                        const char *prefix,\n                        const char *suffix,\n                        const char *builddir,\n                        const char *installdir,\n                        const char *envname)\n{\n    char *ret = NULL;\n    const char *envval = envname ? getenv(envname) : NULL;\n    const char *path;\n\n    if (!prefix)\n        prefix = \"\";\n    if (!suffix)\n        suffix = \"\";\n\n    if (envval)\n        path = envval;\n    else if (useDirOverride)\n        path = builddir;\n    else\n        path = installdir;\n\n    ret = g_strdup_printf(\"%s/%s%s%s\", path, prefix, filename, suffix);\n\n    VIR_DEBUG(\"Resolved '%s' to '%s'\", filename, ret);\n    return ret;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"configmake.h\"\n#include \"virfile.h\"\n#include \"virmodule.h\"\n#include \"virlog.h\"\n#include \"virstoragefilebackend.h\"\n#include \"internal.h\"\n#include \"viralloc.h\"\n#include \"virerror.h\"\n#include \"datatypes.h\"\n#include <sys/stat.h>\n#include <config.h>\n\nstatic int\nvirStorageFileLoadBackendModule(const char *name,\n                                const char *regfunc,\n                                bool forceload)\n{\n    char *modfile = NULL;\n    int ret;\n\n    if (!(modfile = virFileFindResourceFull(name,\n                                            \"libvirt_storage_file_\",\n                                            \".so\",\n                                            abs_top_builddir \"/src/.libs\",\n                                            STORAGE_FILE_MODULE_DIR,\n                                            \"LIBVIRT_STORAGE_FILE_DIR\")))\n        return -1;\n\n    ret = virModuleLoad(modfile, regfunc, forceload);\n\n    VIR_FREE(modfile);\n\n    return ret;\n}"
  }
]