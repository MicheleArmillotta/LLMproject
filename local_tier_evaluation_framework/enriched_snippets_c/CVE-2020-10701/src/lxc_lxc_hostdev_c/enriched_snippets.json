[
  {
    "function_name": "virLXCDomainReAttachHostDevices",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/lxc/lxc_hostdev.c",
    "lines": "130-138",
    "snippet": "void virLXCDomainReAttachHostDevices(virLXCDriverPtr driver,\n                                     virDomainDefPtr def)\n{\n    if (!def->nhostdevs)\n        return;\n\n    virLXCDomainReAttachHostUSBDevices(driver, def->name, def->hostdevs,\n                                       def->nhostdevs);\n}",
    "includes": [
      "#include \"virhostdev.h\"",
      "#include \"virerror.h\"",
      "#include \"virlog.h\"",
      "#include \"viralloc.h\"",
      "#include \"lxc_hostdev.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virLXCDomainReAttachHostUSBDevices",
          "args": [
            "driver",
            "def->name",
            "def->hostdevs",
            "def->nhostdevs"
          ],
          "line": 136
        },
        "resolved": true,
        "details": {
          "function_name": "virLXCDomainReAttachHostUSBDevices",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/lxc/lxc_hostdev.c",
          "lines": "118-128",
          "snippet": "static void\nvirLXCDomainReAttachHostUSBDevices(virLXCDriverPtr driver,\n                                   const char *name,\n                                   virDomainHostdevDefPtr *hostdevs,\n                                   int nhostdevs)\n{\n    virHostdevManagerPtr hostdev_mgr = driver->hostdevMgr;\n\n    virHostdevReAttachUSBDevices(hostdev_mgr, LXC_DRIVER_NAME,\n                                 name, hostdevs, nhostdevs);\n}",
          "includes": [
            "#include \"virhostdev.h\"",
            "#include \"virerror.h\"",
            "#include \"virlog.h\"",
            "#include \"viralloc.h\"",
            "#include \"lxc_hostdev.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virhostdev.h\"\n#include \"virerror.h\"\n#include \"virlog.h\"\n#include \"viralloc.h\"\n#include \"lxc_hostdev.h\"\n#include <config.h>\n\nstatic void\nvirLXCDomainReAttachHostUSBDevices(virLXCDriverPtr driver,\n                                   const char *name,\n                                   virDomainHostdevDefPtr *hostdevs,\n                                   int nhostdevs)\n{\n    virHostdevManagerPtr hostdev_mgr = driver->hostdevMgr;\n\n    virHostdevReAttachUSBDevices(hostdev_mgr, LXC_DRIVER_NAME,\n                                 name, hostdevs, nhostdevs);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virhostdev.h\"\n#include \"virerror.h\"\n#include \"virlog.h\"\n#include \"viralloc.h\"\n#include \"lxc_hostdev.h\"\n#include <config.h>\n\nvoid virLXCDomainReAttachHostDevices(virLXCDriverPtr driver,\n                                     virDomainDefPtr def)\n{\n    if (!def->nhostdevs)\n        return;\n\n    virLXCDomainReAttachHostUSBDevices(driver, def->name, def->hostdevs,\n                                       def->nhostdevs);\n}"
  },
  {
    "function_name": "virLXCDomainReAttachHostUSBDevices",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/lxc/lxc_hostdev.c",
    "lines": "118-128",
    "snippet": "static void\nvirLXCDomainReAttachHostUSBDevices(virLXCDriverPtr driver,\n                                   const char *name,\n                                   virDomainHostdevDefPtr *hostdevs,\n                                   int nhostdevs)\n{\n    virHostdevManagerPtr hostdev_mgr = driver->hostdevMgr;\n\n    virHostdevReAttachUSBDevices(hostdev_mgr, LXC_DRIVER_NAME,\n                                 name, hostdevs, nhostdevs);\n}",
    "includes": [
      "#include \"virhostdev.h\"",
      "#include \"virerror.h\"",
      "#include \"virlog.h\"",
      "#include \"viralloc.h\"",
      "#include \"lxc_hostdev.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virHostdevReAttachUSBDevices",
          "args": [
            "hostdev_mgr",
            "LXC_DRIVER_NAME",
            "name",
            "hostdevs",
            "nhostdevs"
          ],
          "line": 126
        },
        "resolved": true,
        "details": {
          "function_name": "virHostdevReAttachUSBDevices",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/hypervisor/virhostdev.c",
          "lines": "1772-1830",
          "snippet": "void\nvirHostdevReAttachUSBDevices(virHostdevManagerPtr mgr,\n                             const char *drv_name,\n                             const char *dom_name,\n                             virDomainHostdevDefPtr *hostdevs,\n                             int nhostdevs)\n{\n    size_t i;\n\n    if (!nhostdevs)\n        return;\n\n    virObjectLock(mgr->activeUSBHostdevs);\n    for (i = 0; i < nhostdevs; i++) {\n        virDomainHostdevDefPtr hostdev = hostdevs[i];\n        virDomainHostdevSubsysUSBPtr usbsrc = &hostdev->source.subsys.u.usb;\n        g_autoptr(virUSBDevice) usb = NULL;\n        virUSBDevicePtr tmp;\n        const char *usedby_drvname;\n        const char *usedby_domname;\n\n        if (hostdev->mode != VIR_DOMAIN_HOSTDEV_MODE_SUBSYS)\n            continue;\n        if (hostdev->source.subsys.type != VIR_DOMAIN_HOSTDEV_SUBSYS_TYPE_USB)\n            continue;\n        if (hostdev->missing)\n            continue;\n\n        if (!(usb = virUSBDeviceNew(usbsrc->bus, usbsrc->device, NULL))) {\n            VIR_WARN(\"Unable to reattach USB device %03d.%03d on domain %s\",\n                     usbsrc->bus, usbsrc->device, NULLSTR(dom_name));\n            continue;\n        }\n\n        /* Delete only those USB devices which belongs\n         * to domain @name because qemuProcessStart() might\n         * have failed because USB device is already taken.\n         * Therefore we want to steal only those devices from\n         * the list which were taken by @name */\n\n        tmp = virUSBDeviceListFind(mgr->activeUSBHostdevs, usb);\n\n        if (!tmp) {\n            VIR_WARN(\"Unable to find device %03d.%03d \"\n                     \"in list of active USB devices\",\n                     usbsrc->bus, usbsrc->device);\n            continue;\n        }\n\n        virUSBDeviceGetUsedBy(tmp, &usedby_drvname, &usedby_domname);\n        if (STREQ_NULLABLE(drv_name, usedby_drvname) &&\n            STREQ_NULLABLE(dom_name, usedby_domname)) {\n            VIR_DEBUG(\"Removing %03d.%03d dom=%s from activeUSBHostdevs\",\n                      usbsrc->bus, usbsrc->device, dom_name);\n            virUSBDeviceListDel(mgr->activeUSBHostdevs, tmp);\n        }\n    }\n    virObjectUnlock(mgr->activeUSBHostdevs);\n}",
          "includes": [
            "#include \"configmake.h\"",
            "#include \"virnetdev.h\"",
            "#include \"virutil.h\"",
            "#include \"virlog.h\"",
            "#include \"virerror.h\"",
            "#include \"virfile.h\"",
            "#include \"virstring.h\"",
            "#include \"viralloc.h\"",
            "#include \"virhostdev.h\"",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <fcntl.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"configmake.h\"\n#include \"virnetdev.h\"\n#include \"virutil.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n#include \"virfile.h\"\n#include \"virstring.h\"\n#include \"viralloc.h\"\n#include \"virhostdev.h\"\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <config.h>\n\nvoid\nvirHostdevReAttachUSBDevices(virHostdevManagerPtr mgr,\n                             const char *drv_name,\n                             const char *dom_name,\n                             virDomainHostdevDefPtr *hostdevs,\n                             int nhostdevs)\n{\n    size_t i;\n\n    if (!nhostdevs)\n        return;\n\n    virObjectLock(mgr->activeUSBHostdevs);\n    for (i = 0; i < nhostdevs; i++) {\n        virDomainHostdevDefPtr hostdev = hostdevs[i];\n        virDomainHostdevSubsysUSBPtr usbsrc = &hostdev->source.subsys.u.usb;\n        g_autoptr(virUSBDevice) usb = NULL;\n        virUSBDevicePtr tmp;\n        const char *usedby_drvname;\n        const char *usedby_domname;\n\n        if (hostdev->mode != VIR_DOMAIN_HOSTDEV_MODE_SUBSYS)\n            continue;\n        if (hostdev->source.subsys.type != VIR_DOMAIN_HOSTDEV_SUBSYS_TYPE_USB)\n            continue;\n        if (hostdev->missing)\n            continue;\n\n        if (!(usb = virUSBDeviceNew(usbsrc->bus, usbsrc->device, NULL))) {\n            VIR_WARN(\"Unable to reattach USB device %03d.%03d on domain %s\",\n                     usbsrc->bus, usbsrc->device, NULLSTR(dom_name));\n            continue;\n        }\n\n        /* Delete only those USB devices which belongs\n         * to domain @name because qemuProcessStart() might\n         * have failed because USB device is already taken.\n         * Therefore we want to steal only those devices from\n         * the list which were taken by @name */\n\n        tmp = virUSBDeviceListFind(mgr->activeUSBHostdevs, usb);\n\n        if (!tmp) {\n            VIR_WARN(\"Unable to find device %03d.%03d \"\n                     \"in list of active USB devices\",\n                     usbsrc->bus, usbsrc->device);\n            continue;\n        }\n\n        virUSBDeviceGetUsedBy(tmp, &usedby_drvname, &usedby_domname);\n        if (STREQ_NULLABLE(drv_name, usedby_drvname) &&\n            STREQ_NULLABLE(dom_name, usedby_domname)) {\n            VIR_DEBUG(\"Removing %03d.%03d dom=%s from activeUSBHostdevs\",\n                      usbsrc->bus, usbsrc->device, dom_name);\n            virUSBDeviceListDel(mgr->activeUSBHostdevs, tmp);\n        }\n    }\n    virObjectUnlock(mgr->activeUSBHostdevs);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virhostdev.h\"\n#include \"virerror.h\"\n#include \"virlog.h\"\n#include \"viralloc.h\"\n#include \"lxc_hostdev.h\"\n#include <config.h>\n\nstatic void\nvirLXCDomainReAttachHostUSBDevices(virLXCDriverPtr driver,\n                                   const char *name,\n                                   virDomainHostdevDefPtr *hostdevs,\n                                   int nhostdevs)\n{\n    virHostdevManagerPtr hostdev_mgr = driver->hostdevMgr;\n\n    virHostdevReAttachUSBDevices(hostdev_mgr, LXC_DRIVER_NAME,\n                                 name, hostdevs, nhostdevs);\n}"
  },
  {
    "function_name": "virLXCPrepareHostDevices",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/lxc/lxc_hostdev.c",
    "lines": "63-115",
    "snippet": "int virLXCPrepareHostDevices(virLXCDriverPtr driver,\n                             virDomainDefPtr def)\n{\n    size_t i;\n\n    if (!def->nhostdevs)\n        return 0;\n\n    /* Sanity check for supported configurations only */\n    for (i = 0; i < def->nhostdevs; i++) {\n        virDomainHostdevDefPtr dev = def->hostdevs[i];\n\n        switch (dev->mode) {\n        case VIR_DOMAIN_HOSTDEV_MODE_SUBSYS:\n            switch (dev->source.subsys.type) {\n            case VIR_DOMAIN_HOSTDEV_SUBSYS_TYPE_USB:\n                break;\n            default:\n                virReportError(VIR_ERR_CONFIG_UNSUPPORTED,\n                               _(\"Unsupported hostdev type %s\"),\n                               virDomainHostdevSubsysTypeToString(dev->source.subsys.type));\n                return -1;\n            }\n            break;\n\n        case VIR_DOMAIN_HOSTDEV_MODE_CAPABILITIES:\n            switch (dev->source.subsys.type) {\n            case VIR_DOMAIN_HOSTDEV_CAPS_TYPE_STORAGE:\n            case VIR_DOMAIN_HOSTDEV_CAPS_TYPE_MISC:\n            case VIR_DOMAIN_HOSTDEV_CAPS_TYPE_NET:\n                break;\n            default:\n                virReportError(VIR_ERR_CONFIG_UNSUPPORTED,\n                               _(\"Unsupported hostdev type %s\"),\n                               virDomainHostdevSubsysTypeToString(dev->source.subsys.type));\n                return -1;\n            }\n            break;\n\n\n        default:\n            virReportError(VIR_ERR_CONFIG_UNSUPPORTED,\n                           _(\"Unsupported hostdev mode %s\"),\n                           virDomainHostdevModeTypeToString(dev->mode));\n            return -1;\n        }\n    }\n\n    if (virLXCPrepareHostUSBDevices(driver, def) < 0)\n        return -1;\n\n    return 0;\n}",
    "includes": [
      "#include \"virhostdev.h\"",
      "#include \"virerror.h\"",
      "#include \"virlog.h\"",
      "#include \"viralloc.h\"",
      "#include \"lxc_hostdev.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virLXCPrepareHostUSBDevices",
          "args": [
            "driver",
            "def"
          ],
          "line": 111
        },
        "resolved": true,
        "details": {
          "function_name": "virLXCPrepareHostUSBDevices",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/lxc/lxc_hostdev.c",
          "lines": "48-60",
          "snippet": "static int\nvirLXCPrepareHostUSBDevices(virLXCDriverPtr driver,\n                            virDomainDefPtr def)\n{\n    virDomainHostdevDefPtr *hostdevs = def->hostdevs;\n    int nhostdevs = def->nhostdevs;\n    const char *dom_name = def->name;\n    unsigned int flags = 0;\n    virHostdevManagerPtr hostdev_mgr = driver->hostdevMgr;\n\n    return virHostdevPrepareUSBDevices(hostdev_mgr, LXC_DRIVER_NAME, dom_name,\n                                       hostdevs, nhostdevs, flags);\n}",
          "includes": [
            "#include \"virhostdev.h\"",
            "#include \"virerror.h\"",
            "#include \"virlog.h\"",
            "#include \"viralloc.h\"",
            "#include \"lxc_hostdev.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virhostdev.h\"\n#include \"virerror.h\"\n#include \"virlog.h\"\n#include \"viralloc.h\"\n#include \"lxc_hostdev.h\"\n#include <config.h>\n\nstatic int\nvirLXCPrepareHostUSBDevices(virLXCDriverPtr driver,\n                            virDomainDefPtr def)\n{\n    virDomainHostdevDefPtr *hostdevs = def->hostdevs;\n    int nhostdevs = def->nhostdevs;\n    const char *dom_name = def->name;\n    unsigned int flags = 0;\n    virHostdevManagerPtr hostdev_mgr = driver->hostdevMgr;\n\n    return virHostdevPrepareUSBDevices(hostdev_mgr, LXC_DRIVER_NAME, dom_name,\n                                       hostdevs, nhostdevs, flags);\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_CONFIG_UNSUPPORTED",
            "_(\"Unsupported hostdev mode %s\")",
            "virDomainHostdevModeTypeToString(dev->mode)"
          ],
          "line": 104
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virDomainHostdevModeTypeToString",
          "args": [
            "dev->mode"
          ],
          "line": 106
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"Unsupported hostdev mode %s\""
          ],
          "line": 105
        },
        "resolved": true,
        "details": {
          "function_name": "userns_required",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/lxc/lxc_container.c",
          "lines": "2329-2332",
          "snippet": "static int userns_required(virDomainDefPtr def)\n{\n    return def->idmap.uidmap && def->idmap.gidmap;\n}",
          "includes": [
            "#include \"virutil.h\"",
            "#include \"virstring.h\"",
            "#include \"virprocess.h\"",
            "#include \"virnetdevip.h\"",
            "#include \"vircommand.h\"",
            "#include \"virusb.h\"",
            "#include \"virfile.h\"",
            "#include \"viruuid.h\"",
            "#include \"virnetdevveth.h\"",
            "#include \"viralloc.h\"",
            "#include \"lxc_container.h\"",
            "#include \"virlog.h\"",
            "#include \"virerror.h\"",
            "# include <selinux/selinux.h>",
            "# include <blkid.h>",
            "# include <cap-ng.h>",
            "#include <linux/fs.h>",
            "#include <linux/unistd.h>",
            "#include <linux/reboot.h>",
            "#include <sys/reboot.h>",
            "#include <mntent.h>",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/mount.h>",
            "#include <sys/ioctl.h>",
            "#include <fcntl.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virutil.h\"\n#include \"virstring.h\"\n#include \"virprocess.h\"\n#include \"virnetdevip.h\"\n#include \"vircommand.h\"\n#include \"virusb.h\"\n#include \"virfile.h\"\n#include \"viruuid.h\"\n#include \"virnetdevveth.h\"\n#include \"viralloc.h\"\n#include \"lxc_container.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n# include <selinux/selinux.h>\n# include <blkid.h>\n# include <cap-ng.h>\n#include <linux/fs.h>\n#include <linux/unistd.h>\n#include <linux/reboot.h>\n#include <sys/reboot.h>\n#include <mntent.h>\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/mount.h>\n#include <sys/ioctl.h>\n#include <fcntl.h>\n#include <config.h>\n\nstatic int userns_required(virDomainDefPtr def)\n{\n    return def->idmap.uidmap && def->idmap.gidmap;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_CONFIG_UNSUPPORTED",
            "_(\"Unsupported hostdev type %s\")",
            "virDomainHostdevSubsysTypeToString(dev->source.subsys.type)"
          ],
          "line": 95
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virDomainHostdevSubsysTypeToString",
          "args": [
            "dev->source.subsys.type"
          ],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virReportError",
          "args": [
            "VIR_ERR_CONFIG_UNSUPPORTED",
            "_(\"Unsupported hostdev type %s\")",
            "virDomainHostdevSubsysTypeToString(dev->source.subsys.type)"
          ],
          "line": 81
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virDomainHostdevSubsysTypeToString",
          "args": [
            "dev->source.subsys.type"
          ],
          "line": 83
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virhostdev.h\"\n#include \"virerror.h\"\n#include \"virlog.h\"\n#include \"viralloc.h\"\n#include \"lxc_hostdev.h\"\n#include <config.h>\n\nint virLXCPrepareHostDevices(virLXCDriverPtr driver,\n                             virDomainDefPtr def)\n{\n    size_t i;\n\n    if (!def->nhostdevs)\n        return 0;\n\n    /* Sanity check for supported configurations only */\n    for (i = 0; i < def->nhostdevs; i++) {\n        virDomainHostdevDefPtr dev = def->hostdevs[i];\n\n        switch (dev->mode) {\n        case VIR_DOMAIN_HOSTDEV_MODE_SUBSYS:\n            switch (dev->source.subsys.type) {\n            case VIR_DOMAIN_HOSTDEV_SUBSYS_TYPE_USB:\n                break;\n            default:\n                virReportError(VIR_ERR_CONFIG_UNSUPPORTED,\n                               _(\"Unsupported hostdev type %s\"),\n                               virDomainHostdevSubsysTypeToString(dev->source.subsys.type));\n                return -1;\n            }\n            break;\n\n        case VIR_DOMAIN_HOSTDEV_MODE_CAPABILITIES:\n            switch (dev->source.subsys.type) {\n            case VIR_DOMAIN_HOSTDEV_CAPS_TYPE_STORAGE:\n            case VIR_DOMAIN_HOSTDEV_CAPS_TYPE_MISC:\n            case VIR_DOMAIN_HOSTDEV_CAPS_TYPE_NET:\n                break;\n            default:\n                virReportError(VIR_ERR_CONFIG_UNSUPPORTED,\n                               _(\"Unsupported hostdev type %s\"),\n                               virDomainHostdevSubsysTypeToString(dev->source.subsys.type));\n                return -1;\n            }\n            break;\n\n\n        default:\n            virReportError(VIR_ERR_CONFIG_UNSUPPORTED,\n                           _(\"Unsupported hostdev mode %s\"),\n                           virDomainHostdevModeTypeToString(dev->mode));\n            return -1;\n        }\n    }\n\n    if (virLXCPrepareHostUSBDevices(driver, def) < 0)\n        return -1;\n\n    return 0;\n}"
  },
  {
    "function_name": "virLXCPrepareHostUSBDevices",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/lxc/lxc_hostdev.c",
    "lines": "48-60",
    "snippet": "static int\nvirLXCPrepareHostUSBDevices(virLXCDriverPtr driver,\n                            virDomainDefPtr def)\n{\n    virDomainHostdevDefPtr *hostdevs = def->hostdevs;\n    int nhostdevs = def->nhostdevs;\n    const char *dom_name = def->name;\n    unsigned int flags = 0;\n    virHostdevManagerPtr hostdev_mgr = driver->hostdevMgr;\n\n    return virHostdevPrepareUSBDevices(hostdev_mgr, LXC_DRIVER_NAME, dom_name,\n                                       hostdevs, nhostdevs, flags);\n}",
    "includes": [
      "#include \"virhostdev.h\"",
      "#include \"virerror.h\"",
      "#include \"virlog.h\"",
      "#include \"viralloc.h\"",
      "#include \"lxc_hostdev.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virHostdevPrepareUSBDevices",
          "args": [
            "hostdev_mgr",
            "LXC_DRIVER_NAME",
            "dom_name",
            "hostdevs",
            "nhostdevs",
            "flags"
          ],
          "line": 58
        },
        "resolved": true,
        "details": {
          "function_name": "virHostdevPrepareUSBDevices",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/hypervisor/virhostdev.c",
          "lines": "1439-1505",
          "snippet": "int\nvirHostdevPrepareUSBDevices(virHostdevManagerPtr mgr,\n                            const char *drv_name,\n                            const char *dom_name,\n                            virDomainHostdevDefPtr *hostdevs,\n                            int nhostdevs,\n                            unsigned int flags)\n{\n    size_t i;\n    g_autoptr(virUSBDeviceList) list = NULL;\n    virUSBDevicePtr tmp;\n    bool coldBoot = !!(flags & VIR_HOSTDEV_COLD_BOOT);\n\n    if (!nhostdevs)\n        return 0;\n\n    /* To prevent situation where USB device is assigned to two domains\n     * we need to keep a list of currently assigned USB devices.\n     * This is done in several loops which cannot be joined into one big\n     * loop. See virHostdevPreparePCIDevices()\n     */\n    if (!(list = virUSBDeviceListNew()))\n        return -1;\n\n    /* Loop 1: build temporary list\n     */\n    for (i = 0; i < nhostdevs; i++) {\n        virDomainHostdevDefPtr hostdev = hostdevs[i];\n        bool required = true;\n        g_autoptr(virUSBDevice) usb = NULL;\n\n        if (hostdev->mode != VIR_DOMAIN_HOSTDEV_MODE_SUBSYS)\n            continue;\n        if (hostdev->source.subsys.type != VIR_DOMAIN_HOSTDEV_SUBSYS_TYPE_USB)\n            continue;\n\n        if (hostdev->startupPolicy == VIR_DOMAIN_STARTUP_POLICY_OPTIONAL ||\n            (hostdev->startupPolicy == VIR_DOMAIN_STARTUP_POLICY_REQUISITE &&\n             !coldBoot))\n            required = false;\n\n        if (virHostdevFindUSBDevice(hostdev, required, &usb) < 0)\n            return -1;\n\n        if (usb && virUSBDeviceListAdd(list, &usb) < 0)\n            return -1;\n        usb = NULL;\n    }\n\n    /* Mark devices in temporary list as used by @dom_name\n     * and add them do driver list. However, if something goes\n     * wrong, perform rollback.\n     */\n    if (virHostdevMarkUSBDevices(mgr, drv_name, dom_name, list) < 0)\n        return -1;\n\n    /* Loop 2: Temporary list was successfully merged with\n     * driver list, so steal all items to avoid freeing them\n     * in cleanup label.\n     */\n    while (virUSBDeviceListCount(list) > 0) {\n        tmp = virUSBDeviceListGet(list, 0);\n        virUSBDeviceListSteal(list, tmp);\n    }\n\n    return 0;\n}",
          "includes": [
            "#include \"configmake.h\"",
            "#include \"virnetdev.h\"",
            "#include \"virutil.h\"",
            "#include \"virlog.h\"",
            "#include \"virerror.h\"",
            "#include \"virfile.h\"",
            "#include \"virstring.h\"",
            "#include \"viralloc.h\"",
            "#include \"virhostdev.h\"",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <fcntl.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"configmake.h\"\n#include \"virnetdev.h\"\n#include \"virutil.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n#include \"virfile.h\"\n#include \"virstring.h\"\n#include \"viralloc.h\"\n#include \"virhostdev.h\"\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <config.h>\n\nint\nvirHostdevPrepareUSBDevices(virHostdevManagerPtr mgr,\n                            const char *drv_name,\n                            const char *dom_name,\n                            virDomainHostdevDefPtr *hostdevs,\n                            int nhostdevs,\n                            unsigned int flags)\n{\n    size_t i;\n    g_autoptr(virUSBDeviceList) list = NULL;\n    virUSBDevicePtr tmp;\n    bool coldBoot = !!(flags & VIR_HOSTDEV_COLD_BOOT);\n\n    if (!nhostdevs)\n        return 0;\n\n    /* To prevent situation where USB device is assigned to two domains\n     * we need to keep a list of currently assigned USB devices.\n     * This is done in several loops which cannot be joined into one big\n     * loop. See virHostdevPreparePCIDevices()\n     */\n    if (!(list = virUSBDeviceListNew()))\n        return -1;\n\n    /* Loop 1: build temporary list\n     */\n    for (i = 0; i < nhostdevs; i++) {\n        virDomainHostdevDefPtr hostdev = hostdevs[i];\n        bool required = true;\n        g_autoptr(virUSBDevice) usb = NULL;\n\n        if (hostdev->mode != VIR_DOMAIN_HOSTDEV_MODE_SUBSYS)\n            continue;\n        if (hostdev->source.subsys.type != VIR_DOMAIN_HOSTDEV_SUBSYS_TYPE_USB)\n            continue;\n\n        if (hostdev->startupPolicy == VIR_DOMAIN_STARTUP_POLICY_OPTIONAL ||\n            (hostdev->startupPolicy == VIR_DOMAIN_STARTUP_POLICY_REQUISITE &&\n             !coldBoot))\n            required = false;\n\n        if (virHostdevFindUSBDevice(hostdev, required, &usb) < 0)\n            return -1;\n\n        if (usb && virUSBDeviceListAdd(list, &usb) < 0)\n            return -1;\n        usb = NULL;\n    }\n\n    /* Mark devices in temporary list as used by @dom_name\n     * and add them do driver list. However, if something goes\n     * wrong, perform rollback.\n     */\n    if (virHostdevMarkUSBDevices(mgr, drv_name, dom_name, list) < 0)\n        return -1;\n\n    /* Loop 2: Temporary list was successfully merged with\n     * driver list, so steal all items to avoid freeing them\n     * in cleanup label.\n     */\n    while (virUSBDeviceListCount(list) > 0) {\n        tmp = virUSBDeviceListGet(list, 0);\n        virUSBDeviceListSteal(list, tmp);\n    }\n\n    return 0;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virhostdev.h\"\n#include \"virerror.h\"\n#include \"virlog.h\"\n#include \"viralloc.h\"\n#include \"lxc_hostdev.h\"\n#include <config.h>\n\nstatic int\nvirLXCPrepareHostUSBDevices(virLXCDriverPtr driver,\n                            virDomainDefPtr def)\n{\n    virDomainHostdevDefPtr *hostdevs = def->hostdevs;\n    int nhostdevs = def->nhostdevs;\n    const char *dom_name = def->name;\n    unsigned int flags = 0;\n    virHostdevManagerPtr hostdev_mgr = driver->hostdevMgr;\n\n    return virHostdevPrepareUSBDevices(hostdev_mgr, LXC_DRIVER_NAME, dom_name,\n                                       hostdevs, nhostdevs, flags);\n}"
  },
  {
    "function_name": "virLXCUpdateActiveUSBHostdevs",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/lxc/lxc_hostdev.c",
    "lines": "34-46",
    "snippet": "int\nvirLXCUpdateActiveUSBHostdevs(virLXCDriverPtr driver,\n                              virDomainDefPtr def)\n{\n    virHostdevManagerPtr hostdev_mgr = driver->hostdevMgr;\n\n    if (!def->nhostdevs)\n        return 0;\n\n    return virHostdevUpdateActiveUSBDevices(hostdev_mgr,\n                                            def->hostdevs, def->nhostdevs,\n                                            LXC_DRIVER_NAME, def->name);\n}",
    "includes": [
      "#include \"virhostdev.h\"",
      "#include \"virerror.h\"",
      "#include \"virlog.h\"",
      "#include \"viralloc.h\"",
      "#include \"lxc_hostdev.h\"",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virHostdevUpdateActiveUSBDevices",
          "args": [
            "hostdev_mgr",
            "def->hostdevs",
            "def->nhostdevs",
            "LXC_DRIVER_NAME",
            "def->name"
          ],
          "line": 43
        },
        "resolved": true,
        "details": {
          "function_name": "virHostdevUpdateActiveUSBDevices",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/hypervisor/virhostdev.c",
          "lines": "1145-1187",
          "snippet": "int\nvirHostdevUpdateActiveUSBDevices(virHostdevManagerPtr mgr,\n                                 virDomainHostdevDefPtr *hostdevs,\n                                 int nhostdevs,\n                                 const char *drv_name,\n                                 const char *dom_name)\n{\n    virDomainHostdevDefPtr hostdev = NULL;\n    size_t i;\n    int ret = -1;\n\n    if (!nhostdevs)\n        return 0;\n\n    virObjectLock(mgr->activeUSBHostdevs);\n    for (i = 0; i < nhostdevs; i++) {\n        virDomainHostdevSubsysUSBPtr usbsrc;\n        g_autoptr(virUSBDevice) usb = NULL;\n        hostdev = hostdevs[i];\n        usbsrc = &hostdev->source.subsys.u.usb;\n\n        if (hostdev->mode != VIR_DOMAIN_HOSTDEV_MODE_SUBSYS)\n            continue;\n        if (hostdev->source.subsys.type != VIR_DOMAIN_HOSTDEV_SUBSYS_TYPE_USB)\n            continue;\n\n        if (!(usb = virUSBDeviceNew(usbsrc->bus, usbsrc->device, NULL))) {\n            VIR_WARN(\"Unable to reattach USB device %03d.%03d on domain %s\",\n                     usbsrc->bus, usbsrc->device, dom_name);\n            continue;\n        }\n\n        virUSBDeviceSetUsedBy(usb, drv_name, dom_name);\n\n        if (virUSBDeviceListAdd(mgr->activeUSBHostdevs, &usb) < 0)\n            goto cleanup;\n        usb = NULL;\n    }\n    ret = 0;\n cleanup:\n    virObjectUnlock(mgr->activeUSBHostdevs);\n    return ret;\n}",
          "includes": [
            "#include \"configmake.h\"",
            "#include \"virnetdev.h\"",
            "#include \"virutil.h\"",
            "#include \"virlog.h\"",
            "#include \"virerror.h\"",
            "#include \"virfile.h\"",
            "#include \"virstring.h\"",
            "#include \"viralloc.h\"",
            "#include \"virhostdev.h\"",
            "#include <unistd.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <fcntl.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"configmake.h\"\n#include \"virnetdev.h\"\n#include \"virutil.h\"\n#include \"virlog.h\"\n#include \"virerror.h\"\n#include \"virfile.h\"\n#include \"virstring.h\"\n#include \"viralloc.h\"\n#include \"virhostdev.h\"\n#include <unistd.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <fcntl.h>\n#include <config.h>\n\nint\nvirHostdevUpdateActiveUSBDevices(virHostdevManagerPtr mgr,\n                                 virDomainHostdevDefPtr *hostdevs,\n                                 int nhostdevs,\n                                 const char *drv_name,\n                                 const char *dom_name)\n{\n    virDomainHostdevDefPtr hostdev = NULL;\n    size_t i;\n    int ret = -1;\n\n    if (!nhostdevs)\n        return 0;\n\n    virObjectLock(mgr->activeUSBHostdevs);\n    for (i = 0; i < nhostdevs; i++) {\n        virDomainHostdevSubsysUSBPtr usbsrc;\n        g_autoptr(virUSBDevice) usb = NULL;\n        hostdev = hostdevs[i];\n        usbsrc = &hostdev->source.subsys.u.usb;\n\n        if (hostdev->mode != VIR_DOMAIN_HOSTDEV_MODE_SUBSYS)\n            continue;\n        if (hostdev->source.subsys.type != VIR_DOMAIN_HOSTDEV_SUBSYS_TYPE_USB)\n            continue;\n\n        if (!(usb = virUSBDeviceNew(usbsrc->bus, usbsrc->device, NULL))) {\n            VIR_WARN(\"Unable to reattach USB device %03d.%03d on domain %s\",\n                     usbsrc->bus, usbsrc->device, dom_name);\n            continue;\n        }\n\n        virUSBDeviceSetUsedBy(usb, drv_name, dom_name);\n\n        if (virUSBDeviceListAdd(mgr->activeUSBHostdevs, &usb) < 0)\n            goto cleanup;\n        usb = NULL;\n    }\n    ret = 0;\n cleanup:\n    virObjectUnlock(mgr->activeUSBHostdevs);\n    return ret;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"virhostdev.h\"\n#include \"virerror.h\"\n#include \"virlog.h\"\n#include \"viralloc.h\"\n#include \"lxc_hostdev.h\"\n#include <config.h>\n\nint\nvirLXCUpdateActiveUSBHostdevs(virLXCDriverPtr driver,\n                              virDomainDefPtr def)\n{\n    virHostdevManagerPtr hostdev_mgr = driver->hostdevMgr;\n\n    if (!def->nhostdevs)\n        return 0;\n\n    return virHostdevUpdateActiveUSBDevices(hostdev_mgr,\n                                            def->hostdevs, def->nhostdevs,\n                                            LXC_DRIVER_NAME, def->name);\n}"
  }
]