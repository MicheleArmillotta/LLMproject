[
  {
    "function_name": "virInitctlSetRunLevel",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virinitctl.c",
    "lines": "192-197",
    "snippet": "int virInitctlSetRunLevel(const char *fifo G_GNUC_UNUSED,\n                          virInitctlRunLevel level G_GNUC_UNUSED)\n{\n    virReportUnsupportedError();\n    return -1;\n}",
    "includes": [
      "#include \"virstring.h\"",
      "#include \"virfile.h\"",
      "#include \"viralloc.h\"",
      "#include \"virutil.h\"",
      "#include \"virerror.h\"",
      "#include \"virinitctl.h\"",
      "#include \"internal.h\"",
      "#include <fcntl.h>",
      "#include <sys/param.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "virReportUnsupportedError",
          "args": [],
          "line": 195
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virstring.h\"\n#include \"virfile.h\"\n#include \"viralloc.h\"\n#include \"virutil.h\"\n#include \"virerror.h\"\n#include \"virinitctl.h\"\n#include \"internal.h\"\n#include <fcntl.h>\n#include <sys/param.h>\n#include <config.h>\n\nint virInitctlSetRunLevel(const char *fifo G_GNUC_UNUSED,\n                          virInitctlRunLevel level G_GNUC_UNUSED)\n{\n    virReportUnsupportedError();\n    return -1;\n}"
  },
  {
    "function_name": "virInitctlSetRunLevel",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virinitctl.c",
    "lines": "126-185",
    "snippet": "int\nvirInitctlSetRunLevel(const char *fifo,\n                      virInitctlRunLevel level)\n{\n    struct virInitctlRequest req;\n    int fd = -1;\n    int ret = -1;\n    const int open_flags = O_WRONLY|O_NONBLOCK|O_CLOEXEC|O_NOCTTY;\n    size_t i = 0;\n\n    memset(&req, 0, sizeof(req));\n\n    req.magic = VIR_INITCTL_MAGIC;\n    req.sleeptime = 0;\n    req.cmd = VIR_INITCTL_CMD_RUNLVL;\n    /* Yes it is an 'int' field, but wants a numeric character. Go figure */\n    req.runlevel = '0' + level;\n\n    if (fifo) {\n        if ((fd = open(fifo, open_flags)) < 0) {\n            virReportSystemError(errno,\n                                 _(\"Cannot open init control %s\"),\n                                 fifo);\n            goto cleanup;\n        }\n    } else {\n        for (i = 0; virInitctlFifos[i]; i++) {\n            fifo = virInitctlFifos[i];\n\n            if ((fd = open(fifo, open_flags)) >= 0)\n                break;\n\n            if (errno != ENOENT) {\n                virReportSystemError(errno,\n                                     _(\"Cannot open init control %s\"),\n                                     fifo);\n                goto cleanup;\n            }\n        }\n\n        /* Ensure we found a valid initctl fifo */\n        if (fd < 0) {\n            ret = 0;\n            goto cleanup;\n        }\n    }\n\n    if (safewrite(fd, &req, sizeof(req)) != sizeof(req)) {\n        virReportSystemError(errno,\n                             _(\"Failed to send request to init control %s\"),\n                             fifo);\n        goto cleanup;\n    }\n\n    ret = 1;\n\n cleanup:\n    VIR_FORCE_CLOSE(fd);\n    return ret;\n}",
    "includes": [
      "#include \"virstring.h\"",
      "#include \"virfile.h\"",
      "#include \"viralloc.h\"",
      "#include \"virutil.h\"",
      "#include \"virerror.h\"",
      "#include \"virinitctl.h\"",
      "#include \"internal.h\"",
      "#include <fcntl.h>",
      "#include <sys/param.h>",
      "#include <config.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "VIR_FORCE_CLOSE",
          "args": [
            "fd"
          ],
          "line": 183
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "virReportSystemError",
          "args": [
            "errno",
            "_(\"Failed to send request to init control %s\")",
            "fifo"
          ],
          "line": 174
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"Failed to send request to init control %s\""
          ],
          "line": 175
        },
        "resolved": true,
        "details": {
          "function_name": "vir_g_strdup_printf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/glibcompat.c",
          "lines": "191-202",
          "snippet": "char *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}",
          "includes": [
            "#include \"glibcompat.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"glibcompat.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <config.h>\n\nchar *\nvir_g_strdup_printf(const char *msg, ...)\n{\n    va_list args;\n    char *ret;\n    va_start(args, msg);\n    ret = g_strdup_vprintf(msg, args);\n    if (!ret)\n        abort();\n    va_end(args);\n    return ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "safewrite",
          "args": [
            "fd",
            "&req",
            "sizeof(req)"
          ],
          "line": 173
        },
        "resolved": true,
        "details": {
          "function_name": "safewrite",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virfile.c",
          "lines": "1093-1111",
          "snippet": "ssize_t\nsafewrite(int fd, const void *buf, size_t count)\n{\n    size_t nwritten = 0;\n    while (count > 0) {\n        ssize_t r = write(fd, buf, count);\n\n        if (r < 0 && errno == EINTR)\n            continue;\n        if (r < 0)\n            return r;\n        if (r == 0)\n            return nwritten;\n        buf = (const char *)buf + r;\n        count -= r;\n        nwritten += r;\n    }\n    return nwritten;\n}",
          "includes": [
            "#include \"virsocket.h\"",
            "#include \"virutil.h\"",
            "#include \"virstring.h\"",
            "#include \"virprocess.h\"",
            "#include \"virlog.h\"",
            "#include \"virkmod.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"configmake.h\"",
            "# include <sys/xattr.h>",
            "# include <linux/cdrom.h>",
            "# include <sys/ioctl.h>",
            "#  include <linux/loop.h>",
            "# include <sys/statfs.h>",
            "#  include <linux/magic.h>",
            "#include <sys/file.h>",
            "# include <sys/acl.h>",
            "# include <sys/syscall.h>",
            "# include <sys/mman.h>",
            "# include <mntent.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "# include <sys/mount.h>",
            "#include <sys/stat.h>",
            "# include <libutil.h>",
            "# include <util.h>",
            "# include <pty.h>",
            "# include <termios.h>",
            "#include <fcntl.h>",
            "#include \"internal.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virsocket.h\"\n#include \"virutil.h\"\n#include \"virstring.h\"\n#include \"virprocess.h\"\n#include \"virlog.h\"\n#include \"virkmod.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"configmake.h\"\n# include <sys/xattr.h>\n# include <linux/cdrom.h>\n# include <sys/ioctl.h>\n#  include <linux/loop.h>\n# include <sys/statfs.h>\n#  include <linux/magic.h>\n#include <sys/file.h>\n# include <sys/acl.h>\n# include <sys/syscall.h>\n# include <sys/mman.h>\n# include <mntent.h>\n#include <dirent.h>\n#include <unistd.h>\n# include <sys/mount.h>\n#include <sys/stat.h>\n# include <libutil.h>\n# include <util.h>\n# include <pty.h>\n# include <termios.h>\n#include <fcntl.h>\n#include \"internal.h\"\n#include <config.h>\n\nssize_t\nsafewrite(int fd, const void *buf, size_t count)\n{\n    size_t nwritten = 0;\n    while (count > 0) {\n        ssize_t r = write(fd, buf, count);\n\n        if (r < 0 && errno == EINTR)\n            continue;\n        if (r < 0)\n            return r;\n        if (r == 0)\n            return nwritten;\n        buf = (const char *)buf + r;\n        count -= r;\n        nwritten += r;\n    }\n    return nwritten;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportSystemError",
          "args": [
            "errno",
            "_(\"Cannot open init control %s\")",
            "fifo"
          ],
          "line": 159
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "open",
          "args": [
            "fifo",
            "open_flags"
          ],
          "line": 155
        },
        "resolved": true,
        "details": {
          "function_name": "virFileFdopen",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2020-10701/repo/src/util/virfile.c",
          "lines": "164-177",
          "snippet": "FILE *virFileFdopen(int *fdptr, const char *mode)\n{\n    FILE *file = NULL;\n\n    if (*fdptr >= 0) {\n        file = fdopen(*fdptr, mode);\n        if (file)\n            *fdptr = -1;\n    } else {\n        errno = EBADF;\n    }\n\n    return file;\n}",
          "includes": [
            "#include \"virsocket.h\"",
            "#include \"virutil.h\"",
            "#include \"virstring.h\"",
            "#include \"virprocess.h\"",
            "#include \"virlog.h\"",
            "#include \"virkmod.h\"",
            "#include \"virfile.h\"",
            "#include \"virerror.h\"",
            "#include \"vircommand.h\"",
            "#include \"viralloc.h\"",
            "#include \"configmake.h\"",
            "# include <sys/xattr.h>",
            "# include <linux/cdrom.h>",
            "# include <sys/ioctl.h>",
            "#  include <linux/loop.h>",
            "# include <sys/statfs.h>",
            "#  include <linux/magic.h>",
            "#include <sys/file.h>",
            "# include <sys/acl.h>",
            "# include <sys/syscall.h>",
            "# include <sys/mman.h>",
            "# include <mntent.h>",
            "#include <dirent.h>",
            "#include <unistd.h>",
            "# include <sys/mount.h>",
            "#include <sys/stat.h>",
            "# include <libutil.h>",
            "# include <util.h>",
            "# include <pty.h>",
            "# include <termios.h>",
            "#include <fcntl.h>",
            "#include \"internal.h\"",
            "#include <config.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"virsocket.h\"\n#include \"virutil.h\"\n#include \"virstring.h\"\n#include \"virprocess.h\"\n#include \"virlog.h\"\n#include \"virkmod.h\"\n#include \"virfile.h\"\n#include \"virerror.h\"\n#include \"vircommand.h\"\n#include \"viralloc.h\"\n#include \"configmake.h\"\n# include <sys/xattr.h>\n# include <linux/cdrom.h>\n# include <sys/ioctl.h>\n#  include <linux/loop.h>\n# include <sys/statfs.h>\n#  include <linux/magic.h>\n#include <sys/file.h>\n# include <sys/acl.h>\n# include <sys/syscall.h>\n# include <sys/mman.h>\n# include <mntent.h>\n#include <dirent.h>\n#include <unistd.h>\n# include <sys/mount.h>\n#include <sys/stat.h>\n# include <libutil.h>\n# include <util.h>\n# include <pty.h>\n# include <termios.h>\n#include <fcntl.h>\n#include \"internal.h\"\n#include <config.h>\n\nFILE *virFileFdopen(int *fdptr, const char *mode)\n{\n    FILE *file = NULL;\n\n    if (*fdptr >= 0) {\n        file = fdopen(*fdptr, mode);\n        if (file)\n            *fdptr = -1;\n    } else {\n        errno = EBADF;\n    }\n\n    return file;\n}"
        }
      },
      {
        "call_info": {
          "callee": "virReportSystemError",
          "args": [
            "errno",
            "_(\"Cannot open init control %s\")",
            "fifo"
          ],
          "line": 146
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "&req",
            "0",
            "sizeof(req)"
          ],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"virstring.h\"\n#include \"virfile.h\"\n#include \"viralloc.h\"\n#include \"virutil.h\"\n#include \"virerror.h\"\n#include \"virinitctl.h\"\n#include \"internal.h\"\n#include <fcntl.h>\n#include <sys/param.h>\n#include <config.h>\n\nint\nvirInitctlSetRunLevel(const char *fifo,\n                      virInitctlRunLevel level)\n{\n    struct virInitctlRequest req;\n    int fd = -1;\n    int ret = -1;\n    const int open_flags = O_WRONLY|O_NONBLOCK|O_CLOEXEC|O_NOCTTY;\n    size_t i = 0;\n\n    memset(&req, 0, sizeof(req));\n\n    req.magic = VIR_INITCTL_MAGIC;\n    req.sleeptime = 0;\n    req.cmd = VIR_INITCTL_CMD_RUNLVL;\n    /* Yes it is an 'int' field, but wants a numeric character. Go figure */\n    req.runlevel = '0' + level;\n\n    if (fifo) {\n        if ((fd = open(fifo, open_flags)) < 0) {\n            virReportSystemError(errno,\n                                 _(\"Cannot open init control %s\"),\n                                 fifo);\n            goto cleanup;\n        }\n    } else {\n        for (i = 0; virInitctlFifos[i]; i++) {\n            fifo = virInitctlFifos[i];\n\n            if ((fd = open(fifo, open_flags)) >= 0)\n                break;\n\n            if (errno != ENOENT) {\n                virReportSystemError(errno,\n                                     _(\"Cannot open init control %s\"),\n                                     fifo);\n                goto cleanup;\n            }\n        }\n\n        /* Ensure we found a valid initctl fifo */\n        if (fd < 0) {\n            ret = 0;\n            goto cleanup;\n        }\n    }\n\n    if (safewrite(fd, &req, sizeof(req)) != sizeof(req)) {\n        virReportSystemError(errno,\n                             _(\"Failed to send request to init control %s\"),\n                             fifo);\n        goto cleanup;\n    }\n\n    ret = 1;\n\n cleanup:\n    VIR_FORCE_CLOSE(fd);\n    return ret;\n}"
  }
]