[
  {
    "function_name": "pam_sm_close_session",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "793-818",
    "snippet": "int\npam_sm_close_session(pam_handle_t *pamh, int flags UNUSED,\n\t\t     int argc, const char **argv)\n{\n  int i, debug = 0, open_session = 0;\n\n  /* Parse arguments. */\n  for (i = 0; i < argc; i++) {\n    if (strcmp(argv[i], \"debug\") == 0) {\n      debug = 1;\n    }\n    if (strcmp(argv[i], \"open\") == 0) {\n      open_session = 1;\n    }\n  }\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Close Session\");\n\n  /* Is this module supposed to execute open_session only? */\n  if (open_session)\n    return PAM_SUCCESS;\n\n  /* Restore original context. */\n  return restore_context(pamh, get_module_data(pamh), debug);\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "restore_context",
          "args": [
            "pamh",
            "get_module_data(pamh)",
            "debug"
          ],
          "line": 817
        },
        "resolved": true,
        "details": {
          "function_name": "restore_context",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "584-613",
          "snippet": "static int\nrestore_context(const pam_handle_t *pamh, const module_data_t *data, int debug)\n{\n  int err;\n\n  if (!data) {\n    if (debug)\n      pam_syslog(pamh, LOG_NOTICE, \"No context to restore\");\n    return PAM_SUCCESS;\n  }\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE,\n\t       \"Restore file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->tty_context ? data->tty_context : \"\",\n\t       data->prev_tty_context ? data->prev_tty_context : \"\");\n  err = set_file_context(pamh, data->prev_tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Restore executable context: [%s] -> [%s]\",\n\t       data->exec_context,\n\t       data->prev_exec_context ? data->prev_exec_context : \"\");\n  err |= set_exec_context(pamh, data->prev_exec_context);\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nrestore_context(const pam_handle_t *pamh, const module_data_t *data, int debug)\n{\n  int err;\n\n  if (!data) {\n    if (debug)\n      pam_syslog(pamh, LOG_NOTICE, \"No context to restore\");\n    return PAM_SUCCESS;\n  }\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE,\n\t       \"Restore file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->tty_context ? data->tty_context : \"\",\n\t       data->prev_tty_context ? data->prev_tty_context : \"\");\n  err = set_file_context(pamh, data->prev_tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Restore executable context: [%s] -> [%s]\",\n\t       data->exec_context,\n\t       data->prev_exec_context ? data->prev_exec_context : \"\");\n  err |= set_exec_context(pamh, data->prev_exec_context);\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_module_data",
          "args": [
            "pamh"
          ],
          "line": 817
        },
        "resolved": true,
        "details": {
          "function_name": "get_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "406-412",
          "snippet": "static const module_data_t *\nget_module_data(const pam_handle_t *pamh)\n{\n  const void *data;\n\n  return (pam_get_data(pamh, DATANAME, &data) == PAM_SUCCESS) ? data : NULL;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [
            "#define DATANAME \"pam_selinux_context\""
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\n#define DATANAME \"pam_selinux_context\"\n\nstatic const module_data_t *\nget_module_data(const pam_handle_t *pamh)\n{\n  const void *data;\n\n  return (pam_get_data(pamh, DATANAME, &data) == PAM_SUCCESS) ? data : NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Close Session\""
          ],
          "line": 810
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "argv[i]",
            "\"open\""
          ],
          "line": 804
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "argv[i]",
            "\"debug\""
          ],
          "line": 801
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nint\npam_sm_close_session(pam_handle_t *pamh, int flags UNUSED,\n\t\t     int argc, const char **argv)\n{\n  int i, debug = 0, open_session = 0;\n\n  /* Parse arguments. */\n  for (i = 0; i < argc; i++) {\n    if (strcmp(argv[i], \"debug\") == 0) {\n      debug = 1;\n    }\n    if (strcmp(argv[i], \"open\") == 0) {\n      open_session = 1;\n    }\n  }\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Close Session\");\n\n  /* Is this module supposed to execute open_session only? */\n  if (open_session)\n    return PAM_SUCCESS;\n\n  /* Restore original context. */\n  return restore_context(pamh, get_module_data(pamh), debug);\n}"
  },
  {
    "function_name": "pam_sm_open_session",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "752-791",
    "snippet": "int\npam_sm_open_session(pam_handle_t *pamh, int flags UNUSED,\n\t\t    int argc, const char **argv)\n{\n  const module_data_t *data;\n  int i, debug = 0, verbose = 0, close_session = 0, restore = 0;\n\n  /* Parse arguments. */\n  for (i = 0; i < argc; i++) {\n    if (strcmp(argv[i], \"debug\") == 0) {\n      debug = 1;\n    }\n    if (strcmp(argv[i], \"verbose\") == 0) {\n      verbose = 1;\n    }\n    if (strcmp(argv[i], \"close\") == 0) {\n      close_session = 1;\n    }\n    if (strcmp(argv[i], \"restore\") == 0) {\n      restore = 1;\n    }\n  }\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Open Session\");\n\n  /* Is this module supposed to execute close_session only? */\n  if (close_session)\n    return PAM_SUCCESS;\n\n  data = get_module_data(pamh);\n\n  /* Is this module supposed only to restore original context? */\n  if (restore)\n    return restore_context(pamh, data, debug);\n\n  /* If there is a saved context, this module is supposed to set it again. */\n  return data ? set_context(pamh, data, debug, verbose) :\n    create_context(pamh, argc, argv, debug, verbose);\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "create_context",
          "args": [
            "pamh",
            "argc",
            "argv",
            "debug",
            "verbose"
          ],
          "line": 790
        },
        "resolved": true,
        "details": {
          "function_name": "create_context",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "667-735",
          "snippet": "static int\ncreate_context(pam_handle_t *pamh, int argc, const char **argv,\n\t       int debug, int verbose)\n{\n  int i;\n  int ttys = 1;\n  int select_context = 0;\n  int use_current_range = 0;\n  int env_params = 0;\n  module_data_t *data;\n\n  /* Parse arguments. */\n  for (i = 0; i < argc; i++) {\n    if (strcmp(argv[i], \"nottys\") == 0) {\n      ttys = 0;\n    }\n    if (strcmp(argv[i], \"select_context\") == 0) {\n      select_context = 1;\n    }\n    if (strcmp(argv[i], \"use_current_range\") == 0) {\n      use_current_range = 1;\n    }\n    if (strcmp(argv[i], \"env_params\") == 0) {\n      env_params = 1;\n    }\n  }\n\n  if (is_selinux_enabled() <= 0) {\n    if (debug)\n      pam_syslog(pamh, LOG_NOTICE, \"SELinux is not enabled\");\n    return PAM_SUCCESS;\n  }\n\n  if (select_context && env_params) {\n    pam_syslog(pamh, LOG_ERR,\n\t       \"select_context cannot be used with env_params\");\n    select_context = 0;\n  }\n\n  if (!(data = calloc(1, sizeof(*data)))) {\n    pam_syslog(pamh, LOG_CRIT, \"Out of memory\");\n    return PAM_BUF_ERR;\n  }\n\n  i = compute_exec_context(pamh, data, select_context, use_current_range,\n\t\t\t   env_params, debug);\n  if (i != PAM_SUCCESS) {\n    free_module_data(data);\n    return i;\n  }\n\n  if (!data->exec_context) {\n    free_module_data(data);\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  if (ttys && (i = compute_tty_context(pamh, data)) != PAM_SUCCESS) {\n    free_module_data(data);\n    return i;\n  }\n\n  if ((i = pam_set_data(pamh, DATANAME, data, cleanup)) != PAM_SUCCESS) {\n    pam_syslog(pamh, LOG_ERR, \"Error saving context: %m\");\n    free_module_data(data);\n    return i;\n  }\n\n  return set_context(pamh, data, debug, verbose);\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [
            "#define DATANAME \"pam_selinux_context\""
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\n#define DATANAME \"pam_selinux_context\"\n\nstatic int\ncreate_context(pam_handle_t *pamh, int argc, const char **argv,\n\t       int debug, int verbose)\n{\n  int i;\n  int ttys = 1;\n  int select_context = 0;\n  int use_current_range = 0;\n  int env_params = 0;\n  module_data_t *data;\n\n  /* Parse arguments. */\n  for (i = 0; i < argc; i++) {\n    if (strcmp(argv[i], \"nottys\") == 0) {\n      ttys = 0;\n    }\n    if (strcmp(argv[i], \"select_context\") == 0) {\n      select_context = 1;\n    }\n    if (strcmp(argv[i], \"use_current_range\") == 0) {\n      use_current_range = 1;\n    }\n    if (strcmp(argv[i], \"env_params\") == 0) {\n      env_params = 1;\n    }\n  }\n\n  if (is_selinux_enabled() <= 0) {\n    if (debug)\n      pam_syslog(pamh, LOG_NOTICE, \"SELinux is not enabled\");\n    return PAM_SUCCESS;\n  }\n\n  if (select_context && env_params) {\n    pam_syslog(pamh, LOG_ERR,\n\t       \"select_context cannot be used with env_params\");\n    select_context = 0;\n  }\n\n  if (!(data = calloc(1, sizeof(*data)))) {\n    pam_syslog(pamh, LOG_CRIT, \"Out of memory\");\n    return PAM_BUF_ERR;\n  }\n\n  i = compute_exec_context(pamh, data, select_context, use_current_range,\n\t\t\t   env_params, debug);\n  if (i != PAM_SUCCESS) {\n    free_module_data(data);\n    return i;\n  }\n\n  if (!data->exec_context) {\n    free_module_data(data);\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  if (ttys && (i = compute_tty_context(pamh, data)) != PAM_SUCCESS) {\n    free_module_data(data);\n    return i;\n  }\n\n  if ((i = pam_set_data(pamh, DATANAME, data, cleanup)) != PAM_SUCCESS) {\n    pam_syslog(pamh, LOG_ERR, \"Error saving context: %m\");\n    free_module_data(data);\n    return i;\n  }\n\n  return set_context(pamh, data, debug, verbose);\n}"
        }
      },
      {
        "call_info": {
          "callee": "set_context",
          "args": [
            "pamh",
            "data",
            "debug",
            "verbose"
          ],
          "line": 789
        },
        "resolved": true,
        "details": {
          "function_name": "set_context",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "615-665",
          "snippet": "static int\nset_context(pam_handle_t *pamh, const module_data_t *data,\n\t    int debug, int verbose)\n{\n  int rc, err;\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE, \"Set file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->prev_tty_context ? data->prev_tty_context : \"\",\n\t       data->tty_context ? data->tty_context : \"\");\n  err = set_file_context(pamh, data->tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set executable context: [%s] -> [%s]\",\n\t       data->prev_exec_context ? data->prev_exec_context : \"\",\n\t       data->exec_context);\n  rc = set_exec_context(pamh, data->exec_context);\n  err |= rc;\n\n  send_audit_message(pamh, !rc, data->default_user_context, data->exec_context);\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Security context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#ifdef HAVE_SETKEYCREATECON\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set key creation context to %s\",\n\t       data->exec_context ? data->exec_context : \"\");\n  rc = setkeycreatecon(data->exec_context);\n  err |= rc;\n  if (rc)\n    pam_syslog(pamh, LOG_ERR, \"Setting key creation context %s failed: %m\",\n\t       data->exec_context ? data->exec_context : \"\");\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Key creation context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#endif\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nset_context(pam_handle_t *pamh, const module_data_t *data,\n\t    int debug, int verbose)\n{\n  int rc, err;\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE, \"Set file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->prev_tty_context ? data->prev_tty_context : \"\",\n\t       data->tty_context ? data->tty_context : \"\");\n  err = set_file_context(pamh, data->tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set executable context: [%s] -> [%s]\",\n\t       data->prev_exec_context ? data->prev_exec_context : \"\",\n\t       data->exec_context);\n  rc = set_exec_context(pamh, data->exec_context);\n  err |= rc;\n\n  send_audit_message(pamh, !rc, data->default_user_context, data->exec_context);\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Security context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#ifdef HAVE_SETKEYCREATECON\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set key creation context to %s\",\n\t       data->exec_context ? data->exec_context : \"\");\n  rc = setkeycreatecon(data->exec_context);\n  err |= rc;\n  if (rc)\n    pam_syslog(pamh, LOG_ERR, \"Setting key creation context %s failed: %m\",\n\t       data->exec_context ? data->exec_context : \"\");\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Key creation context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#endif\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}"
        }
      },
      {
        "call_info": {
          "callee": "restore_context",
          "args": [
            "pamh",
            "data",
            "debug"
          ],
          "line": 786
        },
        "resolved": true,
        "details": {
          "function_name": "restore_context",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "584-613",
          "snippet": "static int\nrestore_context(const pam_handle_t *pamh, const module_data_t *data, int debug)\n{\n  int err;\n\n  if (!data) {\n    if (debug)\n      pam_syslog(pamh, LOG_NOTICE, \"No context to restore\");\n    return PAM_SUCCESS;\n  }\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE,\n\t       \"Restore file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->tty_context ? data->tty_context : \"\",\n\t       data->prev_tty_context ? data->prev_tty_context : \"\");\n  err = set_file_context(pamh, data->prev_tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Restore executable context: [%s] -> [%s]\",\n\t       data->exec_context,\n\t       data->prev_exec_context ? data->prev_exec_context : \"\");\n  err |= set_exec_context(pamh, data->prev_exec_context);\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nrestore_context(const pam_handle_t *pamh, const module_data_t *data, int debug)\n{\n  int err;\n\n  if (!data) {\n    if (debug)\n      pam_syslog(pamh, LOG_NOTICE, \"No context to restore\");\n    return PAM_SUCCESS;\n  }\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE,\n\t       \"Restore file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->tty_context ? data->tty_context : \"\",\n\t       data->prev_tty_context ? data->prev_tty_context : \"\");\n  err = set_file_context(pamh, data->prev_tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Restore executable context: [%s] -> [%s]\",\n\t       data->exec_context,\n\t       data->prev_exec_context ? data->prev_exec_context : \"\");\n  err |= set_exec_context(pamh, data->prev_exec_context);\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}"
        }
      },
      {
        "call_info": {
          "callee": "get_module_data",
          "args": [
            "pamh"
          ],
          "line": 782
        },
        "resolved": true,
        "details": {
          "function_name": "get_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "406-412",
          "snippet": "static const module_data_t *\nget_module_data(const pam_handle_t *pamh)\n{\n  const void *data;\n\n  return (pam_get_data(pamh, DATANAME, &data) == PAM_SUCCESS) ? data : NULL;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [
            "#define DATANAME \"pam_selinux_context\""
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\n#define DATANAME \"pam_selinux_context\"\n\nstatic const module_data_t *\nget_module_data(const pam_handle_t *pamh)\n{\n  const void *data;\n\n  return (pam_get_data(pamh, DATANAME, &data) == PAM_SUCCESS) ? data : NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Open Session\""
          ],
          "line": 776
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "argv[i]",
            "\"restore\""
          ],
          "line": 770
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "argv[i]",
            "\"close\""
          ],
          "line": 767
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "argv[i]",
            "\"verbose\""
          ],
          "line": 764
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "argv[i]",
            "\"debug\""
          ],
          "line": 761
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nint\npam_sm_open_session(pam_handle_t *pamh, int flags UNUSED,\n\t\t    int argc, const char **argv)\n{\n  const module_data_t *data;\n  int i, debug = 0, verbose = 0, close_session = 0, restore = 0;\n\n  /* Parse arguments. */\n  for (i = 0; i < argc; i++) {\n    if (strcmp(argv[i], \"debug\") == 0) {\n      debug = 1;\n    }\n    if (strcmp(argv[i], \"verbose\") == 0) {\n      verbose = 1;\n    }\n    if (strcmp(argv[i], \"close\") == 0) {\n      close_session = 1;\n    }\n    if (strcmp(argv[i], \"restore\") == 0) {\n      restore = 1;\n    }\n  }\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Open Session\");\n\n  /* Is this module supposed to execute close_session only? */\n  if (close_session)\n    return PAM_SUCCESS;\n\n  data = get_module_data(pamh);\n\n  /* Is this module supposed only to restore original context? */\n  if (restore)\n    return restore_context(pamh, data, debug);\n\n  /* If there is a saved context, this module is supposed to set it again. */\n  return data ? set_context(pamh, data, debug, verbose) :\n    create_context(pamh, argc, argv, debug, verbose);\n}"
  },
  {
    "function_name": "pam_sm_setcred",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "745-750",
    "snippet": "int\npam_sm_setcred(pam_handle_t *pamh UNUSED, int flags UNUSED,\n\t       int argc UNUSED, const char **argv UNUSED)\n{\n  return PAM_SUCCESS;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nint\npam_sm_setcred(pam_handle_t *pamh UNUSED, int flags UNUSED,\n\t       int argc UNUSED, const char **argv UNUSED)\n{\n  return PAM_SUCCESS;\n}"
  },
  {
    "function_name": "pam_sm_authenticate",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "737-743",
    "snippet": "int\npam_sm_authenticate(pam_handle_t *pamh UNUSED, int flags UNUSED,\n\t\t    int argc UNUSED, const char **argv UNUSED)\n{\n  /* Fail by default. */\n  return PAM_AUTH_ERR;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nint\npam_sm_authenticate(pam_handle_t *pamh UNUSED, int flags UNUSED,\n\t\t    int argc UNUSED, const char **argv UNUSED)\n{\n  /* Fail by default. */\n  return PAM_AUTH_ERR;\n}"
  },
  {
    "function_name": "create_context",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "667-735",
    "snippet": "static int\ncreate_context(pam_handle_t *pamh, int argc, const char **argv,\n\t       int debug, int verbose)\n{\n  int i;\n  int ttys = 1;\n  int select_context = 0;\n  int use_current_range = 0;\n  int env_params = 0;\n  module_data_t *data;\n\n  /* Parse arguments. */\n  for (i = 0; i < argc; i++) {\n    if (strcmp(argv[i], \"nottys\") == 0) {\n      ttys = 0;\n    }\n    if (strcmp(argv[i], \"select_context\") == 0) {\n      select_context = 1;\n    }\n    if (strcmp(argv[i], \"use_current_range\") == 0) {\n      use_current_range = 1;\n    }\n    if (strcmp(argv[i], \"env_params\") == 0) {\n      env_params = 1;\n    }\n  }\n\n  if (is_selinux_enabled() <= 0) {\n    if (debug)\n      pam_syslog(pamh, LOG_NOTICE, \"SELinux is not enabled\");\n    return PAM_SUCCESS;\n  }\n\n  if (select_context && env_params) {\n    pam_syslog(pamh, LOG_ERR,\n\t       \"select_context cannot be used with env_params\");\n    select_context = 0;\n  }\n\n  if (!(data = calloc(1, sizeof(*data)))) {\n    pam_syslog(pamh, LOG_CRIT, \"Out of memory\");\n    return PAM_BUF_ERR;\n  }\n\n  i = compute_exec_context(pamh, data, select_context, use_current_range,\n\t\t\t   env_params, debug);\n  if (i != PAM_SUCCESS) {\n    free_module_data(data);\n    return i;\n  }\n\n  if (!data->exec_context) {\n    free_module_data(data);\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  if (ttys && (i = compute_tty_context(pamh, data)) != PAM_SUCCESS) {\n    free_module_data(data);\n    return i;\n  }\n\n  if ((i = pam_set_data(pamh, DATANAME, data, cleanup)) != PAM_SUCCESS) {\n    pam_syslog(pamh, LOG_ERR, \"Error saving context: %m\");\n    free_module_data(data);\n    return i;\n  }\n\n  return set_context(pamh, data, debug, verbose);\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [
      "#define DATANAME \"pam_selinux_context\""
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "set_context",
          "args": [
            "pamh",
            "data",
            "debug",
            "verbose"
          ],
          "line": 734
        },
        "resolved": true,
        "details": {
          "function_name": "set_context",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "615-665",
          "snippet": "static int\nset_context(pam_handle_t *pamh, const module_data_t *data,\n\t    int debug, int verbose)\n{\n  int rc, err;\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE, \"Set file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->prev_tty_context ? data->prev_tty_context : \"\",\n\t       data->tty_context ? data->tty_context : \"\");\n  err = set_file_context(pamh, data->tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set executable context: [%s] -> [%s]\",\n\t       data->prev_exec_context ? data->prev_exec_context : \"\",\n\t       data->exec_context);\n  rc = set_exec_context(pamh, data->exec_context);\n  err |= rc;\n\n  send_audit_message(pamh, !rc, data->default_user_context, data->exec_context);\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Security context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#ifdef HAVE_SETKEYCREATECON\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set key creation context to %s\",\n\t       data->exec_context ? data->exec_context : \"\");\n  rc = setkeycreatecon(data->exec_context);\n  err |= rc;\n  if (rc)\n    pam_syslog(pamh, LOG_ERR, \"Setting key creation context %s failed: %m\",\n\t       data->exec_context ? data->exec_context : \"\");\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Key creation context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#endif\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nset_context(pam_handle_t *pamh, const module_data_t *data,\n\t    int debug, int verbose)\n{\n  int rc, err;\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE, \"Set file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->prev_tty_context ? data->prev_tty_context : \"\",\n\t       data->tty_context ? data->tty_context : \"\");\n  err = set_file_context(pamh, data->tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set executable context: [%s] -> [%s]\",\n\t       data->prev_exec_context ? data->prev_exec_context : \"\",\n\t       data->exec_context);\n  rc = set_exec_context(pamh, data->exec_context);\n  err |= rc;\n\n  send_audit_message(pamh, !rc, data->default_user_context, data->exec_context);\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Security context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#ifdef HAVE_SETKEYCREATECON\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set key creation context to %s\",\n\t       data->exec_context ? data->exec_context : \"\");\n  rc = setkeycreatecon(data->exec_context);\n  err |= rc;\n  if (rc)\n    pam_syslog(pamh, LOG_ERR, \"Setting key creation context %s failed: %m\",\n\t       data->exec_context ? data->exec_context : \"\");\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Key creation context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#endif\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}"
        }
      },
      {
        "call_info": {
          "callee": "free_module_data",
          "args": [
            "data"
          ],
          "line": 730
        },
        "resolved": true,
        "details": {
          "function_name": "free_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "386-398",
          "snippet": "static void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Error saving context: %m\""
          ],
          "line": 729
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_set_data",
          "args": [
            "pamh",
            "DATANAME",
            "data",
            "cleanup"
          ],
          "line": 728
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "compute_tty_context",
          "args": [
            "pamh",
            "data"
          ],
          "line": 723
        },
        "resolved": true,
        "details": {
          "function_name": "compute_tty_context",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "518-582",
          "snippet": "static int\ncompute_tty_context(const pam_handle_t *pamh, module_data_t *data)\n{\n  const char *tty = get_item(pamh, PAM_TTY);\n  security_class_t tclass;\n\n  if (!tty || !*tty || !strcmp(tty, \"ssh\")\n      || pam_str_skip_prefix(tty, \"NODEV\") != NULL) {\n    tty = ttyname(STDIN_FILENO);\n    if (!tty || !*tty)\n      tty = ttyname(STDOUT_FILENO);\n    if (!tty || !*tty)\n      tty = ttyname(STDERR_FILENO);\n    if (!tty || !*tty)\n      return PAM_SUCCESS;\n  }\n\n  if (pam_str_skip_prefix(tty, \"/dev/\") == NULL) {\n    if (asprintf(&data->tty_path, \"%s%s\", \"/dev/\", tty) < 0)\n      data->tty_path = NULL;\n  } else {\n    data->tty_path = strdup(tty);\n  }\n\n  if (!data->tty_path) {\n    pam_syslog(pamh, LOG_CRIT, \"Out of memory\");\n    return PAM_BUF_ERR;\n  }\n\n  if (getfilecon(data->tty_path, &data->prev_tty_context) < 0) {\n    data->prev_tty_context = NULL;\n    if (errno == ENOENT) {\n      free(data->tty_path);\n      data->tty_path = NULL;\n      return PAM_SUCCESS;\n    }\n    pam_syslog(pamh, LOG_ERR, \"Failed to get current context for %s: %m\",\n\t       data->tty_path);\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  tclass = string_to_security_class(\"chr_file\");\n  if (tclass == 0) {\n    pam_syslog(pamh, LOG_ERR, \"Failed to get chr_file security class\");\n    freecon(data->prev_tty_context);\n    data->prev_tty_context = NULL;\n    free(data->tty_path);\n    data->tty_path = NULL;\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  if (security_compute_relabel(data->exec_context, data->prev_tty_context,\n\t\t\t       tclass, &data->tty_context)) {\n    data->tty_context = NULL;\n    pam_syslog(pamh, LOG_ERR, \"Failed to compute new context for %s: %m\",\n\t       data->tty_path);\n    freecon(data->prev_tty_context);\n    data->prev_tty_context = NULL;\n    free(data->tty_path);\n    data->tty_path = NULL;\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  return PAM_SUCCESS;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\ncompute_tty_context(const pam_handle_t *pamh, module_data_t *data)\n{\n  const char *tty = get_item(pamh, PAM_TTY);\n  security_class_t tclass;\n\n  if (!tty || !*tty || !strcmp(tty, \"ssh\")\n      || pam_str_skip_prefix(tty, \"NODEV\") != NULL) {\n    tty = ttyname(STDIN_FILENO);\n    if (!tty || !*tty)\n      tty = ttyname(STDOUT_FILENO);\n    if (!tty || !*tty)\n      tty = ttyname(STDERR_FILENO);\n    if (!tty || !*tty)\n      return PAM_SUCCESS;\n  }\n\n  if (pam_str_skip_prefix(tty, \"/dev/\") == NULL) {\n    if (asprintf(&data->tty_path, \"%s%s\", \"/dev/\", tty) < 0)\n      data->tty_path = NULL;\n  } else {\n    data->tty_path = strdup(tty);\n  }\n\n  if (!data->tty_path) {\n    pam_syslog(pamh, LOG_CRIT, \"Out of memory\");\n    return PAM_BUF_ERR;\n  }\n\n  if (getfilecon(data->tty_path, &data->prev_tty_context) < 0) {\n    data->prev_tty_context = NULL;\n    if (errno == ENOENT) {\n      free(data->tty_path);\n      data->tty_path = NULL;\n      return PAM_SUCCESS;\n    }\n    pam_syslog(pamh, LOG_ERR, \"Failed to get current context for %s: %m\",\n\t       data->tty_path);\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  tclass = string_to_security_class(\"chr_file\");\n  if (tclass == 0) {\n    pam_syslog(pamh, LOG_ERR, \"Failed to get chr_file security class\");\n    freecon(data->prev_tty_context);\n    data->prev_tty_context = NULL;\n    free(data->tty_path);\n    data->tty_path = NULL;\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  if (security_compute_relabel(data->exec_context, data->prev_tty_context,\n\t\t\t       tclass, &data->tty_context)) {\n    data->tty_context = NULL;\n    pam_syslog(pamh, LOG_ERR, \"Failed to compute new context for %s: %m\",\n\t       data->tty_path);\n    freecon(data->prev_tty_context);\n    data->prev_tty_context = NULL;\n    free(data->tty_path);\n    data->tty_path = NULL;\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  return PAM_SUCCESS;\n}"
        }
      },
      {
        "call_info": {
          "callee": "security_getenforce",
          "args": [],
          "line": 720
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "compute_exec_context",
          "args": [
            "pamh",
            "data",
            "select_context",
            "use_current_range",
            "env_params",
            "debug"
          ],
          "line": 711
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_CRIT",
            "\"Out of memory\""
          ],
          "line": 707
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "calloc",
          "args": [
            "1",
            "sizeof(*data)"
          ],
          "line": 706
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"select_context cannot be used with env_params\""
          ],
          "line": 701
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"SELinux is not enabled\""
          ],
          "line": 696
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "is_selinux_enabled",
          "args": [],
          "line": 694
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "argv[i]",
            "\"env_params\""
          ],
          "line": 689
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "argv[i]",
            "\"use_current_range\""
          ],
          "line": 686
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "argv[i]",
            "\"select_context\""
          ],
          "line": 683
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "argv[i]",
            "\"nottys\""
          ],
          "line": 680
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\n#define DATANAME \"pam_selinux_context\"\n\nstatic int\ncreate_context(pam_handle_t *pamh, int argc, const char **argv,\n\t       int debug, int verbose)\n{\n  int i;\n  int ttys = 1;\n  int select_context = 0;\n  int use_current_range = 0;\n  int env_params = 0;\n  module_data_t *data;\n\n  /* Parse arguments. */\n  for (i = 0; i < argc; i++) {\n    if (strcmp(argv[i], \"nottys\") == 0) {\n      ttys = 0;\n    }\n    if (strcmp(argv[i], \"select_context\") == 0) {\n      select_context = 1;\n    }\n    if (strcmp(argv[i], \"use_current_range\") == 0) {\n      use_current_range = 1;\n    }\n    if (strcmp(argv[i], \"env_params\") == 0) {\n      env_params = 1;\n    }\n  }\n\n  if (is_selinux_enabled() <= 0) {\n    if (debug)\n      pam_syslog(pamh, LOG_NOTICE, \"SELinux is not enabled\");\n    return PAM_SUCCESS;\n  }\n\n  if (select_context && env_params) {\n    pam_syslog(pamh, LOG_ERR,\n\t       \"select_context cannot be used with env_params\");\n    select_context = 0;\n  }\n\n  if (!(data = calloc(1, sizeof(*data)))) {\n    pam_syslog(pamh, LOG_CRIT, \"Out of memory\");\n    return PAM_BUF_ERR;\n  }\n\n  i = compute_exec_context(pamh, data, select_context, use_current_range,\n\t\t\t   env_params, debug);\n  if (i != PAM_SUCCESS) {\n    free_module_data(data);\n    return i;\n  }\n\n  if (!data->exec_context) {\n    free_module_data(data);\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  if (ttys && (i = compute_tty_context(pamh, data)) != PAM_SUCCESS) {\n    free_module_data(data);\n    return i;\n  }\n\n  if ((i = pam_set_data(pamh, DATANAME, data, cleanup)) != PAM_SUCCESS) {\n    pam_syslog(pamh, LOG_ERR, \"Error saving context: %m\");\n    free_module_data(data);\n    return i;\n  }\n\n  return set_context(pamh, data, debug, verbose);\n}"
  },
  {
    "function_name": "set_context",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "615-665",
    "snippet": "static int\nset_context(pam_handle_t *pamh, const module_data_t *data,\n\t    int debug, int verbose)\n{\n  int rc, err;\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE, \"Set file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->prev_tty_context ? data->prev_tty_context : \"\",\n\t       data->tty_context ? data->tty_context : \"\");\n  err = set_file_context(pamh, data->tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set executable context: [%s] -> [%s]\",\n\t       data->prev_exec_context ? data->prev_exec_context : \"\",\n\t       data->exec_context);\n  rc = set_exec_context(pamh, data->exec_context);\n  err |= rc;\n\n  send_audit_message(pamh, !rc, data->default_user_context, data->exec_context);\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Security context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#ifdef HAVE_SETKEYCREATECON\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set key creation context to %s\",\n\t       data->exec_context ? data->exec_context : \"\");\n  rc = setkeycreatecon(data->exec_context);\n  err |= rc;\n  if (rc)\n    pam_syslog(pamh, LOG_ERR, \"Setting key creation context %s failed: %m\",\n\t       data->exec_context ? data->exec_context : \"\");\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Key creation context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#endif\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "security_getenforce",
          "args": [],
          "line": 661
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "send_text",
          "args": [
            "pamh",
            "msg",
            "debug"
          ],
          "line": 657
        },
        "resolved": true,
        "details": {
          "function_name": "send_text",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "129-135",
          "snippet": "static int\nsend_text (pam_handle_t *pamh, const char *text, int debug)\n{\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"%s\", text);\n  return pam_info (pamh, \"%s\", text);\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nsend_text (pam_handle_t *pamh, const char *text, int debug)\n{\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"%s\", text);\n  return pam_info (pamh, \"%s\", text);\n}"
        }
      },
      {
        "call_info": {
          "callee": "snprintf",
          "args": [
            "msg",
            "sizeof(msg)",
            "_(\"Key creation context %s has been assigned.\")",
            "data->exec_context"
          ],
          "line": 655
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"Key creation context %s has been assigned.\""
          ],
          "line": 656
        },
        "resolved": true,
        "details": {
          "function_name": "get_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "406-412",
          "snippet": "static const module_data_t *\nget_module_data(const pam_handle_t *pamh)\n{\n  const void *data;\n\n  return (pam_get_data(pamh, DATANAME, &data) == PAM_SUCCESS) ? data : NULL;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [
            "#define DATANAME \"pam_selinux_context\""
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\n#define DATANAME \"pam_selinux_context\"\n\nstatic const module_data_t *\nget_module_data(const pam_handle_t *pamh)\n{\n  const void *data;\n\n  return (pam_get_data(pamh, DATANAME, &data) == PAM_SUCCESS) ? data : NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Setting key creation context %s failed: %m\"",
            "data->exec_context ? data->exec_context : \"\""
          ],
          "line": 650
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setkeycreatecon",
          "args": [
            "data->exec_context"
          ],
          "line": 647
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Set key creation context to %s\"",
            "data->exec_context ? data->exec_context : \"\""
          ],
          "line": 645
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "snprintf",
          "args": [
            "msg",
            "sizeof(msg)",
            "_(\"Security context %s has been assigned.\")",
            "data->exec_context"
          ],
          "line": 639
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "send_audit_message",
          "args": [
            "pamh",
            "!rc",
            "data->default_user_context",
            "data->exec_context"
          ],
          "line": 635
        },
        "resolved": true,
        "details": {
          "function_name": "send_audit_message",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "72-127",
          "snippet": "static void\nsend_audit_message(const pam_handle_t *pamh, int success, const char *default_context,\n\t\t   const char *selected_context)\n{\n#ifdef HAVE_LIBAUDIT\n\tchar *msg = NULL;\n\tint audit_fd = audit_open();\n\tchar *default_raw = NULL;\n\tchar *selected_raw = NULL;\n\tconst void *tty = NULL, *rhost = NULL;\n\tif (audit_fd < 0) {\n\t\tif (errno == EINVAL || errno == EPROTONOSUPPORT ||\n                                        errno == EAFNOSUPPORT) {\n\t\t\tgoto fallback; /* No audit support in kernel */\n\t\t}\n\t\tpam_syslog(pamh, LOG_ERR, \"Error connecting to audit system: %m\");\n\t\tgoto fallback;\n\t}\n\t(void)pam_get_item(pamh, PAM_TTY, &tty);\n\t(void)pam_get_item(pamh, PAM_RHOST, &rhost);\n\tif (selinux_trans_to_raw_context(default_context, &default_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating default context '%s'.\", default_context);\n\t\tdefault_raw = NULL;\n\t}\n\tif (selinux_trans_to_raw_context(selected_context, &selected_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating selected context '%s'.\", selected_context);\n\t\tselected_raw = NULL;\n\t}\n\tif (asprintf(&msg, \"pam: default-context=%s selected-context=%s\",\n\t\t     default_raw ? default_raw : (default_context ? default_context : \"?\"),\n\t\t     selected_raw ? selected_raw : (selected_context ? selected_context : \"?\")) < 0) {\n\t\tmsg = NULL; /* asprintf leaves msg in undefined state on failure */\n\t\tpam_syslog(pamh, LOG_ERR, \"Error allocating memory.\");\n\t\tgoto fallback;\n\t}\n\tif (audit_log_user_message(audit_fd, AUDIT_USER_ROLE_CHANGE,\n\t\t\t\t   msg, rhost, NULL, tty, success) <= 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error sending audit message: %m\");\n\t\tgoto fallback;\n\t}\n\tgoto cleanup;\n\n      fallback:\n#endif /* HAVE_LIBAUDIT */\n        pam_syslog(pamh, LOG_NOTICE, \"pam: default-context=%s selected-context=%s success %d\",\n\t\t   default_context, selected_context, success);\n\n#ifdef HAVE_LIBAUDIT\n      cleanup:\n\tfree(msg);\n\tfreecon(default_raw);\n\tfreecon(selected_raw);\n\tif (audit_fd >= 0)\n\t\tclose(audit_fd);\n#endif /* HAVE_LIBAUDIT */\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nsend_audit_message(const pam_handle_t *pamh, int success, const char *default_context,\n\t\t   const char *selected_context)\n{\n#ifdef HAVE_LIBAUDIT\n\tchar *msg = NULL;\n\tint audit_fd = audit_open();\n\tchar *default_raw = NULL;\n\tchar *selected_raw = NULL;\n\tconst void *tty = NULL, *rhost = NULL;\n\tif (audit_fd < 0) {\n\t\tif (errno == EINVAL || errno == EPROTONOSUPPORT ||\n                                        errno == EAFNOSUPPORT) {\n\t\t\tgoto fallback; /* No audit support in kernel */\n\t\t}\n\t\tpam_syslog(pamh, LOG_ERR, \"Error connecting to audit system: %m\");\n\t\tgoto fallback;\n\t}\n\t(void)pam_get_item(pamh, PAM_TTY, &tty);\n\t(void)pam_get_item(pamh, PAM_RHOST, &rhost);\n\tif (selinux_trans_to_raw_context(default_context, &default_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating default context '%s'.\", default_context);\n\t\tdefault_raw = NULL;\n\t}\n\tif (selinux_trans_to_raw_context(selected_context, &selected_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating selected context '%s'.\", selected_context);\n\t\tselected_raw = NULL;\n\t}\n\tif (asprintf(&msg, \"pam: default-context=%s selected-context=%s\",\n\t\t     default_raw ? default_raw : (default_context ? default_context : \"?\"),\n\t\t     selected_raw ? selected_raw : (selected_context ? selected_context : \"?\")) < 0) {\n\t\tmsg = NULL; /* asprintf leaves msg in undefined state on failure */\n\t\tpam_syslog(pamh, LOG_ERR, \"Error allocating memory.\");\n\t\tgoto fallback;\n\t}\n\tif (audit_log_user_message(audit_fd, AUDIT_USER_ROLE_CHANGE,\n\t\t\t\t   msg, rhost, NULL, tty, success) <= 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error sending audit message: %m\");\n\t\tgoto fallback;\n\t}\n\tgoto cleanup;\n\n      fallback:\n#endif /* HAVE_LIBAUDIT */\n        pam_syslog(pamh, LOG_NOTICE, \"pam: default-context=%s selected-context=%s success %d\",\n\t\t   default_context, selected_context, success);\n\n#ifdef HAVE_LIBAUDIT\n      cleanup:\n\tfree(msg);\n\tfreecon(default_raw);\n\tfreecon(selected_raw);\n\tif (audit_fd >= 0)\n\t\tclose(audit_fd);\n#endif /* HAVE_LIBAUDIT */\n}"
        }
      },
      {
        "call_info": {
          "callee": "set_exec_context",
          "args": [
            "pamh",
            "data->exec_context"
          ],
          "line": 632
        },
        "resolved": true,
        "details": {
          "function_name": "set_exec_context",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "422-430",
          "snippet": "static int\nset_exec_context(const pam_handle_t *pamh, const char *context)\n{\n  if (setexeccon(context) == 0)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting executable context \\\"%s\\\" failed: %m\",\n\t     context ? context : \"\");\n  return -1;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nset_exec_context(const pam_handle_t *pamh, const char *context)\n{\n  if (setexeccon(context) == 0)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting executable context \\\"%s\\\" failed: %m\",\n\t     context ? context : \"\");\n  return -1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Set executable context: [%s] -> [%s]\"",
            "data->prev_exec_context ? data->prev_exec_context : \"\"",
            "data->exec_context"
          ],
          "line": 629
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "set_file_context",
          "args": [
            "pamh",
            "data->tty_context",
            "data->tty_path"
          ],
          "line": 626
        },
        "resolved": true,
        "details": {
          "function_name": "set_file_context",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "432-443",
          "snippet": "static int\nset_file_context(const pam_handle_t *pamh, const char *context,\n\t\t const char *file)\n{\n  if (!file)\n    return 0;\n  if (setfilecon(file, context) == 0 || errno == ENOENT)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting file context \\\"%s\\\" failed for %s: %m\",\n\t     context ? context : \"\", file);\n  return -1;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nset_file_context(const pam_handle_t *pamh, const char *context,\n\t\t const char *file)\n{\n  if (!file)\n    return 0;\n  if (setfilecon(file, context) == 0 || errno == ENOENT)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting file context \\\"%s\\\" failed for %s: %m\",\n\t     context ? context : \"\", file);\n  return -1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Set file context of tty %s: [%s] -> [%s]\"",
            "data->tty_path",
            "data->prev_tty_context ? data->prev_tty_context : \"\"",
            "data->tty_context ? data->tty_context : \"\""
          ],
          "line": 622
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nset_context(pam_handle_t *pamh, const module_data_t *data,\n\t    int debug, int verbose)\n{\n  int rc, err;\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE, \"Set file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->prev_tty_context ? data->prev_tty_context : \"\",\n\t       data->tty_context ? data->tty_context : \"\");\n  err = set_file_context(pamh, data->tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set executable context: [%s] -> [%s]\",\n\t       data->prev_exec_context ? data->prev_exec_context : \"\",\n\t       data->exec_context);\n  rc = set_exec_context(pamh, data->exec_context);\n  err |= rc;\n\n  send_audit_message(pamh, !rc, data->default_user_context, data->exec_context);\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Security context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#ifdef HAVE_SETKEYCREATECON\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Set key creation context to %s\",\n\t       data->exec_context ? data->exec_context : \"\");\n  rc = setkeycreatecon(data->exec_context);\n  err |= rc;\n  if (rc)\n    pam_syslog(pamh, LOG_ERR, \"Setting key creation context %s failed: %m\",\n\t       data->exec_context ? data->exec_context : \"\");\n  if (verbose && !rc) {\n    char msg[PATH_MAX];\n\n    snprintf(msg, sizeof(msg),\n\t     _(\"Key creation context %s has been assigned.\"), data->exec_context);\n    send_text(pamh, msg, debug);\n  }\n#endif\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}"
  },
  {
    "function_name": "restore_context",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "584-613",
    "snippet": "static int\nrestore_context(const pam_handle_t *pamh, const module_data_t *data, int debug)\n{\n  int err;\n\n  if (!data) {\n    if (debug)\n      pam_syslog(pamh, LOG_NOTICE, \"No context to restore\");\n    return PAM_SUCCESS;\n  }\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE,\n\t       \"Restore file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->tty_context ? data->tty_context : \"\",\n\t       data->prev_tty_context ? data->prev_tty_context : \"\");\n  err = set_file_context(pamh, data->prev_tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Restore executable context: [%s] -> [%s]\",\n\t       data->exec_context,\n\t       data->prev_exec_context ? data->prev_exec_context : \"\");\n  err |= set_exec_context(pamh, data->prev_exec_context);\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "security_getenforce",
          "args": [],
          "line": 609
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "set_exec_context",
          "args": [
            "pamh",
            "data->prev_exec_context"
          ],
          "line": 607
        },
        "resolved": true,
        "details": {
          "function_name": "set_exec_context",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "422-430",
          "snippet": "static int\nset_exec_context(const pam_handle_t *pamh, const char *context)\n{\n  if (setexeccon(context) == 0)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting executable context \\\"%s\\\" failed: %m\",\n\t     context ? context : \"\");\n  return -1;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nset_exec_context(const pam_handle_t *pamh, const char *context)\n{\n  if (setexeccon(context) == 0)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting executable context \\\"%s\\\" failed: %m\",\n\t     context ? context : \"\");\n  return -1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Restore executable context: [%s] -> [%s]\"",
            "data->exec_context",
            "data->prev_exec_context ? data->prev_exec_context : \"\""
          ],
          "line": 604
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "set_file_context",
          "args": [
            "pamh",
            "data->prev_tty_context",
            "data->tty_path"
          ],
          "line": 601
        },
        "resolved": true,
        "details": {
          "function_name": "set_file_context",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "432-443",
          "snippet": "static int\nset_file_context(const pam_handle_t *pamh, const char *context,\n\t\t const char *file)\n{\n  if (!file)\n    return 0;\n  if (setfilecon(file, context) == 0 || errno == ENOENT)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting file context \\\"%s\\\" failed for %s: %m\",\n\t     context ? context : \"\", file);\n  return -1;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nset_file_context(const pam_handle_t *pamh, const char *context,\n\t\t const char *file)\n{\n  if (!file)\n    return 0;\n  if (setfilecon(file, context) == 0 || errno == ENOENT)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting file context \\\"%s\\\" failed for %s: %m\",\n\t     context ? context : \"\", file);\n  return -1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Restore file context of tty %s: [%s] -> [%s]\"",
            "data->tty_path",
            "data->tty_context ? data->tty_context : \"\"",
            "data->prev_tty_context ? data->prev_tty_context : \"\""
          ],
          "line": 596
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"No context to restore\""
          ],
          "line": 591
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nrestore_context(const pam_handle_t *pamh, const module_data_t *data, int debug)\n{\n  int err;\n\n  if (!data) {\n    if (debug)\n      pam_syslog(pamh, LOG_NOTICE, \"No context to restore\");\n    return PAM_SUCCESS;\n  }\n\n  if (debug && data->tty_path)\n    pam_syslog(pamh, LOG_NOTICE,\n\t       \"Restore file context of tty %s: [%s] -> [%s]\",\n\t       data->tty_path,\n\t       data->tty_context ? data->tty_context : \"\",\n\t       data->prev_tty_context ? data->prev_tty_context : \"\");\n  err = set_file_context(pamh, data->prev_tty_context, data->tty_path);\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Restore executable context: [%s] -> [%s]\",\n\t       data->exec_context,\n\t       data->prev_exec_context ? data->prev_exec_context : \"\");\n  err |= set_exec_context(pamh, data->prev_exec_context);\n\n  if (err && security_getenforce() == 1)\n    return PAM_SESSION_ERR;\n\n  return PAM_SUCCESS;\n}"
  },
  {
    "function_name": "compute_tty_context",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "518-582",
    "snippet": "static int\ncompute_tty_context(const pam_handle_t *pamh, module_data_t *data)\n{\n  const char *tty = get_item(pamh, PAM_TTY);\n  security_class_t tclass;\n\n  if (!tty || !*tty || !strcmp(tty, \"ssh\")\n      || pam_str_skip_prefix(tty, \"NODEV\") != NULL) {\n    tty = ttyname(STDIN_FILENO);\n    if (!tty || !*tty)\n      tty = ttyname(STDOUT_FILENO);\n    if (!tty || !*tty)\n      tty = ttyname(STDERR_FILENO);\n    if (!tty || !*tty)\n      return PAM_SUCCESS;\n  }\n\n  if (pam_str_skip_prefix(tty, \"/dev/\") == NULL) {\n    if (asprintf(&data->tty_path, \"%s%s\", \"/dev/\", tty) < 0)\n      data->tty_path = NULL;\n  } else {\n    data->tty_path = strdup(tty);\n  }\n\n  if (!data->tty_path) {\n    pam_syslog(pamh, LOG_CRIT, \"Out of memory\");\n    return PAM_BUF_ERR;\n  }\n\n  if (getfilecon(data->tty_path, &data->prev_tty_context) < 0) {\n    data->prev_tty_context = NULL;\n    if (errno == ENOENT) {\n      free(data->tty_path);\n      data->tty_path = NULL;\n      return PAM_SUCCESS;\n    }\n    pam_syslog(pamh, LOG_ERR, \"Failed to get current context for %s: %m\",\n\t       data->tty_path);\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  tclass = string_to_security_class(\"chr_file\");\n  if (tclass == 0) {\n    pam_syslog(pamh, LOG_ERR, \"Failed to get chr_file security class\");\n    freecon(data->prev_tty_context);\n    data->prev_tty_context = NULL;\n    free(data->tty_path);\n    data->tty_path = NULL;\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  if (security_compute_relabel(data->exec_context, data->prev_tty_context,\n\t\t\t       tclass, &data->tty_context)) {\n    data->tty_context = NULL;\n    pam_syslog(pamh, LOG_ERR, \"Failed to compute new context for %s: %m\",\n\t       data->tty_path);\n    freecon(data->prev_tty_context);\n    data->prev_tty_context = NULL;\n    free(data->tty_path);\n    data->tty_path = NULL;\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  return PAM_SUCCESS;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "security_getenforce",
          "args": [],
          "line": 578
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "data->tty_path"
          ],
          "line": 576
        },
        "resolved": true,
        "details": {
          "function_name": "free_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "386-398",
          "snippet": "static void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "data->prev_tty_context"
          ],
          "line": 574
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Failed to compute new context for %s: %m\"",
            "data->tty_path"
          ],
          "line": 572
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "security_compute_relabel",
          "args": [
            "data->exec_context",
            "data->prev_tty_context",
            "tclass",
            "&data->tty_context"
          ],
          "line": 569
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "security_getenforce",
          "args": [],
          "line": 566
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "data->prev_tty_context"
          ],
          "line": 562
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Failed to get chr_file security class\""
          ],
          "line": 561
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "string_to_security_class",
          "args": [
            "\"chr_file\""
          ],
          "line": 559
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "security_getenforce",
          "args": [],
          "line": 556
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Failed to get current context for %s: %m\"",
            "data->tty_path"
          ],
          "line": 554
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getfilecon",
          "args": [
            "data->tty_path",
            "&data->prev_tty_context"
          ],
          "line": 547
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_CRIT",
            "\"Out of memory\""
          ],
          "line": 543
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "tty"
          ],
          "line": 539
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "asprintf",
          "args": [
            "&data->tty_path",
            "\"%s%s\"",
            "\"/dev/\"",
            "tty"
          ],
          "line": 536
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_str_skip_prefix",
          "args": [
            "tty",
            "\"/dev/\""
          ],
          "line": 535
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ttyname",
          "args": [
            "STDERR_FILENO"
          ],
          "line": 530
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ttyname",
          "args": [
            "STDOUT_FILENO"
          ],
          "line": 528
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ttyname",
          "args": [
            "STDIN_FILENO"
          ],
          "line": 526
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_str_skip_prefix",
          "args": [
            "tty",
            "\"NODEV\""
          ],
          "line": 525
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "tty",
            "\"ssh\""
          ],
          "line": 524
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_item",
          "args": [
            "pamh",
            "PAM_TTY"
          ],
          "line": 521
        },
        "resolved": true,
        "details": {
          "function_name": "get_item",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "414-420",
          "snippet": "static const char *\nget_item(const pam_handle_t *pamh, int item_type)\n{\n  const void *item;\n\n  return (pam_get_item(pamh, item_type, &item) == PAM_SUCCESS) ? item : NULL;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic const char *\nget_item(const pam_handle_t *pamh, int item_type)\n{\n  const void *item;\n\n  return (pam_get_item(pamh, item_type, &item) == PAM_SUCCESS) ? item : NULL;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\ncompute_tty_context(const pam_handle_t *pamh, module_data_t *data)\n{\n  const char *tty = get_item(pamh, PAM_TTY);\n  security_class_t tclass;\n\n  if (!tty || !*tty || !strcmp(tty, \"ssh\")\n      || pam_str_skip_prefix(tty, \"NODEV\") != NULL) {\n    tty = ttyname(STDIN_FILENO);\n    if (!tty || !*tty)\n      tty = ttyname(STDOUT_FILENO);\n    if (!tty || !*tty)\n      tty = ttyname(STDERR_FILENO);\n    if (!tty || !*tty)\n      return PAM_SUCCESS;\n  }\n\n  if (pam_str_skip_prefix(tty, \"/dev/\") == NULL) {\n    if (asprintf(&data->tty_path, \"%s%s\", \"/dev/\", tty) < 0)\n      data->tty_path = NULL;\n  } else {\n    data->tty_path = strdup(tty);\n  }\n\n  if (!data->tty_path) {\n    pam_syslog(pamh, LOG_CRIT, \"Out of memory\");\n    return PAM_BUF_ERR;\n  }\n\n  if (getfilecon(data->tty_path, &data->prev_tty_context) < 0) {\n    data->prev_tty_context = NULL;\n    if (errno == ENOENT) {\n      free(data->tty_path);\n      data->tty_path = NULL;\n      return PAM_SUCCESS;\n    }\n    pam_syslog(pamh, LOG_ERR, \"Failed to get current context for %s: %m\",\n\t       data->tty_path);\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  tclass = string_to_security_class(\"chr_file\");\n  if (tclass == 0) {\n    pam_syslog(pamh, LOG_ERR, \"Failed to get chr_file security class\");\n    freecon(data->prev_tty_context);\n    data->prev_tty_context = NULL;\n    free(data->tty_path);\n    data->tty_path = NULL;\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  if (security_compute_relabel(data->exec_context, data->prev_tty_context,\n\t\t\t       tclass, &data->tty_context)) {\n    data->tty_context = NULL;\n    pam_syslog(pamh, LOG_ERR, \"Failed to compute new context for %s: %m\",\n\t       data->tty_path);\n    freecon(data->prev_tty_context);\n    data->prev_tty_context = NULL;\n    free(data->tty_path);\n    data->tty_path = NULL;\n    return (security_getenforce() == 1) ? PAM_SESSION_ERR : PAM_SUCCESS;\n  }\n\n  return PAM_SUCCESS;\n}"
  },
  {
    "function_name": "set_file_context",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "432-443",
    "snippet": "static int\nset_file_context(const pam_handle_t *pamh, const char *context,\n\t\t const char *file)\n{\n  if (!file)\n    return 0;\n  if (setfilecon(file, context) == 0 || errno == ENOENT)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting file context \\\"%s\\\" failed for %s: %m\",\n\t     context ? context : \"\", file);\n  return -1;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Setting file context \\\"%s\\\" failed for %s: %m\"",
            "context ? context : \"\"",
            "file"
          ],
          "line": 440
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setfilecon",
          "args": [
            "file",
            "context"
          ],
          "line": 438
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nset_file_context(const pam_handle_t *pamh, const char *context,\n\t\t const char *file)\n{\n  if (!file)\n    return 0;\n  if (setfilecon(file, context) == 0 || errno == ENOENT)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting file context \\\"%s\\\" failed for %s: %m\",\n\t     context ? context : \"\", file);\n  return -1;\n}"
  },
  {
    "function_name": "set_exec_context",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "422-430",
    "snippet": "static int\nset_exec_context(const pam_handle_t *pamh, const char *context)\n{\n  if (setexeccon(context) == 0)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting executable context \\\"%s\\\" failed: %m\",\n\t     context ? context : \"\");\n  return -1;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Setting executable context \\\"%s\\\" failed: %m\"",
            "context ? context : \"\""
          ],
          "line": 427
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "setexeccon",
          "args": [
            "context"
          ],
          "line": 425
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nset_exec_context(const pam_handle_t *pamh, const char *context)\n{\n  if (setexeccon(context) == 0)\n    return 0;\n  pam_syslog(pamh, LOG_ERR, \"Setting executable context \\\"%s\\\" failed: %m\",\n\t     context ? context : \"\");\n  return -1;\n}"
  },
  {
    "function_name": "get_item",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "414-420",
    "snippet": "static const char *\nget_item(const pam_handle_t *pamh, int item_type)\n{\n  const void *item;\n\n  return (pam_get_item(pamh, item_type, &item) == PAM_SUCCESS) ? item : NULL;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "pam_get_item",
          "args": [
            "pamh",
            "item_type",
            "&item"
          ],
          "line": 419
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic const char *\nget_item(const pam_handle_t *pamh, int item_type)\n{\n  const void *item;\n\n  return (pam_get_item(pamh, item_type, &item) == PAM_SUCCESS) ? item : NULL;\n}"
  },
  {
    "function_name": "get_module_data",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "406-412",
    "snippet": "static const module_data_t *\nget_module_data(const pam_handle_t *pamh)\n{\n  const void *data;\n\n  return (pam_get_data(pamh, DATANAME, &data) == PAM_SUCCESS) ? data : NULL;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [
      "#define DATANAME \"pam_selinux_context\""
    ],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "pam_get_data",
          "args": [
            "pamh",
            "DATANAME",
            "&data"
          ],
          "line": 411
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\n#define DATANAME \"pam_selinux_context\"\n\nstatic const module_data_t *\nget_module_data(const pam_handle_t *pamh)\n{\n  const void *data;\n\n  return (pam_get_data(pamh, DATANAME, &data) == PAM_SUCCESS) ? data : NULL;\n}"
  },
  {
    "function_name": "cleanup",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "400-404",
    "snippet": "static void\ncleanup(pam_handle_t *pamh UNUSED, void *data, int err UNUSED)\n{\n  free_module_data(data);\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free_module_data",
          "args": [
            "data"
          ],
          "line": 403
        },
        "resolved": true,
        "details": {
          "function_name": "free_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "386-398",
          "snippet": "static void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}"
        }
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\ncleanup(pam_handle_t *pamh UNUSED, void *data, int err UNUSED)\n{\n  free_module_data(data);\n}"
  },
  {
    "function_name": "free_module_data",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "386-398",
    "snippet": "static void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "data"
          ],
          "line": 397
        },
        "resolved": true,
        "details": {
          "function_name": "free_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "386-398",
          "snippet": "static void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}",
          "note": "cyclic_reference_detected"
        }
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "data",
            "0",
            "sizeof(*data)"
          ],
          "line": 396
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "data->exec_context"
          ],
          "line": 395
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "data->prev_exec_context"
          ],
          "line": 393
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "data->default_user_context"
          ],
          "line": 392
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "data->tty_context"
          ],
          "line": 391
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "data->prev_tty_context"
          ],
          "line": 390
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}"
  },
  {
    "function_name": "context_from_env",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "278-374",
    "snippet": "static char *\ncontext_from_env (pam_handle_t *pamh, const char *defaultcon, int env_params, int use_current_range, int debug)\n{\n  char *newcon = NULL;\n  context_t new_context;\n  context_t my_context = NULL;\n  int mls_enabled = is_selinux_mls_enabled();\n  const char *env = NULL;\n  char *type = NULL;\n  int fail = 1;\n\n  if ((new_context = context_new(defaultcon)) == NULL)\n    goto fail_set;\n\n  if (env_params && (env = pam_getenv(pamh, \"SELINUX_ROLE_REQUESTED\")) != NULL && env[0] != '\\0') {\n    if (debug)\n\tpam_syslog(pamh, LOG_NOTICE, \"Requested role: %s\", env);\n\n    if (get_default_type(env, &type)) {\n\tpam_syslog(pamh, LOG_NOTICE, \"No default type for role %s\", env);\n\tgoto fail_set;\n    } else {\n\tif (context_role_set(new_context, env))\n\t    goto fail_set;\n\tif (context_type_set(new_context, type))\n\t    goto fail_set;\n    }\n  }\n\n  if (mls_enabled) {\n    if ((env = pam_getenv(pamh, \"SELINUX_USE_CURRENT_RANGE\")) != NULL && env[0] == '1') {\n        if (debug)\n\t    pam_syslog(pamh, LOG_NOTICE, \"SELINUX_USE_CURRENT_RANGE is set\");\n\tuse_current_range = 1;\n    }\n\n    if (use_current_range) {\n        char *mycon = NULL;\n\n\tif (getcon(&mycon) != 0)\n\t    goto fail_set;\n        my_context = context_new(mycon);\n        if (my_context == NULL) {\n            freecon(mycon);\n\t    goto fail_set;\n\t}\n\tfreecon(mycon);\n\tenv = context_range_get(my_context);\n    } else {\n        env = pam_getenv(pamh, \"SELINUX_LEVEL_REQUESTED\");\n    }\n\n    if (env != NULL && env[0] != '\\0') {\n        if (debug)\n\t    pam_syslog(pamh, LOG_NOTICE, \"Requested level: %s\", env);\n\tif (context_range_set(new_context, env))\n\t    goto fail_set;\n    }\n  }\n\n  newcon = strdup(context_str(new_context));\n  if (newcon == NULL)\n    goto fail_set;\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Selected Security Context %s\", newcon);\n\n  /* Get the string value of the context and see if it is valid. */\n  if (security_check_context(newcon)) {\n    pam_syslog(pamh, LOG_NOTICE, \"Not a valid security context %s\", newcon);\n\n    goto fail_set;\n  }\n\n  /* we have to check that this user is allowed to go into the\n     range they have specified ... role is tied to an seuser, so that'll\n     be checked at setexeccon time */\n  if (mls_enabled &&\n      selinux_check_access(defaultcon, newcon, \"context\", \"contains\", NULL) != 0) {\n    pam_syslog(pamh, LOG_NOTICE, \"Security context %s is not allowed for %s\", defaultcon, newcon);\n\n    goto fail_set;\n  }\n\n  fail = 0;\n\n fail_set:\n  free(type);\n  context_free(my_context);\n  context_free(new_context);\n  if (fail) {\n    send_audit_message(pamh, 0, defaultcon, newcon);\n    freecon(newcon);\n    newcon = NULL;\n  }\n  return newcon;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "newcon"
          ],
          "line": 370
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "send_audit_message",
          "args": [
            "pamh",
            "0",
            "defaultcon",
            "newcon"
          ],
          "line": 369
        },
        "resolved": true,
        "details": {
          "function_name": "send_audit_message",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "72-127",
          "snippet": "static void\nsend_audit_message(const pam_handle_t *pamh, int success, const char *default_context,\n\t\t   const char *selected_context)\n{\n#ifdef HAVE_LIBAUDIT\n\tchar *msg = NULL;\n\tint audit_fd = audit_open();\n\tchar *default_raw = NULL;\n\tchar *selected_raw = NULL;\n\tconst void *tty = NULL, *rhost = NULL;\n\tif (audit_fd < 0) {\n\t\tif (errno == EINVAL || errno == EPROTONOSUPPORT ||\n                                        errno == EAFNOSUPPORT) {\n\t\t\tgoto fallback; /* No audit support in kernel */\n\t\t}\n\t\tpam_syslog(pamh, LOG_ERR, \"Error connecting to audit system: %m\");\n\t\tgoto fallback;\n\t}\n\t(void)pam_get_item(pamh, PAM_TTY, &tty);\n\t(void)pam_get_item(pamh, PAM_RHOST, &rhost);\n\tif (selinux_trans_to_raw_context(default_context, &default_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating default context '%s'.\", default_context);\n\t\tdefault_raw = NULL;\n\t}\n\tif (selinux_trans_to_raw_context(selected_context, &selected_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating selected context '%s'.\", selected_context);\n\t\tselected_raw = NULL;\n\t}\n\tif (asprintf(&msg, \"pam: default-context=%s selected-context=%s\",\n\t\t     default_raw ? default_raw : (default_context ? default_context : \"?\"),\n\t\t     selected_raw ? selected_raw : (selected_context ? selected_context : \"?\")) < 0) {\n\t\tmsg = NULL; /* asprintf leaves msg in undefined state on failure */\n\t\tpam_syslog(pamh, LOG_ERR, \"Error allocating memory.\");\n\t\tgoto fallback;\n\t}\n\tif (audit_log_user_message(audit_fd, AUDIT_USER_ROLE_CHANGE,\n\t\t\t\t   msg, rhost, NULL, tty, success) <= 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error sending audit message: %m\");\n\t\tgoto fallback;\n\t}\n\tgoto cleanup;\n\n      fallback:\n#endif /* HAVE_LIBAUDIT */\n        pam_syslog(pamh, LOG_NOTICE, \"pam: default-context=%s selected-context=%s success %d\",\n\t\t   default_context, selected_context, success);\n\n#ifdef HAVE_LIBAUDIT\n      cleanup:\n\tfree(msg);\n\tfreecon(default_raw);\n\tfreecon(selected_raw);\n\tif (audit_fd >= 0)\n\t\tclose(audit_fd);\n#endif /* HAVE_LIBAUDIT */\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nsend_audit_message(const pam_handle_t *pamh, int success, const char *default_context,\n\t\t   const char *selected_context)\n{\n#ifdef HAVE_LIBAUDIT\n\tchar *msg = NULL;\n\tint audit_fd = audit_open();\n\tchar *default_raw = NULL;\n\tchar *selected_raw = NULL;\n\tconst void *tty = NULL, *rhost = NULL;\n\tif (audit_fd < 0) {\n\t\tif (errno == EINVAL || errno == EPROTONOSUPPORT ||\n                                        errno == EAFNOSUPPORT) {\n\t\t\tgoto fallback; /* No audit support in kernel */\n\t\t}\n\t\tpam_syslog(pamh, LOG_ERR, \"Error connecting to audit system: %m\");\n\t\tgoto fallback;\n\t}\n\t(void)pam_get_item(pamh, PAM_TTY, &tty);\n\t(void)pam_get_item(pamh, PAM_RHOST, &rhost);\n\tif (selinux_trans_to_raw_context(default_context, &default_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating default context '%s'.\", default_context);\n\t\tdefault_raw = NULL;\n\t}\n\tif (selinux_trans_to_raw_context(selected_context, &selected_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating selected context '%s'.\", selected_context);\n\t\tselected_raw = NULL;\n\t}\n\tif (asprintf(&msg, \"pam: default-context=%s selected-context=%s\",\n\t\t     default_raw ? default_raw : (default_context ? default_context : \"?\"),\n\t\t     selected_raw ? selected_raw : (selected_context ? selected_context : \"?\")) < 0) {\n\t\tmsg = NULL; /* asprintf leaves msg in undefined state on failure */\n\t\tpam_syslog(pamh, LOG_ERR, \"Error allocating memory.\");\n\t\tgoto fallback;\n\t}\n\tif (audit_log_user_message(audit_fd, AUDIT_USER_ROLE_CHANGE,\n\t\t\t\t   msg, rhost, NULL, tty, success) <= 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error sending audit message: %m\");\n\t\tgoto fallback;\n\t}\n\tgoto cleanup;\n\n      fallback:\n#endif /* HAVE_LIBAUDIT */\n        pam_syslog(pamh, LOG_NOTICE, \"pam: default-context=%s selected-context=%s success %d\",\n\t\t   default_context, selected_context, success);\n\n#ifdef HAVE_LIBAUDIT\n      cleanup:\n\tfree(msg);\n\tfreecon(default_raw);\n\tfreecon(selected_raw);\n\tif (audit_fd >= 0)\n\t\tclose(audit_fd);\n#endif /* HAVE_LIBAUDIT */\n}"
        }
      },
      {
        "call_info": {
          "callee": "context_free",
          "args": [
            "new_context"
          ],
          "line": 367
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_free",
          "args": [
            "my_context"
          ],
          "line": 366
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "type"
          ],
          "line": 365
        },
        "resolved": true,
        "details": {
          "function_name": "free_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "386-398",
          "snippet": "static void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Security context %s is not allowed for %s\"",
            "defaultcon",
            "newcon"
          ],
          "line": 357
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "selinux_check_access",
          "args": [
            "defaultcon",
            "newcon",
            "\"context\"",
            "\"contains\"",
            "NULL"
          ],
          "line": 356
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Not a valid security context %s\"",
            "newcon"
          ],
          "line": 347
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "security_check_context",
          "args": [
            "newcon"
          ],
          "line": 346
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Selected Security Context %s\"",
            "newcon"
          ],
          "line": 343
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "context_str(new_context)"
          ],
          "line": 338
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_str",
          "args": [
            "new_context"
          ],
          "line": 338
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_range_set",
          "args": [
            "new_context",
            "env"
          ],
          "line": 333
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Requested level: %s\"",
            "env"
          ],
          "line": 332
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_getenv",
          "args": [
            "pamh",
            "\"SELINUX_LEVEL_REQUESTED\""
          ],
          "line": 327
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_range_get",
          "args": [
            "my_context"
          ],
          "line": 325
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "mycon"
          ],
          "line": 324
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "mycon"
          ],
          "line": 321
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_new",
          "args": [
            "mycon"
          ],
          "line": 319
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getcon",
          "args": [
            "&mycon"
          ],
          "line": 317
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"SELINUX_USE_CURRENT_RANGE is set\""
          ],
          "line": 310
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_getenv",
          "args": [
            "pamh",
            "\"SELINUX_USE_CURRENT_RANGE\""
          ],
          "line": 308
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_type_set",
          "args": [
            "new_context",
            "type"
          ],
          "line": 302
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_role_set",
          "args": [
            "new_context",
            "env"
          ],
          "line": 300
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"No default type for role %s\"",
            "env"
          ],
          "line": 297
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_default_type",
          "args": [
            "env",
            "&type"
          ],
          "line": 296
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Requested role: %s\"",
            "env"
          ],
          "line": 294
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_getenv",
          "args": [
            "pamh",
            "\"SELINUX_ROLE_REQUESTED\""
          ],
          "line": 292
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_new",
          "args": [
            "defaultcon"
          ],
          "line": 289
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "is_selinux_mls_enabled",
          "args": [],
          "line": 284
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic char *\ncontext_from_env (pam_handle_t *pamh, const char *defaultcon, int env_params, int use_current_range, int debug)\n{\n  char *newcon = NULL;\n  context_t new_context;\n  context_t my_context = NULL;\n  int mls_enabled = is_selinux_mls_enabled();\n  const char *env = NULL;\n  char *type = NULL;\n  int fail = 1;\n\n  if ((new_context = context_new(defaultcon)) == NULL)\n    goto fail_set;\n\n  if (env_params && (env = pam_getenv(pamh, \"SELINUX_ROLE_REQUESTED\")) != NULL && env[0] != '\\0') {\n    if (debug)\n\tpam_syslog(pamh, LOG_NOTICE, \"Requested role: %s\", env);\n\n    if (get_default_type(env, &type)) {\n\tpam_syslog(pamh, LOG_NOTICE, \"No default type for role %s\", env);\n\tgoto fail_set;\n    } else {\n\tif (context_role_set(new_context, env))\n\t    goto fail_set;\n\tif (context_type_set(new_context, type))\n\t    goto fail_set;\n    }\n  }\n\n  if (mls_enabled) {\n    if ((env = pam_getenv(pamh, \"SELINUX_USE_CURRENT_RANGE\")) != NULL && env[0] == '1') {\n        if (debug)\n\t    pam_syslog(pamh, LOG_NOTICE, \"SELINUX_USE_CURRENT_RANGE is set\");\n\tuse_current_range = 1;\n    }\n\n    if (use_current_range) {\n        char *mycon = NULL;\n\n\tif (getcon(&mycon) != 0)\n\t    goto fail_set;\n        my_context = context_new(mycon);\n        if (my_context == NULL) {\n            freecon(mycon);\n\t    goto fail_set;\n\t}\n\tfreecon(mycon);\n\tenv = context_range_get(my_context);\n    } else {\n        env = pam_getenv(pamh, \"SELINUX_LEVEL_REQUESTED\");\n    }\n\n    if (env != NULL && env[0] != '\\0') {\n        if (debug)\n\t    pam_syslog(pamh, LOG_NOTICE, \"Requested level: %s\", env);\n\tif (context_range_set(new_context, env))\n\t    goto fail_set;\n    }\n  }\n\n  newcon = strdup(context_str(new_context));\n  if (newcon == NULL)\n    goto fail_set;\n\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"Selected Security Context %s\", newcon);\n\n  /* Get the string value of the context and see if it is valid. */\n  if (security_check_context(newcon)) {\n    pam_syslog(pamh, LOG_NOTICE, \"Not a valid security context %s\", newcon);\n\n    goto fail_set;\n  }\n\n  /* we have to check that this user is allowed to go into the\n     range they have specified ... role is tied to an seuser, so that'll\n     be checked at setexeccon time */\n  if (mls_enabled &&\n      selinux_check_access(defaultcon, newcon, \"context\", \"contains\", NULL) != 0) {\n    pam_syslog(pamh, LOG_NOTICE, \"Security context %s is not allowed for %s\", defaultcon, newcon);\n\n    goto fail_set;\n  }\n\n  fail = 0;\n\n fail_set:\n  free(type);\n  context_free(my_context);\n  context_free(new_context);\n  if (fail) {\n    send_audit_message(pamh, 0, defaultcon, newcon);\n    freecon(newcon);\n    newcon = NULL;\n  }\n  return newcon;\n}"
  },
  {
    "function_name": "config_context",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "162-276",
    "snippet": "static char *\nconfig_context (pam_handle_t *pamh, const char *defaultcon, int use_current_range, int debug)\n{\n  char *newcon = NULL;\n  context_t new_context;\n  int mls_enabled = is_selinux_mls_enabled();\n  char *response=NULL;\n  char *type=NULL;\n  char resp_val = 0;\n\n  pam_prompt (pamh, PAM_TEXT_INFO, NULL, _(\"The default security context is %s.\"), defaultcon);\n\n  while (1) {\n    if (query_response(pamh,\n\t\t   _(\"Would you like to enter a different role or level?\"), \"n\",\n\t\t   &response, debug) == PAM_SUCCESS) {\n\tresp_val = response[0];\n\t_pam_drop(response);\n    } else {\n\tresp_val = 'N';\n    }\n    if ((resp_val == 'y') || (resp_val == 'Y'))\n      {\n        if ((new_context = context_new(defaultcon)) == NULL)\n\t    goto fail_set;\n\n\t/* Allow the user to enter role and level individually */\n\tif (query_response(pamh, _(\"role:\"), context_role_get(new_context),\n\t\t       &response, debug) == PAM_SUCCESS && response[0]) {\n\t  if (get_default_type(response, &type)) {\n\t    pam_prompt(pamh, PAM_ERROR_MSG, NULL,\n\t\t       _(\"There is no default type for role %s.\"), response);\n\t    _pam_drop(response);\n\t    continue;\n\t  } else {\n\t    if (context_role_set(new_context, response))\n\t      goto fail_set;\n\t    if (context_type_set (new_context, type))\n\t      goto fail_set;\n\t    _pam_drop(type);\n\t  }\n\t}\n\t_pam_drop(response);\n\n\tif (mls_enabled)\n\t  {\n\t    if (use_current_range) {\n\t        char *mycon = NULL;\n\t        context_t my_context;\n\n\t\tif (getcon(&mycon) != 0)\n\t\t    goto fail_set;\n\t\tmy_context = context_new(mycon);\n\t        if (my_context == NULL) {\n\t\t    freecon(mycon);\n\t\t    goto fail_set;\n\t\t}\n\t\tfreecon(mycon);\n\t\tif (context_range_set(new_context, context_range_get(my_context))) {\n\t\t    context_free(my_context);\n\t\t    goto fail_set;\n\t\t}\n\t\tcontext_free(my_context);\n\t    } else if (query_response(pamh, _(\"level:\"), context_range_get(new_context),\n\t\t\t   &response, debug) == PAM_SUCCESS && response[0]) {\n\t\tif (context_range_set(new_context, response))\n\t\t    goto fail_set;\n\t    }\n\t    _pam_drop(response);\n\t  }\n\n\tif (debug)\n\t  pam_syslog(pamh, LOG_NOTICE, \"Selected Security Context %s\", context_str(new_context));\n\n        /* Get the string value of the context and see if it is valid. */\n        if (!security_check_context(context_str(new_context))) {\n\t  newcon = strdup(context_str(new_context));\n\t  if (newcon == NULL)\n\t    goto fail_set;\n\t  context_free(new_context);\n\n\t  /* we have to check that this user is allowed to go into the\n\t     range they have specified ... role is tied to an seuser, so that'll\n\t     be checked at setexeccon time */\n\t  if (mls_enabled &&\n\t      selinux_check_access(defaultcon, newcon, \"context\", \"contains\", NULL) != 0) {\n\t    pam_syslog(pamh, LOG_NOTICE, \"Security context %s is not allowed for %s\", defaultcon, newcon);\n\n\t    send_audit_message(pamh, 0, defaultcon, newcon);\n\n\t    free(newcon);\n\t    goto fail_range;\n\t  }\n\t  return newcon;\n\t}\n\telse {\n\t  send_audit_message(pamh, 0, defaultcon, context_str(new_context));\n\t  send_text(pamh,_(\"This is not a valid security context.\"),debug);\n\t}\n        context_free(new_context); /* next time around allocates another */\n      }\n    else\n      return strdup(defaultcon);\n  } /* end while */\n\n  return NULL;\n\n fail_set:\n  free(type);\n  _pam_drop(response);\n  context_free (new_context);\n  send_audit_message(pamh, 0, defaultcon, NULL);\n fail_range:\n  return NULL;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "send_audit_message",
          "args": [
            "pamh",
            "0",
            "defaultcon",
            "NULL"
          ],
          "line": 273
        },
        "resolved": true,
        "details": {
          "function_name": "send_audit_message",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "72-127",
          "snippet": "static void\nsend_audit_message(const pam_handle_t *pamh, int success, const char *default_context,\n\t\t   const char *selected_context)\n{\n#ifdef HAVE_LIBAUDIT\n\tchar *msg = NULL;\n\tint audit_fd = audit_open();\n\tchar *default_raw = NULL;\n\tchar *selected_raw = NULL;\n\tconst void *tty = NULL, *rhost = NULL;\n\tif (audit_fd < 0) {\n\t\tif (errno == EINVAL || errno == EPROTONOSUPPORT ||\n                                        errno == EAFNOSUPPORT) {\n\t\t\tgoto fallback; /* No audit support in kernel */\n\t\t}\n\t\tpam_syslog(pamh, LOG_ERR, \"Error connecting to audit system: %m\");\n\t\tgoto fallback;\n\t}\n\t(void)pam_get_item(pamh, PAM_TTY, &tty);\n\t(void)pam_get_item(pamh, PAM_RHOST, &rhost);\n\tif (selinux_trans_to_raw_context(default_context, &default_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating default context '%s'.\", default_context);\n\t\tdefault_raw = NULL;\n\t}\n\tif (selinux_trans_to_raw_context(selected_context, &selected_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating selected context '%s'.\", selected_context);\n\t\tselected_raw = NULL;\n\t}\n\tif (asprintf(&msg, \"pam: default-context=%s selected-context=%s\",\n\t\t     default_raw ? default_raw : (default_context ? default_context : \"?\"),\n\t\t     selected_raw ? selected_raw : (selected_context ? selected_context : \"?\")) < 0) {\n\t\tmsg = NULL; /* asprintf leaves msg in undefined state on failure */\n\t\tpam_syslog(pamh, LOG_ERR, \"Error allocating memory.\");\n\t\tgoto fallback;\n\t}\n\tif (audit_log_user_message(audit_fd, AUDIT_USER_ROLE_CHANGE,\n\t\t\t\t   msg, rhost, NULL, tty, success) <= 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error sending audit message: %m\");\n\t\tgoto fallback;\n\t}\n\tgoto cleanup;\n\n      fallback:\n#endif /* HAVE_LIBAUDIT */\n        pam_syslog(pamh, LOG_NOTICE, \"pam: default-context=%s selected-context=%s success %d\",\n\t\t   default_context, selected_context, success);\n\n#ifdef HAVE_LIBAUDIT\n      cleanup:\n\tfree(msg);\n\tfreecon(default_raw);\n\tfreecon(selected_raw);\n\tif (audit_fd >= 0)\n\t\tclose(audit_fd);\n#endif /* HAVE_LIBAUDIT */\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nsend_audit_message(const pam_handle_t *pamh, int success, const char *default_context,\n\t\t   const char *selected_context)\n{\n#ifdef HAVE_LIBAUDIT\n\tchar *msg = NULL;\n\tint audit_fd = audit_open();\n\tchar *default_raw = NULL;\n\tchar *selected_raw = NULL;\n\tconst void *tty = NULL, *rhost = NULL;\n\tif (audit_fd < 0) {\n\t\tif (errno == EINVAL || errno == EPROTONOSUPPORT ||\n                                        errno == EAFNOSUPPORT) {\n\t\t\tgoto fallback; /* No audit support in kernel */\n\t\t}\n\t\tpam_syslog(pamh, LOG_ERR, \"Error connecting to audit system: %m\");\n\t\tgoto fallback;\n\t}\n\t(void)pam_get_item(pamh, PAM_TTY, &tty);\n\t(void)pam_get_item(pamh, PAM_RHOST, &rhost);\n\tif (selinux_trans_to_raw_context(default_context, &default_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating default context '%s'.\", default_context);\n\t\tdefault_raw = NULL;\n\t}\n\tif (selinux_trans_to_raw_context(selected_context, &selected_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating selected context '%s'.\", selected_context);\n\t\tselected_raw = NULL;\n\t}\n\tif (asprintf(&msg, \"pam: default-context=%s selected-context=%s\",\n\t\t     default_raw ? default_raw : (default_context ? default_context : \"?\"),\n\t\t     selected_raw ? selected_raw : (selected_context ? selected_context : \"?\")) < 0) {\n\t\tmsg = NULL; /* asprintf leaves msg in undefined state on failure */\n\t\tpam_syslog(pamh, LOG_ERR, \"Error allocating memory.\");\n\t\tgoto fallback;\n\t}\n\tif (audit_log_user_message(audit_fd, AUDIT_USER_ROLE_CHANGE,\n\t\t\t\t   msg, rhost, NULL, tty, success) <= 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error sending audit message: %m\");\n\t\tgoto fallback;\n\t}\n\tgoto cleanup;\n\n      fallback:\n#endif /* HAVE_LIBAUDIT */\n        pam_syslog(pamh, LOG_NOTICE, \"pam: default-context=%s selected-context=%s success %d\",\n\t\t   default_context, selected_context, success);\n\n#ifdef HAVE_LIBAUDIT\n      cleanup:\n\tfree(msg);\n\tfreecon(default_raw);\n\tfreecon(selected_raw);\n\tif (audit_fd >= 0)\n\t\tclose(audit_fd);\n#endif /* HAVE_LIBAUDIT */\n}"
        }
      },
      {
        "call_info": {
          "callee": "context_free",
          "args": [
            "new_context"
          ],
          "line": 272
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_pam_drop",
          "args": [
            "response"
          ],
          "line": 271
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "type"
          ],
          "line": 270
        },
        "resolved": true,
        "details": {
          "function_name": "free_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "386-398",
          "snippet": "static void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "defaultcon"
          ],
          "line": 264
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_free",
          "args": [
            "new_context"
          ],
          "line": 261
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "send_text",
          "args": [
            "pamh",
            "_(\"This is not a valid security context.\")",
            "debug"
          ],
          "line": 259
        },
        "resolved": true,
        "details": {
          "function_name": "send_text",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "129-135",
          "snippet": "static int\nsend_text (pam_handle_t *pamh, const char *text, int debug)\n{\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"%s\", text);\n  return pam_info (pamh, \"%s\", text);\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nsend_text (pam_handle_t *pamh, const char *text, int debug)\n{\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"%s\", text);\n  return pam_info (pamh, \"%s\", text);\n}"
        }
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"This is not a valid security context.\""
          ],
          "line": 259
        },
        "resolved": true,
        "details": {
          "function_name": "get_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "406-412",
          "snippet": "static const module_data_t *\nget_module_data(const pam_handle_t *pamh)\n{\n  const void *data;\n\n  return (pam_get_data(pamh, DATANAME, &data) == PAM_SUCCESS) ? data : NULL;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [
            "#define DATANAME \"pam_selinux_context\""
          ],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\n#define DATANAME \"pam_selinux_context\"\n\nstatic const module_data_t *\nget_module_data(const pam_handle_t *pamh)\n{\n  const void *data;\n\n  return (pam_get_data(pamh, DATANAME, &data) == PAM_SUCCESS) ? data : NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "context_str",
          "args": [
            "new_context"
          ],
          "line": 258
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Security context %s is not allowed for %s\"",
            "defaultcon",
            "newcon"
          ],
          "line": 248
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "selinux_check_access",
          "args": [
            "defaultcon",
            "newcon",
            "\"context\"",
            "\"contains\"",
            "NULL"
          ],
          "line": 247
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_free",
          "args": [
            "new_context"
          ],
          "line": 241
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strdup",
          "args": [
            "context_str(new_context)"
          ],
          "line": 238
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_str",
          "args": [
            "new_context"
          ],
          "line": 238
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "security_check_context",
          "args": [
            "context_str(new_context)"
          ],
          "line": 237
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_str",
          "args": [
            "new_context"
          ],
          "line": 237
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"Selected Security Context %s\"",
            "context_str(new_context)"
          ],
          "line": 234
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_str",
          "args": [
            "new_context"
          ],
          "line": 234
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_pam_drop",
          "args": [
            "response"
          ],
          "line": 230
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_range_set",
          "args": [
            "new_context",
            "response"
          ],
          "line": 227
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "query_response",
          "args": [
            "pamh",
            "_(\"level:\")",
            "context_range_get(new_context)",
            "&response",
            "debug"
          ],
          "line": 225
        },
        "resolved": true,
        "details": {
          "function_name": "query_response",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "141-160",
          "snippet": "static int\nquery_response (pam_handle_t *pamh, const char *text, const char *def,\n\t\tchar **response, int debug)\n{\n  int rc;\n  if (def)\n    rc = pam_prompt (pamh, PAM_PROMPT_ECHO_ON, response, \"%s [%s] \", text, def);\n  else\n    rc = pam_prompt (pamh, PAM_PROMPT_ECHO_ON, response, \"%s \", text);\n\n  if (*response == NULL) {\n    rc = PAM_CONV_ERR;\n  }\n\n  if (rc != PAM_SUCCESS) {\n    pam_syslog(pamh, LOG_WARNING, \"No response to query: %s\", text);\n  } else  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"%s %s\", text, *response);\n  return rc;\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nquery_response (pam_handle_t *pamh, const char *text, const char *def,\n\t\tchar **response, int debug)\n{\n  int rc;\n  if (def)\n    rc = pam_prompt (pamh, PAM_PROMPT_ECHO_ON, response, \"%s [%s] \", text, def);\n  else\n    rc = pam_prompt (pamh, PAM_PROMPT_ECHO_ON, response, \"%s \", text);\n\n  if (*response == NULL) {\n    rc = PAM_CONV_ERR;\n  }\n\n  if (rc != PAM_SUCCESS) {\n    pam_syslog(pamh, LOG_WARNING, \"No response to query: %s\", text);\n  } else  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"%s %s\", text, *response);\n  return rc;\n}"
        }
      },
      {
        "call_info": {
          "callee": "context_range_get",
          "args": [
            "new_context"
          ],
          "line": 225
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_free",
          "args": [
            "my_context"
          ],
          "line": 224
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_free",
          "args": [
            "my_context"
          ],
          "line": 221
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_range_set",
          "args": [
            "new_context",
            "context_range_get(my_context)"
          ],
          "line": 220
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_range_get",
          "args": [
            "my_context"
          ],
          "line": 220
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "mycon"
          ],
          "line": 219
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "mycon"
          ],
          "line": 216
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_new",
          "args": [
            "mycon"
          ],
          "line": 214
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getcon",
          "args": [
            "&mycon"
          ],
          "line": 212
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_pam_drop",
          "args": [
            "response"
          ],
          "line": 204
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_pam_drop",
          "args": [
            "type"
          ],
          "line": 201
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_type_set",
          "args": [
            "new_context",
            "type"
          ],
          "line": 199
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_role_set",
          "args": [
            "new_context",
            "response"
          ],
          "line": 197
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_pam_drop",
          "args": [
            "response"
          ],
          "line": 194
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_prompt",
          "args": [
            "pamh",
            "PAM_ERROR_MSG",
            "NULL",
            "_(\"There is no default type for role %s.\")",
            "response"
          ],
          "line": 192
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_default_type",
          "args": [
            "response",
            "&type"
          ],
          "line": 191
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_role_get",
          "args": [
            "new_context"
          ],
          "line": 189
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "context_new",
          "args": [
            "defaultcon"
          ],
          "line": 185
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_pam_drop",
          "args": [
            "response"
          ],
          "line": 179
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_prompt",
          "args": [
            "pamh",
            "PAM_TEXT_INFO",
            "NULL",
            "_(\"The default security context is %s.\")",
            "defaultcon"
          ],
          "line": 172
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "is_selinux_mls_enabled",
          "args": [],
          "line": 167
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic char *\nconfig_context (pam_handle_t *pamh, const char *defaultcon, int use_current_range, int debug)\n{\n  char *newcon = NULL;\n  context_t new_context;\n  int mls_enabled = is_selinux_mls_enabled();\n  char *response=NULL;\n  char *type=NULL;\n  char resp_val = 0;\n\n  pam_prompt (pamh, PAM_TEXT_INFO, NULL, _(\"The default security context is %s.\"), defaultcon);\n\n  while (1) {\n    if (query_response(pamh,\n\t\t   _(\"Would you like to enter a different role or level?\"), \"n\",\n\t\t   &response, debug) == PAM_SUCCESS) {\n\tresp_val = response[0];\n\t_pam_drop(response);\n    } else {\n\tresp_val = 'N';\n    }\n    if ((resp_val == 'y') || (resp_val == 'Y'))\n      {\n        if ((new_context = context_new(defaultcon)) == NULL)\n\t    goto fail_set;\n\n\t/* Allow the user to enter role and level individually */\n\tif (query_response(pamh, _(\"role:\"), context_role_get(new_context),\n\t\t       &response, debug) == PAM_SUCCESS && response[0]) {\n\t  if (get_default_type(response, &type)) {\n\t    pam_prompt(pamh, PAM_ERROR_MSG, NULL,\n\t\t       _(\"There is no default type for role %s.\"), response);\n\t    _pam_drop(response);\n\t    continue;\n\t  } else {\n\t    if (context_role_set(new_context, response))\n\t      goto fail_set;\n\t    if (context_type_set (new_context, type))\n\t      goto fail_set;\n\t    _pam_drop(type);\n\t  }\n\t}\n\t_pam_drop(response);\n\n\tif (mls_enabled)\n\t  {\n\t    if (use_current_range) {\n\t        char *mycon = NULL;\n\t        context_t my_context;\n\n\t\tif (getcon(&mycon) != 0)\n\t\t    goto fail_set;\n\t\tmy_context = context_new(mycon);\n\t        if (my_context == NULL) {\n\t\t    freecon(mycon);\n\t\t    goto fail_set;\n\t\t}\n\t\tfreecon(mycon);\n\t\tif (context_range_set(new_context, context_range_get(my_context))) {\n\t\t    context_free(my_context);\n\t\t    goto fail_set;\n\t\t}\n\t\tcontext_free(my_context);\n\t    } else if (query_response(pamh, _(\"level:\"), context_range_get(new_context),\n\t\t\t   &response, debug) == PAM_SUCCESS && response[0]) {\n\t\tif (context_range_set(new_context, response))\n\t\t    goto fail_set;\n\t    }\n\t    _pam_drop(response);\n\t  }\n\n\tif (debug)\n\t  pam_syslog(pamh, LOG_NOTICE, \"Selected Security Context %s\", context_str(new_context));\n\n        /* Get the string value of the context and see if it is valid. */\n        if (!security_check_context(context_str(new_context))) {\n\t  newcon = strdup(context_str(new_context));\n\t  if (newcon == NULL)\n\t    goto fail_set;\n\t  context_free(new_context);\n\n\t  /* we have to check that this user is allowed to go into the\n\t     range they have specified ... role is tied to an seuser, so that'll\n\t     be checked at setexeccon time */\n\t  if (mls_enabled &&\n\t      selinux_check_access(defaultcon, newcon, \"context\", \"contains\", NULL) != 0) {\n\t    pam_syslog(pamh, LOG_NOTICE, \"Security context %s is not allowed for %s\", defaultcon, newcon);\n\n\t    send_audit_message(pamh, 0, defaultcon, newcon);\n\n\t    free(newcon);\n\t    goto fail_range;\n\t  }\n\t  return newcon;\n\t}\n\telse {\n\t  send_audit_message(pamh, 0, defaultcon, context_str(new_context));\n\t  send_text(pamh,_(\"This is not a valid security context.\"),debug);\n\t}\n        context_free(new_context); /* next time around allocates another */\n      }\n    else\n      return strdup(defaultcon);\n  } /* end while */\n\n  return NULL;\n\n fail_set:\n  free(type);\n  _pam_drop(response);\n  context_free (new_context);\n  send_audit_message(pamh, 0, defaultcon, NULL);\n fail_range:\n  return NULL;\n}"
  },
  {
    "function_name": "query_response",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "141-160",
    "snippet": "static int\nquery_response (pam_handle_t *pamh, const char *text, const char *def,\n\t\tchar **response, int debug)\n{\n  int rc;\n  if (def)\n    rc = pam_prompt (pamh, PAM_PROMPT_ECHO_ON, response, \"%s [%s] \", text, def);\n  else\n    rc = pam_prompt (pamh, PAM_PROMPT_ECHO_ON, response, \"%s \", text);\n\n  if (*response == NULL) {\n    rc = PAM_CONV_ERR;\n  }\n\n  if (rc != PAM_SUCCESS) {\n    pam_syslog(pamh, LOG_WARNING, \"No response to query: %s\", text);\n  } else  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"%s %s\", text, *response);\n  return rc;\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"%s %s\"",
            "text",
            "*response"
          ],
          "line": 158
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_WARNING",
            "\"No response to query: %s\"",
            "text"
          ],
          "line": 156
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_prompt",
          "args": [
            "pamh",
            "PAM_PROMPT_ECHO_ON",
            "response",
            "\"%s \"",
            "text"
          ],
          "line": 149
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_prompt",
          "args": [
            "pamh",
            "PAM_PROMPT_ECHO_ON",
            "response",
            "\"%s [%s] \"",
            "text",
            "def"
          ],
          "line": 147
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nquery_response (pam_handle_t *pamh, const char *text, const char *def,\n\t\tchar **response, int debug)\n{\n  int rc;\n  if (def)\n    rc = pam_prompt (pamh, PAM_PROMPT_ECHO_ON, response, \"%s [%s] \", text, def);\n  else\n    rc = pam_prompt (pamh, PAM_PROMPT_ECHO_ON, response, \"%s \", text);\n\n  if (*response == NULL) {\n    rc = PAM_CONV_ERR;\n  }\n\n  if (rc != PAM_SUCCESS) {\n    pam_syslog(pamh, LOG_WARNING, \"No response to query: %s\", text);\n  } else  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"%s %s\", text, *response);\n  return rc;\n}"
  },
  {
    "function_name": "send_text",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "129-135",
    "snippet": "static int\nsend_text (pam_handle_t *pamh, const char *text, int debug)\n{\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"%s\", text);\n  return pam_info (pamh, \"%s\", text);\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "pam_info",
          "args": [
            "pamh",
            "\"%s\"",
            "text"
          ],
          "line": 134
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"%s\"",
            "text"
          ],
          "line": 133
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic int\nsend_text (pam_handle_t *pamh, const char *text, int debug)\n{\n  if (debug)\n    pam_syslog(pamh, LOG_NOTICE, \"%s\", text);\n  return pam_info (pamh, \"%s\", text);\n}"
  },
  {
    "function_name": "send_audit_message",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
    "lines": "72-127",
    "snippet": "static void\nsend_audit_message(const pam_handle_t *pamh, int success, const char *default_context,\n\t\t   const char *selected_context)\n{\n#ifdef HAVE_LIBAUDIT\n\tchar *msg = NULL;\n\tint audit_fd = audit_open();\n\tchar *default_raw = NULL;\n\tchar *selected_raw = NULL;\n\tconst void *tty = NULL, *rhost = NULL;\n\tif (audit_fd < 0) {\n\t\tif (errno == EINVAL || errno == EPROTONOSUPPORT ||\n                                        errno == EAFNOSUPPORT) {\n\t\t\tgoto fallback; /* No audit support in kernel */\n\t\t}\n\t\tpam_syslog(pamh, LOG_ERR, \"Error connecting to audit system: %m\");\n\t\tgoto fallback;\n\t}\n\t(void)pam_get_item(pamh, PAM_TTY, &tty);\n\t(void)pam_get_item(pamh, PAM_RHOST, &rhost);\n\tif (selinux_trans_to_raw_context(default_context, &default_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating default context '%s'.\", default_context);\n\t\tdefault_raw = NULL;\n\t}\n\tif (selinux_trans_to_raw_context(selected_context, &selected_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating selected context '%s'.\", selected_context);\n\t\tselected_raw = NULL;\n\t}\n\tif (asprintf(&msg, \"pam: default-context=%s selected-context=%s\",\n\t\t     default_raw ? default_raw : (default_context ? default_context : \"?\"),\n\t\t     selected_raw ? selected_raw : (selected_context ? selected_context : \"?\")) < 0) {\n\t\tmsg = NULL; /* asprintf leaves msg in undefined state on failure */\n\t\tpam_syslog(pamh, LOG_ERR, \"Error allocating memory.\");\n\t\tgoto fallback;\n\t}\n\tif (audit_log_user_message(audit_fd, AUDIT_USER_ROLE_CHANGE,\n\t\t\t\t   msg, rhost, NULL, tty, success) <= 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error sending audit message: %m\");\n\t\tgoto fallback;\n\t}\n\tgoto cleanup;\n\n      fallback:\n#endif /* HAVE_LIBAUDIT */\n        pam_syslog(pamh, LOG_NOTICE, \"pam: default-context=%s selected-context=%s success %d\",\n\t\t   default_context, selected_context, success);\n\n#ifdef HAVE_LIBAUDIT\n      cleanup:\n\tfree(msg);\n\tfreecon(default_raw);\n\tfreecon(selected_raw);\n\tif (audit_fd >= 0)\n\t\tclose(audit_fd);\n#endif /* HAVE_LIBAUDIT */\n}",
    "includes": [
      "#include <sys/select.h>",
      "#include <libaudit.h>",
      "#include <selinux/get_default_type.h>",
      "#include <selinux/context.h>",
      "#include <selinux/get_context_list.h>",
      "#include <selinux/selinux.h>",
      "#include \"pam_inline.h\"",
      "#include <security/pam_ext.h>",
      "#include <security/pam_modutil.h>",
      "#include <security/_pam_macros.h>",
      "#include <security/pam_modules.h>",
      "#include <syslog.h>",
      "#include <fcntl.h>",
      "#include <sys/stat.h>",
      "#include <sys/types.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <pwd.h>",
      "#include <limits.h>",
      "#include <errno.h>",
      "#include \"config.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "close",
          "args": [
            "audit_fd"
          ],
          "line": 125
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "selected_raw"
          ],
          "line": 123
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "freecon",
          "args": [
            "default_raw"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "msg"
          ],
          "line": 121
        },
        "resolved": true,
        "details": {
          "function_name": "free_module_data",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_selinux/pam_selinux.c",
          "lines": "386-398",
          "snippet": "static void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}",
          "includes": [
            "#include <sys/select.h>",
            "#include <libaudit.h>",
            "#include <selinux/get_default_type.h>",
            "#include <selinux/context.h>",
            "#include <selinux/get_context_list.h>",
            "#include <selinux/selinux.h>",
            "#include \"pam_inline.h\"",
            "#include <security/pam_ext.h>",
            "#include <security/pam_modutil.h>",
            "#include <security/_pam_macros.h>",
            "#include <security/pam_modules.h>",
            "#include <syslog.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/types.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"config.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nfree_module_data(module_data_t *data)\n{\n  free(data->tty_path);\n  freecon(data->prev_tty_context);\n  freecon(data->tty_context);\n  freecon(data->default_user_context);\n  freecon(data->prev_exec_context);\n  if (data->exec_context != data->default_user_context)\n    freecon(data->exec_context);\n  memset(data, 0, sizeof(*data));\n  free(data);\n}"
        }
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_NOTICE",
            "\"pam: default-context=%s selected-context=%s success %d\"",
            "default_context",
            "selected_context",
            "success"
          ],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Error sending audit message: %m\""
          ],
          "line": 109
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "audit_log_user_message",
          "args": [
            "audit_fd",
            "AUDIT_USER_ROLE_CHANGE",
            "msg",
            "rhost",
            "NULL",
            "tty",
            "success"
          ],
          "line": 107
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Error allocating memory.\""
          ],
          "line": 104
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "asprintf",
          "args": [
            "&msg",
            "\"pam: default-context=%s selected-context=%s\"",
            "default_raw ? default_raw : (default_context ? default_context : \"?\")",
            "selected_raw ? selected_raw : (selected_context ? selected_context : \"?\")"
          ],
          "line": 100
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Error translating selected context '%s'.\"",
            "selected_context"
          ],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "selinux_trans_to_raw_context",
          "args": [
            "selected_context",
            "&selected_raw"
          ],
          "line": 96
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Error translating default context '%s'.\"",
            "default_context"
          ],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "selinux_trans_to_raw_context",
          "args": [
            "default_context",
            "&default_raw"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_get_item",
          "args": [
            "pamh",
            "PAM_RHOST",
            "&rhost"
          ],
          "line": 91
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_get_item",
          "args": [
            "pamh",
            "PAM_TTY",
            "&tty"
          ],
          "line": 90
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_syslog",
          "args": [
            "pamh",
            "LOG_ERR",
            "\"Error connecting to audit system: %m\""
          ],
          "line": 87
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "audit_open",
          "args": [],
          "line": 78
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <sys/select.h>\n#include <libaudit.h>\n#include <selinux/get_default_type.h>\n#include <selinux/context.h>\n#include <selinux/get_context_list.h>\n#include <selinux/selinux.h>\n#include \"pam_inline.h\"\n#include <security/pam_ext.h>\n#include <security/pam_modutil.h>\n#include <security/_pam_macros.h>\n#include <security/pam_modules.h>\n#include <syslog.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/types.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <limits.h>\n#include <errno.h>\n#include \"config.h\"\n\nstatic void\nsend_audit_message(const pam_handle_t *pamh, int success, const char *default_context,\n\t\t   const char *selected_context)\n{\n#ifdef HAVE_LIBAUDIT\n\tchar *msg = NULL;\n\tint audit_fd = audit_open();\n\tchar *default_raw = NULL;\n\tchar *selected_raw = NULL;\n\tconst void *tty = NULL, *rhost = NULL;\n\tif (audit_fd < 0) {\n\t\tif (errno == EINVAL || errno == EPROTONOSUPPORT ||\n                                        errno == EAFNOSUPPORT) {\n\t\t\tgoto fallback; /* No audit support in kernel */\n\t\t}\n\t\tpam_syslog(pamh, LOG_ERR, \"Error connecting to audit system: %m\");\n\t\tgoto fallback;\n\t}\n\t(void)pam_get_item(pamh, PAM_TTY, &tty);\n\t(void)pam_get_item(pamh, PAM_RHOST, &rhost);\n\tif (selinux_trans_to_raw_context(default_context, &default_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating default context '%s'.\", default_context);\n\t\tdefault_raw = NULL;\n\t}\n\tif (selinux_trans_to_raw_context(selected_context, &selected_raw) < 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error translating selected context '%s'.\", selected_context);\n\t\tselected_raw = NULL;\n\t}\n\tif (asprintf(&msg, \"pam: default-context=%s selected-context=%s\",\n\t\t     default_raw ? default_raw : (default_context ? default_context : \"?\"),\n\t\t     selected_raw ? selected_raw : (selected_context ? selected_context : \"?\")) < 0) {\n\t\tmsg = NULL; /* asprintf leaves msg in undefined state on failure */\n\t\tpam_syslog(pamh, LOG_ERR, \"Error allocating memory.\");\n\t\tgoto fallback;\n\t}\n\tif (audit_log_user_message(audit_fd, AUDIT_USER_ROLE_CHANGE,\n\t\t\t\t   msg, rhost, NULL, tty, success) <= 0) {\n\t\tpam_syslog(pamh, LOG_ERR, \"Error sending audit message: %m\");\n\t\tgoto fallback;\n\t}\n\tgoto cleanup;\n\n      fallback:\n#endif /* HAVE_LIBAUDIT */\n        pam_syslog(pamh, LOG_NOTICE, \"pam: default-context=%s selected-context=%s success %d\",\n\t\t   default_context, selected_context, success);\n\n#ifdef HAVE_LIBAUDIT\n      cleanup:\n\tfree(msg);\n\tfreecon(default_raw);\n\tfreecon(selected_raw);\n\tif (audit_fd >= 0)\n\t\tclose(audit_fd);\n#endif /* HAVE_LIBAUDIT */\n}"
  }
]