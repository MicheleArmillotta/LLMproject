[
  {
    "function_name": "main",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2022-28321/repo/modules/pam_localuser/tst-pam_localuser-retval.c",
    "lines": "28-144",
    "snippet": "int\nmain(void)\n{\n\tstatic struct pam_conv conv;\n\tpam_handle_t *pamh = NULL;\n\tFILE *fp;\n\tchar cwd[PATH_MAX];\n\tchar name[BUFSIZ];\n\n\tASSERT_NE(NULL, getcwd(cwd, sizeof(cwd)));\n\n\t/* default passwd */\n\tASSERT_NE(NULL, fp = fopen(service_file, \"w\"));\n\tASSERT_LT(0, fprintf(fp, \"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so\\n\",\n\t\t\t     cwd, MODULE_NAME));\n\tASSERT_EQ(0, fclose(fp));\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SERVICE_ERR, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tmemset(name, 'x', sizeof(name) - 1);\n\tname[sizeof(name) - 1] = '\\0';\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, name, &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SERVICE_ERR, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"root:x\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_PERM_DENIED, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\t/* missing passwd file */\n\tASSERT_NE(NULL, fp = fopen(service_file, \"w\"));\n\tASSERT_LT(0, fprintf(fp, \"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so file=%s\\n\",\n\t\t\t     cwd, MODULE_NAME, missing_file));\n\tASSERT_EQ(0, fclose(fp));\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"root\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SERVICE_ERR, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\t/* custom passwd file */\n\tASSERT_NE(NULL, fp = fopen(service_file, \"w\"));\n\tASSERT_LT(0, fprintf(fp, \"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so file=%s\\n\",\n\t\t\t     cwd, MODULE_NAME, passwd_file));\n\tASSERT_EQ(0, fclose(fp));\n\n\tmemcpy(name + (sizeof(name) - sizeof(craig_prefix)),\n\t       craig_prefix, sizeof(craig_prefix));\n\tASSERT_NE(NULL, fp = fopen(passwd_file, \"w\"));\n\tASSERT_LT(0, fprintf(fp, \"%s\\n%s\\n%s%s\\n\",\n\t\t\t     alice_line, bob_line, name, craig_suffix));\n\tASSERT_EQ(0, fclose(fp));\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SERVICE_ERR, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tmemset(name, 'x', sizeof(name) - 1);\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, name, &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SERVICE_ERR, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"alice\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SUCCESS, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"bob\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SUCCESS, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"alice:x\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_PERM_DENIED, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"craig\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_PERM_DENIED, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(0, unlink(service_file));\n\tASSERT_EQ(0, unlink(passwd_file));\n\n\treturn 0;\n}",
    "includes": [
      "#include <security/pam_appl.h>",
      "#include <unistd.h>",
      "#include <string.h>",
      "#include <stdlib.h>",
      "#include <stdio.h>",
      "#include <limits.h>",
      "#include \"test_assert.h\""
    ],
    "macros_used": [
      "#define MODULE_NAME \"pam_localuser\""
    ],
    "globals_used": [
      "static const char service_file[] = TEST_NAME \".service\";",
      "static const char passwd_file[] = TEST_NAME \".passwd\";",
      "static const char missing_file[] = TEST_NAME \".missing\";",
      "static const char alice_line[] = \"alice:x:1001:1001:Alice:/home/alice:\";",
      "static const char bob_line[] = \"bob:x:1002:1002:Bob:/home/bob:\";",
      "static const char craig_prefix[] = \":x:1003:1003:\";",
      "static const char craig_suffix[] = \"craig:/home/craig:\";"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "0",
            "unlink(passwd_file)"
          ],
          "line": 141
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "passwd_file"
          ],
          "line": 141
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "0",
            "unlink(service_file)"
          ],
          "line": 140
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "unlink",
          "args": [
            "service_file"
          ],
          "line": 140
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_end(pamh, 0)"
          ],
          "line": 137
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_end",
          "args": [
            "pamh",
            "0"
          ],
          "line": 137
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_PERM_DENIED",
            "pam_authenticate(pamh, 0)"
          ],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_authenticate",
          "args": [
            "pamh",
            "0"
          ],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "pamh"
          ],
          "line": 135
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_start_confdir(service_file, \"craig\", &conv, \".\", &pamh)"
          ],
          "line": 133
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_start_confdir",
          "args": [
            "service_file",
            "\"craig\"",
            "&conv",
            "\".\"",
            "&pamh"
          ],
          "line": 134
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_end(pamh, 0)"
          ],
          "line": 130
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_end",
          "args": [
            "pamh",
            "0"
          ],
          "line": 130
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_PERM_DENIED",
            "pam_authenticate(pamh, 0)"
          ],
          "line": 129
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_authenticate",
          "args": [
            "pamh",
            "0"
          ],
          "line": 129
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "pamh"
          ],
          "line": 128
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_start_confdir(service_file, \"alice:x\", &conv, \".\", &pamh)"
          ],
          "line": 126
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_start_confdir",
          "args": [
            "service_file",
            "\"alice:x\"",
            "&conv",
            "\".\"",
            "&pamh"
          ],
          "line": 127
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_end(pamh, 0)"
          ],
          "line": 123
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_end",
          "args": [
            "pamh",
            "0"
          ],
          "line": 123
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_authenticate(pamh, 0)"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_authenticate",
          "args": [
            "pamh",
            "0"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "pamh"
          ],
          "line": 121
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_start_confdir(service_file, \"bob\", &conv, \".\", &pamh)"
          ],
          "line": 119
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_start_confdir",
          "args": [
            "service_file",
            "\"bob\"",
            "&conv",
            "\".\"",
            "&pamh"
          ],
          "line": 120
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_end(pamh, 0)"
          ],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_end",
          "args": [
            "pamh",
            "0"
          ],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_authenticate(pamh, 0)"
          ],
          "line": 115
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_authenticate",
          "args": [
            "pamh",
            "0"
          ],
          "line": 115
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "pamh"
          ],
          "line": 114
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_start_confdir(service_file, \"alice\", &conv, \".\", &pamh)"
          ],
          "line": 112
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_start_confdir",
          "args": [
            "service_file",
            "\"alice\"",
            "&conv",
            "\".\"",
            "&pamh"
          ],
          "line": 113
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_end(pamh, 0)"
          ],
          "line": 109
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_end",
          "args": [
            "pamh",
            "0"
          ],
          "line": 109
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SERVICE_ERR",
            "pam_authenticate(pamh, 0)"
          ],
          "line": 108
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_authenticate",
          "args": [
            "pamh",
            "0"
          ],
          "line": 108
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "pamh"
          ],
          "line": 107
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_start_confdir(service_file, name, &conv, \".\", &pamh)"
          ],
          "line": 105
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_start_confdir",
          "args": [
            "service_file",
            "name",
            "&conv",
            "\".\"",
            "&pamh"
          ],
          "line": 106
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "name",
            "'x'",
            "sizeof(name) - 1"
          ],
          "line": 104
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_end(pamh, 0)"
          ],
          "line": 101
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_end",
          "args": [
            "pamh",
            "0"
          ],
          "line": 101
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SERVICE_ERR",
            "pam_authenticate(pamh, 0)"
          ],
          "line": 100
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_authenticate",
          "args": [
            "pamh",
            "0"
          ],
          "line": 100
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "pamh"
          ],
          "line": 99
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_start_confdir(service_file, \"\", &conv, \".\", &pamh)"
          ],
          "line": 97
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_start_confdir",
          "args": [
            "service_file",
            "\"\"",
            "&conv",
            "\".\"",
            "&pamh"
          ],
          "line": 98
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "0",
            "fclose(fp)"
          ],
          "line": 95
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fclose",
          "args": [
            "fp"
          ],
          "line": 95
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_LT",
          "args": [
            "0",
            "fprintf(fp, \"%s\\n%s\\n%s%s\\n\",\n\t\t\t     alice_line, bob_line, name, craig_suffix)"
          ],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "fp",
            "\"%s\\n%s\\n%s%s\\n\"",
            "alice_line",
            "bob_line",
            "name",
            "craig_suffix"
          ],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "fp = fopen(passwd_file, \"w\")"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fopen",
          "args": [
            "passwd_file",
            "\"w\""
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "name + (sizeof(name) - sizeof(craig_prefix))",
            "craig_prefix",
            "sizeof(craig_prefix)"
          ],
          "line": 90
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "0",
            "fclose(fp)"
          ],
          "line": 88
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fclose",
          "args": [
            "fp"
          ],
          "line": 88
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_LT",
          "args": [
            "0",
            "fprintf(fp, \"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so file=%s\\n\",\n\t\t\t     cwd, MODULE_NAME, passwd_file)"
          ],
          "line": 85
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "fp",
            "\"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so file=%s\\n\"",
            "cwd",
            "MODULE_NAME",
            "passwd_file"
          ],
          "line": 85
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "fp = fopen(service_file, \"w\")"
          ],
          "line": 84
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fopen",
          "args": [
            "service_file",
            "\"w\""
          ],
          "line": 84
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_end(pamh, 0)"
          ],
          "line": 80
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_end",
          "args": [
            "pamh",
            "0"
          ],
          "line": 80
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SERVICE_ERR",
            "pam_authenticate(pamh, 0)"
          ],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_authenticate",
          "args": [
            "pamh",
            "0"
          ],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "pamh"
          ],
          "line": 78
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_start_confdir(service_file, \"root\", &conv, \".\", &pamh)"
          ],
          "line": 76
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_start_confdir",
          "args": [
            "service_file",
            "\"root\"",
            "&conv",
            "\".\"",
            "&pamh"
          ],
          "line": 77
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "0",
            "fclose(fp)"
          ],
          "line": 74
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fclose",
          "args": [
            "fp"
          ],
          "line": 74
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_LT",
          "args": [
            "0",
            "fprintf(fp, \"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so file=%s\\n\",\n\t\t\t     cwd, MODULE_NAME, missing_file)"
          ],
          "line": 71
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "fp",
            "\"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so file=%s\\n\"",
            "cwd",
            "MODULE_NAME",
            "missing_file"
          ],
          "line": 71
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "fp = fopen(service_file, \"w\")"
          ],
          "line": 70
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fopen",
          "args": [
            "service_file",
            "\"w\""
          ],
          "line": 70
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_end(pamh, 0)"
          ],
          "line": 66
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_end",
          "args": [
            "pamh",
            "0"
          ],
          "line": 66
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_PERM_DENIED",
            "pam_authenticate(pamh, 0)"
          ],
          "line": 65
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_authenticate",
          "args": [
            "pamh",
            "0"
          ],
          "line": 65
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "pamh"
          ],
          "line": 64
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_start_confdir(service_file, \"root:x\", &conv, \".\", &pamh)"
          ],
          "line": 62
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_start_confdir",
          "args": [
            "service_file",
            "\"root:x\"",
            "&conv",
            "\".\"",
            "&pamh"
          ],
          "line": 63
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_end(pamh, 0)"
          ],
          "line": 59
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_end",
          "args": [
            "pamh",
            "0"
          ],
          "line": 59
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SERVICE_ERR",
            "pam_authenticate(pamh, 0)"
          ],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_authenticate",
          "args": [
            "pamh",
            "0"
          ],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "pamh"
          ],
          "line": 57
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_start_confdir(service_file, name, &conv, \".\", &pamh)"
          ],
          "line": 55
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_start_confdir",
          "args": [
            "service_file",
            "name",
            "&conv",
            "\".\"",
            "&pamh"
          ],
          "line": 56
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "memset",
          "args": [
            "name",
            "'x'",
            "sizeof(name) - 1"
          ],
          "line": 53
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_end(pamh, 0)"
          ],
          "line": 50
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_end",
          "args": [
            "pamh",
            "0"
          ],
          "line": 50
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SERVICE_ERR",
            "pam_authenticate(pamh, 0)"
          ],
          "line": 49
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_authenticate",
          "args": [
            "pamh",
            "0"
          ],
          "line": 49
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "pamh"
          ],
          "line": 48
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "PAM_SUCCESS",
            "pam_start_confdir(service_file, \"\", &conv, \".\", &pamh)"
          ],
          "line": 46
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pam_start_confdir",
          "args": [
            "service_file",
            "\"\"",
            "&conv",
            "\".\"",
            "&pamh"
          ],
          "line": 47
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_EQ",
          "args": [
            "0",
            "fclose(fp)"
          ],
          "line": 44
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fclose",
          "args": [
            "fp"
          ],
          "line": 44
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_LT",
          "args": [
            "0",
            "fprintf(fp, \"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so\\n\",\n\t\t\t     cwd, MODULE_NAME)"
          ],
          "line": 41
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fprintf",
          "args": [
            "fp",
            "\"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so\\n\"",
            "cwd",
            "MODULE_NAME"
          ],
          "line": 41
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "fp = fopen(service_file, \"w\")"
          ],
          "line": 40
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fopen",
          "args": [
            "service_file",
            "\"w\""
          ],
          "line": 40
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ASSERT_NE",
          "args": [
            "NULL",
            "getcwd(cwd, sizeof(cwd))"
          ],
          "line": 37
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "getcwd",
          "args": [
            "cwd",
            "sizeof(cwd)"
          ],
          "line": 37
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include <security/pam_appl.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <limits.h>\n#include \"test_assert.h\"\n\n#define MODULE_NAME \"pam_localuser\"\n\nstatic const char service_file[] = TEST_NAME \".service\";\nstatic const char passwd_file[] = TEST_NAME \".passwd\";\nstatic const char missing_file[] = TEST_NAME \".missing\";\nstatic const char alice_line[] = \"alice:x:1001:1001:Alice:/home/alice:\";\nstatic const char bob_line[] = \"bob:x:1002:1002:Bob:/home/bob:\";\nstatic const char craig_prefix[] = \":x:1003:1003:\";\nstatic const char craig_suffix[] = \"craig:/home/craig:\";\n\nint\nmain(void)\n{\n\tstatic struct pam_conv conv;\n\tpam_handle_t *pamh = NULL;\n\tFILE *fp;\n\tchar cwd[PATH_MAX];\n\tchar name[BUFSIZ];\n\n\tASSERT_NE(NULL, getcwd(cwd, sizeof(cwd)));\n\n\t/* default passwd */\n\tASSERT_NE(NULL, fp = fopen(service_file, \"w\"));\n\tASSERT_LT(0, fprintf(fp, \"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so\\n\",\n\t\t\t     cwd, MODULE_NAME));\n\tASSERT_EQ(0, fclose(fp));\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SERVICE_ERR, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tmemset(name, 'x', sizeof(name) - 1);\n\tname[sizeof(name) - 1] = '\\0';\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, name, &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SERVICE_ERR, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"root:x\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_PERM_DENIED, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\t/* missing passwd file */\n\tASSERT_NE(NULL, fp = fopen(service_file, \"w\"));\n\tASSERT_LT(0, fprintf(fp, \"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so file=%s\\n\",\n\t\t\t     cwd, MODULE_NAME, missing_file));\n\tASSERT_EQ(0, fclose(fp));\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"root\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SERVICE_ERR, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\t/* custom passwd file */\n\tASSERT_NE(NULL, fp = fopen(service_file, \"w\"));\n\tASSERT_LT(0, fprintf(fp, \"#%%PAM-1.0\\n\"\n\t\t\t     \"auth required %s/.libs/%s.so file=%s\\n\",\n\t\t\t     cwd, MODULE_NAME, passwd_file));\n\tASSERT_EQ(0, fclose(fp));\n\n\tmemcpy(name + (sizeof(name) - sizeof(craig_prefix)),\n\t       craig_prefix, sizeof(craig_prefix));\n\tASSERT_NE(NULL, fp = fopen(passwd_file, \"w\"));\n\tASSERT_LT(0, fprintf(fp, \"%s\\n%s\\n%s%s\\n\",\n\t\t\t     alice_line, bob_line, name, craig_suffix));\n\tASSERT_EQ(0, fclose(fp));\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SERVICE_ERR, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tmemset(name, 'x', sizeof(name) - 1);\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, name, &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SERVICE_ERR, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"alice\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SUCCESS, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"bob\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_SUCCESS, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"alice:x\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_PERM_DENIED, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(PAM_SUCCESS,\n\t\t  pam_start_confdir(service_file, \"craig\", &conv, \".\", &pamh));\n\tASSERT_NE(NULL, pamh);\n\tASSERT_EQ(PAM_PERM_DENIED, pam_authenticate(pamh, 0));\n\tASSERT_EQ(PAM_SUCCESS, pam_end(pamh, 0));\n\tpamh = NULL;\n\n\tASSERT_EQ(0, unlink(service_file));\n\tASSERT_EQ(0, unlink(passwd_file));\n\n\treturn 0;\n}"
  }
]