[
  {
    "function_name": "tests",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/regress/unittests/sshkey/tests.c",
    "lines": "18-27",
    "snippet": "void\ntests(void)\n{\n\tOpenSSL_add_all_algorithms();\n\tERR_load_CRYPTO_strings();\n\n\tsshkey_tests();\n\tsshkey_file_tests();\n\tsshkey_fuzz_tests();\n}",
    "includes": [
      "#include \"../test_helper/test_helper.h\"",
      "#include <openssl/evp.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "void sshkey_tests(void);",
      "void sshkey_file_tests(void);",
      "void sshkey_fuzz_tests(void);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "sshkey_fuzz_tests",
          "args": [],
          "line": 26
        },
        "resolved": true,
        "details": {
          "function_name": "sshkey_fuzz_tests",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/regress/unittests/sshkey/test_fuzz.c",
          "lines": "99-360",
          "snippet": "void\nsshkey_fuzz_tests(void)\n{\n\tstruct sshkey *k1;\n\tstruct sshbuf *buf, *fuzzed;\n\tstruct fuzz *fuzz;\n\tint r;\n\n\n\tTEST_START(\"fuzz RSA private\");\n\tbuf = load_file(\"rsa_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA new-format private\");\n\tbuf = load_file(\"rsa_n\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA private\");\n\tbuf = load_file(\"dsa_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA new-format private\");\n\tbuf = load_file(\"dsa_n\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"fuzz ECDSA private\");\n\tbuf = load_file(\"ecdsa_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz ECDSA new-format private\");\n\tbuf = load_file(\"ecdsa_n\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"fuzz Ed25519 private\");\n\tbuf = load_file(\"ed25519_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA public\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA public\");\n\tbuf = load_file(\"dsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"dsa_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"fuzz ECDSA public\");\n\tbuf = load_file(\"ecdsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz ECDSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"ecdsa_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"fuzz Ed25519 public\");\n\tbuf = load_file(\"ed25519_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz Ed25519 cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"ed25519_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA sig\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, \"ssh-rsa\");\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA SHA256 sig\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, \"rsa-sha2-256\");\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA SHA512 sig\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, \"rsa-sha2-512\");\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA sig\");\n\tbuf = load_file(\"dsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"fuzz ECDSA sig\");\n\tbuf = load_file(\"ecdsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"fuzz Ed25519 sig\");\n\tbuf = load_file(\"ed25519_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n/* XXX fuzz decoded new-format blobs too */\n\n}",
          "includes": [
            "#include \"common.h\"",
            "#include \"sshbuf.h\"",
            "#include \"sshkey.h\"",
            "#include \"authfile.h\"",
            "#include \"ssherr.h\"",
            "#include \"../test_helper/test_helper.h\"",
            "# include <openssl/ec.h>",
            "#include <openssl/objects.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/bn.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>",
            "#include <stdio.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/param.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "void sshkey_fuzz_tests(void);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"common.h\"\n#include \"sshbuf.h\"\n#include \"sshkey.h\"\n#include \"authfile.h\"\n#include \"ssherr.h\"\n#include \"../test_helper/test_helper.h\"\n# include <openssl/ec.h>\n#include <openssl/objects.h>\n#include <openssl/dsa.h>\n#include <openssl/rsa.h>\n#include <openssl/bn.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdint.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/param.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid sshkey_fuzz_tests(void);\n\nvoid\nsshkey_fuzz_tests(void)\n{\n\tstruct sshkey *k1;\n\tstruct sshbuf *buf, *fuzzed;\n\tstruct fuzz *fuzz;\n\tint r;\n\n\n\tTEST_START(\"fuzz RSA private\");\n\tbuf = load_file(\"rsa_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA new-format private\");\n\tbuf = load_file(\"rsa_n\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA private\");\n\tbuf = load_file(\"dsa_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA new-format private\");\n\tbuf = load_file(\"dsa_n\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"fuzz ECDSA private\");\n\tbuf = load_file(\"ecdsa_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz ECDSA new-format private\");\n\tbuf = load_file(\"ecdsa_n\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"fuzz Ed25519 private\");\n\tbuf = load_file(\"ed25519_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA public\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA public\");\n\tbuf = load_file(\"dsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"dsa_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"fuzz ECDSA public\");\n\tbuf = load_file(\"ecdsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz ECDSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"ecdsa_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"fuzz Ed25519 public\");\n\tbuf = load_file(\"ed25519_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz Ed25519 cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"ed25519_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA sig\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, \"ssh-rsa\");\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA SHA256 sig\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, \"rsa-sha2-256\");\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA SHA512 sig\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, \"rsa-sha2-512\");\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA sig\");\n\tbuf = load_file(\"dsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"fuzz ECDSA sig\");\n\tbuf = load_file(\"ecdsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"fuzz Ed25519 sig\");\n\tbuf = load_file(\"ed25519_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n/* XXX fuzz decoded new-format blobs too */\n\n}"
        }
      },
      {
        "call_info": {
          "callee": "sshkey_file_tests",
          "args": [],
          "line": 25
        },
        "resolved": true,
        "details": {
          "function_name": "sshkey_file_tests",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/regress/unittests/sshkey/test_file.c",
          "lines": "42-421",
          "snippet": "void\nsshkey_file_tests(void)\n{\n\tstruct sshkey *k1, *k2;\n\tstruct sshbuf *buf, *pw;\n\tBIGNUM *a, *b, *c;\n\tchar *cp;\n\n\tTEST_START(\"load passphrase\");\n\tpw = load_text_file(\"pw\");\n\tTEST_DONE();\n\n\n\tTEST_START(\"parse RSA from private\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k1, NULL);\n\ta = load_bignum(\"rsa_1.param.n\");\n\tb = load_bignum(\"rsa_1.param.p\");\n\tc = load_bignum(\"rsa_1.param.q\");\n\tASSERT_BIGNUM_EQ(rsa_n(k1), a);\n\tASSERT_BIGNUM_EQ(rsa_p(k1), b);\n\tASSERT_BIGNUM_EQ(rsa_q(k1), c);\n\tBN_free(a);\n\tBN_free(b);\n\tBN_free(c);\n\tTEST_DONE();\n\n\tTEST_START(\"parse RSA from private w/ passphrase\");\n\tbuf = load_file(\"rsa_1_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse RSA from new-format\");\n\tbuf = load_file(\"rsa_n\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse RSA from new-format w/ passphrase\");\n\tbuf = load_file(\"rsa_n_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load RSA from public\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"rsa_1.pub\"), &k2,\n\t    NULL), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load RSA cert with SHA1 signature\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1_sha1\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_RSA_CERT);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tASSERT_STRING_EQ(k2->cert->signature_type, \"ssh-rsa\");\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load RSA cert with SHA512 signature\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1_sha512\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_RSA_CERT);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tASSERT_STRING_EQ(k2->cert->signature_type, \"rsa-sha2-512\");\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load RSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_RSA_CERT);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 0);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tTEST_DONE();\n\n\tTEST_START(\"RSA key hex fingerprint\");\n\tbuf = load_text_file(\"rsa_1.fp\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tTEST_START(\"RSA cert hex fingerprint\");\n\tbuf = load_text_file(\"rsa_1-cert.fp\");\n\tcp = sshkey_fingerprint(k2, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"RSA key bubblebabble fingerprint\");\n\tbuf = load_text_file(\"rsa_1.fp.bb\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA1, SSH_FP_BUBBLEBABBLE);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tsshkey_free(k1);\n\n\tTEST_START(\"parse DSA from private\");\n\tbuf = load_file(\"dsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k1, NULL);\n\ta = load_bignum(\"dsa_1.param.g\");\n\tb = load_bignum(\"dsa_1.param.priv\");\n\tc = load_bignum(\"dsa_1.param.pub\");\n\tASSERT_BIGNUM_EQ(dsa_g(k1), a);\n\tASSERT_BIGNUM_EQ(dsa_priv_key(k1), b);\n\tASSERT_BIGNUM_EQ(dsa_pub_key(k1), c);\n\tBN_free(a);\n\tBN_free(b);\n\tBN_free(c);\n\tTEST_DONE();\n\n\tTEST_START(\"parse DSA from private w/ passphrase\");\n\tbuf = load_file(\"dsa_1_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse DSA from new-format\");\n\tbuf = load_file(\"dsa_n\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse DSA from new-format w/ passphrase\");\n\tbuf = load_file(\"dsa_n_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load DSA from public\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"dsa_1.pub\"), &k2,\n\t    NULL), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load DSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"dsa_1\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_DSA_CERT);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 0);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tTEST_DONE();\n\n\tTEST_START(\"DSA key hex fingerprint\");\n\tbuf = load_text_file(\"dsa_1.fp\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tTEST_START(\"DSA cert hex fingerprint\");\n\tbuf = load_text_file(\"dsa_1-cert.fp\");\n\tcp = sshkey_fingerprint(k2, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"DSA key bubblebabble fingerprint\");\n\tbuf = load_text_file(\"dsa_1.fp.bb\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA1, SSH_FP_BUBBLEBABBLE);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tsshkey_free(k1);\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"parse ECDSA from private\");\n\tbuf = load_file(\"ecdsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k1, NULL);\n\tbuf = load_text_file(\"ecdsa_1.param.curve\");\n\tASSERT_STRING_EQ((const char *)sshbuf_ptr(buf),\n\t    OBJ_nid2sn(k1->ecdsa_nid));\n\tsshbuf_free(buf);\n\ta = load_bignum(\"ecdsa_1.param.priv\");\n\tb = load_bignum(\"ecdsa_1.param.pub\");\n\tc = EC_POINT_point2bn(EC_KEY_get0_group(k1->ecdsa),\n\t    EC_KEY_get0_public_key(k1->ecdsa), POINT_CONVERSION_UNCOMPRESSED,\n\t    NULL, NULL);\n\tASSERT_PTR_NE(c, NULL);\n\tASSERT_BIGNUM_EQ(EC_KEY_get0_private_key(k1->ecdsa), a);\n\tASSERT_BIGNUM_EQ(b, c);\n\tBN_free(a);\n\tBN_free(b);\n\tBN_free(c);\n\tTEST_DONE();\n\n\tTEST_START(\"parse ECDSA from private w/ passphrase\");\n\tbuf = load_file(\"ecdsa_1_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse ECDSA from new-format\");\n\tbuf = load_file(\"ecdsa_n\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse ECDSA from new-format w/ passphrase\");\n\tbuf = load_file(\"ecdsa_n_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load ECDSA from public\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"ecdsa_1.pub\"), &k2,\n\t    NULL), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load ECDSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"ecdsa_1\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_ECDSA_CERT);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 0);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tTEST_DONE();\n\n\tTEST_START(\"ECDSA key hex fingerprint\");\n\tbuf = load_text_file(\"ecdsa_1.fp\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tTEST_START(\"ECDSA cert hex fingerprint\");\n\tbuf = load_text_file(\"ecdsa_1-cert.fp\");\n\tcp = sshkey_fingerprint(k2, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"ECDSA key bubblebabble fingerprint\");\n\tbuf = load_text_file(\"ecdsa_1.fp.bb\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA1, SSH_FP_BUBBLEBABBLE);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tsshkey_free(k1);\n#endif /* OPENSSL_HAS_ECC */\n\n\tTEST_START(\"parse Ed25519 from private\");\n\tbuf = load_file(\"ed25519_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_INT_EQ(k1->type, KEY_ED25519);\n\t/* XXX check key contents */\n\tTEST_DONE();\n\n\tTEST_START(\"parse Ed25519 from private w/ passphrase\");\n\tbuf = load_file(\"ed25519_1_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load Ed25519 from public\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"ed25519_1.pub\"), &k2,\n\t    NULL), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load Ed25519 cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"ed25519_1\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_ED25519_CERT);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 0);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tTEST_DONE();\n\n\tTEST_START(\"Ed25519 key hex fingerprint\");\n\tbuf = load_text_file(\"ed25519_1.fp\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tTEST_START(\"Ed25519 cert hex fingerprint\");\n\tbuf = load_text_file(\"ed25519_1-cert.fp\");\n\tcp = sshkey_fingerprint(k2, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"Ed25519 key bubblebabble fingerprint\");\n\tbuf = load_text_file(\"ed25519_1.fp.bb\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA1, SSH_FP_BUBBLEBABBLE);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tsshkey_free(k1);\n\n\tsshbuf_free(pw);\n\n}",
          "includes": [
            "#include \"common.h\"",
            "#include \"digest.h\"",
            "#include \"sshbuf.h\"",
            "#include \"sshkey.h\"",
            "#include \"authfile.h\"",
            "#include \"ssherr.h\"",
            "#include \"../test_helper/test_helper.h\"",
            "# include <openssl/ec.h>",
            "#include <openssl/objects.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/bn.h>",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>",
            "#include <stdio.h>",
            "#include <fcntl.h>",
            "#include <sys/stat.h>",
            "#include <sys/param.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "void sshkey_file_tests(void);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"common.h\"\n#include \"digest.h\"\n#include \"sshbuf.h\"\n#include \"sshkey.h\"\n#include \"authfile.h\"\n#include \"ssherr.h\"\n#include \"../test_helper/test_helper.h\"\n# include <openssl/ec.h>\n#include <openssl/objects.h>\n#include <openssl/dsa.h>\n#include <openssl/rsa.h>\n#include <openssl/bn.h>\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdint.h>\n#include <stdio.h>\n#include <fcntl.h>\n#include <sys/stat.h>\n#include <sys/param.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid sshkey_file_tests(void);\n\nvoid\nsshkey_file_tests(void)\n{\n\tstruct sshkey *k1, *k2;\n\tstruct sshbuf *buf, *pw;\n\tBIGNUM *a, *b, *c;\n\tchar *cp;\n\n\tTEST_START(\"load passphrase\");\n\tpw = load_text_file(\"pw\");\n\tTEST_DONE();\n\n\n\tTEST_START(\"parse RSA from private\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k1, NULL);\n\ta = load_bignum(\"rsa_1.param.n\");\n\tb = load_bignum(\"rsa_1.param.p\");\n\tc = load_bignum(\"rsa_1.param.q\");\n\tASSERT_BIGNUM_EQ(rsa_n(k1), a);\n\tASSERT_BIGNUM_EQ(rsa_p(k1), b);\n\tASSERT_BIGNUM_EQ(rsa_q(k1), c);\n\tBN_free(a);\n\tBN_free(b);\n\tBN_free(c);\n\tTEST_DONE();\n\n\tTEST_START(\"parse RSA from private w/ passphrase\");\n\tbuf = load_file(\"rsa_1_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse RSA from new-format\");\n\tbuf = load_file(\"rsa_n\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse RSA from new-format w/ passphrase\");\n\tbuf = load_file(\"rsa_n_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load RSA from public\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"rsa_1.pub\"), &k2,\n\t    NULL), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load RSA cert with SHA1 signature\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1_sha1\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_RSA_CERT);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tASSERT_STRING_EQ(k2->cert->signature_type, \"ssh-rsa\");\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load RSA cert with SHA512 signature\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1_sha512\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_RSA_CERT);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tASSERT_STRING_EQ(k2->cert->signature_type, \"rsa-sha2-512\");\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load RSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_RSA_CERT);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 0);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tTEST_DONE();\n\n\tTEST_START(\"RSA key hex fingerprint\");\n\tbuf = load_text_file(\"rsa_1.fp\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tTEST_START(\"RSA cert hex fingerprint\");\n\tbuf = load_text_file(\"rsa_1-cert.fp\");\n\tcp = sshkey_fingerprint(k2, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"RSA key bubblebabble fingerprint\");\n\tbuf = load_text_file(\"rsa_1.fp.bb\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA1, SSH_FP_BUBBLEBABBLE);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tsshkey_free(k1);\n\n\tTEST_START(\"parse DSA from private\");\n\tbuf = load_file(\"dsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k1, NULL);\n\ta = load_bignum(\"dsa_1.param.g\");\n\tb = load_bignum(\"dsa_1.param.priv\");\n\tc = load_bignum(\"dsa_1.param.pub\");\n\tASSERT_BIGNUM_EQ(dsa_g(k1), a);\n\tASSERT_BIGNUM_EQ(dsa_priv_key(k1), b);\n\tASSERT_BIGNUM_EQ(dsa_pub_key(k1), c);\n\tBN_free(a);\n\tBN_free(b);\n\tBN_free(c);\n\tTEST_DONE();\n\n\tTEST_START(\"parse DSA from private w/ passphrase\");\n\tbuf = load_file(\"dsa_1_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse DSA from new-format\");\n\tbuf = load_file(\"dsa_n\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse DSA from new-format w/ passphrase\");\n\tbuf = load_file(\"dsa_n_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load DSA from public\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"dsa_1.pub\"), &k2,\n\t    NULL), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load DSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"dsa_1\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_DSA_CERT);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 0);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tTEST_DONE();\n\n\tTEST_START(\"DSA key hex fingerprint\");\n\tbuf = load_text_file(\"dsa_1.fp\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tTEST_START(\"DSA cert hex fingerprint\");\n\tbuf = load_text_file(\"dsa_1-cert.fp\");\n\tcp = sshkey_fingerprint(k2, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"DSA key bubblebabble fingerprint\");\n\tbuf = load_text_file(\"dsa_1.fp.bb\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA1, SSH_FP_BUBBLEBABBLE);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tsshkey_free(k1);\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"parse ECDSA from private\");\n\tbuf = load_file(\"ecdsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k1, NULL);\n\tbuf = load_text_file(\"ecdsa_1.param.curve\");\n\tASSERT_STRING_EQ((const char *)sshbuf_ptr(buf),\n\t    OBJ_nid2sn(k1->ecdsa_nid));\n\tsshbuf_free(buf);\n\ta = load_bignum(\"ecdsa_1.param.priv\");\n\tb = load_bignum(\"ecdsa_1.param.pub\");\n\tc = EC_POINT_point2bn(EC_KEY_get0_group(k1->ecdsa),\n\t    EC_KEY_get0_public_key(k1->ecdsa), POINT_CONVERSION_UNCOMPRESSED,\n\t    NULL, NULL);\n\tASSERT_PTR_NE(c, NULL);\n\tASSERT_BIGNUM_EQ(EC_KEY_get0_private_key(k1->ecdsa), a);\n\tASSERT_BIGNUM_EQ(b, c);\n\tBN_free(a);\n\tBN_free(b);\n\tBN_free(c);\n\tTEST_DONE();\n\n\tTEST_START(\"parse ECDSA from private w/ passphrase\");\n\tbuf = load_file(\"ecdsa_1_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse ECDSA from new-format\");\n\tbuf = load_file(\"ecdsa_n\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"parse ECDSA from new-format w/ passphrase\");\n\tbuf = load_file(\"ecdsa_n_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load ECDSA from public\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"ecdsa_1.pub\"), &k2,\n\t    NULL), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load ECDSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"ecdsa_1\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_ECDSA_CERT);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 0);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tTEST_DONE();\n\n\tTEST_START(\"ECDSA key hex fingerprint\");\n\tbuf = load_text_file(\"ecdsa_1.fp\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tTEST_START(\"ECDSA cert hex fingerprint\");\n\tbuf = load_text_file(\"ecdsa_1-cert.fp\");\n\tcp = sshkey_fingerprint(k2, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"ECDSA key bubblebabble fingerprint\");\n\tbuf = load_text_file(\"ecdsa_1.fp.bb\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA1, SSH_FP_BUBBLEBABBLE);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tsshkey_free(k1);\n#endif /* OPENSSL_HAS_ECC */\n\n\tTEST_START(\"parse Ed25519 from private\");\n\tbuf = load_file(\"ed25519_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_INT_EQ(k1->type, KEY_ED25519);\n\t/* XXX check key contents */\n\tTEST_DONE();\n\n\tTEST_START(\"parse Ed25519 from private w/ passphrase\");\n\tbuf = load_file(\"ed25519_1_pw\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf,\n\t    (const char *)sshbuf_ptr(pw), &k2, NULL), 0);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load Ed25519 from public\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"ed25519_1.pub\"), &k2,\n\t    NULL), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"load Ed25519 cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"ed25519_1\"), &k2), 0);\n\tASSERT_PTR_NE(k2, NULL);\n\tASSERT_INT_EQ(k2->type, KEY_ED25519_CERT);\n\tASSERT_INT_EQ(sshkey_equal(k1, k2), 0);\n\tASSERT_INT_EQ(sshkey_equal_public(k1, k2), 1);\n\tTEST_DONE();\n\n\tTEST_START(\"Ed25519 key hex fingerprint\");\n\tbuf = load_text_file(\"ed25519_1.fp\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tTEST_START(\"Ed25519 cert hex fingerprint\");\n\tbuf = load_text_file(\"ed25519_1-cert.fp\");\n\tcp = sshkey_fingerprint(k2, SSH_DIGEST_SHA256, SSH_FP_BASE64);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"Ed25519 key bubblebabble fingerprint\");\n\tbuf = load_text_file(\"ed25519_1.fp.bb\");\n\tcp = sshkey_fingerprint(k1, SSH_DIGEST_SHA1, SSH_FP_BUBBLEBABBLE);\n\tASSERT_PTR_NE(cp, NULL);\n\tASSERT_STRING_EQ(cp, (const char *)sshbuf_ptr(buf));\n\tsshbuf_free(buf);\n\tfree(cp);\n\tTEST_DONE();\n\n\tsshkey_free(k1);\n\n\tsshbuf_free(pw);\n\n}"
        }
      },
      {
        "call_info": {
          "callee": "sshkey_tests",
          "args": [],
          "line": 24
        },
        "resolved": true,
        "details": {
          "function_name": "sshkey_tests",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/regress/unittests/sshkey/test_sshkey.c",
          "lines": "176-508",
          "snippet": "void\nsshkey_tests(void)\n{\n\tstruct sshkey *k1, *k2, *k3, *k4, *kr, *kd, *kf;\n#ifdef OPENSSL_HAS_ECC\n\tstruct sshkey *ke;\n#endif\n\tstruct sshbuf *b;\n\n\tTEST_START(\"new invalid\");\n\tk1 = sshkey_new(-42);\n\tASSERT_PTR_EQ(k1, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"new/free KEY_UNSPEC\");\n\tk1 = sshkey_new(KEY_UNSPEC);\n\tASSERT_PTR_NE(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"new/free KEY_RSA\");\n\tk1 = sshkey_new(KEY_RSA);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(k1->rsa, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"new/free KEY_DSA\");\n\tk1 = sshkey_new(KEY_DSA);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(k1->dsa, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"new/free KEY_ECDSA\");\n\tk1 = sshkey_new(KEY_ECDSA);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_EQ(k1->ecdsa, NULL);  /* Can't allocate without NID */\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"new/free KEY_ED25519\");\n\tk1 = sshkey_new(KEY_ED25519);\n\tASSERT_PTR_NE(k1, NULL);\n\t/* These should be blank until key loaded or generated */\n\tASSERT_PTR_EQ(k1->ed25519_sk, NULL);\n\tASSERT_PTR_EQ(k1->ed25519_pk, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"generate KEY_RSA too small modulus\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_RSA, 128, &k1),\n\t    SSH_ERR_KEY_LENGTH);\n\tASSERT_PTR_EQ(k1, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"generate KEY_RSA too large modulus\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_RSA, 1 << 20, &k1),\n\t    SSH_ERR_KEY_LENGTH);\n\tASSERT_PTR_EQ(k1, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"generate KEY_DSA wrong bits\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_DSA, 2048, &k1),\n\t    SSH_ERR_KEY_LENGTH);\n\tASSERT_PTR_EQ(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"generate KEY_ECDSA wrong bits\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_ECDSA, 42, &k1),\n\t    SSH_ERR_KEY_LENGTH);\n\tASSERT_PTR_EQ(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"generate KEY_RSA\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_RSA, 767, &kr),\n\t    SSH_ERR_KEY_LENGTH);\n\tASSERT_INT_EQ(sshkey_generate(KEY_RSA, 1024, &kr), 0);\n\tASSERT_PTR_NE(kr, NULL);\n\tASSERT_PTR_NE(kr->rsa, NULL);\n\tASSERT_PTR_NE(rsa_n(kr), NULL);\n\tASSERT_PTR_NE(rsa_e(kr), NULL);\n\tASSERT_PTR_NE(rsa_p(kr), NULL);\n\tASSERT_INT_EQ(BN_num_bits(rsa_n(kr)), 1024);\n\tTEST_DONE();\n\n\tTEST_START(\"generate KEY_DSA\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_DSA, 1024, &kd), 0);\n\tASSERT_PTR_NE(kd, NULL);\n\tASSERT_PTR_NE(kd->dsa, NULL);\n\tASSERT_PTR_NE(dsa_g(kd), NULL);\n\tASSERT_PTR_NE(dsa_priv_key(kd), NULL);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"generate KEY_ECDSA\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_ECDSA, 256, &ke), 0);\n\tASSERT_PTR_NE(ke, NULL);\n\tASSERT_PTR_NE(ke->ecdsa, NULL);\n\tASSERT_PTR_NE(EC_KEY_get0_public_key(ke->ecdsa), NULL);\n\tASSERT_PTR_NE(EC_KEY_get0_private_key(ke->ecdsa), NULL);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"generate KEY_ED25519\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_ED25519, 256, &kf), 0);\n\tASSERT_PTR_NE(kf, NULL);\n\tASSERT_INT_EQ(kf->type, KEY_ED25519);\n\tASSERT_PTR_NE(kf->ed25519_pk, NULL);\n\tASSERT_PTR_NE(kf->ed25519_sk, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"demote KEY_RSA\");\n\tASSERT_INT_EQ(sshkey_from_private(kr, &k1), 0);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(kr, k1);\n\tASSERT_INT_EQ(k1->type, KEY_RSA);\n\tASSERT_PTR_NE(k1->rsa, NULL);\n\tASSERT_PTR_NE(rsa_n(k1), NULL);\n\tASSERT_PTR_NE(rsa_e(k1), NULL);\n\tASSERT_PTR_EQ(rsa_p(k1), NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"equal KEY_RSA/demoted KEY_RSA\");\n\tASSERT_INT_EQ(sshkey_equal(kr, k1), 1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"demote KEY_DSA\");\n\tASSERT_INT_EQ(sshkey_from_private(kd, &k1), 0);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(kd, k1);\n\tASSERT_INT_EQ(k1->type, KEY_DSA);\n\tASSERT_PTR_NE(k1->dsa, NULL);\n\tASSERT_PTR_NE(dsa_g(k1), NULL);\n\tASSERT_PTR_EQ(dsa_priv_key(k1), NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"equal KEY_DSA/demoted KEY_DSA\");\n\tASSERT_INT_EQ(sshkey_equal(kd, k1), 1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"demote KEY_ECDSA\");\n\tASSERT_INT_EQ(sshkey_from_private(ke, &k1), 0);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(ke, k1);\n\tASSERT_INT_EQ(k1->type, KEY_ECDSA);\n\tASSERT_PTR_NE(k1->ecdsa, NULL);\n\tASSERT_INT_EQ(k1->ecdsa_nid, ke->ecdsa_nid);\n\tASSERT_PTR_NE(EC_KEY_get0_public_key(ke->ecdsa), NULL);\n\tASSERT_PTR_EQ(EC_KEY_get0_private_key(k1->ecdsa), NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"equal KEY_ECDSA/demoted KEY_ECDSA\");\n\tASSERT_INT_EQ(sshkey_equal(ke, k1), 1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"demote KEY_ED25519\");\n\tASSERT_INT_EQ(sshkey_from_private(kf, &k1), 0);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(kf, k1);\n\tASSERT_INT_EQ(k1->type, KEY_ED25519);\n\tASSERT_PTR_NE(k1->ed25519_pk, NULL);\n\tASSERT_PTR_EQ(k1->ed25519_sk, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"equal KEY_ED25519/demoted KEY_ED25519\");\n\tASSERT_INT_EQ(sshkey_equal(kf, k1), 1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"equal mismatched key types\");\n\tASSERT_INT_EQ(sshkey_equal(kd, kr), 0);\n#ifdef OPENSSL_HAS_ECC\n\tASSERT_INT_EQ(sshkey_equal(kd, ke), 0);\n\tASSERT_INT_EQ(sshkey_equal(kr, ke), 0);\n\tASSERT_INT_EQ(sshkey_equal(ke, kf), 0);\n#endif\n\tASSERT_INT_EQ(sshkey_equal(kd, kf), 0);\n\tTEST_DONE();\n\n\tTEST_START(\"equal different keys\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_RSA, 1024, &k1), 0);\n\tASSERT_INT_EQ(sshkey_equal(kr, k1), 0);\n\tsshkey_free(k1);\n\tASSERT_INT_EQ(sshkey_generate(KEY_DSA, 1024, &k1), 0);\n\tASSERT_INT_EQ(sshkey_equal(kd, k1), 0);\n\tsshkey_free(k1);\n#ifdef OPENSSL_HAS_ECC\n\tASSERT_INT_EQ(sshkey_generate(KEY_ECDSA, 256, &k1), 0);\n\tASSERT_INT_EQ(sshkey_equal(ke, k1), 0);\n\tsshkey_free(k1);\n#endif\n\tASSERT_INT_EQ(sshkey_generate(KEY_ED25519, 256, &k1), 0);\n\tASSERT_INT_EQ(sshkey_equal(kf, k1), 0);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tsshkey_free(kr);\n\tsshkey_free(kd);\n#ifdef OPENSSL_HAS_ECC\n\tsshkey_free(ke);\n#endif\n\tsshkey_free(kf);\n\n\tTEST_START(\"certify key\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"ed25519_1.pub\"),\n\t    &k1, NULL), 0);\n\tk2 = get_private(\"ed25519_2\");\n\tASSERT_INT_EQ(sshkey_to_certified(k1), 0);\n\tASSERT_PTR_NE(k1->cert, NULL);\n\tk1->cert->type = SSH2_CERT_TYPE_USER;\n\tk1->cert->serial = 1234;\n\tk1->cert->key_id = strdup(\"estragon\");\n\tASSERT_PTR_NE(k1->cert->key_id, NULL);\n\tk1->cert->principals = calloc(4, sizeof(*k1->cert->principals));\n\tASSERT_PTR_NE(k1->cert->principals, NULL);\n\tk1->cert->principals[0] = strdup(\"estragon\");\n\tk1->cert->principals[1] = strdup(\"vladimir\");\n\tk1->cert->principals[2] = strdup(\"pozzo\");\n\tk1->cert->principals[3] = strdup(\"lucky\");\n\tASSERT_PTR_NE(k1->cert->principals[0], NULL);\n\tASSERT_PTR_NE(k1->cert->principals[1], NULL);\n\tASSERT_PTR_NE(k1->cert->principals[2], NULL);\n\tASSERT_PTR_NE(k1->cert->principals[3], NULL);\n\tk1->cert->nprincipals = 4;\n\tk1->cert->valid_after = 0;\n\tk1->cert->valid_before = (u_int64_t)-1;\n\tsshbuf_free(k1->cert->critical);\n\tk1->cert->critical = sshbuf_new();\n\tASSERT_PTR_NE(k1->cert->critical, NULL);\n\tsshbuf_free(k1->cert->extensions);\n\tk1->cert->extensions = sshbuf_new();\n\tASSERT_PTR_NE(k1->cert->extensions, NULL);\n\tput_opt(k1->cert->critical, \"force-command\", \"/usr/bin/true\");\n\tput_opt(k1->cert->critical, \"source-address\", \"127.0.0.1\");\n\tput_opt(k1->cert->extensions, \"permit-X11-forwarding\", NULL);\n\tput_opt(k1->cert->extensions, \"permit-agent-forwarding\", NULL);\n\tASSERT_INT_EQ(sshkey_from_private(k2, &k1->cert->signature_key), 0);\n\tASSERT_INT_EQ(sshkey_certify(k1, k2, NULL), 0);\n\tb = sshbuf_new();\n\tASSERT_PTR_NE(b, NULL);\n\tASSERT_INT_EQ(sshkey_putb(k1, b), 0);\n\tASSERT_INT_EQ(sshkey_from_blob(sshbuf_ptr(b), sshbuf_len(b), &k3), 0);\n\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tsshkey_free(k3);\n\tsshbuf_reset(b);\n\tTEST_DONE();\n\n\tTEST_START(\"sign and verify RSA\");\n\tk1 = get_private(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"rsa_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, \"ssh-rsa\");\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"sign and verify RSA-SHA256\");\n\tk1 = get_private(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"rsa_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, \"rsa-sha2-256\");\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"sign and verify RSA-SHA512\");\n\tk1 = get_private(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"rsa_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, \"rsa-sha2-512\");\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"sign and verify DSA\");\n\tk1 = get_private(\"dsa_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"dsa_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, NULL);\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"sign and verify ECDSA\");\n\tk1 = get_private(\"ecdsa_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"ecdsa_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, NULL);\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"sign and verify ED25519\");\n\tk1 = get_private(\"ed25519_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"ed25519_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, NULL);\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"nested certificate\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1\"), &k1), 0);\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"rsa_1.pub\"), &k2,\n\t    NULL), 0);\n\tk3 = get_private(\"rsa_1\");\n\tbuild_cert(b, k2, \"ssh-rsa-cert-v01@openssh.com\", k3, k1, NULL);\n\tASSERT_INT_EQ(sshkey_from_blob(sshbuf_ptr(b), sshbuf_len(b), &k4),\n\t    SSH_ERR_KEY_CERT_INVALID_SIGN_KEY);\n\tASSERT_PTR_EQ(k4, NULL);\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tsshkey_free(k3);\n\tsshbuf_free(b);\n\tTEST_DONE();\n\n}",
          "includes": [
            "#include \"ssh2.h\"",
            "#include \"common.h\"",
            "#include \"authfile.h\"",
            "#include \"sshkey.h\"",
            "#include \"sshbuf.h\"",
            "#include \"ssherr.h\"",
            "#include \"../test_helper/test_helper.h\"",
            "# include <openssl/ec.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/bn.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdint.h>",
            "#include <stdio.h>",
            "#include <sys/param.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "void sshkey_tests(void);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"ssh2.h\"\n#include \"common.h\"\n#include \"authfile.h\"\n#include \"sshkey.h\"\n#include \"sshbuf.h\"\n#include \"ssherr.h\"\n#include \"../test_helper/test_helper.h\"\n# include <openssl/ec.h>\n#include <openssl/dsa.h>\n#include <openssl/rsa.h>\n#include <openssl/bn.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdint.h>\n#include <stdio.h>\n#include <sys/param.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid sshkey_tests(void);\n\nvoid\nsshkey_tests(void)\n{\n\tstruct sshkey *k1, *k2, *k3, *k4, *kr, *kd, *kf;\n#ifdef OPENSSL_HAS_ECC\n\tstruct sshkey *ke;\n#endif\n\tstruct sshbuf *b;\n\n\tTEST_START(\"new invalid\");\n\tk1 = sshkey_new(-42);\n\tASSERT_PTR_EQ(k1, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"new/free KEY_UNSPEC\");\n\tk1 = sshkey_new(KEY_UNSPEC);\n\tASSERT_PTR_NE(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"new/free KEY_RSA\");\n\tk1 = sshkey_new(KEY_RSA);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(k1->rsa, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"new/free KEY_DSA\");\n\tk1 = sshkey_new(KEY_DSA);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(k1->dsa, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"new/free KEY_ECDSA\");\n\tk1 = sshkey_new(KEY_ECDSA);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_EQ(k1->ecdsa, NULL);  /* Can't allocate without NID */\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"new/free KEY_ED25519\");\n\tk1 = sshkey_new(KEY_ED25519);\n\tASSERT_PTR_NE(k1, NULL);\n\t/* These should be blank until key loaded or generated */\n\tASSERT_PTR_EQ(k1->ed25519_sk, NULL);\n\tASSERT_PTR_EQ(k1->ed25519_pk, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"generate KEY_RSA too small modulus\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_RSA, 128, &k1),\n\t    SSH_ERR_KEY_LENGTH);\n\tASSERT_PTR_EQ(k1, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"generate KEY_RSA too large modulus\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_RSA, 1 << 20, &k1),\n\t    SSH_ERR_KEY_LENGTH);\n\tASSERT_PTR_EQ(k1, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"generate KEY_DSA wrong bits\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_DSA, 2048, &k1),\n\t    SSH_ERR_KEY_LENGTH);\n\tASSERT_PTR_EQ(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"generate KEY_ECDSA wrong bits\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_ECDSA, 42, &k1),\n\t    SSH_ERR_KEY_LENGTH);\n\tASSERT_PTR_EQ(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"generate KEY_RSA\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_RSA, 767, &kr),\n\t    SSH_ERR_KEY_LENGTH);\n\tASSERT_INT_EQ(sshkey_generate(KEY_RSA, 1024, &kr), 0);\n\tASSERT_PTR_NE(kr, NULL);\n\tASSERT_PTR_NE(kr->rsa, NULL);\n\tASSERT_PTR_NE(rsa_n(kr), NULL);\n\tASSERT_PTR_NE(rsa_e(kr), NULL);\n\tASSERT_PTR_NE(rsa_p(kr), NULL);\n\tASSERT_INT_EQ(BN_num_bits(rsa_n(kr)), 1024);\n\tTEST_DONE();\n\n\tTEST_START(\"generate KEY_DSA\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_DSA, 1024, &kd), 0);\n\tASSERT_PTR_NE(kd, NULL);\n\tASSERT_PTR_NE(kd->dsa, NULL);\n\tASSERT_PTR_NE(dsa_g(kd), NULL);\n\tASSERT_PTR_NE(dsa_priv_key(kd), NULL);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"generate KEY_ECDSA\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_ECDSA, 256, &ke), 0);\n\tASSERT_PTR_NE(ke, NULL);\n\tASSERT_PTR_NE(ke->ecdsa, NULL);\n\tASSERT_PTR_NE(EC_KEY_get0_public_key(ke->ecdsa), NULL);\n\tASSERT_PTR_NE(EC_KEY_get0_private_key(ke->ecdsa), NULL);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"generate KEY_ED25519\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_ED25519, 256, &kf), 0);\n\tASSERT_PTR_NE(kf, NULL);\n\tASSERT_INT_EQ(kf->type, KEY_ED25519);\n\tASSERT_PTR_NE(kf->ed25519_pk, NULL);\n\tASSERT_PTR_NE(kf->ed25519_sk, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"demote KEY_RSA\");\n\tASSERT_INT_EQ(sshkey_from_private(kr, &k1), 0);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(kr, k1);\n\tASSERT_INT_EQ(k1->type, KEY_RSA);\n\tASSERT_PTR_NE(k1->rsa, NULL);\n\tASSERT_PTR_NE(rsa_n(k1), NULL);\n\tASSERT_PTR_NE(rsa_e(k1), NULL);\n\tASSERT_PTR_EQ(rsa_p(k1), NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"equal KEY_RSA/demoted KEY_RSA\");\n\tASSERT_INT_EQ(sshkey_equal(kr, k1), 1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"demote KEY_DSA\");\n\tASSERT_INT_EQ(sshkey_from_private(kd, &k1), 0);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(kd, k1);\n\tASSERT_INT_EQ(k1->type, KEY_DSA);\n\tASSERT_PTR_NE(k1->dsa, NULL);\n\tASSERT_PTR_NE(dsa_g(k1), NULL);\n\tASSERT_PTR_EQ(dsa_priv_key(k1), NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"equal KEY_DSA/demoted KEY_DSA\");\n\tASSERT_INT_EQ(sshkey_equal(kd, k1), 1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"demote KEY_ECDSA\");\n\tASSERT_INT_EQ(sshkey_from_private(ke, &k1), 0);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(ke, k1);\n\tASSERT_INT_EQ(k1->type, KEY_ECDSA);\n\tASSERT_PTR_NE(k1->ecdsa, NULL);\n\tASSERT_INT_EQ(k1->ecdsa_nid, ke->ecdsa_nid);\n\tASSERT_PTR_NE(EC_KEY_get0_public_key(ke->ecdsa), NULL);\n\tASSERT_PTR_EQ(EC_KEY_get0_private_key(k1->ecdsa), NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"equal KEY_ECDSA/demoted KEY_ECDSA\");\n\tASSERT_INT_EQ(sshkey_equal(ke, k1), 1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"demote KEY_ED25519\");\n\tASSERT_INT_EQ(sshkey_from_private(kf, &k1), 0);\n\tASSERT_PTR_NE(k1, NULL);\n\tASSERT_PTR_NE(kf, k1);\n\tASSERT_INT_EQ(k1->type, KEY_ED25519);\n\tASSERT_PTR_NE(k1->ed25519_pk, NULL);\n\tASSERT_PTR_EQ(k1->ed25519_sk, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"equal KEY_ED25519/demoted KEY_ED25519\");\n\tASSERT_INT_EQ(sshkey_equal(kf, k1), 1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"equal mismatched key types\");\n\tASSERT_INT_EQ(sshkey_equal(kd, kr), 0);\n#ifdef OPENSSL_HAS_ECC\n\tASSERT_INT_EQ(sshkey_equal(kd, ke), 0);\n\tASSERT_INT_EQ(sshkey_equal(kr, ke), 0);\n\tASSERT_INT_EQ(sshkey_equal(ke, kf), 0);\n#endif\n\tASSERT_INT_EQ(sshkey_equal(kd, kf), 0);\n\tTEST_DONE();\n\n\tTEST_START(\"equal different keys\");\n\tASSERT_INT_EQ(sshkey_generate(KEY_RSA, 1024, &k1), 0);\n\tASSERT_INT_EQ(sshkey_equal(kr, k1), 0);\n\tsshkey_free(k1);\n\tASSERT_INT_EQ(sshkey_generate(KEY_DSA, 1024, &k1), 0);\n\tASSERT_INT_EQ(sshkey_equal(kd, k1), 0);\n\tsshkey_free(k1);\n#ifdef OPENSSL_HAS_ECC\n\tASSERT_INT_EQ(sshkey_generate(KEY_ECDSA, 256, &k1), 0);\n\tASSERT_INT_EQ(sshkey_equal(ke, k1), 0);\n\tsshkey_free(k1);\n#endif\n\tASSERT_INT_EQ(sshkey_generate(KEY_ED25519, 256, &k1), 0);\n\tASSERT_INT_EQ(sshkey_equal(kf, k1), 0);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tsshkey_free(kr);\n\tsshkey_free(kd);\n#ifdef OPENSSL_HAS_ECC\n\tsshkey_free(ke);\n#endif\n\tsshkey_free(kf);\n\n\tTEST_START(\"certify key\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"ed25519_1.pub\"),\n\t    &k1, NULL), 0);\n\tk2 = get_private(\"ed25519_2\");\n\tASSERT_INT_EQ(sshkey_to_certified(k1), 0);\n\tASSERT_PTR_NE(k1->cert, NULL);\n\tk1->cert->type = SSH2_CERT_TYPE_USER;\n\tk1->cert->serial = 1234;\n\tk1->cert->key_id = strdup(\"estragon\");\n\tASSERT_PTR_NE(k1->cert->key_id, NULL);\n\tk1->cert->principals = calloc(4, sizeof(*k1->cert->principals));\n\tASSERT_PTR_NE(k1->cert->principals, NULL);\n\tk1->cert->principals[0] = strdup(\"estragon\");\n\tk1->cert->principals[1] = strdup(\"vladimir\");\n\tk1->cert->principals[2] = strdup(\"pozzo\");\n\tk1->cert->principals[3] = strdup(\"lucky\");\n\tASSERT_PTR_NE(k1->cert->principals[0], NULL);\n\tASSERT_PTR_NE(k1->cert->principals[1], NULL);\n\tASSERT_PTR_NE(k1->cert->principals[2], NULL);\n\tASSERT_PTR_NE(k1->cert->principals[3], NULL);\n\tk1->cert->nprincipals = 4;\n\tk1->cert->valid_after = 0;\n\tk1->cert->valid_before = (u_int64_t)-1;\n\tsshbuf_free(k1->cert->critical);\n\tk1->cert->critical = sshbuf_new();\n\tASSERT_PTR_NE(k1->cert->critical, NULL);\n\tsshbuf_free(k1->cert->extensions);\n\tk1->cert->extensions = sshbuf_new();\n\tASSERT_PTR_NE(k1->cert->extensions, NULL);\n\tput_opt(k1->cert->critical, \"force-command\", \"/usr/bin/true\");\n\tput_opt(k1->cert->critical, \"source-address\", \"127.0.0.1\");\n\tput_opt(k1->cert->extensions, \"permit-X11-forwarding\", NULL);\n\tput_opt(k1->cert->extensions, \"permit-agent-forwarding\", NULL);\n\tASSERT_INT_EQ(sshkey_from_private(k2, &k1->cert->signature_key), 0);\n\tASSERT_INT_EQ(sshkey_certify(k1, k2, NULL), 0);\n\tb = sshbuf_new();\n\tASSERT_PTR_NE(b, NULL);\n\tASSERT_INT_EQ(sshkey_putb(k1, b), 0);\n\tASSERT_INT_EQ(sshkey_from_blob(sshbuf_ptr(b), sshbuf_len(b), &k3), 0);\n\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tsshkey_free(k3);\n\tsshbuf_reset(b);\n\tTEST_DONE();\n\n\tTEST_START(\"sign and verify RSA\");\n\tk1 = get_private(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"rsa_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, \"ssh-rsa\");\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"sign and verify RSA-SHA256\");\n\tk1 = get_private(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"rsa_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, \"rsa-sha2-256\");\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"sign and verify RSA-SHA512\");\n\tk1 = get_private(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"rsa_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, \"rsa-sha2-512\");\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"sign and verify DSA\");\n\tk1 = get_private(\"dsa_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"dsa_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, NULL);\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"sign and verify ECDSA\");\n\tk1 = get_private(\"ecdsa_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"ecdsa_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, NULL);\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n#endif\n\n\tTEST_START(\"sign and verify ED25519\");\n\tk1 = get_private(\"ed25519_1\");\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"ed25519_2.pub\"), &k2,\n\t    NULL), 0);\n\tsignature_tests(k1, k2, NULL);\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tTEST_DONE();\n\n\tTEST_START(\"nested certificate\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1\"), &k1), 0);\n\tASSERT_INT_EQ(sshkey_load_public(test_data_file(\"rsa_1.pub\"), &k2,\n\t    NULL), 0);\n\tk3 = get_private(\"rsa_1\");\n\tbuild_cert(b, k2, \"ssh-rsa-cert-v01@openssh.com\", k3, k1, NULL);\n\tASSERT_INT_EQ(sshkey_from_blob(sshbuf_ptr(b), sshbuf_len(b), &k4),\n\t    SSH_ERR_KEY_CERT_INVALID_SIGN_KEY);\n\tASSERT_PTR_EQ(k4, NULL);\n\tsshkey_free(k1);\n\tsshkey_free(k2);\n\tsshkey_free(k3);\n\tsshbuf_free(b);\n\tTEST_DONE();\n\n}"
        }
      },
      {
        "call_info": {
          "callee": "ERR_load_CRYPTO_strings",
          "args": [],
          "line": 22
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "OpenSSL_add_all_algorithms",
          "args": [],
          "line": 21
        },
        "resolved": true,
        "details": {
          "function_name": "ssh_OpenSSL_add_all_algorithms",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/openssl-compat.c",
          "lines": "70-85",
          "snippet": "void\nssh_OpenSSL_add_all_algorithms(void)\n{\n\tOpenSSL_add_all_algorithms();\n\n\t/* Enable use of crypto hardware */\n\tENGINE_load_builtin_engines();\n\tENGINE_register_all_complete();\n\n#if OPENSSL_VERSION_NUMBER < 0x10100000L\n\tOPENSSL_config(NULL);\n#else\n\tOPENSSL_init_crypto(OPENSSL_INIT_ADD_ALL_CIPHERS |\n\t    OPENSSL_INIT_ADD_ALL_DIGESTS | OPENSSL_INIT_LOAD_CONFIG, NULL);\n#endif\n}",
          "includes": [
            "#include \"openssl-compat.h\"",
            "#include \"log.h\"",
            "# include <openssl/conf.h>",
            "# include <openssl/engine.h>",
            "#include <string.h>",
            "#include <stdarg.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"openssl-compat.h\"\n#include \"log.h\"\n# include <openssl/conf.h>\n# include <openssl/engine.h>\n#include <string.h>\n#include <stdarg.h>\n#include \"includes.h\"\n\nvoid\nssh_OpenSSL_add_all_algorithms(void)\n{\n\tOpenSSL_add_all_algorithms();\n\n\t/* Enable use of crypto hardware */\n\tENGINE_load_builtin_engines();\n\tENGINE_register_all_complete();\n\n#if OPENSSL_VERSION_NUMBER < 0x10100000L\n\tOPENSSL_config(NULL);\n#else\n\tOPENSSL_init_crypto(OPENSSL_INIT_ADD_ALL_CIPHERS |\n\t    OPENSSL_INIT_ADD_ALL_DIGESTS | OPENSSL_INIT_LOAD_CONFIG, NULL);\n#endif\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"../test_helper/test_helper.h\"\n#include <openssl/evp.h>\n#include \"includes.h\"\n\nvoid sshkey_tests(void);\nvoid sshkey_file_tests(void);\nvoid sshkey_fuzz_tests(void);\n\nvoid\ntests(void)\n{\n\tOpenSSL_add_all_algorithms();\n\tERR_load_CRYPTO_strings();\n\n\tsshkey_tests();\n\tsshkey_file_tests();\n\tsshkey_fuzz_tests();\n}"
  }
]