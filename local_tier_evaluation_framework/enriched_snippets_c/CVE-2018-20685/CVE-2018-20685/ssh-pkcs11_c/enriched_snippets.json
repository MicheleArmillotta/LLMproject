[
  {
    "function_name": "pkcs11_terminate",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "726-730",
    "snippet": "void\npkcs11_terminate(void)\n{\n\treturn;\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\npkcs11_terminate(void)\n{\n\treturn;\n}"
  },
  {
    "function_name": "pkcs11_init",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "720-724",
    "snippet": "int\npkcs11_init(int interactive)\n{\n\treturn (0);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\npkcs11_init(int interactive)\n{\n\treturn (0);\n}"
  },
  {
    "function_name": "pkcs11_add_provider",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "592-716",
    "snippet": "int\npkcs11_add_provider(char *provider_id, char *pin, struct sshkey ***keyp)\n{\n\tint nkeys, need_finalize = 0;\n\tstruct pkcs11_provider *p = NULL;\n\tvoid *handle = NULL;\n\tCK_RV (*getfunctionlist)(CK_FUNCTION_LIST **);\n\tCK_RV rv;\n\tCK_FUNCTION_LIST *f = NULL;\n\tCK_TOKEN_INFO *token;\n\tCK_ULONG i;\n\n\t*keyp = NULL;\n\tif (pkcs11_provider_lookup(provider_id) != NULL) {\n\t\tdebug(\"%s: provider already registered: %s\",\n\t\t    __func__, provider_id);\n\t\tgoto fail;\n\t}\n\t/* open shared pkcs11-libarary */\n\tif ((handle = dlopen(provider_id, RTLD_NOW)) == NULL) {\n\t\terror(\"dlopen %s failed: %s\", provider_id, dlerror());\n\t\tgoto fail;\n\t}\n\tif ((getfunctionlist = dlsym(handle, \"C_GetFunctionList\")) == NULL) {\n\t\terror(\"dlsym(C_GetFunctionList) failed: %s\", dlerror());\n\t\tgoto fail;\n\t}\n\tp = xcalloc(1, sizeof(*p));\n\tp->name = xstrdup(provider_id);\n\tp->handle = handle;\n\t/* setup the pkcs11 callbacks */\n\tif ((rv = (*getfunctionlist)(&f)) != CKR_OK) {\n\t\terror(\"C_GetFunctionList for provider %s failed: %lu\",\n\t\t    provider_id, rv);\n\t\tgoto fail;\n\t}\n\tp->function_list = f;\n\tif ((rv = f->C_Initialize(NULL)) != CKR_OK) {\n\t\terror(\"C_Initialize for provider %s failed: %lu\",\n\t\t    provider_id, rv);\n\t\tgoto fail;\n\t}\n\tneed_finalize = 1;\n\tif ((rv = f->C_GetInfo(&p->info)) != CKR_OK) {\n\t\terror(\"C_GetInfo for provider %s failed: %lu\",\n\t\t    provider_id, rv);\n\t\tgoto fail;\n\t}\n\trmspace(p->info.manufacturerID, sizeof(p->info.manufacturerID));\n\trmspace(p->info.libraryDescription, sizeof(p->info.libraryDescription));\n\tdebug(\"provider %s: manufacturerID <%s> cryptokiVersion %d.%d\"\n\t    \" libraryDescription <%s> libraryVersion %d.%d\",\n\t    provider_id,\n\t    p->info.manufacturerID,\n\t    p->info.cryptokiVersion.major,\n\t    p->info.cryptokiVersion.minor,\n\t    p->info.libraryDescription,\n\t    p->info.libraryVersion.major,\n\t    p->info.libraryVersion.minor);\n\tif ((rv = f->C_GetSlotList(CK_TRUE, NULL, &p->nslots)) != CKR_OK) {\n\t\terror(\"C_GetSlotList failed: %lu\", rv);\n\t\tgoto fail;\n\t}\n\tif (p->nslots == 0) {\n\t\tdebug(\"%s: provider %s returned no slots\", __func__,\n\t\t    provider_id);\n\t\tgoto fail;\n\t}\n\tp->slotlist = xcalloc(p->nslots, sizeof(CK_SLOT_ID));\n\tif ((rv = f->C_GetSlotList(CK_TRUE, p->slotlist, &p->nslots))\n\t    != CKR_OK) {\n\t\terror(\"C_GetSlotList for provider %s failed: %lu\",\n\t\t    provider_id, rv);\n\t\tgoto fail;\n\t}\n\tp->slotinfo = xcalloc(p->nslots, sizeof(struct pkcs11_slotinfo));\n\tp->valid = 1;\n\tnkeys = 0;\n\tfor (i = 0; i < p->nslots; i++) {\n\t\ttoken = &p->slotinfo[i].token;\n\t\tif ((rv = f->C_GetTokenInfo(p->slotlist[i], token))\n\t\t    != CKR_OK) {\n\t\t\terror(\"C_GetTokenInfo for provider %s slot %lu \"\n\t\t\t    \"failed: %lu\", provider_id, (unsigned long)i, rv);\n\t\t\tcontinue;\n\t\t}\n\t\tif ((token->flags & CKF_TOKEN_INITIALIZED) == 0) {\n\t\t\tdebug2(\"%s: ignoring uninitialised token in \"\n\t\t\t    \"provider %s slot %lu\", __func__,\n\t\t\t    provider_id, (unsigned long)i);\n\t\t\tcontinue;\n\t\t}\n\t\trmspace(token->label, sizeof(token->label));\n\t\trmspace(token->manufacturerID, sizeof(token->manufacturerID));\n\t\trmspace(token->model, sizeof(token->model));\n\t\trmspace(token->serialNumber, sizeof(token->serialNumber));\n\t\tdebug(\"provider %s slot %lu: label <%s> manufacturerID <%s> \"\n\t\t    \"model <%s> serial <%s> flags 0x%lx\",\n\t\t    provider_id, (unsigned long)i,\n\t\t    token->label, token->manufacturerID, token->model,\n\t\t    token->serialNumber, token->flags);\n\t\t/* open session, login with pin and retrieve public keys */\n\t\tif (pkcs11_open_session(p, i, pin) == 0)\n\t\t\tpkcs11_fetch_keys(p, i, keyp, &nkeys);\n\t}\n\tif (nkeys > 0) {\n\t\tTAILQ_INSERT_TAIL(&pkcs11_providers, p, next);\n\t\tp->refcount++;\t/* add to provider list */\n\t\treturn (nkeys);\n\t}\n\tdebug(\"%s: provider %s returned no keys\", __func__, provider_id);\n\t/* don't add the provider, since it does not have any keys */\nfail:\n\tif (need_finalize && (rv = f->C_Finalize(NULL)) != CKR_OK)\n\t\terror(\"C_Finalize for provider %s failed: %lu\",\n\t\t    provider_id, rv);\n\tif (p) {\n\t\tfree(p->slotlist);\n\t\tfree(p->slotinfo);\n\t\tfree(p);\n\t}\n\tif (handle)\n\t\tdlclose(handle);\n\treturn (-1);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "dlclose",
          "args": [
            "handle"
          ],
          "line": 714
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "p"
          ],
          "line": 711
        },
        "resolved": true,
        "details": {
          "function_name": "freeze",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/smult_curve25519_ref.c",
          "lines": "50-60",
          "snippet": "static void freeze(unsigned int a[32])\n{\n  unsigned int aorig[32];\n  unsigned int j;\n  unsigned int negative;\n\n  for (j = 0;j < 32;++j) aorig[j] = a[j];\n  add(a,a,minusp);\n  negative = -((a[31] >> 7) & 1);\n  for (j = 0;j < 32;++j) a[j] ^= negative & (aorig[j] ^ a[j]);\n}",
          "includes": [],
          "macros_used": [],
          "globals_used": [
            "static const unsigned int minusp[32] = {\n 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128\n} ;"
          ],
          "called_functions": [],
          "contextual_snippet": "static const unsigned int minusp[32] = {\n 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128\n} ;\n\nstatic void freeze(unsigned int a[32])\n{\n  unsigned int aorig[32];\n  unsigned int j;\n  unsigned int negative;\n\n  for (j = 0;j < 32;++j) aorig[j] = a[j];\n  add(a,a,minusp);\n  negative = -((a[31] >> 7) & 1);\n  for (j = 0;j < 32;++j) a[j] ^= negative & (aorig[j] ^ a[j]);\n}"
        }
      },
      {
        "call_info": {
          "callee": "error",
          "args": [
            "\"C_Finalize for provider %s failed: %lu\"",
            "provider_id",
            "rv"
          ],
          "line": 706
        },
        "resolved": true,
        "details": {
          "function_name": "error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "162-170",
          "snippet": "void\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "f->C_Finalize",
          "args": [
            "NULL"
          ],
          "line": 705
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "debug",
          "args": [
            "\"%s: provider %s returned no keys\"",
            "__func__",
            "provider_id"
          ],
          "line": 702
        },
        "resolved": true,
        "details": {
          "function_name": "debug3",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "242-250",
          "snippet": "void\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "TAILQ_INSERT_TAIL",
          "args": [
            "&pkcs11_providers",
            "p",
            "next"
          ],
          "line": 698
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pkcs11_fetch_keys",
          "args": [
            "p",
            "i",
            "keyp",
            "&nkeys"
          ],
          "line": 695
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_fetch_keys",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "410-441",
          "snippet": "static int\npkcs11_fetch_keys(struct pkcs11_provider *p, CK_ULONG slotidx,\n    struct sshkey ***keysp, int *nkeys)\n{\n\tCK_OBJECT_CLASS\tpubkey_class = CKO_PUBLIC_KEY;\n\tCK_OBJECT_CLASS\tcert_class = CKO_CERTIFICATE;\n\tCK_ATTRIBUTE\t\tpubkey_filter[] = {\n\t\t{ CKA_CLASS, NULL, sizeof(pubkey_class) }\n\t};\n\tCK_ATTRIBUTE\t\tcert_filter[] = {\n\t\t{ CKA_CLASS, NULL, sizeof(cert_class) }\n\t};\n\tCK_ATTRIBUTE\t\tpubkey_attribs[] = {\n\t\t{ CKA_ID, NULL, 0 },\n\t\t{ CKA_MODULUS, NULL, 0 },\n\t\t{ CKA_PUBLIC_EXPONENT, NULL, 0 }\n\t};\n\tCK_ATTRIBUTE\t\tcert_attribs[] = {\n\t\t{ CKA_ID, NULL, 0 },\n\t\t{ CKA_SUBJECT, NULL, 0 },\n\t\t{ CKA_VALUE, NULL, 0 }\n\t};\n\tpubkey_filter[0].pValue = &pubkey_class;\n\tcert_filter[0].pValue = &cert_class;\n\n\tif (pkcs11_fetch_keys_filter(p, slotidx, pubkey_filter, pubkey_attribs,\n\t    keysp, nkeys) < 0 ||\n\t    pkcs11_fetch_keys_filter(p, slotidx, cert_filter, cert_attribs,\n\t    keysp, nkeys) < 0)\n\t\treturn (-1);\n\treturn (0);\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_fetch_keys(struct pkcs11_provider *p, CK_ULONG slotidx,\n    struct sshkey ***keysp, int *nkeys)\n{\n\tCK_OBJECT_CLASS\tpubkey_class = CKO_PUBLIC_KEY;\n\tCK_OBJECT_CLASS\tcert_class = CKO_CERTIFICATE;\n\tCK_ATTRIBUTE\t\tpubkey_filter[] = {\n\t\t{ CKA_CLASS, NULL, sizeof(pubkey_class) }\n\t};\n\tCK_ATTRIBUTE\t\tcert_filter[] = {\n\t\t{ CKA_CLASS, NULL, sizeof(cert_class) }\n\t};\n\tCK_ATTRIBUTE\t\tpubkey_attribs[] = {\n\t\t{ CKA_ID, NULL, 0 },\n\t\t{ CKA_MODULUS, NULL, 0 },\n\t\t{ CKA_PUBLIC_EXPONENT, NULL, 0 }\n\t};\n\tCK_ATTRIBUTE\t\tcert_attribs[] = {\n\t\t{ CKA_ID, NULL, 0 },\n\t\t{ CKA_SUBJECT, NULL, 0 },\n\t\t{ CKA_VALUE, NULL, 0 }\n\t};\n\tpubkey_filter[0].pValue = &pubkey_class;\n\tcert_filter[0].pValue = &cert_class;\n\n\tif (pkcs11_fetch_keys_filter(p, slotidx, pubkey_filter, pubkey_attribs,\n\t    keysp, nkeys) < 0 ||\n\t    pkcs11_fetch_keys_filter(p, slotidx, cert_filter, cert_attribs,\n\t    keysp, nkeys) < 0)\n\t\treturn (-1);\n\treturn (0);\n}"
        }
      },
      {
        "call_info": {
          "callee": "pkcs11_open_session",
          "args": [
            "p",
            "i",
            "pin"
          ],
          "line": 694
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_open_session",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "366-399",
          "snippet": "static int\npkcs11_open_session(struct pkcs11_provider *p, CK_ULONG slotidx, char *pin)\n{\n\tCK_RV\t\t\trv;\n\tCK_FUNCTION_LIST\t*f;\n\tCK_SESSION_HANDLE\tsession;\n\tint\t\t\tlogin_required;\n\n\tf = p->function_list;\n\tlogin_required = p->slotinfo[slotidx].token.flags & CKF_LOGIN_REQUIRED;\n\tif (pin && login_required && !strlen(pin)) {\n\t\terror(\"pin required\");\n\t\treturn (-1);\n\t}\n\tif ((rv = f->C_OpenSession(p->slotlist[slotidx], CKF_RW_SESSION|\n\t    CKF_SERIAL_SESSION, NULL, NULL, &session))\n\t    != CKR_OK) {\n\t\terror(\"C_OpenSession failed: %lu\", rv);\n\t\treturn (-1);\n\t}\n\tif (login_required && pin) {\n\t\trv = f->C_Login(session, CKU_USER,\n\t\t    (u_char *)pin, strlen(pin));\n\t\tif (rv != CKR_OK && rv != CKR_USER_ALREADY_LOGGED_IN) {\n\t\t\terror(\"C_Login failed: %lu\", rv);\n\t\t\tif ((rv = f->C_CloseSession(session)) != CKR_OK)\n\t\t\t\terror(\"C_CloseSession failed: %lu\", rv);\n\t\t\treturn (-1);\n\t\t}\n\t\tp->slotinfo[slotidx].logged_in = 1;\n\t}\n\tp->slotinfo[slotidx].session = session;\n\treturn (0);\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_open_session(struct pkcs11_provider *p, CK_ULONG slotidx, char *pin)\n{\n\tCK_RV\t\t\trv;\n\tCK_FUNCTION_LIST\t*f;\n\tCK_SESSION_HANDLE\tsession;\n\tint\t\t\tlogin_required;\n\n\tf = p->function_list;\n\tlogin_required = p->slotinfo[slotidx].token.flags & CKF_LOGIN_REQUIRED;\n\tif (pin && login_required && !strlen(pin)) {\n\t\terror(\"pin required\");\n\t\treturn (-1);\n\t}\n\tif ((rv = f->C_OpenSession(p->slotlist[slotidx], CKF_RW_SESSION|\n\t    CKF_SERIAL_SESSION, NULL, NULL, &session))\n\t    != CKR_OK) {\n\t\terror(\"C_OpenSession failed: %lu\", rv);\n\t\treturn (-1);\n\t}\n\tif (login_required && pin) {\n\t\trv = f->C_Login(session, CKU_USER,\n\t\t    (u_char *)pin, strlen(pin));\n\t\tif (rv != CKR_OK && rv != CKR_USER_ALREADY_LOGGED_IN) {\n\t\t\terror(\"C_Login failed: %lu\", rv);\n\t\t\tif ((rv = f->C_CloseSession(session)) != CKR_OK)\n\t\t\t\terror(\"C_CloseSession failed: %lu\", rv);\n\t\t\treturn (-1);\n\t\t}\n\t\tp->slotinfo[slotidx].logged_in = 1;\n\t}\n\tp->slotinfo[slotidx].session = session;\n\treturn (0);\n}"
        }
      },
      {
        "call_info": {
          "callee": "rmspace",
          "args": [
            "token->serialNumber",
            "sizeof(token->serialNumber)"
          ],
          "line": 687
        },
        "resolved": true,
        "details": {
          "function_name": "rmspace",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "348-360",
          "snippet": "static void\nrmspace(u_char *buf, size_t len)\n{\n\tsize_t i;\n\n\tif (!len)\n\t\treturn;\n\tfor (i = len - 1;  i > 0; i--)\n\t\tif (i == len - 1 || buf[i] == ' ')\n\t\t\tbuf[i] = '\\0';\n\t\telse\n\t\t\tbreak;\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\nrmspace(u_char *buf, size_t len)\n{\n\tsize_t i;\n\n\tif (!len)\n\t\treturn;\n\tfor (i = len - 1;  i > 0; i--)\n\t\tif (i == len - 1 || buf[i] == ' ')\n\t\t\tbuf[i] = '\\0';\n\t\telse\n\t\t\tbreak;\n}"
        }
      },
      {
        "call_info": {
          "callee": "debug2",
          "args": [
            "\"%s: ignoring uninitialised token in \"\n\t\t\t    \"provider %s slot %lu\"",
            "__func__",
            "provider_id",
            "(unsigned long)i"
          ],
          "line": 679
        },
        "resolved": true,
        "details": {
          "function_name": "debug2",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "232-240",
          "snippet": "void\ndebug2(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG2, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\ndebug2(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG2, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "f->C_GetTokenInfo",
          "args": [
            "p->slotlist[i]",
            "token"
          ],
          "line": 672
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "xcalloc",
          "args": [
            "p->nslots",
            "sizeof(struct pkcs11_slotinfo)"
          ],
          "line": 667
        },
        "resolved": true,
        "details": {
          "function_name": "xcalloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/xmalloc.c",
          "lines": "52-66",
          "snippet": "void *\nxcalloc(size_t nmemb, size_t size)\n{\n\tvoid *ptr;\n\n\tif (size == 0 || nmemb == 0)\n\t\tfatal(\"xcalloc: zero size\");\n\tif (SIZE_MAX / nmemb < size)\n\t\tfatal(\"xcalloc: nmemb * size > SIZE_MAX\");\n\tptr = calloc(nmemb, size);\n\tif (ptr == NULL)\n\t\tfatal(\"xcalloc: out of memory (allocating %zu bytes)\",\n\t\t    size * nmemb);\n\treturn ptr;\n}",
          "includes": [
            "#include \"log.h\"",
            "#include \"xmalloc.h\"",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdint.h>",
            "#include <stdarg.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n#include \"xmalloc.h\"\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdint.h>\n#include <stdarg.h>\n#include \"includes.h\"\n\nvoid *\nxcalloc(size_t nmemb, size_t size)\n{\n\tvoid *ptr;\n\n\tif (size == 0 || nmemb == 0)\n\t\tfatal(\"xcalloc: zero size\");\n\tif (SIZE_MAX / nmemb < size)\n\t\tfatal(\"xcalloc: nmemb * size > SIZE_MAX\");\n\tptr = calloc(nmemb, size);\n\tif (ptr == NULL)\n\t\tfatal(\"xcalloc: out of memory (allocating %zu bytes)\",\n\t\t    size * nmemb);\n\treturn ptr;\n}"
        }
      },
      {
        "call_info": {
          "callee": "f->C_GetSlotList",
          "args": [
            "CK_TRUE",
            "p->slotlist",
            "&p->nslots"
          ],
          "line": 661
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_GetSlotList",
          "args": [
            "CK_TRUE",
            "NULL",
            "&p->nslots"
          ],
          "line": 651
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_GetInfo",
          "args": [
            "&p->info"
          ],
          "line": 635
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_Initialize",
          "args": [
            "NULL"
          ],
          "line": 629
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "",
          "args": [
            "&f"
          ],
          "line": 623
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "xstrdup",
          "args": [
            "provider_id"
          ],
          "line": 620
        },
        "resolved": true,
        "details": {
          "function_name": "xstrdup",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/xmalloc.c",
          "lines": "92-102",
          "snippet": "char *\nxstrdup(const char *str)\n{\n\tsize_t len;\n\tchar *cp;\n\n\tlen = strlen(str) + 1;\n\tcp = xmalloc(len);\n\tstrlcpy(cp, str, len);\n\treturn cp;\n}",
          "includes": [
            "#include \"log.h\"",
            "#include \"xmalloc.h\"",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdint.h>",
            "#include <stdarg.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n#include \"xmalloc.h\"\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdint.h>\n#include <stdarg.h>\n#include \"includes.h\"\n\nchar *\nxstrdup(const char *str)\n{\n\tsize_t len;\n\tchar *cp;\n\n\tlen = strlen(str) + 1;\n\tcp = xmalloc(len);\n\tstrlcpy(cp, str, len);\n\treturn cp;\n}"
        }
      },
      {
        "call_info": {
          "callee": "dlerror",
          "args": [],
          "line": 616
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dlsym",
          "args": [
            "handle",
            "\"C_GetFunctionList\""
          ],
          "line": 615
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dlerror",
          "args": [],
          "line": 612
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "dlopen",
          "args": [
            "provider_id",
            "RTLD_NOW"
          ],
          "line": 611
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pkcs11_provider_lookup",
          "args": [
            "provider_id"
          ],
          "line": 605
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_provider_lookup",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "146-157",
          "snippet": "static struct pkcs11_provider *\npkcs11_provider_lookup(char *provider_id)\n{\n\tstruct pkcs11_provider *p;\n\n\tTAILQ_FOREACH(p, &pkcs11_providers, next) {\n\t\tdebug(\"check %p %s\", p, p->name);\n\t\tif (!strcmp(provider_id, p->name))\n\t\t\treturn (p);\n\t}\n\treturn (NULL);\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic struct pkcs11_provider *\npkcs11_provider_lookup(char *provider_id)\n{\n\tstruct pkcs11_provider *p;\n\n\tTAILQ_FOREACH(p, &pkcs11_providers, next) {\n\t\tdebug(\"check %p %s\", p, p->name);\n\t\tif (!strcmp(provider_id, p->name))\n\t\t\treturn (p);\n\t}\n\treturn (NULL);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\npkcs11_add_provider(char *provider_id, char *pin, struct sshkey ***keyp)\n{\n\tint nkeys, need_finalize = 0;\n\tstruct pkcs11_provider *p = NULL;\n\tvoid *handle = NULL;\n\tCK_RV (*getfunctionlist)(CK_FUNCTION_LIST **);\n\tCK_RV rv;\n\tCK_FUNCTION_LIST *f = NULL;\n\tCK_TOKEN_INFO *token;\n\tCK_ULONG i;\n\n\t*keyp = NULL;\n\tif (pkcs11_provider_lookup(provider_id) != NULL) {\n\t\tdebug(\"%s: provider already registered: %s\",\n\t\t    __func__, provider_id);\n\t\tgoto fail;\n\t}\n\t/* open shared pkcs11-libarary */\n\tif ((handle = dlopen(provider_id, RTLD_NOW)) == NULL) {\n\t\terror(\"dlopen %s failed: %s\", provider_id, dlerror());\n\t\tgoto fail;\n\t}\n\tif ((getfunctionlist = dlsym(handle, \"C_GetFunctionList\")) == NULL) {\n\t\terror(\"dlsym(C_GetFunctionList) failed: %s\", dlerror());\n\t\tgoto fail;\n\t}\n\tp = xcalloc(1, sizeof(*p));\n\tp->name = xstrdup(provider_id);\n\tp->handle = handle;\n\t/* setup the pkcs11 callbacks */\n\tif ((rv = (*getfunctionlist)(&f)) != CKR_OK) {\n\t\terror(\"C_GetFunctionList for provider %s failed: %lu\",\n\t\t    provider_id, rv);\n\t\tgoto fail;\n\t}\n\tp->function_list = f;\n\tif ((rv = f->C_Initialize(NULL)) != CKR_OK) {\n\t\terror(\"C_Initialize for provider %s failed: %lu\",\n\t\t    provider_id, rv);\n\t\tgoto fail;\n\t}\n\tneed_finalize = 1;\n\tif ((rv = f->C_GetInfo(&p->info)) != CKR_OK) {\n\t\terror(\"C_GetInfo for provider %s failed: %lu\",\n\t\t    provider_id, rv);\n\t\tgoto fail;\n\t}\n\trmspace(p->info.manufacturerID, sizeof(p->info.manufacturerID));\n\trmspace(p->info.libraryDescription, sizeof(p->info.libraryDescription));\n\tdebug(\"provider %s: manufacturerID <%s> cryptokiVersion %d.%d\"\n\t    \" libraryDescription <%s> libraryVersion %d.%d\",\n\t    provider_id,\n\t    p->info.manufacturerID,\n\t    p->info.cryptokiVersion.major,\n\t    p->info.cryptokiVersion.minor,\n\t    p->info.libraryDescription,\n\t    p->info.libraryVersion.major,\n\t    p->info.libraryVersion.minor);\n\tif ((rv = f->C_GetSlotList(CK_TRUE, NULL, &p->nslots)) != CKR_OK) {\n\t\terror(\"C_GetSlotList failed: %lu\", rv);\n\t\tgoto fail;\n\t}\n\tif (p->nslots == 0) {\n\t\tdebug(\"%s: provider %s returned no slots\", __func__,\n\t\t    provider_id);\n\t\tgoto fail;\n\t}\n\tp->slotlist = xcalloc(p->nslots, sizeof(CK_SLOT_ID));\n\tif ((rv = f->C_GetSlotList(CK_TRUE, p->slotlist, &p->nslots))\n\t    != CKR_OK) {\n\t\terror(\"C_GetSlotList for provider %s failed: %lu\",\n\t\t    provider_id, rv);\n\t\tgoto fail;\n\t}\n\tp->slotinfo = xcalloc(p->nslots, sizeof(struct pkcs11_slotinfo));\n\tp->valid = 1;\n\tnkeys = 0;\n\tfor (i = 0; i < p->nslots; i++) {\n\t\ttoken = &p->slotinfo[i].token;\n\t\tif ((rv = f->C_GetTokenInfo(p->slotlist[i], token))\n\t\t    != CKR_OK) {\n\t\t\terror(\"C_GetTokenInfo for provider %s slot %lu \"\n\t\t\t    \"failed: %lu\", provider_id, (unsigned long)i, rv);\n\t\t\tcontinue;\n\t\t}\n\t\tif ((token->flags & CKF_TOKEN_INITIALIZED) == 0) {\n\t\t\tdebug2(\"%s: ignoring uninitialised token in \"\n\t\t\t    \"provider %s slot %lu\", __func__,\n\t\t\t    provider_id, (unsigned long)i);\n\t\t\tcontinue;\n\t\t}\n\t\trmspace(token->label, sizeof(token->label));\n\t\trmspace(token->manufacturerID, sizeof(token->manufacturerID));\n\t\trmspace(token->model, sizeof(token->model));\n\t\trmspace(token->serialNumber, sizeof(token->serialNumber));\n\t\tdebug(\"provider %s slot %lu: label <%s> manufacturerID <%s> \"\n\t\t    \"model <%s> serial <%s> flags 0x%lx\",\n\t\t    provider_id, (unsigned long)i,\n\t\t    token->label, token->manufacturerID, token->model,\n\t\t    token->serialNumber, token->flags);\n\t\t/* open session, login with pin and retrieve public keys */\n\t\tif (pkcs11_open_session(p, i, pin) == 0)\n\t\t\tpkcs11_fetch_keys(p, i, keyp, &nkeys);\n\t}\n\tif (nkeys > 0) {\n\t\tTAILQ_INSERT_TAIL(&pkcs11_providers, p, next);\n\t\tp->refcount++;\t/* add to provider list */\n\t\treturn (nkeys);\n\t}\n\tdebug(\"%s: provider %s returned no keys\", __func__, provider_id);\n\t/* don't add the provider, since it does not have any keys */\nfail:\n\tif (need_finalize && (rv = f->C_Finalize(NULL)) != CKR_OK)\n\t\terror(\"C_Finalize for provider %s failed: %lu\",\n\t\t    provider_id, rv);\n\tif (p) {\n\t\tfree(p->slotlist);\n\t\tfree(p->slotinfo);\n\t\tfree(p);\n\t}\n\tif (handle)\n\t\tdlclose(handle);\n\treturn (-1);\n}"
  },
  {
    "function_name": "pkcs11_fetch_keys_filter",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "463-589",
    "snippet": "static int\npkcs11_fetch_keys_filter(struct pkcs11_provider *p, CK_ULONG slotidx,\n    CK_ATTRIBUTE filter[], CK_ATTRIBUTE attribs[3],\n    struct sshkey ***keysp, int *nkeys)\n{\n\tstruct sshkey\t\t*key;\n\tRSA\t\t\t*rsa;\n\tX509 \t\t\t*x509;\n\tEVP_PKEY\t\t*evp;\n\tint\t\t\ti;\n\tconst u_char\t\t*cp;\n\tCK_RV\t\t\trv;\n\tCK_OBJECT_HANDLE\tobj;\n\tCK_ULONG\t\tnfound;\n\tCK_SESSION_HANDLE\tsession;\n\tCK_FUNCTION_LIST\t*f;\n\n\tf = p->function_list;\n\tsession = p->slotinfo[slotidx].session;\n\t/* setup a filter the looks for public keys */\n\tif ((rv = f->C_FindObjectsInit(session, filter, 1)) != CKR_OK) {\n\t\terror(\"C_FindObjectsInit failed: %lu\", rv);\n\t\treturn (-1);\n\t}\n\twhile (1) {\n\t\t/* XXX 3 attributes in attribs[] */\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\tattribs[i].pValue = NULL;\n\t\t\tattribs[i].ulValueLen = 0;\n\t\t}\n\t\tif ((rv = f->C_FindObjects(session, &obj, 1, &nfound)) != CKR_OK\n\t\t    || nfound == 0)\n\t\t\tbreak;\n\t\t/* found a key, so figure out size of the attributes */\n\t\tif ((rv = f->C_GetAttributeValue(session, obj, attribs, 3))\n\t\t    != CKR_OK) {\n\t\t\terror(\"C_GetAttributeValue failed: %lu\", rv);\n\t\t\tcontinue;\n\t\t}\n\t\t/*\n\t\t * Allow CKA_ID (always first attribute) to be empty, but\n\t\t * ensure that none of the others are zero length.\n\t\t * XXX assumes CKA_ID is always first.\n\t\t */\n\t\tif (attribs[1].ulValueLen == 0 ||\n\t\t    attribs[2].ulValueLen == 0) {\n\t\t\tcontinue;\n\t\t}\n\t\t/* allocate buffers for attributes */\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\tif (attribs[i].ulValueLen > 0) {\n\t\t\t\tattribs[i].pValue = xmalloc(\n\t\t\t\t    attribs[i].ulValueLen);\n\t\t\t}\n\t\t}\n\n\t\t/*\n\t\t * retrieve ID, modulus and public exponent of RSA key,\n\t\t * or ID, subject and value for certificates.\n\t\t */\n\t\trsa = NULL;\n\t\tif ((rv = f->C_GetAttributeValue(session, obj, attribs, 3))\n\t\t    != CKR_OK) {\n\t\t\terror(\"C_GetAttributeValue failed: %lu\", rv);\n\t\t} else if (attribs[1].type == CKA_MODULUS ) {\n\t\t\tif ((rsa = RSA_new()) == NULL) {\n\t\t\t\terror(\"RSA_new failed\");\n\t\t\t} else {\n\t\t\t\tBIGNUM *rsa_n, *rsa_e;\n\n\t\t\t\trsa_n = BN_bin2bn(attribs[1].pValue,\n\t\t\t\t    attribs[1].ulValueLen, NULL);\n\t\t\t\trsa_e = BN_bin2bn(attribs[2].pValue,\n\t\t\t\t    attribs[2].ulValueLen, NULL);\n\t\t\t\tif (rsa_n != NULL && rsa_e != NULL) {\n\t\t\t\t\tif (!RSA_set0_key(rsa,\n\t\t\t\t\t    rsa_n, rsa_e, NULL))\n\t\t\t\t\t\tfatal(\"%s: set key\", __func__);\n\t\t\t\t\trsa_n = rsa_e = NULL; /* transferred */\n\t\t\t\t}\n\t\t\t\tBN_free(rsa_n);\n\t\t\t\tBN_free(rsa_e);\n\t\t\t}\n\t\t} else {\n\t\t\tcp = attribs[2].pValue;\n\t\t\tif ((x509 = X509_new()) == NULL) {\n\t\t\t\terror(\"X509_new failed\");\n\t\t\t} else if (d2i_X509(&x509, &cp, attribs[2].ulValueLen)\n\t\t\t    == NULL) {\n\t\t\t\terror(\"d2i_X509 failed\");\n\t\t\t} else if ((evp = X509_get_pubkey(x509)) == NULL ||\n\t\t\t    EVP_PKEY_base_id(evp) != EVP_PKEY_RSA ||\n\t\t\t    EVP_PKEY_get0_RSA(evp) == NULL) {\n\t\t\t\tdebug(\"X509_get_pubkey failed or no rsa\");\n\t\t\t} else if ((rsa = RSAPublicKey_dup(\n\t\t\t    EVP_PKEY_get0_RSA(evp))) == NULL) {\n\t\t\t\terror(\"RSAPublicKey_dup\");\n\t\t\t}\n\t\t\tX509_free(x509);\n\t\t}\n\t\tif (rsa && have_rsa_key(rsa) &&\n\t\t    pkcs11_rsa_wrap(p, slotidx, &attribs[0], rsa) == 0) {\n\t\t\tif ((key = sshkey_new(KEY_UNSPEC)) == NULL)\n\t\t\t\tfatal(\"sshkey_new failed\");\n\t\t\tkey->rsa = rsa;\n\t\t\tkey->type = KEY_RSA;\n\t\t\tkey->flags |= SSHKEY_FLAG_EXT;\n\t\t\tif (pkcs11_key_included(keysp, nkeys, key)) {\n\t\t\t\tsshkey_free(key);\n\t\t\t} else {\n\t\t\t\t/* expand key array and add key */\n\t\t\t\t*keysp = xrecallocarray(*keysp, *nkeys,\n\t\t\t\t    *nkeys + 1, sizeof(struct sshkey *));\n\t\t\t\t(*keysp)[*nkeys] = key;\n\t\t\t\t*nkeys = *nkeys + 1;\n\t\t\t\tdebug(\"have %d keys\", *nkeys);\n\t\t\t}\n\t\t} else if (rsa) {\n\t\t\tRSA_free(rsa);\n\t\t}\n\t\tfor (i = 0; i < 3; i++)\n\t\t\tfree(attribs[i].pValue);\n\t}\n\tif ((rv = f->C_FindObjectsFinal(session)) != CKR_OK)\n\t\terror(\"C_FindObjectsFinal failed: %lu\", rv);\n\treturn (0);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "error",
          "args": [
            "\"C_FindObjectsFinal failed: %lu\"",
            "rv"
          ],
          "line": 587
        },
        "resolved": true,
        "details": {
          "function_name": "error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "162-170",
          "snippet": "void\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "f->C_FindObjectsFinal",
          "args": [
            "session"
          ],
          "line": 586
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "attribs[i].pValue"
          ],
          "line": 584
        },
        "resolved": true,
        "details": {
          "function_name": "freeze",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/smult_curve25519_ref.c",
          "lines": "50-60",
          "snippet": "static void freeze(unsigned int a[32])\n{\n  unsigned int aorig[32];\n  unsigned int j;\n  unsigned int negative;\n\n  for (j = 0;j < 32;++j) aorig[j] = a[j];\n  add(a,a,minusp);\n  negative = -((a[31] >> 7) & 1);\n  for (j = 0;j < 32;++j) a[j] ^= negative & (aorig[j] ^ a[j]);\n}",
          "includes": [],
          "macros_used": [],
          "globals_used": [
            "static const unsigned int minusp[32] = {\n 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128\n} ;"
          ],
          "called_functions": [],
          "contextual_snippet": "static const unsigned int minusp[32] = {\n 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128\n} ;\n\nstatic void freeze(unsigned int a[32])\n{\n  unsigned int aorig[32];\n  unsigned int j;\n  unsigned int negative;\n\n  for (j = 0;j < 32;++j) aorig[j] = a[j];\n  add(a,a,minusp);\n  negative = -((a[31] >> 7) & 1);\n  for (j = 0;j < 32;++j) a[j] ^= negative & (aorig[j] ^ a[j]);\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_free",
          "args": [
            "rsa"
          ],
          "line": 581
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "debug",
          "args": [
            "\"have %d keys\"",
            "*nkeys"
          ],
          "line": 578
        },
        "resolved": true,
        "details": {
          "function_name": "debug3",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "242-250",
          "snippet": "void\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "xrecallocarray",
          "args": [
            "*keysp",
            "*nkeys",
            "*nkeys + 1",
            "sizeof(struct sshkey *)"
          ],
          "line": 574
        },
        "resolved": true,
        "details": {
          "function_name": "xrecallocarray",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/xmalloc.c",
          "lines": "80-90",
          "snippet": "void *\nxrecallocarray(void *ptr, size_t onmemb, size_t nmemb, size_t size)\n{\n\tvoid *new_ptr;\n\n\tnew_ptr = recallocarray(ptr, onmemb, nmemb, size);\n\tif (new_ptr == NULL)\n\t\tfatal(\"xrecallocarray: out of memory (%zu elements of %zu bytes)\",\n\t\t    nmemb, size);\n\treturn new_ptr;\n}",
          "includes": [
            "#include \"log.h\"",
            "#include \"xmalloc.h\"",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdint.h>",
            "#include <stdarg.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n#include \"xmalloc.h\"\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdint.h>\n#include <stdarg.h>\n#include \"includes.h\"\n\nvoid *\nxrecallocarray(void *ptr, size_t onmemb, size_t nmemb, size_t size)\n{\n\tvoid *new_ptr;\n\n\tnew_ptr = recallocarray(ptr, onmemb, nmemb, size);\n\tif (new_ptr == NULL)\n\t\tfatal(\"xrecallocarray: out of memory (%zu elements of %zu bytes)\",\n\t\t    nmemb, size);\n\treturn new_ptr;\n}"
        }
      },
      {
        "call_info": {
          "callee": "sshkey_free",
          "args": [
            "key"
          ],
          "line": 571
        },
        "resolved": true,
        "details": {
          "function_name": "sshkey_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/sshkey.c",
          "lines": "552-606",
          "snippet": "void\nsshkey_free(struct sshkey *k)\n{\n\tif (k == NULL)\n\t\treturn;\n\tswitch (k->type) {\n#ifdef WITH_OPENSSL\n\tcase KEY_RSA:\n\tcase KEY_RSA_CERT:\n\t\tRSA_free(k->rsa);\n\t\tk->rsa = NULL;\n\t\tbreak;\n\tcase KEY_DSA:\n\tcase KEY_DSA_CERT:\n\t\tDSA_free(k->dsa);\n\t\tk->dsa = NULL;\n\t\tbreak;\n# ifdef OPENSSL_HAS_ECC\n\tcase KEY_ECDSA:\n\tcase KEY_ECDSA_CERT:\n\t\tEC_KEY_free(k->ecdsa);\n\t\tk->ecdsa = NULL;\n\t\tbreak;\n# endif /* OPENSSL_HAS_ECC */\n#endif /* WITH_OPENSSL */\n\tcase KEY_ED25519:\n\tcase KEY_ED25519_CERT:\n\t\tfreezero(k->ed25519_pk, ED25519_PK_SZ);\n\t\tk->ed25519_pk = NULL;\n\t\tfreezero(k->ed25519_sk, ED25519_SK_SZ);\n\t\tk->ed25519_sk = NULL;\n\t\tbreak;\n#ifdef WITH_XMSS\n\tcase KEY_XMSS:\n\tcase KEY_XMSS_CERT:\n\t\tfreezero(k->xmss_pk, sshkey_xmss_pklen(k));\n\t\tk->xmss_pk = NULL;\n\t\tfreezero(k->xmss_sk, sshkey_xmss_sklen(k));\n\t\tk->xmss_sk = NULL;\n\t\tsshkey_xmss_free_state(k);\n\t\tfree(k->xmss_name);\n\t\tk->xmss_name = NULL;\n\t\tfree(k->xmss_filename);\n\t\tk->xmss_filename = NULL;\n\t\tbreak;\n#endif /* WITH_XMSS */\n\tcase KEY_UNSPEC:\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (sshkey_is_cert(k))\n\t\tcert_free(k->cert);\n\tfreezero(k, sizeof(*k));\n}",
          "includes": [
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"xmss_fast.h\"",
            "#include \"match.h\"",
            "#include \"sshkey-xmss.h\"",
            "#include \"sshkey.h\"",
            "#include \"digest.h\"",
            "#include \"cipher.h\"",
            "#include \"sshbuf.h\"",
            "#include \"misc.h\"",
            "#include \"ssherr.h\"",
            "#include \"ssh2.h\"",
            "#include <util.h>",
            "#include <resolv.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"crypto_api.h\"",
            "#include <openssl/pem.h>",
            "#include <openssl/err.h>",
            "#include <openssl/evp.h>",
            "#include <netinet/in.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"openbsd-compat/openssl-compat.h\"\n#include \"xmss_fast.h\"\n#include \"match.h\"\n#include \"sshkey-xmss.h\"\n#include \"sshkey.h\"\n#include \"digest.h\"\n#include \"cipher.h\"\n#include \"sshbuf.h\"\n#include \"misc.h\"\n#include \"ssherr.h\"\n#include \"ssh2.h\"\n#include <util.h>\n#include <resolv.h>\n#include <string.h>\n#include <stdio.h>\n#include <limits.h>\n#include <errno.h>\n#include \"crypto_api.h\"\n#include <openssl/pem.h>\n#include <openssl/err.h>\n#include <openssl/evp.h>\n#include <netinet/in.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nsshkey_free(struct sshkey *k)\n{\n\tif (k == NULL)\n\t\treturn;\n\tswitch (k->type) {\n#ifdef WITH_OPENSSL\n\tcase KEY_RSA:\n\tcase KEY_RSA_CERT:\n\t\tRSA_free(k->rsa);\n\t\tk->rsa = NULL;\n\t\tbreak;\n\tcase KEY_DSA:\n\tcase KEY_DSA_CERT:\n\t\tDSA_free(k->dsa);\n\t\tk->dsa = NULL;\n\t\tbreak;\n# ifdef OPENSSL_HAS_ECC\n\tcase KEY_ECDSA:\n\tcase KEY_ECDSA_CERT:\n\t\tEC_KEY_free(k->ecdsa);\n\t\tk->ecdsa = NULL;\n\t\tbreak;\n# endif /* OPENSSL_HAS_ECC */\n#endif /* WITH_OPENSSL */\n\tcase KEY_ED25519:\n\tcase KEY_ED25519_CERT:\n\t\tfreezero(k->ed25519_pk, ED25519_PK_SZ);\n\t\tk->ed25519_pk = NULL;\n\t\tfreezero(k->ed25519_sk, ED25519_SK_SZ);\n\t\tk->ed25519_sk = NULL;\n\t\tbreak;\n#ifdef WITH_XMSS\n\tcase KEY_XMSS:\n\tcase KEY_XMSS_CERT:\n\t\tfreezero(k->xmss_pk, sshkey_xmss_pklen(k));\n\t\tk->xmss_pk = NULL;\n\t\tfreezero(k->xmss_sk, sshkey_xmss_sklen(k));\n\t\tk->xmss_sk = NULL;\n\t\tsshkey_xmss_free_state(k);\n\t\tfree(k->xmss_name);\n\t\tk->xmss_name = NULL;\n\t\tfree(k->xmss_filename);\n\t\tk->xmss_filename = NULL;\n\t\tbreak;\n#endif /* WITH_XMSS */\n\tcase KEY_UNSPEC:\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (sshkey_is_cert(k))\n\t\tcert_free(k->cert);\n\tfreezero(k, sizeof(*k));\n}"
        }
      },
      {
        "call_info": {
          "callee": "pkcs11_key_included",
          "args": [
            "keysp",
            "nkeys",
            "key"
          ],
          "line": 570
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_key_included",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "443-452",
          "snippet": "static int\npkcs11_key_included(struct sshkey ***keysp, int *nkeys, struct sshkey *key)\n{\n\tint i;\n\n\tfor (i = 0; i < *nkeys; i++)\n\t\tif (sshkey_equal(key, (*keysp)[i]))\n\t\t\treturn (1);\n\treturn (0);\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_key_included(struct sshkey ***keysp, int *nkeys, struct sshkey *key)\n{\n\tint i;\n\n\tfor (i = 0; i < *nkeys; i++)\n\t\tif (sshkey_equal(key, (*keysp)[i]))\n\t\t\treturn (1);\n\treturn (0);\n}"
        }
      },
      {
        "call_info": {
          "callee": "fatal",
          "args": [
            "\"sshkey_new failed\""
          ],
          "line": 566
        },
        "resolved": true,
        "details": {
          "function_name": "fatal",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/fatal.c",
          "lines": "36-45",
          "snippet": "void\nfatal(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_FATAL, fmt, args);\n\tva_end(args);\n\tcleanup_exit(255);\n}",
          "includes": [
            "#include \"log.h\"",
            "#include <stdarg.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n#include <stdarg.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nfatal(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_FATAL, fmt, args);\n\tva_end(args);\n\tcleanup_exit(255);\n}"
        }
      },
      {
        "call_info": {
          "callee": "sshkey_new",
          "args": [
            "KEY_UNSPEC"
          ],
          "line": 565
        },
        "resolved": true,
        "details": {
          "function_name": "sshkey_new",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/sshkey.c",
          "lines": "485-550",
          "snippet": "struct sshkey *\nsshkey_new(int type)\n{\n\tstruct sshkey *k;\n#ifdef WITH_OPENSSL\n\tRSA *rsa;\n\tDSA *dsa;\n#endif /* WITH_OPENSSL */\n\n\tif ((k = calloc(1, sizeof(*k))) == NULL)\n\t\treturn NULL;\n\tk->type = type;\n\tk->ecdsa = NULL;\n\tk->ecdsa_nid = -1;\n\tk->dsa = NULL;\n\tk->rsa = NULL;\n\tk->cert = NULL;\n\tk->ed25519_sk = NULL;\n\tk->ed25519_pk = NULL;\n\tk->xmss_sk = NULL;\n\tk->xmss_pk = NULL;\n\tswitch (k->type) {\n#ifdef WITH_OPENSSL\n\tcase KEY_RSA:\n\tcase KEY_RSA_CERT:\n\t\tif ((rsa = RSA_new()) == NULL) {\n\t\t\tfree(k);\n\t\t\treturn NULL;\n\t\t}\n\t\tk->rsa = rsa;\n\t\tbreak;\n\tcase KEY_DSA:\n\tcase KEY_DSA_CERT:\n\t\tif ((dsa = DSA_new()) == NULL) {\n\t\t\tfree(k);\n\t\t\treturn NULL;\n\t\t}\n\t\tk->dsa = dsa;\n\t\tbreak;\n\tcase KEY_ECDSA:\n\tcase KEY_ECDSA_CERT:\n\t\t/* Cannot do anything until we know the group */\n\t\tbreak;\n#endif /* WITH_OPENSSL */\n\tcase KEY_ED25519:\n\tcase KEY_ED25519_CERT:\n\tcase KEY_XMSS:\n\tcase KEY_XMSS_CERT:\n\t\t/* no need to prealloc */\n\t\tbreak;\n\tcase KEY_UNSPEC:\n\t\tbreak;\n\tdefault:\n\t\tfree(k);\n\t\treturn NULL;\n\t}\n\n\tif (sshkey_is_cert(k)) {\n\t\tif ((k->cert = cert_new()) == NULL) {\n\t\t\tsshkey_free(k);\n\t\t\treturn NULL;\n\t\t}\n\t}\n\n\treturn k;\n}",
          "includes": [
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"xmss_fast.h\"",
            "#include \"match.h\"",
            "#include \"sshkey-xmss.h\"",
            "#include \"sshkey.h\"",
            "#include \"digest.h\"",
            "#include \"cipher.h\"",
            "#include \"sshbuf.h\"",
            "#include \"misc.h\"",
            "#include \"ssherr.h\"",
            "#include \"ssh2.h\"",
            "#include <util.h>",
            "#include <resolv.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"crypto_api.h\"",
            "#include <openssl/pem.h>",
            "#include <openssl/err.h>",
            "#include <openssl/evp.h>",
            "#include <netinet/in.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"openbsd-compat/openssl-compat.h\"\n#include \"xmss_fast.h\"\n#include \"match.h\"\n#include \"sshkey-xmss.h\"\n#include \"sshkey.h\"\n#include \"digest.h\"\n#include \"cipher.h\"\n#include \"sshbuf.h\"\n#include \"misc.h\"\n#include \"ssherr.h\"\n#include \"ssh2.h\"\n#include <util.h>\n#include <resolv.h>\n#include <string.h>\n#include <stdio.h>\n#include <limits.h>\n#include <errno.h>\n#include \"crypto_api.h\"\n#include <openssl/pem.h>\n#include <openssl/err.h>\n#include <openssl/evp.h>\n#include <netinet/in.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstruct sshkey *\nsshkey_new(int type)\n{\n\tstruct sshkey *k;\n#ifdef WITH_OPENSSL\n\tRSA *rsa;\n\tDSA *dsa;\n#endif /* WITH_OPENSSL */\n\n\tif ((k = calloc(1, sizeof(*k))) == NULL)\n\t\treturn NULL;\n\tk->type = type;\n\tk->ecdsa = NULL;\n\tk->ecdsa_nid = -1;\n\tk->dsa = NULL;\n\tk->rsa = NULL;\n\tk->cert = NULL;\n\tk->ed25519_sk = NULL;\n\tk->ed25519_pk = NULL;\n\tk->xmss_sk = NULL;\n\tk->xmss_pk = NULL;\n\tswitch (k->type) {\n#ifdef WITH_OPENSSL\n\tcase KEY_RSA:\n\tcase KEY_RSA_CERT:\n\t\tif ((rsa = RSA_new()) == NULL) {\n\t\t\tfree(k);\n\t\t\treturn NULL;\n\t\t}\n\t\tk->rsa = rsa;\n\t\tbreak;\n\tcase KEY_DSA:\n\tcase KEY_DSA_CERT:\n\t\tif ((dsa = DSA_new()) == NULL) {\n\t\t\tfree(k);\n\t\t\treturn NULL;\n\t\t}\n\t\tk->dsa = dsa;\n\t\tbreak;\n\tcase KEY_ECDSA:\n\tcase KEY_ECDSA_CERT:\n\t\t/* Cannot do anything until we know the group */\n\t\tbreak;\n#endif /* WITH_OPENSSL */\n\tcase KEY_ED25519:\n\tcase KEY_ED25519_CERT:\n\tcase KEY_XMSS:\n\tcase KEY_XMSS_CERT:\n\t\t/* no need to prealloc */\n\t\tbreak;\n\tcase KEY_UNSPEC:\n\t\tbreak;\n\tdefault:\n\t\tfree(k);\n\t\treturn NULL;\n\t}\n\n\tif (sshkey_is_cert(k)) {\n\t\tif ((k->cert = cert_new()) == NULL) {\n\t\t\tsshkey_free(k);\n\t\t\treturn NULL;\n\t\t}\n\t}\n\n\treturn k;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pkcs11_rsa_wrap",
          "args": [
            "p",
            "slotidx",
            "&attribs[0]",
            "rsa"
          ],
          "line": 564
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_rsa_wrap",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "314-345",
          "snippet": "static int\npkcs11_rsa_wrap(struct pkcs11_provider *provider, CK_ULONG slotidx,\n    CK_ATTRIBUTE *keyid_attrib, RSA *rsa)\n{\n\tstruct pkcs11_key\t*k11;\n\tconst RSA_METHOD\t*def = RSA_get_default_method();\n\n\tk11 = xcalloc(1, sizeof(*k11));\n\tk11->provider = provider;\n\tprovider->refcount++;\t/* provider referenced by RSA key */\n\tk11->slotidx = slotidx;\n\t/* identify key object on smartcard */\n\tk11->keyid_len = keyid_attrib->ulValueLen;\n\tif (k11->keyid_len > 0) {\n\t\tk11->keyid = xmalloc(k11->keyid_len);\n\t\tmemcpy(k11->keyid, keyid_attrib->pValue, k11->keyid_len);\n\t}\n\tk11->rsa_method = RSA_meth_dup(def);\n\tif (k11->rsa_method == NULL)\n\t\tfatal(\"%s: RSA_meth_dup failed\", __func__);\n\tk11->orig_finish = RSA_meth_get_finish(def);\n\tif (!RSA_meth_set1_name(k11->rsa_method, \"pkcs11\") ||\n\t    !RSA_meth_set_priv_enc(k11->rsa_method,\n\t    pkcs11_rsa_private_encrypt) ||\n\t    !RSA_meth_set_priv_dec(k11->rsa_method,\n\t    pkcs11_rsa_private_decrypt) ||\n\t    !RSA_meth_set_finish(k11->rsa_method, pkcs11_rsa_finish))\n\t\tfatal(\"%s: setup pkcs11 method failed\", __func__);\n\tRSA_set_method(rsa, k11->rsa_method);\n\tRSA_set_app_data(rsa, k11);\n\treturn (0);\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_rsa_wrap(struct pkcs11_provider *provider, CK_ULONG slotidx,\n    CK_ATTRIBUTE *keyid_attrib, RSA *rsa)\n{\n\tstruct pkcs11_key\t*k11;\n\tconst RSA_METHOD\t*def = RSA_get_default_method();\n\n\tk11 = xcalloc(1, sizeof(*k11));\n\tk11->provider = provider;\n\tprovider->refcount++;\t/* provider referenced by RSA key */\n\tk11->slotidx = slotidx;\n\t/* identify key object on smartcard */\n\tk11->keyid_len = keyid_attrib->ulValueLen;\n\tif (k11->keyid_len > 0) {\n\t\tk11->keyid = xmalloc(k11->keyid_len);\n\t\tmemcpy(k11->keyid, keyid_attrib->pValue, k11->keyid_len);\n\t}\n\tk11->rsa_method = RSA_meth_dup(def);\n\tif (k11->rsa_method == NULL)\n\t\tfatal(\"%s: RSA_meth_dup failed\", __func__);\n\tk11->orig_finish = RSA_meth_get_finish(def);\n\tif (!RSA_meth_set1_name(k11->rsa_method, \"pkcs11\") ||\n\t    !RSA_meth_set_priv_enc(k11->rsa_method,\n\t    pkcs11_rsa_private_encrypt) ||\n\t    !RSA_meth_set_priv_dec(k11->rsa_method,\n\t    pkcs11_rsa_private_decrypt) ||\n\t    !RSA_meth_set_finish(k11->rsa_method, pkcs11_rsa_finish))\n\t\tfatal(\"%s: setup pkcs11 method failed\", __func__);\n\tRSA_set_method(rsa, k11->rsa_method);\n\tRSA_set_app_data(rsa, k11);\n\treturn (0);\n}"
        }
      },
      {
        "call_info": {
          "callee": "have_rsa_key",
          "args": [
            "rsa"
          ],
          "line": 563
        },
        "resolved": true,
        "details": {
          "function_name": "have_rsa_key",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "454-461",
          "snippet": "static int\nhave_rsa_key(const RSA *rsa)\n{\n\tconst BIGNUM *rsa_n, *rsa_e;\n\n\tRSA_get0_key(rsa, &rsa_n, &rsa_e, NULL);\n\treturn rsa_n != NULL && rsa_e != NULL;\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\nhave_rsa_key(const RSA *rsa)\n{\n\tconst BIGNUM *rsa_n, *rsa_e;\n\n\tRSA_get0_key(rsa, &rsa_n, &rsa_e, NULL);\n\treturn rsa_n != NULL && rsa_e != NULL;\n}"
        }
      },
      {
        "call_info": {
          "callee": "X509_free",
          "args": [
            "x509"
          ],
          "line": 561
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "RSAPublicKey_dup",
          "args": [
            "EVP_PKEY_get0_RSA(evp)"
          ],
          "line": 557
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "EVP_PKEY_get0_RSA",
          "args": [
            "evp"
          ],
          "line": 558
        },
        "resolved": true,
        "details": {
          "function_name": "EVP_PKEY_get0_RSA",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/libressl-api-compat.c",
          "lines": "608-616",
          "snippet": "RSA *\nEVP_PKEY_get0_RSA(EVP_PKEY *pkey)\n{\n\tif (pkey->type != EVP_PKEY_RSA) {\n\t\t/* EVPerror(EVP_R_EXPECTING_AN_RSA_KEY); */\n\t\treturn NULL;\n\t}\n\treturn pkey->pkey.rsa;\n}",
          "includes": [
            "#include <openssl/dh.h>",
            "#include <openssl/ecdsa.h>",
            "#include <openssl/evp.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/bn.h>",
            "#include <openssl/err.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/dh.h>\n#include <openssl/ecdsa.h>\n#include <openssl/evp.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/bn.h>\n#include <openssl/err.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nRSA *\nEVP_PKEY_get0_RSA(EVP_PKEY *pkey)\n{\n\tif (pkey->type != EVP_PKEY_RSA) {\n\t\t/* EVPerror(EVP_R_EXPECTING_AN_RSA_KEY); */\n\t\treturn NULL;\n\t}\n\treturn pkey->pkey.rsa;\n}"
        }
      },
      {
        "call_info": {
          "callee": "EVP_PKEY_base_id",
          "args": [
            "evp"
          ],
          "line": 554
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "X509_get_pubkey",
          "args": [
            "x509"
          ],
          "line": 553
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "d2i_X509",
          "args": [
            "&x509",
            "&cp",
            "attribs[2].ulValueLen"
          ],
          "line": 550
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "X509_new",
          "args": [],
          "line": 548
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "BN_free",
          "args": [
            "rsa_e"
          ],
          "line": 544
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "BN_free",
          "args": [
            "rsa_n"
          ],
          "line": 543
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fatal",
          "args": [
            "\"%s: set key\"",
            "__func__"
          ],
          "line": 540
        },
        "resolved": true,
        "details": {
          "function_name": "match_test_missing_fatal",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/servconf.c",
          "lines": "988-993",
          "snippet": "static void\nmatch_test_missing_fatal(const char *criteria, const char *attrib)\n{\n\tfatal(\"'Match %s' in configuration but '%s' not in connection \"\n\t    \"test specification.\", criteria, attrib);\n}",
          "includes": [
            "#include \"digest.h\"",
            "#include \"myproposal.h\"",
            "#include \"auth.h\"",
            "#include \"hostfile.h\"",
            "#include \"ssherr.h\"",
            "#include \"packet.h\"",
            "#include \"canohost.h\"",
            "#include \"groupaccess.h\"",
            "#include \"channels.h\"",
            "#include \"match.h\"",
            "#include \"mac.h\"",
            "#include \"kex.h\"",
            "#include \"sshkey.h\"",
            "#include \"cipher.h\"",
            "#include \"pathnames.h\"",
            "#include \"compat.h\"",
            "#include \"servconf.h\"",
            "#include \"misc.h\"",
            "#include \"sshbuf.h\"",
            "#include \"log.h\"",
            "#include \"ssh.h\"",
            "#include \"xmalloc.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <util.h>",
            "#include <errno.h>",
            "#include <stdarg.h>",
            "#include <limits.h>",
            "#include <unistd.h>",
            "#include <signal.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <netdb.h>",
            "#include <ctype.h>",
            "#include <net/route.h>",
            "#include <netinet/ip.h>",
            "#include <netinet/in_systm.h>",
            "#include <netinet/in.h>",
            "#include <sys/sysctl.h>",
            "#include <sys/socket.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"digest.h\"\n#include \"myproposal.h\"\n#include \"auth.h\"\n#include \"hostfile.h\"\n#include \"ssherr.h\"\n#include \"packet.h\"\n#include \"canohost.h\"\n#include \"groupaccess.h\"\n#include \"channels.h\"\n#include \"match.h\"\n#include \"mac.h\"\n#include \"kex.h\"\n#include \"sshkey.h\"\n#include \"cipher.h\"\n#include \"pathnames.h\"\n#include \"compat.h\"\n#include \"servconf.h\"\n#include \"misc.h\"\n#include \"sshbuf.h\"\n#include \"log.h\"\n#include \"ssh.h\"\n#include \"xmalloc.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <util.h>\n#include <errno.h>\n#include <stdarg.h>\n#include <limits.h>\n#include <unistd.h>\n#include <signal.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <netdb.h>\n#include <ctype.h>\n#include <net/route.h>\n#include <netinet/ip.h>\n#include <netinet/in_systm.h>\n#include <netinet/in.h>\n#include <sys/sysctl.h>\n#include <sys/socket.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\nmatch_test_missing_fatal(const char *criteria, const char *attrib)\n{\n\tfatal(\"'Match %s' in configuration but '%s' not in connection \"\n\t    \"test specification.\", criteria, attrib);\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_set0_key",
          "args": [
            "rsa",
            "rsa_n",
            "rsa_e",
            "NULL"
          ],
          "line": 538
        },
        "resolved": true,
        "details": {
          "function_name": "RSA_set0_key",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/libressl-api-compat.c",
          "lines": "243-263",
          "snippet": "int\nRSA_set0_key(RSA *r, BIGNUM *n, BIGNUM *e, BIGNUM *d)\n{\n\tif ((r->n == NULL && n == NULL) || (r->e == NULL && e == NULL))\n\t\treturn 0;\n\n\tif (n != NULL) {\n\t\tBN_free(r->n);\n\t\tr->n = n;\n\t}\n\tif (e != NULL) {\n\t\tBN_free(r->e);\n\t\tr->e = e;\n\t}\n\tif (d != NULL) {\n\t\tBN_free(r->d);\n\t\tr->d = d;\n\t}\n\n\treturn 1;\n}",
          "includes": [
            "#include <openssl/dh.h>",
            "#include <openssl/ecdsa.h>",
            "#include <openssl/evp.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/bn.h>",
            "#include <openssl/err.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/dh.h>\n#include <openssl/ecdsa.h>\n#include <openssl/evp.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/bn.h>\n#include <openssl/err.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\nRSA_set0_key(RSA *r, BIGNUM *n, BIGNUM *e, BIGNUM *d)\n{\n\tif ((r->n == NULL && n == NULL) || (r->e == NULL && e == NULL))\n\t\treturn 0;\n\n\tif (n != NULL) {\n\t\tBN_free(r->n);\n\t\tr->n = n;\n\t}\n\tif (e != NULL) {\n\t\tBN_free(r->e);\n\t\tr->e = e;\n\t}\n\tif (d != NULL) {\n\t\tBN_free(r->d);\n\t\tr->d = d;\n\t}\n\n\treturn 1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "BN_bin2bn",
          "args": [
            "attribs[2].pValue",
            "attribs[2].ulValueLen",
            "NULL"
          ],
          "line": 535
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "BN_bin2bn",
          "args": [
            "attribs[1].pValue",
            "attribs[1].ulValueLen",
            "NULL"
          ],
          "line": 533
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "RSA_new",
          "args": [],
          "line": 528
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_GetAttributeValue",
          "args": [
            "session",
            "obj",
            "attribs",
            "3"
          ],
          "line": 524
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "xmalloc",
          "args": [
            "attribs[i].ulValueLen"
          ],
          "line": 514
        },
        "resolved": true,
        "details": {
          "function_name": "xmalloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/xmalloc.c",
          "lines": "39-50",
          "snippet": "void *\nxmalloc(size_t size)\n{\n\tvoid *ptr;\n\n\tif (size == 0)\n\t\tfatal(\"xmalloc: zero size\");\n\tptr = malloc(size);\n\tif (ptr == NULL)\n\t\tfatal(\"xmalloc: out of memory (allocating %zu bytes)\", size);\n\treturn ptr;\n}",
          "includes": [
            "#include \"log.h\"",
            "#include \"xmalloc.h\"",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdint.h>",
            "#include <stdarg.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n#include \"xmalloc.h\"\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdint.h>\n#include <stdarg.h>\n#include \"includes.h\"\n\nvoid *\nxmalloc(size_t size)\n{\n\tvoid *ptr;\n\n\tif (size == 0)\n\t\tfatal(\"xmalloc: zero size\");\n\tptr = malloc(size);\n\tif (ptr == NULL)\n\t\tfatal(\"xmalloc: out of memory (allocating %zu bytes)\", size);\n\treturn ptr;\n}"
        }
      },
      {
        "call_info": {
          "callee": "f->C_GetAttributeValue",
          "args": [
            "session",
            "obj",
            "attribs",
            "3"
          ],
          "line": 497
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_FindObjects",
          "args": [
            "session",
            "&obj",
            "1",
            "&nfound"
          ],
          "line": 493
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_FindObjectsInit",
          "args": [
            "session",
            "filter",
            "1"
          ],
          "line": 483
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_fetch_keys_filter(struct pkcs11_provider *p, CK_ULONG slotidx,\n    CK_ATTRIBUTE filter[], CK_ATTRIBUTE attribs[3],\n    struct sshkey ***keysp, int *nkeys)\n{\n\tstruct sshkey\t\t*key;\n\tRSA\t\t\t*rsa;\n\tX509 \t\t\t*x509;\n\tEVP_PKEY\t\t*evp;\n\tint\t\t\ti;\n\tconst u_char\t\t*cp;\n\tCK_RV\t\t\trv;\n\tCK_OBJECT_HANDLE\tobj;\n\tCK_ULONG\t\tnfound;\n\tCK_SESSION_HANDLE\tsession;\n\tCK_FUNCTION_LIST\t*f;\n\n\tf = p->function_list;\n\tsession = p->slotinfo[slotidx].session;\n\t/* setup a filter the looks for public keys */\n\tif ((rv = f->C_FindObjectsInit(session, filter, 1)) != CKR_OK) {\n\t\terror(\"C_FindObjectsInit failed: %lu\", rv);\n\t\treturn (-1);\n\t}\n\twhile (1) {\n\t\t/* XXX 3 attributes in attribs[] */\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\tattribs[i].pValue = NULL;\n\t\t\tattribs[i].ulValueLen = 0;\n\t\t}\n\t\tif ((rv = f->C_FindObjects(session, &obj, 1, &nfound)) != CKR_OK\n\t\t    || nfound == 0)\n\t\t\tbreak;\n\t\t/* found a key, so figure out size of the attributes */\n\t\tif ((rv = f->C_GetAttributeValue(session, obj, attribs, 3))\n\t\t    != CKR_OK) {\n\t\t\terror(\"C_GetAttributeValue failed: %lu\", rv);\n\t\t\tcontinue;\n\t\t}\n\t\t/*\n\t\t * Allow CKA_ID (always first attribute) to be empty, but\n\t\t * ensure that none of the others are zero length.\n\t\t * XXX assumes CKA_ID is always first.\n\t\t */\n\t\tif (attribs[1].ulValueLen == 0 ||\n\t\t    attribs[2].ulValueLen == 0) {\n\t\t\tcontinue;\n\t\t}\n\t\t/* allocate buffers for attributes */\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\tif (attribs[i].ulValueLen > 0) {\n\t\t\t\tattribs[i].pValue = xmalloc(\n\t\t\t\t    attribs[i].ulValueLen);\n\t\t\t}\n\t\t}\n\n\t\t/*\n\t\t * retrieve ID, modulus and public exponent of RSA key,\n\t\t * or ID, subject and value for certificates.\n\t\t */\n\t\trsa = NULL;\n\t\tif ((rv = f->C_GetAttributeValue(session, obj, attribs, 3))\n\t\t    != CKR_OK) {\n\t\t\terror(\"C_GetAttributeValue failed: %lu\", rv);\n\t\t} else if (attribs[1].type == CKA_MODULUS ) {\n\t\t\tif ((rsa = RSA_new()) == NULL) {\n\t\t\t\terror(\"RSA_new failed\");\n\t\t\t} else {\n\t\t\t\tBIGNUM *rsa_n, *rsa_e;\n\n\t\t\t\trsa_n = BN_bin2bn(attribs[1].pValue,\n\t\t\t\t    attribs[1].ulValueLen, NULL);\n\t\t\t\trsa_e = BN_bin2bn(attribs[2].pValue,\n\t\t\t\t    attribs[2].ulValueLen, NULL);\n\t\t\t\tif (rsa_n != NULL && rsa_e != NULL) {\n\t\t\t\t\tif (!RSA_set0_key(rsa,\n\t\t\t\t\t    rsa_n, rsa_e, NULL))\n\t\t\t\t\t\tfatal(\"%s: set key\", __func__);\n\t\t\t\t\trsa_n = rsa_e = NULL; /* transferred */\n\t\t\t\t}\n\t\t\t\tBN_free(rsa_n);\n\t\t\t\tBN_free(rsa_e);\n\t\t\t}\n\t\t} else {\n\t\t\tcp = attribs[2].pValue;\n\t\t\tif ((x509 = X509_new()) == NULL) {\n\t\t\t\terror(\"X509_new failed\");\n\t\t\t} else if (d2i_X509(&x509, &cp, attribs[2].ulValueLen)\n\t\t\t    == NULL) {\n\t\t\t\terror(\"d2i_X509 failed\");\n\t\t\t} else if ((evp = X509_get_pubkey(x509)) == NULL ||\n\t\t\t    EVP_PKEY_base_id(evp) != EVP_PKEY_RSA ||\n\t\t\t    EVP_PKEY_get0_RSA(evp) == NULL) {\n\t\t\t\tdebug(\"X509_get_pubkey failed or no rsa\");\n\t\t\t} else if ((rsa = RSAPublicKey_dup(\n\t\t\t    EVP_PKEY_get0_RSA(evp))) == NULL) {\n\t\t\t\terror(\"RSAPublicKey_dup\");\n\t\t\t}\n\t\t\tX509_free(x509);\n\t\t}\n\t\tif (rsa && have_rsa_key(rsa) &&\n\t\t    pkcs11_rsa_wrap(p, slotidx, &attribs[0], rsa) == 0) {\n\t\t\tif ((key = sshkey_new(KEY_UNSPEC)) == NULL)\n\t\t\t\tfatal(\"sshkey_new failed\");\n\t\t\tkey->rsa = rsa;\n\t\t\tkey->type = KEY_RSA;\n\t\t\tkey->flags |= SSHKEY_FLAG_EXT;\n\t\t\tif (pkcs11_key_included(keysp, nkeys, key)) {\n\t\t\t\tsshkey_free(key);\n\t\t\t} else {\n\t\t\t\t/* expand key array and add key */\n\t\t\t\t*keysp = xrecallocarray(*keysp, *nkeys,\n\t\t\t\t    *nkeys + 1, sizeof(struct sshkey *));\n\t\t\t\t(*keysp)[*nkeys] = key;\n\t\t\t\t*nkeys = *nkeys + 1;\n\t\t\t\tdebug(\"have %d keys\", *nkeys);\n\t\t\t}\n\t\t} else if (rsa) {\n\t\t\tRSA_free(rsa);\n\t\t}\n\t\tfor (i = 0; i < 3; i++)\n\t\t\tfree(attribs[i].pValue);\n\t}\n\tif ((rv = f->C_FindObjectsFinal(session)) != CKR_OK)\n\t\terror(\"C_FindObjectsFinal failed: %lu\", rv);\n\treturn (0);\n}"
  },
  {
    "function_name": "have_rsa_key",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "454-461",
    "snippet": "static int\nhave_rsa_key(const RSA *rsa)\n{\n\tconst BIGNUM *rsa_n, *rsa_e;\n\n\tRSA_get0_key(rsa, &rsa_n, &rsa_e, NULL);\n\treturn rsa_n != NULL && rsa_e != NULL;\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "RSA_get0_key",
          "args": [
            "rsa",
            "&rsa_n",
            "&rsa_e",
            "NULL"
          ],
          "line": 459
        },
        "resolved": true,
        "details": {
          "function_name": "RSA_get0_key",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/libressl-api-compat.c",
          "lines": "230-239",
          "snippet": "void\nRSA_get0_key(const RSA *r, const BIGNUM **n, const BIGNUM **e, const BIGNUM **d)\n{\n\tif (n != NULL)\n\t\t*n = r->n;\n\tif (e != NULL)\n\t\t*e = r->e;\n\tif (d != NULL)\n\t\t*d = r->d;\n}",
          "includes": [
            "#include <openssl/dh.h>",
            "#include <openssl/ecdsa.h>",
            "#include <openssl/evp.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/bn.h>",
            "#include <openssl/err.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/dh.h>\n#include <openssl/ecdsa.h>\n#include <openssl/evp.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/bn.h>\n#include <openssl/err.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nRSA_get0_key(const RSA *r, const BIGNUM **n, const BIGNUM **e, const BIGNUM **d)\n{\n\tif (n != NULL)\n\t\t*n = r->n;\n\tif (e != NULL)\n\t\t*e = r->e;\n\tif (d != NULL)\n\t\t*d = r->d;\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\nhave_rsa_key(const RSA *rsa)\n{\n\tconst BIGNUM *rsa_n, *rsa_e;\n\n\tRSA_get0_key(rsa, &rsa_n, &rsa_e, NULL);\n\treturn rsa_n != NULL && rsa_e != NULL;\n}"
  },
  {
    "function_name": "pkcs11_key_included",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "443-452",
    "snippet": "static int\npkcs11_key_included(struct sshkey ***keysp, int *nkeys, struct sshkey *key)\n{\n\tint i;\n\n\tfor (i = 0; i < *nkeys; i++)\n\t\tif (sshkey_equal(key, (*keysp)[i]))\n\t\t\treturn (1);\n\treturn (0);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "sshkey_equal",
          "args": [
            "key",
            "(*keysp)[i]"
          ],
          "line": 449
        },
        "resolved": true,
        "details": {
          "function_name": "sshkey_equal",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/sshkey.c",
          "lines": "704-714",
          "snippet": "int\nsshkey_equal(const struct sshkey *a, const struct sshkey *b)\n{\n\tif (a == NULL || b == NULL || a->type != b->type)\n\t\treturn 0;\n\tif (sshkey_is_cert(a)) {\n\t\tif (!cert_compare(a->cert, b->cert))\n\t\t\treturn 0;\n\t}\n\treturn sshkey_equal_public(a, b);\n}",
          "includes": [
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"xmss_fast.h\"",
            "#include \"match.h\"",
            "#include \"sshkey-xmss.h\"",
            "#include \"sshkey.h\"",
            "#include \"digest.h\"",
            "#include \"cipher.h\"",
            "#include \"sshbuf.h\"",
            "#include \"misc.h\"",
            "#include \"ssherr.h\"",
            "#include \"ssh2.h\"",
            "#include <util.h>",
            "#include <resolv.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <limits.h>",
            "#include <errno.h>",
            "#include \"crypto_api.h\"",
            "#include <openssl/pem.h>",
            "#include <openssl/err.h>",
            "#include <openssl/evp.h>",
            "#include <netinet/in.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"openbsd-compat/openssl-compat.h\"\n#include \"xmss_fast.h\"\n#include \"match.h\"\n#include \"sshkey-xmss.h\"\n#include \"sshkey.h\"\n#include \"digest.h\"\n#include \"cipher.h\"\n#include \"sshbuf.h\"\n#include \"misc.h\"\n#include \"ssherr.h\"\n#include \"ssh2.h\"\n#include <util.h>\n#include <resolv.h>\n#include <string.h>\n#include <stdio.h>\n#include <limits.h>\n#include <errno.h>\n#include \"crypto_api.h\"\n#include <openssl/pem.h>\n#include <openssl/err.h>\n#include <openssl/evp.h>\n#include <netinet/in.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\nsshkey_equal(const struct sshkey *a, const struct sshkey *b)\n{\n\tif (a == NULL || b == NULL || a->type != b->type)\n\t\treturn 0;\n\tif (sshkey_is_cert(a)) {\n\t\tif (!cert_compare(a->cert, b->cert))\n\t\t\treturn 0;\n\t}\n\treturn sshkey_equal_public(a, b);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_key_included(struct sshkey ***keysp, int *nkeys, struct sshkey *key)\n{\n\tint i;\n\n\tfor (i = 0; i < *nkeys; i++)\n\t\tif (sshkey_equal(key, (*keysp)[i]))\n\t\t\treturn (1);\n\treturn (0);\n}"
  },
  {
    "function_name": "pkcs11_fetch_keys",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "410-441",
    "snippet": "static int\npkcs11_fetch_keys(struct pkcs11_provider *p, CK_ULONG slotidx,\n    struct sshkey ***keysp, int *nkeys)\n{\n\tCK_OBJECT_CLASS\tpubkey_class = CKO_PUBLIC_KEY;\n\tCK_OBJECT_CLASS\tcert_class = CKO_CERTIFICATE;\n\tCK_ATTRIBUTE\t\tpubkey_filter[] = {\n\t\t{ CKA_CLASS, NULL, sizeof(pubkey_class) }\n\t};\n\tCK_ATTRIBUTE\t\tcert_filter[] = {\n\t\t{ CKA_CLASS, NULL, sizeof(cert_class) }\n\t};\n\tCK_ATTRIBUTE\t\tpubkey_attribs[] = {\n\t\t{ CKA_ID, NULL, 0 },\n\t\t{ CKA_MODULUS, NULL, 0 },\n\t\t{ CKA_PUBLIC_EXPONENT, NULL, 0 }\n\t};\n\tCK_ATTRIBUTE\t\tcert_attribs[] = {\n\t\t{ CKA_ID, NULL, 0 },\n\t\t{ CKA_SUBJECT, NULL, 0 },\n\t\t{ CKA_VALUE, NULL, 0 }\n\t};\n\tpubkey_filter[0].pValue = &pubkey_class;\n\tcert_filter[0].pValue = &cert_class;\n\n\tif (pkcs11_fetch_keys_filter(p, slotidx, pubkey_filter, pubkey_attribs,\n\t    keysp, nkeys) < 0 ||\n\t    pkcs11_fetch_keys_filter(p, slotidx, cert_filter, cert_attribs,\n\t    keysp, nkeys) < 0)\n\t\treturn (-1);\n\treturn (0);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "pkcs11_fetch_keys_filter",
          "args": [
            "p",
            "slotidx",
            "cert_filter",
            "cert_attribs",
            "keysp",
            "nkeys"
          ],
          "line": 437
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_fetch_keys_filter",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "463-589",
          "snippet": "static int\npkcs11_fetch_keys_filter(struct pkcs11_provider *p, CK_ULONG slotidx,\n    CK_ATTRIBUTE filter[], CK_ATTRIBUTE attribs[3],\n    struct sshkey ***keysp, int *nkeys)\n{\n\tstruct sshkey\t\t*key;\n\tRSA\t\t\t*rsa;\n\tX509 \t\t\t*x509;\n\tEVP_PKEY\t\t*evp;\n\tint\t\t\ti;\n\tconst u_char\t\t*cp;\n\tCK_RV\t\t\trv;\n\tCK_OBJECT_HANDLE\tobj;\n\tCK_ULONG\t\tnfound;\n\tCK_SESSION_HANDLE\tsession;\n\tCK_FUNCTION_LIST\t*f;\n\n\tf = p->function_list;\n\tsession = p->slotinfo[slotidx].session;\n\t/* setup a filter the looks for public keys */\n\tif ((rv = f->C_FindObjectsInit(session, filter, 1)) != CKR_OK) {\n\t\terror(\"C_FindObjectsInit failed: %lu\", rv);\n\t\treturn (-1);\n\t}\n\twhile (1) {\n\t\t/* XXX 3 attributes in attribs[] */\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\tattribs[i].pValue = NULL;\n\t\t\tattribs[i].ulValueLen = 0;\n\t\t}\n\t\tif ((rv = f->C_FindObjects(session, &obj, 1, &nfound)) != CKR_OK\n\t\t    || nfound == 0)\n\t\t\tbreak;\n\t\t/* found a key, so figure out size of the attributes */\n\t\tif ((rv = f->C_GetAttributeValue(session, obj, attribs, 3))\n\t\t    != CKR_OK) {\n\t\t\terror(\"C_GetAttributeValue failed: %lu\", rv);\n\t\t\tcontinue;\n\t\t}\n\t\t/*\n\t\t * Allow CKA_ID (always first attribute) to be empty, but\n\t\t * ensure that none of the others are zero length.\n\t\t * XXX assumes CKA_ID is always first.\n\t\t */\n\t\tif (attribs[1].ulValueLen == 0 ||\n\t\t    attribs[2].ulValueLen == 0) {\n\t\t\tcontinue;\n\t\t}\n\t\t/* allocate buffers for attributes */\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\tif (attribs[i].ulValueLen > 0) {\n\t\t\t\tattribs[i].pValue = xmalloc(\n\t\t\t\t    attribs[i].ulValueLen);\n\t\t\t}\n\t\t}\n\n\t\t/*\n\t\t * retrieve ID, modulus and public exponent of RSA key,\n\t\t * or ID, subject and value for certificates.\n\t\t */\n\t\trsa = NULL;\n\t\tif ((rv = f->C_GetAttributeValue(session, obj, attribs, 3))\n\t\t    != CKR_OK) {\n\t\t\terror(\"C_GetAttributeValue failed: %lu\", rv);\n\t\t} else if (attribs[1].type == CKA_MODULUS ) {\n\t\t\tif ((rsa = RSA_new()) == NULL) {\n\t\t\t\terror(\"RSA_new failed\");\n\t\t\t} else {\n\t\t\t\tBIGNUM *rsa_n, *rsa_e;\n\n\t\t\t\trsa_n = BN_bin2bn(attribs[1].pValue,\n\t\t\t\t    attribs[1].ulValueLen, NULL);\n\t\t\t\trsa_e = BN_bin2bn(attribs[2].pValue,\n\t\t\t\t    attribs[2].ulValueLen, NULL);\n\t\t\t\tif (rsa_n != NULL && rsa_e != NULL) {\n\t\t\t\t\tif (!RSA_set0_key(rsa,\n\t\t\t\t\t    rsa_n, rsa_e, NULL))\n\t\t\t\t\t\tfatal(\"%s: set key\", __func__);\n\t\t\t\t\trsa_n = rsa_e = NULL; /* transferred */\n\t\t\t\t}\n\t\t\t\tBN_free(rsa_n);\n\t\t\t\tBN_free(rsa_e);\n\t\t\t}\n\t\t} else {\n\t\t\tcp = attribs[2].pValue;\n\t\t\tif ((x509 = X509_new()) == NULL) {\n\t\t\t\terror(\"X509_new failed\");\n\t\t\t} else if (d2i_X509(&x509, &cp, attribs[2].ulValueLen)\n\t\t\t    == NULL) {\n\t\t\t\terror(\"d2i_X509 failed\");\n\t\t\t} else if ((evp = X509_get_pubkey(x509)) == NULL ||\n\t\t\t    EVP_PKEY_base_id(evp) != EVP_PKEY_RSA ||\n\t\t\t    EVP_PKEY_get0_RSA(evp) == NULL) {\n\t\t\t\tdebug(\"X509_get_pubkey failed or no rsa\");\n\t\t\t} else if ((rsa = RSAPublicKey_dup(\n\t\t\t    EVP_PKEY_get0_RSA(evp))) == NULL) {\n\t\t\t\terror(\"RSAPublicKey_dup\");\n\t\t\t}\n\t\t\tX509_free(x509);\n\t\t}\n\t\tif (rsa && have_rsa_key(rsa) &&\n\t\t    pkcs11_rsa_wrap(p, slotidx, &attribs[0], rsa) == 0) {\n\t\t\tif ((key = sshkey_new(KEY_UNSPEC)) == NULL)\n\t\t\t\tfatal(\"sshkey_new failed\");\n\t\t\tkey->rsa = rsa;\n\t\t\tkey->type = KEY_RSA;\n\t\t\tkey->flags |= SSHKEY_FLAG_EXT;\n\t\t\tif (pkcs11_key_included(keysp, nkeys, key)) {\n\t\t\t\tsshkey_free(key);\n\t\t\t} else {\n\t\t\t\t/* expand key array and add key */\n\t\t\t\t*keysp = xrecallocarray(*keysp, *nkeys,\n\t\t\t\t    *nkeys + 1, sizeof(struct sshkey *));\n\t\t\t\t(*keysp)[*nkeys] = key;\n\t\t\t\t*nkeys = *nkeys + 1;\n\t\t\t\tdebug(\"have %d keys\", *nkeys);\n\t\t\t}\n\t\t} else if (rsa) {\n\t\t\tRSA_free(rsa);\n\t\t}\n\t\tfor (i = 0; i < 3; i++)\n\t\t\tfree(attribs[i].pValue);\n\t}\n\tif ((rv = f->C_FindObjectsFinal(session)) != CKR_OK)\n\t\terror(\"C_FindObjectsFinal failed: %lu\", rv);\n\treturn (0);\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_fetch_keys_filter(struct pkcs11_provider *p, CK_ULONG slotidx,\n    CK_ATTRIBUTE filter[], CK_ATTRIBUTE attribs[3],\n    struct sshkey ***keysp, int *nkeys)\n{\n\tstruct sshkey\t\t*key;\n\tRSA\t\t\t*rsa;\n\tX509 \t\t\t*x509;\n\tEVP_PKEY\t\t*evp;\n\tint\t\t\ti;\n\tconst u_char\t\t*cp;\n\tCK_RV\t\t\trv;\n\tCK_OBJECT_HANDLE\tobj;\n\tCK_ULONG\t\tnfound;\n\tCK_SESSION_HANDLE\tsession;\n\tCK_FUNCTION_LIST\t*f;\n\n\tf = p->function_list;\n\tsession = p->slotinfo[slotidx].session;\n\t/* setup a filter the looks for public keys */\n\tif ((rv = f->C_FindObjectsInit(session, filter, 1)) != CKR_OK) {\n\t\terror(\"C_FindObjectsInit failed: %lu\", rv);\n\t\treturn (-1);\n\t}\n\twhile (1) {\n\t\t/* XXX 3 attributes in attribs[] */\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\tattribs[i].pValue = NULL;\n\t\t\tattribs[i].ulValueLen = 0;\n\t\t}\n\t\tif ((rv = f->C_FindObjects(session, &obj, 1, &nfound)) != CKR_OK\n\t\t    || nfound == 0)\n\t\t\tbreak;\n\t\t/* found a key, so figure out size of the attributes */\n\t\tif ((rv = f->C_GetAttributeValue(session, obj, attribs, 3))\n\t\t    != CKR_OK) {\n\t\t\terror(\"C_GetAttributeValue failed: %lu\", rv);\n\t\t\tcontinue;\n\t\t}\n\t\t/*\n\t\t * Allow CKA_ID (always first attribute) to be empty, but\n\t\t * ensure that none of the others are zero length.\n\t\t * XXX assumes CKA_ID is always first.\n\t\t */\n\t\tif (attribs[1].ulValueLen == 0 ||\n\t\t    attribs[2].ulValueLen == 0) {\n\t\t\tcontinue;\n\t\t}\n\t\t/* allocate buffers for attributes */\n\t\tfor (i = 0; i < 3; i++) {\n\t\t\tif (attribs[i].ulValueLen > 0) {\n\t\t\t\tattribs[i].pValue = xmalloc(\n\t\t\t\t    attribs[i].ulValueLen);\n\t\t\t}\n\t\t}\n\n\t\t/*\n\t\t * retrieve ID, modulus and public exponent of RSA key,\n\t\t * or ID, subject and value for certificates.\n\t\t */\n\t\trsa = NULL;\n\t\tif ((rv = f->C_GetAttributeValue(session, obj, attribs, 3))\n\t\t    != CKR_OK) {\n\t\t\terror(\"C_GetAttributeValue failed: %lu\", rv);\n\t\t} else if (attribs[1].type == CKA_MODULUS ) {\n\t\t\tif ((rsa = RSA_new()) == NULL) {\n\t\t\t\terror(\"RSA_new failed\");\n\t\t\t} else {\n\t\t\t\tBIGNUM *rsa_n, *rsa_e;\n\n\t\t\t\trsa_n = BN_bin2bn(attribs[1].pValue,\n\t\t\t\t    attribs[1].ulValueLen, NULL);\n\t\t\t\trsa_e = BN_bin2bn(attribs[2].pValue,\n\t\t\t\t    attribs[2].ulValueLen, NULL);\n\t\t\t\tif (rsa_n != NULL && rsa_e != NULL) {\n\t\t\t\t\tif (!RSA_set0_key(rsa,\n\t\t\t\t\t    rsa_n, rsa_e, NULL))\n\t\t\t\t\t\tfatal(\"%s: set key\", __func__);\n\t\t\t\t\trsa_n = rsa_e = NULL; /* transferred */\n\t\t\t\t}\n\t\t\t\tBN_free(rsa_n);\n\t\t\t\tBN_free(rsa_e);\n\t\t\t}\n\t\t} else {\n\t\t\tcp = attribs[2].pValue;\n\t\t\tif ((x509 = X509_new()) == NULL) {\n\t\t\t\terror(\"X509_new failed\");\n\t\t\t} else if (d2i_X509(&x509, &cp, attribs[2].ulValueLen)\n\t\t\t    == NULL) {\n\t\t\t\terror(\"d2i_X509 failed\");\n\t\t\t} else if ((evp = X509_get_pubkey(x509)) == NULL ||\n\t\t\t    EVP_PKEY_base_id(evp) != EVP_PKEY_RSA ||\n\t\t\t    EVP_PKEY_get0_RSA(evp) == NULL) {\n\t\t\t\tdebug(\"X509_get_pubkey failed or no rsa\");\n\t\t\t} else if ((rsa = RSAPublicKey_dup(\n\t\t\t    EVP_PKEY_get0_RSA(evp))) == NULL) {\n\t\t\t\terror(\"RSAPublicKey_dup\");\n\t\t\t}\n\t\t\tX509_free(x509);\n\t\t}\n\t\tif (rsa && have_rsa_key(rsa) &&\n\t\t    pkcs11_rsa_wrap(p, slotidx, &attribs[0], rsa) == 0) {\n\t\t\tif ((key = sshkey_new(KEY_UNSPEC)) == NULL)\n\t\t\t\tfatal(\"sshkey_new failed\");\n\t\t\tkey->rsa = rsa;\n\t\t\tkey->type = KEY_RSA;\n\t\t\tkey->flags |= SSHKEY_FLAG_EXT;\n\t\t\tif (pkcs11_key_included(keysp, nkeys, key)) {\n\t\t\t\tsshkey_free(key);\n\t\t\t} else {\n\t\t\t\t/* expand key array and add key */\n\t\t\t\t*keysp = xrecallocarray(*keysp, *nkeys,\n\t\t\t\t    *nkeys + 1, sizeof(struct sshkey *));\n\t\t\t\t(*keysp)[*nkeys] = key;\n\t\t\t\t*nkeys = *nkeys + 1;\n\t\t\t\tdebug(\"have %d keys\", *nkeys);\n\t\t\t}\n\t\t} else if (rsa) {\n\t\t\tRSA_free(rsa);\n\t\t}\n\t\tfor (i = 0; i < 3; i++)\n\t\t\tfree(attribs[i].pValue);\n\t}\n\tif ((rv = f->C_FindObjectsFinal(session)) != CKR_OK)\n\t\terror(\"C_FindObjectsFinal failed: %lu\", rv);\n\treturn (0);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_fetch_keys(struct pkcs11_provider *p, CK_ULONG slotidx,\n    struct sshkey ***keysp, int *nkeys)\n{\n\tCK_OBJECT_CLASS\tpubkey_class = CKO_PUBLIC_KEY;\n\tCK_OBJECT_CLASS\tcert_class = CKO_CERTIFICATE;\n\tCK_ATTRIBUTE\t\tpubkey_filter[] = {\n\t\t{ CKA_CLASS, NULL, sizeof(pubkey_class) }\n\t};\n\tCK_ATTRIBUTE\t\tcert_filter[] = {\n\t\t{ CKA_CLASS, NULL, sizeof(cert_class) }\n\t};\n\tCK_ATTRIBUTE\t\tpubkey_attribs[] = {\n\t\t{ CKA_ID, NULL, 0 },\n\t\t{ CKA_MODULUS, NULL, 0 },\n\t\t{ CKA_PUBLIC_EXPONENT, NULL, 0 }\n\t};\n\tCK_ATTRIBUTE\t\tcert_attribs[] = {\n\t\t{ CKA_ID, NULL, 0 },\n\t\t{ CKA_SUBJECT, NULL, 0 },\n\t\t{ CKA_VALUE, NULL, 0 }\n\t};\n\tpubkey_filter[0].pValue = &pubkey_class;\n\tcert_filter[0].pValue = &cert_class;\n\n\tif (pkcs11_fetch_keys_filter(p, slotidx, pubkey_filter, pubkey_attribs,\n\t    keysp, nkeys) < 0 ||\n\t    pkcs11_fetch_keys_filter(p, slotidx, cert_filter, cert_attribs,\n\t    keysp, nkeys) < 0)\n\t\treturn (-1);\n\treturn (0);\n}"
  },
  {
    "function_name": "pkcs11_open_session",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "366-399",
    "snippet": "static int\npkcs11_open_session(struct pkcs11_provider *p, CK_ULONG slotidx, char *pin)\n{\n\tCK_RV\t\t\trv;\n\tCK_FUNCTION_LIST\t*f;\n\tCK_SESSION_HANDLE\tsession;\n\tint\t\t\tlogin_required;\n\n\tf = p->function_list;\n\tlogin_required = p->slotinfo[slotidx].token.flags & CKF_LOGIN_REQUIRED;\n\tif (pin && login_required && !strlen(pin)) {\n\t\terror(\"pin required\");\n\t\treturn (-1);\n\t}\n\tif ((rv = f->C_OpenSession(p->slotlist[slotidx], CKF_RW_SESSION|\n\t    CKF_SERIAL_SESSION, NULL, NULL, &session))\n\t    != CKR_OK) {\n\t\terror(\"C_OpenSession failed: %lu\", rv);\n\t\treturn (-1);\n\t}\n\tif (login_required && pin) {\n\t\trv = f->C_Login(session, CKU_USER,\n\t\t    (u_char *)pin, strlen(pin));\n\t\tif (rv != CKR_OK && rv != CKR_USER_ALREADY_LOGGED_IN) {\n\t\t\terror(\"C_Login failed: %lu\", rv);\n\t\t\tif ((rv = f->C_CloseSession(session)) != CKR_OK)\n\t\t\t\terror(\"C_CloseSession failed: %lu\", rv);\n\t\t\treturn (-1);\n\t\t}\n\t\tp->slotinfo[slotidx].logged_in = 1;\n\t}\n\tp->slotinfo[slotidx].session = session;\n\treturn (0);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "error",
          "args": [
            "\"C_CloseSession failed: %lu\"",
            "rv"
          ],
          "line": 392
        },
        "resolved": true,
        "details": {
          "function_name": "error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "162-170",
          "snippet": "void\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "f->C_CloseSession",
          "args": [
            "session"
          ],
          "line": 391
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_Login",
          "args": [
            "session",
            "CKU_USER",
            "(u_char *)pin",
            "strlen(pin)"
          ],
          "line": 387
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "pin"
          ],
          "line": 388
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_OpenSession",
          "args": [
            "p->slotlist[slotidx]",
            "CKF_RW_SESSION|\n\t    CKF_SERIAL_SESSION",
            "NULL",
            "NULL",
            "&session"
          ],
          "line": 380
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "pin"
          ],
          "line": 376
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_open_session(struct pkcs11_provider *p, CK_ULONG slotidx, char *pin)\n{\n\tCK_RV\t\t\trv;\n\tCK_FUNCTION_LIST\t*f;\n\tCK_SESSION_HANDLE\tsession;\n\tint\t\t\tlogin_required;\n\n\tf = p->function_list;\n\tlogin_required = p->slotinfo[slotidx].token.flags & CKF_LOGIN_REQUIRED;\n\tif (pin && login_required && !strlen(pin)) {\n\t\terror(\"pin required\");\n\t\treturn (-1);\n\t}\n\tif ((rv = f->C_OpenSession(p->slotlist[slotidx], CKF_RW_SESSION|\n\t    CKF_SERIAL_SESSION, NULL, NULL, &session))\n\t    != CKR_OK) {\n\t\terror(\"C_OpenSession failed: %lu\", rv);\n\t\treturn (-1);\n\t}\n\tif (login_required && pin) {\n\t\trv = f->C_Login(session, CKU_USER,\n\t\t    (u_char *)pin, strlen(pin));\n\t\tif (rv != CKR_OK && rv != CKR_USER_ALREADY_LOGGED_IN) {\n\t\t\terror(\"C_Login failed: %lu\", rv);\n\t\t\tif ((rv = f->C_CloseSession(session)) != CKR_OK)\n\t\t\t\terror(\"C_CloseSession failed: %lu\", rv);\n\t\t\treturn (-1);\n\t\t}\n\t\tp->slotinfo[slotidx].logged_in = 1;\n\t}\n\tp->slotinfo[slotidx].session = session;\n\treturn (0);\n}"
  },
  {
    "function_name": "rmspace",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "348-360",
    "snippet": "static void\nrmspace(u_char *buf, size_t len)\n{\n\tsize_t i;\n\n\tif (!len)\n\t\treturn;\n\tfor (i = len - 1;  i > 0; i--)\n\t\tif (i == len - 1 || buf[i] == ' ')\n\t\t\tbuf[i] = '\\0';\n\t\telse\n\t\t\tbreak;\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\nrmspace(u_char *buf, size_t len)\n{\n\tsize_t i;\n\n\tif (!len)\n\t\treturn;\n\tfor (i = len - 1;  i > 0; i--)\n\t\tif (i == len - 1 || buf[i] == ' ')\n\t\t\tbuf[i] = '\\0';\n\t\telse\n\t\t\tbreak;\n}"
  },
  {
    "function_name": "pkcs11_rsa_wrap",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "314-345",
    "snippet": "static int\npkcs11_rsa_wrap(struct pkcs11_provider *provider, CK_ULONG slotidx,\n    CK_ATTRIBUTE *keyid_attrib, RSA *rsa)\n{\n\tstruct pkcs11_key\t*k11;\n\tconst RSA_METHOD\t*def = RSA_get_default_method();\n\n\tk11 = xcalloc(1, sizeof(*k11));\n\tk11->provider = provider;\n\tprovider->refcount++;\t/* provider referenced by RSA key */\n\tk11->slotidx = slotidx;\n\t/* identify key object on smartcard */\n\tk11->keyid_len = keyid_attrib->ulValueLen;\n\tif (k11->keyid_len > 0) {\n\t\tk11->keyid = xmalloc(k11->keyid_len);\n\t\tmemcpy(k11->keyid, keyid_attrib->pValue, k11->keyid_len);\n\t}\n\tk11->rsa_method = RSA_meth_dup(def);\n\tif (k11->rsa_method == NULL)\n\t\tfatal(\"%s: RSA_meth_dup failed\", __func__);\n\tk11->orig_finish = RSA_meth_get_finish(def);\n\tif (!RSA_meth_set1_name(k11->rsa_method, \"pkcs11\") ||\n\t    !RSA_meth_set_priv_enc(k11->rsa_method,\n\t    pkcs11_rsa_private_encrypt) ||\n\t    !RSA_meth_set_priv_dec(k11->rsa_method,\n\t    pkcs11_rsa_private_decrypt) ||\n\t    !RSA_meth_set_finish(k11->rsa_method, pkcs11_rsa_finish))\n\t\tfatal(\"%s: setup pkcs11 method failed\", __func__);\n\tRSA_set_method(rsa, k11->rsa_method);\n\tRSA_set_app_data(rsa, k11);\n\treturn (0);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "RSA_set_app_data",
          "args": [
            "rsa",
            "k11"
          ],
          "line": 343
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "RSA_set_method",
          "args": [
            "rsa",
            "k11->rsa_method"
          ],
          "line": 342
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "fatal",
          "args": [
            "\"%s: setup pkcs11 method failed\"",
            "__func__"
          ],
          "line": 341
        },
        "resolved": true,
        "details": {
          "function_name": "match_test_missing_fatal",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/servconf.c",
          "lines": "988-993",
          "snippet": "static void\nmatch_test_missing_fatal(const char *criteria, const char *attrib)\n{\n\tfatal(\"'Match %s' in configuration but '%s' not in connection \"\n\t    \"test specification.\", criteria, attrib);\n}",
          "includes": [
            "#include \"digest.h\"",
            "#include \"myproposal.h\"",
            "#include \"auth.h\"",
            "#include \"hostfile.h\"",
            "#include \"ssherr.h\"",
            "#include \"packet.h\"",
            "#include \"canohost.h\"",
            "#include \"groupaccess.h\"",
            "#include \"channels.h\"",
            "#include \"match.h\"",
            "#include \"mac.h\"",
            "#include \"kex.h\"",
            "#include \"sshkey.h\"",
            "#include \"cipher.h\"",
            "#include \"pathnames.h\"",
            "#include \"compat.h\"",
            "#include \"servconf.h\"",
            "#include \"misc.h\"",
            "#include \"sshbuf.h\"",
            "#include \"log.h\"",
            "#include \"ssh.h\"",
            "#include \"xmalloc.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <util.h>",
            "#include <errno.h>",
            "#include <stdarg.h>",
            "#include <limits.h>",
            "#include <unistd.h>",
            "#include <signal.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <pwd.h>",
            "#include <netdb.h>",
            "#include <ctype.h>",
            "#include <net/route.h>",
            "#include <netinet/ip.h>",
            "#include <netinet/in_systm.h>",
            "#include <netinet/in.h>",
            "#include <sys/sysctl.h>",
            "#include <sys/socket.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"digest.h\"\n#include \"myproposal.h\"\n#include \"auth.h\"\n#include \"hostfile.h\"\n#include \"ssherr.h\"\n#include \"packet.h\"\n#include \"canohost.h\"\n#include \"groupaccess.h\"\n#include \"channels.h\"\n#include \"match.h\"\n#include \"mac.h\"\n#include \"kex.h\"\n#include \"sshkey.h\"\n#include \"cipher.h\"\n#include \"pathnames.h\"\n#include \"compat.h\"\n#include \"servconf.h\"\n#include \"misc.h\"\n#include \"sshbuf.h\"\n#include \"log.h\"\n#include \"ssh.h\"\n#include \"xmalloc.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <util.h>\n#include <errno.h>\n#include <stdarg.h>\n#include <limits.h>\n#include <unistd.h>\n#include <signal.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <pwd.h>\n#include <netdb.h>\n#include <ctype.h>\n#include <net/route.h>\n#include <netinet/ip.h>\n#include <netinet/in_systm.h>\n#include <netinet/in.h>\n#include <sys/sysctl.h>\n#include <sys/socket.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\nmatch_test_missing_fatal(const char *criteria, const char *attrib)\n{\n\tfatal(\"'Match %s' in configuration but '%s' not in connection \"\n\t    \"test specification.\", criteria, attrib);\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_meth_set_finish",
          "args": [
            "k11->rsa_method",
            "pkcs11_rsa_finish"
          ],
          "line": 340
        },
        "resolved": true,
        "details": {
          "function_name": "RSA_meth_set_finish",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/libressl-api-compat.c",
          "lines": "599-604",
          "snippet": "int\nRSA_meth_set_finish(RSA_METHOD *meth, int (*finish)(RSA *rsa))\n{\n\tmeth->finish = finish;\n\treturn 1;\n}",
          "includes": [
            "#include <openssl/dh.h>",
            "#include <openssl/ecdsa.h>",
            "#include <openssl/evp.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/bn.h>",
            "#include <openssl/err.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/dh.h>\n#include <openssl/ecdsa.h>\n#include <openssl/evp.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/bn.h>\n#include <openssl/err.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\nRSA_meth_set_finish(RSA_METHOD *meth, int (*finish)(RSA *rsa))\n{\n\tmeth->finish = finish;\n\treturn 1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_meth_set_priv_dec",
          "args": [
            "k11->rsa_method",
            "pkcs11_rsa_private_decrypt"
          ],
          "line": 338
        },
        "resolved": true,
        "details": {
          "function_name": "RSA_meth_set_priv_dec",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/libressl-api-compat.c",
          "lines": "589-595",
          "snippet": "int\nRSA_meth_set_priv_dec(RSA_METHOD *meth, int (*priv_dec)(int flen,\n    const unsigned char *from, unsigned char *to, RSA *rsa, int padding))\n{\n\tmeth->rsa_priv_dec = priv_dec;\n\treturn 1;\n}",
          "includes": [
            "#include <openssl/dh.h>",
            "#include <openssl/ecdsa.h>",
            "#include <openssl/evp.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/bn.h>",
            "#include <openssl/err.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/dh.h>\n#include <openssl/ecdsa.h>\n#include <openssl/evp.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/bn.h>\n#include <openssl/err.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\nRSA_meth_set_priv_dec(RSA_METHOD *meth, int (*priv_dec)(int flen,\n    const unsigned char *from, unsigned char *to, RSA *rsa, int padding))\n{\n\tmeth->rsa_priv_dec = priv_dec;\n\treturn 1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_meth_set_priv_enc",
          "args": [
            "k11->rsa_method",
            "pkcs11_rsa_private_encrypt"
          ],
          "line": 336
        },
        "resolved": true,
        "details": {
          "function_name": "RSA_meth_set_priv_enc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/libressl-api-compat.c",
          "lines": "579-585",
          "snippet": "int\nRSA_meth_set_priv_enc(RSA_METHOD *meth, int (*priv_enc)(int flen,\n    const unsigned char *from, unsigned char *to, RSA *rsa, int padding))\n{\n\tmeth->rsa_priv_enc = priv_enc;\n\treturn 1;\n}",
          "includes": [
            "#include <openssl/dh.h>",
            "#include <openssl/ecdsa.h>",
            "#include <openssl/evp.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/bn.h>",
            "#include <openssl/err.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/dh.h>\n#include <openssl/ecdsa.h>\n#include <openssl/evp.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/bn.h>\n#include <openssl/err.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\nRSA_meth_set_priv_enc(RSA_METHOD *meth, int (*priv_enc)(int flen,\n    const unsigned char *from, unsigned char *to, RSA *rsa, int padding))\n{\n\tmeth->rsa_priv_enc = priv_enc;\n\treturn 1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_meth_set1_name",
          "args": [
            "k11->rsa_method",
            "\"pkcs11\""
          ],
          "line": 335
        },
        "resolved": true,
        "details": {
          "function_name": "RSA_meth_set1_name",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/libressl-api-compat.c",
          "lines": "557-567",
          "snippet": "int\nRSA_meth_set1_name(RSA_METHOD *meth, const char *name)\n{\n\tchar *copy;\n\n\tif ((copy = strdup(name)) == NULL)\n\t\treturn 0;\n\tfree((char *)meth->name);\n\tmeth->name = copy;\n\treturn 1;\n}",
          "includes": [
            "#include <openssl/dh.h>",
            "#include <openssl/ecdsa.h>",
            "#include <openssl/evp.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/bn.h>",
            "#include <openssl/err.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/dh.h>\n#include <openssl/ecdsa.h>\n#include <openssl/evp.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/bn.h>\n#include <openssl/err.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\nRSA_meth_set1_name(RSA_METHOD *meth, const char *name)\n{\n\tchar *copy;\n\n\tif ((copy = strdup(name)) == NULL)\n\t\treturn 0;\n\tfree((char *)meth->name);\n\tmeth->name = copy;\n\treturn 1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_meth_get_finish",
          "args": [
            "def"
          ],
          "line": 334
        },
        "resolved": true,
        "details": {
          "function_name": "RSA_meth_get_finish",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/libressl-api-compat.c",
          "lines": "571-575",
          "snippet": "int\n(*RSA_meth_get_finish(const RSA_METHOD *meth))(RSA *rsa)\n{\n\treturn meth->finish;\n}",
          "includes": [
            "#include <openssl/dh.h>",
            "#include <openssl/ecdsa.h>",
            "#include <openssl/evp.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/bn.h>",
            "#include <openssl/err.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/dh.h>\n#include <openssl/ecdsa.h>\n#include <openssl/evp.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/bn.h>\n#include <openssl/err.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\n(*RSA_meth_get_finish(const RSA_METHOD *meth))(RSA *rsa)\n{\n\treturn meth->finish;\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_meth_dup",
          "args": [
            "def"
          ],
          "line": 331
        },
        "resolved": true,
        "details": {
          "function_name": "RSA_meth_dup",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/libressl-api-compat.c",
          "lines": "539-553",
          "snippet": "RSA_METHOD *\nRSA_meth_dup(const RSA_METHOD *meth)\n{\n\tRSA_METHOD *copy;\n\n\tif ((copy = calloc(1, sizeof(*copy))) == NULL)\n\t\treturn NULL;\n\tmemcpy(copy, meth, sizeof(*copy));\n\tif ((copy->name = strdup(meth->name)) == NULL) {\n\t\tfree(copy);\n\t\treturn NULL;\n\t}\n\n\treturn copy;\n}",
          "includes": [
            "#include <openssl/dh.h>",
            "#include <openssl/ecdsa.h>",
            "#include <openssl/evp.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/bn.h>",
            "#include <openssl/err.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/dh.h>\n#include <openssl/ecdsa.h>\n#include <openssl/evp.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/bn.h>\n#include <openssl/err.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nRSA_METHOD *\nRSA_meth_dup(const RSA_METHOD *meth)\n{\n\tRSA_METHOD *copy;\n\n\tif ((copy = calloc(1, sizeof(*copy))) == NULL)\n\t\treturn NULL;\n\tmemcpy(copy, meth, sizeof(*copy));\n\tif ((copy->name = strdup(meth->name)) == NULL) {\n\t\tfree(copy);\n\t\treturn NULL;\n\t}\n\n\treturn copy;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "k11->keyid",
            "keyid_attrib->pValue",
            "k11->keyid_len"
          ],
          "line": 329
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "xmalloc",
          "args": [
            "k11->keyid_len"
          ],
          "line": 328
        },
        "resolved": true,
        "details": {
          "function_name": "xmalloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/xmalloc.c",
          "lines": "39-50",
          "snippet": "void *\nxmalloc(size_t size)\n{\n\tvoid *ptr;\n\n\tif (size == 0)\n\t\tfatal(\"xmalloc: zero size\");\n\tptr = malloc(size);\n\tif (ptr == NULL)\n\t\tfatal(\"xmalloc: out of memory (allocating %zu bytes)\", size);\n\treturn ptr;\n}",
          "includes": [
            "#include \"log.h\"",
            "#include \"xmalloc.h\"",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdint.h>",
            "#include <stdarg.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n#include \"xmalloc.h\"\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdint.h>\n#include <stdarg.h>\n#include \"includes.h\"\n\nvoid *\nxmalloc(size_t size)\n{\n\tvoid *ptr;\n\n\tif (size == 0)\n\t\tfatal(\"xmalloc: zero size\");\n\tptr = malloc(size);\n\tif (ptr == NULL)\n\t\tfatal(\"xmalloc: out of memory (allocating %zu bytes)\", size);\n\treturn ptr;\n}"
        }
      },
      {
        "call_info": {
          "callee": "xcalloc",
          "args": [
            "1",
            "sizeof(*k11)"
          ],
          "line": 321
        },
        "resolved": true,
        "details": {
          "function_name": "xcalloc",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/xmalloc.c",
          "lines": "52-66",
          "snippet": "void *\nxcalloc(size_t nmemb, size_t size)\n{\n\tvoid *ptr;\n\n\tif (size == 0 || nmemb == 0)\n\t\tfatal(\"xcalloc: zero size\");\n\tif (SIZE_MAX / nmemb < size)\n\t\tfatal(\"xcalloc: nmemb * size > SIZE_MAX\");\n\tptr = calloc(nmemb, size);\n\tif (ptr == NULL)\n\t\tfatal(\"xcalloc: out of memory (allocating %zu bytes)\",\n\t\t    size * nmemb);\n\treturn ptr;\n}",
          "includes": [
            "#include \"log.h\"",
            "#include \"xmalloc.h\"",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdint.h>",
            "#include <stdarg.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n#include \"xmalloc.h\"\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdint.h>\n#include <stdarg.h>\n#include \"includes.h\"\n\nvoid *\nxcalloc(size_t nmemb, size_t size)\n{\n\tvoid *ptr;\n\n\tif (size == 0 || nmemb == 0)\n\t\tfatal(\"xcalloc: zero size\");\n\tif (SIZE_MAX / nmemb < size)\n\t\tfatal(\"xcalloc: nmemb * size > SIZE_MAX\");\n\tptr = calloc(nmemb, size);\n\tif (ptr == NULL)\n\t\tfatal(\"xcalloc: out of memory (allocating %zu bytes)\",\n\t\t    size * nmemb);\n\treturn ptr;\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_get_default_method",
          "args": [],
          "line": 319
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_rsa_wrap(struct pkcs11_provider *provider, CK_ULONG slotidx,\n    CK_ATTRIBUTE *keyid_attrib, RSA *rsa)\n{\n\tstruct pkcs11_key\t*k11;\n\tconst RSA_METHOD\t*def = RSA_get_default_method();\n\n\tk11 = xcalloc(1, sizeof(*k11));\n\tk11->provider = provider;\n\tprovider->refcount++;\t/* provider referenced by RSA key */\n\tk11->slotidx = slotidx;\n\t/* identify key object on smartcard */\n\tk11->keyid_len = keyid_attrib->ulValueLen;\n\tif (k11->keyid_len > 0) {\n\t\tk11->keyid = xmalloc(k11->keyid_len);\n\t\tmemcpy(k11->keyid, keyid_attrib->pValue, k11->keyid_len);\n\t}\n\tk11->rsa_method = RSA_meth_dup(def);\n\tif (k11->rsa_method == NULL)\n\t\tfatal(\"%s: RSA_meth_dup failed\", __func__);\n\tk11->orig_finish = RSA_meth_get_finish(def);\n\tif (!RSA_meth_set1_name(k11->rsa_method, \"pkcs11\") ||\n\t    !RSA_meth_set_priv_enc(k11->rsa_method,\n\t    pkcs11_rsa_private_encrypt) ||\n\t    !RSA_meth_set_priv_dec(k11->rsa_method,\n\t    pkcs11_rsa_private_decrypt) ||\n\t    !RSA_meth_set_finish(k11->rsa_method, pkcs11_rsa_finish))\n\t\tfatal(\"%s: setup pkcs11 method failed\", __func__);\n\tRSA_set_method(rsa, k11->rsa_method);\n\tRSA_set_app_data(rsa, k11);\n\treturn (0);\n}"
  },
  {
    "function_name": "pkcs11_rsa_private_decrypt",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "306-311",
    "snippet": "static int\npkcs11_rsa_private_decrypt(int flen, const u_char *from, u_char *to, RSA *rsa,\n    int padding)\n{\n\treturn (-1);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_rsa_private_decrypt(int flen, const u_char *from, u_char *to, RSA *rsa,\n    int padding)\n{\n\treturn (-1);\n}"
  },
  {
    "function_name": "pkcs11_rsa_private_encrypt",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "222-304",
    "snippet": "static int\npkcs11_rsa_private_encrypt(int flen, const u_char *from, u_char *to, RSA *rsa,\n    int padding)\n{\n\tstruct pkcs11_key\t*k11;\n\tstruct pkcs11_slotinfo\t*si;\n\tCK_FUNCTION_LIST\t*f;\n\tCK_OBJECT_HANDLE\tobj;\n\tCK_ULONG\t\ttlen = 0;\n\tCK_RV\t\t\trv;\n\tCK_OBJECT_CLASS\tprivate_key_class = CKO_PRIVATE_KEY;\n\tCK_BBOOL\t\ttrue_val = CK_TRUE;\n\tCK_MECHANISM\t\tmech = {\n\t\tCKM_RSA_PKCS, NULL_PTR, 0\n\t};\n\tCK_ATTRIBUTE\t\tkey_filter[] = {\n\t\t{CKA_CLASS, NULL, sizeof(private_key_class) },\n\t\t{CKA_ID, NULL, 0},\n\t\t{CKA_SIGN, NULL, sizeof(true_val) }\n\t};\n\tchar\t\t\t*pin = NULL, prompt[1024];\n\tint\t\t\trval = -1;\n\n\tkey_filter[0].pValue = &private_key_class;\n\tkey_filter[2].pValue = &true_val;\n\n\tif ((k11 = RSA_get_app_data(rsa)) == NULL) {\n\t\terror(\"RSA_get_app_data failed for rsa %p\", rsa);\n\t\treturn (-1);\n\t}\n\tif (!k11->provider || !k11->provider->valid) {\n\t\terror(\"no pkcs11 (valid) provider for rsa %p\", rsa);\n\t\treturn (-1);\n\t}\n\tf = k11->provider->function_list;\n\tsi = &k11->provider->slotinfo[k11->slotidx];\n\tif ((si->token.flags & CKF_LOGIN_REQUIRED) && !si->logged_in) {\n\t\tif (!pkcs11_interactive) {\n\t\t\terror(\"need pin entry%s\", (si->token.flags &\n\t\t\t    CKF_PROTECTED_AUTHENTICATION_PATH) ?\n\t\t\t    \" on reader keypad\" : \"\");\n\t\t\treturn (-1);\n\t\t}\n\t\tif (si->token.flags & CKF_PROTECTED_AUTHENTICATION_PATH)\n\t\t\tverbose(\"Deferring PIN entry to reader keypad.\");\n\t\telse {\n\t\t\tsnprintf(prompt, sizeof(prompt),\n\t\t\t    \"Enter PIN for '%s': \", si->token.label);\n\t\t\tpin = read_passphrase(prompt, RP_ALLOW_EOF);\n\t\t\tif (pin == NULL)\n\t\t\t\treturn (-1);\t/* bail out */\n\t\t}\n\t\trv = f->C_Login(si->session, CKU_USER, (u_char *)pin,\n\t\t    (pin != NULL) ? strlen(pin) : 0);\n\t\tif (pin != NULL) {\n\t\t\texplicit_bzero(pin, strlen(pin));\n\t\t\tfree(pin);\n\t\t}\n\t\tif (rv != CKR_OK && rv != CKR_USER_ALREADY_LOGGED_IN) {\n\t\t\terror(\"C_Login failed: %lu\", rv);\n\t\t\treturn (-1);\n\t\t}\n\t\tsi->logged_in = 1;\n\t}\n\tkey_filter[1].pValue = k11->keyid;\n\tkey_filter[1].ulValueLen = k11->keyid_len;\n\t/* try to find object w/CKA_SIGN first, retry w/o */\n\tif (pkcs11_find(k11->provider, k11->slotidx, key_filter, 3, &obj) < 0 &&\n\t    pkcs11_find(k11->provider, k11->slotidx, key_filter, 2, &obj) < 0) {\n\t\terror(\"cannot find private key\");\n\t} else if ((rv = f->C_SignInit(si->session, &mech, obj)) != CKR_OK) {\n\t\terror(\"C_SignInit failed: %lu\", rv);\n\t} else {\n\t\t/* XXX handle CKR_BUFFER_TOO_SMALL */\n\t\ttlen = RSA_size(rsa);\n\t\trv = f->C_Sign(si->session, (CK_BYTE *)from, flen, to, &tlen);\n\t\tif (rv == CKR_OK) \n\t\t\trval = tlen;\n\t\telse \n\t\t\terror(\"C_Sign failed: %lu\", rv);\n\t}\n\treturn (rval);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "error",
          "args": [
            "\"C_Sign failed: %lu\"",
            "rv"
          ],
          "line": 301
        },
        "resolved": true,
        "details": {
          "function_name": "error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "162-170",
          "snippet": "void\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "f->C_Sign",
          "args": [
            "si->session",
            "(CK_BYTE *)from",
            "flen",
            "to",
            "&tlen"
          ],
          "line": 297
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "RSA_size",
          "args": [
            "rsa"
          ],
          "line": 296
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_SignInit",
          "args": [
            "si->session",
            "&mech",
            "obj"
          ],
          "line": 292
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pkcs11_find",
          "args": [
            "k11->provider",
            "k11->slotidx",
            "key_filter",
            "2",
            "&obj"
          ],
          "line": 290
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_find",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "194-219",
          "snippet": "static int\npkcs11_find(struct pkcs11_provider *p, CK_ULONG slotidx, CK_ATTRIBUTE *attr,\n    CK_ULONG nattr, CK_OBJECT_HANDLE *obj)\n{\n\tCK_FUNCTION_LIST\t*f;\n\tCK_SESSION_HANDLE\tsession;\n\tCK_ULONG\t\tnfound = 0;\n\tCK_RV\t\t\trv;\n\tint\t\t\tret = -1;\n\n\tf = p->function_list;\n\tsession = p->slotinfo[slotidx].session;\n\tif ((rv = f->C_FindObjectsInit(session, attr, nattr)) != CKR_OK) {\n\t\terror(\"C_FindObjectsInit failed (nattr %lu): %lu\", nattr, rv);\n\t\treturn (-1);\n\t}\n\tif ((rv = f->C_FindObjects(session, obj, 1, &nfound)) != CKR_OK ||\n\t    nfound != 1) {\n\t\tdebug(\"C_FindObjects failed (nfound %lu nattr %lu): %lu\",\n\t\t    nfound, nattr, rv);\n\t} else\n\t\tret = 0;\n\tif ((rv = f->C_FindObjectsFinal(session)) != CKR_OK)\n\t\terror(\"C_FindObjectsFinal failed: %lu\", rv);\n\treturn (ret);\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_find(struct pkcs11_provider *p, CK_ULONG slotidx, CK_ATTRIBUTE *attr,\n    CK_ULONG nattr, CK_OBJECT_HANDLE *obj)\n{\n\tCK_FUNCTION_LIST\t*f;\n\tCK_SESSION_HANDLE\tsession;\n\tCK_ULONG\t\tnfound = 0;\n\tCK_RV\t\t\trv;\n\tint\t\t\tret = -1;\n\n\tf = p->function_list;\n\tsession = p->slotinfo[slotidx].session;\n\tif ((rv = f->C_FindObjectsInit(session, attr, nattr)) != CKR_OK) {\n\t\terror(\"C_FindObjectsInit failed (nattr %lu): %lu\", nattr, rv);\n\t\treturn (-1);\n\t}\n\tif ((rv = f->C_FindObjects(session, obj, 1, &nfound)) != CKR_OK ||\n\t    nfound != 1) {\n\t\tdebug(\"C_FindObjects failed (nfound %lu nattr %lu): %lu\",\n\t\t    nfound, nattr, rv);\n\t} else\n\t\tret = 0;\n\tif ((rv = f->C_FindObjectsFinal(session)) != CKR_OK)\n\t\terror(\"C_FindObjectsFinal failed: %lu\", rv);\n\treturn (ret);\n}"
        }
      },
      {
        "call_info": {
          "callee": "free",
          "args": [
            "pin"
          ],
          "line": 278
        },
        "resolved": true,
        "details": {
          "function_name": "freeze",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/smult_curve25519_ref.c",
          "lines": "50-60",
          "snippet": "static void freeze(unsigned int a[32])\n{\n  unsigned int aorig[32];\n  unsigned int j;\n  unsigned int negative;\n\n  for (j = 0;j < 32;++j) aorig[j] = a[j];\n  add(a,a,minusp);\n  negative = -((a[31] >> 7) & 1);\n  for (j = 0;j < 32;++j) a[j] ^= negative & (aorig[j] ^ a[j]);\n}",
          "includes": [],
          "macros_used": [],
          "globals_used": [
            "static const unsigned int minusp[32] = {\n 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128\n} ;"
          ],
          "called_functions": [],
          "contextual_snippet": "static const unsigned int minusp[32] = {\n 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128\n} ;\n\nstatic void freeze(unsigned int a[32])\n{\n  unsigned int aorig[32];\n  unsigned int j;\n  unsigned int negative;\n\n  for (j = 0;j < 32;++j) aorig[j] = a[j];\n  add(a,a,minusp);\n  negative = -((a[31] >> 7) & 1);\n  for (j = 0;j < 32;++j) a[j] ^= negative & (aorig[j] ^ a[j]);\n}"
        }
      },
      {
        "call_info": {
          "callee": "explicit_bzero",
          "args": [
            "pin",
            "strlen(pin)"
          ],
          "line": 277
        },
        "resolved": true,
        "details": {
          "function_name": "explicit_bzero",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/explicit_bzero.c",
          "lines": "36-53",
          "snippet": "void\nexplicit_bzero(void *p, size_t n)\n{\n\tif (n == 0)\n\t\treturn;\n\t/*\n\t * clang -fsanitize=memory needs to intercept memset-like functions\n\t * to correctly detect memory initialisation. Make sure one is called\n\t * directly since our indirection trick above successfully confuses it.\n\t */\n#if defined(__has_feature)\n# if __has_feature(memory_sanitizer)\n\tmemset(p, 0, n);\n# endif\n#endif\n\n\tssh_bzero(p, n);\n}",
          "includes": [
            "#include <string.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <string.h>\n#include \"includes.h\"\n\nvoid\nexplicit_bzero(void *p, size_t n)\n{\n\tif (n == 0)\n\t\treturn;\n\t/*\n\t * clang -fsanitize=memory needs to intercept memset-like functions\n\t * to correctly detect memory initialisation. Make sure one is called\n\t * directly since our indirection trick above successfully confuses it.\n\t */\n#if defined(__has_feature)\n# if __has_feature(memory_sanitizer)\n\tmemset(p, 0, n);\n# endif\n#endif\n\n\tssh_bzero(p, n);\n}"
        }
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "pin"
          ],
          "line": 277
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_Login",
          "args": [
            "si->session",
            "CKU_USER",
            "(u_char *)pin",
            "(pin != NULL) ? strlen(pin) : 0"
          ],
          "line": 274
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "pin"
          ],
          "line": 275
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "read_passphrase",
          "args": [
            "prompt",
            "RP_ALLOW_EOF"
          ],
          "line": 270
        },
        "resolved": true,
        "details": {
          "function_name": "read_passphrase",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/readpass.c",
          "lines": "117-166",
          "snippet": "char *\nread_passphrase(const char *prompt, int flags)\n{\n\tchar *askpass = NULL, *ret, buf[1024];\n\tint rppflags, use_askpass = 0, ttyfd;\n\n\trppflags = (flags & RP_ECHO) ? RPP_ECHO_ON : RPP_ECHO_OFF;\n\tif (flags & RP_USE_ASKPASS)\n\t\tuse_askpass = 1;\n\telse if (flags & RP_ALLOW_STDIN) {\n\t\tif (!isatty(STDIN_FILENO)) {\n\t\t\tdebug(\"read_passphrase: stdin is not a tty\");\n\t\t\tuse_askpass = 1;\n\t\t}\n\t} else {\n\t\trppflags |= RPP_REQUIRE_TTY;\n\t\tttyfd = open(_PATH_TTY, O_RDWR);\n\t\tif (ttyfd >= 0)\n\t\t\tclose(ttyfd);\n\t\telse {\n\t\t\tdebug(\"read_passphrase: can't open %s: %s\", _PATH_TTY,\n\t\t\t    strerror(errno));\n\t\t\tuse_askpass = 1;\n\t\t}\n\t}\n\n\tif ((flags & RP_USE_ASKPASS) && getenv(\"DISPLAY\") == NULL)\n\t\treturn (flags & RP_ALLOW_EOF) ? NULL : xstrdup(\"\");\n\n\tif (use_askpass && getenv(\"DISPLAY\")) {\n\t\tif (getenv(SSH_ASKPASS_ENV))\n\t\t\taskpass = getenv(SSH_ASKPASS_ENV);\n\t\telse\n\t\t\taskpass = _PATH_SSH_ASKPASS_DEFAULT;\n\t\tif ((ret = ssh_askpass(askpass, prompt)) == NULL)\n\t\t\tif (!(flags & RP_ALLOW_EOF))\n\t\t\t\treturn xstrdup(\"\");\n\t\treturn ret;\n\t}\n\n\tif (readpassphrase(prompt, buf, sizeof buf, rppflags) == NULL) {\n\t\tif (flags & RP_ALLOW_EOF)\n\t\t\treturn NULL;\n\t\treturn xstrdup(\"\");\n\t}\n\n\tret = xstrdup(buf);\n\texplicit_bzero(buf, sizeof(buf));\n\treturn ret;\n}",
          "includes": [
            "#include \"uidswap.h\"",
            "#include \"ssh.h\"",
            "#include \"log.h\"",
            "#include \"pathnames.h\"",
            "#include \"misc.h\"",
            "#include \"xmalloc.h\"",
            "#include <unistd.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <signal.h>",
            "# include <paths.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <sys/wait.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"uidswap.h\"\n#include \"ssh.h\"\n#include \"log.h\"\n#include \"pathnames.h\"\n#include \"misc.h\"\n#include \"xmalloc.h\"\n#include <unistd.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <signal.h>\n# include <paths.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <sys/wait.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nchar *\nread_passphrase(const char *prompt, int flags)\n{\n\tchar *askpass = NULL, *ret, buf[1024];\n\tint rppflags, use_askpass = 0, ttyfd;\n\n\trppflags = (flags & RP_ECHO) ? RPP_ECHO_ON : RPP_ECHO_OFF;\n\tif (flags & RP_USE_ASKPASS)\n\t\tuse_askpass = 1;\n\telse if (flags & RP_ALLOW_STDIN) {\n\t\tif (!isatty(STDIN_FILENO)) {\n\t\t\tdebug(\"read_passphrase: stdin is not a tty\");\n\t\t\tuse_askpass = 1;\n\t\t}\n\t} else {\n\t\trppflags |= RPP_REQUIRE_TTY;\n\t\tttyfd = open(_PATH_TTY, O_RDWR);\n\t\tif (ttyfd >= 0)\n\t\t\tclose(ttyfd);\n\t\telse {\n\t\t\tdebug(\"read_passphrase: can't open %s: %s\", _PATH_TTY,\n\t\t\t    strerror(errno));\n\t\t\tuse_askpass = 1;\n\t\t}\n\t}\n\n\tif ((flags & RP_USE_ASKPASS) && getenv(\"DISPLAY\") == NULL)\n\t\treturn (flags & RP_ALLOW_EOF) ? NULL : xstrdup(\"\");\n\n\tif (use_askpass && getenv(\"DISPLAY\")) {\n\t\tif (getenv(SSH_ASKPASS_ENV))\n\t\t\taskpass = getenv(SSH_ASKPASS_ENV);\n\t\telse\n\t\t\taskpass = _PATH_SSH_ASKPASS_DEFAULT;\n\t\tif ((ret = ssh_askpass(askpass, prompt)) == NULL)\n\t\t\tif (!(flags & RP_ALLOW_EOF))\n\t\t\t\treturn xstrdup(\"\");\n\t\treturn ret;\n\t}\n\n\tif (readpassphrase(prompt, buf, sizeof buf, rppflags) == NULL) {\n\t\tif (flags & RP_ALLOW_EOF)\n\t\t\treturn NULL;\n\t\treturn xstrdup(\"\");\n\t}\n\n\tret = xstrdup(buf);\n\texplicit_bzero(buf, sizeof(buf));\n\treturn ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "snprintf",
          "args": [
            "prompt",
            "sizeof(prompt)",
            "\"Enter PIN for '%s': \"",
            "si->token.label"
          ],
          "line": 268
        },
        "resolved": true,
        "details": {
          "function_name": "snprintf",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/bsd-snprintf.c",
          "lines": "869-879",
          "snippet": "int\nsnprintf(char *str, size_t count, SNPRINTF_CONST char *fmt, ...)\n{\n\tsize_t ret;\n\tva_list ap;\n\n\tva_start(ap, fmt);\n\tret = vsnprintf(str, count, fmt, ap);\n\tva_end(ap);\n\treturn ret;\n}",
          "includes": [
            "#include <errno.h>",
            "#include <limits.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdarg.h>",
            "#include <ctype.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <errno.h>\n#include <limits.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdarg.h>\n#include <ctype.h>\n#include \"includes.h\"\n\nint\nsnprintf(char *str, size_t count, SNPRINTF_CONST char *fmt, ...)\n{\n\tsize_t ret;\n\tva_list ap;\n\n\tva_start(ap, fmt);\n\tret = vsnprintf(str, count, fmt, ap);\n\tva_end(ap);\n\treturn ret;\n}"
        }
      },
      {
        "call_info": {
          "callee": "verbose",
          "args": [
            "\"Deferring PIN entry to reader keypad.\""
          ],
          "line": 266
        },
        "resolved": true,
        "details": {
          "function_name": "verbose",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "210-218",
          "snippet": "void\nverbose(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_VERBOSE, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nverbose(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_VERBOSE, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_get_app_data",
          "args": [
            "rsa"
          ],
          "line": 248
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_rsa_private_encrypt(int flen, const u_char *from, u_char *to, RSA *rsa,\n    int padding)\n{\n\tstruct pkcs11_key\t*k11;\n\tstruct pkcs11_slotinfo\t*si;\n\tCK_FUNCTION_LIST\t*f;\n\tCK_OBJECT_HANDLE\tobj;\n\tCK_ULONG\t\ttlen = 0;\n\tCK_RV\t\t\trv;\n\tCK_OBJECT_CLASS\tprivate_key_class = CKO_PRIVATE_KEY;\n\tCK_BBOOL\t\ttrue_val = CK_TRUE;\n\tCK_MECHANISM\t\tmech = {\n\t\tCKM_RSA_PKCS, NULL_PTR, 0\n\t};\n\tCK_ATTRIBUTE\t\tkey_filter[] = {\n\t\t{CKA_CLASS, NULL, sizeof(private_key_class) },\n\t\t{CKA_ID, NULL, 0},\n\t\t{CKA_SIGN, NULL, sizeof(true_val) }\n\t};\n\tchar\t\t\t*pin = NULL, prompt[1024];\n\tint\t\t\trval = -1;\n\n\tkey_filter[0].pValue = &private_key_class;\n\tkey_filter[2].pValue = &true_val;\n\n\tif ((k11 = RSA_get_app_data(rsa)) == NULL) {\n\t\terror(\"RSA_get_app_data failed for rsa %p\", rsa);\n\t\treturn (-1);\n\t}\n\tif (!k11->provider || !k11->provider->valid) {\n\t\terror(\"no pkcs11 (valid) provider for rsa %p\", rsa);\n\t\treturn (-1);\n\t}\n\tf = k11->provider->function_list;\n\tsi = &k11->provider->slotinfo[k11->slotidx];\n\tif ((si->token.flags & CKF_LOGIN_REQUIRED) && !si->logged_in) {\n\t\tif (!pkcs11_interactive) {\n\t\t\terror(\"need pin entry%s\", (si->token.flags &\n\t\t\t    CKF_PROTECTED_AUTHENTICATION_PATH) ?\n\t\t\t    \" on reader keypad\" : \"\");\n\t\t\treturn (-1);\n\t\t}\n\t\tif (si->token.flags & CKF_PROTECTED_AUTHENTICATION_PATH)\n\t\t\tverbose(\"Deferring PIN entry to reader keypad.\");\n\t\telse {\n\t\t\tsnprintf(prompt, sizeof(prompt),\n\t\t\t    \"Enter PIN for '%s': \", si->token.label);\n\t\t\tpin = read_passphrase(prompt, RP_ALLOW_EOF);\n\t\t\tif (pin == NULL)\n\t\t\t\treturn (-1);\t/* bail out */\n\t\t}\n\t\trv = f->C_Login(si->session, CKU_USER, (u_char *)pin,\n\t\t    (pin != NULL) ? strlen(pin) : 0);\n\t\tif (pin != NULL) {\n\t\t\texplicit_bzero(pin, strlen(pin));\n\t\t\tfree(pin);\n\t\t}\n\t\tif (rv != CKR_OK && rv != CKR_USER_ALREADY_LOGGED_IN) {\n\t\t\terror(\"C_Login failed: %lu\", rv);\n\t\t\treturn (-1);\n\t\t}\n\t\tsi->logged_in = 1;\n\t}\n\tkey_filter[1].pValue = k11->keyid;\n\tkey_filter[1].ulValueLen = k11->keyid_len;\n\t/* try to find object w/CKA_SIGN first, retry w/o */\n\tif (pkcs11_find(k11->provider, k11->slotidx, key_filter, 3, &obj) < 0 &&\n\t    pkcs11_find(k11->provider, k11->slotidx, key_filter, 2, &obj) < 0) {\n\t\terror(\"cannot find private key\");\n\t} else if ((rv = f->C_SignInit(si->session, &mech, obj)) != CKR_OK) {\n\t\terror(\"C_SignInit failed: %lu\", rv);\n\t} else {\n\t\t/* XXX handle CKR_BUFFER_TOO_SMALL */\n\t\ttlen = RSA_size(rsa);\n\t\trv = f->C_Sign(si->session, (CK_BYTE *)from, flen, to, &tlen);\n\t\tif (rv == CKR_OK) \n\t\t\trval = tlen;\n\t\telse \n\t\t\terror(\"C_Sign failed: %lu\", rv);\n\t}\n\treturn (rval);\n}"
  },
  {
    "function_name": "pkcs11_find",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "194-219",
    "snippet": "static int\npkcs11_find(struct pkcs11_provider *p, CK_ULONG slotidx, CK_ATTRIBUTE *attr,\n    CK_ULONG nattr, CK_OBJECT_HANDLE *obj)\n{\n\tCK_FUNCTION_LIST\t*f;\n\tCK_SESSION_HANDLE\tsession;\n\tCK_ULONG\t\tnfound = 0;\n\tCK_RV\t\t\trv;\n\tint\t\t\tret = -1;\n\n\tf = p->function_list;\n\tsession = p->slotinfo[slotidx].session;\n\tif ((rv = f->C_FindObjectsInit(session, attr, nattr)) != CKR_OK) {\n\t\terror(\"C_FindObjectsInit failed (nattr %lu): %lu\", nattr, rv);\n\t\treturn (-1);\n\t}\n\tif ((rv = f->C_FindObjects(session, obj, 1, &nfound)) != CKR_OK ||\n\t    nfound != 1) {\n\t\tdebug(\"C_FindObjects failed (nfound %lu nattr %lu): %lu\",\n\t\t    nfound, nattr, rv);\n\t} else\n\t\tret = 0;\n\tif ((rv = f->C_FindObjectsFinal(session)) != CKR_OK)\n\t\terror(\"C_FindObjectsFinal failed: %lu\", rv);\n\treturn (ret);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "error",
          "args": [
            "\"C_FindObjectsFinal failed: %lu\"",
            "rv"
          ],
          "line": 217
        },
        "resolved": true,
        "details": {
          "function_name": "error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "162-170",
          "snippet": "void\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "f->C_FindObjectsFinal",
          "args": [
            "session"
          ],
          "line": 216
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "debug",
          "args": [
            "\"C_FindObjects failed (nfound %lu nattr %lu): %lu\"",
            "nfound",
            "nattr",
            "rv"
          ],
          "line": 212
        },
        "resolved": true,
        "details": {
          "function_name": "debug3",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "242-250",
          "snippet": "void\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "f->C_FindObjects",
          "args": [
            "session",
            "obj",
            "1",
            "&nfound"
          ],
          "line": 210
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "f->C_FindObjectsInit",
          "args": [
            "session",
            "attr",
            "nattr"
          ],
          "line": 206
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_find(struct pkcs11_provider *p, CK_ULONG slotidx, CK_ATTRIBUTE *attr,\n    CK_ULONG nattr, CK_OBJECT_HANDLE *obj)\n{\n\tCK_FUNCTION_LIST\t*f;\n\tCK_SESSION_HANDLE\tsession;\n\tCK_ULONG\t\tnfound = 0;\n\tCK_RV\t\t\trv;\n\tint\t\t\tret = -1;\n\n\tf = p->function_list;\n\tsession = p->slotinfo[slotidx].session;\n\tif ((rv = f->C_FindObjectsInit(session, attr, nattr)) != CKR_OK) {\n\t\terror(\"C_FindObjectsInit failed (nattr %lu): %lu\", nattr, rv);\n\t\treturn (-1);\n\t}\n\tif ((rv = f->C_FindObjects(session, obj, 1, &nfound)) != CKR_OK ||\n\t    nfound != 1) {\n\t\tdebug(\"C_FindObjects failed (nfound %lu nattr %lu): %lu\",\n\t\t    nfound, nattr, rv);\n\t} else\n\t\tret = 0;\n\tif ((rv = f->C_FindObjectsFinal(session)) != CKR_OK)\n\t\terror(\"C_FindObjectsFinal failed: %lu\", rv);\n\treturn (ret);\n}"
  },
  {
    "function_name": "pkcs11_rsa_finish",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "175-191",
    "snippet": "static int\npkcs11_rsa_finish(RSA *rsa)\n{\n\tstruct pkcs11_key\t*k11;\n\tint rv = -1;\n\n\tif ((k11 = RSA_get_app_data(rsa)) != NULL) {\n\t\tif (k11->orig_finish)\n\t\t\trv = k11->orig_finish(rsa);\n\t\tif (k11->provider)\n\t\t\tpkcs11_provider_unref(k11->provider);\n\t\tRSA_meth_free(k11->rsa_method);\n\t\tfree(k11->keyid);\n\t\tfree(k11);\n\t}\n\treturn (rv);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "k11"
          ],
          "line": 188
        },
        "resolved": true,
        "details": {
          "function_name": "freeze",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/smult_curve25519_ref.c",
          "lines": "50-60",
          "snippet": "static void freeze(unsigned int a[32])\n{\n  unsigned int aorig[32];\n  unsigned int j;\n  unsigned int negative;\n\n  for (j = 0;j < 32;++j) aorig[j] = a[j];\n  add(a,a,minusp);\n  negative = -((a[31] >> 7) & 1);\n  for (j = 0;j < 32;++j) a[j] ^= negative & (aorig[j] ^ a[j]);\n}",
          "includes": [],
          "macros_used": [],
          "globals_used": [
            "static const unsigned int minusp[32] = {\n 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128\n} ;"
          ],
          "called_functions": [],
          "contextual_snippet": "static const unsigned int minusp[32] = {\n 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128\n} ;\n\nstatic void freeze(unsigned int a[32])\n{\n  unsigned int aorig[32];\n  unsigned int j;\n  unsigned int negative;\n\n  for (j = 0;j < 32;++j) aorig[j] = a[j];\n  add(a,a,minusp);\n  negative = -((a[31] >> 7) & 1);\n  for (j = 0;j < 32;++j) a[j] ^= negative & (aorig[j] ^ a[j]);\n}"
        }
      },
      {
        "call_info": {
          "callee": "RSA_meth_free",
          "args": [
            "k11->rsa_method"
          ],
          "line": 186
        },
        "resolved": true,
        "details": {
          "function_name": "RSA_meth_free",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/openbsd-compat/libressl-api-compat.c",
          "lines": "528-535",
          "snippet": "void\nRSA_meth_free(RSA_METHOD *meth)\n{\n\tif (meth != NULL) {\n\t\tfree((char *)meth->name);\n\t\tfree(meth);\n\t}\n}",
          "includes": [
            "#include <openssl/dh.h>",
            "#include <openssl/ecdsa.h>",
            "#include <openssl/evp.h>",
            "#include <openssl/rsa.h>",
            "#include <openssl/dsa.h>",
            "#include <openssl/bn.h>",
            "#include <openssl/err.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <openssl/dh.h>\n#include <openssl/ecdsa.h>\n#include <openssl/evp.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/bn.h>\n#include <openssl/err.h>\n#include <string.h>\n#include <stdlib.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nRSA_meth_free(RSA_METHOD *meth)\n{\n\tif (meth != NULL) {\n\t\tfree((char *)meth->name);\n\t\tfree(meth);\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "pkcs11_provider_unref",
          "args": [
            "k11->provider"
          ],
          "line": 185
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_provider_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "119-130",
          "snippet": "static void\npkcs11_provider_unref(struct pkcs11_provider *p)\n{\n\tdebug(\"pkcs11_provider_unref: %p refcount %d\", p, p->refcount);\n\tif (--p->refcount <= 0) {\n\t\tif (p->valid)\n\t\t\terror(\"pkcs11_provider_unref: %p still valid\", p);\n\t\tfree(p->slotlist);\n\t\tfree(p->slotinfo);\n\t\tfree(p);\n\t}\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\npkcs11_provider_unref(struct pkcs11_provider *p)\n{\n\tdebug(\"pkcs11_provider_unref: %p refcount %d\", p, p->refcount);\n\tif (--p->refcount <= 0) {\n\t\tif (p->valid)\n\t\t\terror(\"pkcs11_provider_unref: %p still valid\", p);\n\t\tfree(p->slotlist);\n\t\tfree(p->slotinfo);\n\t\tfree(p);\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "k11->orig_finish",
          "args": [
            "rsa"
          ],
          "line": 183
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "RSA_get_app_data",
          "args": [
            "rsa"
          ],
          "line": 181
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\npkcs11_rsa_finish(RSA *rsa)\n{\n\tstruct pkcs11_key\t*k11;\n\tint rv = -1;\n\n\tif ((k11 = RSA_get_app_data(rsa)) != NULL) {\n\t\tif (k11->orig_finish)\n\t\t\trv = k11->orig_finish(rsa);\n\t\tif (k11->provider)\n\t\t\tpkcs11_provider_unref(k11->provider);\n\t\tRSA_meth_free(k11->rsa_method);\n\t\tfree(k11->keyid);\n\t\tfree(k11);\n\t}\n\treturn (rv);\n}"
  },
  {
    "function_name": "pkcs11_del_provider",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "160-172",
    "snippet": "int\npkcs11_del_provider(char *provider_id)\n{\n\tstruct pkcs11_provider *p;\n\n\tif ((p = pkcs11_provider_lookup(provider_id)) != NULL) {\n\t\tTAILQ_REMOVE(&pkcs11_providers, p, next);\n\t\tpkcs11_provider_finalize(p);\n\t\tpkcs11_provider_unref(p);\n\t\treturn (0);\n\t}\n\treturn (-1);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "pkcs11_provider_unref",
          "args": [
            "p"
          ],
          "line": 168
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_provider_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "119-130",
          "snippet": "static void\npkcs11_provider_unref(struct pkcs11_provider *p)\n{\n\tdebug(\"pkcs11_provider_unref: %p refcount %d\", p, p->refcount);\n\tif (--p->refcount <= 0) {\n\t\tif (p->valid)\n\t\t\terror(\"pkcs11_provider_unref: %p still valid\", p);\n\t\tfree(p->slotlist);\n\t\tfree(p->slotinfo);\n\t\tfree(p);\n\t}\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\npkcs11_provider_unref(struct pkcs11_provider *p)\n{\n\tdebug(\"pkcs11_provider_unref: %p refcount %d\", p, p->refcount);\n\tif (--p->refcount <= 0) {\n\t\tif (p->valid)\n\t\t\terror(\"pkcs11_provider_unref: %p still valid\", p);\n\t\tfree(p->slotlist);\n\t\tfree(p->slotinfo);\n\t\tfree(p);\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "pkcs11_provider_finalize",
          "args": [
            "p"
          ],
          "line": 167
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_provider_finalize",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "92-113",
          "snippet": "static void\npkcs11_provider_finalize(struct pkcs11_provider *p)\n{\n\tCK_RV rv;\n\tCK_ULONG i;\n\n\tdebug(\"pkcs11_provider_finalize: %p refcount %d valid %d\",\n\t    p, p->refcount, p->valid);\n\tif (!p->valid)\n\t\treturn;\n\tfor (i = 0; i < p->nslots; i++) {\n\t\tif (p->slotinfo[i].session &&\n\t\t    (rv = p->function_list->C_CloseSession(\n\t\t    p->slotinfo[i].session)) != CKR_OK)\n\t\t\terror(\"C_CloseSession failed: %lu\", rv);\n\t}\n\tif ((rv = p->function_list->C_Finalize(NULL)) != CKR_OK)\n\t\terror(\"C_Finalize failed: %lu\", rv);\n\tp->valid = 0;\n\tp->function_list = NULL;\n\tdlclose(p->handle);\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\npkcs11_provider_finalize(struct pkcs11_provider *p)\n{\n\tCK_RV rv;\n\tCK_ULONG i;\n\n\tdebug(\"pkcs11_provider_finalize: %p refcount %d valid %d\",\n\t    p, p->refcount, p->valid);\n\tif (!p->valid)\n\t\treturn;\n\tfor (i = 0; i < p->nslots; i++) {\n\t\tif (p->slotinfo[i].session &&\n\t\t    (rv = p->function_list->C_CloseSession(\n\t\t    p->slotinfo[i].session)) != CKR_OK)\n\t\t\terror(\"C_CloseSession failed: %lu\", rv);\n\t}\n\tif ((rv = p->function_list->C_Finalize(NULL)) != CKR_OK)\n\t\terror(\"C_Finalize failed: %lu\", rv);\n\tp->valid = 0;\n\tp->function_list = NULL;\n\tdlclose(p->handle);\n}"
        }
      },
      {
        "call_info": {
          "callee": "TAILQ_REMOVE",
          "args": [
            "&pkcs11_providers",
            "p",
            "next"
          ],
          "line": 166
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "pkcs11_provider_lookup",
          "args": [
            "provider_id"
          ],
          "line": 165
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_provider_lookup",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "146-157",
          "snippet": "static struct pkcs11_provider *\npkcs11_provider_lookup(char *provider_id)\n{\n\tstruct pkcs11_provider *p;\n\n\tTAILQ_FOREACH(p, &pkcs11_providers, next) {\n\t\tdebug(\"check %p %s\", p, p->name);\n\t\tif (!strcmp(provider_id, p->name))\n\t\t\treturn (p);\n\t}\n\treturn (NULL);\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic struct pkcs11_provider *\npkcs11_provider_lookup(char *provider_id)\n{\n\tstruct pkcs11_provider *p;\n\n\tTAILQ_FOREACH(p, &pkcs11_providers, next) {\n\t\tdebug(\"check %p %s\", p, p->name);\n\t\tif (!strcmp(provider_id, p->name))\n\t\t\treturn (p);\n\t}\n\treturn (NULL);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\npkcs11_del_provider(char *provider_id)\n{\n\tstruct pkcs11_provider *p;\n\n\tif ((p = pkcs11_provider_lookup(provider_id)) != NULL) {\n\t\tTAILQ_REMOVE(&pkcs11_providers, p, next);\n\t\tpkcs11_provider_finalize(p);\n\t\tpkcs11_provider_unref(p);\n\t\treturn (0);\n\t}\n\treturn (-1);\n}"
  },
  {
    "function_name": "pkcs11_provider_lookup",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "146-157",
    "snippet": "static struct pkcs11_provider *\npkcs11_provider_lookup(char *provider_id)\n{\n\tstruct pkcs11_provider *p;\n\n\tTAILQ_FOREACH(p, &pkcs11_providers, next) {\n\t\tdebug(\"check %p %s\", p, p->name);\n\t\tif (!strcmp(provider_id, p->name))\n\t\t\treturn (p);\n\t}\n\treturn (NULL);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "strcmp",
          "args": [
            "provider_id",
            "p->name"
          ],
          "line": 153
        },
        "resolved": true,
        "details": {
          "function_name": "strcmp_maybe_null",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/misc.c",
          "lines": "1550-1558",
          "snippet": "static int\nstrcmp_maybe_null(const char *a, const char *b)\n{\n\tif ((a == NULL && b != NULL) || (a != NULL && b == NULL))\n\t\treturn 0;\n\tif (a != NULL && strcmp(a, b) != 0)\n\t\treturn 0;\n\treturn 1;\n}",
          "includes": [
            "#include \"platform.h\"",
            "#include \"ssherr.h\"",
            "#include \"sshbuf.h\"",
            "#include \"ssh.h\"",
            "#include \"log.h\"",
            "#include \"misc.h\"",
            "#include \"xmalloc.h\"",
            "#include <net/if.h>",
            "#include <pwd.h>",
            "# include <paths.h>",
            "#include <netdb.h>",
            "#include <fcntl.h>",
            "#include <errno.h>",
            "#include <ctype.h>",
            "#include <arpa/inet.h>",
            "#include <netinet/tcp.h>",
            "#include <netinet/ip.h>",
            "#include <netinet/in_systm.h>",
            "#include <netinet/in.h>",
            "#include <unistd.h>",
            "#include <time.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <signal.h>",
            "# include <libgen.h>",
            "#include <limits.h>",
            "#include <sys/un.h>",
            "#include <sys/wait.h>",
            "#include <sys/time.h>",
            "#include <sys/stat.h>",
            "#include <sys/socket.h>",
            "#include <sys/ioctl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"platform.h\"\n#include \"ssherr.h\"\n#include \"sshbuf.h\"\n#include \"ssh.h\"\n#include \"log.h\"\n#include \"misc.h\"\n#include \"xmalloc.h\"\n#include <net/if.h>\n#include <pwd.h>\n# include <paths.h>\n#include <netdb.h>\n#include <fcntl.h>\n#include <errno.h>\n#include <ctype.h>\n#include <arpa/inet.h>\n#include <netinet/tcp.h>\n#include <netinet/ip.h>\n#include <netinet/in_systm.h>\n#include <netinet/in.h>\n#include <unistd.h>\n#include <time.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <signal.h>\n# include <libgen.h>\n#include <limits.h>\n#include <sys/un.h>\n#include <sys/wait.h>\n#include <sys/time.h>\n#include <sys/stat.h>\n#include <sys/socket.h>\n#include <sys/ioctl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic int\nstrcmp_maybe_null(const char *a, const char *b)\n{\n\tif ((a == NULL && b != NULL) || (a != NULL && b == NULL))\n\t\treturn 0;\n\tif (a != NULL && strcmp(a, b) != 0)\n\t\treturn 0;\n\treturn 1;\n}"
        }
      },
      {
        "call_info": {
          "callee": "debug",
          "args": [
            "\"check %p %s\"",
            "p",
            "p->name"
          ],
          "line": 152
        },
        "resolved": true,
        "details": {
          "function_name": "debug3",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "242-250",
          "snippet": "void\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "TAILQ_FOREACH",
          "args": [
            "p",
            "&pkcs11_providers",
            "next"
          ],
          "line": 151
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic struct pkcs11_provider *\npkcs11_provider_lookup(char *provider_id)\n{\n\tstruct pkcs11_provider *p;\n\n\tTAILQ_FOREACH(p, &pkcs11_providers, next) {\n\t\tdebug(\"check %p %s\", p, p->name);\n\t\tif (!strcmp(provider_id, p->name))\n\t\t\treturn (p);\n\t}\n\treturn (NULL);\n}"
  },
  {
    "function_name": "pkcs11_terminate",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "133-143",
    "snippet": "void\npkcs11_terminate(void)\n{\n\tstruct pkcs11_provider *p;\n\n\twhile ((p = TAILQ_FIRST(&pkcs11_providers)) != NULL) {\n\t\tTAILQ_REMOVE(&pkcs11_providers, p, next);\n\t\tpkcs11_provider_finalize(p);\n\t\tpkcs11_provider_unref(p);\n\t}\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "pkcs11_provider_unref",
          "args": [
            "p"
          ],
          "line": 141
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_provider_unref",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "119-130",
          "snippet": "static void\npkcs11_provider_unref(struct pkcs11_provider *p)\n{\n\tdebug(\"pkcs11_provider_unref: %p refcount %d\", p, p->refcount);\n\tif (--p->refcount <= 0) {\n\t\tif (p->valid)\n\t\t\terror(\"pkcs11_provider_unref: %p still valid\", p);\n\t\tfree(p->slotlist);\n\t\tfree(p->slotinfo);\n\t\tfree(p);\n\t}\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\npkcs11_provider_unref(struct pkcs11_provider *p)\n{\n\tdebug(\"pkcs11_provider_unref: %p refcount %d\", p, p->refcount);\n\tif (--p->refcount <= 0) {\n\t\tif (p->valid)\n\t\t\terror(\"pkcs11_provider_unref: %p still valid\", p);\n\t\tfree(p->slotlist);\n\t\tfree(p->slotinfo);\n\t\tfree(p);\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "pkcs11_provider_finalize",
          "args": [
            "p"
          ],
          "line": 140
        },
        "resolved": true,
        "details": {
          "function_name": "pkcs11_provider_finalize",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
          "lines": "92-113",
          "snippet": "static void\npkcs11_provider_finalize(struct pkcs11_provider *p)\n{\n\tCK_RV rv;\n\tCK_ULONG i;\n\n\tdebug(\"pkcs11_provider_finalize: %p refcount %d valid %d\",\n\t    p, p->refcount, p->valid);\n\tif (!p->valid)\n\t\treturn;\n\tfor (i = 0; i < p->nslots; i++) {\n\t\tif (p->slotinfo[i].session &&\n\t\t    (rv = p->function_list->C_CloseSession(\n\t\t    p->slotinfo[i].session)) != CKR_OK)\n\t\t\terror(\"C_CloseSession failed: %lu\", rv);\n\t}\n\tif ((rv = p->function_list->C_Finalize(NULL)) != CKR_OK)\n\t\terror(\"C_Finalize failed: %lu\", rv);\n\tp->valid = 0;\n\tp->function_list = NULL;\n\tdlclose(p->handle);\n}",
          "includes": [
            "#include \"xmalloc.h\"",
            "#include \"ssh-pkcs11.h\"",
            "#include \"sshkey.h\"",
            "#include \"misc.h\"",
            "#include \"log.h\"",
            "#include \"pkcs11.h\"",
            "#include <openssl/x509.h>",
            "#include \"openbsd-compat/openssl-compat.h\"",
            "#include \"openbsd-compat/sys-queue.h\"",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "# include <sys/time.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\npkcs11_provider_finalize(struct pkcs11_provider *p)\n{\n\tCK_RV rv;\n\tCK_ULONG i;\n\n\tdebug(\"pkcs11_provider_finalize: %p refcount %d valid %d\",\n\t    p, p->refcount, p->valid);\n\tif (!p->valid)\n\t\treturn;\n\tfor (i = 0; i < p->nslots; i++) {\n\t\tif (p->slotinfo[i].session &&\n\t\t    (rv = p->function_list->C_CloseSession(\n\t\t    p->slotinfo[i].session)) != CKR_OK)\n\t\t\terror(\"C_CloseSession failed: %lu\", rv);\n\t}\n\tif ((rv = p->function_list->C_Finalize(NULL)) != CKR_OK)\n\t\terror(\"C_Finalize failed: %lu\", rv);\n\tp->valid = 0;\n\tp->function_list = NULL;\n\tdlclose(p->handle);\n}"
        }
      },
      {
        "call_info": {
          "callee": "TAILQ_REMOVE",
          "args": [
            "&pkcs11_providers",
            "p",
            "next"
          ],
          "line": 139
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "TAILQ_FIRST",
          "args": [
            "&pkcs11_providers"
          ],
          "line": 138
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\npkcs11_terminate(void)\n{\n\tstruct pkcs11_provider *p;\n\n\twhile ((p = TAILQ_FIRST(&pkcs11_providers)) != NULL) {\n\t\tTAILQ_REMOVE(&pkcs11_providers, p, next);\n\t\tpkcs11_provider_finalize(p);\n\t\tpkcs11_provider_unref(p);\n\t}\n}"
  },
  {
    "function_name": "pkcs11_provider_unref",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "119-130",
    "snippet": "static void\npkcs11_provider_unref(struct pkcs11_provider *p)\n{\n\tdebug(\"pkcs11_provider_unref: %p refcount %d\", p, p->refcount);\n\tif (--p->refcount <= 0) {\n\t\tif (p->valid)\n\t\t\terror(\"pkcs11_provider_unref: %p still valid\", p);\n\t\tfree(p->slotlist);\n\t\tfree(p->slotinfo);\n\t\tfree(p);\n\t}\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "free",
          "args": [
            "p"
          ],
          "line": 128
        },
        "resolved": true,
        "details": {
          "function_name": "freeze",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/smult_curve25519_ref.c",
          "lines": "50-60",
          "snippet": "static void freeze(unsigned int a[32])\n{\n  unsigned int aorig[32];\n  unsigned int j;\n  unsigned int negative;\n\n  for (j = 0;j < 32;++j) aorig[j] = a[j];\n  add(a,a,minusp);\n  negative = -((a[31] >> 7) & 1);\n  for (j = 0;j < 32;++j) a[j] ^= negative & (aorig[j] ^ a[j]);\n}",
          "includes": [],
          "macros_used": [],
          "globals_used": [
            "static const unsigned int minusp[32] = {\n 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128\n} ;"
          ],
          "called_functions": [],
          "contextual_snippet": "static const unsigned int minusp[32] = {\n 19, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 128\n} ;\n\nstatic void freeze(unsigned int a[32])\n{\n  unsigned int aorig[32];\n  unsigned int j;\n  unsigned int negative;\n\n  for (j = 0;j < 32;++j) aorig[j] = a[j];\n  add(a,a,minusp);\n  negative = -((a[31] >> 7) & 1);\n  for (j = 0;j < 32;++j) a[j] ^= negative & (aorig[j] ^ a[j]);\n}"
        }
      },
      {
        "call_info": {
          "callee": "error",
          "args": [
            "\"pkcs11_provider_unref: %p still valid\"",
            "p"
          ],
          "line": 125
        },
        "resolved": true,
        "details": {
          "function_name": "error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "162-170",
          "snippet": "void\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "debug",
          "args": [
            "\"pkcs11_provider_unref: %p refcount %d\"",
            "p",
            "p->refcount"
          ],
          "line": 122
        },
        "resolved": true,
        "details": {
          "function_name": "debug3",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "242-250",
          "snippet": "void\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\npkcs11_provider_unref(struct pkcs11_provider *p)\n{\n\tdebug(\"pkcs11_provider_unref: %p refcount %d\", p, p->refcount);\n\tif (--p->refcount <= 0) {\n\t\tif (p->valid)\n\t\t\terror(\"pkcs11_provider_unref: %p still valid\", p);\n\t\tfree(p->slotlist);\n\t\tfree(p->slotinfo);\n\t\tfree(p);\n\t}\n}"
  },
  {
    "function_name": "pkcs11_provider_finalize",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "92-113",
    "snippet": "static void\npkcs11_provider_finalize(struct pkcs11_provider *p)\n{\n\tCK_RV rv;\n\tCK_ULONG i;\n\n\tdebug(\"pkcs11_provider_finalize: %p refcount %d valid %d\",\n\t    p, p->refcount, p->valid);\n\tif (!p->valid)\n\t\treturn;\n\tfor (i = 0; i < p->nslots; i++) {\n\t\tif (p->slotinfo[i].session &&\n\t\t    (rv = p->function_list->C_CloseSession(\n\t\t    p->slotinfo[i].session)) != CKR_OK)\n\t\t\terror(\"C_CloseSession failed: %lu\", rv);\n\t}\n\tif ((rv = p->function_list->C_Finalize(NULL)) != CKR_OK)\n\t\terror(\"C_Finalize failed: %lu\", rv);\n\tp->valid = 0;\n\tp->function_list = NULL;\n\tdlclose(p->handle);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "dlclose",
          "args": [
            "p->handle"
          ],
          "line": 112
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "error",
          "args": [
            "\"C_Finalize failed: %lu\"",
            "rv"
          ],
          "line": 109
        },
        "resolved": true,
        "details": {
          "function_name": "error",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "162-170",
          "snippet": "void\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\nerror(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_ERROR, fmt, args);\n\tva_end(args);\n}"
        }
      },
      {
        "call_info": {
          "callee": "p->function_list->C_Finalize",
          "args": [
            "NULL"
          ],
          "line": 108
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "p->function_list->C_CloseSession",
          "args": [
            "p->slotinfo[i].session"
          ],
          "line": 104
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "debug",
          "args": [
            "\"pkcs11_provider_finalize: %p refcount %d valid %d\"",
            "p",
            "p->refcount",
            "p->valid"
          ],
          "line": 98
        },
        "resolved": true,
        "details": {
          "function_name": "debug3",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/log.c",
          "lines": "242-250",
          "snippet": "void\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}",
          "includes": [
            "#include \"log.h\"",
            "# include <vis.h>",
            "#include <errno.h>",
            "#include <unistd.h>",
            "#include <syslog.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>",
            "#include <stdarg.h>",
            "#include <fcntl.h>",
            "#include <sys/types.h>",
            "#include \"includes.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"log.h\"\n# include <vis.h>\n#include <errno.h>\n#include <unistd.h>\n#include <syslog.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <stdarg.h>\n#include <fcntl.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nvoid\ndebug3(const char *fmt,...)\n{\n\tva_list args;\n\n\tva_start(args, fmt);\n\tdo_log(SYSLOG_LEVEL_DEBUG3, fmt, args);\n\tva_end(args);\n}"
        }
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nstatic void\npkcs11_provider_finalize(struct pkcs11_provider *p)\n{\n\tCK_RV rv;\n\tCK_ULONG i;\n\n\tdebug(\"pkcs11_provider_finalize: %p refcount %d valid %d\",\n\t    p, p->refcount, p->valid);\n\tif (!p->valid)\n\t\treturn;\n\tfor (i = 0; i < p->nslots; i++) {\n\t\tif (p->slotinfo[i].session &&\n\t\t    (rv = p->function_list->C_CloseSession(\n\t\t    p->slotinfo[i].session)) != CKR_OK)\n\t\t\terror(\"C_CloseSession failed: %lu\", rv);\n\t}\n\tif ((rv = p->function_list->C_Finalize(NULL)) != CKR_OK)\n\t\terror(\"C_Finalize failed: %lu\", rv);\n\tp->valid = 0;\n\tp->function_list = NULL;\n\tdlclose(p->handle);\n}"
  },
  {
    "function_name": "pkcs11_init",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2018-20685/repo/ssh-pkcs11.c",
    "lines": "78-84",
    "snippet": "int\npkcs11_init(int interactive)\n{\n\tpkcs11_interactive = interactive;\n\tTAILQ_INIT(&pkcs11_providers);\n\treturn (0);\n}",
    "includes": [
      "#include \"xmalloc.h\"",
      "#include \"ssh-pkcs11.h\"",
      "#include \"sshkey.h\"",
      "#include \"misc.h\"",
      "#include \"log.h\"",
      "#include \"pkcs11.h\"",
      "#include <openssl/x509.h>",
      "#include \"openbsd-compat/openssl-compat.h\"",
      "#include \"openbsd-compat/sys-queue.h\"",
      "#include <dlfcn.h>",
      "#include <string.h>",
      "#include <stdio.h>",
      "#include <stdarg.h>",
      "# include <sys/time.h>",
      "#include <sys/types.h>",
      "#include \"includes.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "TAILQ_INIT",
          "args": [
            "&pkcs11_providers"
          ],
          "line": 82
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"xmalloc.h\"\n#include \"ssh-pkcs11.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"log.h\"\n#include \"pkcs11.h\"\n#include <openssl/x509.h>\n#include \"openbsd-compat/openssl-compat.h\"\n#include \"openbsd-compat/sys-queue.h\"\n#include <dlfcn.h>\n#include <string.h>\n#include <stdio.h>\n#include <stdarg.h>\n# include <sys/time.h>\n#include <sys/types.h>\n#include \"includes.h\"\n\nint\npkcs11_init(int interactive)\n{\n\tpkcs11_interactive = interactive;\n\tTAILQ_INIT(&pkcs11_providers);\n\treturn (0);\n}"
  }
]