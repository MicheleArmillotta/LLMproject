[
  {
    "function_name": "cs_cmd_list",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/list.c",
    "lines": "137-253",
    "snippet": "static void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[])\n{\n\tmychan_t *mc;\n\tmetadata_t *md, *mdclosed;\n\tchar *chanpattern = NULL, *markpattern = NULL, *closedpattern = NULL;\n\tchar buf[BUFSIZE];\n\tchar criteriastr[BUFSIZE];\n\tunsigned int matches = 0;\n\tunsigned int flagset = 0;\n\tint aclsize = 0;\n\ttime_t age = 0, lastused = 0;\n\tbool closed = false, marked = false, markmatch, closedmatch;\n\tmowgli_patricia_iteration_state_t state;\n\tlist_option_t optstable[] = {\n\t\t{\"pattern\",\tOPT_STRING,\t{.strval = &chanpattern}, 0},\n\t\t{\"mark-reason\", OPT_STRING,\t{.strval = &markpattern}, 0},\n\t\t{\"close-reason\", OPT_STRING,    {.strval = &closedpattern}, 0},\n\t\t{\"noexpire\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_HOLD},\n\t\t{\"held\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_HOLD},\n\t\t{\"hold\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_HOLD},\n\t\t{\"noop\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_NOOP},\n\t\t{\"limitflags\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_LIMITFLAGS},\n\t\t{\"secure\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_SECURE},\n\t\t{\"nosync\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_NOSYNC},\n\t\t{\"verbose\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_VERBOSE},\n\t\t{\"restricted\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_RESTRICTED},\n\t\t{\"keeptopic\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_KEEPTOPIC},\n\t\t{\"verbose-ops\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_VERBOSE_OPS},\n\t\t{\"topiclock\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_TOPICLOCK},\n\t\t{\"guard\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_GUARD},\n\t\t{\"private\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_PRIVATE},\n\t\t{\"closed\",\tOPT_BOOL,\t{.boolval = &closed}, 0},\n\t\t{\"marked\",\tOPT_BOOL,\t{.boolval = &marked}, 0},\n\t\t{\"aclsize\",\tOPT_INT,\t{.intval = &aclsize}, 0},\n\t\t{\"registered\",\tOPT_AGE,\t{.ageval = &age}, 0},\n\t\t{\"lastused\",\tOPT_AGE,\t{.ageval = &lastused}, 0},\n\t};\n\n\tprocess_parvarray(optstable, ARRAY_SIZE(optstable), parc, parv);\n\tbuild_criteriastr(criteriastr, parc, parv);\n\n\tcommand_success_nodata(si, _(\"Channels matching \\2%s\\2:\"), criteriastr);\n\n\tMOWGLI_PATRICIA_FOREACH(mc, &state, mclist)\n\t{\n\t\tif (chanpattern != NULL && match(chanpattern, mc->name))\n\t\t\tcontinue;\n\n\t\tif (markpattern)\n\t\t{\n\t\t\tmarkmatch = false;\n\t\t\tmd = metadata_find(mc, \"private:mark:reason\");\n\t\t\tif (md != NULL && !match(markpattern, md->value))\n\t\t\t\tmarkmatch = true;\n\n\t\t\tif (!markmatch)\n\t\t\t\tcontinue;\n\t\t}\n\n\t\tif (closedpattern)\n\t\t{\n\t\t\tclosedmatch = false;\n\t\t\tmdclosed = metadata_find(mc, \"private:close:reason\");\n\t\t\tif (mdclosed != NULL && !match(closedpattern, mdclosed->value))\n\t\t\t\tclosedmatch = true;\n\n\t\t\tif (!closedmatch)\n\t\t\t\tcontinue;\n\t\t}\n\n\t\tif (marked && !metadata_find(mc, \"private:mark:setter\"))\n\t\t\tcontinue;\n\n\t\tif (closed && !metadata_find(mc, \"private:close:closer\"))\n\t\t\tcontinue;\n\n\t\tif (flagset && (mc->flags & flagset) != flagset)\n\t\t\tcontinue;\n\n\t\tif (aclsize && MOWGLI_LIST_LENGTH(&mc->chanacs) < (unsigned int)aclsize)\n\t\t\tcontinue;\n\n\t\tif (age && (CURRTIME - mc->registered) < age)\n\t\t\tcontinue;\n\n\t\tif (lastused && (CURRTIME - mc->used) < lastused)\n\t\t\tcontinue;\n\n\t\t/* in the future we could add a LIMIT parameter */\n\t\t*buf = '\\0';\n\n\t\tif (metadata_find(mc, \"private:mark:setter\")) {\n\t\t\tmowgli_strlcat(buf, \"\\2[marked]\\2\", BUFSIZE);\n\t\t}\n\t\tif (metadata_find(mc, \"private:close:closer\")) {\n\t\t\tif (*buf)\n\t\t\t\tmowgli_strlcat(buf, \" \", BUFSIZE);\n\n\t\t\tmowgli_strlcat(buf, \"\\2[closed]\\2\", BUFSIZE);\n\t\t}\n\t\tif (mc->flags & MC_HOLD) {\n\t\t\tif (*buf)\n\t\t\t\tmowgli_strlcat(buf, \" \", BUFSIZE);\n\n\t\t\tmowgli_strlcat(buf, \"\\2[held]\\2\", BUFSIZE);\n\t\t}\n\n\t\tcommand_success_nodata(si, \"- %s (%s) %s\", mc->name, mychan_founder_names(mc), buf);\n\t\tmatches++;\n\t}\n\n\tlogcommand(si, CMDLOG_ADMIN, \"LIST: \\2%s\\2 (\\2%d\\2 matches)\", criteriastr, matches);\n\tif (matches == 0)\n\t\tcommand_success_nodata(si, _(\"No channel matched criteria \\2%s\\2\"), criteriastr);\n\telse\n\t\tcommand_success_nodata(si, ngettext(N_(\"\\2%d\\2 match for criteria \\2%s\\2\"), N_(\"\\2%d\\2 matches for criteria \\2%s\\2\"), matches), matches, criteriastr);\n}",
    "includes": [
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "static void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[]);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "ngettext(N_(\"\\2%d\\2 match for criteria \\2%s\\2\"), N_(\"\\2%d\\2 matches for criteria \\2%s\\2\"), matches)",
            "matches",
            "criteriastr"
          ],
          "line": 252
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ngettext",
          "args": [
            "N_(\"\\2%d\\2 match for criteria \\2%s\\2\")",
            "N_(\"\\2%d\\2 matches for criteria \\2%s\\2\")",
            "matches"
          ],
          "line": 252
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "N_",
          "args": [
            "\"\\2%d\\2 matches for criteria \\2%s\\2\""
          ],
          "line": 252
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "N_",
          "args": [
            "\"\\2%d\\2 match for criteria \\2%s\\2\""
          ],
          "line": 252
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"No channel matched criteria \\2%s\\2\")",
            "criteriastr"
          ],
          "line": 250
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"No channel matched criteria \\2%s\\2\""
          ],
          "line": 250
        },
        "resolved": true,
        "details": {
          "function_name": "parse_age",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/list.c",
          "lines": "53-73",
          "snippet": "static time_t parse_age(char *s)\n{\n\ttime_t duration;\n\n\tduration = (atol(s) * 60);\n\twhile (isdigit((unsigned char)*s))\n\t\ts++;\n\n\tif (*s == 'h' || *s == 'H')\n\t\tduration *= 60;\n\telse if (*s == 'd' || *s == 'D')\n\t\tduration *= 1440;\n\telse if (*s == 'w' || *s == 'W')\n\t\tduration *= 10080;\n\telse if (*s == '\\0')\n\t\t;\n\telse\n\t\tduration = 0;\n\n\treturn duration;\n}",
          "includes": [
            "#include \"atheme.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"atheme.h\"\n\nstatic time_t parse_age(char *s)\n{\n\ttime_t duration;\n\n\tduration = (atol(s) * 60);\n\twhile (isdigit((unsigned char)*s))\n\t\ts++;\n\n\tif (*s == 'h' || *s == 'H')\n\t\tduration *= 60;\n\telse if (*s == 'd' || *s == 'D')\n\t\tduration *= 1440;\n\telse if (*s == 'w' || *s == 'W')\n\t\tduration *= 10080;\n\telse if (*s == '\\0')\n\t\t;\n\telse\n\t\tduration = 0;\n\n\treturn duration;\n}"
        }
      },
      {
        "call_info": {
          "callee": "logcommand",
          "args": [
            "si",
            "CMDLOG_ADMIN",
            "\"LIST: \\2%s\\2 (\\2%d\\2 matches)\"",
            "criteriastr",
            "matches"
          ],
          "line": 248
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "\"- %s (%s) %s\"",
            "mc->name",
            "mychan_founder_names(mc)",
            "buf"
          ],
          "line": 244
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mychan_founder_names",
          "args": [
            "mc"
          ],
          "line": 244
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcat",
          "args": [
            "buf",
            "\"\\2[held]\\2\"",
            "BUFSIZE"
          ],
          "line": 241
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcat",
          "args": [
            "buf",
            "\" \"",
            "BUFSIZE"
          ],
          "line": 239
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcat",
          "args": [
            "buf",
            "\"\\2[closed]\\2\"",
            "BUFSIZE"
          ],
          "line": 235
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcat",
          "args": [
            "buf",
            "\" \"",
            "BUFSIZE"
          ],
          "line": 233
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_find",
          "args": [
            "mc",
            "\"private:close:closer\""
          ],
          "line": 231
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcat",
          "args": [
            "buf",
            "\"\\2[marked]\\2\"",
            "BUFSIZE"
          ],
          "line": 229
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_find",
          "args": [
            "mc",
            "\"private:mark:setter\""
          ],
          "line": 228
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MOWGLI_LIST_LENGTH",
          "args": [
            "&mc->chanacs"
          ],
          "line": 216
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_find",
          "args": [
            "mc",
            "\"private:close:closer\""
          ],
          "line": 210
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_find",
          "args": [
            "mc",
            "\"private:mark:setter\""
          ],
          "line": 207
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "match",
          "args": [
            "closedpattern",
            "mdclosed->value"
          ],
          "line": 200
        },
        "resolved": true,
        "details": {
          "function_name": "clear_bans_matching_entity",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/akick.c",
          "lines": "90-126",
          "snippet": "static void clear_bans_matching_entity(mychan_t *mc, myentity_t *mt)\n{\n\tmowgli_node_t *n;\n\tmyuser_t *tmu;\n\n\tif (mc->chan == NULL)\n\t\treturn;\n\n\tif (!isuser(mt))\n\t\treturn;\n\n\ttmu = user(mt);\n\n\tMOWGLI_ITER_FOREACH(n, tmu->logins.head)\n\t{\n\t\tuser_t *tu;\n\t\tmowgli_node_t *it, *itn;\n\n\t\tchar hostbuf2[BUFSIZE];\n\n\t\ttu = n->data;\n\n\t\tsnprintf(hostbuf2, BUFSIZE, \"%s!%s@%s\", tu->nick, tu->user, tu->vhost);\n\t\tfor (it = next_matching_ban(mc->chan, tu, 'b', mc->chan->bans.head); it != NULL; it = next_matching_ban(mc->chan, tu, 'b', itn))\n\t\t{\n\t\t\tchanban_t *cb;\n\n\t\t\titn = it->next;\n\t\t\tcb = it->data;\n\n\t\t\tmodestack_mode_param(chansvs.nick, mc->chan, MTYPE_DEL, cb->type, cb->mask);\n\t\t\tchanban_delete(cb);\n\t\t}\n\t}\n\n\tmodestack_flush_channel(mc->chan);\n}",
          "includes": [
            "#include \"atheme.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"atheme.h\"\n\nstatic void clear_bans_matching_entity(mychan_t *mc, myentity_t *mt)\n{\n\tmowgli_node_t *n;\n\tmyuser_t *tmu;\n\n\tif (mc->chan == NULL)\n\t\treturn;\n\n\tif (!isuser(mt))\n\t\treturn;\n\n\ttmu = user(mt);\n\n\tMOWGLI_ITER_FOREACH(n, tmu->logins.head)\n\t{\n\t\tuser_t *tu;\n\t\tmowgli_node_t *it, *itn;\n\n\t\tchar hostbuf2[BUFSIZE];\n\n\t\ttu = n->data;\n\n\t\tsnprintf(hostbuf2, BUFSIZE, \"%s!%s@%s\", tu->nick, tu->user, tu->vhost);\n\t\tfor (it = next_matching_ban(mc->chan, tu, 'b', mc->chan->bans.head); it != NULL; it = next_matching_ban(mc->chan, tu, 'b', itn))\n\t\t{\n\t\t\tchanban_t *cb;\n\n\t\t\titn = it->next;\n\t\t\tcb = it->data;\n\n\t\t\tmodestack_mode_param(chansvs.nick, mc->chan, MTYPE_DEL, cb->type, cb->mask);\n\t\t\tchanban_delete(cb);\n\t\t}\n\t}\n\n\tmodestack_flush_channel(mc->chan);\n}"
        }
      },
      {
        "call_info": {
          "callee": "metadata_find",
          "args": [
            "mc",
            "\"private:close:reason\""
          ],
          "line": 199
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_find",
          "args": [
            "mc",
            "\"private:mark:reason\""
          ],
          "line": 188
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MOWGLI_PATRICIA_FOREACH",
          "args": [
            "mc",
            "&state",
            "mclist"
          ],
          "line": 180
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"Channels matching \\2%s\\2:\")",
            "criteriastr"
          ],
          "line": 178
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "build_criteriastr",
          "args": [
            "criteriastr",
            "parc",
            "parv"
          ],
          "line": 176
        },
        "resolved": true,
        "details": {
          "function_name": "build_criteriastr",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/list.c",
          "lines": "123-135",
          "snippet": "static void build_criteriastr(char *buf, int parc, char *parv[])\n{\n\tint i;\n\n\treturn_if_fail(buf != NULL);\n\n\t*buf = 0;\n\tfor (i = 0; i < parc; i++)\n\t{\n\t\tmowgli_strlcat(buf, parv[i], BUFSIZE);\n\t\tmowgli_strlcat(buf, \" \", BUFSIZE);\n\t}\n}",
          "includes": [
            "#include \"atheme.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "static void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[]);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"atheme.h\"\n\nstatic void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[]);\n\nstatic void build_criteriastr(char *buf, int parc, char *parv[])\n{\n\tint i;\n\n\treturn_if_fail(buf != NULL);\n\n\t*buf = 0;\n\tfor (i = 0; i < parc; i++)\n\t{\n\t\tmowgli_strlcat(buf, parv[i], BUFSIZE);\n\t\tmowgli_strlcat(buf, \" \", BUFSIZE);\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "process_parvarray",
          "args": [
            "optstable",
            "ARRAY_SIZE(optstable)",
            "parc",
            "parv"
          ],
          "line": 175
        },
        "resolved": true,
        "details": {
          "function_name": "process_parvarray",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/list.c",
          "lines": "75-121",
          "snippet": "static void process_parvarray(list_option_t *opts, size_t optsize, int parc, char *parv[])\n{\n\tint i;\n\tsize_t j;\n\n\tfor (i = 0; i < parc; i++)\n\t{\n\t\tfor (j = 0; j < optsize; j++)\n\t\t{\n\t\t\tif (!strcasecmp(opts[j].option, parv[i]))\n\t\t\t{\n\t\t\t\tswitch(opts[j].opttype)\n\t\t\t\t{\n\t\t\t\tcase OPT_BOOL:\n\t\t\t\t\t*opts[j].optval.boolval = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_INT:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.intval = atoi(parv[i + 1]);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_STRING:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.strval = parv[i + 1];\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_FLAG:\n\t\t\t\t\t*opts[j].optval.flagval |= opts[j].flag;\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_AGE:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.ageval = parse_age(parv[i + 1]);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}",
          "includes": [
            "#include \"atheme.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "static void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[]);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"atheme.h\"\n\nstatic void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[]);\n\nstatic void process_parvarray(list_option_t *opts, size_t optsize, int parc, char *parv[])\n{\n\tint i;\n\tsize_t j;\n\n\tfor (i = 0; i < parc; i++)\n\t{\n\t\tfor (j = 0; j < optsize; j++)\n\t\t{\n\t\t\tif (!strcasecmp(opts[j].option, parv[i]))\n\t\t\t{\n\t\t\t\tswitch(opts[j].opttype)\n\t\t\t\t{\n\t\t\t\tcase OPT_BOOL:\n\t\t\t\t\t*opts[j].optval.boolval = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_INT:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.intval = atoi(parv[i + 1]);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_STRING:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.strval = parv[i + 1];\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_FLAG:\n\t\t\t\t\t*opts[j].optval.flagval |= opts[j].flag;\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_AGE:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.ageval = parse_age(parv[i + 1]);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "ARRAY_SIZE",
          "args": [
            "optstable"
          ],
          "line": 175
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"atheme.h\"\n\nstatic void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[]);\n\nstatic void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[])\n{\n\tmychan_t *mc;\n\tmetadata_t *md, *mdclosed;\n\tchar *chanpattern = NULL, *markpattern = NULL, *closedpattern = NULL;\n\tchar buf[BUFSIZE];\n\tchar criteriastr[BUFSIZE];\n\tunsigned int matches = 0;\n\tunsigned int flagset = 0;\n\tint aclsize = 0;\n\ttime_t age = 0, lastused = 0;\n\tbool closed = false, marked = false, markmatch, closedmatch;\n\tmowgli_patricia_iteration_state_t state;\n\tlist_option_t optstable[] = {\n\t\t{\"pattern\",\tOPT_STRING,\t{.strval = &chanpattern}, 0},\n\t\t{\"mark-reason\", OPT_STRING,\t{.strval = &markpattern}, 0},\n\t\t{\"close-reason\", OPT_STRING,    {.strval = &closedpattern}, 0},\n\t\t{\"noexpire\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_HOLD},\n\t\t{\"held\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_HOLD},\n\t\t{\"hold\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_HOLD},\n\t\t{\"noop\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_NOOP},\n\t\t{\"limitflags\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_LIMITFLAGS},\n\t\t{\"secure\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_SECURE},\n\t\t{\"nosync\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_NOSYNC},\n\t\t{\"verbose\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_VERBOSE},\n\t\t{\"restricted\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_RESTRICTED},\n\t\t{\"keeptopic\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_KEEPTOPIC},\n\t\t{\"verbose-ops\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_VERBOSE_OPS},\n\t\t{\"topiclock\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_TOPICLOCK},\n\t\t{\"guard\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_GUARD},\n\t\t{\"private\",\tOPT_FLAG,\t{.flagval = &flagset}, MC_PRIVATE},\n\t\t{\"closed\",\tOPT_BOOL,\t{.boolval = &closed}, 0},\n\t\t{\"marked\",\tOPT_BOOL,\t{.boolval = &marked}, 0},\n\t\t{\"aclsize\",\tOPT_INT,\t{.intval = &aclsize}, 0},\n\t\t{\"registered\",\tOPT_AGE,\t{.ageval = &age}, 0},\n\t\t{\"lastused\",\tOPT_AGE,\t{.ageval = &lastused}, 0},\n\t};\n\n\tprocess_parvarray(optstable, ARRAY_SIZE(optstable), parc, parv);\n\tbuild_criteriastr(criteriastr, parc, parv);\n\n\tcommand_success_nodata(si, _(\"Channels matching \\2%s\\2:\"), criteriastr);\n\n\tMOWGLI_PATRICIA_FOREACH(mc, &state, mclist)\n\t{\n\t\tif (chanpattern != NULL && match(chanpattern, mc->name))\n\t\t\tcontinue;\n\n\t\tif (markpattern)\n\t\t{\n\t\t\tmarkmatch = false;\n\t\t\tmd = metadata_find(mc, \"private:mark:reason\");\n\t\t\tif (md != NULL && !match(markpattern, md->value))\n\t\t\t\tmarkmatch = true;\n\n\t\t\tif (!markmatch)\n\t\t\t\tcontinue;\n\t\t}\n\n\t\tif (closedpattern)\n\t\t{\n\t\t\tclosedmatch = false;\n\t\t\tmdclosed = metadata_find(mc, \"private:close:reason\");\n\t\t\tif (mdclosed != NULL && !match(closedpattern, mdclosed->value))\n\t\t\t\tclosedmatch = true;\n\n\t\t\tif (!closedmatch)\n\t\t\t\tcontinue;\n\t\t}\n\n\t\tif (marked && !metadata_find(mc, \"private:mark:setter\"))\n\t\t\tcontinue;\n\n\t\tif (closed && !metadata_find(mc, \"private:close:closer\"))\n\t\t\tcontinue;\n\n\t\tif (flagset && (mc->flags & flagset) != flagset)\n\t\t\tcontinue;\n\n\t\tif (aclsize && MOWGLI_LIST_LENGTH(&mc->chanacs) < (unsigned int)aclsize)\n\t\t\tcontinue;\n\n\t\tif (age && (CURRTIME - mc->registered) < age)\n\t\t\tcontinue;\n\n\t\tif (lastused && (CURRTIME - mc->used) < lastused)\n\t\t\tcontinue;\n\n\t\t/* in the future we could add a LIMIT parameter */\n\t\t*buf = '\\0';\n\n\t\tif (metadata_find(mc, \"private:mark:setter\")) {\n\t\t\tmowgli_strlcat(buf, \"\\2[marked]\\2\", BUFSIZE);\n\t\t}\n\t\tif (metadata_find(mc, \"private:close:closer\")) {\n\t\t\tif (*buf)\n\t\t\t\tmowgli_strlcat(buf, \" \", BUFSIZE);\n\n\t\t\tmowgli_strlcat(buf, \"\\2[closed]\\2\", BUFSIZE);\n\t\t}\n\t\tif (mc->flags & MC_HOLD) {\n\t\t\tif (*buf)\n\t\t\t\tmowgli_strlcat(buf, \" \", BUFSIZE);\n\n\t\t\tmowgli_strlcat(buf, \"\\2[held]\\2\", BUFSIZE);\n\t\t}\n\n\t\tcommand_success_nodata(si, \"- %s (%s) %s\", mc->name, mychan_founder_names(mc), buf);\n\t\tmatches++;\n\t}\n\n\tlogcommand(si, CMDLOG_ADMIN, \"LIST: \\2%s\\2 (\\2%d\\2 matches)\", criteriastr, matches);\n\tif (matches == 0)\n\t\tcommand_success_nodata(si, _(\"No channel matched criteria \\2%s\\2\"), criteriastr);\n\telse\n\t\tcommand_success_nodata(si, ngettext(N_(\"\\2%d\\2 match for criteria \\2%s\\2\"), N_(\"\\2%d\\2 matches for criteria \\2%s\\2\"), matches), matches, criteriastr);\n}"
  },
  {
    "function_name": "build_criteriastr",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/list.c",
    "lines": "123-135",
    "snippet": "static void build_criteriastr(char *buf, int parc, char *parv[])\n{\n\tint i;\n\n\treturn_if_fail(buf != NULL);\n\n\t*buf = 0;\n\tfor (i = 0; i < parc; i++)\n\t{\n\t\tmowgli_strlcat(buf, parv[i], BUFSIZE);\n\t\tmowgli_strlcat(buf, \" \", BUFSIZE);\n\t}\n}",
    "includes": [
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "static void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[]);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "mowgli_strlcat",
          "args": [
            "buf",
            "\" \"",
            "BUFSIZE"
          ],
          "line": 133
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcat",
          "args": [
            "buf",
            "parv[i]",
            "BUFSIZE"
          ],
          "line": 132
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "return_if_fail",
          "args": [
            "buf != NULL"
          ],
          "line": 127
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"atheme.h\"\n\nstatic void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[]);\n\nstatic void build_criteriastr(char *buf, int parc, char *parv[])\n{\n\tint i;\n\n\treturn_if_fail(buf != NULL);\n\n\t*buf = 0;\n\tfor (i = 0; i < parc; i++)\n\t{\n\t\tmowgli_strlcat(buf, parv[i], BUFSIZE);\n\t\tmowgli_strlcat(buf, \" \", BUFSIZE);\n\t}\n}"
  },
  {
    "function_name": "process_parvarray",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/list.c",
    "lines": "75-121",
    "snippet": "static void process_parvarray(list_option_t *opts, size_t optsize, int parc, char *parv[])\n{\n\tint i;\n\tsize_t j;\n\n\tfor (i = 0; i < parc; i++)\n\t{\n\t\tfor (j = 0; j < optsize; j++)\n\t\t{\n\t\t\tif (!strcasecmp(opts[j].option, parv[i]))\n\t\t\t{\n\t\t\t\tswitch(opts[j].opttype)\n\t\t\t\t{\n\t\t\t\tcase OPT_BOOL:\n\t\t\t\t\t*opts[j].optval.boolval = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_INT:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.intval = atoi(parv[i + 1]);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_STRING:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.strval = parv[i + 1];\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_FLAG:\n\t\t\t\t\t*opts[j].optval.flagval |= opts[j].flag;\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_AGE:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.ageval = parse_age(parv[i + 1]);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}",
    "includes": [
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "static void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[]);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "parse_age",
          "args": [
            "parv[i + 1]"
          ],
          "line": 111
        },
        "resolved": true,
        "details": {
          "function_name": "parse_age",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/list.c",
          "lines": "53-73",
          "snippet": "static time_t parse_age(char *s)\n{\n\ttime_t duration;\n\n\tduration = (atol(s) * 60);\n\twhile (isdigit((unsigned char)*s))\n\t\ts++;\n\n\tif (*s == 'h' || *s == 'H')\n\t\tduration *= 60;\n\telse if (*s == 'd' || *s == 'D')\n\t\tduration *= 1440;\n\telse if (*s == 'w' || *s == 'W')\n\t\tduration *= 10080;\n\telse if (*s == '\\0')\n\t\t;\n\telse\n\t\tduration = 0;\n\n\treturn duration;\n}",
          "includes": [
            "#include \"atheme.h\""
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"atheme.h\"\n\nstatic time_t parse_age(char *s)\n{\n\ttime_t duration;\n\n\tduration = (atol(s) * 60);\n\twhile (isdigit((unsigned char)*s))\n\t\ts++;\n\n\tif (*s == 'h' || *s == 'H')\n\t\tduration *= 60;\n\telse if (*s == 'd' || *s == 'D')\n\t\tduration *= 1440;\n\telse if (*s == 'w' || *s == 'W')\n\t\tduration *= 10080;\n\telse if (*s == '\\0')\n\t\t;\n\telse\n\t\tduration = 0;\n\n\treturn duration;\n}"
        }
      },
      {
        "call_info": {
          "callee": "atoi",
          "args": [
            "parv[i + 1]"
          ],
          "line": 94
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcasecmp",
          "args": [
            "opts[j].option",
            "parv[i]"
          ],
          "line": 84
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"atheme.h\"\n\nstatic void cs_cmd_list(sourceinfo_t *si, int parc, char *parv[]);\n\nstatic void process_parvarray(list_option_t *opts, size_t optsize, int parc, char *parv[])\n{\n\tint i;\n\tsize_t j;\n\n\tfor (i = 0; i < parc; i++)\n\t{\n\t\tfor (j = 0; j < optsize; j++)\n\t\t{\n\t\t\tif (!strcasecmp(opts[j].option, parv[i]))\n\t\t\t{\n\t\t\t\tswitch(opts[j].opttype)\n\t\t\t\t{\n\t\t\t\tcase OPT_BOOL:\n\t\t\t\t\t*opts[j].optval.boolval = true;\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_INT:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.intval = atoi(parv[i + 1]);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_STRING:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.strval = parv[i + 1];\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_FLAG:\n\t\t\t\t\t*opts[j].optval.flagval |= opts[j].flag;\n\t\t\t\t\tbreak;\n\t\t\t\tcase OPT_AGE:\n\t\t\t\t\tif (i + 1 < parc)\n\t\t\t\t\t{\n\t\t\t\t\t\t*opts[j].optval.ageval = parse_age(parv[i + 1]);\n\t\t\t\t\t\ti++;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}"
  },
  {
    "function_name": "parse_age",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/list.c",
    "lines": "53-73",
    "snippet": "static time_t parse_age(char *s)\n{\n\ttime_t duration;\n\n\tduration = (atol(s) * 60);\n\twhile (isdigit((unsigned char)*s))\n\t\ts++;\n\n\tif (*s == 'h' || *s == 'H')\n\t\tduration *= 60;\n\telse if (*s == 'd' || *s == 'D')\n\t\tduration *= 1440;\n\telse if (*s == 'w' || *s == 'W')\n\t\tduration *= 10080;\n\telse if (*s == '\\0')\n\t\t;\n\telse\n\t\tduration = 0;\n\n\treturn duration;\n}",
    "includes": [
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "isdigit",
          "args": [
            "(unsigned char)*s"
          ],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "atol",
          "args": [
            "s"
          ],
          "line": 57
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"atheme.h\"\n\nstatic time_t parse_age(char *s)\n{\n\ttime_t duration;\n\n\tduration = (atol(s) * 60);\n\twhile (isdigit((unsigned char)*s))\n\t\ts++;\n\n\tif (*s == 'h' || *s == 'H')\n\t\tduration *= 60;\n\telse if (*s == 'd' || *s == 'D')\n\t\tduration *= 1440;\n\telse if (*s == 'w' || *s == 'W')\n\t\tduration *= 10080;\n\telse if (*s == '\\0')\n\t\t;\n\telse\n\t\tduration = 0;\n\n\treturn duration;\n}"
  },
  {
    "function_name": "_moddeinit",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/list.c",
    "lines": "27-30",
    "snippet": "void _moddeinit(module_unload_intent_t intent)\n{\n\tservice_named_unbind_command(\"chanserv\", &cs_list);\n}",
    "includes": [
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "command_t cs_list = { \"LIST\", N_(\"Lists channels registered matching a given pattern.\"), PRIV_CHAN_AUSPEX, 10, cs_cmd_list, { .path = \"cservice/list\" } };"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "service_named_unbind_command",
          "args": [
            "\"chanserv\"",
            "&cs_list"
          ],
          "line": 29
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"atheme.h\"\n\ncommand_t cs_list = { \"LIST\", N_(\"Lists channels registered matching a given pattern.\"), PRIV_CHAN_AUSPEX, 10, cs_cmd_list, { .path = \"cservice/list\" } };\n\nvoid _moddeinit(module_unload_intent_t intent)\n{\n\tservice_named_unbind_command(\"chanserv\", &cs_list);\n}"
  },
  {
    "function_name": "_modinit",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/list.c",
    "lines": "22-25",
    "snippet": "void _modinit(module_t *m)\n{\n\tservice_named_bind_command(\"chanserv\", &cs_list);\n}",
    "includes": [
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "command_t cs_list = { \"LIST\", N_(\"Lists channels registered matching a given pattern.\"), PRIV_CHAN_AUSPEX, 10, cs_cmd_list, { .path = \"cservice/list\" } };"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "service_named_bind_command",
          "args": [
            "\"chanserv\"",
            "&cs_list"
          ],
          "line": 24
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"atheme.h\"\n\ncommand_t cs_list = { \"LIST\", N_(\"Lists channels registered matching a given pattern.\"), PRIV_CHAN_AUSPEX, 10, cs_cmd_list, { .path = \"cservice/list\" } };\n\nvoid _modinit(module_t *m)\n{\n\tservice_named_bind_command(\"chanserv\", &cs_list);\n}"
  }
]