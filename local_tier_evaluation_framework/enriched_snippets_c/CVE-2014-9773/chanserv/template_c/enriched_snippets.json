[
  {
    "function_name": "cs_cmd_template",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/template.c",
    "lines": "63-400",
    "snippet": "static void cs_cmd_template(sourceinfo_t *si, int parc, char *parv[])\n{\n\tmetadata_t *md;\n\tbool operoverride = false, changechanacs = false;\n\tsize_t l;\n\tchar *channel = parv[0];\n\tchar *target = parv[1];\n\tmychan_t *mc;\n\tunsigned int oldflags, newflags = 0, addflags, removeflags, restrictflags;\n\tchar *p, *q, *r;\n\tchar ss[40], newstr[400];\n\tbool found, denied;\n\n\tif (!channel)\n\t{\n\t\tlist_generic_flags(si);\n\t\tlogcommand(si, CMDLOG_GET, \"TEMPLATE\");\n\t\treturn;\n\t}\n\n\tmc = mychan_find(channel);\n\tif (!mc)\n\t{\n\t\tcommand_fail(si, fault_nosuch_target, _(\"Channel \\2%s\\2 is not registered.\"), channel);\n\t\treturn;\n\t}\n\n\tif (!target)\n\t{\n\t\tif (!(mc->flags & MC_PUBACL) && !chanacs_source_has_flag(mc, si, CA_ACLVIEW))\n\t\t{\n\t\t\tif (has_priv(si, PRIV_CHAN_AUSPEX))\n\t\t\t\toperoverride = true;\n\t\t\telse\n\t\t\t{\n\t\t\t\tcommand_fail(si, fault_noprivs, _(\"You are not authorized to perform this operation.\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (metadata_find(mc, \"private:close:closer\") && !has_priv(si, PRIV_CHAN_AUSPEX))\n\t\t{\n\t\t\tcommand_fail(si, fault_noprivs, _(\"\\2%s\\2 is closed.\"), channel);\n\t\t\treturn;\n\t\t}\n\n\t\tmd = metadata_find(mc, \"private:templates\");\n\n\t\tif (md != NULL)\n\t\t{\n\t\t\tcommand_success_nodata(si, \"%-20s %s\", _(\"Name\"), _(\"Flags\"));\n\t\t\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\n\t\t\tp = md->value;\n\t\t\twhile (p != NULL)\n\t\t\t{\n\t\t\t\twhile (*p == ' ')\n\t\t\t\t\tp++;\n\t\t\t\tq = strchr(p, '=');\n\t\t\t\tif (q == NULL)\n\t\t\t\t\tbreak;\n\t\t\t\tr = strchr(q, ' ');\n\t\t\t\tcommand_success_nodata(si, \"%-20.*s %.*s\", (int)(q - p), p, r != NULL ? (int)(r - q - 1) : (int)strlen(q + 1), q + 1);\n\t\t\t\tp = r;\n\t\t\t}\n\n\t\t\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\t\t\tcommand_success_nodata(si, _(\"End of \\2%s\\2 TEMPLATE listing.\"), mc->name);\n\t\t}\n\t\telse\n\t\t\tcommand_success_nodata(si, _(\"No templates set on channel \\2%s\\2.\"), mc->name);\n\n\t\tif (operoverride)\n\t\t\tlogcommand(si, CMDLOG_ADMIN, \"TEMPLATE: \\2%s\\2 (oper override)\", mc->name);\n\t\telse\n\t\t\tlogcommand(si, CMDLOG_GET, \"TEMPLATE: \\2%s\\2\", mc->name);\n\t}\n\telse\n\t{\n\t\tchar *flagstr = parv[2];\n\n\t\tif (!si->smu)\n\t\t{\n\t\t\tcommand_fail(si, fault_noprivs, _(\"You are not logged in.\"));\n\t\t\treturn;\n\t\t}\n\n\t\t/* founder may always set flags -- jilles */\n\t\trestrictflags = chanacs_source_flags(mc, si);\n\t\tif (restrictflags & CA_FOUNDER)\n\t\t\trestrictflags = ca_all;\n\t\telse\n\t\t{\n\t\t\tif (!(restrictflags & CA_FLAGS))\n\t\t\t{\n\t\t\t\tcommand_fail(si, fault_noprivs, _(\"You are not authorized to execute this command.\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\trestrictflags = allow_flags(mc, restrictflags);\n\t\t}\n\n\t\tif (metadata_find(mc, \"private:close:closer\"))\n\t\t{\n\t\t\tcommand_fail(si, fault_noprivs, _(\"\\2%s\\2 is closed.\"), channel);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!target || !flagstr)\n\t\t{\n\t\t\tcommand_fail(si, fault_needmoreparams, _(\"Usage: TEMPLATE %s [target flags]\"), channel);\n\t\t\treturn;\n\t\t}\n\n\t\tif (*target == '+' || *target == '-' || *target == '=')\n\t\t{\n\t\t\tcommand_fail(si, fault_badparams, _(\"Invalid template name \\2%s\\2.\"), target);\n\t\t\treturn;\n\t\t}\n\t\tl = strlen(target);\n\n\t\tif (*flagstr == '!' && (flagstr[1] == '+' || flagstr[1] == '-' || flagstr[1] == '='))\n\t\t{\n\t\t\tchangechanacs = true;\n\t\t\tflagstr++;\n\t\t}\n\n\t\tif (*flagstr == '+' || *flagstr == '-' || *flagstr == '=')\n\t\t{\n\t\t\tflags_make_bitmasks(flagstr, &addflags, &removeflags);\n\t\t\tif (addflags == 0 && removeflags == 0)\n\t\t\t{\n\t\t\t\tcommand_fail(si, fault_badparams, _(\"No valid flags given, use /%s%s HELP FLAGS for a list\"), ircd->uses_rcommand ? \"\" : \"msg \", chansvs.me->disp);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t/* allow copying templates as well */\n\t\t\taddflags = get_template_flags(mc, flagstr);\n\t\t\tif (addflags == 0)\n\t\t\t{\n\t\t\t\tcommand_fail(si, fault_nosuch_key, _(\"Invalid template name given, use /%s%s TEMPLATE %s for a list\"), ircd->uses_rcommand ? \"\" : \"msg \", chansvs.me->disp, mc->name);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tremoveflags = ca_all & ~addflags;\n\t\t}\n\n\t\t/* if adding +F, also add +f */\n\t\tif (addflags & CA_FOUNDER)\n\t\t\taddflags |= CA_FLAGS, removeflags &= ~CA_FLAGS;\n\t\t/* if removing +f, also remove +F */\n\t\telse if (removeflags & CA_FLAGS)\n\t\t\tremoveflags |= CA_FOUNDER, addflags &= ~CA_FOUNDER;\n\n\t\tfound = denied = false;\n\t\toldflags = 0;\n\n\t\tmd = metadata_find(mc, \"private:templates\");\n\t\tif (md != NULL)\n\t\t{\n\t\t\tp = md->value;\n\t\t\tmowgli_strlcpy(newstr, p, sizeof newstr);\n\t\t\twhile (p != NULL)\n\t\t\t{\n\t\t\t\twhile (*p == ' ')\n\t\t\t\t\tp++;\n\t\t\t\tq = strchr(p, '=');\n\t\t\t\tif (q == NULL)\n\t\t\t\t\tbreak;\n\t\t\t\tr = strchr(q, ' ');\n\t\t\t\tif (r != NULL && r < q)\n\t\t\t\t\tbreak;\n\t\t\t\tmowgli_strlcpy(ss, q, sizeof ss);\n\t\t\t\tif (r != NULL && r - q < (int)(sizeof ss - 1))\n\t\t\t\t{\n\t\t\t\t\tss[r - q] = '\\0';\n\t\t\t\t}\n\t\t\t\tif ((size_t)(q - p) == l && !strncasecmp(target, p, l))\n\t\t\t\t{\n\t\t\t\t\tfound = true;\n\t\t\t\t\toldflags = flags_to_bitmask(ss, 0);\n\t\t\t\t\toldflags &= ca_all;\n\t\t\t\t\taddflags &= ~oldflags;\n\t\t\t\t\tremoveflags &= oldflags & ~addflags;\n\t\t\t\t\t/* no change? */\n\t\t\t\t\tif ((addflags | removeflags) == 0)\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t/* attempting to add bad flag? */\n\t\t\t\t\t/* attempting to remove bad flag? */\n\t\t\t\t\t/* attempting to manipulate something with more privs? */\n\t\t\t\t\tif (~restrictflags & addflags ||\n\t\t\t\t\t\t\t~restrictflags & removeflags ||\n\t\t\t\t\t\t\t~restrictflags & oldflags)\n\t\t\t\t\t{\n\t\t\t\t\t\tdenied = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tnewflags = (oldflags | addflags) & ~removeflags;\n\t\t\t\t\tif (newflags == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (p == md->value)\n\t\t\t\t\t\t\t/* removing first entry,\n\t\t\t\t\t\t\t * zap the space after it */\n\t\t\t\t\t\t\tmowgli_strlcpy(newstr, r != NULL ? r + 1 : \"\", sizeof newstr);\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t/* otherwise, zap the space before it */\n\t\t\t\t\t\t\tp--;\n\t\t\t\t\t\t\tmowgli_strlcpy(newstr + (p - md->value), r != NULL ? r : \"\", sizeof newstr - (p - md->value));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t\tsnprintf(newstr + (p - md->value), sizeof newstr - (p - md->value), \"%s=%s%s\", target, bitmask_to_flags(newflags), r != NULL ? r : \"\");\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tp = r;\n\t\t\t}\n\t\t}\n\t\tif (!found)\n\t\t{\n\t\t\tif (l == 3 && !chansvs.hide_xop && (!strcasecmp(target, \"SOP\") ||\n\t\t\t\t\t\t!strcasecmp(target, \"AOP\") ||\n\t\t\t\t\t\t!strcasecmp(target, \"HOP\") ||\n\t\t\t\t\t\t!strcasecmp(target, \"VOP\")))\n\t\t\t{\n\t\t\t\toldflags = get_template_flags(NULL, target);\n\t\t\t\taddflags &= ~oldflags;\n\t\t\t\tremoveflags &= oldflags & ~addflags;\n\t\t\t\tnewflags = (oldflags | addflags) & ~removeflags;\n\t\t\t\tif (newflags == 0)\n\t\t\t\t\tremoveflags = 0;\n\t\t\t\tif ((addflags | removeflags) != 0)\n\t\t\t\t\tcommand_success_nodata(si, _(\"Redefining built-in template \\2%s\\2.\"), target);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tremoveflags = 0;\n\t\t\t\tnewflags = addflags;\n\t\t\t}\n\t\t\tif ((addflags | removeflags) == 0)\n\t\t\t\t;\n\t\t\telse if (~restrictflags & addflags ||\n\t\t\t\t\t~restrictflags & removeflags ||\n\t\t\t\t\t~restrictflags & oldflags)\n\t\t\t\tdenied = true;\n\t\t\telse if (md != NULL)\n\t\t\t\tsnprintf(newstr + strlen(newstr), sizeof newstr - strlen(newstr), \" %s=%s\", target, bitmask_to_flags(newflags));\n\t\t\telse\n\t\t\t\tsnprintf(newstr, sizeof newstr, \"%s=%s\", target, bitmask_to_flags(newflags));\n\t\t}\n\t\tif (oldflags == 0 && has_ctrl_chars(target))\n\t\t{\n\t\t\tcommand_fail(si, fault_badparams, _(\"Invalid template name \\2%s\\2.\"), target);\n\t\t\treturn;\n\t\t}\n\t\tif ((addflags | removeflags) == 0)\n\t\t{\n\t\t\tif (oldflags != 0)\n\t\t\t\tcommand_fail(si, fault_nochange, _(\"Template \\2%s\\2 on \\2%s\\2 unchanged.\"), target, channel);\n\t\t\telse\n\t\t\t\tcommand_fail(si, fault_nosuch_key, _(\"No such template \\2%s\\2 on \\2%s\\2.\"), target, channel);\n\t\t\treturn;\n\t\t}\n\t\tif (denied)\n\t\t{\n\t\t\tcommand_fail(si, fault_noprivs, _(\"You are not allowed to set \\2%s\\2 on template \\2%s\\2 in \\2%s\\2.\"), bitmask_to_flags2(addflags, removeflags), target, mc->name);\n\t\t\treturn;\n\t\t}\n\t\tif (strlen(newstr) >= 300)\n\t\t{\n\t\t\tcommand_fail(si, fault_toomany, _(\"Sorry, too many templates on \\2%s\\2.\"), channel);\n\t\t\treturn;\n\t\t}\n\t\tp = md != NULL ? md->value : NULL;\n\t\twhile (p != NULL)\n\t\t{\n\t\t\twhile (*p == ' ')\n\t\t\tp++;\n\t\t\tq = strchr(p, '=');\n\t\t\tif (q == NULL)\n\t\t\t\t\tbreak;\n\t\t\tr = strchr(q, ' ');\n\t\t\tsnprintf(ss,sizeof ss,\"%.*s\",r != NULL ? (int)(r - q - 1) : (int)strlen(q + 1), q + 1);\n\t\t\tif (flags_to_bitmask(ss,0) == newflags)\n\t\t\t{\n\t\t\t\tcommand_fail(si, fault_alreadyexists, _(\"The template \\2%.*s\\2 already has flags \\2%.*s\\2.\"), (int)(q - p), p, r != NULL ? (int)(r - q - 1) : (int)strlen(q + 1), q + 1);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tp = r;\n\t\t}\n\n\t\tif (newstr[0] == '\\0')\n\t\t\tmetadata_delete(mc, \"private:templates\");\n\t\telse\n\t\t\tmetadata_add(mc, \"private:templates\", newstr);\n\t\tif (oldflags == 0)\n\t\t\tcommand_success_nodata(si, _(\"Added template \\2%s\\2 with flags \\2%s\\2 in \\2%s\\2.\"), target, bitmask_to_flags(newflags), channel);\n\t\telse if (newflags == 0)\n\t\t\tcommand_success_nodata(si, _(\"Removed template \\2%s\\2 from \\2%s\\2.\"), target, channel);\n\t\telse\n\t\t\tcommand_success_nodata(si, _(\"Changed template \\2%s\\2 to \\2%s\\2 in \\2%s\\2.\"), target, bitmask_to_flags(newflags), channel);\n\n\t\tflagstr = bitmask_to_flags2(addflags, removeflags);\n\t\tif (changechanacs)\n\t\t{\n\t\t\tmowgli_node_t *n, *tn;\n\t\t\tchanacs_t *ca;\n\t\t\tint changes = 0, founderskipped = 0;\n\t\t\tchar flagstr2[128];\n\n\t\t\tMOWGLI_ITER_FOREACH_SAFE(n, tn, mc->chanacs.head)\n\t\t\t{\n\t\t\t\tca = n->data;\n\t\t\t\tif (ca->level != oldflags)\n\t\t\t\t\tcontinue;\n\t\t\t\tif ((addflags | removeflags) & CA_FOUNDER)\n\t\t\t\t{\n\t\t\t\t\tfounderskipped++;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tchanges++;\n\t\t\t\tchanacs_modify_simple(ca, newflags, ~newflags);\n\t\t\t\tchanacs_close(ca);\n\t\t\t}\n\t\t\tlogcommand(si, CMDLOG_SET, \"TEMPLATE: \\2%s\\2 \\2%s\\2 !\\2%s\\2 (\\2%d\\2 changes)\", mc->name, target, flagstr, changes);\n\t\t\tmowgli_strlcpy(flagstr2, flagstr, sizeof flagstr2);\n\t\t\tif (changes > 0)\n\t\t\t\tverbose(mc, \"\\2%s\\2 set \\2%s\\2 on %d access entries with flags \\2%s\\2.\", get_source_name(si), flagstr2, changes, bitmask_to_flags(oldflags));\n\t\t\tcommand_success_nodata(si, _(\"%d access entries updated accordingly.\"), changes);\n\t\t\tif (founderskipped)\n\t\t\t\tcommand_success_nodata(si, _(\"Not updating %d access entries involving founder status. Please do it manually.\"), founderskipped);\n\t\t}\n\t\telse\n\t\t\tlogcommand(si, CMDLOG_SET, \"TEMPLATE: \\2%s\\2 \\2%s\\2 \\2%s\\2\", mc->name, target, flagstr);\n\t\t/*verbose(mc, \"Flags \\2%s\\2 were set on template \\2%s\\2 in \\2%s\\2.\", flagstr, target, channel);*/\n\t}\n}",
    "includes": [
      "#include \"template.h\"",
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "static void list_generic_flags(sourceinfo_t *si);",
      "static void cs_cmd_template(sourceinfo_t *si, int parc, char *parv[]);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "logcommand",
          "args": [
            "si",
            "CMDLOG_SET",
            "\"TEMPLATE: \\2%s\\2 \\2%s\\2 \\2%s\\2\"",
            "mc->name",
            "target",
            "flagstr"
          ],
          "line": 397
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"Not updating %d access entries involving founder status. Please do it manually.\")",
            "founderskipped"
          ],
          "line": 394
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"Not updating %d access entries involving founder status. Please do it manually.\""
          ],
          "line": 394
        },
        "resolved": true,
        "details": {
          "function_name": "list_generic_flags",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/template.c",
          "lines": "51-60",
          "snippet": "static void list_generic_flags(sourceinfo_t *si)\n{\n\tcommand_success_nodata(si, \"%-20s %s\", _(\"Name\"), _(\"Flags\"));\n\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\n\tmowgli_patricia_foreach(global_template_dict, display_template, si);\n\n\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\tcommand_success_nodata(si, _(\"End of network wide template list.\"));\n}",
          "includes": [
            "#include \"template.h\"",
            "#include \"atheme.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "static void list_generic_flags(sourceinfo_t *si);"
          ],
          "called_functions": [],
          "contextual_snippet": "#include \"template.h\"\n#include \"atheme.h\"\n\nstatic void list_generic_flags(sourceinfo_t *si);\n\nstatic void list_generic_flags(sourceinfo_t *si)\n{\n\tcommand_success_nodata(si, \"%-20s %s\", _(\"Name\"), _(\"Flags\"));\n\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\n\tmowgli_patricia_foreach(global_template_dict, display_template, si);\n\n\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\tcommand_success_nodata(si, _(\"End of network wide template list.\"));\n}"
        }
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"%d access entries updated accordingly.\")",
            "changes"
          ],
          "line": 392
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "verbose",
          "args": [
            "mc",
            "\"\\2%s\\2 set \\2%s\\2 on %d access entries with flags \\2%s\\2.\"",
            "get_source_name(si)",
            "flagstr2",
            "changes",
            "bitmask_to_flags(oldflags)"
          ],
          "line": 391
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bitmask_to_flags",
          "args": [
            "oldflags"
          ],
          "line": 391
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_source_name",
          "args": [
            "si"
          ],
          "line": 391
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcpy",
          "args": [
            "flagstr2",
            "flagstr",
            "sizeof flagstr2"
          ],
          "line": 389
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "logcommand",
          "args": [
            "si",
            "CMDLOG_SET",
            "\"TEMPLATE: \\2%s\\2 \\2%s\\2 !\\2%s\\2 (\\2%d\\2 changes)\"",
            "mc->name",
            "target",
            "flagstr",
            "changes"
          ],
          "line": 388
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chanacs_close",
          "args": [
            "ca"
          ],
          "line": 386
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chanacs_modify_simple",
          "args": [
            "ca",
            "newflags",
            "~newflags"
          ],
          "line": 385
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MOWGLI_ITER_FOREACH_SAFE",
          "args": [
            "n",
            "tn",
            "mc->chanacs.head"
          ],
          "line": 374
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bitmask_to_flags2",
          "args": [
            "addflags",
            "removeflags"
          ],
          "line": 366
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"Changed template \\2%s\\2 to \\2%s\\2 in \\2%s\\2.\")",
            "target",
            "bitmask_to_flags(newflags)",
            "channel"
          ],
          "line": 364
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bitmask_to_flags",
          "args": [
            "newflags"
          ],
          "line": 364
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"Removed template \\2%s\\2 from \\2%s\\2.\")",
            "target",
            "channel"
          ],
          "line": 362
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"Added template \\2%s\\2 with flags \\2%s\\2 in \\2%s\\2.\")",
            "target",
            "bitmask_to_flags(newflags)",
            "channel"
          ],
          "line": 360
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bitmask_to_flags",
          "args": [
            "newflags"
          ],
          "line": 360
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_add",
          "args": [
            "mc",
            "\"private:templates\"",
            "newstr"
          ],
          "line": 358
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_delete",
          "args": [
            "mc",
            "\"private:templates\""
          ],
          "line": 356
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_alreadyexists",
            "_(\"The template \\2%.*s\\2 already has flags \\2%.*s\\2.\")",
            "(int)(q - p)",
            "p",
            "r != NULL ? (int)(r - q - 1) : (int)strlen(q + 1)",
            "q + 1"
          ],
          "line": 348
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "q + 1"
          ],
          "line": 348
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "flags_to_bitmask",
          "args": [
            "ss",
            "0"
          ],
          "line": 346
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "snprintf",
          "args": [
            "ss",
            "sizeof ss",
            "\"%.*s\"",
            "r != NULL ? (int)(r - q - 1) : (int)strlen(q + 1)",
            "q + 1"
          ],
          "line": 345
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "q + 1"
          ],
          "line": 345
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strchr",
          "args": [
            "q",
            "' '"
          ],
          "line": 344
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strchr",
          "args": [
            "p",
            "'='"
          ],
          "line": 341
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_toomany",
            "_(\"Sorry, too many templates on \\2%s\\2.\")",
            "channel"
          ],
          "line": 333
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "newstr"
          ],
          "line": 331
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_noprivs",
            "_(\"You are not allowed to set \\2%s\\2 on template \\2%s\\2 in \\2%s\\2.\")",
            "bitmask_to_flags2(addflags, removeflags)",
            "target",
            "mc->name"
          ],
          "line": 328
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bitmask_to_flags2",
          "args": [
            "addflags",
            "removeflags"
          ],
          "line": 328
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_nosuch_key",
            "_(\"No such template \\2%s\\2 on \\2%s\\2.\")",
            "target",
            "channel"
          ],
          "line": 323
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_nochange",
            "_(\"Template \\2%s\\2 on \\2%s\\2 unchanged.\")",
            "target",
            "channel"
          ],
          "line": 321
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_badparams",
            "_(\"Invalid template name \\2%s\\2.\")",
            "target"
          ],
          "line": 315
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "has_ctrl_chars",
          "args": [
            "target"
          ],
          "line": 313
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "snprintf",
          "args": [
            "newstr",
            "sizeof newstr",
            "\"%s=%s\"",
            "target",
            "bitmask_to_flags(newflags)"
          ],
          "line": 311
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bitmask_to_flags",
          "args": [
            "newflags"
          ],
          "line": 311
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "snprintf",
          "args": [
            "newstr + strlen(newstr)",
            "sizeof newstr - strlen(newstr)",
            "\" %s=%s\"",
            "target",
            "bitmask_to_flags(newflags)"
          ],
          "line": 309
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bitmask_to_flags",
          "args": [
            "newflags"
          ],
          "line": 309
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "newstr"
          ],
          "line": 309
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "newstr"
          ],
          "line": 309
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"Redefining built-in template \\2%s\\2.\")",
            "target"
          ],
          "line": 295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_template_flags",
          "args": [
            "NULL",
            "target"
          ],
          "line": 288
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcasecmp",
          "args": [
            "target",
            "\"VOP\""
          ],
          "line": 286
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcasecmp",
          "args": [
            "target",
            "\"HOP\""
          ],
          "line": 285
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcasecmp",
          "args": [
            "target",
            "\"AOP\""
          ],
          "line": 284
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcasecmp",
          "args": [
            "target",
            "\"SOP\""
          ],
          "line": 283
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "snprintf",
          "args": [
            "newstr + (p - md->value)",
            "sizeof newstr - (p - md->value)",
            "\"%s=%s%s\"",
            "target",
            "bitmask_to_flags(newflags)",
            "r != NULL ? r : \"\""
          ],
          "line": 275
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bitmask_to_flags",
          "args": [
            "newflags"
          ],
          "line": 275
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcpy",
          "args": [
            "newstr + (p - md->value)",
            "r != NULL ? r : \"\"",
            "sizeof newstr - (p - md->value)"
          ],
          "line": 271
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcpy",
          "args": [
            "newstr",
            "r != NULL ? r + 1 : \"\"",
            "sizeof newstr"
          ],
          "line": 266
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "flags_to_bitmask",
          "args": [
            "ss",
            "0"
          ],
          "line": 243
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strncasecmp",
          "args": [
            "target",
            "p",
            "l"
          ],
          "line": 240
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcpy",
          "args": [
            "ss",
            "q",
            "sizeof ss"
          ],
          "line": 235
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strchr",
          "args": [
            "q",
            "' '"
          ],
          "line": 232
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strchr",
          "args": [
            "p",
            "'='"
          ],
          "line": 229
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_strlcpy",
          "args": [
            "newstr",
            "p",
            "sizeof newstr"
          ],
          "line": 224
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_find",
          "args": [
            "mc",
            "\"private:templates\""
          ],
          "line": 220
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_nosuch_key",
            "_(\"Invalid template name given, use /%s%s TEMPLATE %s for a list\")",
            "ircd->uses_rcommand ? \"\" : \"msg \"",
            "chansvs.me->disp",
            "mc->name"
          ],
          "line": 204
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_template_flags",
          "args": [
            "mc",
            "flagstr"
          ],
          "line": 201
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_badparams",
            "_(\"No valid flags given, use /%s%s HELP FLAGS for a list\")",
            "ircd->uses_rcommand ? \"\" : \"msg \"",
            "chansvs.me->disp"
          ],
          "line": 194
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "flags_make_bitmasks",
          "args": [
            "flagstr",
            "&addflags",
            "&removeflags"
          ],
          "line": 191
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "target"
          ],
          "line": 181
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_badparams",
            "_(\"Invalid template name \\2%s\\2.\")",
            "target"
          ],
          "line": 178
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_needmoreparams",
            "_(\"Usage: TEMPLATE %s [target flags]\")",
            "channel"
          ],
          "line": 172
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_noprivs",
            "_(\"\\2%s\\2 is closed.\")",
            "channel"
          ],
          "line": 166
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_find",
          "args": [
            "mc",
            "\"private:close:closer\""
          ],
          "line": 164
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "allow_flags",
          "args": [
            "mc",
            "restrictflags"
          ],
          "line": 161
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_noprivs",
            "_(\"You are not authorized to execute this command.\")"
          ],
          "line": 158
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chanacs_source_flags",
          "args": [
            "mc",
            "si"
          ],
          "line": 151
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_noprivs",
            "_(\"You are not logged in.\")"
          ],
          "line": 146
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "logcommand",
          "args": [
            "si",
            "CMDLOG_GET",
            "\"TEMPLATE: \\2%s\\2\"",
            "mc->name"
          ],
          "line": 138
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "logcommand",
          "args": [
            "si",
            "CMDLOG_ADMIN",
            "\"TEMPLATE: \\2%s\\2 (oper override)\"",
            "mc->name"
          ],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"No templates set on channel \\2%s\\2.\")",
            "mc->name"
          ],
          "line": 133
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"End of \\2%s\\2 TEMPLATE listing.\")",
            "mc->name"
          ],
          "line": 130
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "\"%-20s %s\"",
            "\"--------------------\"",
            "\"-----\""
          ],
          "line": 129
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "\"%-20.*s %.*s\"",
            "(int)(q - p)",
            "p",
            "r != NULL ? (int)(r - q - 1) : (int)strlen(q + 1)",
            "q + 1"
          ],
          "line": 125
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strlen",
          "args": [
            "q + 1"
          ],
          "line": 125
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strchr",
          "args": [
            "q",
            "' '"
          ],
          "line": 124
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strchr",
          "args": [
            "p",
            "'='"
          ],
          "line": 121
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "\"%-20s %s\"",
            "\"--------------------\"",
            "\"-----\""
          ],
          "line": 114
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "\"%-20s %s\"",
            "_(\"Name\")",
            "_(\"Flags\")"
          ],
          "line": 113
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_find",
          "args": [
            "mc",
            "\"private:templates\""
          ],
          "line": 109
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_noprivs",
            "_(\"\\2%s\\2 is closed.\")",
            "channel"
          ],
          "line": 105
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "has_priv",
          "args": [
            "si",
            "PRIV_CHAN_AUSPEX"
          ],
          "line": 103
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "metadata_find",
          "args": [
            "mc",
            "\"private:close:closer\""
          ],
          "line": 103
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_noprivs",
            "_(\"You are not authorized to perform this operation.\")"
          ],
          "line": 98
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "has_priv",
          "args": [
            "si",
            "PRIV_CHAN_AUSPEX"
          ],
          "line": 94
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "chanacs_source_has_flag",
          "args": [
            "mc",
            "si",
            "CA_ACLVIEW"
          ],
          "line": 92
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_fail",
          "args": [
            "si",
            "fault_nosuch_target",
            "_(\"Channel \\2%s\\2 is not registered.\")",
            "channel"
          ],
          "line": 86
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mychan_find",
          "args": [
            "channel"
          ],
          "line": 83
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "logcommand",
          "args": [
            "si",
            "CMDLOG_GET",
            "\"TEMPLATE\""
          ],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"template.h\"\n#include \"atheme.h\"\n\nstatic void list_generic_flags(sourceinfo_t *si);\nstatic void cs_cmd_template(sourceinfo_t *si, int parc, char *parv[]);\n\nstatic void cs_cmd_template(sourceinfo_t *si, int parc, char *parv[])\n{\n\tmetadata_t *md;\n\tbool operoverride = false, changechanacs = false;\n\tsize_t l;\n\tchar *channel = parv[0];\n\tchar *target = parv[1];\n\tmychan_t *mc;\n\tunsigned int oldflags, newflags = 0, addflags, removeflags, restrictflags;\n\tchar *p, *q, *r;\n\tchar ss[40], newstr[400];\n\tbool found, denied;\n\n\tif (!channel)\n\t{\n\t\tlist_generic_flags(si);\n\t\tlogcommand(si, CMDLOG_GET, \"TEMPLATE\");\n\t\treturn;\n\t}\n\n\tmc = mychan_find(channel);\n\tif (!mc)\n\t{\n\t\tcommand_fail(si, fault_nosuch_target, _(\"Channel \\2%s\\2 is not registered.\"), channel);\n\t\treturn;\n\t}\n\n\tif (!target)\n\t{\n\t\tif (!(mc->flags & MC_PUBACL) && !chanacs_source_has_flag(mc, si, CA_ACLVIEW))\n\t\t{\n\t\t\tif (has_priv(si, PRIV_CHAN_AUSPEX))\n\t\t\t\toperoverride = true;\n\t\t\telse\n\t\t\t{\n\t\t\t\tcommand_fail(si, fault_noprivs, _(\"You are not authorized to perform this operation.\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tif (metadata_find(mc, \"private:close:closer\") && !has_priv(si, PRIV_CHAN_AUSPEX))\n\t\t{\n\t\t\tcommand_fail(si, fault_noprivs, _(\"\\2%s\\2 is closed.\"), channel);\n\t\t\treturn;\n\t\t}\n\n\t\tmd = metadata_find(mc, \"private:templates\");\n\n\t\tif (md != NULL)\n\t\t{\n\t\t\tcommand_success_nodata(si, \"%-20s %s\", _(\"Name\"), _(\"Flags\"));\n\t\t\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\n\t\t\tp = md->value;\n\t\t\twhile (p != NULL)\n\t\t\t{\n\t\t\t\twhile (*p == ' ')\n\t\t\t\t\tp++;\n\t\t\t\tq = strchr(p, '=');\n\t\t\t\tif (q == NULL)\n\t\t\t\t\tbreak;\n\t\t\t\tr = strchr(q, ' ');\n\t\t\t\tcommand_success_nodata(si, \"%-20.*s %.*s\", (int)(q - p), p, r != NULL ? (int)(r - q - 1) : (int)strlen(q + 1), q + 1);\n\t\t\t\tp = r;\n\t\t\t}\n\n\t\t\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\t\t\tcommand_success_nodata(si, _(\"End of \\2%s\\2 TEMPLATE listing.\"), mc->name);\n\t\t}\n\t\telse\n\t\t\tcommand_success_nodata(si, _(\"No templates set on channel \\2%s\\2.\"), mc->name);\n\n\t\tif (operoverride)\n\t\t\tlogcommand(si, CMDLOG_ADMIN, \"TEMPLATE: \\2%s\\2 (oper override)\", mc->name);\n\t\telse\n\t\t\tlogcommand(si, CMDLOG_GET, \"TEMPLATE: \\2%s\\2\", mc->name);\n\t}\n\telse\n\t{\n\t\tchar *flagstr = parv[2];\n\n\t\tif (!si->smu)\n\t\t{\n\t\t\tcommand_fail(si, fault_noprivs, _(\"You are not logged in.\"));\n\t\t\treturn;\n\t\t}\n\n\t\t/* founder may always set flags -- jilles */\n\t\trestrictflags = chanacs_source_flags(mc, si);\n\t\tif (restrictflags & CA_FOUNDER)\n\t\t\trestrictflags = ca_all;\n\t\telse\n\t\t{\n\t\t\tif (!(restrictflags & CA_FLAGS))\n\t\t\t{\n\t\t\t\tcommand_fail(si, fault_noprivs, _(\"You are not authorized to execute this command.\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\trestrictflags = allow_flags(mc, restrictflags);\n\t\t}\n\n\t\tif (metadata_find(mc, \"private:close:closer\"))\n\t\t{\n\t\t\tcommand_fail(si, fault_noprivs, _(\"\\2%s\\2 is closed.\"), channel);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!target || !flagstr)\n\t\t{\n\t\t\tcommand_fail(si, fault_needmoreparams, _(\"Usage: TEMPLATE %s [target flags]\"), channel);\n\t\t\treturn;\n\t\t}\n\n\t\tif (*target == '+' || *target == '-' || *target == '=')\n\t\t{\n\t\t\tcommand_fail(si, fault_badparams, _(\"Invalid template name \\2%s\\2.\"), target);\n\t\t\treturn;\n\t\t}\n\t\tl = strlen(target);\n\n\t\tif (*flagstr == '!' && (flagstr[1] == '+' || flagstr[1] == '-' || flagstr[1] == '='))\n\t\t{\n\t\t\tchangechanacs = true;\n\t\t\tflagstr++;\n\t\t}\n\n\t\tif (*flagstr == '+' || *flagstr == '-' || *flagstr == '=')\n\t\t{\n\t\t\tflags_make_bitmasks(flagstr, &addflags, &removeflags);\n\t\t\tif (addflags == 0 && removeflags == 0)\n\t\t\t{\n\t\t\t\tcommand_fail(si, fault_badparams, _(\"No valid flags given, use /%s%s HELP FLAGS for a list\"), ircd->uses_rcommand ? \"\" : \"msg \", chansvs.me->disp);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t/* allow copying templates as well */\n\t\t\taddflags = get_template_flags(mc, flagstr);\n\t\t\tif (addflags == 0)\n\t\t\t{\n\t\t\t\tcommand_fail(si, fault_nosuch_key, _(\"Invalid template name given, use /%s%s TEMPLATE %s for a list\"), ircd->uses_rcommand ? \"\" : \"msg \", chansvs.me->disp, mc->name);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tremoveflags = ca_all & ~addflags;\n\t\t}\n\n\t\t/* if adding +F, also add +f */\n\t\tif (addflags & CA_FOUNDER)\n\t\t\taddflags |= CA_FLAGS, removeflags &= ~CA_FLAGS;\n\t\t/* if removing +f, also remove +F */\n\t\telse if (removeflags & CA_FLAGS)\n\t\t\tremoveflags |= CA_FOUNDER, addflags &= ~CA_FOUNDER;\n\n\t\tfound = denied = false;\n\t\toldflags = 0;\n\n\t\tmd = metadata_find(mc, \"private:templates\");\n\t\tif (md != NULL)\n\t\t{\n\t\t\tp = md->value;\n\t\t\tmowgli_strlcpy(newstr, p, sizeof newstr);\n\t\t\twhile (p != NULL)\n\t\t\t{\n\t\t\t\twhile (*p == ' ')\n\t\t\t\t\tp++;\n\t\t\t\tq = strchr(p, '=');\n\t\t\t\tif (q == NULL)\n\t\t\t\t\tbreak;\n\t\t\t\tr = strchr(q, ' ');\n\t\t\t\tif (r != NULL && r < q)\n\t\t\t\t\tbreak;\n\t\t\t\tmowgli_strlcpy(ss, q, sizeof ss);\n\t\t\t\tif (r != NULL && r - q < (int)(sizeof ss - 1))\n\t\t\t\t{\n\t\t\t\t\tss[r - q] = '\\0';\n\t\t\t\t}\n\t\t\t\tif ((size_t)(q - p) == l && !strncasecmp(target, p, l))\n\t\t\t\t{\n\t\t\t\t\tfound = true;\n\t\t\t\t\toldflags = flags_to_bitmask(ss, 0);\n\t\t\t\t\toldflags &= ca_all;\n\t\t\t\t\taddflags &= ~oldflags;\n\t\t\t\t\tremoveflags &= oldflags & ~addflags;\n\t\t\t\t\t/* no change? */\n\t\t\t\t\tif ((addflags | removeflags) == 0)\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t/* attempting to add bad flag? */\n\t\t\t\t\t/* attempting to remove bad flag? */\n\t\t\t\t\t/* attempting to manipulate something with more privs? */\n\t\t\t\t\tif (~restrictflags & addflags ||\n\t\t\t\t\t\t\t~restrictflags & removeflags ||\n\t\t\t\t\t\t\t~restrictflags & oldflags)\n\t\t\t\t\t{\n\t\t\t\t\t\tdenied = true;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tnewflags = (oldflags | addflags) & ~removeflags;\n\t\t\t\t\tif (newflags == 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (p == md->value)\n\t\t\t\t\t\t\t/* removing first entry,\n\t\t\t\t\t\t\t * zap the space after it */\n\t\t\t\t\t\t\tmowgli_strlcpy(newstr, r != NULL ? r + 1 : \"\", sizeof newstr);\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t/* otherwise, zap the space before it */\n\t\t\t\t\t\t\tp--;\n\t\t\t\t\t\t\tmowgli_strlcpy(newstr + (p - md->value), r != NULL ? r : \"\", sizeof newstr - (p - md->value));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t\tsnprintf(newstr + (p - md->value), sizeof newstr - (p - md->value), \"%s=%s%s\", target, bitmask_to_flags(newflags), r != NULL ? r : \"\");\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tp = r;\n\t\t\t}\n\t\t}\n\t\tif (!found)\n\t\t{\n\t\t\tif (l == 3 && !chansvs.hide_xop && (!strcasecmp(target, \"SOP\") ||\n\t\t\t\t\t\t!strcasecmp(target, \"AOP\") ||\n\t\t\t\t\t\t!strcasecmp(target, \"HOP\") ||\n\t\t\t\t\t\t!strcasecmp(target, \"VOP\")))\n\t\t\t{\n\t\t\t\toldflags = get_template_flags(NULL, target);\n\t\t\t\taddflags &= ~oldflags;\n\t\t\t\tremoveflags &= oldflags & ~addflags;\n\t\t\t\tnewflags = (oldflags | addflags) & ~removeflags;\n\t\t\t\tif (newflags == 0)\n\t\t\t\t\tremoveflags = 0;\n\t\t\t\tif ((addflags | removeflags) != 0)\n\t\t\t\t\tcommand_success_nodata(si, _(\"Redefining built-in template \\2%s\\2.\"), target);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tremoveflags = 0;\n\t\t\t\tnewflags = addflags;\n\t\t\t}\n\t\t\tif ((addflags | removeflags) == 0)\n\t\t\t\t;\n\t\t\telse if (~restrictflags & addflags ||\n\t\t\t\t\t~restrictflags & removeflags ||\n\t\t\t\t\t~restrictflags & oldflags)\n\t\t\t\tdenied = true;\n\t\t\telse if (md != NULL)\n\t\t\t\tsnprintf(newstr + strlen(newstr), sizeof newstr - strlen(newstr), \" %s=%s\", target, bitmask_to_flags(newflags));\n\t\t\telse\n\t\t\t\tsnprintf(newstr, sizeof newstr, \"%s=%s\", target, bitmask_to_flags(newflags));\n\t\t}\n\t\tif (oldflags == 0 && has_ctrl_chars(target))\n\t\t{\n\t\t\tcommand_fail(si, fault_badparams, _(\"Invalid template name \\2%s\\2.\"), target);\n\t\t\treturn;\n\t\t}\n\t\tif ((addflags | removeflags) == 0)\n\t\t{\n\t\t\tif (oldflags != 0)\n\t\t\t\tcommand_fail(si, fault_nochange, _(\"Template \\2%s\\2 on \\2%s\\2 unchanged.\"), target, channel);\n\t\t\telse\n\t\t\t\tcommand_fail(si, fault_nosuch_key, _(\"No such template \\2%s\\2 on \\2%s\\2.\"), target, channel);\n\t\t\treturn;\n\t\t}\n\t\tif (denied)\n\t\t{\n\t\t\tcommand_fail(si, fault_noprivs, _(\"You are not allowed to set \\2%s\\2 on template \\2%s\\2 in \\2%s\\2.\"), bitmask_to_flags2(addflags, removeflags), target, mc->name);\n\t\t\treturn;\n\t\t}\n\t\tif (strlen(newstr) >= 300)\n\t\t{\n\t\t\tcommand_fail(si, fault_toomany, _(\"Sorry, too many templates on \\2%s\\2.\"), channel);\n\t\t\treturn;\n\t\t}\n\t\tp = md != NULL ? md->value : NULL;\n\t\twhile (p != NULL)\n\t\t{\n\t\t\twhile (*p == ' ')\n\t\t\tp++;\n\t\t\tq = strchr(p, '=');\n\t\t\tif (q == NULL)\n\t\t\t\t\tbreak;\n\t\t\tr = strchr(q, ' ');\n\t\t\tsnprintf(ss,sizeof ss,\"%.*s\",r != NULL ? (int)(r - q - 1) : (int)strlen(q + 1), q + 1);\n\t\t\tif (flags_to_bitmask(ss,0) == newflags)\n\t\t\t{\n\t\t\t\tcommand_fail(si, fault_alreadyexists, _(\"The template \\2%.*s\\2 already has flags \\2%.*s\\2.\"), (int)(q - p), p, r != NULL ? (int)(r - q - 1) : (int)strlen(q + 1), q + 1);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tp = r;\n\t\t}\n\n\t\tif (newstr[0] == '\\0')\n\t\t\tmetadata_delete(mc, \"private:templates\");\n\t\telse\n\t\t\tmetadata_add(mc, \"private:templates\", newstr);\n\t\tif (oldflags == 0)\n\t\t\tcommand_success_nodata(si, _(\"Added template \\2%s\\2 with flags \\2%s\\2 in \\2%s\\2.\"), target, bitmask_to_flags(newflags), channel);\n\t\telse if (newflags == 0)\n\t\t\tcommand_success_nodata(si, _(\"Removed template \\2%s\\2 from \\2%s\\2.\"), target, channel);\n\t\telse\n\t\t\tcommand_success_nodata(si, _(\"Changed template \\2%s\\2 to \\2%s\\2 in \\2%s\\2.\"), target, bitmask_to_flags(newflags), channel);\n\n\t\tflagstr = bitmask_to_flags2(addflags, removeflags);\n\t\tif (changechanacs)\n\t\t{\n\t\t\tmowgli_node_t *n, *tn;\n\t\t\tchanacs_t *ca;\n\t\t\tint changes = 0, founderskipped = 0;\n\t\t\tchar flagstr2[128];\n\n\t\t\tMOWGLI_ITER_FOREACH_SAFE(n, tn, mc->chanacs.head)\n\t\t\t{\n\t\t\t\tca = n->data;\n\t\t\t\tif (ca->level != oldflags)\n\t\t\t\t\tcontinue;\n\t\t\t\tif ((addflags | removeflags) & CA_FOUNDER)\n\t\t\t\t{\n\t\t\t\t\tfounderskipped++;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tchanges++;\n\t\t\t\tchanacs_modify_simple(ca, newflags, ~newflags);\n\t\t\t\tchanacs_close(ca);\n\t\t\t}\n\t\t\tlogcommand(si, CMDLOG_SET, \"TEMPLATE: \\2%s\\2 \\2%s\\2 !\\2%s\\2 (\\2%d\\2 changes)\", mc->name, target, flagstr, changes);\n\t\t\tmowgli_strlcpy(flagstr2, flagstr, sizeof flagstr2);\n\t\t\tif (changes > 0)\n\t\t\t\tverbose(mc, \"\\2%s\\2 set \\2%s\\2 on %d access entries with flags \\2%s\\2.\", get_source_name(si), flagstr2, changes, bitmask_to_flags(oldflags));\n\t\t\tcommand_success_nodata(si, _(\"%d access entries updated accordingly.\"), changes);\n\t\t\tif (founderskipped)\n\t\t\t\tcommand_success_nodata(si, _(\"Not updating %d access entries involving founder status. Please do it manually.\"), founderskipped);\n\t\t}\n\t\telse\n\t\t\tlogcommand(si, CMDLOG_SET, \"TEMPLATE: \\2%s\\2 \\2%s\\2 \\2%s\\2\", mc->name, target, flagstr);\n\t\t/*verbose(mc, \"Flags \\2%s\\2 were set on template \\2%s\\2 in \\2%s\\2.\", flagstr, target, channel);*/\n\t}\n}"
  },
  {
    "function_name": "list_generic_flags",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/template.c",
    "lines": "51-60",
    "snippet": "static void list_generic_flags(sourceinfo_t *si)\n{\n\tcommand_success_nodata(si, \"%-20s %s\", _(\"Name\"), _(\"Flags\"));\n\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\n\tmowgli_patricia_foreach(global_template_dict, display_template, si);\n\n\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\tcommand_success_nodata(si, _(\"End of network wide template list.\"));\n}",
    "includes": [
      "#include \"template.h\"",
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "static void list_generic_flags(sourceinfo_t *si);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "_(\"End of network wide template list.\")"
          ],
          "line": 59
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_",
          "args": [
            "\"End of network wide template list.\""
          ],
          "line": 59
        },
        "resolved": true,
        "details": {
          "function_name": "list_generic_flags",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/template.c",
          "lines": "51-60",
          "snippet": "static void list_generic_flags(sourceinfo_t *si)\n{\n\tcommand_success_nodata(si, \"%-20s %s\", _(\"Name\"), _(\"Flags\"));\n\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\n\tmowgli_patricia_foreach(global_template_dict, display_template, si);\n\n\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\tcommand_success_nodata(si, _(\"End of network wide template list.\"));\n}",
          "note": "cyclic_reference_detected"
        }
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "\"%-20s %s\"",
            "\"--------------------\"",
            "\"-----\""
          ],
          "line": 58
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mowgli_patricia_foreach",
          "args": [
            "global_template_dict",
            "display_template",
            "si"
          ],
          "line": 56
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "\"%-20s %s\"",
            "\"--------------------\"",
            "\"-----\""
          ],
          "line": 54
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "\"%-20s %s\"",
            "_(\"Name\")",
            "_(\"Flags\")"
          ],
          "line": 53
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"template.h\"\n#include \"atheme.h\"\n\nstatic void list_generic_flags(sourceinfo_t *si);\n\nstatic void list_generic_flags(sourceinfo_t *si)\n{\n\tcommand_success_nodata(si, \"%-20s %s\", _(\"Name\"), _(\"Flags\"));\n\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\n\tmowgli_patricia_foreach(global_template_dict, display_template, si);\n\n\tcommand_success_nodata(si, \"%-20s %s\", \"--------------------\", \"-----\");\n\tcommand_success_nodata(si, _(\"End of network wide template list.\"));\n}"
  },
  {
    "function_name": "display_template",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/template.c",
    "lines": "36-49",
    "snippet": "static int display_template(const char *key, void *data, void *privdata)\n{\n\tsourceinfo_t *si = privdata;\n\tdefault_template_t *def_t = data;\n\tunsigned int vopflags;\n\n\tvopflags = get_global_template_flags(\"VOP\");\n\tif (def_t->flags == vopflags && !strcasecmp(key, \"HOP\"))\n\t\treturn 0;\n\n\tcommand_success_nodata(si, \"%-20s %s\", key, bitmask_to_flags(def_t->flags));\n\n\treturn 0;\n}",
    "includes": [
      "#include \"template.h\"",
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "static void list_generic_flags(sourceinfo_t *si);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "command_success_nodata",
          "args": [
            "si",
            "\"%-20s %s\"",
            "key",
            "bitmask_to_flags(def_t->flags)"
          ],
          "line": 46
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "bitmask_to_flags",
          "args": [
            "def_t->flags"
          ],
          "line": 46
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "strcasecmp",
          "args": [
            "key",
            "\"HOP\""
          ],
          "line": 43
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "get_global_template_flags",
          "args": [
            "\"VOP\""
          ],
          "line": 42
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"template.h\"\n#include \"atheme.h\"\n\nstatic void list_generic_flags(sourceinfo_t *si);\n\nstatic int display_template(const char *key, void *data, void *privdata)\n{\n\tsourceinfo_t *si = privdata;\n\tdefault_template_t *def_t = data;\n\tunsigned int vopflags;\n\n\tvopflags = get_global_template_flags(\"VOP\");\n\tif (def_t->flags == vopflags && !strcasecmp(key, \"HOP\"))\n\t\treturn 0;\n\n\tcommand_success_nodata(si, \"%-20s %s\", key, bitmask_to_flags(def_t->flags));\n\n\treturn 0;\n}"
  },
  {
    "function_name": "_moddeinit",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/template.c",
    "lines": "31-34",
    "snippet": "void _moddeinit(module_unload_intent_t intent)\n{\n\tservice_named_unbind_command(\"chanserv\", &cs_flags);\n}",
    "includes": [
      "#include \"template.h\"",
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "command_t cs_flags = { \"TEMPLATE\", N_(\"Manipulates predefined sets of flags.\"),\n                        AC_NONE, 3, cs_cmd_template, { .path = \"cservice/template\" } };"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "service_named_unbind_command",
          "args": [
            "\"chanserv\"",
            "&cs_flags"
          ],
          "line": 33
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"template.h\"\n#include \"atheme.h\"\n\ncommand_t cs_flags = { \"TEMPLATE\", N_(\"Manipulates predefined sets of flags.\"),\n                        AC_NONE, 3, cs_cmd_template, { .path = \"cservice/template\" } };\n\nvoid _moddeinit(module_unload_intent_t intent)\n{\n\tservice_named_unbind_command(\"chanserv\", &cs_flags);\n}"
  },
  {
    "function_name": "_modinit",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2014-9773/repo/modules/chanserv/template.c",
    "lines": "26-29",
    "snippet": "void _modinit(module_t *m)\n{\n        service_named_bind_command(\"chanserv\", &cs_flags);\n}",
    "includes": [
      "#include \"template.h\"",
      "#include \"atheme.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "command_t cs_flags = { \"TEMPLATE\", N_(\"Manipulates predefined sets of flags.\"),\n                        AC_NONE, 3, cs_cmd_template, { .path = \"cservice/template\" } };"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "service_named_bind_command",
          "args": [
            "\"chanserv\"",
            "&cs_flags"
          ],
          "line": 28
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"template.h\"\n#include \"atheme.h\"\n\ncommand_t cs_flags = { \"TEMPLATE\", N_(\"Manipulates predefined sets of flags.\"),\n                        AC_NONE, 3, cs_cmd_template, { .path = \"cservice/template\" } };\n\nvoid _modinit(module_t *m)\n{\n        service_named_bind_command(\"chanserv\", &cs_flags);\n}"
  }
]