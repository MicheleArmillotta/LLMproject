[
  {
    "function_name": "load_seccomp",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-12589/repo/src/libpostexecseccomp/libpostexecseccomp.c",
    "lines": "28-58",
    "snippet": "__attribute__((constructor))\nstatic void load_seccomp(void) {\n\tint fd = open(RUN_SECCOMP_POSTEXEC, O_RDONLY);\n\tif (fd == -1)\n\t\treturn;\n\n\toff_t size = lseek(fd, 0, SEEK_END);\n\tif (size <= 0) {\n\t\tclose(fd);\n\t\treturn;\n\t}\n\tunsigned short entries = (unsigned short) size / (unsigned short) sizeof(struct sock_filter);\n\tstruct sock_filter *filter = MAP_FAILED;\n\tif (size != 0)\n\t\tfilter = mmap(NULL, size, PROT_READ, MAP_PRIVATE, fd, 0);\n\n\tclose(fd);\n\n\tif (filter == MAP_FAILED)\n\t\treturn;\n\n\t// install filter\n\tstruct sock_fprog prog = {\n\t\t.len = entries,\n\t\t.filter = filter,\n\t};\n\n\tprctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0);\n\tprctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &prog);\n\tmunmap(filter, size);\n}",
    "includes": [
      "#include <unistd.h>",
      "#include <sys/prctl.h>",
      "#include <sys/mman.h>",
      "#include <linux/filter.h>",
      "#include <fcntl.h>",
      "#include \"../include/seccomp.h\"",
      "#include \"libpostexecseccomp.h\""
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "munmap",
          "args": [
            "filter",
            "size"
          ],
          "line": 57
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "prctl",
          "args": [
            "PR_SET_SECCOMP",
            "SECCOMP_MODE_FILTER",
            "&prog"
          ],
          "line": 56
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "prctl",
          "args": [
            "PR_SET_NO_NEW_PRIVS",
            "1",
            "0",
            "0",
            "0"
          ],
          "line": 55
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "close",
          "args": [
            "fd"
          ],
          "line": 44
        },
        "resolved": true,
        "details": {
          "function_name": "rtnl_close",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-12589/repo/src/lib/libnetlink.c",
          "lines": "46-52",
          "snippet": "void rtnl_close(struct rtnl_handle *rth)\n{\n\tif (rth->fd >= 0) {\n\t\tclose(rth->fd);\n\t\trth->fd = -1;\n\t}\n}",
          "includes": [
            "#include \"../include/libnetlink.h\"",
            "#include <sys/uio.h>",
            "#include <time.h>",
            "#include <errno.h>",
            "#include <string.h>",
            "#include <netinet/in.h>",
            "#include <sys/socket.h>",
            "#include <net/if_arp.h>",
            "#include <fcntl.h>",
            "#include <syslog.h>",
            "#include <unistd.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include \"../include/libnetlink.h\"\n#include <sys/uio.h>\n#include <time.h>\n#include <errno.h>\n#include <string.h>\n#include <netinet/in.h>\n#include <sys/socket.h>\n#include <net/if_arp.h>\n#include <fcntl.h>\n#include <syslog.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <stdio.h>\n\nvoid rtnl_close(struct rtnl_handle *rth)\n{\n\tif (rth->fd >= 0) {\n\t\tclose(rth->fd);\n\t\trth->fd = -1;\n\t}\n}"
        }
      },
      {
        "call_info": {
          "callee": "mmap",
          "args": [
            "NULL",
            "size",
            "PROT_READ",
            "MAP_PRIVATE",
            "fd",
            "0"
          ],
          "line": 42
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "lseek",
          "args": [
            "fd",
            "0",
            "SEEK_END"
          ],
          "line": 34
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "open",
          "args": [
            "RUN_SECCOMP_POSTEXEC",
            "O_RDONLY"
          ],
          "line": 30
        },
        "resolved": true,
        "details": {
          "function_name": "fopen64",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2019-12589/repo/src/libtrace/libtrace.c",
          "lines": "320-327",
          "snippet": "FILE *fopen64(const char *pathname, const char *mode) {\n\tif (!orig_fopen64)\n\t\torig_fopen64 = (orig_fopen_t)dlsym(RTLD_NEXT, \"fopen64\");\n\n\tFILE *rv = orig_fopen64(pathname, mode);\n\tprintf(\"%u:%s:fopen64 %s:%p\\n\", pid(), name(), pathname, rv);\n\treturn rv;\n}",
          "includes": [
            "#include <limits.h>",
            "#include <dirent.h>",
            "#include <syslog.h>",
            "#include <sys/stat.h>",
            "#include <sys/un.h>",
            "#include <arpa/inet.h>",
            "#include <netinet/in.h>",
            "#include <sys/socket.h>",
            "#include <unistd.h>",
            "#include <limits.h>",
            "#include <sys/types.h>",
            "#include <dlfcn.h>",
            "#include <string.h>",
            "#include <stdlib.h>",
            "#include <stdio.h>"
          ],
          "macros_used": [],
          "globals_used": [
            "static orig_fopen64_t orig_fopen64 = NULL;"
          ],
          "called_functions": [],
          "contextual_snippet": "#include <limits.h>\n#include <dirent.h>\n#include <syslog.h>\n#include <sys/stat.h>\n#include <sys/un.h>\n#include <arpa/inet.h>\n#include <netinet/in.h>\n#include <sys/socket.h>\n#include <unistd.h>\n#include <limits.h>\n#include <sys/types.h>\n#include <dlfcn.h>\n#include <string.h>\n#include <stdlib.h>\n#include <stdio.h>\n\nstatic orig_fopen64_t orig_fopen64 = NULL;\n\nFILE *fopen64(const char *pathname, const char *mode) {\n\tif (!orig_fopen64)\n\t\torig_fopen64 = (orig_fopen_t)dlsym(RTLD_NEXT, \"fopen64\");\n\n\tFILE *rv = orig_fopen64(pathname, mode);\n\tprintf(\"%u:%s:fopen64 %s:%p\\n\", pid(), name(), pathname, rv);\n\treturn rv;\n}"
        }
      }
    ],
    "contextual_snippet": "#include <unistd.h>\n#include <sys/prctl.h>\n#include <sys/mman.h>\n#include <linux/filter.h>\n#include <fcntl.h>\n#include \"../include/seccomp.h\"\n#include \"libpostexecseccomp.h\"\n\n__attribute__((constructor))\nstatic void load_seccomp(void) {\n\tint fd = open(RUN_SECCOMP_POSTEXEC, O_RDONLY);\n\tif (fd == -1)\n\t\treturn;\n\n\toff_t size = lseek(fd, 0, SEEK_END);\n\tif (size <= 0) {\n\t\tclose(fd);\n\t\treturn;\n\t}\n\tunsigned short entries = (unsigned short) size / (unsigned short) sizeof(struct sock_filter);\n\tstruct sock_filter *filter = MAP_FAILED;\n\tif (size != 0)\n\t\tfilter = mmap(NULL, size, PROT_READ, MAP_PRIVATE, fd, 0);\n\n\tclose(fd);\n\n\tif (filter == MAP_FAILED)\n\t\treturn;\n\n\t// install filter\n\tstruct sock_fprog prog = {\n\t\t.len = entries,\n\t\t.filter = filter,\n\t};\n\n\tprctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0);\n\tprctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &prog);\n\tmunmap(filter, size);\n}"
  }
]