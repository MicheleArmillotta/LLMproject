[
  {
    "function_name": "mod_verify_sig",
    "container": null,
    "file": "output_repos_c/CVE-2022-30594/repo/kernel/module_signing.c",
    "lines": "20-45",
    "snippet": "int mod_verify_sig(const void *mod, struct load_info *info)\n{\n\tstruct module_signature ms;\n\tsize_t sig_len, modlen = info->len;\n\tint ret;\n\n\tpr_devel(\"==>%s(,%zu)\\n\", __func__, modlen);\n\n\tif (modlen <= sizeof(ms))\n\t\treturn -EBADMSG;\n\n\tmemcpy(&ms, mod + (modlen - sizeof(ms)), sizeof(ms));\n\n\tret = mod_check_sig(&ms, modlen, \"module\");\n\tif (ret)\n\t\treturn ret;\n\n\tsig_len = be32_to_cpu(ms.sig_len);\n\tmodlen -= sig_len + sizeof(ms);\n\tinfo->len = modlen;\n\n\treturn verify_pkcs7_signature(mod, modlen, mod + modlen, sig_len,\n\t\t\t\t      VERIFY_USE_SECONDARY_KEYRING,\n\t\t\t\t      VERIFYING_MODULE_SIGNATURE,\n\t\t\t\t      NULL, NULL);\n}",
    "includes": [
      "#include \"module-internal.h\"",
      "#include <crypto/public_key.h>",
      "#include <linux/verification.h>",
      "#include <linux/string.h>",
      "#include <linux/module_signature.h>",
      "#include <linux/module.h>",
      "#include <linux/errno.h>",
      "#include <linux/kernel.h>"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "verify_pkcs7_signature",
          "args": [
            "mod",
            "modlen",
            "mod + modlen",
            "sig_len",
            "VERIFY_USE_SECONDARY_KEYRING",
            "VERIFYING_MODULE_SIGNATURE",
            "NULL",
            "NULL"
          ],
          "line": 41
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "be32_to_cpu",
          "args": [
            "ms.sig_len"
          ],
          "line": 37
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "mod_check_sig",
          "args": [
            "&ms",
            "modlen",
            "\"module\""
          ],
          "line": 33
        },
        "resolved": true,
        "details": {
          "function_name": "mod_check_sig",
          "container": null,
          "file": "output_repos_c/CVE-2022-30594/repo/kernel/module_signature.c",
          "lines": "21-46",
          "snippet": "int mod_check_sig(const struct module_signature *ms, size_t file_len,\n\t\t  const char *name)\n{\n\tif (be32_to_cpu(ms->sig_len) >= file_len - sizeof(*ms))\n\t\treturn -EBADMSG;\n\n\tif (ms->id_type != PKEY_ID_PKCS7) {\n\t\tpr_err(\"%s: not signed with expected PKCS#7 message\\n\",\n\t\t       name);\n\t\treturn -ENOPKG;\n\t}\n\n\tif (ms->algo != 0 ||\n\t    ms->hash != 0 ||\n\t    ms->signer_len != 0 ||\n\t    ms->key_id_len != 0 ||\n\t    ms->__pad[0] != 0 ||\n\t    ms->__pad[1] != 0 ||\n\t    ms->__pad[2] != 0) {\n\t\tpr_err(\"%s: PKCS#7 signature info has unexpected non-zero params\\n\",\n\t\t       name);\n\t\treturn -EBADMSG;\n\t}\n\n\treturn 0;\n}",
          "includes": [
            "#include <asm/byteorder.h>",
            "#include <linux/module_signature.h>",
            "#include <linux/printk.h>",
            "#include <linux/errno.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <asm/byteorder.h>\n#include <linux/module_signature.h>\n#include <linux/printk.h>\n#include <linux/errno.h>\n\nint mod_check_sig(const struct module_signature *ms, size_t file_len,\n\t\t  const char *name)\n{\n\tif (be32_to_cpu(ms->sig_len) >= file_len - sizeof(*ms))\n\t\treturn -EBADMSG;\n\n\tif (ms->id_type != PKEY_ID_PKCS7) {\n\t\tpr_err(\"%s: not signed with expected PKCS#7 message\\n\",\n\t\t       name);\n\t\treturn -ENOPKG;\n\t}\n\n\tif (ms->algo != 0 ||\n\t    ms->hash != 0 ||\n\t    ms->signer_len != 0 ||\n\t    ms->key_id_len != 0 ||\n\t    ms->__pad[0] != 0 ||\n\t    ms->__pad[1] != 0 ||\n\t    ms->__pad[2] != 0) {\n\t\tpr_err(\"%s: PKCS#7 signature info has unexpected non-zero params\\n\",\n\t\t       name);\n\t\treturn -EBADMSG;\n\t}\n\n\treturn 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "memcpy",
          "args": [
            "&ms",
            "mod + (modlen - sizeof(ms))",
            "sizeof(ms)"
          ],
          "line": 31
        },
        "resolved": true,
        "details": {
          "function_name": "memcpy_skip",
          "container": null,
          "file": "output_repos_c/CVE-2022-30594/repo/kernel/events/internal.h",
          "lines": "180-184",
          "snippet": "static inline unsigned long\nmemcpy_skip(void *dst, const void *src, unsigned long n)\n{\n\treturn 0;\n}",
          "includes": [
            "#include <linux/refcount.h>",
            "#include <linux/uaccess.h>",
            "#include <linux/hardirq.h>"
          ],
          "macros_used": [],
          "globals_used": [],
          "called_functions": [],
          "contextual_snippet": "#include <linux/refcount.h>\n#include <linux/uaccess.h>\n#include <linux/hardirq.h>\n\nstatic inline unsigned long\nmemcpy_skip(void *dst, const void *src, unsigned long n)\n{\n\treturn 0;\n}"
        }
      },
      {
        "call_info": {
          "callee": "pr_devel",
          "args": [
            "\"==>%s(,%zu)\\n\"",
            "__func__",
            "modlen"
          ],
          "line": 26
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "#include \"module-internal.h\"\n#include <crypto/public_key.h>\n#include <linux/verification.h>\n#include <linux/string.h>\n#include <linux/module_signature.h>\n#include <linux/module.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n\nint mod_verify_sig(const void *mod, struct load_info *info)\n{\n\tstruct module_signature ms;\n\tsize_t sig_len, modlen = info->len;\n\tint ret;\n\n\tpr_devel(\"==>%s(,%zu)\\n\", __func__, modlen);\n\n\tif (modlen <= sizeof(ms))\n\t\treturn -EBADMSG;\n\n\tmemcpy(&ms, mod + (modlen - sizeof(ms)), sizeof(ms));\n\n\tret = mod_check_sig(&ms, modlen, \"module\");\n\tif (ret)\n\t\treturn ret;\n\n\tsig_len = be32_to_cpu(ms.sig_len);\n\tmodlen -= sig_len + sizeof(ms);\n\tinfo->len = modlen;\n\n\treturn verify_pkcs7_signature(mod, modlen, mod + modlen, sig_len,\n\t\t\t\t      VERIFY_USE_SECONDARY_KEYRING,\n\t\t\t\t      VERIFYING_MODULE_SIGNATURE,\n\t\t\t\t      NULL, NULL);\n}"
  }
]