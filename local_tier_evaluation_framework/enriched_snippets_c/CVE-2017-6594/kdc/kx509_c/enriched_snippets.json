[
  {
    "function_name": "c_do_kx509(kr",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/kx509.c",
    "lines": "376-545",
    "snippet": "5_error_code\n_kdc_do_kx509(krb5_context context,\n\t      krb5_kdc_configuration *config,\n\t      const struct Kx509Request *req, krb5_data *reply,\n\t      const char *from, struct sockaddr *addr)\n{\n    krb5_error_code ret;\n    krb5_ticket *ticket = NULL;\n    krb5_flags ap_req_options;\n    krb5_auth_context ac = NULL;\n    krb5_keytab id = NULL;\n    krb5_principal sprincipal = NULL, cprincipal = NULL;\n    char *cname = NULL;\n    Kx509Response rep;\n    size_t size;\n    krb5_keyblock *key = NULL;\n    krb5_boolean def_bool;\n\n    krb5_data_zero(reply);\n    memset(&rep, 0, sizeof(rep));\n\n    if(!config->enable_kx509) {\n\tkdc_log(context, config, 0,\n\t\t\"Rejected kx509 request (disabled) from %s\", from);\n\treturn KRB5KDC_ERR_POLICY;\n    }\n\n    kdc_log(context, config, 0, \"Kx509 request from %s\", from);\n\n    ret = krb5_kt_resolve(context, \"HDBGET:\", &id);\n    if (ret) {\n\tkdc_log(context, config, 0, \"Can't open database for digest\");\n\tgoto out;\n    }\n\n    ret = krb5_rd_req(context,\n\t\t      &ac,\n\t\t      &req->authenticator,\n\t\t      NULL,\n\t\t      id,\n\t\t      &ap_req_options,\n\t\t      &ticket);\n    if (ret)\n\tgoto out;\n\n    ret = krb5_ticket_get_client(context, ticket, &cprincipal);\n    if (ret)\n\tgoto out;\n\n    def_bool = krb5_config_get_bool_default(context, NULL, TRUE, \"kdc\",\n                                            \"require_initial_kca_tickets\",\n                                            NULL);\n    if (!ticket->ticket.flags.initial &&\n        krb5_config_get_bool_default(context, NULL, def_bool, \"kdc\",\n                                      krb5_principal_get_realm(context,\n                                                               cprincipal),\n                                      \"require_initial_kca_tickets\", NULL)) {\n        ret = KRB5KDC_ERR_POLICY;\n        goto out;\n    }\n\n    ret = krb5_unparse_name(context, cprincipal, &cname);\n    if (ret)\n\tgoto out;\n\n    ret = krb5_ticket_get_server(context, ticket, &sprincipal);\n    if (ret)\n\tgoto out;\n\n    ret = kdc_kx509_verify_service_principal(context, cname, sprincipal);\n    if (ret)\n\tgoto out;\n\n    ret = krb5_auth_con_getkey(context, ac, &key);\n    if (ret == 0 && key == NULL)\n\tret = KRB5KDC_ERR_NULL_KEY;\n    if (ret) {\n\tkrb5_set_error_message(context, ret, \"Kx509 can't get session key\");\n\tgoto out;\n    }\n\n    ret = verify_req_hash(context, req, key);\n    if (ret)\n\tgoto out;\n\n    /* Verify that the key is encoded RSA key */\n    {\n\tRSAPublicKey rsapkey;\n\tsize_t rsapkeysize;\n\n\tret = decode_RSAPublicKey(req->pk_key.data, req->pk_key.length,\n\t\t\t\t  &rsapkey, &rsapkeysize);\n\tif (ret)\n\t    goto out;\n\tfree_RSAPublicKey(&rsapkey);\n\tif (rsapkeysize != req->pk_key.length) {\n\t    ret = ASN1_EXTRA_DATA;\n\t    goto out;\n\t}\n    }\n\n    ALLOC(rep.certificate);\n    if (rep.certificate == NULL)\n\tgoto out;\n    krb5_data_zero(rep.certificate);\n    ALLOC(rep.hash);\n    if (rep.hash == NULL)\n\tgoto out;\n    krb5_data_zero(rep.hash);\n\n    ret = build_certificate(context, config, &req->pk_key,\n\t\t\t    krb5_ticket_get_endtime(context, ticket),\n\t\t\t    cprincipal, rep.certificate);\n    if (ret)\n\tgoto out;\n\n    ret = calculate_reply_hash(context, key, &rep);\n    if (ret)\n\tgoto out;\n\n    /*\n     * Encode reply, [ version | Kx509Response ]\n     */\n\n    {\n\tkrb5_data data;\n\n\tASN1_MALLOC_ENCODE(Kx509Response, data.data, data.length, &rep,\n\t\t\t   &size, ret);\n\tif (ret) {\n\t    krb5_set_error_message(context, ret, \"Failed to encode kx509 reply\");\n\t    goto out;\n\t}\n\tif (size != data.length)\n\t    krb5_abortx(context, \"ASN1 internal error\");\n\n\tret = krb5_data_alloc(reply, data.length + sizeof(version_2_0));\n\tif (ret) {\n\t    free(data.data);\n\t    goto out;\n\t}\n\tmemcpy(reply->data, version_2_0, sizeof(version_2_0));\n\tmemcpy(((unsigned char *)reply->data) + sizeof(version_2_0),\n\t       data.data, data.length);\n\tfree(data.data);\n    }\n\n    kdc_log(context, config, 0, \"Successful Kx509 request for %s\", cname);\n\nout:\n    if (ac)\n\tkrb5_auth_con_free(context, ac);\n    if (ret)\n\tkrb5_warn(context, ret, \"Kx509 request from %s failed\", from);\n    if (ticket)\n\tkrb5_free_ticket(context, ticket);\n    if (id)\n\tkrb5_kt_close(context, id);\n    if (sprincipal)\n\tkrb5_free_principal(context, sprincipal);\n    if (cprincipal)\n\tkrb5_free_principal(context, cprincipal);\n    if (key)\n\tkrb5_free_keyblock (context, key);\n    if (cname)\n\tfree(cname);\n    free_Kx509Response(&rep);\n\n    return 0;\n}\n\n#",
    "includes": [
      "include <hx509.h>",
      "include <rfc2459_asn1.h>\n#",
      "include <hex.h>\n#",
      "include \"kdc_locl.h\"\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "e_Kx509Response(&r",
          "args": [
            "p);"
          ],
          "line": 542
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "e(cn",
          "args": [
            "me);"
          ],
          "line": 541
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_free_keyblock (c",
          "args": [
            "text, k",
            ");"
          ],
          "line": 539
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_free_principal(co",
          "args": [
            "text, c",
            "incipal);"
          ],
          "line": 537
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_free_principal(co",
          "args": [
            "text, s",
            "incipal);"
          ],
          "line": 535
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_kt_close(co",
          "args": [
            "text, i",
            ";"
          ],
          "line": 533
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_free_ticket(co",
          "args": [
            "text, t",
            "ket);"
          ],
          "line": 531
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_warn(co",
          "args": [
            "text, r",
            ", \"",
            "509 request from %s failed\", f",
            "m);"
          ],
          "line": 529
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_auth_con_free(co",
          "args": [
            "text, a",
            ";"
          ],
          "line": 527
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_log(co",
          "args": [
            "text, c",
            "fig, 0",
            "\"",
            "ccessful Kx509 request for %s\", c",
            "me);"
          ],
          "line": 523
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "e(da",
          "args": [
            "a.data);"
          ],
          "line": 520
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "cpy(((",
          "args": [
            "nsigned char *)reply->data) + sizeof(version_2_0),",
            "a.data, d",
            "a.length);"
          ],
          "line": 518
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "cpy(re",
          "args": [
            "ly->data, v",
            "sion_2_0, s",
            "eof(version_2_0));"
          ],
          "line": 517
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "e(da",
          "args": [
            "a.data);"
          ],
          "line": 514
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_data_alloc(re",
          "args": [
            "ly, d",
            "a.length + sizeof(version_2_0));"
          ],
          "line": 512
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_abortx(co",
          "args": [
            "text, \"",
            "N1 internal error\");"
          ],
          "line": 510
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_set_error_message(co",
          "args": [
            "text, r",
            ", \"",
            "iled to encode kx509 reply\");"
          ],
          "line": 506
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "1_MALLOC_ENCODE(Kx",
          "args": [
            "09Response, d",
            "a.data, d",
            "a.length, &",
            "p,",
            "ze, r",
            ");"
          ],
          "line": 503
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "culate_reply_hash(co",
          "args": [
            "text, k",
            ", &",
            "p);"
          ],
          "line": 492
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ld_certificate(co",
          "args": [
            "text, c",
            "fig, &",
            "q->pk_key,",
            "5_ticket_get_endtime(context, ticket),",
            "incipal, r",
            ".certificate);"
          ],
          "line": 486
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_ticket_get_endtime(co",
          "args": [
            "text, t",
            "ket),"
          ],
          "line": 487
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_data_zero(re",
          "args": [
            ".hash);"
          ],
          "line": 484
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "OC(re",
          "args": [
            ".hash);"
          ],
          "line": 481
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_data_zero(re",
          "args": [
            ".certificate);"
          ],
          "line": 480
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "OC(re",
          "args": [
            ".certificate);"
          ],
          "line": 477
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "e_RSAPublicKey(&r",
          "args": [
            "apkey);"
          ],
          "line": 470
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ode_RSAPublicKey(re",
          "args": [
            "->pk_key.data, r",
            "->pk_key.length,",
            "apkey, &",
            "apkeysize);"
          ],
          "line": 466
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ify_req_hash(co",
          "args": [
            "text, r",
            ", k",
            ");"
          ],
          "line": 457
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_set_error_message(co",
          "args": [
            "text, r",
            ", \"",
            "509 can't get session key\");"
          ],
          "line": 453
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_auth_con_getkey(co",
          "args": [
            "text, a",
            "&",
            "y);"
          ],
          "line": 449
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_kx509_verify_service_principal(co",
          "args": [
            "text, c",
            "me, s",
            "incipal);"
          ],
          "line": 445
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_ticket_get_server(co",
          "args": [
            "text, t",
            "ket, &",
            "rincipal);"
          ],
          "line": 441
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_unparse_name(co",
          "args": [
            "text, c",
            "incipal, &",
            "ame);"
          ],
          "line": 437
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_config_get_bool_default(co",
          "args": [
            "text, N",
            "L, d",
            "_bool, \"",
            "c\",",
            "5_principal_get_realm(context,\n                                                               cprincipal),",
            "quire_initial_kca_tickets\", N",
            "L))"
          ],
          "line": 429
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_principal_get_realm(co",
          "args": [
            "text,",
            "incipal),"
          ],
          "line": 430
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_config_get_bool_default(co",
          "args": [
            "text, N",
            "L, T",
            "E, \"",
            "c\",",
            "quire_initial_kca_tickets\",",
            "L);"
          ],
          "line": 425
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_ticket_get_client(co",
          "args": [
            "text, t",
            "ket, &",
            "rincipal);"
          ],
          "line": 421
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_rd_req(co",
          "args": [
            "text,",
            ",",
            "q->authenticator,",
            "L,",
            "_req_options,",
            "cket);"
          ],
          "line": 411
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_log(co",
          "args": [
            "text, c",
            "fig, 0",
            "\"",
            "n't open database for digest\");"
          ],
          "line": 407
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_kt_resolve(co",
          "args": [
            "text, \"",
            "BGET:\", &",
            ");"
          ],
          "line": 405
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_log(co",
          "args": [
            "text, c",
            "fig, 0",
            "\"",
            "509 request from %s\", f",
            "m);"
          ],
          "line": 403
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_log(co",
          "args": [
            "text, c",
            "fig, 0",
            "jected kx509 request (disabled) from %s\", f",
            "m);"
          ],
          "line": 398
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "set(&r",
          "args": [
            "p, 0",
            "s",
            "eof(rep));"
          ],
          "line": 395
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_data_zero(re",
          "args": [
            "ly);"
          ],
          "line": 394
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <rfc2459_asn1.h>\n#\ninclude <hex.h>\n#\ninclude \"kdc_locl.h\"\n#\n\n5_error_code\n_kdc_do_kx509(krb5_context context,\n\t      krb5_kdc_configuration *config,\n\t      const struct Kx509Request *req, krb5_data *reply,\n\t      const char *from, struct sockaddr *addr)\n{\n    krb5_error_code ret;\n    krb5_ticket *ticket = NULL;\n    krb5_flags ap_req_options;\n    krb5_auth_context ac = NULL;\n    krb5_keytab id = NULL;\n    krb5_principal sprincipal = NULL, cprincipal = NULL;\n    char *cname = NULL;\n    Kx509Response rep;\n    size_t size;\n    krb5_keyblock *key = NULL;\n    krb5_boolean def_bool;\n\n    krb5_data_zero(reply);\n    memset(&rep, 0, sizeof(rep));\n\n    if(!config->enable_kx509) {\n\tkdc_log(context, config, 0,\n\t\t\"Rejected kx509 request (disabled) from %s\", from);\n\treturn KRB5KDC_ERR_POLICY;\n    }\n\n    kdc_log(context, config, 0, \"Kx509 request from %s\", from);\n\n    ret = krb5_kt_resolve(context, \"HDBGET:\", &id);\n    if (ret) {\n\tkdc_log(context, config, 0, \"Can't open database for digest\");\n\tgoto out;\n    }\n\n    ret = krb5_rd_req(context,\n\t\t      &ac,\n\t\t      &req->authenticator,\n\t\t      NULL,\n\t\t      id,\n\t\t      &ap_req_options,\n\t\t      &ticket);\n    if (ret)\n\tgoto out;\n\n    ret = krb5_ticket_get_client(context, ticket, &cprincipal);\n    if (ret)\n\tgoto out;\n\n    def_bool = krb5_config_get_bool_default(context, NULL, TRUE, \"kdc\",\n                                            \"require_initial_kca_tickets\",\n                                            NULL);\n    if (!ticket->ticket.flags.initial &&\n        krb5_config_get_bool_default(context, NULL, def_bool, \"kdc\",\n                                      krb5_principal_get_realm(context,\n                                                               cprincipal),\n                                      \"require_initial_kca_tickets\", NULL)) {\n        ret = KRB5KDC_ERR_POLICY;\n        goto out;\n    }\n\n    ret = krb5_unparse_name(context, cprincipal, &cname);\n    if (ret)\n\tgoto out;\n\n    ret = krb5_ticket_get_server(context, ticket, &sprincipal);\n    if (ret)\n\tgoto out;\n\n    ret = kdc_kx509_verify_service_principal(context, cname, sprincipal);\n    if (ret)\n\tgoto out;\n\n    ret = krb5_auth_con_getkey(context, ac, &key);\n    if (ret == 0 && key == NULL)\n\tret = KRB5KDC_ERR_NULL_KEY;\n    if (ret) {\n\tkrb5_set_error_message(context, ret, \"Kx509 can't get session key\");\n\tgoto out;\n    }\n\n    ret = verify_req_hash(context, req, key);\n    if (ret)\n\tgoto out;\n\n    /* Verify that the key is encoded RSA key */\n    {\n\tRSAPublicKey rsapkey;\n\tsize_t rsapkeysize;\n\n\tret = decode_RSAPublicKey(req->pk_key.data, req->pk_key.length,\n\t\t\t\t  &rsapkey, &rsapkeysize);\n\tif (ret)\n\t    goto out;\n\tfree_RSAPublicKey(&rsapkey);\n\tif (rsapkeysize != req->pk_key.length) {\n\t    ret = ASN1_EXTRA_DATA;\n\t    goto out;\n\t}\n    }\n\n    ALLOC(rep.certificate);\n    if (rep.certificate == NULL)\n\tgoto out;\n    krb5_data_zero(rep.certificate);\n    ALLOC(rep.hash);\n    if (rep.hash == NULL)\n\tgoto out;\n    krb5_data_zero(rep.hash);\n\n    ret = build_certificate(context, config, &req->pk_key,\n\t\t\t    krb5_ticket_get_endtime(context, ticket),\n\t\t\t    cprincipal, rep.certificate);\n    if (ret)\n\tgoto out;\n\n    ret = calculate_reply_hash(context, key, &rep);\n    if (ret)\n\tgoto out;\n\n    /*\n     * Encode reply, [ version | Kx509Response ]\n     */\n\n    {\n\tkrb5_data data;\n\n\tASN1_MALLOC_ENCODE(Kx509Response, data.data, data.length, &rep,\n\t\t\t   &size, ret);\n\tif (ret) {\n\t    krb5_set_error_message(context, ret, \"Failed to encode kx509 reply\");\n\t    goto out;\n\t}\n\tif (size != data.length)\n\t    krb5_abortx(context, \"ASN1 internal error\");\n\n\tret = krb5_data_alloc(reply, data.length + sizeof(version_2_0));\n\tif (ret) {\n\t    free(data.data);\n\t    goto out;\n\t}\n\tmemcpy(reply->data, version_2_0, sizeof(version_2_0));\n\tmemcpy(((unsigned char *)reply->data) + sizeof(version_2_0),\n\t       data.data, data.length);\n\tfree(data.data);\n    }\n\n    kdc_log(context, config, 0, \"Successful Kx509 request for %s\", cname);\n\nout:\n    if (ac)\n\tkrb5_auth_con_free(context, ac);\n    if (ret)\n\tkrb5_warn(context, ret, \"Kx509 request from %s failed\", from);\n    if (ticket)\n\tkrb5_free_ticket(context, ticket);\n    if (id)\n\tkrb5_kt_close(context, id);\n    if (sprincipal)\n\tkrb5_free_principal(context, sprincipal);\n    if (cprincipal)\n\tkrb5_free_principal(context, cprincipal);\n    if (key)\n\tkrb5_free_keyblock (context, key);\n    if (cname)\n\tfree(cname);\n    free_Kx509Response(&rep);\n\n    return 0;\n}\n\n#"
  },
  {
    "function_name": "_kx509_verify_service_principal(kr",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/kx509.c",
    "lines": "325-370",
    "snippet": "5_error_code\nkdc_kx509_verify_service_principal(krb5_context context,\n\t\t\t\t   const char *cname,\n\t\t\t\t   krb5_principal sprincipal)\n{\n    krb5_error_code ret, aret;\n    krb5_boolean bret;\n    krb5_principal principal = NULL;\n    char *expected = NULL;\n    char localhost[MAXHOSTNAMELEN];\n\n    ret = gethostname(localhost, sizeof(localhost) - 1);\n    if (ret != 0) {\n\tret = errno;\n\tkrb5_set_error_message(context, ret,\n\t\t\t       N_(\"Failed to get local hostname\", \"\"));\n\treturn ret;\n    }\n    localhost[sizeof(localhost) - 1] = '\\0';\n\n    ret = krb5_make_principal(context, &principal, \"\", \"kca_service\",\n\t\t\t      localhost, NULL);\n    if (ret)\n\tgoto out;\n\n    bret = krb5_principal_compare_any_realm(context, sprincipal, principal);\n    if (bret == TRUE)\n\tgoto out;\t/* found a match */\n\n    ret = KRB5KDC_ERR_SERVER_NOMATCH;\n\n    aret = krb5_unparse_name(context, sprincipal, &expected);\n    if (aret)\n\tgoto out;\n\n    krb5_set_error_message(context, ret,\n\t\t\t   \"User %s used wrong Kx509 service \"\n\t\t\t   \"principal, expected: %s\",\n\t\t\t   cname, expected);\n\n  out:\n    krb5_xfree(expected);\n    krb5_free_principal(context, principal);\n\n    return ret;\n}\n\n/",
    "includes": [
      "include <hx509.h>",
      "include <rfc2459_asn1.h>\n#",
      "include <hex.h>\n#",
      "include \"kdc_locl.h\"\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "5_free_principal(co",
          "args": [
            "text, p",
            "ncipal);"
          ],
          "line": 367
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_xfree(ex",
          "args": [
            "ected);"
          ],
          "line": 366
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_set_error_message(co",
          "args": [
            "text, r",
            ",",
            "er %s used wrong Kx509 service \"\n\t\t\t   \"principal, expected: %s\",",
            "me, e",
            "ected);"
          ],
          "line": 360
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_unparse_name(co",
          "args": [
            "text, s",
            "incipal, &",
            "pected);"
          ],
          "line": 356
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_principal_compare_any_realm(co",
          "args": [
            "text, s",
            "incipal, p",
            "ncipal);"
          ],
          "line": 350
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_make_principal(co",
          "args": [
            "text, &",
            "incipal, \"",
            "\"",
            "a_service\",",
            "alhost, N",
            "L);"
          ],
          "line": 345
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_set_error_message(co",
          "args": [
            "text, r",
            ",",
            "\"Failed to get local hostname\", \"\"));"
          ],
          "line": 339
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "\"F",
          "args": [
            "iled to get local hostname\", \"",
            ");"
          ],
          "line": 340
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "hostname(lo",
          "args": [
            "alhost, s",
            "eof(localhost) - 1);"
          ],
          "line": 336
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <rfc2459_asn1.h>\n#\ninclude <hex.h>\n#\ninclude \"kdc_locl.h\"\n#\n\n5_error_code\nkdc_kx509_verify_service_principal(krb5_context context,\n\t\t\t\t   const char *cname,\n\t\t\t\t   krb5_principal sprincipal)\n{\n    krb5_error_code ret, aret;\n    krb5_boolean bret;\n    krb5_principal principal = NULL;\n    char *expected = NULL;\n    char localhost[MAXHOSTNAMELEN];\n\n    ret = gethostname(localhost, sizeof(localhost) - 1);\n    if (ret != 0) {\n\tret = errno;\n\tkrb5_set_error_message(context, ret,\n\t\t\t       N_(\"Failed to get local hostname\", \"\"));\n\treturn ret;\n    }\n    localhost[sizeof(localhost) - 1] = '\\0';\n\n    ret = krb5_make_principal(context, &principal, \"\", \"kca_service\",\n\t\t\t      localhost, NULL);\n    if (ret)\n\tgoto out;\n\n    bret = krb5_principal_compare_any_realm(context, sprincipal, principal);\n    if (bret == TRUE)\n\tgoto out;\t/* found a match */\n\n    ret = KRB5KDC_ERR_SERVER_NOMATCH;\n\n    aret = krb5_unparse_name(context, sprincipal, &expected);\n    if (aret)\n\tgoto out;\n\n    krb5_set_error_message(context, ret,\n\t\t\t   \"User %s used wrong Kx509 service \"\n\t\t\t   \"principal, expected: %s\",\n\t\t\t   cname, expected);\n\n  out:\n    krb5_xfree(expected);\n    krb5_free_principal(context, principal);\n\n    return ret;\n}\n\n/"
  },
  {
    "function_name": "ld_certificate(kr",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/kx509.c",
    "lines": "138-323",
    "snippet": "tic krb5_error_code\nbuild_certificate(krb5_context context,\n\t\t  krb5_kdc_configuration *config,\n\t\t  const krb5_data *key,\n\t\t  time_t endtime,\n\t\t  krb5_principal principal,\n\t\t  krb5_data *certificate)\n{\n    char *name = NULL;\n    const char *kx509_ca;\n    hx509_ca_tbs tbs = NULL;\n    hx509_env env = NULL;\n    hx509_cert cert = NULL;\n    hx509_cert signer = NULL;\n    krb5_boolean def_bool;\n    int ret;\n\n    ret = krb5_unparse_name_flags(context, principal,\n\t\t\t\t  KRB5_PRINCIPAL_UNPARSE_NO_REALM,\n\t\t\t\t  &name);\n    if (ret)\n\tgoto out;\n\n    ret = hx509_env_add(context->hx509ctx, &env, \"principal-name-without-realm\",\n\t\t\tname);\n    krb5_xfree(name);\n    name = NULL;\n    if (ret)\n\tgoto out;\n\n    /*\n     * Include the realm in the principal-name env var; the template\n     * might not use $principal-name-realm after all.\n     */\n    ret = krb5_unparse_name(context, principal, &name);\n    if (ret)\n\tgoto out;\n\n    ret = hx509_env_add(context->hx509ctx, &env, \"principal-name\",\n\t\t\tname);\n    if (ret)\n\tgoto out;\n\n    ret = hx509_env_add(context->hx509ctx, &env, \"principal-name-realm\",\n\t\t\tkrb5_principal_get_realm(context, principal));\n    if (ret)\n\tgoto out;\n\n    /* Pick an issuer based on the crealm if we can */\n    kx509_ca = krb5_config_get_string(context, NULL, \"kdc\",\n                                      krb5_principal_get_realm(context,\n                                                               principal),\n                                      \"kx509_ca\", NULL);\n    if (kx509_ca == NULL)\n        kx509_ca = config->kx509_ca;\n\n    {\n\thx509_certs certs;\n\thx509_query *q;\n\n\tret = hx509_certs_init(context->hx509ctx, config->kx509_ca, 0,\n\t\t\t       NULL, &certs);\n\tif (ret) {\n\t    kdc_log(context, config, 0, \"Failed to load CA %s\",\n\t\t    config->kx509_ca);\n\t    goto out;\n\t}\n\tret = hx509_query_alloc(context->hx509ctx, &q);\n\tif (ret) {\n\t    hx509_certs_free(&certs);\n\t    goto out;\n\t}\n\n\thx509_query_match_option(q, HX509_QUERY_OPTION_PRIVATE_KEY);\n\thx509_query_match_option(q, HX509_QUERY_OPTION_KU_KEYCERTSIGN);\n\n\tret = hx509_certs_find(context->hx509ctx, certs, q, &signer);\n\thx509_query_free(context->hx509ctx, q);\n\thx509_certs_free(&certs);\n\tif (ret) {\n\t    kdc_log(context, config, 0, \"Failed to find a CA in %s\",\n\t\t    config->kx509_ca);\n\t    goto out;\n\t}\n    }\n\n    ret = hx509_ca_tbs_init(context->hx509ctx, &tbs);\n    if (ret)\n\tgoto out;\n\n    {\n\tSubjectPublicKeyInfo spki;\n\theim_any any;\n\n\tmemset(&spki, 0, sizeof(spki));\n\n\tspki.subjectPublicKey.data = key->data;\n\tspki.subjectPublicKey.length = key->length * 8;\n\n\tret = der_copy_oid(&asn1_oid_id_pkcs1_rsaEncryption,\n\t\t\t   &spki.algorithm.algorithm);\n\n\tany.data = \"\\x05\\x00\";\n\tany.length = 2;\n\tspki.algorithm.parameters = &any;\n\n\tret = hx509_ca_tbs_set_spki(context->hx509ctx, tbs, &spki);\n\tder_free_oid(&spki.algorithm.algorithm);\n\tif (ret)\n\t    goto out;\n    }\n\n    {\n\thx509_certs certs;\n\thx509_cert template;\n\n\tret = hx509_certs_init(context->hx509ctx, config->kx509_template, 0,\n\t\t\t       NULL, &certs);\n\tif (ret) {\n\t    kdc_log(context, config, 0, \"Failed to load template %s\",\n\t\t    config->kx509_template);\n\t    goto out;\n\t}\n\tret = hx509_get_one_cert(context->hx509ctx, certs, &template);\n\thx509_certs_free(&certs);\n\tif (ret) {\n\t    kdc_log(context, config, 0, \"Failed to find template in %s\",\n\t\t    config->kx509_template);\n\t    goto out;\n\t}\n\tret = hx509_ca_tbs_set_template(context->hx509ctx, tbs,\n\t\t\t\t\tHX509_CA_TEMPLATE_SUBJECT|\n\t\t\t\t\tHX509_CA_TEMPLATE_KU|\n\t\t\t\t\tHX509_CA_TEMPLATE_EKU,\n\t\t\t\t\ttemplate);\n\thx509_cert_free(template);\n\tif (ret)\n\t    goto out;\n    }\n\n    def_bool = krb5_config_get_bool_default(context, NULL, TRUE, \"kdc\",\n                                            \"kx509_include_pkinit_san\",\n                                            NULL);\n    if (krb5_config_get_bool_default(context, NULL, def_bool, \"kdc\",\n                                     krb5_principal_get_realm(context,\n                                                              principal),\n                                     \"kx509_include_pkinit_san\",\n                                     NULL)) {\n        ret = hx509_ca_tbs_add_san_pkinit(context->hx509ctx, tbs, name);\n        if (ret)\n            goto out;\n    }\n\n    hx509_ca_tbs_set_notAfter(context->hx509ctx, tbs, endtime);\n\n    hx509_ca_tbs_subject_expand(context->hx509ctx, tbs, env);\n    hx509_env_free(&env);\n\n    ret = hx509_ca_sign(context->hx509ctx, tbs, signer, &cert);\n    hx509_cert_free(signer);\n    if (ret)\n\tgoto out;\n\n    hx509_ca_tbs_free(&tbs);\n\n    ret = hx509_cert_binary(context->hx509ctx, cert, certificate);\n    hx509_cert_free(cert);\n    if (ret)\n\tgoto out;\n\n    /* cleanup on success */\n    krb5_xfree(name);\n\n    return 0;\nout:\n    if (name)\n\tkrb5_xfree(name);\n    if (env)\n\thx509_env_free(&env);\n    if (tbs)\n\thx509_ca_tbs_free(&tbs);\n    if (signer)\n\thx509_cert_free(signer);\n    krb5_set_error_message(context, ret, \"cert creation failed\");\n    return ret;\n}\n\nk",
    "includes": [
      "include <hx509.h>",
      "include <rfc2459_asn1.h>\n#",
      "include <hex.h>\n#",
      "include \"kdc_locl.h\"\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "5_set_error_message(co",
          "args": [
            "text, r",
            ", \"",
            "rt creation failed\");"
          ],
          "line": 321
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_cert_free(si",
          "args": [
            "ner);"
          ],
          "line": 320
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_ca_tbs_free(&t",
          "args": [
            "s);"
          ],
          "line": 318
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_env_free(&e",
          "args": [
            "v);"
          ],
          "line": 316
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_xfree(na",
          "args": [
            "e);"
          ],
          "line": 314
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_xfree(na",
          "args": [
            "e);"
          ],
          "line": 309
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_cert_free(ce",
          "args": [
            "t);"
          ],
          "line": 304
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_cert_binary(co",
          "args": [
            "text->hx509ctx, c",
            "t, c",
            "tificate);"
          ],
          "line": 303
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_ca_tbs_free(&t",
          "args": [
            "s);"
          ],
          "line": 301
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_cert_free(si",
          "args": [
            "ner);"
          ],
          "line": 297
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_ca_sign(co",
          "args": [
            "text->hx509ctx, t",
            ", s",
            "ner, &",
            "rt);"
          ],
          "line": 296
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_env_free(&e",
          "args": [
            "v);"
          ],
          "line": 294
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_ca_tbs_subject_expand(co",
          "args": [
            "text->hx509ctx, t",
            ", e",
            ");"
          ],
          "line": 293
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_ca_tbs_set_notAfter(co",
          "args": [
            "text->hx509ctx, t",
            ", e",
            "time);"
          ],
          "line": 291
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_ca_tbs_add_san_pkinit(co",
          "args": [
            "text->hx509ctx, t",
            ", n",
            "e);"
          ],
          "line": 286
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_config_get_bool_default(co",
          "args": [
            "text, N",
            "L, d",
            "_bool, \"",
            "c\",",
            "5_principal_get_realm(context,\n                                                              principal),",
            "509_include_pkinit_san\",",
            "L))"
          ],
          "line": 281
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_principal_get_realm(co",
          "args": [
            "text,",
            "ncipal),"
          ],
          "line": 282
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_config_get_bool_default(co",
          "args": [
            "text, N",
            "L, T",
            "E, \"",
            "c\",",
            "509_include_pkinit_san\",",
            "L);"
          ],
          "line": 278
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_cert_free(te",
          "args": [
            "plate);"
          ],
          "line": 273
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_ca_tbs_set_template(co",
          "args": [
            "text->hx509ctx, t",
            ",",
            "09_CA_TEMPLATE_SUBJECT|\n\t\t\t\t\tHX509_CA_TEMPLATE_KU|\n\t\t\t\t\tHX509_CA_TEMPLATE_EKU,",
            "plate);"
          ],
          "line": 268
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_log(co",
          "args": [
            "text, c",
            "fig, 0",
            "\"",
            "iled to find template in %s\",",
            "fig->kx509_template);"
          ],
          "line": 264
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_certs_free(&c",
          "args": [
            "rts);"
          ],
          "line": 262
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_get_one_cert(co",
          "args": [
            "text->hx509ctx, c",
            "ts, &",
            "mplate);"
          ],
          "line": 261
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_log(co",
          "args": [
            "text, c",
            "fig, 0",
            "\"",
            "iled to load template %s\",",
            "fig->kx509_template);"
          ],
          "line": 257
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_certs_init(co",
          "args": [
            "text->hx509ctx, c",
            "fig->kx509_template, 0",
            "L, &",
            "rts);"
          ],
          "line": 254
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_free_oid(&s",
          "args": [
            "ki.algorithm.algorithm);"
          ],
          "line": 245
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_ca_tbs_set_spki(co",
          "args": [
            "text->hx509ctx, t",
            ", &",
            "ki);"
          ],
          "line": 244
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_copy_oid(&a",
          "args": [
            "n1_oid_id_pkcs1_rsaEncryption,",
            "ki.algorithm.algorithm);"
          ],
          "line": 237
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "set(&s",
          "args": [
            "ki, 0",
            "s",
            "eof(spki));"
          ],
          "line": 232
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_ca_tbs_init(co",
          "args": [
            "text->hx509ctx, &",
            "s);"
          ],
          "line": 224
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_log(co",
          "args": [
            "text, c",
            "fig, 0",
            "\"",
            "iled to find a CA in %s\",",
            "fig->kx509_ca);"
          ],
          "line": 218
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_certs_free(&c",
          "args": [
            "rts);"
          ],
          "line": 216
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_query_free(co",
          "args": [
            "text->hx509ctx, q"
          ],
          "line": 215
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_certs_find(co",
          "args": [
            "text->hx509ctx, c",
            "ts, q",
            "&",
            "gner);"
          ],
          "line": 214
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_query_match_option(q,",
          "args": [
            "H",
            "09_QUERY_OPTION_KU_KEYCERTSIGN);"
          ],
          "line": 212
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_query_match_option(q,",
          "args": [
            "H",
            "09_QUERY_OPTION_PRIVATE_KEY);"
          ],
          "line": 211
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_certs_free(&c",
          "args": [
            "rts);"
          ],
          "line": 207
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_query_alloc(co",
          "args": [
            "text->hx509ctx, &",
            ";"
          ],
          "line": 205
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "_log(co",
          "args": [
            "text, c",
            "fig, 0",
            "\"",
            "iled to load CA %s\",",
            "fig->kx509_ca);"
          ],
          "line": 201
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_certs_init(co",
          "args": [
            "text->hx509ctx, c",
            "fig->kx509_ca, 0",
            "L, &",
            "rts);"
          ],
          "line": 198
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_config_get_string(co",
          "args": [
            "text, N",
            "L, \"",
            "c\",",
            "5_principal_get_realm(context,\n                                                               principal),",
            "509_ca\", N",
            "L);"
          ],
          "line": 187
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_principal_get_realm(co",
          "args": [
            "text,",
            "ncipal),"
          ],
          "line": 188
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_env_add(co",
          "args": [
            "text->hx509ctx, &",
            "v, \"",
            "incipal-name-realm\",",
            "5_principal_get_realm(context, principal));"
          ],
          "line": 181
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_principal_get_realm(co",
          "args": [
            "text, p",
            "ncipal));"
          ],
          "line": 182
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_env_add(co",
          "args": [
            "text->hx509ctx, &",
            "v, \"",
            "incipal-name\",",
            "e);"
          ],
          "line": 176
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_unparse_name(co",
          "args": [
            "text, p",
            "ncipal, &",
            "me);"
          ],
          "line": 172
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_xfree(na",
          "args": [
            "e);"
          ],
          "line": 163
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "09_env_add(co",
          "args": [
            "text->hx509ctx, &",
            "v, \"",
            "incipal-name-without-realm\",",
            "e);"
          ],
          "line": 161
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "5_unparse_name_flags(co",
          "args": [
            "text, p",
            "ncipal,",
            "5_PRINCIPAL_UNPARSE_NO_REALM,",
            "me);"
          ],
          "line": 155
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <rfc2459_asn1.h>\n#\ninclude <hex.h>\n#\ninclude \"kdc_locl.h\"\n#\n\ntic krb5_error_code\nbuild_certificate(krb5_context context,\n\t\t  krb5_kdc_configuration *config,\n\t\t  const krb5_data *key,\n\t\t  time_t endtime,\n\t\t  krb5_principal principal,\n\t\t  krb5_data *certificate)\n{\n    char *name = NULL;\n    const char *kx509_ca;\n    hx509_ca_tbs tbs = NULL;\n    hx509_env env = NULL;\n    hx509_cert cert = NULL;\n    hx509_cert signer = NULL;\n    krb5_boolean def_bool;\n    int ret;\n\n    ret = krb5_unparse_name_flags(context, principal,\n\t\t\t\t  KRB5_PRINCIPAL_UNPARSE_NO_REALM,\n\t\t\t\t  &name);\n    if (ret)\n\tgoto out;\n\n    ret = hx509_env_add(context->hx509ctx, &env, \"principal-name-without-realm\",\n\t\t\tname);\n    krb5_xfree(name);\n    name = NULL;\n    if (ret)\n\tgoto out;\n\n    /*\n     * Include the realm in the principal-name env var; the template\n     * might not use $principal-name-realm after all.\n     */\n    ret = krb5_unparse_name(context, principal, &name);\n    if (ret)\n\tgoto out;\n\n    ret = hx509_env_add(context->hx509ctx, &env, \"principal-name\",\n\t\t\tname);\n    if (ret)\n\tgoto out;\n\n    ret = hx509_env_add(context->hx509ctx, &env, \"principal-name-realm\",\n\t\t\tkrb5_principal_get_realm(context, principal));\n    if (ret)\n\tgoto out;\n\n    /* Pick an issuer based on the crealm if we can */\n    kx509_ca = krb5_config_get_string(context, NULL, \"kdc\",\n                                      krb5_principal_get_realm(context,\n                                                               principal),\n                                      \"kx509_ca\", NULL);\n    if (kx509_ca == NULL)\n        kx509_ca = config->kx509_ca;\n\n    {\n\thx509_certs certs;\n\thx509_query *q;\n\n\tret = hx509_certs_init(context->hx509ctx, config->kx509_ca, 0,\n\t\t\t       NULL, &certs);\n\tif (ret) {\n\t    kdc_log(context, config, 0, \"Failed to load CA %s\",\n\t\t    config->kx509_ca);\n\t    goto out;\n\t}\n\tret = hx509_query_alloc(context->hx509ctx, &q);\n\tif (ret) {\n\t    hx509_certs_free(&certs);\n\t    goto out;\n\t}\n\n\thx509_query_match_option(q, HX509_QUERY_OPTION_PRIVATE_KEY);\n\thx509_query_match_option(q, HX509_QUERY_OPTION_KU_KEYCERTSIGN);\n\n\tret = hx509_certs_find(context->hx509ctx, certs, q, &signer);\n\thx509_query_free(context->hx509ctx, q);\n\thx509_certs_free(&certs);\n\tif (ret) {\n\t    kdc_log(context, config, 0, \"Failed to find a CA in %s\",\n\t\t    config->kx509_ca);\n\t    goto out;\n\t}\n    }\n\n    ret = hx509_ca_tbs_init(context->hx509ctx, &tbs);\n    if (ret)\n\tgoto out;\n\n    {\n\tSubjectPublicKeyInfo spki;\n\theim_any any;\n\n\tmemset(&spki, 0, sizeof(spki));\n\n\tspki.subjectPublicKey.data = key->data;\n\tspki.subjectPublicKey.length = key->length * 8;\n\n\tret = der_copy_oid(&asn1_oid_id_pkcs1_rsaEncryption,\n\t\t\t   &spki.algorithm.algorithm);\n\n\tany.data = \"\\x05\\x00\";\n\tany.length = 2;\n\tspki.algorithm.parameters = &any;\n\n\tret = hx509_ca_tbs_set_spki(context->hx509ctx, tbs, &spki);\n\tder_free_oid(&spki.algorithm.algorithm);\n\tif (ret)\n\t    goto out;\n    }\n\n    {\n\thx509_certs certs;\n\thx509_cert template;\n\n\tret = hx509_certs_init(context->hx509ctx, config->kx509_template, 0,\n\t\t\t       NULL, &certs);\n\tif (ret) {\n\t    kdc_log(context, config, 0, \"Failed to load template %s\",\n\t\t    config->kx509_template);\n\t    goto out;\n\t}\n\tret = hx509_get_one_cert(context->hx509ctx, certs, &template);\n\thx509_certs_free(&certs);\n\tif (ret) {\n\t    kdc_log(context, config, 0, \"Failed to find template in %s\",\n\t\t    config->kx509_template);\n\t    goto out;\n\t}\n\tret = hx509_ca_tbs_set_template(context->hx509ctx, tbs,\n\t\t\t\t\tHX509_CA_TEMPLATE_SUBJECT|\n\t\t\t\t\tHX509_CA_TEMPLATE_KU|\n\t\t\t\t\tHX509_CA_TEMPLATE_EKU,\n\t\t\t\t\ttemplate);\n\thx509_cert_free(template);\n\tif (ret)\n\t    goto out;\n    }\n\n    def_bool = krb5_config_get_bool_default(context, NULL, TRUE, \"kdc\",\n                                            \"kx509_include_pkinit_san\",\n                                            NULL);\n    if (krb5_config_get_bool_default(context, NULL, def_bool, \"kdc\",\n                                     krb5_principal_get_realm(context,\n                                                              principal),\n                                     \"kx509_include_pkinit_san\",\n                                     NULL)) {\n        ret = hx509_ca_tbs_add_san_pkinit(context->hx509ctx, tbs, name);\n        if (ret)\n            goto out;\n    }\n\n    hx509_ca_tbs_set_notAfter(context->hx509ctx, tbs, endtime);\n\n    hx509_ca_tbs_subject_expand(context->hx509ctx, tbs, env);\n    hx509_env_free(&env);\n\n    ret = hx509_ca_sign(context->hx509ctx, tbs, signer, &cert);\n    hx509_cert_free(signer);\n    if (ret)\n\tgoto out;\n\n    hx509_ca_tbs_free(&tbs);\n\n    ret = hx509_cert_binary(context->hx509ctx, cert, certificate);\n    hx509_cert_free(cert);\n    if (ret)\n\tgoto out;\n\n    /* cleanup on success */\n    krb5_xfree(name);\n\n    return 0;\nout:\n    if (name)\n\tkrb5_xfree(name);\n    if (env)\n\thx509_env_free(&env);\n    if (tbs)\n\thx509_ca_tbs_free(&tbs);\n    if (signer)\n\thx509_cert_free(signer);\n    krb5_set_error_message(context, ret, \"cert creation failed\");\n    return ret;\n}\n\nk"
  },
  {
    "function_name": "alculate_reply_hash(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/kx509.c",
    "lines": "95-132",
    "snippet": "tatic krb5_error_code\ncalculate_reply_hash(krb5_context context,\n\t\t     krb5_keyblock *key,\n\t\t     Kx509Response *rep)\n{\n    krb5_error_code ret;\n    HMAC_CTX ctx;\n\n    HMAC_CTX_init(&ctx);\n\n    HMAC_Init_ex(&ctx, key->keyvalue.data, key->keyvalue.length,\n\t\t EVP_sha1(), NULL);\n    ret = krb5_data_alloc(rep->hash, HMAC_size(&ctx));\n    if (ret) {\n\tHMAC_CTX_cleanup(&ctx);\n\tkrb5_set_error_message(context, ENOMEM, \"malloc: out of memory\");\n\treturn ENOMEM;\n    }\n\n    HMAC_Update(&ctx, version_2_0, sizeof(version_2_0));\n    if (rep->error_code) {\n\tint32_t t = *rep->error_code;\n\tdo {\n\t    unsigned char p = (t & 0xff);\n\t    HMAC_Update(&ctx, &p, 1);\n\t    t >>= 8;\n\t} while (t);\n    }\n    if (rep->certificate)\n\tHMAC_Update(&ctx, rep->certificate->data, rep->certificate->length);\n    if (rep->e_text)\n\tHMAC_Update(&ctx, (unsigned char *)*rep->e_text, strlen(*rep->e_text));\n\n    HMAC_Final(&ctx, rep->hash->data, 0);\n    HMAC_CTX_cleanup(&ctx);\n\n    return 0;\n}",
    "includes": [
      "include <hx509.h>",
      "include <rfc2459_asn1.h>\n#",
      "include <hex.h>\n#",
      "include \"kdc_locl.h\"\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "MAC_CTX_cleanup(",
          "args": [
            "ctx)"
          ],
          "line": 129
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_Final(",
          "args": [
            "ctx,",
            "ep->hash->data,",
            ")"
          ],
          "line": 128
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_Update(",
          "args": [
            "ctx,",
            "unsigned char *)*rep->e_text,",
            "trlen(*rep->e_text))"
          ],
          "line": 126
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "trlen(",
          "args": [
            "rep->e_text)"
          ],
          "line": 126
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_Update(",
          "args": [
            "ctx,",
            "ep->certificate->data,",
            "ep->certificate->length)"
          ],
          "line": 124
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_Update(",
          "args": [
            "ctx,",
            "p,",
            ")"
          ],
          "line": 119
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_Update(",
          "args": [
            "ctx,",
            "ersion_2_0,",
            "izeof(version_2_0))"
          ],
          "line": 114
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_set_error_message(",
          "args": [
            "ontext,",
            "NOMEM,",
            "malloc: out of memory\")"
          ],
          "line": 110
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_CTX_cleanup(",
          "args": [
            "ctx)"
          ],
          "line": 109
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_data_alloc(",
          "args": [
            "ep->hash,",
            "MAC_size(&ctx))"
          ],
          "line": 107
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_size(",
          "args": [
            "ctx)"
          ],
          "line": 107
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_Init_ex(",
          "args": [
            "ctx,",
            "ey->keyvalue.data,",
            "ey->keyvalue.length,",
            "VP_sha1(),",
            "ULL)"
          ],
          "line": 105
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VP_sha1(",
          "args": [],
          "line": 106
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_CTX_init(",
          "args": [
            "ctx)"
          ],
          "line": 103
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <rfc2459_asn1.h>\n#\ninclude <hex.h>\n#\ninclude \"kdc_locl.h\"\n#\n\ntatic krb5_error_code\ncalculate_reply_hash(krb5_context context,\n\t\t     krb5_keyblock *key,\n\t\t     Kx509Response *rep)\n{\n    krb5_error_code ret;\n    HMAC_CTX ctx;\n\n    HMAC_CTX_init(&ctx);\n\n    HMAC_Init_ex(&ctx, key->keyvalue.data, key->keyvalue.length,\n\t\t EVP_sha1(), NULL);\n    ret = krb5_data_alloc(rep->hash, HMAC_size(&ctx));\n    if (ret) {\n\tHMAC_CTX_cleanup(&ctx);\n\tkrb5_set_error_message(context, ENOMEM, \"malloc: out of memory\");\n\treturn ENOMEM;\n    }\n\n    HMAC_Update(&ctx, version_2_0, sizeof(version_2_0));\n    if (rep->error_code) {\n\tint32_t t = *rep->error_code;\n\tdo {\n\t    unsigned char p = (t & 0xff);\n\t    HMAC_Update(&ctx, &p, 1);\n\t    t >>= 8;\n\t} while (t);\n    }\n    if (rep->certificate)\n\tHMAC_Update(&ctx, rep->certificate->data, rep->certificate->length);\n    if (rep->e_text)\n\tHMAC_Update(&ctx, (unsigned char *)*rep->e_text, strlen(*rep->e_text));\n\n    HMAC_Final(&ctx, rep->hash->data, 0);\n    HMAC_CTX_cleanup(&ctx);\n\n    return 0;\n}"
  },
  {
    "function_name": "erify_req_hash(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/kx509.c",
    "lines": "61-93",
    "snippet": "tatic krb5_error_code\nverify_req_hash(krb5_context context,\n\t\tconst Kx509Request *req,\n\t\tkrb5_keyblock *key)\n{\n    unsigned char digest[SHA_DIGEST_LENGTH];\n    HMAC_CTX ctx;\n\n    if (req->pk_hash.length != sizeof(digest)) {\n\tkrb5_set_error_message(context, KRB5KDC_ERR_PREAUTH_FAILED,\n\t\t\t       \"pk-hash have wrong length: %lu\",\n\t\t\t       (unsigned long)req->pk_hash.length);\n\treturn KRB5KDC_ERR_PREAUTH_FAILED;\n    }\n\n    HMAC_CTX_init(&ctx);\n    HMAC_Init_ex(&ctx,\n\t\t key->keyvalue.data, key->keyvalue.length,\n\t\t EVP_sha1(), NULL);\n    if (sizeof(digest) != HMAC_size(&ctx))\n\tkrb5_abortx(context, \"runtime error, hmac buffer wrong size in kx509\");\n    HMAC_Update(&ctx, version_2_0, sizeof(version_2_0));\n    HMAC_Update(&ctx, req->pk_key.data, req->pk_key.length);\n    HMAC_Final(&ctx, digest, 0);\n    HMAC_CTX_cleanup(&ctx);\n\n    if (memcmp(req->pk_hash.data, digest, sizeof(digest)) != 0) {\n\tkrb5_set_error_message(context, KRB5KDC_ERR_PREAUTH_FAILED,\n\t\t\t       \"pk-hash is not correct\");\n\treturn KRB5KDC_ERR_PREAUTH_FAILED;\n    }\n    return 0;\n}",
    "includes": [
      "include <hx509.h>",
      "include <rfc2459_asn1.h>\n#",
      "include <hex.h>\n#",
      "include \"kdc_locl.h\"\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "rb5_set_error_message(",
          "args": [
            "ontext,",
            "RB5KDC_ERR_PREAUTH_FAILED,",
            "pk-hash is not correct\")"
          ],
          "line": 88
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "emcmp(",
          "args": [
            "eq->pk_hash.data,",
            "igest,",
            "izeof(digest))"
          ],
          "line": 87
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_CTX_cleanup(",
          "args": [
            "ctx)"
          ],
          "line": 85
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_Final(",
          "args": [
            "ctx,",
            "igest,",
            ")"
          ],
          "line": 84
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_Update(",
          "args": [
            "ctx,",
            "eq->pk_key.data,",
            "eq->pk_key.length)"
          ],
          "line": 83
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_Update(",
          "args": [
            "ctx,",
            "ersion_2_0,",
            "izeof(version_2_0))"
          ],
          "line": 82
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_abortx(",
          "args": [
            "ontext,",
            "runtime error, hmac buffer wrong size in kx509\")"
          ],
          "line": 81
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_size(",
          "args": [
            "ctx)"
          ],
          "line": 80
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_Init_ex(",
          "args": [
            "ctx,",
            "ey->keyvalue.data,",
            "ey->keyvalue.length,",
            "VP_sha1(),",
            "ULL)"
          ],
          "line": 77
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "VP_sha1(",
          "args": [],
          "line": 79
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "MAC_CTX_init(",
          "args": [
            "ctx)"
          ],
          "line": 76
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_set_error_message(",
          "args": [
            "ontext,",
            "RB5KDC_ERR_PREAUTH_FAILED,",
            "pk-hash have wrong length: %lu\",",
            "unsigned long)req->pk_hash.length)"
          ],
          "line": 70
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <rfc2459_asn1.h>\n#\ninclude <hex.h>\n#\ninclude \"kdc_locl.h\"\n#\n\ntatic krb5_error_code\nverify_req_hash(krb5_context context,\n\t\tconst Kx509Request *req,\n\t\tkrb5_keyblock *key)\n{\n    unsigned char digest[SHA_DIGEST_LENGTH];\n    HMAC_CTX ctx;\n\n    if (req->pk_hash.length != sizeof(digest)) {\n\tkrb5_set_error_message(context, KRB5KDC_ERR_PREAUTH_FAILED,\n\t\t\t       \"pk-hash have wrong length: %lu\",\n\t\t\t       (unsigned long)req->pk_hash.length);\n\treturn KRB5KDC_ERR_PREAUTH_FAILED;\n    }\n\n    HMAC_CTX_init(&ctx);\n    HMAC_Init_ex(&ctx,\n\t\t key->keyvalue.data, key->keyvalue.length,\n\t\t EVP_sha1(), NULL);\n    if (sizeof(digest) != HMAC_size(&ctx))\n\tkrb5_abortx(context, \"runtime error, hmac buffer wrong size in kx509\");\n    HMAC_Update(&ctx, version_2_0, sizeof(version_2_0));\n    HMAC_Update(&ctx, req->pk_key.data, req->pk_key.length);\n    HMAC_Final(&ctx, digest, 0);\n    HMAC_CTX_cleanup(&ctx);\n\n    if (memcmp(req->pk_hash.data, digest, sizeof(digest)) != 0) {\n\tkrb5_set_error_message(context, KRB5KDC_ERR_PREAUTH_FAILED,\n\t\t\t       \"pk-hash is not correct\");\n\treturn KRB5KDC_ERR_PREAUTH_FAILED;\n    }\n    return 0;\n}"
  },
  {
    "function_name": "kdc_try_kx509_request(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/kx509.c",
    "lines": "45-53",
    "snippet": "rb5_error_code\n_kdc_try_kx509_request(void *ptr, size_t len, struct Kx509Request *req, size_t *size)\n{\n    if (len < 4)\n\treturn -1;\n    if (memcmp(\"\\x00\\x00\\x02\\x00\", ptr, 4) != 0)\n\treturn -1;\n    return decode_Kx509Request(((unsigned char *)ptr) + 4, len - 4, req, size);\n}",
    "includes": [
      "include <hx509.h>",
      "include <rfc2459_asn1.h>\n#",
      "include <hex.h>\n#",
      "include \"kdc_locl.h\"\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "ecode_Kx509Request(",
          "args": [
            "(unsigned char *)ptr) + 4,",
            "en - 4,",
            "eq,",
            "ize)"
          ],
          "line": 52
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "emcmp(",
          "args": [
            "\\x00\\x00\\x02\\x00\",",
            "tr,",
            ")"
          ],
          "line": 50
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <rfc2459_asn1.h>\n#\ninclude <hex.h>\n#\ninclude \"kdc_locl.h\"\n#\n\nrb5_error_code\n_kdc_try_kx509_request(void *ptr, size_t len, struct Kx509Request *req, size_t *size)\n{\n    if (len < 4)\n\treturn -1;\n    if (memcmp(\"\\x00\\x00\\x02\\x00\", ptr, 4) != 0)\n\treturn -1;\n    return decode_Kx509Request(((unsigned char *)ptr) + 4, len - 4, req, size);\n}"
  }
]