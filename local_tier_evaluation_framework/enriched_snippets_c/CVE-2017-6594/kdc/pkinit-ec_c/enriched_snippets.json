[
  {
    "function_name": "kdc_serialize_ecdh_key(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
    "lines": "305-316",
    "snippet": "rb5_error_code\n_kdc_serialize_ecdh_key(krb5_context context,\n                        void *key,\n                        unsigned char **out,\n                        size_t *out_len)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    return serialize_ecdh_key(context, key, out, out_len);\n#else\n    return ENOTSUP;\n#endif\n}",
    "includes": [
      "include <hx509.h>",
      "include <pkinit_asn1.h>",
      "include <cms_asn1.h>\n#",
      "include <rfc2459_asn1.h>\n#",
      "include <heim_asn1.h>\n#",
      "include <hcrypto/des.h>\n#",
      "include \"kdc_locl.h\"\n#",
      "include <openssl/bn.h>\n#",
      "include <openssl/evp.h>\n#",
      "include <openssl/ecdh.h>\n#",
      "include <openssl/ec.h>\n#",
      "include <roken.h>",
      "include <config.h>\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "erialize_ecdh_key(",
          "args": [
            "ontext,",
            "ey,",
            "ut,",
            "ut_len)"
          ],
          "line": 312
        },
        "resolved": true,
        "details": {
          "function_name": "kdc_serialize_ecdh_key(",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
          "lines": "305-316",
          "snippet": "rb5_error_code\n_kdc_serialize_ecdh_key(krb5_context context,\n                        void *key,\n                        unsigned char **out,\n                        size_t *out_len)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    return serialize_ecdh_key(context, key, out, out_len);\n#else\n    return ENOTSUP;\n#endif\n}",
          "note": "cyclic_reference_detected"
        }
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <pkinit_asn1.h>\ninclude <cms_asn1.h>\n#\ninclude <rfc2459_asn1.h>\n#\ninclude <heim_asn1.h>\n#\ninclude <hcrypto/des.h>\n#\ninclude \"kdc_locl.h\"\n#\ninclude <openssl/bn.h>\n#\ninclude <openssl/evp.h>\n#\ninclude <openssl/ecdh.h>\n#\ninclude <openssl/ec.h>\n#\ninclude <roken.h>\ninclude <config.h>\n#\n\nrb5_error_code\n_kdc_serialize_ecdh_key(krb5_context context,\n                        void *key,\n                        unsigned char **out,\n                        size_t *out_len)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    return serialize_ecdh_key(context, key, out, out_len);\n#else\n    return ENOTSUP;\n#endif\n}"
  },
  {
    "function_name": "erialize_ecdh_key(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
    "lines": "268-302",
    "snippet": "tatic krb5_error_code\nserialize_ecdh_key(krb5_context context,\n                   EC_KEY *key,\n                   unsigned char **out,\n                   size_t *out_len)\n{\n    krb5_error_code ret = 0;\n    unsigned char *p;\n    int len;\n\n    *out = NULL;\n    *out_len = 0;\n\n    len = i2o_ECPublicKey(key, NULL);\n    if (len <= 0)\n        return EOVERFLOW;\n\n    *out = malloc(len);\n    if (*out == NULL)\n        return krb5_enomem(context);\n\n    p = *out;\n    len = i2o_ECPublicKey(key, &p);\n    if (len <= 0) {\n        free(*out);\n        *out = NULL;\n        ret = EINVAL; /* XXX Better error please */\n\tkrb5_set_error_message(context, ret,\n\t\t\t       \"PKINIT failed to encode ECDH key\");\n        return ret;\n    }\n\n    *out_len = len * 8;\n    return ret;\n}",
    "includes": [
      "include <hx509.h>",
      "include <pkinit_asn1.h>",
      "include <cms_asn1.h>\n#",
      "include <rfc2459_asn1.h>\n#",
      "include <heim_asn1.h>\n#",
      "include <hcrypto/des.h>\n#",
      "include \"kdc_locl.h\"\n#",
      "include <openssl/bn.h>\n#",
      "include <openssl/evp.h>\n#",
      "include <openssl/ecdh.h>\n#",
      "include <openssl/ec.h>\n#",
      "include <roken.h>",
      "include <config.h>\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "rb5_set_error_message(",
          "args": [
            "ontext,",
            "et,",
            "PKINIT failed to encode ECDH key\")"
          ],
          "line": 295
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ree(",
          "args": [
            "out)"
          ],
          "line": 292
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "2o_ECPublicKey(",
          "args": [
            "ey,",
            "p)"
          ],
          "line": 290
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_enomem(",
          "args": [
            "ontext)"
          ],
          "line": 287
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "alloc(",
          "args": [
            "en)"
          ],
          "line": 285
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "2o_ECPublicKey(",
          "args": [
            "ey,",
            "ULL)"
          ],
          "line": 281
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <pkinit_asn1.h>\ninclude <cms_asn1.h>\n#\ninclude <rfc2459_asn1.h>\n#\ninclude <heim_asn1.h>\n#\ninclude <hcrypto/des.h>\n#\ninclude \"kdc_locl.h\"\n#\ninclude <openssl/bn.h>\n#\ninclude <openssl/evp.h>\n#\ninclude <openssl/ecdh.h>\n#\ninclude <openssl/ec.h>\n#\ninclude <roken.h>\ninclude <config.h>\n#\n\ntatic krb5_error_code\nserialize_ecdh_key(krb5_context context,\n                   EC_KEY *key,\n                   unsigned char **out,\n                   size_t *out_len)\n{\n    krb5_error_code ret = 0;\n    unsigned char *p;\n    int len;\n\n    *out = NULL;\n    *out_len = 0;\n\n    len = i2o_ECPublicKey(key, NULL);\n    if (len <= 0)\n        return EOVERFLOW;\n\n    *out = malloc(len);\n    if (*out == NULL)\n        return krb5_enomem(context);\n\n    p = *out;\n    len = i2o_ECPublicKey(key, &p);\n    if (len <= 0) {\n        free(*out);\n        *out = NULL;\n        ret = EINVAL; /* XXX Better error please */\n\tkrb5_set_error_message(context, ret,\n\t\t\t       \"PKINIT failed to encode ECDH key\");\n        return ret;\n    }\n\n    *out_len = len * 8;\n    return ret;\n}"
  },
  {
    "function_name": "kdc_get_ecdh_param(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
    "lines": "249-260",
    "snippet": "rb5_error_code\n_kdc_get_ecdh_param(krb5_context context,\n                    krb5_kdc_configuration *config,\n                    SubjectPublicKeyInfo *dh_key_info,\n                    void **out)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    return get_ecdh_param(context, config, dh_key_info, (EC_KEY **)out);\n#else\n    return ENOTSUP;\n#endif /* HAVE_HCRYPTO_W_OPENSSL */\n}",
    "includes": [
      "include <hx509.h>",
      "include <pkinit_asn1.h>",
      "include <cms_asn1.h>\n#",
      "include <rfc2459_asn1.h>\n#",
      "include <heim_asn1.h>\n#",
      "include <hcrypto/des.h>\n#",
      "include \"kdc_locl.h\"\n#",
      "include <openssl/bn.h>\n#",
      "include <openssl/evp.h>\n#",
      "include <openssl/ecdh.h>\n#",
      "include <openssl/ec.h>\n#",
      "include <roken.h>",
      "include <config.h>\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "et_ecdh_param(",
          "args": [
            "ontext,",
            "onfig,",
            "h_key_info,",
            "EC_KEY **)out)"
          ],
          "line": 256
        },
        "resolved": true,
        "details": {
          "function_name": "kdc_get_ecdh_param(",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
          "lines": "249-260",
          "snippet": "rb5_error_code\n_kdc_get_ecdh_param(krb5_context context,\n                    krb5_kdc_configuration *config,\n                    SubjectPublicKeyInfo *dh_key_info,\n                    void **out)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    return get_ecdh_param(context, config, dh_key_info, (EC_KEY **)out);\n#else\n    return ENOTSUP;\n#endif /* HAVE_HCRYPTO_W_OPENSSL */\n}",
          "note": "cyclic_reference_detected"
        }
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <pkinit_asn1.h>\ninclude <cms_asn1.h>\n#\ninclude <rfc2459_asn1.h>\n#\ninclude <heim_asn1.h>\n#\ninclude <hcrypto/des.h>\n#\ninclude \"kdc_locl.h\"\n#\ninclude <openssl/bn.h>\n#\ninclude <openssl/evp.h>\n#\ninclude <openssl/ecdh.h>\n#\ninclude <openssl/ec.h>\n#\ninclude <roken.h>\ninclude <config.h>\n#\n\nrb5_error_code\n_kdc_get_ecdh_param(krb5_context context,\n                    krb5_kdc_configuration *config,\n                    SubjectPublicKeyInfo *dh_key_info,\n                    void **out)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    return get_ecdh_param(context, config, dh_key_info, (EC_KEY **)out);\n#else\n    return ENOTSUP;\n#endif /* HAVE_HCRYPTO_W_OPENSSL */\n}"
  },
  {
    "function_name": "et_ecdh_param(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
    "lines": "187-246",
    "snippet": "tatic krb5_error_code\nget_ecdh_param(krb5_context context,\n               krb5_kdc_configuration *config,\n               SubjectPublicKeyInfo *dh_key_info,\n               EC_KEY **out)\n{\n    ECParameters ecp;\n    EC_KEY *public = NULL;\n    krb5_error_code ret;\n    const unsigned char *p;\n    size_t len;\n    int nid;\n\n    if (dh_key_info->algorithm.parameters == NULL) {\n\tkrb5_set_error_message(context, KRB5_BADMSGTYPE,\n\t\t\t       \"PKINIT missing algorithm parameter \"\n\t\t\t       \"in clientPublicValue\");\n\treturn KRB5_BADMSGTYPE;\n    }\n\n    memset(&ecp, 0, sizeof(ecp));\n\n    ret = decode_ECParameters(dh_key_info->algorithm.parameters->data,\n\t\t\t      dh_key_info->algorithm.parameters->length, &ecp, &len);\n    if (ret)\n\tgoto out;\n\n    if (ecp.element != choice_ECParameters_namedCurve) {\n\tret = KRB5_BADMSGTYPE;\n\tgoto out;\n    }\n\n    if (der_heim_oid_cmp(&ecp.u.namedCurve, &asn1_oid_id_ec_group_secp256r1) == 0)\n\tnid = NID_X9_62_prime256v1;\n    else {\n\tret = KRB5_BADMSGTYPE;\n\tgoto out;\n    }\n\n    /* XXX verify group is ok */\n\n    public = EC_KEY_new_by_curve_name(nid);\n\n    p = dh_key_info->subjectPublicKey.data;\n    len = dh_key_info->subjectPublicKey.length / 8;\n    if (o2i_ECPublicKey(&public, &p, len) == NULL) {\n\tret = KRB5_BADMSGTYPE;\n\tkrb5_set_error_message(context, ret,\n\t\t\t       \"PKINIT failed to decode ECDH key\");\n\tgoto out;\n    }\n    *out = public;\n    public = NULL;\n\n out:\n    if (public)\n\tEC_KEY_free(public);\n    free_ECParameters(&ecp);\n    return ret;\n}",
    "includes": [
      "include <hx509.h>",
      "include <pkinit_asn1.h>",
      "include <cms_asn1.h>\n#",
      "include <rfc2459_asn1.h>\n#",
      "include <heim_asn1.h>\n#",
      "include <hcrypto/des.h>\n#",
      "include \"kdc_locl.h\"\n#",
      "include <openssl/bn.h>\n#",
      "include <openssl/evp.h>\n#",
      "include <openssl/ecdh.h>\n#",
      "include <openssl/ec.h>\n#",
      "include <roken.h>",
      "include <config.h>\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "ree_ECParameters(",
          "args": [
            "ecp)"
          ],
          "line": 244
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_free(",
          "args": [
            "ublic)"
          ],
          "line": 243
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_set_error_message(",
          "args": [
            "ontext,",
            "et,",
            "PKINIT failed to decode ECDH key\")"
          ],
          "line": 234
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "2i_ECPublicKey(",
          "args": [
            "public,",
            "p,",
            "en)"
          ],
          "line": 232
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_new_by_curve_name(",
          "args": [
            "id)"
          ],
          "line": 228
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "er_heim_oid_cmp(",
          "args": [
            "ecp.u.namedCurve,",
            "asn1_oid_id_ec_group_secp256r1)"
          ],
          "line": 219
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ecode_ECParameters(",
          "args": [
            "h_key_info->algorithm.parameters->data,",
            "h_key_info->algorithm.parameters->length,",
            "ecp,",
            "len)"
          ],
          "line": 209
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "emset(",
          "args": [
            "ecp,",
            ",",
            "izeof(ecp))"
          ],
          "line": 207
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_set_error_message(",
          "args": [
            "ontext,",
            "RB5_BADMSGTYPE,",
            "PKINIT missing algorithm parameter \"\n\t\t\t       \"in clientPublicValue\")"
          ],
          "line": 201
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <pkinit_asn1.h>\ninclude <cms_asn1.h>\n#\ninclude <rfc2459_asn1.h>\n#\ninclude <heim_asn1.h>\n#\ninclude <hcrypto/des.h>\n#\ninclude \"kdc_locl.h\"\n#\ninclude <openssl/bn.h>\n#\ninclude <openssl/evp.h>\n#\ninclude <openssl/ecdh.h>\n#\ninclude <openssl/ec.h>\n#\ninclude <roken.h>\ninclude <config.h>\n#\n\ntatic krb5_error_code\nget_ecdh_param(krb5_context context,\n               krb5_kdc_configuration *config,\n               SubjectPublicKeyInfo *dh_key_info,\n               EC_KEY **out)\n{\n    ECParameters ecp;\n    EC_KEY *public = NULL;\n    krb5_error_code ret;\n    const unsigned char *p;\n    size_t len;\n    int nid;\n\n    if (dh_key_info->algorithm.parameters == NULL) {\n\tkrb5_set_error_message(context, KRB5_BADMSGTYPE,\n\t\t\t       \"PKINIT missing algorithm parameter \"\n\t\t\t       \"in clientPublicValue\");\n\treturn KRB5_BADMSGTYPE;\n    }\n\n    memset(&ecp, 0, sizeof(ecp));\n\n    ret = decode_ECParameters(dh_key_info->algorithm.parameters->data,\n\t\t\t      dh_key_info->algorithm.parameters->length, &ecp, &len);\n    if (ret)\n\tgoto out;\n\n    if (ecp.element != choice_ECParameters_namedCurve) {\n\tret = KRB5_BADMSGTYPE;\n\tgoto out;\n    }\n\n    if (der_heim_oid_cmp(&ecp.u.namedCurve, &asn1_oid_id_ec_group_secp256r1) == 0)\n\tnid = NID_X9_62_prime256v1;\n    else {\n\tret = KRB5_BADMSGTYPE;\n\tgoto out;\n    }\n\n    /* XXX verify group is ok */\n\n    public = EC_KEY_new_by_curve_name(nid);\n\n    p = dh_key_info->subjectPublicKey.data;\n    len = dh_key_info->subjectPublicKey.length / 8;\n    if (o2i_ECPublicKey(&public, &p, len) == NULL) {\n\tret = KRB5_BADMSGTYPE;\n\tkrb5_set_error_message(context, ret,\n\t\t\t       \"PKINIT failed to decode ECDH key\");\n\tgoto out;\n    }\n    *out = public;\n    public = NULL;\n\n out:\n    if (public)\n\tEC_KEY_free(public);\n    free_ECParameters(&ecp);\n    return ret;\n}"
  },
  {
    "function_name": "kdc_generate_ecdh_keyblock(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
    "lines": "170-184",
    "snippet": "rb5_error_code\n_kdc_generate_ecdh_keyblock(krb5_context context,\n                            void *ec_key_pk,    /* the client's public key */\n                            void **ec_key_key,  /* the KDC's ephemeral private */\n                            unsigned char **dh_gen_key, /* shared secret */\n                            size_t *dh_gen_keylen)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    return generate_ecdh_keyblock(context, ec_key_pk,\n                                  (EC_KEY **)ec_key_key,\n                                  dh_gen_key, dh_gen_keylen);\n#else\n    return ENOTSUP;\n#endif /* HAVE_HCRYPTO_W_OPENSSL */\n}",
    "includes": [
      "include <hx509.h>",
      "include <pkinit_asn1.h>",
      "include <cms_asn1.h>\n#",
      "include <rfc2459_asn1.h>\n#",
      "include <heim_asn1.h>\n#",
      "include <hcrypto/des.h>\n#",
      "include \"kdc_locl.h\"\n#",
      "include <openssl/bn.h>\n#",
      "include <openssl/evp.h>\n#",
      "include <openssl/ecdh.h>\n#",
      "include <openssl/ec.h>\n#",
      "include <roken.h>",
      "include <config.h>\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "enerate_ecdh_keyblock(",
          "args": [
            "ontext,",
            "c_key_pk,",
            "EC_KEY **)ec_key_key,",
            "h_gen_key,",
            "h_gen_keylen)"
          ],
          "line": 178
        },
        "resolved": true,
        "details": {
          "function_name": "kdc_generate_ecdh_keyblock(",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
          "lines": "170-184",
          "snippet": "rb5_error_code\n_kdc_generate_ecdh_keyblock(krb5_context context,\n                            void *ec_key_pk,    /* the client's public key */\n                            void **ec_key_key,  /* the KDC's ephemeral private */\n                            unsigned char **dh_gen_key, /* shared secret */\n                            size_t *dh_gen_keylen)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    return generate_ecdh_keyblock(context, ec_key_pk,\n                                  (EC_KEY **)ec_key_key,\n                                  dh_gen_key, dh_gen_keylen);\n#else\n    return ENOTSUP;\n#endif /* HAVE_HCRYPTO_W_OPENSSL */\n}",
          "note": "cyclic_reference_detected"
        }
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <pkinit_asn1.h>\ninclude <cms_asn1.h>\n#\ninclude <rfc2459_asn1.h>\n#\ninclude <heim_asn1.h>\n#\ninclude <hcrypto/des.h>\n#\ninclude \"kdc_locl.h\"\n#\ninclude <openssl/bn.h>\n#\ninclude <openssl/evp.h>\n#\ninclude <openssl/ecdh.h>\n#\ninclude <openssl/ec.h>\n#\ninclude <roken.h>\ninclude <config.h>\n#\n\nrb5_error_code\n_kdc_generate_ecdh_keyblock(krb5_context context,\n                            void *ec_key_pk,    /* the client's public key */\n                            void **ec_key_key,  /* the KDC's ephemeral private */\n                            unsigned char **dh_gen_key, /* shared secret */\n                            size_t *dh_gen_keylen)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    return generate_ecdh_keyblock(context, ec_key_pk,\n                                  (EC_KEY **)ec_key_key,\n                                  dh_gen_key, dh_gen_keylen);\n#else\n    return ENOTSUP;\n#endif /* HAVE_HCRYPTO_W_OPENSSL */\n}"
  },
  {
    "function_name": "enerate_ecdh_keyblock(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
    "lines": "97-167",
    "snippet": "tatic krb5_error_code\ngenerate_ecdh_keyblock(krb5_context context,\n                       EC_KEY *ec_key_pk,    /* the client's public key */\n                       EC_KEY **ec_key_key,  /* the KDC's ephemeral private */\n                       unsigned char **dh_gen_key, /* shared secret */\n                       size_t *dh_gen_keylen)\n{\n    const EC_GROUP *group;\n    EC_KEY *ephemeral;\n    krb5_keyblock key;\n    krb5_error_code ret;\n    unsigned char *p;\n    size_t size;\n    int len;\n\n    *dh_gen_key = NULL;\n    *dh_gen_keylen = 0;\n    *ec_key_key = NULL;\n\n    memset(&key, 0, sizeof(key));\n\n    if (ec_key_pk == NULL) {\n        ret = KRB5KRB_ERR_GENERIC;\n        krb5_set_error_message(context, ret, \"public_key\");\n        return ret;\n    }\n\n    group = EC_KEY_get0_group(ec_key_pk);\n    if (group == NULL) {\n        ret = KRB5KRB_ERR_GENERIC;\n        krb5_set_error_message(context, ret, \"failed to get the group of \"\n                               \"the client's public key\");\n        return ret;\n    }\n\n    ephemeral = EC_KEY_new();\n    if (ephemeral == NULL)\n        return krb5_enomem(context);\n\n    EC_KEY_set_group(ephemeral, group);\n\n    if (EC_KEY_generate_key(ephemeral) != 1) {\n\tEC_KEY_free(ephemeral);\n        return krb5_enomem(context);\n    }\n\n    size = (EC_GROUP_get_degree(group) + 7) / 8;\n    p = malloc(size);\n    if (p == NULL) {\n        EC_KEY_free(ephemeral);\n        return krb5_enomem(context);\n    }\n\n    len = ECDH_compute_key(p, size,\n                           EC_KEY_get0_public_key(ec_key_pk),\n                           ephemeral, NULL);\n    if (len <= 0) {\n        free(p);\n        EC_KEY_free(ephemeral);\n        ret = KRB5KRB_ERR_GENERIC;\n        krb5_set_error_message(context, ret, \"Failed to compute ECDH \"\n                               \"public shared secret\");\n        return ret;\n    }\n\n    *ec_key_key = ephemeral;\n    *dh_gen_key = p;\n    *dh_gen_keylen = len;\n\n    return 0;\n}",
    "includes": [
      "include <hx509.h>",
      "include <pkinit_asn1.h>",
      "include <cms_asn1.h>\n#",
      "include <rfc2459_asn1.h>\n#",
      "include <heim_asn1.h>\n#",
      "include <hcrypto/des.h>\n#",
      "include \"kdc_locl.h\"\n#",
      "include <openssl/bn.h>\n#",
      "include <openssl/evp.h>\n#",
      "include <openssl/ecdh.h>\n#",
      "include <openssl/ec.h>\n#",
      "include <roken.h>",
      "include <config.h>\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "rb5_set_error_message(",
          "args": [
            "ontext,",
            "et,",
            "Failed to compute ECDH \"\n                               \"public shared secret\")"
          ],
          "line": 157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_free(",
          "args": [
            "phemeral)"
          ],
          "line": 155
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ree(",
          "args": [
            ")"
          ],
          "line": 154
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "CDH_compute_key(",
          "args": [
            ",",
            "ize,",
            "C_KEY_get0_public_key(ec_key_pk),",
            "phemeral,",
            "ULL)"
          ],
          "line": 150
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_get0_public_key(",
          "args": [
            "c_key_pk)"
          ],
          "line": 151
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_enomem(",
          "args": [
            "ontext)"
          ],
          "line": 147
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_free(",
          "args": [
            "phemeral)"
          ],
          "line": 146
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "alloc(",
          "args": [
            "ize)"
          ],
          "line": 144
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_GROUP_get_degree(",
          "args": [
            "roup)"
          ],
          "line": 143
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_enomem(",
          "args": [
            "ontext)"
          ],
          "line": 140
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_free(",
          "args": [
            "phemeral)"
          ],
          "line": 139
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_generate_key(",
          "args": [
            "phemeral)"
          ],
          "line": 138
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_set_group(",
          "args": [
            "phemeral,",
            "roup)"
          ],
          "line": 136
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_enomem(",
          "args": [
            "ontext)"
          ],
          "line": 134
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_new(",
          "args": [],
          "line": 132
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_set_error_message(",
          "args": [
            "ontext,",
            "et,",
            "failed to get the group of \"\n                               \"the client's public key\")"
          ],
          "line": 127
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_get0_group(",
          "args": [
            "c_key_pk)"
          ],
          "line": 124
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_set_error_message(",
          "args": [
            "ontext,",
            "et,",
            "public_key\")"
          ],
          "line": 120
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "emset(",
          "args": [
            "key,",
            ",",
            "izeof(key))"
          ],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <pkinit_asn1.h>\ninclude <cms_asn1.h>\n#\ninclude <rfc2459_asn1.h>\n#\ninclude <heim_asn1.h>\n#\ninclude <hcrypto/des.h>\n#\ninclude \"kdc_locl.h\"\n#\ninclude <openssl/bn.h>\n#\ninclude <openssl/evp.h>\n#\ninclude <openssl/ecdh.h>\n#\ninclude <openssl/ec.h>\n#\ninclude <roken.h>\ninclude <config.h>\n#\n\ntatic krb5_error_code\ngenerate_ecdh_keyblock(krb5_context context,\n                       EC_KEY *ec_key_pk,    /* the client's public key */\n                       EC_KEY **ec_key_key,  /* the KDC's ephemeral private */\n                       unsigned char **dh_gen_key, /* shared secret */\n                       size_t *dh_gen_keylen)\n{\n    const EC_GROUP *group;\n    EC_KEY *ephemeral;\n    krb5_keyblock key;\n    krb5_error_code ret;\n    unsigned char *p;\n    size_t size;\n    int len;\n\n    *dh_gen_key = NULL;\n    *dh_gen_keylen = 0;\n    *ec_key_key = NULL;\n\n    memset(&key, 0, sizeof(key));\n\n    if (ec_key_pk == NULL) {\n        ret = KRB5KRB_ERR_GENERIC;\n        krb5_set_error_message(context, ret, \"public_key\");\n        return ret;\n    }\n\n    group = EC_KEY_get0_group(ec_key_pk);\n    if (group == NULL) {\n        ret = KRB5KRB_ERR_GENERIC;\n        krb5_set_error_message(context, ret, \"failed to get the group of \"\n                               \"the client's public key\");\n        return ret;\n    }\n\n    ephemeral = EC_KEY_new();\n    if (ephemeral == NULL)\n        return krb5_enomem(context);\n\n    EC_KEY_set_group(ephemeral, group);\n\n    if (EC_KEY_generate_key(ephemeral) != 1) {\n\tEC_KEY_free(ephemeral);\n        return krb5_enomem(context);\n    }\n\n    size = (EC_GROUP_get_degree(group) + 7) / 8;\n    p = malloc(size);\n    if (p == NULL) {\n        EC_KEY_free(ephemeral);\n        return krb5_enomem(context);\n    }\n\n    len = ECDH_compute_key(p, size,\n                           EC_KEY_get0_public_key(ec_key_pk),\n                           ephemeral, NULL);\n    if (len <= 0) {\n        free(p);\n        EC_KEY_free(ephemeral);\n        ret = KRB5KRB_ERR_GENERIC;\n        krb5_set_error_message(context, ret, \"Failed to compute ECDH \"\n                               \"public shared secret\");\n        return ret;\n    }\n\n    *ec_key_key = ephemeral;\n    *dh_gen_key = p;\n    *dh_gen_keylen = len;\n\n    return 0;\n}"
  },
  {
    "function_name": "kdc_pk_free_client_ec_param(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
    "lines": "86-94",
    "snippet": "oid\n_kdc_pk_free_client_ec_param(krb5_context context,\n                             void *ec_key_pk,\n                             void *ec_key_key)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    free_client_ec_param(context, ec_key_pk, ec_key_key);\n#endif\n}",
    "includes": [
      "include <hx509.h>",
      "include <pkinit_asn1.h>",
      "include <cms_asn1.h>\n#",
      "include <rfc2459_asn1.h>\n#",
      "include <heim_asn1.h>\n#",
      "include <hcrypto/des.h>\n#",
      "include \"kdc_locl.h\"\n#",
      "include <openssl/bn.h>\n#",
      "include <openssl/evp.h>\n#",
      "include <openssl/ecdh.h>\n#",
      "include <openssl/ec.h>\n#",
      "include <roken.h>",
      "include <config.h>\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "ree_client_ec_param(",
          "args": [
            "ontext,",
            "c_key_pk,",
            "c_key_key)"
          ],
          "line": 92
        },
        "resolved": true,
        "details": {
          "function_name": "kdc_pk_free_client_ec_param(",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
          "lines": "86-94",
          "snippet": "oid\n_kdc_pk_free_client_ec_param(krb5_context context,\n                             void *ec_key_pk,\n                             void *ec_key_key)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    free_client_ec_param(context, ec_key_pk, ec_key_key);\n#endif\n}",
          "note": "cyclic_reference_detected"
        }
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <pkinit_asn1.h>\ninclude <cms_asn1.h>\n#\ninclude <rfc2459_asn1.h>\n#\ninclude <heim_asn1.h>\n#\ninclude <hcrypto/des.h>\n#\ninclude \"kdc_locl.h\"\n#\ninclude <openssl/bn.h>\n#\ninclude <openssl/evp.h>\n#\ninclude <openssl/ecdh.h>\n#\ninclude <openssl/ec.h>\n#\ninclude <roken.h>\ninclude <config.h>\n#\n\noid\n_kdc_pk_free_client_ec_param(krb5_context context,\n                             void *ec_key_pk,\n                             void *ec_key_key)\n{\n#ifdef HAVE_HCRYPTO_W_OPENSSL\n    free_client_ec_param(context, ec_key_pk, ec_key_key);\n#endif\n}"
  },
  {
    "function_name": "ree_client_ec_param(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/pkinit-ec.c",
    "lines": "74-83",
    "snippet": "tatic void\nfree_client_ec_param(krb5_context context,\n                     EC_KEY *ec_key_pk,\n                     EC_KEY *ec_key_key)\n{\n    if (ec_key_pk != NULL)\n        EC_KEY_free(ec_key_pk);\n    if (ec_key_key != NULL)\n        EC_KEY_free(ec_key_key);\n}",
    "includes": [
      "include <hx509.h>",
      "include <pkinit_asn1.h>",
      "include <cms_asn1.h>\n#",
      "include <rfc2459_asn1.h>\n#",
      "include <heim_asn1.h>\n#",
      "include <hcrypto/des.h>\n#",
      "include \"kdc_locl.h\"\n#",
      "include <openssl/bn.h>\n#",
      "include <openssl/evp.h>\n#",
      "include <openssl/ecdh.h>\n#",
      "include <openssl/ec.h>\n#",
      "include <roken.h>",
      "include <config.h>\n#"
    ],
    "macros_used": [],
    "globals_used": [],
    "called_functions": [
      {
        "call_info": {
          "callee": "C_KEY_free(",
          "args": [
            "c_key_key)"
          ],
          "line": 82
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "C_KEY_free(",
          "args": [
            "c_key_pk)"
          ],
          "line": 80
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include <hx509.h>\ninclude <pkinit_asn1.h>\ninclude <cms_asn1.h>\n#\ninclude <rfc2459_asn1.h>\n#\ninclude <heim_asn1.h>\n#\ninclude <hcrypto/des.h>\n#\ninclude \"kdc_locl.h\"\n#\ninclude <openssl/bn.h>\n#\ninclude <openssl/evp.h>\n#\ninclude <openssl/ecdh.h>\n#\ninclude <openssl/ec.h>\n#\ninclude <roken.h>\ninclude <config.h>\n#\n\ntatic void\nfree_client_ec_param(krb5_context context,\n                     EC_KEY *ec_key_pk,\n                     EC_KEY *ec_key_key)\n{\n    if (ec_key_pk != NULL)\n        EC_KEY_free(ec_key_pk);\n    if (ec_key_key != NULL)\n        EC_KEY_free(ec_key_key);\n}"
  }
]