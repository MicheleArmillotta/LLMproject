[
  {
    "function_name": "ain(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/kstash.c",
    "lines": "64-186",
    "snippet": "nt\nmain(int argc, char **argv)\n{\n    char buf[1024+1];\n    krb5_error_code ret;\n    int aret;\n\n    krb5_enctype enctype;\n\n    hdb_master_key mkey;\n\n    krb5_program_setup(&context, argc, argv, args, num_args, NULL);\n\n    if(help_flag)\n\tkrb5_std_usage(0, args, num_args);\n    if(version_flag){\n\tprint_version(NULL);\n\texit(0);\n    }\n\n    if (master_key_fd != -1 && random_key_flag)\n\tkrb5_errx(context, 1, \"random-key and master-key-fd \"\n\t\t  \"is mutual exclusive\");\n\n    if (keyfile == NULL) {\n\taret = asprintf(&keyfile, \"%s/m-key\", hdb_db_dir(context));\n\tif (aret == -1)\n\t    krb5_errx(context, 1, \"out of memory\");\n    }\n\n    ret = krb5_string_to_enctype(context, enctype_str, &enctype);\n    if(ret)\n\tkrb5_err(context, 1, ret, \"krb5_string_to_enctype\");\n\n    ret = hdb_read_master_key(context, keyfile, &mkey);\n    if(ret && ret != ENOENT)\n\tkrb5_err(context, 1, ret, \"reading master key from %s\", keyfile);\n\n    if (convert_flag) {\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"reading master key from %s\", keyfile);\n    } else {\n\tkrb5_keyblock key;\n\tkrb5_salt salt;\n\tsalt.salttype = KRB5_PW_SALT;\n\t/* XXX better value? */\n\tsalt.saltvalue.data = NULL;\n\tsalt.saltvalue.length = 0;\n\tif (random_key_flag) {\n\t    ret = krb5_generate_random_keyblock(context, enctype, &key);\n\t    if (ret)\n\t\tkrb5_err(context, 1, ret, \"krb5_generate_random_keyblock\");\n\n\t} else {\n\t    if(master_key_fd != -1) {\n\t\tssize_t n;\n\t\tn = read(master_key_fd, buf, sizeof(buf)-1);\n\t\tif(n <= 0)\n\t\t    krb5_err(context, 1, errno, \"failed to read passphrase\");\n\t\tbuf[n] = '\\0';\n\t\tbuf[strcspn(buf, \"\\r\\n\")] = '\\0';\n\n\t    } else {\n\t\tif(UI_UTIL_read_pw_string(buf, sizeof(buf), \"Master key: \", 1))\n\t\t    exit(1);\n\t    }\n\t    krb5_string_to_key_salt(context, enctype, buf, salt, &key);\n\t}\n\tret = hdb_add_master_key(context, &key, &mkey);\n\n\tkrb5_free_keyblock_contents(context, &key);\n\n    }\n\n    {\n\tchar *new = NULL, *old = NULL;\n\n\taret = asprintf(&old, \"%s.old\", keyfile);\n\tif (aret == -1) {\n\t    old = NULL;\n\t    ret = ENOMEM;\n\t    goto out;\n\t}\n\taret = asprintf(&new, \"%s.new\", keyfile);\n\tif (aret == -1) {\n\t    new = NULL;\n\t    ret = ENOMEM;\n\t    goto out;\n\t}\n\tif(unlink(new) < 0 && errno != ENOENT) {\n\t    ret = errno;\n\t    goto out;\n\t}\n\tkrb5_warnx(context, \"writing key to `%s'\", keyfile);\n\tret = hdb_write_master_key(context, new, mkey);\n\tif(ret)\n\t    unlink(new);\n\telse {\n#ifndef NO_POSIX_LINKS\n\t    unlink(old);\n\t    if(link(keyfile, old) < 0 && errno != ENOENT) {\n\t\tret = errno;\n\t\tunlink(new);\n\t    } else {\n#endif\n\t\tif(rename(new, keyfile) < 0) {\n\t\t    ret = errno;\n\t\t}\n#ifndef NO_POSIX_LINKS\n\t    }\n#endif\n\t}\n    out:\n\tfree(old);\n\tfree(new);\n\tif(ret)\n\t    krb5_warn(context, errno, \"writing master key file\");\n    }\n\n    hdb_free_master_key(context, mkey);\n\n    exit(ret != 0);\n}",
    "includes": [
      "include \"headers.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "rb5_context context;",
      "tatic char *keyfile;",
      "tatic int convert_flag;",
      "tatic int help_flag;",
      "tatic int version_flag;",
      "tatic int master_key_fd = -1;",
      "tatic int random_key_flag;",
      "tatic const char *enctype_str = \"des3-cbc-sha1\";",
      "tatic struct getargs args[] = {\n    { \"enctype\", 'e', arg_string, rk_UNCONST(&enctype_str), \"encryption type\",\n\tNULL },\n    { \"key-file\", 'k', arg_string, &keyfile, \"master key file\", \"file\" },\n    { \"convert-file\", 0, arg_flag, &convert_flag,\n      \"just convert keyfile to new format\", NULL },\n    { \"master-key-fd\", 0, arg_integer, &master_key_fd,\n      \"filedescriptor to read passphrase from\", \"fd\" },\n    { \"random-key\", 0, arg_flag, &random_key_flag,\n\t\"generate a random master key\", NULL },\n    { \"help\", 'h', arg_flag, &help_flag, NULL, NULL },\n    { \"version\", 0, arg_flag, &version_flag, NULL, NULL }\n};",
      "nt num_args = sizeof(args) / sizeof(args[0]);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "xit(",
          "args": [
            "et != 0)"
          ],
          "line": 185
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db_free_master_key(",
          "args": [
            "ontext,",
            "key)"
          ],
          "line": 183
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_warn(",
          "args": [
            "ontext,",
            "rrno,",
            "writing master key file\")"
          ],
          "line": 180
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ree(",
          "args": [
            "ew)"
          ],
          "line": 178
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ree(",
          "args": [
            "ld)"
          ],
          "line": 177
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ename(",
          "args": [
            "ew,",
            "eyfile)"
          ],
          "line": 169
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "nlink(",
          "args": [
            "ew)"
          ],
          "line": 166
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ink(",
          "args": [
            "eyfile,",
            "ld)"
          ],
          "line": 164
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "nlink(",
          "args": [
            "ld)"
          ],
          "line": 163
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "nlink(",
          "args": [
            "ew)"
          ],
          "line": 160
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db_write_master_key(",
          "args": [
            "ontext,",
            "ew,",
            "key)"
          ],
          "line": 158
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_warnx(",
          "args": [
            "ontext,",
            "writing key to `%s'\",",
            "eyfile)"
          ],
          "line": 157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "nlink(",
          "args": [
            "ew)"
          ],
          "line": 153
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sprintf(",
          "args": [
            "new,",
            "%s.new\",",
            "eyfile)"
          ],
          "line": 147
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sprintf(",
          "args": [
            "old,",
            "%s.old\",",
            "eyfile)"
          ],
          "line": 141
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_free_keyblock_contents(",
          "args": [
            "ontext,",
            "key)"
          ],
          "line": 134
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db_add_master_key(",
          "args": [
            "ontext,",
            "key,",
            "mkey)"
          ],
          "line": 132
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_string_to_key_salt(",
          "args": [
            "ontext,",
            "nctype,",
            "uf,",
            "alt,",
            "key)"
          ],
          "line": 130
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "xit(",
          "args": [
            ")"
          ],
          "line": 128
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "I_UTIL_read_pw_string(",
          "args": [
            "uf,",
            "izeof(buf),",
            "Master key: \",",
            ")"
          ],
          "line": 127
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "trcspn(",
          "args": [
            "uf,",
            "\\r\\n\")"
          ],
          "line": 124
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "rrno,",
            "failed to read passphrase\")"
          ],
          "line": 122
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ead(",
          "args": [
            "aster_key_fd,",
            "uf,",
            "izeof(buf)-1)"
          ],
          "line": 120
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_generate_random_keyblock\")"
          ],
          "line": 115
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_generate_random_keyblock(",
          "args": [
            "ontext,",
            "nctype,",
            "key)"
          ],
          "line": 113
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "reading master key from %s\",",
            "eyfile)"
          ],
          "line": 104
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "reading master key from %s\",",
            "eyfile)"
          ],
          "line": 100
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db_read_master_key(",
          "args": [
            "ontext,",
            "eyfile,",
            "mkey)"
          ],
          "line": 98
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_string_to_enctype\")"
          ],
          "line": 96
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_string_to_enctype(",
          "args": [
            "ontext,",
            "nctype_str,",
            "enctype)"
          ],
          "line": 94
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_errx(",
          "args": [
            "ontext,",
            ",",
            "out of memory\")"
          ],
          "line": 91
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sprintf(",
          "args": [
            "keyfile,",
            "%s/m-key\",",
            "db_db_dir(context))"
          ],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db_db_dir(",
          "args": [
            "ontext)"
          ],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_errx(",
          "args": [
            "ontext,",
            ",",
            "random-key and master-key-fd \"\n\t\t  \"is mutual exclusive\")"
          ],
          "line": 85
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "xit(",
          "args": [
            ")"
          ],
          "line": 81
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rint_version(",
          "args": [
            "ULL)"
          ],
          "line": 80
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_std_usage(",
          "args": [
            ",",
            "rgs,",
            "um_args)"
          ],
          "line": 78
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_program_setup(",
          "args": [
            "context,",
            "rgc,",
            "rgv,",
            "rgs,",
            "um_args,",
            "ULL)"
          ],
          "line": 75
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include \"headers.h\"\n\nrb5_context context;\ntatic char *keyfile;\ntatic int convert_flag;\ntatic int help_flag;\ntatic int version_flag;\ntatic int master_key_fd = -1;\ntatic int random_key_flag;\ntatic const char *enctype_str = \"des3-cbc-sha1\";\ntatic struct getargs args[] = {\n    { \"enctype\", 'e', arg_string, rk_UNCONST(&enctype_str), \"encryption type\",\n\tNULL },\n    { \"key-file\", 'k', arg_string, &keyfile, \"master key file\", \"file\" },\n    { \"convert-file\", 0, arg_flag, &convert_flag,\n      \"just convert keyfile to new format\", NULL },\n    { \"master-key-fd\", 0, arg_integer, &master_key_fd,\n      \"filedescriptor to read passphrase from\", \"fd\" },\n    { \"random-key\", 0, arg_flag, &random_key_flag,\n\t\"generate a random master key\", NULL },\n    { \"help\", 'h', arg_flag, &help_flag, NULL, NULL },\n    { \"version\", 0, arg_flag, &version_flag, NULL, NULL }\n};\nnt num_args = sizeof(args) / sizeof(args[0]);\n\nnt\nmain(int argc, char **argv)\n{\n    char buf[1024+1];\n    krb5_error_code ret;\n    int aret;\n\n    krb5_enctype enctype;\n\n    hdb_master_key mkey;\n\n    krb5_program_setup(&context, argc, argv, args, num_args, NULL);\n\n    if(help_flag)\n\tkrb5_std_usage(0, args, num_args);\n    if(version_flag){\n\tprint_version(NULL);\n\texit(0);\n    }\n\n    if (master_key_fd != -1 && random_key_flag)\n\tkrb5_errx(context, 1, \"random-key and master-key-fd \"\n\t\t  \"is mutual exclusive\");\n\n    if (keyfile == NULL) {\n\taret = asprintf(&keyfile, \"%s/m-key\", hdb_db_dir(context));\n\tif (aret == -1)\n\t    krb5_errx(context, 1, \"out of memory\");\n    }\n\n    ret = krb5_string_to_enctype(context, enctype_str, &enctype);\n    if(ret)\n\tkrb5_err(context, 1, ret, \"krb5_string_to_enctype\");\n\n    ret = hdb_read_master_key(context, keyfile, &mkey);\n    if(ret && ret != ENOENT)\n\tkrb5_err(context, 1, ret, \"reading master key from %s\", keyfile);\n\n    if (convert_flag) {\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"reading master key from %s\", keyfile);\n    } else {\n\tkrb5_keyblock key;\n\tkrb5_salt salt;\n\tsalt.salttype = KRB5_PW_SALT;\n\t/* XXX better value? */\n\tsalt.saltvalue.data = NULL;\n\tsalt.saltvalue.length = 0;\n\tif (random_key_flag) {\n\t    ret = krb5_generate_random_keyblock(context, enctype, &key);\n\t    if (ret)\n\t\tkrb5_err(context, 1, ret, \"krb5_generate_random_keyblock\");\n\n\t} else {\n\t    if(master_key_fd != -1) {\n\t\tssize_t n;\n\t\tn = read(master_key_fd, buf, sizeof(buf)-1);\n\t\tif(n <= 0)\n\t\t    krb5_err(context, 1, errno, \"failed to read passphrase\");\n\t\tbuf[n] = '\\0';\n\t\tbuf[strcspn(buf, \"\\r\\n\")] = '\\0';\n\n\t    } else {\n\t\tif(UI_UTIL_read_pw_string(buf, sizeof(buf), \"Master key: \", 1))\n\t\t    exit(1);\n\t    }\n\t    krb5_string_to_key_salt(context, enctype, buf, salt, &key);\n\t}\n\tret = hdb_add_master_key(context, &key, &mkey);\n\n\tkrb5_free_keyblock_contents(context, &key);\n\n    }\n\n    {\n\tchar *new = NULL, *old = NULL;\n\n\taret = asprintf(&old, \"%s.old\", keyfile);\n\tif (aret == -1) {\n\t    old = NULL;\n\t    ret = ENOMEM;\n\t    goto out;\n\t}\n\taret = asprintf(&new, \"%s.new\", keyfile);\n\tif (aret == -1) {\n\t    new = NULL;\n\t    ret = ENOMEM;\n\t    goto out;\n\t}\n\tif(unlink(new) < 0 && errno != ENOENT) {\n\t    ret = errno;\n\t    goto out;\n\t}\n\tkrb5_warnx(context, \"writing key to `%s'\", keyfile);\n\tret = hdb_write_master_key(context, new, mkey);\n\tif(ret)\n\t    unlink(new);\n\telse {\n#ifndef NO_POSIX_LINKS\n\t    unlink(old);\n\t    if(link(keyfile, old) < 0 && errno != ENOENT) {\n\t\tret = errno;\n\t\tunlink(new);\n\t    } else {\n#endif\n\t\tif(rename(new, keyfile) < 0) {\n\t\t    ret = errno;\n\t\t}\n#ifndef NO_POSIX_LINKS\n\t    }\n#endif\n\t}\n    out:\n\tfree(old);\n\tfree(new);\n\tif(ret)\n\t    krb5_warn(context, errno, \"writing master key file\");\n    }\n\n    hdb_free_master_key(context, mkey);\n\n    exit(ret != 0);\n}"
  }
]