[
  {
    "function_name": "ain(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/hpropd.c",
    "lines": "69-289",
    "snippet": "nt\nmain(int argc, char **argv)\n{\n    krb5_error_code ret;\n    krb5_context context;\n    krb5_auth_context ac = NULL;\n    krb5_principal c1, c2;\n    krb5_authenticator authent;\n    krb5_keytab keytab;\n    krb5_socket_t sock = rk_INVALID_SOCKET;\n    HDB *db = NULL;\n    int optidx = 0;\n    char *tmp_db;\n    krb5_log_facility *fac;\n    int nprincs;\n\n    setprogname(argv[0]);\n\n    ret = krb5_init_context(&context);\n    if (ret)\n\texit(1);\n\n    ret = krb5_openlog(context, \"hpropd\", &fac);\n    if (ret)\n\terrx(1, \"krb5_openlog\");\n    krb5_set_warn_dest(context, fac);\n\n    if (getarg(args, num_args, argc, argv, &optidx))\n\tusage(1);\n\n    if (local_realm != NULL)\n\tkrb5_set_default_realm(context, local_realm);\n\n    if (help_flag)\n\tusage(0);\n    if (version_flag) {\n\tprint_version(NULL);\n\texit(0);\n    }\n\n    argc -= optidx;\n    argv += optidx;\n\n    if (argc != 0)\n\tusage(1);\n\n    if (database == NULL)\n\tdatabase = hdb_default_db(context);\n\n    if (from_stdin) {\n\tsock = STDIN_FILENO;\n    } else {\n\tstruct sockaddr_storage ss;\n\tstruct sockaddr *sa = (struct sockaddr *)&ss;\n\tsocklen_t sin_len = sizeof(ss);\n\tchar addr_name[256];\n\tkrb5_ticket *ticket;\n\tchar *server;\n\n\tsock = STDIN_FILENO;\n#ifdef SUPPORT_INETD\n\tif (inetd_flag == -1) {\n\t    if (getpeername (sock, sa, &sin_len) < 0) {\n\t\tinetd_flag = 0;\n\t    } else {\n\t\tinetd_flag = 1;\n\t    }\n\t}\n#else\n\tinetd_flag = 0;\n#endif\n\tif (!inetd_flag) {\n\t    mini_inetd (krb5_getportbyname (context, \"hprop\", \"tcp\",\n\t\t\t\t\t    HPROP_PORT), &sock);\n\t}\n\tsin_len = sizeof(ss);\n\tif (getpeername(sock, sa, &sin_len) < 0)\n\t    krb5_err(context, 1, errno, \"getpeername\");\n\n\tif (inet_ntop(ss.ss_family,\n\t\t      socket_get_address (sa),\n\t\t      addr_name,\n\t\t      sizeof(addr_name)) == NULL)\n\t    strlcpy (addr_name, \"unknown address\",\n\t\t     sizeof(addr_name));\n\n\tkrb5_log(context, fac, 0, \"Connection from %s\", addr_name);\n\n\tret = krb5_kt_register(context, &hdb_get_kt_ops);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_kt_register\");\n\n\tif (ktname != NULL) {\n\t    ret = krb5_kt_resolve(context, ktname, &keytab);\n\t    if (ret)\n\t\tkrb5_err (context, 1, ret, \"krb5_kt_resolve %s\", ktname);\n\t} else {\n\t    ret = krb5_kt_default (context, &keytab);\n\t    if (ret)\n\t\tkrb5_err (context, 1, ret, \"krb5_kt_default\");\n\t}\n\n\tret = krb5_recvauth(context, &ac, &sock, HPROP_VERSION, NULL,\n\t\t\t    0, keytab, &ticket);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_recvauth\");\n\n\tret = krb5_unparse_name(context, ticket->server, &server);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_unparse_name\");\n\tif (strncmp(server, \"hprop/\", 5) != 0)\n\t    krb5_errx(context, 1, \"ticket not for hprop (%s)\", server);\n\n\tfree(server);\n\tkrb5_free_ticket (context, ticket);\n\n\tret = krb5_auth_con_getauthenticator(context, ac, &authent);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_auth_con_getauthenticator\");\n\n\tret = krb5_make_principal(context, &c1, NULL, \"kadmin\", \"hprop\", NULL);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_make_principal\");\n\t_krb5_principalname2krb5_principal(context, &c2,\n\t\t\t\t\t   authent->cname, authent->crealm);\n\tif (!krb5_principal_compare(context, c1, c2)) {\n\t    char *s;\n\t    ret = krb5_unparse_name(context, c2, &s);\n\t    if (ret)\n\t\ts = unparseable_name;\n\t    krb5_errx(context, 1, \"Unauthorized connection from %s\", s);\n\t}\n\tkrb5_free_principal(context, c1);\n\tkrb5_free_principal(context, c2);\n\n\tret = krb5_kt_close(context, keytab);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_kt_close\");\n    }\n\n    if (!print_dump) {\n\tint aret;\n\n\taret = asprintf(&tmp_db, \"%s~\", database);\n\tif (aret == -1)\n\t    krb5_errx(context, 1, \"hdb_create: out of memory\");\n\n\tret = hdb_create(context, &db, tmp_db);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"hdb_create(%s)\", tmp_db);\n\tret = db->hdb_open(context, db, O_RDWR | O_CREAT | O_TRUNC, 0600);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"hdb_open(%s)\", tmp_db);\n    }\n\n    nprincs = 0;\n    while (1){\n\tkrb5_data data;\n\thdb_entry_ex entry;\n\n\tif (from_stdin) {\n\t    ret = krb5_read_message(context, &sock, &data);\n\t    if (ret != 0 && ret != HEIM_ERR_EOF)\n\t\tkrb5_err(context, 1, ret, \"krb5_read_message\");\n\t} else {\n\t    ret = krb5_read_priv_message(context, ac, &sock, &data);\n\t    if (ret)\n\t\tkrb5_err(context, 1, ret, \"krb5_read_priv_message\");\n\t}\n\n\tif (ret == HEIM_ERR_EOF || data.length == 0) {\n\t    if (!from_stdin) {\n\t\tdata.data = NULL;\n\t\tdata.length = 0;\n\t\tkrb5_write_priv_message(context, ac, &sock, &data);\n\t    }\n\t    if (!print_dump) {\n\t\tret = db->hdb_close(context, db);\n\t\tif (ret)\n\t\t    krb5_err(context, 1, ret, \"db_close\");\n\t\tret = db->hdb_rename(context, db, database);\n\t\tif (ret)\n\t\t    krb5_err(context, 1, ret, \"db_rename\");\n\t    }\n\t    break;\n\t}\n\tmemset(&entry, 0, sizeof(entry));\n\tret = hdb_value2entry(context, &data, &entry.entry);\n\tkrb5_data_free(&data);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"hdb_value2entry\");\n\tif (print_dump) {\n            struct hdb_print_entry_arg parg;\n\n            parg.out = stdout;\n            parg.fmt = HDB_DUMP_HEIMDAL;\n\t    hdb_print_entry(context, db, &entry, &parg);\n        } else {\n\t    ret = db->hdb_store(context, db, 0, &entry);\n\t    if (ret == HDB_ERR_EXISTS) {\n\t\tchar *s;\n\t\tret = krb5_unparse_name(context, entry.entry.principal, &s);\n\t\tif (ret)\n\t\t    s = strdup(unparseable_name);\n\t\tkrb5_warnx(context, \"Entry exists: %s\", s);\n\t\tfree(s);\n\t    } else if (ret)\n\t\tkrb5_err(context, 1, ret, \"db_store\");\n\t    else\n\t\tnprincs++;\n\t}\n\thdb_free_entry(context, &entry);\n    }\n    if (!print_dump)\n\tkrb5_log(context, fac, 0, \"Received %d principals\", nprincs);\n\n    if (inetd_flag == 0)\n\trk_closesocket(sock);\n\n    exit(0);\n}",
    "includes": [
      "include \"hprop.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "tatic int inetd_flag = -1;",
      "tatic int help_flag;",
      "tatic int version_flag;",
      "tatic int print_dump;",
      "tatic const char *database;",
      "tatic int from_stdin;",
      "tatic char *local_realm;",
      "tatic char *ktname = NULL;",
      "truct getargs args[] = {\n    { \"database\", 'd', arg_string, rk_UNCONST(&database), \"database\", \"file\" },\n    { \"stdin\",    'n', arg_flag, &from_stdin, \"read from stdin\", NULL },\n    { \"print\",\t    0, arg_flag, &print_dump, \"print dump to stdout\", NULL },\n#ifdef SUPPORT_INETD\n    { \"inetd\",\t   'i',\targ_negative_flag,\t&inetd_flag,\n      \"Not started from inetd\", NULL },\n#endif\n    { \"keytab\",   'k',\targ_string, &ktname,\t\"keytab to use for authentication\", \"keytab\" },\n    { \"realm\",   'r',\targ_string, &local_realm, \"realm to use\", NULL },\n    { \"version\",    0, arg_flag, &version_flag, NULL, NULL },\n    { \"help\",    'h',  arg_flag, &help_flag, NULL, NULL}\n};",
      "tatic int num_args = sizeof(args) / sizeof(args[0]);",
      "tatic char unparseable_name[] = \"unparseable name\";"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "xit(",
          "args": [
            ")"
          ],
          "line": 288
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "k_closesocket(",
          "args": [
            "ock)"
          ],
          "line": 286
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_log(",
          "args": [
            "ontext,",
            "ac,",
            ",",
            "Received %d principals\",",
            "princs)"
          ],
          "line": 283
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db_free_entry(",
          "args": [
            "ontext,",
            "entry)"
          ],
          "line": 280
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "db_store\")"
          ],
          "line": 276
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ree(",
          "args": [
            ")"
          ],
          "line": 274
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_warnx(",
          "args": [
            "ontext,",
            "Entry exists: %s\",",
            ")"
          ],
          "line": 273
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "trdup(",
          "args": [
            "nparseable_name)"
          ],
          "line": 272
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_unparse_name(",
          "args": [
            "ontext,",
            "ntry.entry.principal,",
            "s)"
          ],
          "line": 270
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "b->hdb_store",
          "args": [
            "ontext,",
            "b,",
            ",",
            "entry)"
          ],
          "line": 267
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db_print_entry(",
          "args": [
            "ontext,",
            "b,",
            "entry,",
            "parg)"
          ],
          "line": 265
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "hdb_value2entry\")"
          ],
          "line": 259
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_data_free(",
          "args": [
            "data)"
          ],
          "line": 257
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db_value2entry(",
          "args": [
            "ontext,",
            "data,",
            "entry.entry)"
          ],
          "line": 256
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "emset(",
          "args": [
            "entry,",
            ",",
            "izeof(entry))"
          ],
          "line": 255
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "db_rename\")"
          ],
          "line": 251
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "b->hdb_rename",
          "args": [
            "ontext,",
            "b,",
            "atabase)"
          ],
          "line": 249
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "db_close\")"
          ],
          "line": 248
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "b->hdb_close",
          "args": [
            "ontext,",
            "b)"
          ],
          "line": 246
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_write_priv_message(",
          "args": [
            "ontext,",
            "c,",
            "sock,",
            "data)"
          ],
          "line": 243
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_read_priv_message\")"
          ],
          "line": 236
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_read_priv_message(",
          "args": [
            "ontext,",
            "c,",
            "sock,",
            "data)"
          ],
          "line": 234
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_read_message\")"
          ],
          "line": 232
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_read_message(",
          "args": [
            "ontext,",
            "sock,",
            "data)"
          ],
          "line": 230
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "hdb_open(%s)\",",
            "mp_db)"
          ],
          "line": 221
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "b->hdb_open",
          "args": [
            "ontext,",
            "b,",
            "_RDWR | O_CREAT | O_TRUNC,",
            "600)"
          ],
          "line": 219
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "hdb_create(%s)\",",
            "mp_db)"
          ],
          "line": 218
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db_create(",
          "args": [
            "ontext,",
            "db,",
            "mp_db)"
          ],
          "line": 216
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_errx(",
          "args": [
            "ontext,",
            ",",
            "hdb_create: out of memory\")"
          ],
          "line": 214
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sprintf(",
          "args": [
            "tmp_db,",
            "%s~\",",
            "atabase)"
          ],
          "line": 212
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_kt_close\")"
          ],
          "line": 206
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_kt_close(",
          "args": [
            "ontext,",
            "eytab)"
          ],
          "line": 204
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_free_principal(",
          "args": [
            "ontext,",
            "2)"
          ],
          "line": 202
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_free_principal(",
          "args": [
            "ontext,",
            "1)"
          ],
          "line": 201
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_errx(",
          "args": [
            "ontext,",
            ",",
            "Unauthorized connection from %s\",",
            ")"
          ],
          "line": 199
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_unparse_name(",
          "args": [
            "ontext,",
            "2,",
            "s)"
          ],
          "line": 196
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_principal_compare(",
          "args": [
            "ontext,",
            "1,",
            "2)"
          ],
          "line": 194
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "krb5_principalname2krb5_principal(",
          "args": [
            "ontext,",
            "c2,",
            "uthent->cname,",
            "uthent->crealm)"
          ],
          "line": 192
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_make_principal\")"
          ],
          "line": 191
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_make_principal(",
          "args": [
            "ontext,",
            "c1,",
            "ULL,",
            "kadmin\",",
            "hprop\",",
            "ULL)"
          ],
          "line": 189
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_auth_con_getauthenticator\")"
          ],
          "line": 187
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_auth_con_getauthenticator(",
          "args": [
            "ontext,",
            "c,",
            "authent)"
          ],
          "line": 185
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_free_ticket",
          "args": [
            "ontext,",
            "icket)"
          ],
          "line": 183
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ree(",
          "args": [
            "erver)"
          ],
          "line": 182
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_errx(",
          "args": [
            "ontext,",
            ",",
            "ticket not for hprop (%s)\",",
            "erver)"
          ],
          "line": 180
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "trncmp(",
          "args": [
            "erver,",
            "hprop/\",",
            ")"
          ],
          "line": 179
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_unparse_name\")"
          ],
          "line": 178
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_unparse_name(",
          "args": [
            "ontext,",
            "icket->server,",
            "server)"
          ],
          "line": 176
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_recvauth\")"
          ],
          "line": 174
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_recvauth(",
          "args": [
            "ontext,",
            "ac,",
            "sock,",
            "PROP_VERSION,",
            "ULL,",
            ",",
            "eytab,",
            "ticket)"
          ],
          "line": 171
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_kt_default\")"
          ],
          "line": 168
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_kt_default",
          "args": [
            "ontext,",
            "keytab)"
          ],
          "line": 166
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_kt_resolve %s\",",
            "tname)"
          ],
          "line": 164
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_kt_resolve(",
          "args": [
            "ontext,",
            "tname,",
            "keytab)"
          ],
          "line": 162
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "et,",
            "krb5_kt_register\")"
          ],
          "line": 159
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_kt_register(",
          "args": [
            "ontext,",
            "hdb_get_kt_ops)"
          ],
          "line": 157
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_log(",
          "args": [
            "ontext,",
            "ac,",
            ",",
            "Connection from %s\",",
            "ddr_name)"
          ],
          "line": 155
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "trlcpy",
          "args": [
            "ddr_name,",
            "unknown address\",",
            "izeof(addr_name))"
          ],
          "line": 152
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "net_ntop(",
          "args": [
            "s.ss_family,",
            "ocket_get_address (sa),",
            "ddr_name,",
            "izeof(addr_name))"
          ],
          "line": 148
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ocket_get_address",
          "args": [
            "a)"
          ],
          "line": 149
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_err(",
          "args": [
            "ontext,",
            ",",
            "rrno,",
            "getpeername\")"
          ],
          "line": 146
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "etpeername(",
          "args": [
            "ock,",
            "a,",
            "sin_len)"
          ],
          "line": 145
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "ini_inetd",
          "args": [
            "rb5_getportbyname (context, \"hprop\", \"tcp\",\n\t\t\t\t\t    HPROP_PORT),",
            "sock)"
          ],
          "line": 141
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_getportbyname",
          "args": [
            "ontext,",
            "hprop\",",
            "tcp\",",
            "PROP_PORT)"
          ],
          "line": 141
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "etpeername",
          "args": [
            "ock,",
            "a,",
            "sin_len)"
          ],
          "line": 131
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "db_default_db(",
          "args": [
            "ontext)"
          ],
          "line": 116
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "sage(",
          "args": [
            ")"
          ],
          "line": 113
        },
        "resolved": true,
        "details": {
          "function_name": "sage(",
          "container": null,
          "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/hpropd.c",
          "lines": "62-67",
          "snippet": "tatic void\nusage(int ret)\n{\n    arg_printusage (args, num_args, NULL, \"\");\n    exit (ret);\n}",
          "includes": [
            "include \"hprop.h\""
          ],
          "macros_used": [],
          "globals_used": [
            "truct getargs args[] = {\n    { \"database\", 'd', arg_string, rk_UNCONST(&database), \"database\", \"file\" },\n    { \"stdin\",    'n', arg_flag, &from_stdin, \"read from stdin\", NULL },\n    { \"print\",\t    0, arg_flag, &print_dump, \"print dump to stdout\", NULL },\n#ifdef SUPPORT_INETD\n    { \"inetd\",\t   'i',\targ_negative_flag,\t&inetd_flag,\n      \"Not started from inetd\", NULL },\n#endif\n    { \"keytab\",   'k',\targ_string, &ktname,\t\"keytab to use for authentication\", \"keytab\" },\n    { \"realm\",   'r',\targ_string, &local_realm, \"realm to use\", NULL },\n    { \"version\",    0, arg_flag, &version_flag, NULL, NULL },\n    { \"help\",    'h',  arg_flag, &help_flag, NULL, NULL}\n};",
            "tatic int num_args = sizeof(args) / sizeof(args[0]);"
          ],
          "called_functions": [],
          "contextual_snippet": "include \"hprop.h\"\n\ntruct getargs args[] = {\n    { \"database\", 'd', arg_string, rk_UNCONST(&database), \"database\", \"file\" },\n    { \"stdin\",    'n', arg_flag, &from_stdin, \"read from stdin\", NULL },\n    { \"print\",\t    0, arg_flag, &print_dump, \"print dump to stdout\", NULL },\n#ifdef SUPPORT_INETD\n    { \"inetd\",\t   'i',\targ_negative_flag,\t&inetd_flag,\n      \"Not started from inetd\", NULL },\n#endif\n    { \"keytab\",   'k',\targ_string, &ktname,\t\"keytab to use for authentication\", \"keytab\" },\n    { \"realm\",   'r',\targ_string, &local_realm, \"realm to use\", NULL },\n    { \"version\",    0, arg_flag, &version_flag, NULL, NULL },\n    { \"help\",    'h',  arg_flag, &help_flag, NULL, NULL}\n};\ntatic int num_args = sizeof(args) / sizeof(args[0]);\n\ntatic void\nusage(int ret)\n{\n    arg_printusage (args, num_args, NULL, \"\");\n    exit (ret);\n}"
        }
      },
      {
        "call_info": {
          "callee": "xit(",
          "args": [
            ")"
          ],
          "line": 106
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rint_version(",
          "args": [
            "ULL)"
          ],
          "line": 105
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_set_default_realm(",
          "args": [
            "ontext,",
            "ocal_realm)"
          ],
          "line": 100
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "etarg(",
          "args": [
            "rgs,",
            "um_args,",
            "rgc,",
            "rgv,",
            "optidx)"
          ],
          "line": 96
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_set_warn_dest(",
          "args": [
            "ontext,",
            "ac)"
          ],
          "line": 94
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rrx(",
          "args": [
            ",",
            "krb5_openlog\")"
          ],
          "line": 93
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_openlog(",
          "args": [
            "ontext,",
            "hpropd\",",
            "fac)"
          ],
          "line": 91
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "xit(",
          "args": [
            ")"
          ],
          "line": 89
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rb5_init_context(",
          "args": [
            "context)"
          ],
          "line": 87
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "etprogname(",
          "args": [
            "rgv[0])"
          ],
          "line": 85
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include \"hprop.h\"\n\ntatic int inetd_flag = -1;\ntatic int help_flag;\ntatic int version_flag;\ntatic int print_dump;\ntatic const char *database;\ntatic int from_stdin;\ntatic char *local_realm;\ntatic char *ktname = NULL;\ntruct getargs args[] = {\n    { \"database\", 'd', arg_string, rk_UNCONST(&database), \"database\", \"file\" },\n    { \"stdin\",    'n', arg_flag, &from_stdin, \"read from stdin\", NULL },\n    { \"print\",\t    0, arg_flag, &print_dump, \"print dump to stdout\", NULL },\n#ifdef SUPPORT_INETD\n    { \"inetd\",\t   'i',\targ_negative_flag,\t&inetd_flag,\n      \"Not started from inetd\", NULL },\n#endif\n    { \"keytab\",   'k',\targ_string, &ktname,\t\"keytab to use for authentication\", \"keytab\" },\n    { \"realm\",   'r',\targ_string, &local_realm, \"realm to use\", NULL },\n    { \"version\",    0, arg_flag, &version_flag, NULL, NULL },\n    { \"help\",    'h',  arg_flag, &help_flag, NULL, NULL}\n};\ntatic int num_args = sizeof(args) / sizeof(args[0]);\ntatic char unparseable_name[] = \"unparseable name\";\n\nnt\nmain(int argc, char **argv)\n{\n    krb5_error_code ret;\n    krb5_context context;\n    krb5_auth_context ac = NULL;\n    krb5_principal c1, c2;\n    krb5_authenticator authent;\n    krb5_keytab keytab;\n    krb5_socket_t sock = rk_INVALID_SOCKET;\n    HDB *db = NULL;\n    int optidx = 0;\n    char *tmp_db;\n    krb5_log_facility *fac;\n    int nprincs;\n\n    setprogname(argv[0]);\n\n    ret = krb5_init_context(&context);\n    if (ret)\n\texit(1);\n\n    ret = krb5_openlog(context, \"hpropd\", &fac);\n    if (ret)\n\terrx(1, \"krb5_openlog\");\n    krb5_set_warn_dest(context, fac);\n\n    if (getarg(args, num_args, argc, argv, &optidx))\n\tusage(1);\n\n    if (local_realm != NULL)\n\tkrb5_set_default_realm(context, local_realm);\n\n    if (help_flag)\n\tusage(0);\n    if (version_flag) {\n\tprint_version(NULL);\n\texit(0);\n    }\n\n    argc -= optidx;\n    argv += optidx;\n\n    if (argc != 0)\n\tusage(1);\n\n    if (database == NULL)\n\tdatabase = hdb_default_db(context);\n\n    if (from_stdin) {\n\tsock = STDIN_FILENO;\n    } else {\n\tstruct sockaddr_storage ss;\n\tstruct sockaddr *sa = (struct sockaddr *)&ss;\n\tsocklen_t sin_len = sizeof(ss);\n\tchar addr_name[256];\n\tkrb5_ticket *ticket;\n\tchar *server;\n\n\tsock = STDIN_FILENO;\n#ifdef SUPPORT_INETD\n\tif (inetd_flag == -1) {\n\t    if (getpeername (sock, sa, &sin_len) < 0) {\n\t\tinetd_flag = 0;\n\t    } else {\n\t\tinetd_flag = 1;\n\t    }\n\t}\n#else\n\tinetd_flag = 0;\n#endif\n\tif (!inetd_flag) {\n\t    mini_inetd (krb5_getportbyname (context, \"hprop\", \"tcp\",\n\t\t\t\t\t    HPROP_PORT), &sock);\n\t}\n\tsin_len = sizeof(ss);\n\tif (getpeername(sock, sa, &sin_len) < 0)\n\t    krb5_err(context, 1, errno, \"getpeername\");\n\n\tif (inet_ntop(ss.ss_family,\n\t\t      socket_get_address (sa),\n\t\t      addr_name,\n\t\t      sizeof(addr_name)) == NULL)\n\t    strlcpy (addr_name, \"unknown address\",\n\t\t     sizeof(addr_name));\n\n\tkrb5_log(context, fac, 0, \"Connection from %s\", addr_name);\n\n\tret = krb5_kt_register(context, &hdb_get_kt_ops);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_kt_register\");\n\n\tif (ktname != NULL) {\n\t    ret = krb5_kt_resolve(context, ktname, &keytab);\n\t    if (ret)\n\t\tkrb5_err (context, 1, ret, \"krb5_kt_resolve %s\", ktname);\n\t} else {\n\t    ret = krb5_kt_default (context, &keytab);\n\t    if (ret)\n\t\tkrb5_err (context, 1, ret, \"krb5_kt_default\");\n\t}\n\n\tret = krb5_recvauth(context, &ac, &sock, HPROP_VERSION, NULL,\n\t\t\t    0, keytab, &ticket);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_recvauth\");\n\n\tret = krb5_unparse_name(context, ticket->server, &server);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_unparse_name\");\n\tif (strncmp(server, \"hprop/\", 5) != 0)\n\t    krb5_errx(context, 1, \"ticket not for hprop (%s)\", server);\n\n\tfree(server);\n\tkrb5_free_ticket (context, ticket);\n\n\tret = krb5_auth_con_getauthenticator(context, ac, &authent);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_auth_con_getauthenticator\");\n\n\tret = krb5_make_principal(context, &c1, NULL, \"kadmin\", \"hprop\", NULL);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_make_principal\");\n\t_krb5_principalname2krb5_principal(context, &c2,\n\t\t\t\t\t   authent->cname, authent->crealm);\n\tif (!krb5_principal_compare(context, c1, c2)) {\n\t    char *s;\n\t    ret = krb5_unparse_name(context, c2, &s);\n\t    if (ret)\n\t\ts = unparseable_name;\n\t    krb5_errx(context, 1, \"Unauthorized connection from %s\", s);\n\t}\n\tkrb5_free_principal(context, c1);\n\tkrb5_free_principal(context, c2);\n\n\tret = krb5_kt_close(context, keytab);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"krb5_kt_close\");\n    }\n\n    if (!print_dump) {\n\tint aret;\n\n\taret = asprintf(&tmp_db, \"%s~\", database);\n\tif (aret == -1)\n\t    krb5_errx(context, 1, \"hdb_create: out of memory\");\n\n\tret = hdb_create(context, &db, tmp_db);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"hdb_create(%s)\", tmp_db);\n\tret = db->hdb_open(context, db, O_RDWR | O_CREAT | O_TRUNC, 0600);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"hdb_open(%s)\", tmp_db);\n    }\n\n    nprincs = 0;\n    while (1){\n\tkrb5_data data;\n\thdb_entry_ex entry;\n\n\tif (from_stdin) {\n\t    ret = krb5_read_message(context, &sock, &data);\n\t    if (ret != 0 && ret != HEIM_ERR_EOF)\n\t\tkrb5_err(context, 1, ret, \"krb5_read_message\");\n\t} else {\n\t    ret = krb5_read_priv_message(context, ac, &sock, &data);\n\t    if (ret)\n\t\tkrb5_err(context, 1, ret, \"krb5_read_priv_message\");\n\t}\n\n\tif (ret == HEIM_ERR_EOF || data.length == 0) {\n\t    if (!from_stdin) {\n\t\tdata.data = NULL;\n\t\tdata.length = 0;\n\t\tkrb5_write_priv_message(context, ac, &sock, &data);\n\t    }\n\t    if (!print_dump) {\n\t\tret = db->hdb_close(context, db);\n\t\tif (ret)\n\t\t    krb5_err(context, 1, ret, \"db_close\");\n\t\tret = db->hdb_rename(context, db, database);\n\t\tif (ret)\n\t\t    krb5_err(context, 1, ret, \"db_rename\");\n\t    }\n\t    break;\n\t}\n\tmemset(&entry, 0, sizeof(entry));\n\tret = hdb_value2entry(context, &data, &entry.entry);\n\tkrb5_data_free(&data);\n\tif (ret)\n\t    krb5_err(context, 1, ret, \"hdb_value2entry\");\n\tif (print_dump) {\n            struct hdb_print_entry_arg parg;\n\n            parg.out = stdout;\n            parg.fmt = HDB_DUMP_HEIMDAL;\n\t    hdb_print_entry(context, db, &entry, &parg);\n        } else {\n\t    ret = db->hdb_store(context, db, 0, &entry);\n\t    if (ret == HDB_ERR_EXISTS) {\n\t\tchar *s;\n\t\tret = krb5_unparse_name(context, entry.entry.principal, &s);\n\t\tif (ret)\n\t\t    s = strdup(unparseable_name);\n\t\tkrb5_warnx(context, \"Entry exists: %s\", s);\n\t\tfree(s);\n\t    } else if (ret)\n\t\tkrb5_err(context, 1, ret, \"db_store\");\n\t    else\n\t\tnprincs++;\n\t}\n\thdb_free_entry(context, &entry);\n    }\n    if (!print_dump)\n\tkrb5_log(context, fac, 0, \"Received %d principals\", nprincs);\n\n    if (inetd_flag == 0)\n\trk_closesocket(sock);\n\n    exit(0);\n}"
  },
  {
    "function_name": "sage(",
    "container": null,
    "file": "/home/michele/Desktop/ricerca/output_repos_c/CVE-2017-6594/repo/kdc/hpropd.c",
    "lines": "62-67",
    "snippet": "tatic void\nusage(int ret)\n{\n    arg_printusage (args, num_args, NULL, \"\");\n    exit (ret);\n}",
    "includes": [
      "include \"hprop.h\""
    ],
    "macros_used": [],
    "globals_used": [
      "truct getargs args[] = {\n    { \"database\", 'd', arg_string, rk_UNCONST(&database), \"database\", \"file\" },\n    { \"stdin\",    'n', arg_flag, &from_stdin, \"read from stdin\", NULL },\n    { \"print\",\t    0, arg_flag, &print_dump, \"print dump to stdout\", NULL },\n#ifdef SUPPORT_INETD\n    { \"inetd\",\t   'i',\targ_negative_flag,\t&inetd_flag,\n      \"Not started from inetd\", NULL },\n#endif\n    { \"keytab\",   'k',\targ_string, &ktname,\t\"keytab to use for authentication\", \"keytab\" },\n    { \"realm\",   'r',\targ_string, &local_realm, \"realm to use\", NULL },\n    { \"version\",    0, arg_flag, &version_flag, NULL, NULL },\n    { \"help\",    'h',  arg_flag, &help_flag, NULL, NULL}\n};",
      "tatic int num_args = sizeof(args) / sizeof(args[0]);"
    ],
    "called_functions": [
      {
        "call_info": {
          "callee": "xit",
          "args": [
            "et)"
          ],
          "line": 66
        },
        "resolved": false,
        "reason": "library_or_external"
      },
      {
        "call_info": {
          "callee": "rg_printusage",
          "args": [
            "rgs,",
            "um_args,",
            "ULL,",
            "\")"
          ],
          "line": 65
        },
        "resolved": false,
        "reason": "library_or_external"
      }
    ],
    "contextual_snippet": "include \"hprop.h\"\n\ntruct getargs args[] = {\n    { \"database\", 'd', arg_string, rk_UNCONST(&database), \"database\", \"file\" },\n    { \"stdin\",    'n', arg_flag, &from_stdin, \"read from stdin\", NULL },\n    { \"print\",\t    0, arg_flag, &print_dump, \"print dump to stdout\", NULL },\n#ifdef SUPPORT_INETD\n    { \"inetd\",\t   'i',\targ_negative_flag,\t&inetd_flag,\n      \"Not started from inetd\", NULL },\n#endif\n    { \"keytab\",   'k',\targ_string, &ktname,\t\"keytab to use for authentication\", \"keytab\" },\n    { \"realm\",   'r',\targ_string, &local_realm, \"realm to use\", NULL },\n    { \"version\",    0, arg_flag, &version_flag, NULL, NULL },\n    { \"help\",    'h',  arg_flag, &help_flag, NULL, NULL}\n};\ntatic int num_args = sizeof(args) / sizeof(args[0]);\n\ntatic void\nusage(int ret)\n{\n    arg_printusage (args, num_args, NULL, \"\");\n    exit (ret);\n}"
  }
]