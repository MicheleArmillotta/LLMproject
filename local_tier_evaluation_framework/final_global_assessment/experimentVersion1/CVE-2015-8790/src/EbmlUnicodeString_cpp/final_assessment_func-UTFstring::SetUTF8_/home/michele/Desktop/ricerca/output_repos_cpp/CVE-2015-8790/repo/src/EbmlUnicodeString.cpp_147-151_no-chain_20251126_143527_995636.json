{
  "assessment_type": "function_only",
  "id": [
    "UTFstring::SetUTF8",
    "/home/michele/Desktop/ricerca/output_repos_cpp/CVE-2015-8790/repo/src/EbmlUnicodeString.cpp",
    "147-151"
  ],
  "file_path": "/home/michele/Desktop/ricerca/agents/local_tier_evaluation_framework/enriched_snippets/CVE-2015-8790/src/EbmlUnicodeString_cpp/enriched_snippets.json",
  "function_name": "UTFstring::SetUTF8",
  "function_code": "#include \"ebml/EbmlUnicodeString.h\"\n#include <wchar.h>\n#include <cassert>\n\nvoid UTFstring::SetUTF8(const std::string & _aStr)\n{\n  UTF8string = _aStr;\n  UpdateFromUTF8();\n}\n\n-------- CONTEXTUAL INFORMATIONS - CALLEES CODE --------\n-------- Code of the functions used by the analyzed function -------- \n\n\nCallee: UpdateFromUTF8\nvoid UTFstring::UpdateFromUTF8()\n{\n  delete [] _Data;\n  // find the size of the final UCS-2 string\n  size_t i;\n  const size_t SrcLength = UTF8string.length();\n  for (_Length=0, i=0; i<SrcLength; _Length++) {\n    const unsigned int CharLength = UTFCharLength(static_cast<uint8>(UTF8string[i]));\n    if ((CharLength >= 1) && (CharLength <= 4))\n      i += CharLength;\n    else\n      // Invalid size?\n      break;\n  }\n  _Data = new wchar_t[_Length+1];\n  size_t j;\n  for (j=0, i=0; i<SrcLength; j++) {\n    const uint8 lead              = static_cast<uint8>(UTF8string[i]);\n    const unsigned int CharLength = UTFCharLength(lead);\n    if ((CharLength < 1) || (CharLength > 4))\n      // Invalid char?\n      break;\n\n    if ((i + CharLength) > SrcLength)\n      // Guard against invalid memory access beyond the end of the\n      // source buffer.\n      break;\n\n    if (CharLength == 1)\n      _Data[j] = lead;\n    else if (CharLength == 2)\n      _Data[j] = ((lead & 0x1F) << 6) + (UTF8string[i+1] & 0x3F);\n    else if (CharLength == 3)\n      _Data[j] = ((lead & 0x0F) << 12) + ((UTF8string[i+1] & 0x3F) << 6) + (UTF8string[i+2] & 0x3F);\n    else if (CharLength == 4)\n      _Data[j] = ((lead & 0x07) << 18) + ((UTF8string[i+1] & 0x3F) << 12) + ((UTF8string[i+2] & 0x3F) << 6) + (UTF8string[i+3] & 0x3F);\n\n    i += CharLength;\n  }\n  _Data[j] = 0;\n}\n",
  "chain_code": null,
  "False_positive_reason": "",
  "Preconditions": [
    "The allocated buffer size (_Length + 1) must be less than 256"
  ],
  "Trigger_actions": [
    "Provide a UTF-8 string containing exactly 254 valid single-byte characters"
  ],
  "Dangerous_post_conditions": [
    "Buffer overflow when writing to _Data[j] at index 255 (one element beyond the allocated buffer)"
  ],
  "Initial_conditions": [
    "The code must process user-controlled UTF-8 strings through the UTFstring::SetUTF8 method."
  ]
}